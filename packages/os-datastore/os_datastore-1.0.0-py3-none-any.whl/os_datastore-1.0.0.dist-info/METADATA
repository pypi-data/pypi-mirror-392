Metadata-Version: 2.1
Name: os-datastore
Version: 1.0.0
Summary: A datastore SDK for accessing various data sources via URN
Home-page: https://github.com/yourusername/datastore
Author: uloveits
Author-email: Your Name <your.email@example.com>
License: MIT
Keywords: datastore,sdk,urn,database,storage
Classifier: Development Status :: 4 - Beta
Classifier: Intended Audience :: Developers
Classifier: Topic :: Software Development :: Libraries :: Python Modules
Classifier: License :: OSI Approved :: MIT License
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3.7
Classifier: Programming Language :: Python :: 3.8
Classifier: Programming Language :: Python :: 3.9
Classifier: Programming Language :: Python :: 3.10
Classifier: Programming Language :: Python :: 3.11
Requires-Python: >=3.7
Description-Content-Type: text/markdown
License-File: LICENSE
Requires-Dist: requests>=2.28.0
Requires-Dist: jsonschema>=4.17.0
Requires-Dist: minio>=7.1.0
Requires-Dist: cassandra-driver>=3.27.0
Requires-Dist: redis>=4.5.0
Requires-Dist: kafka-python>=2.0.2
Requires-Dist: urllib3>=1.26.0
Provides-Extra: dev
Requires-Dist: pytest>=7.0.0; extra == "dev"
Requires-Dist: pytest-cov>=4.0.0; extra == "dev"
Requires-Dist: black>=23.0.0; extra == "dev"
Requires-Dist: flake8>=6.0.0; extra == "dev"

# Datastore SDK

ä¸€ä¸ªç”¨äºé€šè¿‡ URN è®¿é—®å„ç§æ•°æ®æºçš„ Python SDKã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ”— é€šè¿‡ URN è‡ªåŠ¨è·å–èµ„äº§è¿æ¥ä¿¡æ¯
- ğŸ“Š æ”¯æŒå¤šç§æ•°æ®æºï¼šMinIOã€Cassandraã€Redisã€Kafkaã€HTTP
- âœ… è‡ªåŠ¨ Schema éªŒè¯ï¼ˆå†™å…¥æ—¶ï¼‰
- ğŸš€ ç®€å•æ˜“ç”¨çš„ API
- ğŸ“¦ å¯å‘å¸ƒåˆ° PyPI

## å®‰è£…

```bash
pip install datastore==1.0.0
```

## å¿«é€Ÿå¼€å§‹

> ğŸ“– **è¯¦ç»†ä½¿ç”¨æŒ‡å—**: æŸ¥çœ‹ [QUICKSTART.md](QUICKSTART.md) è·å–å®Œæ•´çš„å¿«é€Ÿå…¥é—¨æ‰‹å†Œï¼ŒåŒ…å«æ‰€æœ‰æ•°æ®æºçš„è¯¦ç»†ä½¿ç”¨è¯´æ˜ã€å¸¸è§åœºæ™¯å’Œæœ€ä½³å®è·µã€‚

### åŸºæœ¬ä½¿ç”¨

```python
from datastore import DataStoreClient

# åˆ›å»ºå®¢æˆ·ç«¯å®ä¾‹
client = DataStoreClient(api_base_url="http://192.168.2.123:8067")

# è¿æ¥åˆ°èµ„äº§
client.connect("urn:store:os.iot.rotary_wheel_image")

# è¯»å–æ•°æ®
data = client.read(key="some_key")  # æ ¹æ®æ•°æ®æºç±»å‹ä½¿ç”¨ä¸åŒçš„å‚æ•°

# å†™å…¥æ•°æ®ï¼ˆè‡ªåŠ¨éªŒè¯ schemaï¼‰
client.write({
    "thingid": "device_001",
    "filepath": "/path/to/file.jpg",
    "time": "2025-01-18T10:00:00Z"
})

# æ–­å¼€è¿æ¥
client.disconnect()
```

### ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨

```python
from datastore import DataStoreClient

with DataStoreClient() as client:
    client.connect("urn:store:os.iot.rotary_wheel_image")
    
    # è¯»å–æ•°æ®
    data = client.read()
    
    # å†™å…¥æ•°æ®
    client.write({"key": "value"})
    # è‡ªåŠ¨æ–­å¼€è¿æ¥
```

## æ”¯æŒçš„æ•°æ®æº

### MinIOï¼ˆå¯¹è±¡å­˜å‚¨ï¼‰

```python
client.connect("urn:store:example.minio")

# URL æ ¼å¼: minio://192.168.2.123:9006/file?username=admin&password=Minio_Rozh123srv
# å…¶ä¸­: file æ˜¯ bucket åç§°

# è¯»å–å¯¹è±¡ï¼ˆé»˜è®¤åŒ…å« metadataï¼‰
result = client.read(object_name="path/to/object.json")
# è¿”å›: {"data": ..., "metadata": {...}}

# åªè¯»å–æ•°æ®ï¼ˆä¸åŒ…å« metadataï¼‰
data = client.read(object_name="path/to/object.json", include_metadata=False)

# å†™å…¥å¯¹è±¡ï¼ˆå¸¦ metadataï¼Œmetadata ä¼šè¢« Schema æ ¡éªŒï¼‰
client.write(
    file_data=binary_data,  # å®é™…æ–‡ä»¶æ•°æ®ï¼ˆå­—èŠ‚ï¼‰
    metadata={  # metadataï¼ˆä¼šè¢« Schema æ ¡éªŒï¼‰
        "thingid": "device_001",
        "filepath": "/path/to/file.jpg",
        "time": "2025-01-18T10:00:00Z"
    },
    object_name="path/to/file.jpg",
    content_type="image/jpeg"
)

# å†™å…¥ JSON å¯¹è±¡ï¼ˆä¸å¸¦ metadataï¼‰
client.write(
    data={"key": "value"},
    object_name="path/to/object.json"
)
```

**é‡è¦è¯´æ˜ï¼š**
- è¯»å–æ—¶é»˜è®¤è¿”å› `{"data": ..., "metadata": {...}}` æ ¼å¼
- å†™å…¥æ—¶å¦‚æœæä¾›äº† `metadata`ï¼ŒSchema æ ¡éªŒä¼šæ ¡éªŒ `metadata` è€Œä¸æ˜¯æ–‡ä»¶æ•°æ®æœ¬èº«
- `metadata` ä¼šä»¥ `x-amz-meta-` å‰ç¼€å­˜å‚¨åœ¨ MinIO ä¸­

### Cassandraï¼ˆNoSQL æ•°æ®åº“ï¼‰

```python
client.connect("urn:store:example.cassandra")

# è¯»å–æ•°æ®
rows = client.read(
    table="my_table",
    where_clause="id = '123'",
    limit=100
)

# å†™å…¥æ•°æ®
client.write(
    data={"id": "123", "name": "test"},
    table="my_table"
)
```

### Redisï¼ˆç¼“å­˜ï¼‰

```python
client.connect("urn:store:example.redis")

# è¯»å–æ•°æ®
data = client.read(key="my_key")

# å†™å…¥æ•°æ®
client.write(
    data={"key": "value"},
    key="my_key",
    ttl=3600  # è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
)
```

### Kafkaï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰

```python
client.connect("urn:store:example.kafka")

# è¯»å–å†å²æ¶ˆæ¯ï¼ˆå¦‚æœæ²¡æœ‰ä¿å­˜çš„ offsetï¼Œä» earliest å¼€å§‹ï¼‰
messages = client.read(
    timeout_ms=3000,
    max_records=10,
    group_id="my_consumer_group",
    auto_offset_reset="earliest"  # å¦‚æœæ²¡æœ‰ä¿å­˜çš„ offsetï¼Œä» earliest å¼€å§‹
)
# æ‰‹åŠ¨æäº¤åç§»é‡
client.commit_offset()

# è¯»å–æ–°æ¶ˆæ¯ï¼ˆå¦‚æœæ²¡æœ‰ä¿å­˜çš„ offsetï¼Œä» latest å¼€å§‹ï¼‰
new_messages = client.read(
    timeout_ms=2000,
    max_records=5,
    group_id="my_consumer_group_new",
    auto_offset_reset="latest"  # å¦‚æœæ²¡æœ‰ä¿å­˜çš„ offsetï¼Œä» latest å¼€å§‹
)
client.commit_offset()

# ä½¿ç”¨å·²å­˜åœ¨çš„ consumer groupï¼ˆä¼šä»ä¿å­˜çš„ offset å¼€å§‹æ¶ˆè´¹ï¼‰
existing_messages = client.read(
    timeout_ms=2000,
    max_records=5,
    group_id="my_consumer_group",  # ä½¿ç”¨ä¹‹å‰ç”¨è¿‡çš„ group_id
    auto_offset_reset="latest"  # åªæœ‰åœ¨æ²¡æœ‰ä¿å­˜çš„ offset æ—¶æ‰ä½¿ç”¨
)
client.commit_offset()

# æŒç»­æµå¼è¯»å–æ¶ˆæ¯ï¼ˆä¸€æ—¦æœ‰æ–°æ•°æ®å°±ä¼šè¯»å–ï¼‰
message_count = 0
for message in client.readstream(
    poll_timeout_ms=1000,
    group_id="my_stream_consumer_group",
    auto_offset_reset="latest"  # å¦‚æœæ²¡æœ‰ä¿å­˜çš„ offsetï¼Œä» latest å¼€å§‹
):
    message_count += 1
    print(f"æ”¶åˆ°æ¶ˆæ¯: {message}")
    # æ¯å¤„ç† 10 æ¡æ¶ˆæ¯æäº¤ä¸€æ¬¡åç§»é‡
    if message_count % 10 == 0:
        client.commit_offset()
    # æŒ‰ Ctrl+C åœæ­¢

# å†™å…¥æ¶ˆæ¯
client.write(
    data={"message": "hello"},
    key="message_key"  # å¯é€‰
)
```

**é‡è¦è¯´æ˜ï¼š**
- é»˜è®¤æƒ…å†µä¸‹ï¼Œåç§»é‡ä¸ä¼šè‡ªåŠ¨æäº¤ï¼Œéœ€è¦æ‰‹åŠ¨è°ƒç”¨ `commit_offset()` æ–¹æ³•
- å¦‚æœæœ‰ consumer group ä¸”æœ‰ä¿å­˜çš„ offsetï¼Œä¼šä»ä¿å­˜çš„ offset å¼€å§‹æ¶ˆè´¹
- å¦‚æœæ²¡æœ‰ä¿å­˜çš„ offsetï¼Œåˆ™æ ¹æ® `auto_offset_reset` å‚æ•°å†³å®šä» `earliest` æˆ– `latest` å¼€å§‹
- `auto_offset_reset` å‚æ•°åªåœ¨æ²¡æœ‰ä¿å­˜çš„ offset æ—¶ç”Ÿæ•ˆ

### HTTPï¼ˆåªè¯» APIï¼‰

```python
client.connect("urn:store:example.http")

# è¯»å–æ•°æ®
data = client.read(
    path="/api/data",
    params={"id": "123"},
    headers={"Authorization": "Bearer token"}
)

# HTTP ä¸æ”¯æŒå†™å…¥æ“ä½œ
# client.write(...)  # ä¼šæŠ›å‡º NotImplementedError
```

## Schema éªŒè¯

SDK æ”¯æŒçµæ´»çš„ Schema éªŒè¯é…ç½®ï¼Œå¯ä»¥åœ¨å¤šä¸ªå±‚çº§æ§åˆ¶éªŒè¯è¡Œä¸ºã€‚

### åˆå§‹åŒ–æ—¶é…ç½®ï¼ˆå…¨å±€é»˜è®¤ï¼‰

```python
# é»˜è®¤å¯ç”¨ Schema æ ¡éªŒï¼ˆæ¨èï¼‰
client = DataStoreClient(api_base_url="http://192.168.2.123:8067")

# ç¦ç”¨ Schema æ ¡éªŒ
client = DataStoreClient(
    api_base_url="http://192.168.2.123:8067",
    enable_schema_validation=False
)
```

### è¿æ¥æ—¶é…ç½®ï¼ˆé’ˆå¯¹ç‰¹å®šèµ„äº§ï¼‰

```python
client = DataStoreClient()

# è¿æ¥æ—¶å¯ç”¨ Schema æ ¡éªŒï¼ˆè¦†ç›–é»˜è®¤è®¾ç½®ï¼‰
client.connect("urn:store:example", enable_schema_validation=True)

# è¿æ¥æ—¶ç¦ç”¨ Schema æ ¡éªŒ
client.connect("urn:store:example", enable_schema_validation=False)
```

### è¿è¡Œæ—¶åŠ¨æ€æ§åˆ¶

```python
client = DataStoreClient()
client.connect("urn:store:example")

# æ£€æŸ¥å½“å‰æ˜¯å¦å¯ç”¨æ ¡éªŒ
if client.is_schema_validation_enabled():
    print("Schema æ ¡éªŒå·²å¯ç”¨")

# åŠ¨æ€å¯ç”¨æ ¡éªŒ
client.enable_schema_validation()

# åŠ¨æ€ç¦ç”¨æ ¡éªŒ
client.disable_schema_validation()
```

### å†™å…¥æ—¶æ§åˆ¶ï¼ˆå•æ¬¡æ“ä½œï¼‰

```python
client.connect("urn:store:example")

# ä½¿ç”¨é»˜è®¤è®¾ç½®ï¼ˆæ ¹æ®åˆå§‹åŒ–æˆ–è¿æ¥æ—¶çš„é…ç½®ï¼‰
client.write({"thingid": "device_001", "filepath": "/path/to/file.jpg", "time": "2025-01-18T10:00:00Z"})

# å¼ºåˆ¶éªŒè¯ï¼ˆå³ä½¿é»˜è®¤ç¦ç”¨ï¼‰
client.write(
    data={"thingid": "device_001", "filepath": "/path/to/file.jpg", "time": "2025-01-18T10:00:00Z"},
    validate_schema=True
)

# è·³è¿‡éªŒè¯ï¼ˆå³ä½¿é»˜è®¤å¯ç”¨ï¼‰
client.write(
    data={"thingid": "device_001", "filepath": "/path/to/file.jpg", "time": "2025-01-18T10:00:00Z"},
    validate_schema=False
)
```

### éªŒè¯æ•°æ®ï¼ˆä¸å†™å…¥ï¼‰

```python
client.connect("urn:store:example")

# éªŒè¯æ•°æ®ï¼ˆä¸å†™å…¥ï¼‰
is_valid, error = client.validate_data({
    "thingid": "device_001",
    "filepath": "/path/to/file.jpg",
    "time": "2025-01-18T10:00:00Z"
})

if not is_valid:
    print(f"éªŒè¯å¤±è´¥: {error}")
```

### éªŒè¯ä¼˜å…ˆçº§

éªŒè¯è¡Œä¸ºçš„ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š
1. `write()` æ–¹æ³•çš„ `validate_schema` å‚æ•°ï¼ˆå•æ¬¡æ“ä½œï¼‰
2. `connect()` æ–¹æ³•çš„ `enable_schema_validation` å‚æ•°ï¼ˆé’ˆå¯¹ç‰¹å®šèµ„äº§ï¼‰
3. `DataStoreClient()` åˆå§‹åŒ–æ—¶çš„ `enable_schema_validation` å‚æ•°ï¼ˆå…¨å±€é»˜è®¤ï¼‰

## API å‚è€ƒ

### DataStoreClient

#### `__init__(api_base_url: str = "http://192.168.2.123:8067")`

åˆ›å»ºå®¢æˆ·ç«¯å®ä¾‹ã€‚

**å‚æ•°ï¼š**
- `api_base_url`: API åŸºç¡€ URL

#### `connect(urn: str) -> None`

è¿æ¥åˆ°æŒ‡å®šçš„èµ„äº§ã€‚

**å‚æ•°ï¼š**
- `urn`: èµ„äº§ URNï¼Œä¾‹å¦‚ï¼š`urn:store:os.iot.rotary_wheel_image`

#### `disconnect() -> None`

æ–­å¼€è¿æ¥ã€‚

#### `read(**kwargs) -> Any`

è¯»å–æ•°æ®ã€‚å‚æ•°æ ¹æ®æ•°æ®æºç±»å‹è€Œå¼‚ã€‚

#### `write(data: Dict[str, Any], validate_schema: bool = True, **kwargs) -> bool`

å†™å…¥æ•°æ®ã€‚

**å‚æ•°ï¼š**
- `data`: è¦å†™å…¥çš„æ•°æ®å­—å…¸
- `validate_schema`: æ˜¯å¦éªŒè¯ schemaï¼ˆé»˜è®¤ Trueï¼‰
- `**kwargs`: ä¼ é€’ç»™è¿æ¥å™¨çš„å†™å…¥å‚æ•°

**è¿”å›ï¼š**
- `True` å¦‚æœå†™å…¥æˆåŠŸ

**å¼‚å¸¸ï¼š**
- `ValueError`: å¦‚æœæ•°æ®ä¸ç¬¦åˆ schema
- `NotImplementedError`: å¦‚æœæ•°æ®æºä¸æ”¯æŒå†™å…¥ï¼ˆå¦‚ HTTPï¼‰

#### `get_asset_info() -> Optional[Dict[str, Any]]`

è·å–å½“å‰èµ„äº§çš„è¯¦ç»†ä¿¡æ¯ã€‚

#### `get_schema() -> Optional[Dict[str, Any]]`

è·å–å½“å‰èµ„äº§çš„ Schemaã€‚

#### `validate_data(data: Dict[str, Any]) -> Tuple[bool, Optional[str]]`

éªŒè¯æ•°æ®æ˜¯å¦ç¬¦åˆ schemaï¼ˆä¸å†™å…¥ï¼‰ã€‚

**è¿”å›ï¼š**
- `(is_valid, error_message)` å…ƒç»„

## å¼€å‘

### å®‰è£…å¼€å‘ä¾èµ–

```bash
pip install -e ".[dev]"
```

### è¿è¡Œæµ‹è¯•

```bash
pytest
```

### æ„å»ºåŒ…

```bash
python setup.py sdist bdist_wheel
```

### å‘å¸ƒåˆ° PyPI

```bash
pip install twine
twine upload dist/*
```

## è®¸å¯è¯

MIT License

## è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼
