# Generated by CodiumAI

import pytest
from loopresources import DhConfig, desurvey
import pandas as pd
import numpy as np

"""
Code Analysis

Objective:
- The objective of the 'desurvey' function is to desurvey and resample a drillhole along a specific interval using the minimum curvature method.

Inputs:
- collar: a pandas DataFrame containing the collar for a single drill hole.
- survey: a pandas DataFrame containing the survey table for a single drill hole.
- newinterval (optional): a float representing the step size of the interval. The default value is 1.0 meter.

Flow:
- The function first creates a new depth array using the minimum and maximum depth values from the survey DataFrame and the newinterval value.
- The azimuth and inclination of the drillhole are then interpolated to the new depth array using the interp1d function from the scipy.interpolate module.
- The xyz coordinates are calculated using the minimum curvature method, which involves calculating the change in inclination and azimuth between two survey points, and then calculating the change in x, y, and z coordinates based on the change in depth and the calculated inclination and azimuth values.
- The resulting DataFrame is then returned.

Outputs:
- The main output of the function is a pandas DataFrame containing the resampled survey data along the drillhole at the specific interval.

Additional aspects:
- The function uses the DhConfig class to access the column names for the collar and survey DataFrames.
- The function uses numpy and pandas modules for data manipulation and the scipy.interpolate module for interpolation.
"""


class TestDesurvey:
    # Tests that the function returns the correct output when provided with valid collar and survey dataframes and a valid newinterval value. tags: [happy path]
    def test_desurvey_valid_input(self):
        # create valid collar and survey DataFrames
        collar = pd.DataFrame(
            {
                DhConfig.holeid: ["HOLE1"],
                DhConfig.x: [0],
                DhConfig.y: [0],
                DhConfig.z: [0],
                DhConfig.total_depth: [30],
            }
        )
        survey = pd.DataFrame(
            {
                DhConfig.depth: [0, 10, 20, 30],
                DhConfig.dip: [0, 10, 20, 30],
                DhConfig.azimuth: [0, 10, 20, 30],
            }
        )
        survey[DhConfig.dip] = np.deg2rad(survey[DhConfig.dip])
        survey[DhConfig.azimuth] = np.deg2rad(survey[DhConfig.azimuth])
        # call function with valid input
        result = desurvey(collar, survey, newinterval=5)
        # check that output is correct
        # assert result.shape == (6, 7)
        assert result[DhConfig.depth].tolist() == [0, 5, 10, 15, 20, 25]
        assert np.isclose(
            result[DhConfig.dip].values, np.array([0.0, 5.0, 10.0, 15.0, 20.0, 25.0]),atol=5e-1
        ).all()
        assert np.isclose(
            result[DhConfig.azimuth].values, np.array([0.0, 5.0, 10.0, 15.0, 20.0, 25.0]),atol=5e-1
        ).all()

    # Tests that the function raises an error when provided with a newinterval value of 0 or negative, or a survey dataframe with only one row. tags: [edge case]
    def test_desurvey_invalid_input(self):
        # create collar and survey DataFrames with invalid input
        collar = pd.DataFrame(
            {
                DhConfig.holeid: ["HOLE1"],
                DhConfig.x: [0],
                DhConfig.y: [0],
                DhConfig.z: [0],
                DhConfig.total_depth: [30],
            }
        )
        survey = pd.DataFrame(
            {
                DhConfig.depth: [0, 10, 20, 30],
                DhConfig.dip: [0, 10, 20, 30],
                DhConfig.azimuth: [0, 10, 20, 30],
            }
        )
        # test with newinterval value of 0
        with pytest.raises(ValueError):
            desurvey(collar, survey, newinterval=0)
        # test with newinterval value of -1
        with pytest.raises(ValueError):
            desurvey(collar, survey, newinterval=-1)

    # Tests that the function returns an empty dataframe when provided with empty collar or survey dataframes. tags: [edge case]
    def test_desurvey_empty_input(self):
        # test with empty collar DataFrame
        collar = pd.DataFrame(
            columns=[DhConfig.holeid, DhConfig.x, DhConfig.y, DhConfig.z, DhConfig.total_depth]
        )
        survey = pd.DataFrame(
            {
                DhConfig.depth: [0, 10, 20, 30],
                DhConfig.dip: [0, 10, 20, 30],
                DhConfig.azimuth: [0, 10, 20, 30],
            }
        )
        result = desurvey(collar, survey)
        assert result.empty
        # test with empty survey DataFrame
        collar = pd.DataFrame(
            {
                DhConfig.holeid: ["HOLE1"],
                DhConfig.x: [0],
                DhConfig.y: [0],
                DhConfig.z: [0],
            }
        )
        survey = pd.DataFrame(columns=[DhConfig.depth, DhConfig.dip, DhConfig.azimuth])
        result = desurvey(collar, survey)
        assert result.empty

    # Tests that the function raises an error when the input dataframes have different column names than expected. tags: [other possible issue]
    def test_desurvey_column_names(self):
        # create input dataframes with incorrect column names
        collar = pd.DataFrame(
            {"HOLE": [1], "FROM": [0], "TO": [10], "E": [100], "N": [200], "RL": [0]}
        )
        survey = pd.DataFrame(
            {
                "HOLE": [1, 1, 1],
                "DEPTH_FROM": [0, 5, 10],
                "DEPTH_TO": [5, 10, 15],
                "AZIMUTH": [0, 90, 180],
                "DIP": [-90, -45, 0],
            }
        )
        # assert that function raises a KeyError
        with pytest.raises(KeyError):
            desurvey(collar, survey)

    # Tests that the function raises an error when the input dataframes have different data types than expected. tags: [other possible issue]
    # def test_desurvey_data_types(self):
    #     # create input dataframes with incorrect data types
    #     collar = pd.DataFrame(
    #         {
    #             "HOLEID": ["1"],
    #             "SAMPFROM": ["0"],
    #             "SAMPTO": ["10"],
    #             "EAST": ["100"],
    #             "NORTH": ["200"],
    #             "RL": ["0"],
    #         }
    #     )
    #     survey = pd.DataFrame(
    #         {
    #             "HOLEID": ["1", "1", "1"],
    #             "DEPTH": ["0", "5", "10"],
    #             "AZIMUTH": ["0", "90", "180"],
    #             "DIP": ["-90", "-45", "0"],
    #         }
    #     )
    #     # assert that function raises a TypeError
    #     with pytest.raises(TypeError):
    #         desurvey(collar, survey)

    # Tests that the function raises an error when the survey dataframe is not sorted by depth. tags: [other possible issue]
    def test_desurvey_unsorted_survey(self):
        # create input dataframes with unsorted survey dataframe
        collar = pd.DataFrame(
            {
                "HOLEID": [1],
                "SAMPFROM": [0],
                "SAMPTO": [10],
                "EAST": [100],
                "NORTH": [200],
                "RL": [0],
                "DEPTH": [10],
            }
        )
        survey = pd.DataFrame(
            {
                "HOLEID": [1, 1, 1],
                "DEPTH": [5, 0, 10],
                "AZIMUTH": [0, 90, 180],
                "DIP": [-90, -45, 0],
            }
        )
        survey[DhConfig.dip] = np.deg2rad(survey[DhConfig.dip])
        survey[DhConfig.azimuth] = np.deg2rad(survey[DhConfig.azimuth])
        # assert that function raises a ValueError
        results = desurvey(collar, survey, newinterval=1)
        # check that the arrays were sorted by depth and the interpolated dip/azi is correct
        print(results.loc[results["DEPTH"] == 0.0])
        assert (np.isclose(results.loc[results["DEPTH"] == 0.0, "DIP"], -45.).all())
        assert (np.isclose(results.loc[results["DEPTH"] == 0.0, "AZIMUTH"], 90.).all())

        assert (np.isclose(results.loc[results["DEPTH"] == 5.0, "DIP"], -90.).all())
        assert (np.isclose(results.loc[results["DEPTH"] == 5.0, "AZIMUTH"], 0.).all())

        assert (np.isclose(results.loc[results["DEPTH"] == 10.0, "DIP"], 0.).all())
        assert (np.isclose(results.loc[results["DEPTH"] == 10.0, "AZIMUTH"], 180.).all())
