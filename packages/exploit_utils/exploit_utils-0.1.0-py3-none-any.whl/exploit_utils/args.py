"""命令行参数的相关功能"""

import argparse
import copy
from dataclasses import dataclass, field
from typing import Any, TypedDict, Iterable, Callable, Literal


__all__ = [
    "ArgOptions", "Arg", "Preset", "Parser",
    "URL", "FILE", "OUTPUT", "THREADS", "DEBUG",
    "RHOST", "RPORT", "LHOST", "LPORT", "DICT",
    "COMMAND",
    "BASIC_PRESET", "REVERSE_SHELL_PRESET", "SCAN_PRESET"
]


class ArgOptions(TypedDict):
    action: str | type[argparse.Action]
    nargs: int | Literal['?', '*', '+']
    const: Any
    default: Any
    type: Callable[[str], Any]
    choices: Iterable[Any]
    required: bool
    help: str
    metavar: str | tuple[str, ...]
    dest: str
    version: str


@dataclass
class Arg():
    name_or_flags: tuple[str] = ()
    options: ArgOptions = field(default_factory=dict)

    def __call__(self, options: ArgOptions) -> "Arg":
        """创建该选项的副本, 可以修改部分参数"""
        new_options = copy.deepcopy(self.options)
        new_options.update(options)
        return Arg(self.name_or_flags, new_options)


type Preset = list[Arg]


class Parser(argparse.ArgumentParser):
    def load_args(self, args: Iterable[Arg]) -> None:
        """批量导入由 `exploit_utils.args.Arg` 定义的命令行参数"""
        for arg in args:
            self.add_argument(*arg.name_or_flags, **arg.options)


URL     = Arg(("--url", "-u"),      {"help": "目标 URL"})
'''--url URL, -u URL  目标 URL'''
FILE    = Arg(("--file", "-f"),     {"help": "从文件批量获取 URL"})
'''--file FILE, -f FILE  从文件批量获取 URL'''
OUTPUT  = Arg(("--output", "-o"),   {"help": "输出文件"})
'''--output OUTPUT, -o OUTPUT  输出文件'''
THREADS = Arg(("--threads", "-t"),  {"type": int, "default": 5, "help": "线程数"})
'''--threads THREADS, -t THREADS  线程数'''
DEBUG   = Arg(("--debug",),         {"action": "store_true", "help": "开启 Debug 模式"})
'''--debug  开启 Debug 模式'''
RHOST   = Arg(("--rhost", "-rh"),   {"required": True, "help": "目标地址"})
'''--rhost RHOST, -rh RHOST  目标地址 '''
RPORT   = Arg(("--rport", "-rp"),   {"type": int, "default": 80, "help": "目标端口"})
'''--rport RPORT, -rp RPORT  目标端口'''
LHOST   = Arg(("--lhost", "-lh"),   {"default": "127.0.0.1", "help": "回连地址"})
'''--lhost LHOST, -lh LHOST  回连地址'''
LPORT   = Arg(("--lport", "-lp"),   {"type": int, "default": 8080, "help": "回连端口"})
'''--lport LPORT, -lp LPORT  回连端口'''
DICT    = Arg(("--dict", "-d"),     {"help": "指定字典"})
'''--dict DICT, -d DICT  指定字典'''
COMMAND = Arg(("--command", "-c"),  {"default": "whoami", "help": "要执行的命令"})
'''--command COMMAND, -c COMMAND  要执行的命令'''

BASIC_PRESET: Preset = [URL, FILE, OUTPUT, THREADS]
'''基础预设, 包含 exp 常用的参数:
```
--url URL, -u URL              目标 URL
--file FILE, -f FILE           从文件批量获取 URL
--output OUTPUT, -o OUTPUT     输出文件
--threads THREADS, -t THREADS  线程数
```'''

REVERSE_SHELL_PRESET: Preset = [RHOST, RPORT, LHOST, LPORT]
'''反向 shell 预设, 包含反连相关参数:
```
--rhost RHOST, -rh RHOST  目标地址
--rport RPORT, -rp RPORT  目标端口
--lhost LHOST, -lh LHOST  回连地址
--lport LPORT, -lp LPORT  回连端口
```'''

SCAN_PRESET: Preset = [URL, THREADS, DICT]
'''扫描器预设, 包含基本扫描参数:
```
--url URL, -u URL              目标 URL
--threads THREADS, -t THREADS  THREADS 线程数
--dict DICT, -d DICT           指定字典
```'''
