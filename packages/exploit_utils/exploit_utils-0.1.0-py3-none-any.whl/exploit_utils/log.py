"""日志相关的操作"""

import logging
import tqdm
from pathlib import Path
from threading import Lock


__all__ = ["get_logger", "add_aoutputfile", "RecordSet"]


class TqdmStream():
    def write(self, s: str) -> None:
        tqdm.tqdm.write(s, end='')


class RecordSet(set):
    """一个会将其元素实时记录到指定文件的集合, 线程安全"""
    def __init__(self, path: Path | str, **options) -> None:
        super().__init__(**options)
        self.save_path = path
        self.lock = Lock()
    
    def add(self, elm: str) -> None:
        if elm not in self:
            with self.lock, open(self.save_path, "a") as f:
                f.write(elm + '\n')
        return super().add(elm)


# 添加了 SUCCESS 日志级别, 使用 `logger.ok` 输出该级别日志
SUCCESS = 25
logging.addLevelName(SUCCESS, "SUCCESS")
logging.Logger.ok = lambda self, message, *args, **kwargs: self._log(SUCCESS, message, args, **kwargs)

_logger = logging.getLogger(__name__)
_logger.setLevel(logging.INFO)

formatter = logging.Formatter("[%(levelname)s] %(message)s")

# 添加控制台输出
console_handler = logging.StreamHandler(stream=TqdmStream())
console_handler.setFormatter(formatter)
_logger.addHandler(console_handler)


def get_logger() -> logging.Logger:
    return _logger


def add_outputfile(path: Path | str) -> None:
    """给日志添加文件输出"""
    file_handler = logging.FileHandler(path)
    file_handler.setFormatter(formatter)
    _logger.addHandler(file_handler)
