# Note: This code is generated by Cursor, not tested yet.

from typing import Optional, Union

from nexaai.common import PluginID
from nexaai.cv import CVModel, CVModelConfig, CVResults
from nexaai.mlx_backend.cv.interface import CVModel as MLXCVInterface, create_cv_model


class MLXCVImpl(CVModel):
    def __init__(self):
        """Initialize MLX CV implementation."""
        super().__init__()
        self._mlx_cv = None

    @classmethod
    def _load_from(cls,
                   local_path: str,
                   model_name: Optional[str] = None,
                   m_cfg: CVModelConfig = None,
                   plugin_id: Union[PluginID, str] = PluginID.MLX,
                   device_id: Optional[str] = None,
                   **kwargs
        ) -> 'MLXCVImpl':
        """Load CV model from configuration using MLX backend."""
        try:            
            # Get MLX config class
            from nexaai.mlx_backend.ml import CVModelConfig as MLXCVModelConfig
            
            # Convert our config to MLX format
            mlx_config = MLXCVModelConfig(
                capabilities=m_cfg.capabilities,
                det_model_path=m_cfg.det_model_path or local_path,
                rec_model_path=m_cfg.rec_model_path or local_path,
                model_path=m_cfg.model_path,
                system_library_path=m_cfg.system_library_path,
                backend_library_path=m_cfg.backend_library_path,
                extension_library_path=m_cfg.extension_library_path,
                config_file_path=m_cfg.config_file_path,
                char_dict_path=m_cfg.char_dict_path
            )
            
            # Create instance and load MLX CV model
            instance = cls()
            instance._mlx_cv = create_cv_model(mlx_config, device_id)
            
            return instance
        except Exception as e:
            raise RuntimeError(f"Failed to load MLX CV: {str(e)}")

    def eject(self):
        """Destroy the model and free resources."""
        if self._mlx_cv:
            self._mlx_cv.destroy()
            self._mlx_cv = None

    def infer(self, input_image_path: str) -> CVResults:
        """Perform inference on image."""
        if not self._mlx_cv:
            raise RuntimeError("MLX CV not loaded")
        
        try:
            # Use MLX CV inference
            result = self._mlx_cv.infer(input_image_path)
            
            # Convert MLX result to our format
            from nexaai.cv import CVResult
            
            our_results = []
            for mlx_result in result.results:
                our_result = CVResult(
                    image_paths=mlx_result.image_paths,
                    image_count=mlx_result.image_count,
                    class_id=mlx_result.class_id,
                    confidence=mlx_result.confidence,
                    bbox=mlx_result.bbox,
                    text=mlx_result.text,
                    embedding=mlx_result.embedding,
                    embedding_dim=mlx_result.embedding_dim
                )
                our_results.append(our_result)
            
            return CVResults(
                results=our_results,
                result_count=result.result_count
            )
            
        except Exception as e:
            raise RuntimeError(f"Failed to perform CV inference: {str(e)}")


