Metadata-Version: 2.4
Name: yookassa-telegram
Version: 1.1.0
Summary: By @rerowros
Author-email: rerowros <rerowros@gmail.com>
License: MIT
Project-URL: Homepage, https://github.com/Rerowros/yookassa-telegram
Project-URL: Documentation, https://github.com/Rerowros/yookassa-telegram#readme
Project-URL: Repository, https://github.com/Rerowros/yookassa-telegram
Project-URL: Issues, https://github.com/Rerowros/yookassa-telegram/issues
Keywords: yookassa,telegram,bot,payment,aiogram
Classifier: Development Status :: 4 - Beta
Classifier: Intended Audience :: Developers
Classifier: License :: OSI Approved :: MIT License
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3.10
Classifier: Programming Language :: Python :: 3.11
Classifier: Programming Language :: Python :: 3.12
Classifier: Topic :: Software Development :: Libraries :: Python Modules
Requires-Python: >=3.10
Description-Content-Type: text/markdown
License-File: LICENSE
Requires-Dist: aiogram>=3.0.0
Requires-Dist: aiohttp>=3.8.0
Requires-Dist: yookassa>=2.0.0
Provides-Extra: dev
Requires-Dist: pytest>=7.0.0; extra == "dev"
Requires-Dist: pytest-asyncio>=0.21.0; extra == "dev"
Requires-Dist: black>=23.0.0; extra == "dev"
Requires-Dist: mypy>=1.0.0; extra == "dev"
Dynamic: license-file

# yookassa-telegram

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–µ–π YooKassa —Å Telegram-–±–æ—Ç–∞–º–∏ (aiogram 3.x).

–õ—ë–≥–∫–∞—è –≤—Å—Ç—Ä–∞–∏–≤–∞–µ–º–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π, —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ–∫–æ–≤ (54-–§–ó), –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–µ–±—Ö—É–∫–æ–≤ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞–º–∏.

---

## üîß –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ YooKassa
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ–∫–æ–≤ (54‚Äë–§–ó) –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–ª–æ–≥–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å aiogram: –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞–º–∏ –¥–ª—è –æ–ø–ª–∞—Ç—ã
- –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ retry –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ YooKassa SDK
- –ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –ø–ª–∞—Ç–µ–∂–µ–π: in-memory, JSON –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–≤–æ—ë
- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ webhook —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–æ–¥–ø–∏—Å–∏ –∏ callback-–∞–º–∏

---

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å PyPI:

```bash
pip install yookassa-telegram
```

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- Python 3.10+
- aiogram
- aiohttp
- yookassa

–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω—ã –≤ `pyproject.toml`.

---

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–ø—Ä–∏–º–µ—Ä `.env`):

```
YOOKASSA_SHOP_ID=123456
YOOKASSA_SECRET_KEY=test_xxxxx
YOOKASSA_RETURN_URL=https://example.com/payment/return
YOOKASSA_WEBHOOK_URL=https://example.com/webhook
YOOKASSA_IS_TEST=true
YOOKASSA_ENABLE_RECEIPTS=true
YOOKASSA_INN=1234567890
```

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å aiogram:

```python
from aiogram import Bot, Dispatcher
from yookassa_telegram_integration.config import YooKassaConfig
from yookassa_telegram_integration.yookassa_client import YooKassaClient
from yookassa_telegram_integration.payment_service import PaymentService
from yookassa_telegram_integration.receipt_service import ReceiptService
from yookassa_telegram_integration.refund_service import RefundService
from yookassa_telegram_integration.telegram_integration import (
    TelegramPaymentIntegration, create_payment_router
)
from yookassa_telegram_integration.storage import InMemoryPaymentStorage

config = YooKassaConfig.from_env()
client = YooKassaClient(config)
storage = InMemoryPaymentStorage()
payment_service = PaymentService(config, storage, client)
receipt_service = ReceiptService(config)
refund_service = RefundService(config, storage, client)

integration = TelegramPaymentIntegration(
    config,
    payment_service,
    receipt_service,
    refund_service,
    storage
)

router = create_payment_router(integration)
# –í–∫–ª—é—á–∏—Ç–µ router –≤ –≤–∞—à Dispatcher
# dp.include_router(router)
```

–ü—Ä–∏–º–µ—Ä –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∫–Ω–æ–ø–∫–æ–π –æ–ø–ª–∞—Ç—ã:

```python
await integration.send_payment_message(
    message,  # aiogram.types.Message
    amount=150.0,
    description='–û–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏',
    order_id='order_12345',
    user_email='user@example.com'
)
```

---

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–ö–ª—é—á–µ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ `YooKassaConfig`:
- `shop_id` –∏ `secret_key` ‚Äî –¥–∞–Ω–Ω—ã–µ –º–∞–≥–∞–∑–∏–Ω–∞ YooKassa
- `return_url` ‚Äî URL –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ –ø–ª–∞—Ç–µ–∂–∞
- `webhook_url` ‚Äî URL –¥–ª—è webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- `enable_receipts`, `inn`, `default_tax_system` ‚Äî –æ–ø—Ü–∏–∏ –¥–ª—è 54-–§–ó
- `auto_capture` ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂–∏

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `YooKassaConfig.from_env()` –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.

---

## Webhook (–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)

`WebhookHandler` –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–∞—Ä—Å–∏–Ω–≥ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π, –ø—Ä–æ–≤–µ—Ä–∫—É –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞, –∞ —Ç–∞–∫–∂–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é Callback-–æ–≤ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π.

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:

```python
from yookassa_telegram_integration.webhook_handler import (
    create_webhook_handler, WebhookEventType
)

async def on_success(notification):
    print('–û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞', notification.payment_id)

handler = create_webhook_handler(
    config,
    on_payment_succeeded=on_success
)

# –í —Ä—É—á–Ω–æ–º –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–µ / –Ω–∞ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–µ –ø–µ—Ä–µ–¥–∞–π—Ç–µ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –≤ handler.handle_webhook
# notification = await handler.handle_webhook(payload, headers)
```

---

## –•—Ä–∞–Ω–∏–ª–∏—â–µ (Storage)

–î–æ—Å—Ç—É–ø–Ω—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:
- `InMemoryPaymentStorage` ‚Äî –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ —Ç–µ—Å—Ç–æ–≤
- `JSONFilePaymentStorage` ‚Äî –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ –ø—Ä–æ—Ç–æ—Ç–∏–ø–∏—Ä–æ–≤–∞–Ω–∏—è

–î–ª—è production —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–≤–æ–π `PaymentStorage` –Ω–∞ –æ—Å–Ω–æ–≤–µ –°–£–ë–î (Postgres, SQLite) –∏–ª–∏ Redis.

---

## API (–∫—Ä–∞—Ç–∫–æ)

- `TelegramPaymentIntegration` ‚Äî –æ—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Telegram.
- `PaymentService` ‚Äî –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏ –æ—Ç–º–µ–Ω—ã –ø–ª–∞—Ç–µ–∂–µ–π.
- `YooKassaClient` ‚Äî –∫–ª–∏–µ–Ω—Ç-–æ–±—ë—Ä—Ç–∫–∞ –≤–æ–∫—Ä—É–≥ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ SDK —Å retry-–ª–æ–≥–∏–∫–æ–π.
- `WebhookHandler` ‚Äî –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ callback-—ã.
- `YooKassaConfig` ‚Äî –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è API –ö–ª–∏–µ–Ω—Ç–∞ –∏ —Å–µ—Ä–≤–∏—Å–æ–≤.
- –º–æ–¥–µ–ª–∏: `CustomerInfo`, `PaymentData`, `ReceiptData`, `PaymentItem`.

–ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è ‚Äî –≤ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞—Ö –∏ docstrings.

---

## –ü—Ä–∏–º–µ—Ä—ã (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ)

–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞:

```python
from yookassa_telegram_integration.payment_service import PaymentService
await payment_service.capture_payment(payment_id)
```

–û—Ç–º–µ–Ω–∞ –ø–ª–∞—Ç–µ–∂–∞:

```python
await payment_service.cancel_payment(payment_id)
```

–°–æ–∑–¥–∞–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—Ç–∞:

```python
from yookassa_telegram_integration.models import RefundData
await refund_service.create_refund(
    RefundData(
        payment_id='payment_123',
        amount=100.0,
        currency='RUB',
        description='–í–æ–∑–≤—Ä–∞—Ç –ø–æ –æ—à–∏–±–∫–µ'
    ),
    idempotency_key='refund_key_123'
)
```

## –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ —Ç–µ—Å—Ç—ã

–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ dev-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ—Å—Ç—ã:

```bash
pip install -e .[dev]
pytest
```
---

## –ü—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–∞ PyPI

–°–æ–∑–¥–∞–π—Ç–µ –±–∏–ª–¥—ã –∏ –æ–ø—É–±–ª–∏–∫—É–π—Ç–µ –ø–∞–∫–µ—Ç —Å –ø–æ–º–æ—â—å—é `build` –∏ `twine`:

```bash
python -m build
twine upload dist/*
```

–î–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞–∫–µ—Ç –≤ TestPyPI:

```bash
twine upload --repository testpypi dist/*
```

---

## Contributing

PR –∏ issue –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é—Ç—Å—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–µ—Ç–∫—É `main` –∫–∞–∫ –æ—Å–Ω–æ–≤—É –∏ —Å–ª–µ–¥—É–π—Ç–µ CONTRIBUTING.md (–µ—Å–ª–∏ –µ—Å—Ç—å).

–ü–µ—Ä–µ–¥ PR –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```bash
black .
mypy .
pytest
```

---

## –õ–∏—Ü–µ–Ω–∑–∏—è

–ü—Ä–æ–µ–∫—Ç —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ–¥ –ª–∏—Ü–µ–Ω–∑–∏–µ–π MIT. –ü–æ–¥—Ä–æ–±–Ω–µ–µ –≤ `LICENSE`.

---

## –ö–æ–Ω—Ç–∞–∫—Ç

–ê–≤—Ç–æ—Ä: rerowros  ¬∑  Email: rerowros@gmail.com

–ü–æ–¥–¥–µ—Ä–∂–∫–∞/Issues: https://github.com/Rerowros/yookassa-telegram/issues
