Metadata-Version: 2.4
Name: flowmeta
Version: 0.1.0
Summary: Integrated metagenomic workflow orchestration
Author-email: Dongqiang Zeng <interlaken@smu.edu.cn>
License: Proprietary
Requires-Python: >=3.8
Description-Content-Type: text/markdown
License-File: LICENSE
Requires-Dist: numpy>=1.21
Requires-Dist: pandas>=1.5
Dynamic: license-file

# FlowMeta: Automated End-to-End Metagenomic Profiling Pipeline ğŸš€

> Repository: <https://github.com/SkinMicrobe/FlowMeta>  
> Author: Dongqiang Zeng  
> Email: interlaken@smu.edu.cn

**FlowMeta** packages a 13-step, end-to-end metagenomic workflow into a single Python command that can be deployed on any Linux/WSL environment. Each processing phase writes `*.task.complete` flags so you can resume or re-run individual stages with confidence across microbiome, environmental, or any shotgun metagenomic study.

## âœ¨ Highlights
- End-to-end orchestration (`flowmeta_base`) covering fastp âœ Bowtie2 âœ Kraken2/Bracken âœ host-taxid filtering âœ final OTU/MPA matrix merge.
- Smart checkpointing with `.task.complete` for incremental runs.
- Shared-memory (optional) caching for Kraken2 databases.
- Configurable project prefix (e.g. `SMOOTH-`) applied to Step 6 outputs.
- Detailed per-step logs stored alongside generated data.

## ğŸ“¦ Installation

```bash
conda activate meta  # or any Python >= 3.8 environment
pip install flowmeta  # published on PyPI
```

Tip: the auxiliary YAML file [`environment.yml`](environment.yml) captures the recommended Conda environment, including Python, pandas/numpy, and the `build` toolchain. Alternative setup paths (Conda, mamba, pip) are described in `docs/tutorial.html` so you can pick the package manager that matches your infrastructure. When using an internal build, install the local wheel via `pip install dist/flowmeta-0.1.0-py3-none-any.whl`.

## ğŸ Quick Start

```bash
flowmeta_base \
    --input_dir /mnt/data/01-raw \
    --output_dir /mnt/data/flowmeta-out \
    --db_bowtie2 /mnt/db/GRCh38_noalt_as/GRCh38_noalt_as \
    --db_kraken /mnt/db/k2ppf \
    --threads 32 \
    --project_prefix SMOOTH-
```

All downstream folders (`02-qc` â€¦ `09-mpa`) are created automatically inside `--output_dir`. Existing results are reused unless `--force` is specified.

## ğŸ§­ CLI Cheatsheet

| Flag | Description |
| --- | --- |
| `--input_dir` | Directory containing raw FASTQ files (defaults to paired `_1.fastq.gz`/`_2.fastq.gz`). |
| `--output_dir` | Target workspace; the pipeline creates `02-qc` â€¦ `09-mpa` here. |
| `--db_bowtie2` | Path prefix of the host Bowtie2 index. |
| `--db_kraken` | Kraken2 database directory (must include `hash.k2d`, `opts.k2d`, `taxo.k2d`). |
| `--threads` | Worker threads per sample. |
| `--batch` | Number of samples processed in parallel (fastp/Kraken). |
| `--min_count` | Bracken minimum count threshold during host-taxid filtering (Step 5). |
| `--project_prefix` | Optional label prepended to Step 6 merged assets (e.g. `SMOOTH-`). |
| `--force` | Recompute even if `.task.complete` exists for the step. |
| `--skip_host_extract` | Skip samtools-based host FASTQ extraction (Step 3). |
| `--no_shm`/`--shm_path` | Control Kraken2 shared-memory caching. |

Full parameter descriptions and advanced scenarios are documented in `docs/tutorial.html`.

### Kraken2 Reference Databases

- ğŸ”— Download pre-built Kraken2 libraries directly from the official mirror: <https://benlangmead.github.io/aws-indexes/k2>
- ğŸ“¦ After downloading, extract the archive and point `--db_kraken` to the directory containing `hash.k2d`, `opts.k2d`, and `taxo.k2d`.
- ğŸ’¾ Consider staging the database on fast SSD or RAM disk when processing large cohorts.

### Bowtie2 Host Reference (Human Example)

1. ğŸ“¥ Fetch the GRCh38 primary assembly FASTA from the NCBI FTP mirror:
	```bash
	wget https://ftp.ncbi.nlm.nih.gov/genomes/all/GCA/000/001/405/GCA_000001405.28_GRCh38.p13/GCA_000001405.28_GRCh38.p13_genomic.fna.gz
	gunzip GCA_000001405.28_GRCh38.p13_genomic.fna.gz
	```
2. ğŸ§¹ Optionally remove alternative contigs if you prefer the `noalt` subset:
	```bash
	seqkit grep -rvp 'alt|PATCH' GCA_000001405.28_GRCh38.p13_genomic.fna > GRCh38_noalt.fna
	```
3. ğŸ§± Build the Bowtie2 index:
	```bash
	bowtie2-build GRCh38_noalt.fna GRCh38_noalt_as/GRCh38_noalt_as
	```
4. ğŸ“ Supply the resulting prefix directory to `--db_bowtie2` (e.g. `--db_bowtie2 /mnt/db/GRCh38_noalt_as/GRCh38_noalt_as`).

## ğŸ“‚ Output Layout

```
01-raw/           # user-supplied FASTQ (read-only)
02-qc/            # fastp outputs + integrity checks
03-hr/            # host-removed FASTQ
04-bam/           # Bowtie2 BAM/indices
05-host/          # optional host reads (samtools)
06-ku/            # Kraken2 reports/outputs
07-bracken/       # Bracken abundance tables
08-ku2/           # Host-filtered rerun (reports + diversity metrics)
09-mpa/           # Merge matrices, count tables, final summaries
```

Every folder contains per-sample `*.task.complete` markers to enable resumable runs.

## ğŸ› ï¸ Building From Source

```bash
pip install build
python -m build --wheel
ls dist/
```

The resulting wheel is compatible with Python â‰¥ 3.8. Remember to sync large reference databases manuallyâ€”the package ships only orchestration logic and helper scripts.

## ğŸ“š Documentation

- Companion README (operations cheat sheet): [`README.zh.md`](README.zh.md)
- HTML tutorial: [`docs/tutorial.html`](docs/tutorial.html)
- Quick validation script: `docs/quickstart.md`

## ğŸ¤ Support

For bug reports or integration questions please reach out directly:

**Dongqiang Zeng** Â· ğŸ“§ interlaken@smu.edu.cn

GitHub project: <https://github.com/SkinMicrobe/FlowMeta>

Happy sequencing! ğŸ§¬
