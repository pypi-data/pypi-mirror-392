from __future__ import annotations

from pydantic_fixturegen.cli import diff as diff_mod


def test_json_field_hints_detects_schema_changes() -> None:
    actual = '[{"id": 1, "name": "alice"}]'
    regenerated = '[{"id": 1, "name": "alice", "email": "a@example.com"}]'
    hints = diff_mod._json_field_hints(actual, regenerated, jsonl=False)
    assert any("email" in hint for hint in hints)


def test_fixture_header_hints_report_metadata_changes() -> None:
    payload = (
        "# Generated by pydantic-fixturegen v1 | seed=1 | model-digest=abc | scope=function | "
        "style=functions | return=model | cases=1 | models=models.User\n"
        "content"
    )
    expected = {
        "seed": "2",
        "model-digest": "def",
        "scope": "module",
        "style": "factory",
        "return": "dict",
        "cases": "2",
        "models": "models.User, models.Profile",
    }
    hints = diff_mod._fixture_header_hints(payload, expected)
    assert len(hints) >= 2
    assert any("seed" in hint for hint in hints)


def test_schema_definition_hints_surface_added_models() -> None:
    actual = '{"$defs": {"User": {"type": "object"}}}'
    regenerated = '{"$defs": {"User": {"type": "object"}, "Order": {"type": "object"}}}'
    hints = diff_mod._schema_definition_hints(actual, regenerated)
    assert any("Order" in hint for hint in hints)


def test_constraint_failure_hints_include_hint_messages() -> None:
    report = {
        "models": [
            {
                "model": "models.User",
                "fields": [
                    {
                        "name": "age",
                        "failures": [
                            {
                                "location": ["age"],
                                "hint": "increase upper bound",
                                "message": "error",
                            }
                        ],
                    }
                ],
            }
        ]
    }
    hints = diff_mod._constraint_failure_hints(report)
    assert hints and "age" in hints[0]
