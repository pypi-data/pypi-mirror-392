from .templates import autotest, utils, main, nonpies
from pathlib import Path
from . import helper
import shutil
import os

class Constructor:
    def __init__(self, pro_name:str, author:str, lic:str, 
                 path:str, dual_lic: str|None = None, 
                 no_lic:bool = False, minimal:bool = False, 
                 force: bool = False):
        self.name        = pro_name
        self.author      = author
        self.license     = lic
        self.dual_lic    = dual_lic
        self.no_license  = no_lic
        self.minimal     = minimal
        self.force       = force
        self.DRT_DIR     = Path(path)/self.name
        self.SRC_DIR     = self.DRT_DIR/"src"
        self.PRO_DIR     = self.SRC_DIR/self.name.lower()
        self.create_folders()
        self.create_drt_files()
        self.create_src_files()
        done_msg  = f"Created project {self.name!r} in "
        done_msg += f"{self.DRT_DIR.parent}"
        print(f"\n{utils.style_text(done_msg, 'green')}\n")
    
    def create_folders(self) -> None:
        if self.force and os.path.exists(self.DRT_DIR):
            otp = helper.gen_otp()
            pin = input(utils.style_text(f"\nEnter {otp!r} "
                + "to overwrite directory:\n"
                + f"'{self.DRT_DIR!s}': ", "yellow"))
            if pin == otp: shutil.rmtree(self.DRT_DIR)
            else: helper.err(otp=True)
            
        dirs = [self.DRT_DIR, self.SRC_DIR, self.PRO_DIR, 
                self.SRC_DIR/"tests"]
                
        for i, path in enumerate(dirs):
            if i == len(dirs) - 1 and self.minimal: continue
            path.mkdir(exist_ok=self.force)

    def create_drt_files(self) -> None:
        LICENSES = []
        if not self.no_license:
            LICENSES.append(nonpies.get_license(
                self.license, self.author))
            if self.dual_lic: 
                LICENSES.append(nonpies.get_license(
                    self.dual_lic, self.author))

        toml      = nonpies.gen_toml(self.name, self.author)
        readme    = nonpies.readme
        gitignore = nonpies.gitignore
        run       = nonpies.gen_runpy(self.name)
        scaffolds = LICENSES+ [run, toml, readme, gitignore]
        files     = ["LICENSE" if i==0 else f"LICENSE-{i+1}" 
                for i in range(len(LICENSES))] + ["run.py", 
                    "pyproject.toml", "README.md", 
                    ".gitignore"]

        for info, path in zip(scaffolds, files):
            with open(self.DRT_DIR/path, "w") as file:
                file.write(info)
        
        with open(self.DRT_DIR/"requirements.txt","w") as f:
            f.write("# Scaffolding generated by Droots")

    def create_src_files(self) -> None:
        n     = self.name.lower()
        inpy  = [autotest, utils, main]
        paths = ["autotest.py", "utils.py", f"{n}/main.py"]
        if self.minimal: inpy, paths = [main], [paths[-1]]

        for module, path in zip(inpy, paths):
            with open(module.__file__) as template:
                with open(self.SRC_DIR/path, "w") as file:
                    file.write(template.read())

        with open(self.PRO_DIR/"__init__.py", "w") as file:
            file.write(f"# Project: {self.name}\n")
            file.write(f"# Author: {self.author}\n")
            file.write(f"# License: {self.license}")
            if self.dual_lic:
                file.write(f", {self.dual_lic}")
            file.write("\n# Generated by Droots\n")
