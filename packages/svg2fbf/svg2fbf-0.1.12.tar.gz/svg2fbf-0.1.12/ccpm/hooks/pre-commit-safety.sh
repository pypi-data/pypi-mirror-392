#!/usr/bin/env bash
#
# Pre-Commit Safety Hook for CCPM Agents
#
# Purpose: Block commits that modify protected infrastructure files
# Usage: Called automatically by git pre-commit hook
# Exit codes:
#   0 - Safe to commit
#   1 - Blocked (protected file modified)
#
# Installation:
#   ln -sf ../../ccpm/hooks/pre-commit-safety.sh .git/hooks/pre-commit
#
# Author: CCPM Plugin
# Last updated: 2025-01-14

set -euo pipefail

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Paths
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# For worktrees, ccpm/ exists in main repo, not worktree (it's gitignored)
# Use --git-common-dir to find main .git, then navigate up to repo root
GIT_COMMON_DIR="$(git rev-parse --git-common-dir)"
MAIN_REPO_ROOT="$(cd "$GIT_COMMON_DIR/.." && pwd)"
PROTECTED_FILES_LIST="${MAIN_REPO_ROOT}/ccpm/rules/protected-files.txt"

# Check if protected files list exists
if [[ ! -f "$PROTECTED_FILES_LIST" ]]; then
    echo -e "${YELLOW}⚠️  Warning: Protected files list not found at:${NC}"
    echo "   $PROTECTED_FILES_LIST"
    echo "   Skipping protected file check."
    exit 0
fi

# Read protected files (skip comments and empty lines)
protected_patterns=()
while IFS= read -r line; do
    # Skip comments and empty lines
    [[ "$line" =~ ^[[:space:]]*# ]] && continue
    [[ -z "$line" ]] && continue

    # Add pattern to array
    protected_patterns+=("$line")
done < "$PROTECTED_FILES_LIST"

# Get staged files
staged_files=$(git diff --cached --name-only)

# Check each staged file against protected patterns
violations=()
for file in $staged_files; do
    for pattern in "${protected_patterns[@]}"; do
        # Check if pattern matches file
        # Support both exact match and glob patterns
        if [[ "$file" == $pattern ]]; then
            violations+=("$file")
            break
        fi
    done
done

# If violations found, block commit
if [[ ${#violations[@]} -gt 0 ]]; then
    echo -e "${RED}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${RED}║                 ⛔ COMMIT BLOCKED                         ║${NC}"
    echo -e "${RED}╚════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo -e "${RED}❌ ERROR: Attempting to modify protected infrastructure files${NC}"
    echo ""
    echo -e "${YELLOW}Protected files detected in this commit:${NC}"
    for file in "${violations[@]}"; do
        echo -e "   ${RED}✗${NC} $file"
    done
    echo ""
    echo -e "${YELLOW}Why this is blocked:${NC}"
    echo "   These files are critical infrastructure managed by humans only."
    echo "   Agents must NOT modify:"
    echo "   - justfile (build commands)"
    echo "   - scripts/release.sh (release automation)"
    echo "   - .github/workflows/* (CI/CD pipelines)"
    echo "   - CHANGELOG.md (auto-generated by git-cliff)"
    echo "   - pyproject.toml (project configuration)"
    echo ""
    echo -e "${GREEN}Recovery options:${NC}"
    echo ""
    echo "   1. Unstage protected files:"
    echo "      ${GREEN}git restore --staged <file>${NC}"
    echo ""
    echo "   2. Restore protected files to original state:"
    echo "      ${GREEN}git restore <file>${NC}"
    echo ""
    echo "   3. Commit only non-protected files:"
    echo "      ${GREEN}git add <safe-files>${NC}"
    echo "      ${GREEN}git commit${NC}"
    echo ""
    echo "   4. If you need to modify these files:"
    echo "      ${YELLOW}Contact a human maintainer for approval${NC}"
    echo ""
    echo -e "${YELLOW}See also:${NC}"
    echo "   - Protected files list: ccpm/rules/protected-files.txt"
    echo "   - Recovery procedures: ccpm/skills/recovery-procedures.md"
    echo ""

    exit 1
fi

# All clear
echo -e "${GREEN}✅ Pre-commit safety check passed${NC}"
echo "   No protected files modified"
exit 0
