{
  "parser_name": "ComfyUI Universal Parser",
  "priority": 100,
  "description": "Advanced ComfyUI parser that handles any workflow type with robust detection and extraction",
  "version": "2.0_universal_edition",
  "maintainer": "DuskFall Crew",
  "target_file_types": [
    "PNG",
    "JPEG",
    "JPG",
    "WEBP"
  ],
  "detection_rules": [
    {
      "comment": "Rule 1: Must have 'workflow' PNG chunk with valid JSON and ComfyUI node signatures",
      "operator": "AND",
      "rules": [
        {
          "source_type": "png_chunk",
          "source_key": "workflow",
          "operator": "exists"
        },
        {
          "source_type": "png_chunk",
          "source_key": "workflow",
          "operator": "is_valid_json"
        },
        {
          "comment": "Check for typical ComfyUI node types - using simple contains check instead of regex",
          "source_type": "png_chunk",
          "source_key": "workflow",
          "operator": "OR",
          "rules": [
            {"operator": "contains", "value": "KSampler"},
            {"operator": "contains", "value": "SamplerCustomAdvanced"},
            {"operator": "contains", "value": "CLIPTextEncode"}
          ]
        },
        {
          "comment": "Exclude Civitai ComfyUI files (they have extraMetadata and should use specialized parser)",
          "source_type": "png_chunk",
          "source_key": "workflow",
          "operator": "does_not_contain",
          "value": "extraMetadata"
        }
      ]
    },
    {
      "comment": "Rule 2: OR, must have 'prompt' pil_info_key with valid JSON and ComfyUI node signatures (for older/different formats)",
      "operator": "AND",
      "rules": [
        {
          "source_type": "pil_info_key",
          "source_key": "prompt",
          "operator": "is_valid_json"
        },
        {
          "comment": "Check for typical ComfyUI node types - using simple contains check instead of regex",
          "source_type": "pil_info_key",
          "source_key": "prompt",
          "operator": "OR",
          "rules": [
            {"operator": "contains", "value": "KSampler"},
            {"operator": "contains", "value": "SamplerCustomAdvanced"},
            {"operator": "contains", "value": "CLIPTextEncode"}
          ]
        },
        {
          "comment": "Exclude Civitai ComfyUI files (they have extraMetadata and should use specialized parser)",
          "source_type": "pil_info_key",
          "source_key": "prompt",
          "operator": "does_not_contain",
          "value": "extraMetadata"
        }
      ]
    },
    {
      "comment": "Rule 3: Must NOT be a Civitai JPEG ComfyUI file (exclude EXIF UserComment with extraMetadata)",
      "operator": "NOT",
      "rules": [
        {
          "operator": "AND",
          "rules": [
            {
              "source_type": "exif_user_comment",
              "operator": "is_valid_json"
            },
            {
              "source_type": "exif_user_comment",
              "operator": "contains",
              "value": "extraMetadata"
            }
          ]
        }
      ]
    },
    {
      "comment": "Rule 4: Must NOT have ModelSamplingAuraFlow in workflow or prompt",
      "operator": "AND",
      "rules": [
        {
          "source_type": "pil_info_key",
          "source_key": "workflow",
          "operator": "does_not_contain",
          "value": "ModelSamplingAuraFlow"
        },
        {
          "source_type": "pil_info_key",
          "source_key": "prompt",
          "operator": "does_not_contain",
          "value": "ModelSamplingAuraFlow"
        }
      ]
    },
    {
      "comment": "Rule 5: Must NOT have ModelSamplingSD3 in workflow or prompt",
      "operator": "AND",
      "rules": [
        {
          "source_type": "pil_info_key",
          "source_key": "workflow",
          "operator": "does_not_contain",
          "value": "ModelSamplingSD3"
        },
        {
          "source_type": "pil_info_key",
          "source_key": "prompt",
          "operator": "does_not_contain",
          "value": "ModelSamplingSD3"
        }
      ]
    },
    {
      "comment": "Rule 6: Must NOT have ModelSamplingFlux in workflow or prompt",
      "operator": "AND",
      "rules": [
        {
          "source_type": "pil_info_key",
          "source_key": "workflow",
          "operator": "does_not_contain",
          "value": "ModelSamplingFlux"
        },
        {
          "source_type": "pil_info_key",
          "source_key": "prompt",
          "operator": "does_not_contain",
          "value": "ModelSamplingFlux"
        }
      ]
    },
    {
      "comment": "Rule 7: Must NOT have Chroma LoRAs in workflow (use Chroma-specific parser)",
      "operator": "AND",
      "rules": [
        {
          "source_type": "pil_info_key",
          "source_key": "workflow",
          "operator": "does_not_contain",
          "value": "Chroma-Anime"
        },
        {
          "source_type": "pil_info_key",
          "source_key": "workflow",
          "operator": "does_not_contain",
          "value": "chroma_v10HD"
        }
      ]
    }
  ],
  "parsing_instructions": {
    "input_data": {
      "source_options": [
        {
          "source_type": "pil_info_key",
          "source_key": "workflow"
        },
        {
          "source_type": "pil_info_key",
          "source_key": "prompt"
        }
      ],
      "transformations": [
        {
          "type": "json_decode_string_itself"
        }
      ]
    },
    "fields": [
      {
        "comment": "Extract positive prompt from text encoding nodes",
        "target_key": "prompt",
        "method": "comfy_find_text_from_main_sampler_input",
        "sampler_node_types": [
          "KSampler",
          "KSamplerAdvanced",
          "SamplerCustomAdvanced",
          "KSampler_A1111"
        ],
        "positive_input_name": "positive",
        "text_input_name_in_encoder": "text",
        "text_encoder_node_types": [
          "CLIPTextEncode",
          "BNK_CLIPTextEncodeAdvanced",
          "CLIPTextEncodeAdvanced",
          "T5TextEncode",
          "PixArtT5TextEncode",
          "CLIPTextEncodeSDXL",
          "CLIPTextEncodeSDXLRefiner",
          "smZ CLIPTextEncode",
          "PrimitiveStringMultiline",
          "easy positive"
        ]
      },
      {
        "comment": "Extract negative prompt from text encoding nodes",
        "target_key": "negative_prompt",
        "method": "comfy_find_text_from_main_sampler_input",
        "sampler_node_types": [
          "KSampler",
          "KSamplerAdvanced",
          "SamplerCustomAdvanced",
          "KSampler_A1111"
        ],
        "negative_input_name": "negative",
        "text_input_name_in_encoder": "text",
        "text_encoder_node_types": [
          "CLIPTextEncode",
          "BNK_CLIPTextEncodeAdvanced",
          "CLIPTextEncodeAdvanced",
          "T5TextEncode",
          "PixArtT5TextEncode",
          "CLIPTextEncodeSDXL",
          "CLIPTextEncodeSDXLRefiner",
          "smZ CLIPTextEncode",
          "PrimitiveStringMultiline",
          "easy positive"
        ]
      },
      {
        "comment": "Extract seed from sampler",
        "target_key": "parameters.seed",
        "method": "comfy_find_input_of_main_sampler",
        "sampler_node_types": [
          "KSampler",
          "KSamplerAdvanced",
          "SamplerCustomAdvanced",
          "KSampler_A1111"
        ],
        "input_field": "seed",
        "value_type": "integer"
      },
      {
        "comment": "Extract steps from sampler",
        "target_key": "parameters.steps",
        "method": "comfy_find_input_of_main_sampler",
        "sampler_node_types": [
          "KSampler",
          "KSamplerAdvanced",
          "SamplerCustomAdvanced",
          "KSampler_A1111"
        ],
        "input_field": "steps",
        "value_type": "integer"
      },
      {
        "comment": "Extract cfg_scale from sampler",
        "target_key": "parameters.cfg_scale",
        "method": "comfy_find_input_of_main_sampler",
        "sampler_node_types": [
          "KSampler",
          "KSamplerAdvanced",
          "SamplerCustomAdvanced",
          "KSampler_A1111"
        ],
        "input_field": "cfg",
        "value_type": "float"
      },
      {
        "comment": "Extract sampler name",
        "target_key": "parameters.sampler_name",
        "method": "comfy_find_input_of_main_sampler",
        "sampler_node_types": [
          "KSampler",
          "KSamplerAdvanced",
          "SamplerCustomAdvanced",
          "KSampler_A1111"
        ],
        "input_field": "sampler_name",
        "value_type": "string"
      },
      {
        "comment": "Extract width from latent image nodes",
        "target_key": "parameters.width",
        "method": "comfy_find_node_input_or_widget_value",
        "node_criteria": [
          {
            "class_type": "EmptyLatentImage"
          },
          {
            "class_type": "LatentUpscale"
          },
          {
            "class_type": "EmptyLatentImageFromPresetsSDXL"
          },
          {
            "class_type": "EmptySD3LatentImage"
          }
        ],
        "input_field": "width",
        "value_type": "integer"
      },
      {
        "comment": "Extract height from latent image nodes",
        "target_key": "parameters.height",
        "method": "comfy_find_node_input_or_widget_value",
        "node_criteria": [
          {
            "class_type": "EmptyLatentImage"
          },
          {
            "class_type": "LatentUpscale"
          },
          {
            "class_type": "EmptyLatentImageFromPresetsSDXL"
          },
          {
            "class_type": "EmptySD3LatentImage"
          }
        ],
        "input_field": "height",
        "value_type": "integer"
      },
      {
        "comment": "Extract scheduler from sampler",
        "target_key": "parameters.scheduler",
        "method": "comfy_find_input_of_main_sampler",
        "sampler_node_types": [
          "KSampler",
          "KSamplerAdvanced",
          "SamplerCustomAdvanced",
          "KSampler_A1111"
        ],
        "input_field": "scheduler",
        "value_type": "string"
      },
      {
        "comment": "Extract model/checkpoint name",
        "target_key": "parameters.model",
        "method": "comfy_find_input_of_node_type",
        "node_types": [
          "CheckpointLoaderSimple",
          "UNETLoader",
          "CheckpointLoader"
        ],
        "input_field": "ckpt_name",
        "data_type": "string"
      },
      {
        "comment": "Extract denoise strength (for img2img workflows)",
        "target_key": "parameters.denoise",
        "method": "comfy_find_input_of_main_sampler",
        "sampler_node_types": [
          "KSampler",
          "KSamplerAdvanced",
          "SamplerCustomAdvanced"
        ],
        "input_field": "denoise",
        "value_type": "float"
      },
      {
        "comment": "Extract batch size",
        "target_key": "parameters.batch_size",
        "method": "comfy_find_input_of_node_type",
        "node_types": [
          "EmptyLatentImage",
          "EmptySD3LatentImage"
        ],
        "input_field": "batch_size",
        "data_type": "integer"
      },
      {
        "comment": "Extract LoRA information",
        "target_key": "parameters.loras",
        "method": "comfy_find_all_lora_nodes",
        "lora_node_types": [
          "LoraLoader",
          "LoraLoaderModelOnly",
          "LoraTagLoader",
          "Power Lora Loader (rgthree)"
        ],
        "extract_fields": [
          "lora_name",
          "strength_model",
          "strength_clip"
        ]
      },
      {
        "comment": "Extract VAE model",
        "target_key": "parameters.vae_model",
        "method": "comfy_find_input_of_node_type",
        "node_types": [
          "VAELoader"
        ],
        "input_field": "vae_name",
        "data_type": "string"
      },
      {
        "comment": "Extract raw workflow metadata",
        "target_key": "raw_metadata",
        "method": "comfyui_extract_raw_workflow"
      },
      {
        "comment": "ðŸŽ¯ TIPO AI Prompt Enhancement Detection",
        "target_key": "workflow_analysis.tipo_enhancement",
        "method": "comfyui_detect_tipo_enhancement"
      },
      {
        "comment": "ðŸ“Š Workflow Complexity Analysis",
        "target_key": "workflow_analysis.workflow_complexity",
        "method": "comfyui_calculate_workflow_complexity"
      },
      {
        "comment": "ðŸš€ Advanced Upscaling Detection",
        "target_key": "workflow_analysis.advanced_upscaling",
        "method": "comfyui_detect_advanced_upscaling"
      },
      {
        "comment": "ðŸŽ¨ Multi-Stage Conditioning Detection",
        "target_key": "workflow_analysis.multi_stage_conditioning",
        "method": "comfyui_detect_multi_stage_conditioning"
      },
      {
        "comment": "âœ¨ Post-Processing Effects Detection",
        "target_key": "workflow_analysis.post_processing_effects",
        "method": "comfyui_detect_post_processing_effects"
      },
      {
        "comment": "ðŸ”Œ Custom Node Ecosystem Detection",
        "target_key": "workflow_analysis.custom_node_ecosystems",
        "method": "comfyui_detect_custom_node_ecosystems"
      },
      {
        "comment": "ðŸŽ¯ High-Level Workflow Techniques",
        "target_key": "workflow_analysis.workflow_techniques",
        "method": "comfyui_extract_workflow_techniques"
      }
    ],
    "output_template": {
      "parser_name_from_engine": "ComfyUI Universal Parser",
      "tool": "ComfyUI (Universal Parser)",
      "format": "ComfyUI Generic Workflow",
      "parser_version": "2.0_universal_enhanced",
      "prompt": "$prompt",
      "negative_prompt": "$negative_prompt",
      "parameters": {
        "model": "$parameters.model",
        "seed": "$parameters.seed",
        "steps": "$parameters.steps",
        "cfg_scale": "$parameters.cfg_scale",
        "sampler_name": "$parameters.sampler_name",
        "scheduler": "$parameters.scheduler",
        "denoise": "$parameters.denoise",
        "width": "$parameters.width",
        "height": "$parameters.height",
        "batch_size": "$parameters.batch_size",
        "loras": "$parameters.loras",
        "vae_model": "$parameters.vae_model"
      },
      "raw_metadata": "$raw_metadata",
      "workflow_analysis": {
        "tipo_enhancement": "$workflow_analysis.tipo_enhancement",
        "workflow_complexity": "$workflow_analysis.workflow_complexity",
        "advanced_upscaling": "$workflow_analysis.advanced_upscaling",
        "multi_stage_conditioning": "$workflow_analysis.multi_stage_conditioning",
        "post_processing_effects": "$workflow_analysis.post_processing_effects",
        "custom_node_ecosystems": "$workflow_analysis.custom_node_ecosystems",
        "workflow_techniques": "$workflow_analysis.workflow_techniques"
      },
      "workflow_metadata": {
        "source": "ComfyUI workflow",
        "parser_priority": 100,
        "confidence": "high",
        "parser_used": "Universal ComfyUI Parser",
        "notes": "Handles standard ComfyUI workflows (SDXL, SD1.5, and other variants)"
      }
    }
  },
  "engineering_notes": {
    "design_goals": [
      "Built for reliability and broad ComfyUI support",
      "Handles both legacy SDXL and modern FLUX workflows",
      "Robust detection prevents conflicts with specialized parsers",
      "Uses proven extraction methods instead of placeholders",
      "Designed for extensibility as ComfyUI evolves"
    ],
    "technical_features": [
      "SamplerCustomAdvanced support for FLUX workflows",
      "DualCLIPLoader detection for advanced text encoding",
      "Fallback model detection (checkpoint OR FLUX unet)",
      "Flexible prompt extraction from any CLIP encoder variant",
      "Future-proof node type detection"
    ],
    "implementation": [
      "Real metadata extraction instead of placeholder text",
      "Handles workflow complexity without breaking",
      "Clean, maintainable architecture",
      "Ready for new ComfyUI node types"
    ]
  },
  "supported_workflows": [
    "SDXL with KSampler",
    "FLUX with SamplerCustomAdvanced + BasicGuider",
    "Any ComfyUI workflow with CLIPTextEncode variants",
    "Complex multi-node workflows",
    "Custom sampling setups",
    "Future ComfyUI developments"
  ],
  "status": "production_ready",
  "enhanced_with_node_discovery": true,
  "enhancement_date": "2025-07-08"
}
