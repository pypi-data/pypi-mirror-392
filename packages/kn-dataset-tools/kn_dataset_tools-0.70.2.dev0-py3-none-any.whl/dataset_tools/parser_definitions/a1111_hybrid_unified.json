{
  "parser_name": "A1111 Hybrid (Unified)",
  "priority": 175,
  "description": "Unified parser for hybrid A1111/ComfyUI systems - handles A1111 format with optional ComfyUI workflow presence",
  "version": "2.0",
  "maintainer": "Dataset-Tools",
  "target_file_types": ["PNG", "JPEG", "WEBP"],

  "detection_rules": [
    {
      "comment": "Rule 1: Must have A1111-style parameter text with standard fields",
      "source_type": "a1111_parameter_string_content",
      "operator": "regex_match_all",
      "regex_patterns": ["Steps:", "Sampler:", "CFG scale:"]
    },
    {
      "comment": "Rule 2: Must mention ComfyUI backend (this is what makes it hybrid!)",
      "source_type": "a1111_parameter_string_content",
      "operator": "regex_match_any",
      "regex_patterns": [
        "Version: ComfyUI",
        "Tool version: ComfyUI",
        "Backend: ComfyUI"
      ]
    },
    {
      "comment": "Rule 3: Must NOT be Civitai (let Civitai parser handle those)",
      "operator": "NOT",
      "rules": [
        {
          "source_type": "a1111_parameter_string_content",
          "operator": "regex_match_any",
          "regex_patterns": ["Civitai resources:", "Civitai metadata:"]
        }
      ]
    }
  ],

  "parsing_instructions": {
    "input_data": {
      "source_options": [
        {"source_type": "pil_info_key", "source_key": "parameters"},
        {"source_type": "exif_user_comment"}
      ],
      "transformations": [
        {"type": "conditional_json_unwrap_parameters_string"}
      ]
    },
    "extraction_strategy": "a1111_text_parsing",
    "format_description": "A1111 text format (may have ComfyUI backend or workflow present)",
    "fields": [
      {
        "comment": "Extract the full workflow for debugging/inspection (if present)",
        "target_key": "raw_workflow_json",
        "method": "direct_context_key",
        "context_key": "comfyui_workflow_json",
        "optional": true
      },
      {
        "comment": "Detect if this is ComfyRoll workflow specifically",
        "target_key": "is_comfyroll",
        "method": "context_workflow_contains_string",
        "search_string": "\"class_type\": \"CR ",
        "optional": true
      },
      {
        "comment": "Detect ComfyUI backend mentions",
        "target_key": "has_comfyui_backend",
        "method": "regex_on_input_data_string",
        "pattern": "(Version|Tool version|Backend):\\s*ComfyUI",
        "value_type": "boolean",
        "optional": true
      },
      {
        "target_key": "prompt",
        "method": "a1111_extract_prompt_positive"
      },
      {
        "target_key": "negative_prompt",
        "method": "a1111_extract_prompt_negative"
      },
      {
        "target_key": "parameters.steps",
        "method": "key_value_extract_from_a1111_block",
        "key_name": "Steps",
        "value_type": "integer"
      },
      {
        "target_key": "parameters.sampler",
        "method": "key_value_extract_from_a1111_block",
        "key_name": "Sampler",
        "value_type": "string"
      },
      {
        "target_key": "parameters.cfg_scale",
        "method": "key_value_extract_from_a1111_block",
        "key_name": "CFG scale",
        "value_type": "float"
      },
      {
        "target_key": "parameters.seed",
        "method": "key_value_extract_from_a1111_block",
        "key_name": "Seed",
        "value_type": "integer"
      },
      {
        "target_key": "parameters.size",
        "method": "key_value_extract_from_a1111_block",
        "key_name": "Size",
        "value_type": "string"
      },
      {
        "target_key": "parameters.model",
        "method": "key_value_extract_from_a1111_block",
        "key_name": "Model",
        "value_type": "string",
        "optional": true
      },
      {
        "target_key": "parameters.model_hash",
        "method": "key_value_extract_from_a1111_block",
        "key_name": "Model hash",
        "value_type": "string",
        "optional": true
      },
      {
        "target_key": "parameters.version",
        "method": "key_value_extract_from_a1111_block",
        "key_name": "Version",
        "value_type": "string",
        "optional": true
      },
      {
        "target_key": "parameters.backend_version",
        "method": "key_value_extract_from_a1111_block",
        "key_name": "Tool version",
        "value_type": "string",
        "optional": true
      },
      {
        "comment": "Preserve the original A1111 parameter string",
        "target_key": "raw_a1111_string",
        "method": "direct_input_data_as_string"
      }
    ],
    "output_template": {
      "tool": "A1111 Hybrid Format",
      "parser": "a1111_hybrid_unified",
      "prompt": "$prompt",
      "negative_prompt": "$negative_prompt",
      "parameters": {
        "steps": "$parameters.steps",
        "sampler": "$parameters.sampler",
        "cfg_scale": "$parameters.cfg_scale",
        "seed": "$parameters.seed",
        "size": "$parameters.size",
        "model": "$parameters.model",
        "model_hash": "$parameters.model_hash",
        "version": "$parameters.version",
        "backend_version": "$parameters.backend_version"
      },
      "raw_metadata": "$raw_a1111_string",
      "raw_workflow": "$raw_workflow_json",
      "system_info": {
        "hybrid_setup": "$has_comfyui_backend",
        "comfyui_workflow_present": "$raw_workflow_json",
        "extraction_source": "A1111 parameter text"
      },
      "_metadata": {
        "processed_at": "$CURRENT_TIMESTAMP",
        "processor": "MetadataEngine",
        "template_processed": true
      }
    }
  },
  "notes": [
    "Unified parser replacing a1111_string_with_workflow and hybrid_a1111_comfyui",
    "Priority 165 puts it above standard a1111_webui (170) but below Civitai (172)",
    "Handles three scenarios:",
    "  1. A1111 format with ComfyUI workflow JSON present",
    "  2. A1111 format with ComfyUI backend mentioned in Version/Tool fields",
    "  3. Pure A1111 format that mentions ComfyUI compatibility",
    "Extracts from A1111 parameter text - workflow is preserved but not parsed"
  ]
}
