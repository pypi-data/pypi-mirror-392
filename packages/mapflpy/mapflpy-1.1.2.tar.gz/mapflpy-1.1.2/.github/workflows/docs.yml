name: Publish Docs

on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - master
    tags:
      - '*'

permissions:
  contents: read

jobs:
  build_docs:
    name: Build docs
    runs-on: ubuntu-latest

    steps:
#      - uses: mamba-org/setup-micromamba@v2
#        with:
#          init-shell: bash
#          cache-downloads: true
#
#      - name: Checkout mapflpy
#        uses: actions/checkout@v4
#
#      - name: Setup Python
#        uses: actions/setup-python@v5
#        with:
#          python-version: 3.13
#
#      - name: Install build dependencies
#        run: |
#          python -m pip install --upgrade pip
#          pip install nox[pbs]
#
#      - name: Set nox conda backend
#        run: echo "CONDA_EXE=micromamba" >> "$GITHUB_ENV"
#
#      - name: Build docs
#        run: |
#          nox -s build_docs
#
#      - name: Upload docs artifact
#        if: always()
#        uses: actions/upload-artifact@v4
#        with:
#          name: docs
#          path: .nox/_artifacts/docs/html*/
#          retention-days: 7

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Create dummy docs
        run: |
          mkdir -p .nox/_artifacts/docs/html-test
          date > .nox/_artifacts/docs/html-test/build-info.txt
          echo '<html><body><h1>RSYNC TEST OK</h1></body></html>' \
            > .nox/_artifacts/docs/html-test/index.html
          ls -alR .nox/_artifacts/docs

      - name: Upload dummy docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: dummy-docs
          path: .nox/_artifacts/docs/html-test/
          retention-days: 7

      - name: Prepare SSH
        env:
          SSH_HOST: ${{ secrets.DOCS_SSH_HOST }}
          SSH_PORT: ${{ secrets.DOCS_SSH_PORT }}
        run: |
          install -m 700 -d ~/.ssh
          install -m 600 /dev/null ~/.ssh/id_rsync
          printf '%s\n' "${{ secrets.DOCS_SSH_KEY }}" > ~/.ssh/id_rsync
          ssh-keyscan -p "${SSH_PORT:-22}" "${SSH_HOST}" >> ~/.ssh/known_hosts

      - name: Rsync to server
        env:
          SSH_HOST: ${{ secrets.DOCS_SSH_HOST }}
          SSH_USER: ${{ secrets.DOCS_SSH_USER }}
          SSH_PORT: ${{ secrets.DOCS_SSH_PORT }}
          REMOTE_DIR: ${{ secrets.DOCS_SSH_PATH }}
        run: |
          # ensure target dir exists
          ssh -i ~/.ssh/id_rsync -p "${SSH_PORT:-22}" -o StrictHostKeyChecking=yes \
            "${SSH_USER}@${SSH_HOST}" "mkdir -p '${REMOTE_DIR}'"
          rsync -az \
            -e "ssh -i ~/.ssh/id_rsync -p ${SSH_PORT:-22} -o StrictHostKeyChecking=yes" \
            .nox/_artifacts/docs/html*/ "${SSH_USER}@${SSH_HOST}:${REMOTE_DIR}/"
