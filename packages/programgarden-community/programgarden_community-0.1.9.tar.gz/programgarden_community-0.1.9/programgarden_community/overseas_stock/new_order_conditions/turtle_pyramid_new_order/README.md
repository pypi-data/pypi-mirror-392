# 터틀 피라미딩 신규 주문 (해외주식)

## 전략 ID
`TurtlePyramidNewOrder`

## 전략 기여자
ProgramGarden Team

## 간단한 설명

이 전략은 **터틀 규칙에 맞게 “조금씩 나눠 사기(피라미딩)”를 자동으로 도와주는 신규 주문 로직**입니다.

계좌에서 한 번에 감당할 수 있는 손실 금액과 ATR(평균 진폭)을 기준으로 **안전한 1단계 매수 수량**을 계산하고,
가격이 예상대로 우호적으로 움직일 때마다 **다음 유닛을 차분히 추가**해 주도록 설계되어 있습니다.

## 이 전략이 필요한 이유

- 터틀 철학은 **“추세가 분명할 때만 들어가고, 한 번에 잃을 수 있는 금액을 미리 정하라”** 는 데서 출발합니다.
- 실제 매매에서는 이 철학을 숫자로 바꾸는 과정이 번거롭습니다.
  - 계좌 크기에 맞게 1회 손실 한도를 정하고,
  - ATR로 종목의 일평균 흔들림을 계산한 뒤,
  - 거기에 맞춰 **몇 주를 사야 하는지, 언제 추가 매수를 할지** 다시 계산해야 합니다.
- `TurtlePyramidNewOrder`는 이런 계산을 자동으로 수행해,
  - **계좌 크기에 맞는 1단계 진입 수량**,
  - **추가 매수(피라미딩)를 언제까지 허용할지**,
  - **이미 주문·보유 수량이 충분한지**
  를 규칙적으로 판단해 줍니다.
- 덕분에 운영자는 “이 종목을 터틀 규칙에 맞게 나눠 사는 것이 맞는가?”에 집중할 수 있고,
  **실제 수량 계산과 기록 관리는 전략에 맡길 수 있습니다.**

## 전략 상세 설명

### 어떤 방식으로 동작하나요?

1. **후보 종목 확인**
    - 필요하다면 다시 한 번 추세·변동성을 점검해, **지금 피라미딩을 시작할 만한 자리인지** 확인합니다.
2. **위험 한도(R) 계산**
    - 계좌에서 **한 번의 거래에 허용할 손실 비율**(`risk_per_trade`)을 정합니다. (예: 계좌의 1%)
    - 계좌 총액과 곱해, 이번 거래에서 감당 가능한 금액 위험(R)을 계산합니다.
3. **1단계 매수 수량 계산**
    - 종목의 ATR(평균 진폭)을 참고해, **손절선까지의 가격 거리**를 어림잡아 구합니다.
    - 금액 위험(R)을 이 가격 거리로 나누어, **1단계에서 매수할 주식 수(유닛 크기)** 를 계산합니다.
    - 최소 거래 단위(`min_trade_size`)와 너무 싼 종목(`min_price` 미만)을 제외하는 조건도 함께 반영합니다.
4. **피라미딩 단계 기록**
    - 주문이 실제로 나가면, 현재 작업 폴더에 **가벼운 기록 파일**을 만들어 종목별 피라미딩 상태를 저장합니다.
    - “지금 이 종목은 몇 유닛째인지, 어느 가격에서 진입했는지”를 기억해 두었다가 다음 주문 때 참고합니다.
5. **추가 매수(피라미딩) 조건 확인**
    - 가격이 **미리 정한 거리(`pyramid_trigger_atr` × ATR)** 만큼 더 올라가면, 다음 유닛을 추가할 수 있는지 확인합니다.
    - 추세가 기대한 방향으로 계속 이어질 때만 **최대 허용 유닛 수(`max_units_per_symbol`)까지** 천천히 물량을 늘립니다.
6. **안전장치 체크**
    - 이미 미체결 주문이 있거나,
    - 현재 보유 유닛 수가 `max_units_per_symbol`에 도달했거나,
    - 예수금(또는 `account_equity`)이 부족하면 **추가 주문을 자동으로 건너뜁니다.**

### 방향성은 이렇게 해석하세요

- 이 전략은 **“어느 방향으로 매매할지”를 직접 고르는 전략이 아니라**,
  이미 터틀 스캐너/추세 전략에서 상승(또는 하락) 방향이 정해진 종목에 대해
  **“얼마나, 어떻게 나눠 살지(또는 나눠 쌓을지)”를 관리하는 주문 전략**입니다.
- 방향(롱/숏) 자체는 상위 전략에서 결정되고,
  이 전략은 해당 방향에 맞춰 **유닛 수와 피라미딩 단계를 관리하는 보조 역할**을 합니다.

### 활용 시나리오

- 해외주식 종목을 대상으로,
  **계좌 크기에 맞는 1% 위험 피라미딩 규칙을 자동으로 적용**하고 싶을 때
- 감정에 휘둘리지 않고, **“올라갈 때만 추가로 사는” 추세 추종 원칙**을 일관되게 지키고 싶을 때
- 여러 종목에 터틀 전략을 동시에 적용하면서, **각 종목의 피라미딩 단계와 주문 이력을 자동으로 기록·관리**하고 싶을 때

## DSL 예시
```python
{
    "condition_id": "TurtlePyramidNewOrder",
    "params": {
        "appkey": "발급받은키",
        "appsecretkey": "발급받은시크릿",
        "risk_per_trade": 0.01,
        "pyramid_trigger_atr": 0.5,
        "limit_buffer_atr": 0.1
    }
}
```

## 파라미터 설명

| 이름 | 타입 | 기본값 | 설명 |
| --- | --- | --- | --- |
| `risk_per_trade` | float | 0.01 | 계좌의 몇 %를 한 번의 거래에 걸지 결정합니다. 일반적으로 1% 수준을 권장합니다. |
| `max_units_per_symbol` | int | 4 | 한 종목을 최대 몇 유닛까지 쌓을지(피라미딩 단계 수)를 제한합니다. |
| `pyramid_trigger_atr` | float | 0.5 | 가격이 **몇 ATR만큼 유리하게** 움직였을 때 다음 유닛을 추가할지 결정합니다. 예: 0.5면 “평균 하루 변동의 절반만큼” 올라가야 다음 매수를 고려합니다. |
| `limit_buffer_atr` | float | 0.1 | 지정가 주문을 넣을 때, 시장 가격에서 **몇 ATR만큼 여유를 둘지**를 정합니다. 너무 작으면 체결이 잘 안 되고, 너무 크면 원하던 가격보다 비싸게 살 수 있습니다. |
| `min_trade_size` | int | 1 | 거래소가 허용하는 최소 거래 수량입니다. 이 값보다 작은 주문은 만들지 않습니다. |
| `min_price` | float | 1.0 | 이 가격보다 싼 주식은 변동성이 과도할 수 있어 자동으로 제외합니다. |
| `appkey` | str | - | LS증권 Open API 앱키입니다. |
| `appsecretkey` | str | - | LS증권 Open API 앱시크릿입니다. |

## 전략 사용 시 주의사항

- 이 전략은 **터틀 규칙에 맞춘 주문·피라미딩 로직**을 자동화해 줍니다.
- `risk_per_trade`를 너무 높게 잡으면 연속 손실 시 계좌 변동폭이 커질 수 있으므로, 본인의 리스크 성향에 맞게 보수적으로 설정하는 것을 권장합니다.
