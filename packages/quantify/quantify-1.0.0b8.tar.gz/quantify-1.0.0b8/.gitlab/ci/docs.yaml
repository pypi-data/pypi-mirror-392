.docs-base:
  stage: Docs
  needs:
    - job: build-ci-image
    - job: build-package
      artifacts: true
    - job: pre-commit
    - job: pyright
    - job: pytest-linux
    - job: pytest-linux-py312-coverage
  image: $CI_IMAGE
  before_script:
    - git config --add --global safe.directory "$CI_PROJECT_DIR"
    - git fetch --tags
    - python -m pip install -U "pip==25.3" "setuptools==80.9.0" "wheel==0.45.1"
    - python -m pip install dist/*.whl
    - |
      python -m pip install \
        "jupyter-sphinx>=0.5.3" \
        "jupytext>=1.18.1" \
        "linkify-it-py>=2.0.3" \
        "myst-nb>=1.3.0" \
        "myst-parser>=4.0.1" \
        "nbsphinx>=0.9.7" \
        "plotly>=6.4.0" \
        "pydata-sphinx-theme>=0.16.1" \
        "quantify_scheduler[zhinst]>=0.25.0" \
        "scanpydoc>=0.15.4" \
        "sphinx>=8.1.3" \
        "sphinx-autoapi>=3.6.1" \
        "sphinx-autobuild>=2024.10.3" \
        "sphinx-autodoc-typehints>=3.0.1" \
        "sphinx-copybutton>=0.5.2" \
        "sphinx-design>=0.6.1" \
        "sphinx-jsonschema>=1.19.1" \
        "sphinx-rtd-theme>=3.0.2" \
        "sphinx-togglebutton>=0.3.2" \
        "sphinxcontrib-bibtex>=2.6.5" \
        "sphinxcontrib-mermaid>=1.0.0"
  cache:
    key: "sphinx-doctrees"
    paths:
      - docs/_build/doctrees/
    policy: pull-push
    when: on_success

build-documentation:
  extends: .docs-base
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH'
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: never
    - if: '$CI_COMMIT_TAG'
      when: never
  script:
    - |
      OUT_DIR="docs/_build/html"
      echo "Building docs (no deploy) to: $OUT_DIR"
      sphinx-build -b html --keep-going -d docs/_build/doctrees docs/source "$OUT_DIR"
  artifacts:
    expose_as: "Documentation preview"
    paths:
      - docs/_build/html

pages:
  extends: .docs-base
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
    - if: '$CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+((rc|a|b)[0-9]+)?$/'
  script:
    # Build documentation (tagged releases go under /<tag>/)
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        export DOCS_VERSION="$CI_COMMIT_TAG"
        OUT_DIR="public/$CI_COMMIT_TAG"
      else
        export DOCS_VERSION="dev"
        OUT_DIR="public"
      fi
      echo "Building docs to: $OUT_DIR (DOCS_VERSION=$DOCS_VERSION)"
      sphinx-build -b html --keep-going -d docs/_build/doctrees docs/source "$OUT_DIR"
  artifacts:
    expose_as: "Documentation"
    paths:
      - public
  environment:
    name: production
    url: $CI_PAGES_URL
