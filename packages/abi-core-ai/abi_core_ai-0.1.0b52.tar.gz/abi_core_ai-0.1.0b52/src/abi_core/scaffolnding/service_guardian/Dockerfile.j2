# {{ project_name }} Guardian Security Service Dockerfile
# Generated by ABI-Core scaffolding

FROM smarbuy/abi-image:latest

# Install system dependencies for cryptography and security
USER root
RUN apt-get update && apt-get install -y \
    build-essential \
    libffi-dev \
    libssl-dev \
    python3-dev \
    pkg-config \
    wget \
    && rm -rf /var/lib/apt/lists/*

# Install Guardian dependencies
COPY requirements.txt /tmp/guardian-requirements.txt
RUN pip install --no-cache-dir -r /tmp/guardian-requirements.txt && \
    rm /tmp/guardian-requirements.txt

# Copy Guardian agent files
COPY ./agent /app/agent

# Copy OPA policies
COPY ./opa/policies /app/opa/policies

# Copy alerting configuration
COPY ./alerting_config.json /app/alerting_config.json

# Create emergency logs directory with proper permissions
RUN mkdir -p {{ emergency_log_dir | default('/app/emergency_logs') }} && \
    chmod 755 {{ emergency_log_dir | default('/app/emergency_logs') }}

# Create audit database directory
RUN mkdir -p /app/data && chmod 755 /app/data

RUN mv /app/agent_cards/guardian_agent.json /app/agent/agent_cards
RUN rm -rf /app/agent_cards/

WORKDIR /app

# Configure entrypoint for Guardian
ENV START_OLLAMA=true
ENV SERVICE_MODULE=agent.main
ENV SERVICE_PORT={{ guardian_port | default('11438') }}

# Expose Guardian API and Dashboard ports
EXPOSE {{ guardian_port | default('11438') }}
EXPOSE {{ dashboard_port | default('8080') }}

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD wget -qO- http://localhost:{{ guardian_port | default('11438') }}/health || exit 1

ENTRYPOINT ["/opt/abi/agents.d/abi-entrypoint.sh"]