name: {{ network }}

volumes:
  {% for service in services %}
  hoprd-{{ network }}-{{ service.node_suffix }}:
  {% endfor %}

x-settings: &settings
  image: europe-west3-docker.pkg.dev/hoprassociation/docker-images/hoprd:{{ version|default("latest", true) }}
  restart: unless-stopped
  pull_policy: always
  stop_signal: SIGINT
  security_opt:
    - seccomp:unconfined
  deploy:
    resources:
      reservations:
        memory: 1g
      limits:
        memory: 2g
  logging:
    driver: json-file
    options:
      max-size: 1000M
      max-file: "5"
{% if network_names %}
  networks:
  {% for network_name in network_names %}
    - {{ network_name }}
  {% endfor %}
{% endif %}

x-envars: &envvars
  RUST_BACKTRACE: full
  HOPRD_CONFIGURATION_FILE_PATH: /app/hoprd.cfg.yaml
  {% for key, value in envvars.items() %}
  {{ key }}: {{ value }}
  {% endfor %}

services:
  {% for service in services %}
  hoprd-{{ network }}-{{ service.node_suffix }}:
    <<: *settings
    container_name: hoprd-{{ network }}-{{ service.node_suffix }}
    environment:
      HOPRD_API_PORT: {{ service.api_port }}
      <<: *envvars
    volumes:
      - {{ service.folder }}/.hopr-configs/{{ network }}/hoprd-{{ network }}-{{ service.node_suffix }}.cfg.yaml:/app/hoprd.cfg.yaml
      - {{ service.folder }}/.hopr-ids/{{ network }}/hoprd-{{ network }}-{{ service.node_suffix }}.id:/app/hopr.id
      - hoprd-{{ network }}-{{ service.node_suffix }}:/app/hoprd-db
    ports:
      - {{ service.session_port }}:{{ service.session_port }}/tcp
      - {{ service.session_port }}:{{ service.session_port }}/udp
      - {{ service.network_port }}:{{ service.network_port }}/tcp
      - {{ service.network_port }}:{{ service.network_port }}/udp
      - {{ service.api_port }}:{{ service.api_port }}

  {% endfor %}
  {% for service in services %}
  {% if service.network.slug != none %}
  metricspusher-{{ network }}-{{ service.node_suffix }}:
    image: curlimages/curl:latest
    command: /bin/sh /app/metricspusher.sh
    volumes:
      - ./metricspusher.sh:/app/metricspusher.sh
    network_mode: service:hoprd-{{ network }}-{{ service.node_suffix }}
    container_name: metricspusher-{{ network }}-{{ service.node_suffix }}
    environment:
      HOPRD_API_TOKEN: {{ service.api_password }}
      HOPRD_NODE_NAME: hoprd-{{ network }}-{{ service.node_suffix }}
      HOPRD_JOB_NAME: {{ service.network.slug }}{{ service.node_suffix }}
      HOPRD_API_PORT: {{ service.api_port }}
      HOPRD_NETWORK: {{ network }}

  {% endif %}
  {% endfor %}
{% if networks %}
networks:
{{ networks_yaml }}
{% endif %}
