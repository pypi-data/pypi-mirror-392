services:
  # Node 1 - Primary node that starts runtime and keeps running for benchmarks
  cte-bench-node1:
    image: iowarp/context-transfer-engine-build:latest
    container_name: cte-bench-node1
    hostname: cte-bench-node1
    extra_hosts:
      - "cte-bench-node1:172.27.0.10"
      - "cte-bench-node2:172.27.0.11"
      - "cte-bench-node3:172.27.0.12"
      - "cte-bench-node4:172.27.0.13"
    networks:
      cte-bench-cluster:
        ipv4_address: 172.27.0.10
    volumes:
      - ./hostfile:/etc/iowarp/hostfile:ro
      - ./wrp_config.yaml:/etc/iowarp/wrp_config.yaml:ro
      - storage1:/mnt/cte_storage
    environment:
      - NODE_ID=1
      - NODE_IP=172.27.0.10
      - CHI_NODE_ID=0
      - CONTAINER_HOSTFILE=/etc/iowarp/hostfile
      - WRP_RUNTIME_CONF=/etc/iowarp/wrp_config.yaml
      - LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libasan.so.8
      - ASAN_OPTIONS=detect_leaks=0:detect_odr_violation=0:halt_on_error=1:abort_on_error=1:print_stacktrace=1:symbolize=1
    shm_size: '16gb'
    mem_limit: 16g
    entrypoint: ["/bin/bash", "-c"]
    command: >
      "
        set -x &&
        echo '========================================' &&
        echo 'Node 1: Starting initialization' &&
        echo '========================================' &&
        echo 'Node 1: Setting up permissions...' &&
        sudo service ssh start &&
        sudo chown -R iowarp:iowarp /mnt &&
        echo 'Node 1: Creating storage directories...' &&
        mkdir -p /mnt/cte_storage &&
        echo 'Node 1: Starting Chimaera runtime...' &&
        export PATH=/usr/local/bin:$$PATH &&
        export WRP_RUNTIME_CONF=/etc/iowarp/wrp_config.yaml &&
        export CHI_NODE_ID=0 &&
        echo 'Node 1: CHI_NODE_ID set to 0' &&
        echo '========================================' &&
        echo 'Node 1: Runtime starting in foreground' &&
        echo '========================================' &&
        chimaera_start_runtime
      "

  # Node 2 - Secondary node
  cte-bench-node2:
    image: iowarp/context-transfer-engine-build:latest
    container_name: cte-bench-node2
    hostname: cte-bench-node2
    extra_hosts:
      - "cte-bench-node1:172.27.0.10"
      - "cte-bench-node2:172.27.0.11"
      - "cte-bench-node3:172.27.0.12"
      - "cte-bench-node4:172.27.0.13"
    networks:
      cte-bench-cluster:
        ipv4_address: 172.27.0.11
    volumes:
      - ./hostfile:/etc/iowarp/hostfile:ro
      - ./wrp_config.yaml:/etc/iowarp/wrp_config.yaml:ro
      - storage2:/mnt/cte_storage
    environment:
      - NODE_ID=2
      - NODE_IP=172.27.0.11
      - CHI_NODE_ID=1
      - CONTAINER_HOSTFILE=/etc/iowarp/hostfile
      - WRP_RUNTIME_CONF=/etc/iowarp/wrp_config.yaml
      - LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libasan.so.8
      - ASAN_OPTIONS=detect_leaks=0:detect_odr_violation=0:halt_on_error=1:abort_on_error=1:print_stacktrace=1:symbolize=1
    shm_size: '16gb'
    mem_limit: 16g
    entrypoint: ["/bin/bash", "-c"]
    command: >
      "
        set -x &&
        echo '========================================' &&
        echo 'Node 2: Starting initialization' &&
        echo '========================================' &&
        sudo service ssh start &&
        sudo chown -R iowarp:iowarp /mnt &&
        mkdir -p /mnt/cte_storage &&
        echo 'Node 2: Starting Chimaera runtime...' &&
        export PATH=/usr/local/bin:$$PATH &&
        export WRP_RUNTIME_CONF=/etc/iowarp/wrp_config.yaml &&
        export CHI_NODE_ID=1 &&
        echo 'Node 2: CHI_NODE_ID set to 1' &&
        echo '========================================' &&
        echo 'Node 2: Runtime running in foreground' &&
        echo '========================================' &&
        chimaera_start_runtime
      "

  # Node 3 - Secondary node
  cte-bench-node3:
    image: iowarp/context-transfer-engine-build:latest
    container_name: cte-bench-node3
    hostname: cte-bench-node3
    extra_hosts:
      - "cte-bench-node1:172.27.0.10"
      - "cte-bench-node2:172.27.0.11"
      - "cte-bench-node3:172.27.0.12"
      - "cte-bench-node4:172.27.0.13"
    networks:
      cte-bench-cluster:
        ipv4_address: 172.27.0.12
    volumes:
      - ./hostfile:/etc/iowarp/hostfile:ro
      - ./wrp_config.yaml:/etc/iowarp/wrp_config.yaml:ro
      - storage3:/mnt/cte_storage
    environment:
      - NODE_ID=3
      - NODE_IP=172.27.0.12
      - CHI_NODE_ID=2
      - CONTAINER_HOSTFILE=/etc/iowarp/hostfile
      - WRP_RUNTIME_CONF=/etc/iowarp/wrp_config.yaml
      - LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libasan.so.8
      - ASAN_OPTIONS=detect_leaks=0:detect_odr_violation=0:halt_on_error=1:abort_on_error=1:print_stacktrace=1:symbolize=1
    shm_size: '16gb'
    mem_limit: 16g
    entrypoint: ["/bin/bash", "-c"]
    command: >
      "
        set -x &&
        echo '========================================' &&
        echo 'Node 3: Starting initialization' &&
        echo '========================================' &&
        sudo service ssh start &&
        sudo chown -R iowarp:iowarp /mnt &&
        mkdir -p /mnt/cte_storage &&
        echo 'Node 3: Starting Chimaera runtime...' &&
        export PATH=/usr/local/bin:$$PATH &&
        export WRP_RUNTIME_CONF=/etc/iowarp/wrp_config.yaml &&
        export CHI_NODE_ID=2 &&
        echo 'Node 3: CHI_NODE_ID set to 2' &&
        echo '========================================' &&
        echo 'Node 3: Runtime running in foreground' &&
        echo '========================================' &&
        chimaera_start_runtime
      "

  # Node 4 - Secondary node
  cte-bench-node4:
    image: iowarp/context-transfer-engine-build:latest
    container_name: cte-bench-node4
    hostname: cte-bench-node4
    extra_hosts:
      - "cte-bench-node1:172.27.0.10"
      - "cte-bench-node2:172.27.0.11"
      - "cte-bench-node3:172.27.0.12"
      - "cte-bench-node4:172.27.0.13"
    networks:
      cte-bench-cluster:
        ipv4_address: 172.27.0.13
    volumes:
      - ./hostfile:/etc/iowarp/hostfile:ro
      - ./wrp_config.yaml:/etc/iowarp/wrp_config.yaml:ro
      - storage4:/mnt/cte_storage
    environment:
      - NODE_ID=4
      - NODE_IP=172.27.0.13
      - CHI_NODE_ID=3
      - CONTAINER_HOSTFILE=/etc/iowarp/hostfile
      - WRP_RUNTIME_CONF=/etc/iowarp/wrp_config.yaml
      - LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libasan.so.8
      - ASAN_OPTIONS=detect_leaks=0:detect_odr_violation=0:halt_on_error=1:abort_on_error=1:print_stacktrace=1:symbolize=1
    shm_size: '16gb'
    mem_limit: 16g
    entrypoint: ["/bin/bash", "-c"]
    command: >
      "
        set -x &&
        echo '========================================' &&
        echo 'Node 4: Starting initialization' &&
        echo '========================================' &&
        sudo service ssh start &&
        sudo chown -R iowarp:iowarp /mnt &&
        mkdir -p /mnt/cte_storage &&
        echo 'Node 4: Starting Chimaera runtime...' &&
        export PATH=/usr/local/bin:$$PATH &&
        export WRP_RUNTIME_CONF=/etc/iowarp/wrp_config.yaml &&
        export CHI_NODE_ID=3 &&
        echo 'Node 4: CHI_NODE_ID set to 3' &&
        echo '========================================' &&
        echo 'Node 4: Runtime running in foreground' &&
        echo '========================================' &&
        chimaera_start_runtime
      "

volumes:
  storage1:
    driver: local
  storage2:
    driver: local
  storage3:
    driver: local
  storage4:
    driver: local

networks:
  cte-bench-cluster:
    driver: bridge
    ipam:
      config:
        - subnet: 172.27.0.0/16
