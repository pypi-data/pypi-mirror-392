# WRP CTE Benchmark Docker Compose Configuration
#
# This compose file runs WRP CTE benchmarks with a separate iowarp runtime service.
# The iowarp service provides the CTE runtime, and the benchmark service connects to it.
#
# Architecture:
#   1. iowarp-runtime: Runs the CTE runtime daemon (iowarp/iowarp:latest)
#   2. wrp-cte-bench:  Runs the benchmark client (iowarp/cte-wrp-bench:latest)
#
# Usage:
#   docker-compose up                       # Run with default settings
#   docker-compose up -d iowarp-runtime     # Start runtime only
#   TEST_CASE=Get docker-compose up         # Override specific parameters
#   docker-compose down                     # Stop all services
#
# Environment Variables:
#   TEST_CASE         - Benchmark test: Put, Get, PutGet (default: Put)
#   NUM_PROCS         - Number of parallel processes (default: 1)
#   DEPTH             - Queue depth for concurrent operations (default: 4)
#   IO_SIZE              - Size of each I/O operation (default: 1m)
#                          Supports: b (bytes), k (KB), m (MB), g (GB)
#   IO_COUNT             - Number of operations to perform (default: 100)
#   CHIMAERA_WITH_RUNTIME - Initialize CTE runtime in benchmark (default: 0, runtime handled by iowarp service)
#   WRP_RUNTIME_CONF     - Path to CTE configuration file (default: /etc/iowarp/cte_config.yaml)

services:
  # IOWarp Runtime Service
  # Provides the CTE runtime daemon that benchmark clients connect to
  iowarp-runtime:
    image: iowarp/core:latest
    container_name: iowarp-runtime

    # Mount shared CTE configuration
    volumes:
      - ./cte_config.yaml:/etc/iowarp/wrp_conf.yaml:ro

    # Expose ZeroMQ port for client connections
    ports:
      - "5555:5555"

    # Resource limits
    # Large shared memory for CTE operations
    shm_size: 8g
    mem_limit: 8g

    # Make IPC namespace accessible to host so external applications can connect
    ipc: host

    # Keep container running as a daemon
    stdin_open: true
    tty: true

    # Restart policy - no restart for benchmark runs
    restart: "no"

  # WRP CTE Benchmark Service
  # Runs benchmark tests against the iowarp runtime
  wrp-cte-bench:
    image: iowarp/iowarp-cte-bench:latest
    container_name: wrp-cte-bench

    # Depend on the runtime service
    depends_on:
      iowarp-runtime:
        condition: service_healthy

    # Environment variables for benchmark configuration
    environment:
      # CTE Runtime Configuration
      # Do NOT initialize runtime in benchmark (runtime service handles this)
      - CHIMAERA_WITH_RUNTIME=${CHIMAERA_WITH_RUNTIME:-0}

      # Benchmark Test Parameters
      # Test case selection: Put (write), Get (read), PutGet (mixed)
      - TEST_CASE=${TEST_CASE:-Put}

      # Number of parallel processes
      - NUM_PROCS=${NUM_PROCS:-1}

      # Queue depth for concurrent operations
      - DEPTH=${DEPTH:-4}

      # I/O operation size (supports b, k, m, g suffixes)
      - IO_SIZE=${IO_SIZE:-1m}

      # Number of operations to perform
      - IO_COUNT=${IO_COUNT:-100}

    # Network configuration to access runtime service
    network_mode: service:iowarp-runtime

    # IPC namespace sharing for shared memory access
    # This ensures both services can access the same shared memory segments
    ipc: service:iowarp-runtime

    # Resource limits
    # Match or exceed runtime service limits
    shm_size: 8g
    mem_limit: 8g

    # Clean up container after run
    restart: "no"

  # Alternative service configurations for different test scenarios
  # Uncomment to use specific test cases

  # Put operation benchmark - write-heavy workload
  # wrp-cte-bench-put:
  #   image: iowarp/iowarp-cte-bench:latest
  #   container_name: wrp-cte-bench-put
  #   depends_on:
  #     iowarp-runtime:
  #       condition: service_healthy
  #   volumes:
  #     - ./cte_config.yaml:/etc/iowarp/cte_config.yaml:ro
  #   environment:
  #     - CHIMAERA_WITH_RUNTIME=0
  #     - WRP_RUNTIME_CONF=/etc/iowarp/cte_config.yaml
  #     - TEST_CASE=Put
  #     - NUM_PROCS=4
  #     - DEPTH=8
  #     - IO_SIZE=4k
  #     - IO_COUNT=100000
  #   network_mode: service:iowarp-runtime
  #   ipc: service:iowarp-runtime
  #   shm_size: 8g
  #   mem_limit: 8g
  #   restart: "no"

  # Get operation benchmark - read-heavy workload
  # wrp-cte-bench-get:
  #   image: iowarp/iowarp-cte-bench:latest
  #   container_name: wrp-cte-bench-get
  #   depends_on:
  #     iowarp-runtime:
  #       condition: service_healthy
  #   volumes:
  #     - ./cte_config.yaml:/etc/iowarp/cte_config.yaml:ro
  #   environment:
  #     - CHIMAERA_WITH_RUNTIME=0
  #     - WRP_RUNTIME_CONF=/etc/iowarp/cte_config.yaml
  #     - TEST_CASE=Get
  #     - NUM_PROCS=4
  #     - DEPTH=8
  #     - IO_SIZE=4k
  #     - IO_COUNT=100000
  #   network_mode: service:iowarp-runtime
  #   ipc: service:iowarp-runtime
  #   shm_size: 8g
  #   mem_limit: 8g
  #   restart: "no"

  # PutGet operation benchmark - mixed read/write workload
  # wrp-cte-bench-putget:
  #   image: iowarp/iowarp-cte-bench:latest
  #   container_name: wrp-cte-bench-putget
  #   depends_on:
  #     iowarp-runtime:
  #       condition: service_healthy
  #   volumes:
  #     - ./cte_config.yaml:/etc/iowarp/cte_config.yaml:ro
  #   environment:
  #     - CHIMAERA_WITH_RUNTIME=0
  #     - WRP_RUNTIME_CONF=/etc/iowarp/cte_config.yaml
  #     - TEST_CASE=PutGet
  #     - NUM_PROCS=4
  #     - DEPTH=4
  #     - IO_SIZE=1m
  #     - IO_COUNT=10000
  #   network_mode: service:iowarp-runtime
  #   ipc: service:iowarp-runtime
  #   shm_size: 8g
  #   mem_limit: 8g
  #   restart: "no"

  # Large I/O benchmark - 16MB operations
  # wrp-cte-bench-large:
  #   image: iowarp/iowarp-cte-bench:latest
  #   container_name: wrp-cte-bench-large
  #   depends_on:
  #     iowarp-runtime:
  #       condition: service_healthy
  #   volumes:
  #     - ./cte_config.yaml:/etc/iowarp/cte_config.yaml:ro
  #   environment:
  #     - CHIMAERA_WITH_RUNTIME=0
  #     - WRP_RUNTIME_CONF=/etc/iowarp/cte_config.yaml
  #     - TEST_CASE=Put
  #     - NUM_PROCS=1
  #     - DEPTH=2
  #     - IO_SIZE=16m
  #     - IO_COUNT=1000
  #   network_mode: service:iowarp-runtime
  #   ipc: service:iowarp-runtime
  #   shm_size: 8g
  #   mem_limit: 8g
  #   restart: "no"

  # High concurrency benchmark - many parallel processes
  # wrp-cte-bench-concurrent:
  #   image: iowarp/iowarp-cte-bench:latest
  #   container_name: wrp-cte-bench-concurrent
  #   depends_on:
  #     iowarp-runtime:
  #       condition: service_healthy
  #   volumes:
  #     - ./cte_config.yaml:/etc/iowarp/cte_config.yaml:ro
  #   environment:
  #     - CHIMAERA_WITH_RUNTIME=0
  #     - WRP_RUNTIME_CONF=/etc/iowarp/cte_config.yaml
  #     - TEST_CASE=Put
  #     - NUM_PROCS=16
  #     - DEPTH=16
  #     - IO_SIZE=4k
  #     - IO_COUNT=1000000
  #   network_mode: service:iowarp-runtime
  #   ipc: service:iowarp-runtime
  #   shm_size: 8g
  #   mem_limit: 8g
  #   restart: "no"

# Example usage commands:
#
# Start runtime and run default benchmark (Put, 1 process, depth 4, 1MB I/O, 100 ops):
#   docker-compose up
#
# Start runtime in background, then run benchmark:
#   docker-compose up -d iowarp-runtime
#   docker-compose up wrp-cte-bench
#
# Run Get benchmark with custom parameters:
#   TEST_CASE=Get NUM_PROCS=4 DEPTH=8 IO_SIZE=4k IO_COUNT=100000 docker-compose up wrp-cte-bench
#
# Run PutGet benchmark with high concurrency:
#   TEST_CASE=PutGet NUM_PROCS=8 DEPTH=16 docker-compose up wrp-cte-bench
#
# Run specific service variants:
#   docker-compose up wrp-cte-bench-put
#   docker-compose up wrp-cte-bench-large
#
# View logs:
#   docker-compose logs -f iowarp-runtime
#   docker-compose logs -f wrp-cte-bench
#
# Stop all services:
#   docker-compose down
#
# Clean up and remove volumes:
#   docker-compose down -v
