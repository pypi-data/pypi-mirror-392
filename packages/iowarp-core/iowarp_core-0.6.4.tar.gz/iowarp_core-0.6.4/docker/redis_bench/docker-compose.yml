# Redis Benchmark Docker Compose Configuration
#
# This compose file runs Redis benchmarks for performance comparison with CTE.
# Redis server is started internally by the container, no external Redis needed.
#
# Usage:
#   docker-compose up                    # Run with default settings
#   docker-compose run redis-bench       # Interactive run
#   TEST_CASE=Get docker-compose up      # Override specific parameters
#
# Environment Variables:
#   TEST_CASE    - Benchmark test to run: Set, Get, SetGet, All (default: All)
#   NUM_CLIENTS  - Number of parallel clients (default: 4)
#   IO_SIZE      - Size of each I/O operation (default: 1m)
#                  Supports: b (bytes), k (KB), m (MB), g (GB)
#   IO_COUNT     - Number of operations to perform (default: 10000)

services:
  # Main Redis benchmark service
  redis-bench:
    image: iowarp/iowarp-redis-bench:latest
    container_name: redis-bench

    # Environment variables for benchmark configuration
    # These override the default CMD arguments
    environment:
      # Test case selection
      - TEST_CASE=${TEST_CASE:-All}

      # Number of parallel Redis clients
      - NUM_CLIENTS=${NUM_CLIENTS:-4}

      # I/O operation size (supports b, k, m, g suffixes)
      - IO_SIZE=${IO_SIZE:-1m}

      # Number of operations to perform
      - IO_COUNT=${IO_COUNT:-1000}

    # Resource limits
    mem_limit: 4g

    # Clean up container after run
    restart: "no"
  # Alternative service configurations for different test scenarios
  # Uncomment to use specific test cases

  # Set operation benchmark - write-heavy workload
  # redis-bench-set:
  #   image: iowarp/iowarp-redis-bench:latest
  #   container_name: redis-bench-set
  #   command: ["Set", "8", "4k", "100000"]
  #   mem_limit: 4g
  #   restart: "no"

  # Get operation benchmark - read-heavy workload
  # redis-bench-get:
  #   image: iowarp/iowarp-redis-bench:latest
  #   container_name: redis-bench-get
  #   command: ["Get", "8", "4k", "100000"]
  #   mem_limit: 4g
  #   restart: "no"

  # SetGet operation benchmark - mixed read/write workload
  # redis-bench-setget:
  #   image: iowarp/iowarp-redis-bench:latest
  #   container_name: redis-bench-setget
  #   command: ["SetGet", "4", "1m", "10000"]
  #   mem_limit: 4g
  #   restart: "no"

  # Large I/O benchmark - 16MB operations
  # redis-bench-large:
  #   image: iowarp/iowarp-redis-bench:latest
  #   container_name: redis-bench-large
  #   command: ["All", "2", "16m", "1000"]
  #   mem_limit: 8g
  #   restart: "no"

  # Small I/O benchmark - 4KB operations (high IOPS)
  # redis-bench-small:
  #   image: iowarp/iowarp-redis-bench:latest
  #   container_name: redis-bench-small
  #   command: ["All", "16", "4k", "1000000"]
  #   mem_limit: 4g
  #   restart: "no"

  # Example usage commands:
  #
  # Run default benchmark (All tests, 4 clients, 1MB I/O, 10000 ops):
  #   docker-compose up redis-bench
  #
  # Run Set benchmark with custom parameters:
  #   TEST_CASE=Set NUM_CLIENTS=8 IO_SIZE=4k IO_COUNT=100000 docker-compose up redis-bench
  #
  # Run Get benchmark with 16 clients:
  #   TEST_CASE=Get NUM_CLIENTS=16 docker-compose up redis-bench
  #
  # Run specific service variants:
  #   docker-compose up redis-bench-set
  #   docker-compose up redis-bench-large
  #
  # View logs:
  #   docker-compose logs -f redis-bench
  #
  # Clean up:
  #   docker-compose down
