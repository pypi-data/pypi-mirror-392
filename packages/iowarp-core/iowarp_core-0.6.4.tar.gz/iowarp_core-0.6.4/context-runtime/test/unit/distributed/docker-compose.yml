services:
  # Node 1 - Test coordinator that runs the test binary
  iowarp-node1:
    image: iowarp/core-build:latest
    container_name: iowarp-distributed-node1
    hostname: iowarp-node1
    networks:
      iowarp-cluster:
        ipv4_address: 172.25.0.10
    volumes:
      - ${IOWARP_CORE_ROOT:-.}/context-runtime/test/unit/distributed/:/etc/iowarp:ro
    environment:
      - NODE_ID=1
      - NODE_IP=172.25.0.10
      - CONTAINER_HOSTFILE=/etc/iowarp/hostfile
      - CHIMAERA_WITH_RUNTIME=0
      - CHI_NUM_CONTAINERS=4
    shm_size: '16gb'
    mem_limit: 16g
    working_dir: /workspace
    entrypoint: [ "/bin/bash", "-c" ]
    command: >
      "
        echo 'Node 1: Starting runtime...' &&
        export PATH=/usr/local/bin:$PATH &&
        chimaera_start_runtime &
        RUNTIME_PID=\$! &&
        echo 'Node 1: Runtime started (PID \$RUNTIME_PID). Running distributed tests...' &&
        chimaera_bdev_chimod_tests &&
        echo 'Node 1: Tests completed.' &&
        kill \$RUNTIME_PID &&
        wait \$RUNTIME_PID
      "

  # Node 2
  iowarp-node2:
    image: iowarp/core-build:latest
    container_name: iowarp-distributed-node2
    hostname: iowarp-node2
    networks:
      iowarp-cluster:
        ipv4_address: 172.25.0.11
    volumes:
      - ${IOWARP_CORE_ROOT:-.}/context-runtime/test/unit/distributed/:/etc/iowarp:ro
    environment:
      - NODE_ID=2
      - NODE_IP=172.25.0.11
      - CONTAINER_HOSTFILE=/etc/iowarp/hostfile
      - CHIMAERA_WITH_RUNTIME=0
      - CHI_NUM_CONTAINERS=4
    shm_size: '16gb'
    mem_limit: 16g
    working_dir: /workspace
    entrypoint: [ "/bin/bash", "-c" ]
    command: >
      "
        echo 'Node 2: Starting runtime...' &&
        export PATH=/usr/local/bin:$PATH &&
        chimaera_start_runtime &
        RUNTIME_PID=\$! &&
        echo \"Node 2: Runtime started (PID \$RUNTIME_PID). Waiting for tests...\" &&
        tail -f /dev/null
      "

  # Node 3
  iowarp-node3:
    image: iowarp/core-build:latest
    container_name: iowarp-distributed-node3
    hostname: iowarp-node3
    networks:
      iowarp-cluster:
        ipv4_address: 172.25.0.12
    volumes:
      - ${IOWARP_CORE_ROOT:-.}/context-runtime/test/unit/distributed/:/etc/iowarp:ro
    environment:
      - NODE_ID=3
      - NODE_IP=172.25.0.12
      - CONTAINER_HOSTFILE=/etc/iowarp/hostfile
      - CHIMAERA_WITH_RUNTIME=0
      - CHI_NUM_CONTAINERS=4
    shm_size: '16gb'
    mem_limit: 16g
    working_dir: /workspace
    entrypoint: [ "/bin/bash", "-c" ]
    command: >
      "
        echo 'Node 3: Starting runtime...' &&
        export PATH=/usr/local/bin:$PATH &&
        chimaera_start_runtime &
        RUNTIME_PID=\$! &&
        echo \"Node 3: Runtime started (PID \$RUNTIME_PID). Waiting for tests...\" &&
        tail -f /dev/null
      "

  # Node 4
  iowarp-node4:
    image: iowarp/core-build:latest
    container_name: iowarp-distributed-node4
    hostname: iowarp-node4
    networks:
      iowarp-cluster:
        ipv4_address: 172.25.0.13
    volumes:
      - ${IOWARP_CORE_ROOT:-.}/context-runtime/test/unit/distributed/:/etc/iowarp:ro
    environment:
      - NODE_ID=4
      - NODE_IP=172.25.0.13
      - CONTAINER_HOSTFILE=/etc/iowarp/hostfile
      - CHIMAERA_WITH_RUNTIME=0
      - CHI_NUM_CONTAINERS=4
    shm_size: '16gb'
    mem_limit: 16g
    working_dir: /workspace
    entrypoint: [ "/bin/bash", "-c" ]
    command: >
      "
        echo 'Node 4: Starting runtime...' &&
        export PATH=/usr/local/bin:$PATH &&
        chimaera_start_runtime &
        RUNTIME_PID=\$! &&
        echo \"Node 4: Runtime started (PID \$RUNTIME_PID). Waiting for tests...\" &&
        tail -f /dev/null
      "

networks:
  iowarp-cluster:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16
