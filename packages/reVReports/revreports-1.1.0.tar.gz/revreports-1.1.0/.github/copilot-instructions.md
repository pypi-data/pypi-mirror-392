# reVReports Coding Agent Onboarding Guide

## 1. Project Summary
reVReports generates publication-ready plots, maps, and summary tables from
reV supply-curve outputs. It ships a Click-powered CLI and Python API that
load scenario CSVs, validate configuration files, and render standardized
graphics along with characterization CSVs. Primary outcomes: reproducible
supply-curve visualizations, scenario comparison artifacts, and
regression-friendly assets for report generation.

## 2. Tech Stack Overview
- Python ≥ 3.10 (core library, CLI, plotting stack using pandas, geopandas,
  cartopy, matplotlib, seaborn, shapely).
- Environment management: **Pixi** environments (`default`, `dev`, `test`,
  `doc`, `build`). Always prefer Pixi over bare pip for dependency
  consistency.
- Packaging/versioning: `setuptools_scm` (version in `reVReports/_version.py`
  generated dynamically by tags `vX.Y.Z`).
- Linting/Formatting: Ruff (configured in `pyproject.toml`). Line length 79
  (72 for docstrings). Ruff also runs format checks.
- Testing: Pytest (unit-style and integration-style cases in `tests/`),
  coverage via `pytest-cov`, optional parallel runs through `pytest-xdist`.
- Docs: Sphinx (doc extra) and guides (`README.rst`, `USAGE.md`),
  published on GitHub Pages.
- CLI: Click entry point `reVReports.cli:main` orchestrates plot/map
  generation and characterizations.

## 3. High-Level Project Structure
```
reVReports/             Core Python package
  cli.py                CLI entry point (Click commands)
  configs.py            Pydantic config parsing and validation
  characterizations.py  Scenario characterization helpers
  maps.py               Map orchestration utilities
  plots.py              Plot generation utilities
  datasets/             Bundled sample supply-curve inputs
  assets/               Fonts and other static resources
  utilities/            Shared map/plot/data helpers
tests/                  Pytest suites + golden data/outputs
.github/workflows       CI definitions (lint, tests, publish)
pyproject.toml          Dependencies, Pixi config, Ruff settings
USAGE.md                CLI and library usage documentation
```

## 4. Environment & Commands Cheat Sheet
Always prefer Pixi; it encodes supported dependency sets:
```
# Sync and enter development environment
pixi install --frozen -e dev
pixi shell -e dev

# Linting and formatting
pixi run -e dev ruff check .
pixi run -e dev ruff format .

# Run tests (optionally in parallel/with coverage)
pixi run -e test pytest
pixi run -e test pytest --cov=reVReports --cov-report=term-missing

# CLI smoke test
pixi run -e dev reVReports --help

# Build docs (when editing Sphinx docs)
pixi run -e doc sphinx-build -b html docs docs/_build/html

# Build distribution artifacts
pixi run -e build build-wheels
```
To add a new dependency, use `pixi add <package>`; this updates `pyproject.toml` and the lockfile atomically.
Use `pixi add --feature dev <package>` to add a dependency that is only used for development (tests, linting, docs, etc.).


## 5. Coding Guidelines (Python)
- Follow the repository style guide: avoid type hints, keep numpy-style
  docstrings, prefer protected helpers until APIs stabilize, and mirror
  existing naming/visibility patterns.
- Follow Ruff configuration (79 char lines, 72 char lines for docstrings,
  double quotes, numpy docstyle). Run locally: `pixi run -e dev ruff check .`
  and `pixi run -e dev ruff format .` (Pixi includes Ruff).
- Do not add comments unless they are absolutely critical to understanding;
  always prefer descriptive function and variable names instead.
- Use absolute imports under `reVReports.`.
- Logging: Use helpers in `reVReports.logs` (e.g., `get_logger`) to attach
  stream handlers; avoid introducing global logging side effects.
- Version: Never edit `_version.py` manually (auto-generated by `setuptools_scm`). Tag releases `vX.Y.Z`.
- Exceptions: Always raise specific custom exceptions from
  `reVReports.exceptions` (e.g., `reVReportsValueError`). Add new exceptions
  to this module if appropriate.
- When adding new plotting or mapping flows, mirror the patterns in
  `reVReports.plots`, `reVReports.maps`, and companion utilities modules.

## 6. Docstring Guidelines (Python)
- Use numpy-style docstrings to document classes, methods, and functions.
- Avoid type hints.
- Keep docstring length to 72 characters per line.
- Never include a period (".") at the end of the first line of docstrings.
- Do not add a short summary to __init__ methods. Instead, keep the line blank and start the "Parameters" section after a second newline.
- Do not document parameters in the class docstring - do that in the __init__ docstring instead.
- All @property and @cached_property method documentation should be one line long and should start with the return type.
- "Protected" functions and methods should always be documented using only one-line summary docstrings.

## 7. Testing Strategy
- Unit tests target granular modules (`tests/python/unit/...`). Add new tests adjacent to similar domain (e.g., new utility → `tests/python/unit/utilities/`).
- Integration tests at `tests/python/integration` cover full pipelines.
- Coverage thresholds enforced (e.g. `--cov-fail-under=30`). Keep defensive code minimal; exclude per coverage config if necessary.
- Regression fixtures (plots, maps, characterizations) live under `tests/data`;
  keep golden assets deterministic and update expectations intentionally.
- Pytest options for parallel execution (`-n auto`) are supported; prefer
  `pixi run -e dev pytest -n auto` for heavier suites.

## 8. Logging & Observability
- Logging is lightweight (`reVReports.logs.get_logger` attaches a stdout
  handler). Reuse this helper rather than configuring global logging in
  multiple places.
- Exceptions in `reVReports.exceptions` automatically emit log messages; keep
  error text concise and user-facing.
- CLI commands should surface actionable messages and exit codes without
  relying on hidden background logging.

## 9. Common Pitfalls & Gotchas
- Do not modify `_version.py` directly; tests or builds may assume dynamic version structure.
- Geo libraries (cartopy, geopandas, pyproj) depend on system-level data; let
  Pixi manage the environment to avoid missing PROJ/GDAL binaries.
- Supply-curve data must include the column names expected by
  `reVReports.data` helpers; validate configs before adding new keys.
- Tests depend on golden outputs under `tests/data/outputs`; update fixtures
  intentionally when plot/map changes affect hashes or filenames.
- CLI configs (`tests/data/config_*.json`) serve as reference; maintain
  backwards compatibility when adjusting Pydantic models.
- Fonts and other assets in `reVReports/assets` are copied at runtime; keep
  filenames stable or update the asset loader when replacing them.

## 10. Implementing a Sample Feature (Reference Flow)
Example: Add a new supply-curve plot template.
1. Extend `reVReports/plots.py` (or `reVReports/utilities/plots.py`) with the
   rendering helper and update docstrings.
2. Wire the feature into the CLI in `reVReports/cli.py`, including any config
   validation changes in `reVReports/configs.py`.
3. Add or update tests in `tests/test_plots.py` (plus fixture data under
   `tests/data/outputs/plots/`).
4. Run `pixi run -e dev pytest -k plots` and refresh regression assets as
   needed.

## 11. CI/Release Lifecycle
- PR: Ruff lint → tests (locked + multi-OS). Fix lint first to avoid wasted CI cycles.
- Docs must build with `--fail-on-warning`; ensure new references are valid.
- Publishing uses `publish_to_pypi.yml`; tags `v*` trigger the release.
- When touching documentation, ensure `USAGE.md` stays consistent with CLI
  behavior and Sphinx builds remain warning-free under the `doc` environment.

## 12. Contribution & Style Extensions
- Follow Development Guidelines in `docs/source/dev/README.rst` for deeper details.
- Keep functions small; prefer pure helpers in `utilities/` with focused responsibilities.
- Prefer simple dicts over dataclasses.
- Avoid complex inheritance.

## 13. Quick Triage Guide for the Agent
- Characterizations: `reVReports/characterizations.py` and fixtures under
  `tests/data/outputs/characterizations/`.
- Config parsing & validation: `reVReports/configs.py`, schemas mirrored in
  `tests/data/config_*.json`.
- Maps: `reVReports/maps.py` with helpers in `reVReports/utilities/maps.py` and
  regression data in `tests/data/maps/`.
- Plots: `reVReports/plots.py` plus utilities in `reVReports/utilities/plots.py`.
- CLI flow: `reVReports/cli.py`; support functions in `reVReports/data.py` and
  `reVReports/logs.py`.
