Metadata-Version: 2.4
Name: iflow-mcp_larkagentx
Version: 0.1.0
Summary: Lark Agent X - AI assistant for Lark/Feishu with MCP support
Requires-Python: >=3.10
Requires-Dist: brotli==1.1.0
Requires-Dist: cryptography==44.0.2
Requires-Dist: fastmcp==2.1.2
Requires-Dist: loguru==0.7.3
Requires-Dist: mcp==1.6.0
Requires-Dist: openai==1.74.0
Requires-Dist: protobuf3-to-dict==0.1.5
Requires-Dist: protobuf==5.29.3
Requires-Dist: pyexecjs==1.5.1
Requires-Dist: pymysql==1.1.0
Requires-Dist: python-dotenv==1.1.0
Requires-Dist: requests==2.31.0
Requires-Dist: sqlalchemy==2.0.30
Requires-Dist: websockets==15.0.1
Description-Content-Type: text/markdown

# Lark Agentx - ä½ çš„é£ä¹¦ AI åŠ©æ‰‹ ğŸš€

[![Python Version](https://img.shields.io/badge/python-3.10%2B-blue)](https://www.python.org/)
[![Node.js Version](https://img.shields.io/badge/nodejs-18%2B-blue)](https://nodejs.org/zh-cn/)

ä¸€ä¸ªåŸºäºé£ä¹¦(Lark)çš„AI Agentï¼Œå®ç°å¤§æ¨¡å‹é€šè¿‡é£ä¹¦è¿›è¡Œå‡½æ•°è°ƒç”¨å’Œæ¶ˆæ¯å¤„ç†ã€‚


**æ— éœ€é…ç½®é£ä¹¦æœºå™¨äººï¼Œä½ çš„é£ä¹¦è´¦å·å³æ˜¯AIåŠ©æ‰‹ã€‚**


**åªéœ€å®šä¹‰å‡½æ•°å’Œæ³¨é‡Šï¼Œä½ çš„é£ä¹¦æœºå™¨äººä¼šè‡ªåŠ¨æ ¹æ®åœºæ™¯è°ƒç”¨ã€‚**


## é¡¹ç›®æ¦‚è¿° ğŸŒŸ

Lark Agentxæ˜¯ä¸€ä¸ªç°ä»£åŒ–çš„Pythonåº”ç”¨ç¨‹åºï¼Œèƒ½å¤Ÿ:

- ğŸ“Š é€†å‘é£ä¹¦Protobufæ ¼å¼ä¼ è¾“çš„Websocketså’ŒAPIï¼Œç›‘å¬å¹¶è®°å½•æ¶ˆæ¯
- ğŸ¤– æä¾›è‡ªå®šä¹‰å‡½æ•°ä¾›å¤§æ¨¡å‹è°ƒç”¨
- ğŸ”„ å®ç°åŸºäºMCP (Model Context Protocol) çš„å‡½æ•°è°ƒç”¨æ¡†æ¶
- ğŸ’¾ ä½¿ç”¨SQLAlchemyå°†æ¶ˆæ¯å­˜å‚¨åˆ°MySQLæ•°æ®åº“

## æ•ˆæœå›¾ğŸ§¸

<div align="center">
  <img src="static/resource/back_end.png" width="600" alt="åå°æ—¥å¿—">
  <br>
  <em>å›¾1: åå°æ—¥å¿—</em>
</div>


<div align="center">
  <img src="static/resource/front_end_1.png" width="600" alt="èŠå¤©æ•°æ®åº“æŸ¥è¯¢">
  <br>
  <em>å›¾2: èŠå¤©æ•°æ®åº“æŸ¥è¯¢</em>
</div>

<div align="center">
  <img src="static/resource/front_end_2.png" width="600" alt="å¤©æ°”æŸ¥è¯¢"> 
  <br>
  <em>å›¾3: å¤©æ°”æŸ¥è¯¢</em>
</div>

<div align="center">
  <img src="static/resource/functions.png" width="600" alt="æ³¨å†Œå‡½æ•°"> 
  <br>
  <em>å›¾4: ç®€å•æ³¨å†Œå‡½æ•°ï¼Œåªéœ€å®šä¹‰å‡½æ•°å’Œæ³¨é‡Š</em>
</div>

## âœ¨ åŠŸèƒ½ç‰¹ç‚¹

- **å‡½æ•°æ³¨å†Œæœºåˆ¶**: ç®€å•ç›´è§‚çš„å‡½æ•°æ³¨å†Œè£…é¥°å™¨
- **æ¶ˆæ¯è‡ªåŠ¨å¤„ç†**: è®°å½•æ‰€æœ‰æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼ˆç§èŠå’Œç¾¤èŠï¼‰
- **å¼‚æ­¥å¤„ç†**: é‡‡ç”¨async/awaitæ¨¡å¼è¿›è¡Œå¼‚æ­¥é€šä¿¡
- **æ•°æ®æŒä¹…åŒ–**: ä½¿ç”¨SQLAlchemyå°†æ¶ˆæ¯å­˜å‚¨åœ¨MySQLæ•°æ®åº“ä¸­
- **çµæ´»é…ç½®**: é€šè¿‡ç¯å¢ƒå˜é‡è¿›è¡Œé…ç½®
- **å®¹å™¨åŒ–éƒ¨ç½²**: æ”¯æŒDockerå¿«é€Ÿéƒ¨ç½²
- **æ™ºèƒ½å‡½æ•°è°ƒç”¨**: AIä¼šæ ¹æ®ç”¨æˆ·è¾“å…¥çš„æ–‡å­—è‡ªåŠ¨åˆ†æå¹¶è°ƒç”¨æœ€åŒ¹é…çš„å‡½æ•°ï¼Œå¼€å‘è€…åªéœ€æ·»åŠ å‡½æ•°åŠå…¶æ³¨é‡Šæè¿°

## ğŸ“¦ å½“å‰æ”¯æŒçš„å‡½æ•°

é¡¹ç›®ç›®å‰å†…ç½®äº†ä»¥ä¸‹å‡½æ•°ä¾›å¤§æ¨¡å‹è°ƒç”¨:

| å‡½æ•°å | æè¿° |
|-------|------|
| `tell_joke` | è®²ä¸€ä¸ªéšæœºç¬‘è¯ |
| `get_time` | è·å–å½“å‰æ—¶é—´ |
| `fortune` | æŠ½å–ä¸€ä¸ªéšæœºè¿åŠ¿ |
| `get_weather` | è·å–åŸå¸‚å¤©æ°” |
| `count_daily_speakers` | è·å–ä»Šå¤©å‘è¨€çš„äººæ•°ç»Ÿè®¡ |
| `get_top_speaker_today` | è·å–ä»Šå¤©å‘è¨€æœ€å¤šçš„ç”¨æˆ· |
| `send_message` | ç»™æŒ‡å®šç”¨æˆ·å‘é€æ¶ˆæ¯ |
| `list_tools` | åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„å·¥å…·åŠå…¶æè¿° |
| `extra_order_from_content` | æå–æ–‡å­—ä¸­çš„è®¢å•ä¿¡æ¯ï¼ŒåŒ…æ‹¬è®¢å•å·ã€å•†å“åç§°ã€æ•°é‡ç­‰ |


ä½ å¯ä»¥é€šè¿‡åœ¨é£ä¹¦ä¸­è¾“å…¥è§¦å‘æŒ‡ä»¤åè·Ÿè¦æ‰§è¡Œçš„æ“ä½œæ¥è°ƒç”¨è¿™äº›åŠŸèƒ½ï¼Œä¾‹å¦‚: `/run è®²ä¸ªç¬‘è¯`

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
project/
â”œâ”€â”€ app/                    # åº”ç”¨ç¨‹åºæ¨¡å—
â”‚   â”œâ”€â”€ api/                # APIç›¸å…³æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ auth.py         # è®¤è¯æ¨¡å—
â”‚   â”‚   â””â”€â”€ lark_client.py  # é£ä¹¦å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ config/             # é…ç½®æ¨¡å—
â”‚   â”‚   â””â”€â”€ settings.py     # åº”ç”¨é…ç½®
â”‚   â”œâ”€â”€ core/               # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ mcp_server.py   # MCPæœåŠ¡å™¨ï¼ˆå‡½æ•°æ³¨å†Œå’Œå¤„ç†ï¼‰
â”‚   â”‚   â”œâ”€â”€ llm_service.py  # LLMæœåŠ¡
â”‚   â”‚   â””â”€â”€ message_service.py  # æ¶ˆæ¯å¤„ç†æœåŠ¡
â”‚   â”œâ”€â”€ db/                 # æ•°æ®åº“ç›¸å…³
â”‚   â”‚   â”œâ”€â”€ models.py       # æ•°æ®æ¨¡å‹
â”‚   â”‚   â””â”€â”€ session.py      # æ•°æ®åº“ä¼šè¯ç®¡ç†
â”‚   â””â”€â”€ utils/              # å·¥å…·å‡½æ•°
â”œâ”€â”€ builder/                # è¯·æ±‚æ„å»ºå™¨
â”œâ”€â”€ extension/              # æ‰©å±•åŠŸèƒ½
â”‚   â””â”€â”€ weather_api/        # å¤©æ°”APIé›†æˆ
â”œâ”€â”€ static/                 # é™æ€èµ„æº
â”‚   â”œâ”€â”€ resource/           # å›¾ç‰‡èµ„æº
â”‚   â”œâ”€â”€ proto_pb2.py        # åè®®å®šä¹‰
â”‚   â””â”€â”€ lark_decrypt.js     # é£ä¹¦è§£å¯†å·¥å…·
â”œâ”€â”€ .env                    # ç¯å¢ƒå˜é‡
â”œâ”€â”€ main.py                 # åº”ç”¨å…¥å£
â”œâ”€â”€ requirements.txt        # é¡¹ç›®ä¾èµ–
â”œâ”€â”€ docker-compose.yml      # Docker Composeé…ç½®
â””â”€â”€ Dockerfile              # Dockeré…ç½®
```

## ğŸ› ï¸ è‡ªå®šä¹‰å‡½æ•°å¼€å‘

åœ¨ `app/core/mcp_server.py` æ–‡ä»¶ä¸­ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `@register_tool` è£…é¥°å™¨æ·»åŠ æ‚¨è‡ªå·±çš„è‡ªå®šä¹‰å‡½æ•°:

```python
@register_tool(name="tell_joke", description="è®²ä¸€ä¸ªéšæœºç¬‘è¯")
def tell_joke() -> str:
    jokes = [
        "ä¸ºä»€ä¹ˆç¨‹åºå‘˜éƒ½å–œæ¬¢é»‘è‰²ï¼Ÿå› ä¸ºä»–ä»¬ä¸å–œæ¬¢ bug å…‰ã€‚",
        "Python å’Œè›‡æœ‰ä»€ä¹ˆå…±åŒç‚¹ï¼Ÿä¸€æ—¦ç¼ ä¸Šä½ å°±æ”¾ä¸ä¸‹äº†ã€‚",
        "ä¸ºä»€ä¹ˆ Java å¼€å‘è€…å¾ˆå°‘è¢«é‚€å»æ´¾å¯¹ï¼Ÿå› ä¸ºä»–ä»¬æ€»æ˜¯æŠ›å‡ºå¼‚å¸¸ã€‚",
    ]
    return random.choice(jokes)

@register_tool(name="send_message", description="ç»™æŒ‡å®šç”¨æˆ·å‘é€æ¶ˆæ¯ {user:ç”¨æˆ·åç§° content:æ¶ˆæ¯å†…å®¹}")
def send_message(user: str, content: str) -> str:
    """ç»™æŒ‡å®šç”¨æˆ·å‘é€ç§ä¿¡"""
    lark_client = LarkClient(get_auth())
    # ... å®ç°é€»è¾‘ ...
    return f"æˆåŠŸå‘ {user} å‘é€äº†ç§ä¿¡: '{content}'"
```

**é‡è¦**: åªéœ€æ·»åŠ å‡½æ•°å’Œå¯¹åº”çš„æè¿°ï¼ŒAIä¼šæ ¹æ®ç”¨æˆ·çš„æ–‡å­—è‡ªåŠ¨åˆ†æå¹¶è°ƒç”¨æœ€åŒ¹é…çš„å‡½æ•°ï¼Œæ— éœ€æ‰‹åŠ¨å®ç°å‡½æ•°åŒ¹é…é€»è¾‘ã€‚

## ğŸ”§ ç¯å¢ƒè¦æ±‚

- Python 3.10+
- Node.js 18+
- MySQLæ•°æ®åº“

## ğŸ“¦ å®‰è£…æ–¹æ³•

### ä½¿ç”¨æœ¬åœ°ç¯å¢ƒ

1. å®‰è£…ä¾èµ–:
   ```bash
   pip install -r requirements.txt
   ```

2. Windowsç”¨æˆ·æ³¨æ„:
   Windowsç³»ç»Ÿéœ€è¦é¢å¤–å®‰è£…ä»¥ä¸‹ä¾èµ–:
   ```bash
   pip install win-inet-pton==1.1.0
   ```

### ä½¿ç”¨Docker

æ–¹æ³•ä¸€ï¼šå•ç‹¬æ„å»ºé•œåƒ
```bash
# æ„å»ºé•œåƒ 
docker build -t feishuapp .

# è¿è¡Œå®¹å™¨ éœ€è¦å¤–éƒ¨mysql é€šè¿‡dockerç½‘å…³è¿æ¥å®¿ä¸»æœºmysql æ¨è--env-file
docker run -it feishuapp bash
```

æ–¹æ³•äºŒï¼šä½¿ç”¨Docker Composeï¼ˆæ¨èï¼‰
```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆåº”ç”¨å’Œæ•°æ®åº“ï¼‰
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose down
```

ä½¿ç”¨Docker Composeå¯ä»¥ä¸€é”®å¯åŠ¨æ•´ä¸ªåº”ç”¨ç¯å¢ƒï¼ŒåŒ…æ‹¬MySQLæ•°æ®åº“å’Œåº”ç”¨æœåŠ¡ï¼Œæ›´åŠ æ–¹ä¾¿å’Œé«˜æ•ˆã€‚

## ğŸ› ï¸ é…ç½®è¯´æ˜

å¤åˆ¶`.env.example`æ–‡ä»¶å‘½åä¸º`.env`æ–‡ä»¶ï¼ŒåŒ…å«ä»¥ä¸‹é…ç½®:

```
# æ•°æ®åº“è®¾ç½®
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=123456
DB_NAME=lark_messages

# é£ä¹¦çš„Cookieè®¾ç½® - åªéœ€é…ç½®LARK_COOKIEå³å¯ï¼Œå‘Šåˆ«é£ä¹¦æœºå™¨äºº
LARK_COOKIE=""

# è°ƒç”¨å‡½æ•°çš„è§¦å‘å‰ç¼€ ï¼ˆä»¥FUNCTION_TRIGGER_FLAGå¼€å¤´çš„æ¶ˆæ¯ä¼šè¢«å¤§æ¨¡å‹è§£æï¼Œæ‰€æœ‰æ¶ˆæ¯éƒ½ä¼šè¢«è®°å½•åˆ°æ•°æ®åº“ï¼Œæ— è®ºæ˜¯å¦ä»¥è¯¥å‰ç¼€å¼€å¤´ï¼‰
FUNCTION_TRIGGER_FLAG="/run"

# æœºå™¨äººå‘è¨€å‰ç¼€ ï¼ˆæš‚æœªä½¿ç”¨ï¼‰
AI_BOT_PREFIX="Lark AI Bot:"

# OpenAI APIé…ç½® é»˜è®¤æ˜¯é€šä¹‰åƒé—®çš„ï¼Œæ»¡è¶³OpenAIçš„å¤§æ¨¡å‹å‚å•†éƒ½å¯ä»¥
OPENAI_API_KEY=""
OPENAI_API_BASE_URL="https://dashscope.aliyuncs.com/compatible-mode/v1"
OPENAI_API_MODEL="qwen-plus"
```

## ğŸš€ ä½¿ç”¨æŒ‡å—

### è¿è¡Œåº”ç”¨ç¨‹åº

æ–¹æ³•ä¸€ï¼šç›´æ¥è¿è¡Œ
```bash
python main.py
```

æ–¹æ³•äºŒï¼šä½¿ç”¨Docker Compose
```bash
docker-compose up -d
```

åº”ç”¨ç¨‹åºå°†:
1. åˆå§‹åŒ–MCPæœåŠ¡å™¨
2. è¿æ¥åˆ°é£ä¹¦APIå¹¶ä½¿ç”¨ä½ çš„é£ä¹¦è´¦å·ä½œä¸ºAIåŠ©æ‰‹
3. ç›‘å¬ä¼ å…¥çš„æ¶ˆæ¯
4. å¤„ç†å¹¶æ‰§è¡Œå¤§æ¨¡å‹é€šè¿‡é£ä¹¦å‘èµ·çš„å‡½æ•°è°ƒç”¨
5. å°†æ¶ˆæ¯å­˜å‚¨åœ¨MySQLæ•°æ®åº“ä¸­


## ğŸ—„ï¸ æ•°æ®åº“ç»“æ„

åº”ç”¨ç¨‹åºå°†æ¶ˆæ¯å­˜å‚¨åœ¨`messages`è¡¨ä¸­ï¼Œè¯¥è¡¨å…·æœ‰ä»¥ä¸‹ç»“æ„:

| åˆ—å           | ç±»å‹           | æè¿°                      |
|----------------|---------------|---------------------------|
| id             | INT (PK)      | ä¸»é”®                      |
| user_name      | VARCHAR(255)  | æ¶ˆæ¯å‘é€è€…çš„åç§°           |
| user_id        | VARCHAR(255)  | å‘é€è€…çš„é£ä¹¦ç”¨æˆ·ID         |
| content        | TEXT          | æ¶ˆæ¯å†…å®¹                  |
| is_group_chat  | BOOLEAN       | æ¶ˆæ¯æ˜¯å¦æ¥è‡ªç¾¤èŠ           |
| group_name     | VARCHAR(255)  | ç¾¤èŠåç§°ï¼ˆå¦‚é€‚ç”¨ï¼‰         |
| chat_id        | VARCHAR(255)  | èŠå¤©ID                    |
| message_time   | DATETIME      | æ¶ˆæ¯å‘é€æ—¶é—´               |
| created_at     | DATETIME      | è®°å½•åˆ›å»ºæ—¶é—´               |

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿è´¡çŒ®ï¼è¯·éšæ—¶æäº¤Pull Requestã€‚

1. Forkè¿™ä¸ªä»“åº“
2. åˆ›å»ºæ‚¨çš„ç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/amazing-feature`)
3. æäº¤æ‚¨çš„æ›´æ”¹ (`git commit -m 'æ·»åŠ ä¸€äº›å¾ˆæ£’çš„ç‰¹æ€§'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/amazing-feature`)
5. æ‰“å¼€Pull Request

## ğŸ› é—®é¢˜ä¸æ”¯æŒ

å¦‚æœæ‚¨é‡åˆ°ä»»ä½•é—®é¢˜æˆ–æœ‰ç–‘é—®ï¼Œè¯·[æäº¤issue](https://github.com/cv-cat/LarkAgentX/issues)æˆ–è®¿é—®æˆ‘ä»¬çš„[è®¨è®ºè®ºå›](https://github.com/cv-cat/LarkAgentX/discussions)ã€‚

## ğŸ“ˆ Star è¶‹åŠ¿
<a href="https://www.star-history.com/#cv-cat/LarkAgentX&Date">
 <picture>
   <source media="(prefers-color-scheme: dark)" srcset="https://api.star-history.com/svg?repos=cv-cat/LarkAgentX&type=Date&theme=dark" />
   <source media="(prefers-color-scheme: light)" srcset="https://api.star-history.com/svg?repos=cv-cat/LarkAgentX&type=Date" />
   <img alt="Star History Chart" src="https://api.star-history.com/svg?repos=cv-cat/LarkAgentX&type=Date" />
 </picture>
</a>
