name: Release
permissions:
  contents: read

on:
  push:
    tags:
      - "v?[0-9]+.[0-9]+.[0-9]+"
      - "v?[0-9]+.[0-9]+.[0-9]+.[0-9]+"
  workflow_dispatch:

jobs:
  release:
    uses: ./.github/workflows/build.yml
    with:
      matrix_config: |
        {
          "include": [
            {
              "os": "ubuntu-latest",
              "platform": "manylinux",
              "arch": "x86_64"
            },
            {
              "os": "ubuntu-latest",
              "platform": "musllinux",
              "arch": "x86_64"
            },
            {
              "os": "ubuntu-24.04-arm",
              "platform": "manylinux",
              "arch": "aarch64"
            },
            {
              "os": "ubuntu-24.04-arm",
              "platform": "musllinux",
              "arch": "aarch64"
            },
            {
              "os": "windows-2025",
              "platform": "win",
              "arch": "AMD64"
            },
            {
              "os": "windows-11-arm",
              "platform": "win",
              "arch": "ARM64"
            },
            {
              "os": "macos-15-intel",
              "platform": "macos",
              "arch": "x86_64"
            },
            {
              "os": "macos-15",
              "platform": "macos",
              "arch": "arm64"
            }
          ]
        }
      use_cached_builds: false

  upload_pypi:
    name: Upload to PyPI
    needs: [release]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
      attestations: write
    if: github.repository_owner == 'jmpfar'

    steps:
      - uses: actions/download-artifact@v6
        with:
          pattern: artifacts-*
          merge-multiple: true
          path: dist

      - name: Generate artifact attestation for sdist and wheels
        id: provenance
        uses: actions/attest-build-provenance@v3.0.0
        with:
          subject-path: "dist/*"

      - name: Upload to PyPI (tagged commits)
        uses: pypa/gh-action-pypi-publish@v1.13.0
        if: startsWith(github.ref, 'refs/tags/')

      - name: Upload to TestPyPI (manual trigger)
        uses: pypa/gh-action-pypi-publish@v1.13.0
        if: ${{ !startsWith(github.ref, 'refs/tags/') }}
        with:
          repository-url: https://test.pypi.org/legacy/

      - name: GitHub release for tagged commits
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            dist/*.whl
            ${{ steps.provenance.outputs.bundle-path }}
