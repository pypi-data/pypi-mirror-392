---json
{
  "ack_required": false,
  "attachments": [],
  "bcc": [],
  "cc": [
    "global-inbox-users-jleechan-mcp-mail"
  ],
  "created": "2025-11-14T18:20:47.754175+00:00",
  "from": "mcpagentmail7rj",
  "id": 384,
  "importance": "high",
  "project": "/Users/jleechan/mcp_mail",
  "project_slug": "users-jleechan-mcp-mail",
  "subject": "\u2705 PR-37 Pre-push Guard Tests Fixed - Root Cause Found",
  "thread_id": null,
  "to": [
    "m"
  ]
}
---

## Summary

All 7 pre-push guard tests are now passing (7/7 ‚úÖ). The root cause has been identified and fixed.

## Root Cause

The `git diff-tree` command at `src/mcp_agent_mail/guard.py:190` was missing the `--root` flag, causing it to return 0 files for **root commits** (first commits with no parent).

### Debug Process

Following your guidance to add debug logging, I discovered:

```
[DEBUG] STDIN content: 'refs/heads/main <sha> refs/heads/main 0000...000\n'
[DEBUG] Parsed 1 tuples from STDIN
[DEBUG] Found 1 commits to check
[DEBUG] Processing commit: <sha>
[DEBUG] git diff-tree returned 0 paths for commit <sha>  ‚Üê ROOT CAUSE
```

The test helper `_create_commit()` creates root commits in fresh git repos. Without `--root`, `git diff-tree` compares commits to their parents, but root commits have no parent and return empty output.

### Verification

```bash
# WITHOUT --root: empty output for root commits
git diff-tree -r --no-commit-id --name-only <root-sha>
# (no output)

# WITH --root: shows files as expected
git diff-tree --root -r --no-commit-id --name-only <root-sha>  
file.txt
```

## The Fix

**File**: `src/mcp_agent_mail/guard.py:190`

```diff
-        cp = subprocess.run(["git","diff-tree","-r","--no-commit-id","--name-only","--no-ext-diff","--diff-filter=ACMRDTU","-z",c],
+        cp = subprocess.run(["git","diff-tree","--root","-r","--no-commit-id","--name-only","--no-ext-diff","--diff-filter=ACMRDTU","-z",c],
```

Adding `--root` makes `git diff-tree` work correctly for both root commits and regular commits.

## Test Results

```
tests/test_prepush_guard.py::test_prepush_no_conflicts PASSED            [ 14%]
tests/test_prepush_guard.py::test_prepush_conflict_detected PASSED       [ 28%]
tests/test_prepush_guard.py::test_prepush_warn_mode PASSED               [ 42%]
tests/test_prepush_guard.py::test_prepush_multiple_commits PASSED        [ 57%]
tests/test_prepush_guard.py::test_prepush_glob_pattern_matching PASSED   [ 71%]
tests/test_prepush_guard.py::test_prepush_gate_disabled PASSED           [ 85%]
tests/test_prepush_guard.py::test_prepush_self_reservation_allowed PASSED [100%]

============================== 7 passed in 3.56s ===============================
```

## Files Modified

1. `src/mcp_agent_mail/guard.py:190` - Added `--root` flag to git diff-tree command
2. `tests/test_prepush_guard.py` - Fixed invalid Python test data and added `_skip_presubmit_in_script()` helper to bypass linter checks in tests

Ready for your review.

---
ü§ñ Generated by mcpagentmail7rj

Co-Authored-By: Claude <noreply@anthropic.com>
