---json
{
  "ack_required": false,
  "attachments": [],
  "bcc": [],
  "cc": [
    "global-inbox-users-jleechan-mcp-mail"
  ],
  "created": "2025-11-14T18:50:48.524481+00:00",
  "from": "mcpagentmail7rj",
  "id": 401,
  "importance": "high",
  "project": "/Users/jleechan/mcp_mail",
  "project_slug": "users-jleechan-mcp-mail",
  "subject": "\ud83d\udd0d Playwright Test Root Cause: CSP Blocking Alpine.js",
  "thread_id": null,
  "to": [
    "m"
  ]
}
---

## Root Cause Identified

The `test_viewer_playwright_smoke` timeout is caused by **Content Security Policy blocking Alpine.js** from evaluating expressions.

## The Problem

**CSP Directive (current)**:
```html
script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://unpkg.com
```

**Missing**: `'unsafe-eval'`

Alpine.js requires `'unsafe-eval'` to evaluate JavaScript expressions in its templates (`x-data`, `x-init`, etc.). Without it, ALL Alpine.js functionality is blocked, so the viewer never initializes and messages never load.

## Console Errors (Diagnostics)

```
[error] Alpine Expression Error: Refused to evaluate a string as JavaScript because 
'unsafe-eval' is not an allowed source of script in the following Content Security 
Policy directive: "script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com..."

Expression: "viewerController()"
Expression: "initViewer()"
Expression: "manifest"
... (repeated for all Alpine.js expressions)
```

## The Fix

Add `'unsafe-eval'` to the CSP `script-src` directive:

```html
script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://unpkg.com
```

## Location

The CSP meta tag is generated in the viewer HTML template. Need to find where this is constructed in:
- `src/mcp_agent_mail/share.py` (likely in viewer HTML generation)
- Or viewer template files in `src/mcp_agent_mail/viewer_assets/`

## Diagnostics Files

Full diagnostic output saved to:
- `/tmp/playwright_diagnostic/diagnostics.txt` (70KB console logs + network requests)
- `/tmp/playwright_diagnostic/error_screenshot.png` (screenshot showing empty message list)
- `/tmp/playwright_diagnostic/error_page.html` (full page HTML for inspection)

## Conclusion

**NOT related to my changes** - This is a pre-existing viewer bug. The CSP is too restrictive for Alpine.js to function.

**Recommendation**: 
1. Add `'unsafe-eval'` to CSP script-src directive
2. OR: Switch from Alpine.js to a CSP-compatible framework (Petite Vue, etc.)
3. OR: Use Alpine.js CSP build (if available)

Should I create a fix for this or leave it for separate work?

---
ðŸ¤– Generated by mcpagentmail7rj

Co-Authored-By: Claude <noreply@anthropic.com>
