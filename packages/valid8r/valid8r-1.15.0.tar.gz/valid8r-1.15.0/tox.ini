[tox]
isolated_build = True
envlist = py311, py312, py313, py314

[testenv]
deps =
    pytest
    behave
    click>=8.0.0
    coverage
    pytest-cov
    pytest-mock
    pytest-sugar
    typer>=0.20.0
    pytest-benchmark
    marshmallow
    cerberus
setenv =
    PYTHONPATH = {toxinidir}
commands =
    # Install package in development mode so tests use the actual source
    pip install -e .
    # Run unit tests with pytest (excluding benchmarks by default)
    pytest tests/unit tests/bdd {posargs} --cov=valid8r --cov-report=term
    # Run BDD tests with behave
    behave tests/bdd/features

[testenv:lint]
deps =
    ruff
    isort
    mypy
commands =
    ruff check .
    ruff format .
    isort --check-only valid8r tests
    mypy valid8r

[testenv:docs]
deps =
    sphinx
    sphinx-rtd-theme
    sphinx-autodoc-typehints
    sphinx-copybutton
    sphinx-autoapi
    myst-parser
    linkify-it-py
commands =
    sphinx-build -b html docs docs/_build/html

[testenv:coverage]
deps =
    pytest
    coverage
    pytest-cov
commands =
    pytest --cov=valid8r tests/unit
    coverage report -m
    coverage html

[testenv:bdd]
deps =
    behave
    click>=8.0.0
    pytest
    typer>=0.20.0
commands =
    pip install -e .
    behave tests/bdd/features

[testenv:doctests]
description = Run doctests in code and documentation
deps =
    pytest
commands =
    pip install -e .
    pytest --doctest-modules valid8r/core/parsers.py

[testenv:benchmarks]
description = Run performance benchmarks
deps =
    pytest
    pytest-benchmark
    marshmallow
    cerberus
commands =
    pip install -e .
    # Run benchmark correctness tests first
    pytest tests/benchmarks/test_benchmark_correctness.py -v
    # Then run performance benchmarks
    pytest tests/benchmarks/test_benchmarks.py --benchmark-only --benchmark-sort=name

[testenv:security]
description = Run security tests and ReDoS detection
deps =
    pytest
    pytest-cov
    regexploit
commands =
    pip install -e .
    # Run security tests (including ReDoS protection tests)
    pytest tests/security/ -v --cov=scripts/check_regex_safety --cov-report=term
    # Run ReDoS scanner on the entire codebase
    python scripts/check_regex_safety.py valid8r/
