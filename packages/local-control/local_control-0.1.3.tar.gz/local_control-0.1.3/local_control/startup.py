"""
Cross-platform helpers for registering/unregistering the LAN control server at user login.
"""

from __future__ import annotations

import os
import plistlib
import shlex
import subprocess
import sys
from pathlib import Path
from typing import List


class StartupError(RuntimeError):
    """Raised when registering or unregistering auto-start fails."""


class StartupManager:
    def __init__(self, host: str, port: int, debug: bool = False) -> None:
        self.host = host
        self.port = port
        self.debug = debug
        self.python = Path(sys.executable).resolve()
        self.command = self._build_command()

    def enable(self) -> None:
        system = sys.platform
        try:
            if system.startswith("win"):
                self._enable_windows()
            elif system == "darwin":
                self._enable_darwin()
            else:
                self._enable_linux()
        except OSError as exc:  # pragma: no cover - platform specific
            raise StartupError(str(exc)) from exc

    def disable(self) -> None:
        system = sys.platform
        try:
            if system.startswith("win"):
                self._disable_windows()
            elif system == "darwin":
                self._disable_darwin()
            else:
                self._disable_linux()
        except OSError as exc:  # pragma: no cover - platform specific
            raise StartupError(str(exc)) from exc

    # ------------------------------------------------------------------ #
    def _build_command(self) -> List[str]:
        cmd = [
            str(self.python),
            "-m",
            "local_control.cli",
            "--host",
            self.host,
            "--port",
            str(self.port),
        ]
        if self.debug:
            cmd.append("--debug")
        return cmd

    # Linux ------------------------------------------------------------- #
    def _autostart_path(self) -> Path:
        return Path.home() / ".config" / "autostart" / "local_control.desktop"

    def _enable_linux(self) -> None:
        path = self._autostart_path()
        path.parent.mkdir(parents=True, exist_ok=True)
        exec_cmd = " ".join(shlex.quote(part) for part in self.command)
        desktop_entry = "\n".join(
            [
                "[Desktop Entry]",
                "Type=Application",
                "Version=1.0",
                "Name=Local Control",
                "Comment=Start the Local Control server on login",
                f"Exec={exec_cmd}",
                "X-GNOME-Autostart-enabled=true",
            ]
        )
        path.write_text(desktop_entry, encoding="utf-8")

    def _disable_linux(self) -> None:
        path = self._autostart_path()
        if path.exists():
            path.unlink()

    # macOS ------------------------------------------------------------- #
    def _launch_agent_path(self) -> Path:
        return Path.home() / "Library" / "LaunchAgents" / "com.local_control.server.plist"

    def _enable_darwin(self) -> None:
        agent_path = self._launch_agent_path()
        agent_path.parent.mkdir(parents=True, exist_ok=True)
        plist = {
            "Label": "com.local_control.server",
            "ProgramArguments": self.command,
            "RunAtLoad": True,
            "KeepAlive": False,
            "WorkingDirectory": str(Path.home()),
            "StandardOutPath": str(agent_path.with_suffix(".log")),
            "StandardErrorPath": str(agent_path.with_suffix(".err.log")),
        }
        agent_path.write_bytes(plistlib.dumps(plist))
        subprocess.run(["launchctl", "load", str(agent_path)], check=False)

    def _disable_darwin(self) -> None:
        agent_path = self._launch_agent_path()
        subprocess.run(["launchctl", "unload", str(agent_path)], check=False)
        if agent_path.exists():
            agent_path.unlink()

    # Windows ----------------------------------------------------------- #
    def _startup_script_path(self) -> Path:
        appdata = Path(os.environ.get("APPDATA", Path.home() / "AppData" / "Roaming"))
        startup_dir = appdata / "Microsoft" / "Windows" / "Start Menu" / "Programs" / "Startup"
        startup_dir.mkdir(parents=True, exist_ok=True)
        return startup_dir / "local_control_startup.bat"

    def _enable_windows(self) -> None:
        path = self._startup_script_path()
        cmd = " ".join(f'"{part}"' if " " in part else part for part in self.command)
        script = "\r\n".join(
            [
                "@echo off",
                "REM Auto-generated by local_control StartupManager",
                f'start "" {cmd}',
            ]
        )
        path.write_text(script, encoding="utf-8")

    def _disable_windows(self) -> None:
        path = self._startup_script_path()
        if path.exists():
            path.unlink()
