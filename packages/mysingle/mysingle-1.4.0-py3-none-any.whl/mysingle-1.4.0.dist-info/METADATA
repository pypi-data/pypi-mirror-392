Metadata-Version: 2.4
Name: mysingle
Version: 1.4.0
Summary: Common utilities and configurations for MySingle Platform microservices
Requires-Python: >=3.12
Requires-Dist: aiohttp>=3.9.4
Requires-Dist: beanie>=1.23.6
Requires-Dist: colorlog>=6.9.0
Requires-Dist: duckdb>=1.1.0
Requires-Dist: email-validator>=2.2.0
Requires-Dist: emails>=0.6
Requires-Dist: fastapi>=0.104.1
Requires-Dist: httpx-oauth>=0.16.1
Requires-Dist: httpx>=0.25.2
Requires-Dist: jinja2>=3.1.6
Requires-Dist: makefun>=1.16.0
Requires-Dist: motor>=3.3.2
Requires-Dist: numpy>=1.26.0
Requires-Dist: pandas>=2.2.0
Requires-Dist: prometheus-client>=0.19.0
Requires-Dist: pwdlib[argon2,bcrypt]>=0.2.1
Requires-Dist: pydantic-settings>=2.1.0
Requires-Dist: pydantic>=2.5.0
Requires-Dist: pyjwt>=2.10.1
Requires-Dist: python-multipart>=0.0.6
Requires-Dist: redis>=6.4.0
Requires-Dist: restrictedpython>=7.0
Requires-Dist: structlog>=23.2.0
Requires-Dist: uvicorn[standard]>=0.24.0
Provides-Extra: dev
Requires-Dist: httpx>=0.26.0; extra == 'dev'
Requires-Dist: mypy>=1.8.0; extra == 'dev'
Requires-Dist: pytest-asyncio>=0.21.1; extra == 'dev'
Requires-Dist: pytest>=7.4.3; extra == 'dev'
Requires-Dist: ruff>=0.1.9; extra == 'dev'
Description-Content-Type: text/markdown

# MySingle

Common utilities and configurations for MySingle Platform microservices.

## ğŸ“¦ Installation

### Basic Installation
```bash
pip install mysingle
```
Installs only core dependencies (`pydantic`, `pydantic-settings`).

### Feature-specific Installation
```bash
# Authentication features
pip install mysingle[auth]

# Web framework features
pip install mysingle[web]

# Database features
pip install mysingle[database]

# Email features
pip install mysingle[email]

# Monitoring features
pip install mysingle[monitoring]

# DSL runtime features
pip install mysingle[dsl]

# All features
pip install mysingle[full]

# Development tools
pip install mysingle[dev]
```

### Combined Installation
```bash
# Web + Auth + Database
pip install mysingle[web,auth,database]

# Full features + development tools
pip install mysingle[full,dev]
```

## ğŸš€ Quick Start

### Basic Usage
```python
from mysingle.core import create_fastapi_app
from mysingle.core.config import settings

# Create FastAPI app with common configurations
app = create_fastapi_app()

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
```

## ğŸ§­ Imports: ê¶Œì¥ ê²½ë¡œ

ë£¨íŠ¸ ì¬ë…¸ì¶œì€ ìœ ì§€ë˜ì§€ë§Œ, ì„œë¸ŒíŒ¨í‚¤ì§€ ê²½ë¡œë¥¼ ì‚¬ìš©í•˜ë©´ ìˆœí™˜ì°¸ì¡°ë¥¼ í”¼í•˜ê³  ì´ˆê¸°í™” ë¹„ìš©ì„ ì¤„ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- Core (ë£¨íŠ¸ì—ì„œë„ ë…¸ì¶œ ìœ ì§€)
    - ê¶Œì¥: `from mysingle.core import create_fastapi_app, CommonSettings, settings, get_settings, init_mongo, get_mongodb_url, get_database_name`
    - ë£¨íŠ¸ë„ ê°€ëŠ¥: `from mysingle import create_fastapi_app, CommonSettings, settings, get_settings, init_mongo, get_mongodb_url, get_database_name`

- Logging
    - ê¶Œì¥: `from mysingle.logging import get_logger, setup_logging, configure_structured_logging`
    - ë£¨íŠ¸ë„ ê°€ëŠ¥: `from mysingle import get_logger`

- Database
    - ê¶Œì¥: `from mysingle.database import BaseDuckDBManager`
    - ë£¨íŠ¸ë„ ê°€ëŠ¥: `from mysingle import BaseDuckDBManager`

- Clients
    - ê¶Œì¥: `from mysingle.clients import BaseServiceClient`
    - ë£¨íŠ¸ë„ ê°€ëŠ¥: `from mysingle import BaseServiceClient`

- DSL
    - ê¶Œì¥: `from mysingle.dsl import DSLParser, DSLExecutor, SecurityValidator, ResourceLimits`
    - ë£¨íŠ¸ë„ ê°€ëŠ¥: `from mysingle import DSLParser, DSLExecutor, SecurityValidator, ResourceLimits`

ë£¨íŠ¸ íŒ¨í‚¤ì§€(`mysingle`)ëŠ” ì§€ì—° ë¡œë”©(lazy export)ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ìˆì–´, ì‹¬ë³¼ ì ‘ê·¼ ì‹œì ì—ë§Œ ì„œë¸ŒíŒ¨í‚¤ì§€ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.

### With Authentication
```python
from mysingle.core import create_fastapi_app
from mysingle.auth import get_user_manager
from mysingle.auth.router import auth_router

app = create_fastapi_app()
app.include_router(auth_router, prefix="/auth")
```

### With Database
```python
from mysingle.core import create_fastapi_app
from mysingle.core.db import init_db

app = create_fastapi_app()

@app.on_event("startup")
async def startup():
    await init_db()
```

### With DSL Runtime
```python
from mysingle.dsl import DSLParser, DSLExecutor
import pandas as pd

# Parse and compile DSL code
parser = DSLParser()
bytecode = parser.parse("result = sma(close, 20)")

# Execute with data
executor = DSLExecutor()
data = pd.DataFrame({"close": [100, 102, 105, 103, 107]})
result = executor.execute(bytecode, data={"close": data["close"]})
print(result["result"])  # 20-period SMA
```

## ğŸ“‹ Features

- **ğŸ” Authentication**: JWT-based auth with OAuth support
- **ğŸŒ Web Framework**: FastAPI with common configurations
- **ğŸ—„ï¸ Database**: MongoDB with Beanie ODM
- **ğŸ“§ Email**: Template-based email system
- **ğŸ“Š Monitoring**: Prometheus metrics and structured logging
- **âš™ï¸ Configuration**: Pydantic-based settings management
- **ğŸ”§ DSL Runtime**: Secure Python DSL execution engine for user-defined indicators and strategies
- **ğŸ”‘ Standard Constants**: HTTP headers and environment variable naming conventions

## ğŸ”‘ Standard Constants

ëª¨ë“  ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ì—ì„œ ì¼ê´€ëœ í—¤ë” ë° í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš©ì„ ìœ„í•œ í‘œì¤€ ìƒìˆ˜ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

### HTTP í—¤ë” ìƒìˆ˜

```python
from mysingle.constants import (
    # Kong Gateway ì›ë³¸ í—¤ë”
    HEADER_KONG_USER_ID,         # "X-Consumer-Custom-ID" (JWT sub í´ë ˆì„)
    HEADER_KONG_CONSUMER_ID,     # "X-Consumer-ID"
    HEADER_KONG_REQUEST_ID,      # "X-Kong-Request-Id"
    HEADER_CORRELATION_ID,       # "X-Correlation-Id"

    # ì„œë¹„ìŠ¤ ê°„ ì „íŒŒìš© í—¤ë”
    HEADER_USER_ID,              # "X-User-Id" (ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ ì „íŒŒ)
    HEADER_AUTHORIZATION,        # "Authorization"
)

# ì‚¬ìš© ì˜ˆì‹œ
headers = {
    HEADER_AUTHORIZATION: f"Bearer {token}",
    HEADER_USER_ID: user_id,
    HEADER_CORRELATION_ID: correlation_id,
}
```

### gRPC ë©”íƒ€ë°ì´í„° ìƒìˆ˜

```python
from mysingle.constants import (
    GRPC_METADATA_USER_ID,       # "user_id"
    GRPC_METADATA_AUTHORIZATION, # "authorization"
    GRPC_METADATA_CORRELATION_ID,# "correlation_id"
)

# ì‚¬ìš© ì˜ˆì‹œ
metadata = [
    (GRPC_METADATA_USER_ID, user_id),
    (GRPC_METADATA_CORRELATION_ID, correlation_id),
]
```

### í™˜ê²½ ë³€ìˆ˜ ë„¤ì´ë° ê·œì¹™

```python
from mysingle.constants import (
    HTTP_CLIENT_MAX_CONNECTIONS,  # "HTTP_CLIENT_MAX_CONNECTIONS"
    HTTP_CLIENT_TIMEOUT,           # "HTTP_CLIENT_TIMEOUT"
    ENV_TEST_ALLOW_SIMPLE_USER,   # "TEST_ALLOW_SIMPLE_USER"
)

# ì„œë¹„ìŠ¤ë³„ gRPC ì„¤ì • íŒ¨í„´
# USE_GRPC_FOR_<SERVICE_NAME>
# <SERVICE_NAME>_GRPC_HOST
# <SERVICE_NAME>_GRPC_PORT
```

### BaseServiceClient í‘œì¤€ ì‚¬ìš©ë²•

```python
from mysingle.clients import BaseServiceClient
from fastapi import Request

class MyServiceClient(BaseServiceClient):
    def __init__(self, request: Request | None = None):
        super().__init__(
            service_name="my-service",
            default_port=8001,
            request=request,  # JWTì™€ X-User-Id ìë™ ì „íŒŒ
        )

    async def get_data(self) -> dict:
        return await self._request("GET", "/api/v1/data")

# ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ì‚¬ìš©
@router.get("/endpoint")
async def endpoint(request: Request):
    async with MyServiceClient(request=request) as client:
        # requestì—ì„œ Authorization, X-User-Id ìë™ ì¶”ì¶œ ë° ì „íŒŒ
        data = await client.get_data()
    return data
```

## ï¿½ gRPC Interceptors

gRPC ì„œë¹„ìŠ¤ì—ì„œ ì¸ì¦, ë¡œê¹…, ë©”íƒ€ë°ì´í„° ì „íŒŒë¥¼ ìœ„í•œ í‘œì¤€ ì¸í„°ì…‰í„°ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

### ì„œë²„ ì¸í„°ì…‰í„° ì ìš©

```python
import grpc
from mysingle.grpc import AuthInterceptor, LoggingInterceptor, MetadataInterceptor

# gRPC ì„œë²„ ìƒì„± ì‹œ ì¸í„°ì…‰í„° ì ìš©
async def serve():
    server = grpc.aio.server(
        interceptors=[
            AuthInterceptor(
                require_auth=True,
                exempt_methods=["/health/Check", "/health/Ready"]
            ),
            MetadataInterceptor(auto_generate=True),
            LoggingInterceptor(),
        ]
    )

    # servicer ë“±ë¡
    my_pb2_grpc.add_MyServiceServicer_to_server(MyServiceServicer(), server)

    server.add_insecure_port('[::]:50051')
    await server.start()
    await server.wait_for_termination()
```

### í´ë¼ì´ì–¸íŠ¸ ì¸í„°ì…‰í„° ì ìš©

```python
from mysingle.grpc import ClientAuthInterceptor

async def call_grpc_service(user_id: str, correlation_id: str | None = None):
    async with grpc.aio.insecure_channel(
        'strategy-service:50051',
        interceptors=[
            ClientAuthInterceptor(
                user_id=user_id,
                correlation_id=correlation_id
            )
        ]
    ) as channel:
        stub = strategy_pb2_grpc.StrategyServiceStub(channel)
        response = await stub.GetStrategy(request)
        return response
```

### ë©”íƒ€ë°ì´í„° í‘œì¤€

ëª¨ë“  gRPC í˜¸ì¶œì€ ì•„ë˜ ë©”íƒ€ë°ì´í„°ë¥¼ ì „íŒŒí•©ë‹ˆë‹¤:

```python
from mysingle.constants import (
    GRPC_METADATA_USER_ID,        # "user_id" (í•„ìˆ˜)
    GRPC_METADATA_CORRELATION_ID, # "correlation_id" (ì„ íƒ, ìë™ ìƒì„±)
    GRPC_METADATA_REQUEST_ID,     # "request_id" (ì„ íƒ, ìë™ ìƒì„±)
)
```

**ì£¼ì˜ì‚¬í•­:**
- `user_id`ëŠ” ëª¨ë“  gRPC í˜¸ì¶œì— í•„ìˆ˜ì…ë‹ˆë‹¤.
- `AuthInterceptor`ëŠ” `user_id` ëˆ„ë½ ì‹œ `UNAUTHENTICATED` ì—ëŸ¬ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
- ê°œë°œ/í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œëŠ” `require_auth=False`ë¡œ ì¸ì¦ì„ ë¹„í™œì„±í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ï¿½ğŸ“ Available Dependencies by Feature

### Core (always installed)
- `pydantic>=2.5.0`
- `pydantic-settings>=2.1.0`

### Auth
- `httpx-oauth>=0.16.1`
- `pyjwt>=2.10.1`
- `pwdlib>=0.2.1`

### Web
- `fastapi>=0.104.1`
- `uvicorn[standard]>=0.24.0`
- `python-multipart>=0.0.6`

### Database
- `motor>=3.3.2`
- `beanie>=1.23.6`
- `redis>=6.4.0`

### Email
- `emails>=0.6`
- `jinja2>=3.1.6`

### Monitoring
- `prometheus-client>=0.19.0`
- `structlog>=23.2.0`

### DSL
- `RestrictedPython>=7.4`
- `pandas>=2.1.4`
- `numpy>=1.24.0`

## ğŸ› ï¸ Development

```bash
# Clone repository
git clone <repo-url>
cd quant-pack

# Install with development dependencies
pip install -e .[full,dev]

# Run tests
pytest

# Format code
black src/
ruff check src/ --fix

# Type checking
mypy src/mysingle/
```

## ğŸ”– Release & Versioning

CIëŠ” ê¸°ë³¸ì ìœ¼ë¡œ Conventional Commitsë¥¼ íŒŒì‹±í•´ ìë™ìœ¼ë¡œ ë‹¤ìŒ ë²„ì „ì„ ê²°ì •(major/minor/patch)í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ ë¦´ë¦¬ìŠ¤ ì „ì— ìˆ˜ë™ìœ¼ë¡œ ë²„ì „ì„ ì§€ì •í•˜ê³  ì‹¶ë‹¤ë©´, ì œê³µëœ ëŒ€í™”í˜• ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”. ì´ ìŠ¤í¬ë¦½íŠ¸ë¡œ ì§ì ‘ ë²„ì „ì„ ì˜¬ë¦¬ë©´ CIì˜ ìë™ ë²„ì „ ê²°ì •ì€ ìŠ¤í‚µë©ë‹ˆë‹¤(ìˆ˜ë™ ë³€ê²½ ìš°ì„ ).

### ëŒ€í™”í˜• ë²„ì „ ì—… ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš©ë²•

```bash
python scripts/bump_version.py
```

- í˜„ì¬ ë²„ì „ì„ ì½ì–´ì™€ bump ì¢…ë¥˜(major/minor/patch/custom)ë¥¼ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ì˜µì…˜ìœ¼ë¡œ main ë¸Œëœì¹˜ ì „í™˜/ìµœì‹  ë°˜ì˜, ì»¤ë°‹/íƒœê·¸ ìƒì„±, ì›ê²© í‘¸ì‹œê¹Œì§€ ì§€ì›í•©ë‹ˆë‹¤.
- ì»¤ë°‹ ë©”ì‹œì§€ëŠ” `chore(release): vX.Y.Z (bump <type>)` í˜•íƒœë¡œ ìƒì„±ë©ë‹ˆë‹¤.
- pyproject.tomlì˜ `project.version`ì´ ë³€ê²½ë˜ë¯€ë¡œ, ê°™ì€ ì»¤ë°‹ì—ì„œ ë‹¤ì‹œ ìë™ ë²„ì „ ì˜¬ë¦¬ê¸°ë¥¼ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ê¶Œì¥ í”Œë¡œìš°(ìˆ˜ë™ ë¦´ë¦¬ìŠ¤):

1) í…ŒìŠ¤íŠ¸/ê²€í†  ì™„ë£Œ â†’ 2) `python scripts/bump_version.py` ì‹¤í–‰ â†’ 3) ì»¤ë°‹/íƒœê·¸/í‘¸ì‹œ â†’ 4) CIê°€ ë¹Œë“œ/í¼ë¸”ë¦¬ì‹œ ìˆ˜í–‰(ìˆ˜ë™ ë²„ì „ ìœ ì§€)

## ï¿½ï¸ Roadmap

### Phase 1: Enhanced Developer Experience (Current)
- [ ] **DI Functions Compatibility**: Add `Depends()` wrapper functions for backward compatibility
- [ ] **ServiceConfig Extensions**: Add ServiceCategory enum and internal routes flag
- [ ] **Configuration Documentation**: Create inheritance pattern templates for services

### Phase 2: Advanced Architecture (Q4 2024)
- [ ] **Service Templates**: Generate service-specific configuration templates
- [ ] **Service Type Expansion**: Add ORCHESTRATOR, EXECUTION, DATA, ANALYTICS, UTILITY types
- [ ] **Enhanced Routing**: Support for internal vs external API separation

### Phase 3: Developer Tools (Q1 2025)
- [ ] **CLI Tools**: Service generator and validator commands
- [ ] **Testing Utilities**: Enhanced auth helpers and service testing framework
- [ ] **Auto Documentation**: Generate service documentation from configuration

### Completed Features âœ…
- **App Factory Standardization**: Unified FastAPI app creation with automatic middleware setup
- **HTTP Client Pooling**: Standardized service-to-service communication with connection pooling
- **Structured Logging**: JSON logging with correlation ID support and context management
- **Kong Gateway Integration**: Complete header standardization and authentication flow
- **Metrics Collection**: Prometheus-compatible metrics with performance monitoring
- **Audit Logging**: Comprehensive request/response logging system

### Migration Status
- [x] All services using App Factory pattern
- [x] HTTP client standardization implemented
- [x] Kong Gateway headers standardized
- [x] Structured logging system deployed
- [ ] CommonSettings inheritance pattern adoption
- [ ] Request-based DI pattern migration
- [ ] Test code updates
- [ ] Environment configuration migration

## ï¿½ğŸ“„ License

This project is licensed under the MIT License.
