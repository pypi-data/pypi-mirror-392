<!DOCTYPE html>
<html>
<head>
    <title>DBT Column Lineage</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/css/styles.css') }}">
    <script src="{{ url_for('static', path='/vendor/d3.v7.min.js') }}"></script>
    <script src="https://dagrejs.github.io/project/dagre/latest/dagre.min.js"></script>
    <script src="{{ url_for('static', path='/js/config.js') }}"></script>
    <script src="{{ url_for('static', path='/js/dataProcessor.js') }}"></script>
    <script src="{{ url_for('static', path='/js/utils.js') }}"></script>
    <script src="{{ url_for('static', path='/js/renderer.js') }}"></script>
    <script src="{{ url_for('static', path='/js/interactions.js') }}"></script>
    <script src="{{ url_for('static', path='/js/graph.js') }}"></script>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            {% if explore_mode %}
            <div class="explore-panel">
                <h3>Explore Lineage</h3>
                <div class="search-bar-container">
                    <input type="text" id="modelSearchInput" placeholder="Search models...">
                    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </div>
                <div id="model-tree-container">
                </div>
                <div class="explore-panel-actions">
                    <div class="column-selector">
                        <label for="columnSelect">Column:</label>
                        <div class="custom-select disabled" id="columnSelectWrapper">
                            <div class="custom-select-trigger" id="columnSelectTrigger">
                                <span class="custom-select-value"><span class="option-text">Select a model first</span></span>
                                <svg class="custom-select-arrow" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </div>
                            <div class="custom-select-options" id="columnSelectOptions">
                                <div class="custom-select-option" data-value=""><span class="option-text">Select a column</span></div>
                            </div>
                        </div>
                        <select id="columnSelect" disabled style="display: none;">
                            <option value="">Select a model first</option>
                        </select>
                    </div>
                    <div class="action-buttons">
                        <button id="loadLineage" disabled>Load Lineage</button>
                    </div>
                </div>
            </div>
            {% endif %}
            <!-- Impact Analysis Panel -->
            <div id="impactAnalysisPanel" class="impact-panel" style="display: none;">
                <div class="impact-panel-resize-handle" id="impactPanelResizeHandle"></div>
                <div class="impact-panel-header">
                    <div class="header-content">
                        <h3>Impact Analysis</h3>
                        <p class="header-subtitle">What happens if I change this column?</p>
                    </div>
                    <button id="closeImpactPanel" class="close-button">×</button>
                </div>
                <div id="impactAnalysisContent" class="impact-panel-content">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
            <div class="controls">
                <h3>Controls</h3>
                <button id="zoomIn">Zoom In</button>
                <button id="zoomOut">Zoom Out</button>
                <button id="resetView">Reset View</button>
                <button id="relayout">Re-layout</button>
            </div>
        </div>
        <div id="graph">
            <!-- Impact Analysis Card - appears when lineage is loaded -->
            <div id="impactAnalysisCard" class="impact-analysis-card" style="display: none;">
                <div class="impact-card-header">
                    <div class="impact-card-title">
                        <span class="impact-card-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"></path>
                                <circle cx="12" cy="12" r="5"></circle>
                            </svg>
                        </span>
                        <div>
                            <h4>What happens if I change this column?</h4>
                            <p class="impact-card-subtitle">Understand the impact of modifying this column's logic on downstream models, transformations, and dashboards</p>
                        </div>
                    </div>
                    <button class="impact-card-close" onclick="document.getElementById('impactAnalysisCard').style.display='none'">×</button>
                </div>
                <div class="impact-card-content">
                    <div class="impact-card-explanation">
                        <p>
                            <strong>Impact Analysis</strong> shows you what will be affected if you modify this column:
                        </p>
                        <ul>
                            <li>Which <strong>models and columns</strong> depend on this column</li>
                            <li>Which <strong>transformations</strong> (SUM, CASE, etc.) use this column and may need review</li>
                            <li>Which <strong>dashboards and exposures</strong> will be impacted</li>
                        </ul>
                        <p>
                            This helps you understand the <strong>blast radius</strong> of your changes before making them.
                        </p>
                    </div>
                    <button id="loadImpactAnalysisFromCard" class="impact-card-button">
                        Analyze Impact
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Data:', {{ data | tojson }});
            let graphInstance = initGraph({{ data | tojson }});
            
            {% if explore_mode %}
            const columnSelect = document.getElementById('columnSelect');
            const loadLineageBtn = document.getElementById('loadLineage');
            const graphContainer = document.getElementById('graph');
            const modelTreeContainer = document.getElementById('model-tree-container');
            const searchInput = document.getElementById('modelSearchInput');
            
            let selectedModelData = null;
            let allTreeData = [];
            
            const iconFolderClosed = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" class="tree-icon folder-icon closed"><path d="M3 7C3 5.89543 3.89543 5 5 5H9.58579C9.851 5 10.1054 5.10536 10.2929 5.29289L12 7H19C20.1046 7 21 7.89543 21 9V18C21 19.1046 20.1046 20 19 20H5C3.89543 20 3 19.1046 3 18V7Z" fill="currentColor" fill-opacity="0.3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
            const iconFolderOpen = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" class="tree-icon folder-icon open"><path d="M3 7C3 5.89543 3.89543 5 5 5H9.58579C9.851 5 10.1054 5.10536 10.2929 5.29289L12 7H19C20.1046 7 21 7.89543 21 9V10M3 11L4.5 17.5C4.77614 18.6 5.77614 19.5 6.9 19.5H17.1C18.2239 19.5 19.2239 18.6 19.5 17.5L21 11H3Z" fill="currentColor" fill-opacity="0.2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
            const iconModel = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" class="tree-icon model-icon"><path d="M12 3L3 7.5V16.5L12 21L21 16.5V7.5L12 3Z" fill="currentColor" fill-opacity="0.2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 12L21 7.5M12 12L3 7.5M12 12V21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
            const iconSource = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" class="tree-icon source-icon"><path d="M12 5C7 5 4 6.5 4 8.5C4 10.5 7 12 12 12C17 12 20 10.5 20 8.5C20 6.5 17 5 12 5Z" fill="currentColor" fill-opacity="0.3" stroke="currentColor" stroke-width="1.5"/><path d="M4 8.5V15.5C4 17.5 7 19 12 19C17 19 20 17.5 20 15.5V8.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M4 12C4 14 7 15.5 12 15.5C17 15.5 20 14 20 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>`;
            const iconSeed = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" class="tree-icon seed-icon"><path d="M3 6C3 4.34315 4.34315 3 6 3H14L18 7V18C18 19.6569 16.6569 21 15 21H6C4.34315 21 3 19.6569 3 18V6Z" fill="currentColor" fill-opacity="0.2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M14 3V7H18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M7 12H14M7 16H11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>`;
            const iconExposure = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" class="tree-icon exposure-icon"><path d="M14 2H6C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2Z" fill="currentColor" fill-opacity="0.2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M14 2V8H20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M16 13H8M16 17H8M10 9H8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>`;
            const iconDefault = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" class="tree-icon default-icon"><rect x="4" y="4" width="16" height="16" rx="2" fill="currentColor" fill-opacity="0.2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;

            function renderTree(nodes, container, level = 0) {
                const ul = document.createElement('ul');
                ul.classList.add('model-tree');
                if (level > 0) ul.classList.add('nested');

                nodes.forEach(node => {
                    const li = document.createElement('li');
                    const nodeType = node.resource_type === 'exposure' ? 'exposure' : node.type;
                    li.classList.add('tree-node', `tree-node-${nodeType}`);
                    
                    const nodeContent = document.createElement('div');
                    nodeContent.classList.add('node-content');
                    
                    const iconContainer = document.createElement('span');
                    iconContainer.classList.add('icon-container');

                    const span = document.createElement('span');
                    span.textContent = node.type === 'model' ? node.display_name : node.name; 
                    span.classList.add('node-label');

                    if (node.type === 'folder') {
                        nodeContent.classList.add('folder');
                        iconContainer.innerHTML = iconFolderClosed;
                        nodeContent.appendChild(iconContainer);
                        nodeContent.appendChild(span);
                        
                        li.appendChild(nodeContent);

                        nodeContent.addEventListener('click', () => {
                            li.classList.toggle('expanded');
                            const nestedUl = li.querySelector('ul');
                            const icon = iconContainer.querySelector('.folder-icon');
                            if (nestedUl) {
                                nestedUl.classList.toggle('active');
                                if (li.classList.contains('expanded')) {
                                    iconContainer.innerHTML = iconFolderOpen;
                                } else {
                                    iconContainer.innerHTML = iconFolderClosed;
                                }
                            }
                        });
                        if (node.children && node.children.length > 0) {
                             renderTree(node.children, li, level + 1);
                             const childUl = li.querySelector('ul');
                             if(childUl) childUl.classList.remove('active');
                        } else {
                            li.classList.add('empty-folder'); // Style empty folders if needed
                        }
                    } else { // It's a model or exposure node
                        if (node.resource_type === 'exposure') {
                            nodeContent.classList.add('exposure');
                            iconContainer.innerHTML = iconExposure;
                            nodeContent.appendChild(iconContainer);
                            nodeContent.appendChild(span);
                            li.appendChild(nodeContent);
                            
                            // Exposures don't have columns, so clicking them doesn't populate column selector
                            nodeContent.addEventListener('click', () => {
                                document.querySelectorAll('.model-tree .node-content.selected').forEach(el => el.classList.remove('selected'));
                                nodeContent.classList.add('selected');
                                // Don't populate column selector for exposures
                                const columnSelectWrapper = document.getElementById('columnSelectWrapper');
                                const columnSelectValue = document.querySelector('.custom-select-value');
                                const columnSelectOptions = document.getElementById('columnSelectOptions');
                                columnSelect.innerHTML = '<option value="">Exposures don\'t have columns</option>';
                                columnSelectOptions.innerHTML = '<div class="custom-select-option" data-value=""><span class="option-text">Exposures don\'t have columns</span></div>';
                                const resetContent = document.createElement('div');
                                resetContent.className = 'option-content';
                                const resetText = document.createElement('span');
                                resetText.className = 'option-text';
                                resetText.textContent = 'Exposures don\'t have columns';
                                resetContent.appendChild(resetText);
                                columnSelectValue.innerHTML = '';
                                columnSelectValue.appendChild(resetContent);
                                columnSelectWrapper.classList.add('disabled');
                                columnSelect.disabled = true;
                                loadLineageBtn.disabled = true;
                            });
                        } else {
                            nodeContent.classList.add('model');
                            let modelIcon = iconDefault;
                            if (node.resource_type === 'model') modelIcon = iconModel;
                            else if (node.resource_type === 'source') modelIcon = iconSource;
                            else if (node.resource_type === 'seed') modelIcon = iconSeed;
                            
                            iconContainer.innerHTML = modelIcon;
                            nodeContent.appendChild(iconContainer);
                            nodeContent.appendChild(span);

                            li.appendChild(nodeContent);

                            span.dataset.modelName = node.model_name;
                            
                            nodeContent.addEventListener('click', () => {
                                document.querySelectorAll('.model-tree .node-content.selected').forEach(el => el.classList.remove('selected'));
                                nodeContent.classList.add('selected');
                                
                                selectedModelData = node;
                                populateColumnSelector(node.columns);
                                loadLineageBtn.disabled = true;
                            });
                        }
                    }
                    ul.appendChild(li);
                });
                container.appendChild(ul);
            }
            
            function filterTree(searchTerm) {
                const term = searchTerm.toLowerCase().trim();
                const allNodes = modelTreeContainer.querySelectorAll('.tree-node');

                // Reset visibility and expansion
                allNodes.forEach(node => {
                    node.style.display = '';
                    // Collapse all folders initially unless search is empty
                    if (node.classList.contains('tree-node-folder') && term !== '') {
                        node.classList.remove('expanded');
                        const nestedUl = node.querySelector('ul.nested');
                        if (nestedUl) nestedUl.classList.remove('active');
                        const iconContainer = node.querySelector('.icon-container');
                        if(iconContainer) iconContainer.innerHTML = iconFolderClosed;
                    }
                });

                if (term === '') return;

                const modelNodes = modelTreeContainer.querySelectorAll('.tree-node-model, .tree-node-exposure');
                const foldersToShow = new Set();

                modelNodes.forEach(modelLi => {
                    const label = modelLi.querySelector('.node-label');
                    const modelName = label ? label.textContent.toLowerCase() : '';
                    const matches = modelName.includes(term);

                    if (matches) {
                        modelLi.style.display = 'block';
                        let current = modelLi.parentElement;
                        while (current && current !== modelTreeContainer) {
                            if (current.tagName === 'LI' && current.classList.contains('tree-node-folder')) {
                                foldersToShow.add(current);
                            }
                            current = current.parentElement;
                        }
                    } else {
                        modelLi.style.display = 'none';
                    }
                });

                // Show necessary folders and hide others
                const folderNodes = modelTreeContainer.querySelectorAll('.tree-node-folder');
                folderNodes.forEach(folderLi => {
                    if (foldersToShow.has(folderLi)) {
                        folderLi.style.display = 'block';
                        if (!folderLi.classList.contains('expanded')) {
                           folderLi.classList.add('expanded');
                           const nestedUl = folderLi.querySelector('ul.nested');
                           if (nestedUl) nestedUl.classList.add('active');
                           const iconContainer = folderLi.querySelector('.icon-container');
                           if (iconContainer) iconContainer.innerHTML = iconFolderOpen;
                        }
                    } else {
                        folderLi.style.display = 'none';
                    }
                });
            }

            function getTagColor(type) {
                if (!type) return '#cbd5e1';
                const typeStr = type.toLowerCase();
                const defaultColor = '#cbd5e1';
                
                if (typeStr.includes('int') || typeStr.includes('decimal') || 
                    typeStr.includes('numeric') || typeStr.includes('double') || 
                    typeStr.includes('float')) {
                    return '#7cb7fc';
                }
                
                if (typeStr.includes('varchar') || typeStr.includes('char') || 
                    typeStr.includes('text') || typeStr.includes('string')) {
                    return '#4ddba4';
                }
                
                if (typeStr.includes('date') || typeStr.includes('time')) {
                    return '#b29dfc';
                }
                
                if (typeStr.includes('bool')) {
                    return '#f98b8b';
                }
                
                if (typeStr.includes('variant')) {
                    return '#fca154';
                }
                
                return defaultColor;
            }

            function getShortType(type) {
                if (!type) return 'unknown';
                return type.toLowerCase()
                    .replace('character varying', 'varchar')
                    .replace('double precision', 'double')
                    .replace('timestamp without time zone', 'timestamp')
                    .replace('timestamp with time zone', 'timestamptz');
            }

            function populateColumnSelector(columns) {
                const columnSelectWrapper = document.getElementById('columnSelectWrapper');
                const columnSelectTrigger = document.getElementById('columnSelectTrigger');
                const columnSelectOptions = document.getElementById('columnSelectOptions');
                const columnSelectValue = columnSelectTrigger.querySelector('.custom-select-value');
                
                // Update hidden select for form compatibility
                columnSelect.innerHTML = '<option value="">Select a column</option>';
                
                // Update custom dropdown
                columnSelectOptions.innerHTML = '<div class="custom-select-option" data-value=""><span class="option-text">Select a column</span></div>';
                
                columns.forEach(column => {
                    // Add to hidden select
                    const option = document.createElement('option');
                    option.value = column.name;
                    option.textContent = `${column.name} (${column.type || 'unknown'})`;
                    columnSelect.appendChild(option);
                    
                    // Add to custom dropdown with styled type tag
                    const customOption = document.createElement('div');
                    customOption.className = 'custom-select-option';
                    customOption.dataset.value = column.name;
                    
                    const optionContent = document.createElement('div');
                    optionContent.className = 'option-content';
                    
                    const optionText = document.createElement('span');
                    optionText.className = 'option-text';
                    optionText.textContent = column.name;
                    
                    const typeTag = document.createElement('span');
                    typeTag.className = 'option-type-tag';
                    const shortType = getShortType(column.type);
                    typeTag.textContent = shortType;
                    typeTag.style.backgroundColor = getTagColor(column.type);
                    
                    optionContent.appendChild(optionText);
                    optionContent.appendChild(typeTag);
                    customOption.appendChild(optionContent);
                    columnSelectOptions.appendChild(customOption);
                });
                
                // Reset display
                const resetContent = document.createElement('div');
                resetContent.className = 'option-content';
                const resetText = document.createElement('span');
                resetText.className = 'option-text';
                resetText.textContent = 'Select a column';
                resetContent.appendChild(resetText);
                columnSelectValue.innerHTML = '';
                columnSelectValue.appendChild(resetContent);
                columnSelectWrapper.classList.remove('disabled');
                columnSelect.disabled = false;
            }

            fetch('/api/models')
                .then(response => response.json())
                .then(treeData => {
                    modelTreeContainer.innerHTML = '';
                    allTreeData = treeData;
                    if (treeData && treeData.length > 0) {
                        renderTree(treeData, modelTreeContainer);
                    } else {
                        modelTreeContainer.innerHTML = '<p>No models found.</p>';
                    }
                })
                .catch(error => {
                    console.error("Error fetching model tree:", error);
                    modelTreeContainer.innerHTML = '<p>Error loading models.</p>';
                });
                
            // Custom dropdown functionality
            const columnSelectWrapper = document.getElementById('columnSelectWrapper');
            const columnSelectTrigger = document.getElementById('columnSelectTrigger');
            const columnSelectOptions = document.getElementById('columnSelectOptions');
            const columnSelectValue = columnSelectTrigger.querySelector('.custom-select-value');
            
            // Toggle dropdown
            columnSelectTrigger.addEventListener('click', function(e) {
                if (columnSelectWrapper.classList.contains('disabled')) return;
                e.stopPropagation();
                columnSelectWrapper.classList.toggle('open');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!columnSelectWrapper.contains(e.target)) {
                    columnSelectWrapper.classList.remove('open');
                }
            });
            
            // Handle option selection
            columnSelectOptions.addEventListener('click', function(e) {
                const option = e.target.closest('.custom-select-option');
                if (!option) return;
                
                const value = option.dataset.value;
                const optionContent = option.querySelector('.option-content');
                
                // Update custom dropdown - clone the option content
                columnSelectValue.innerHTML = '';
                if (optionContent) {
                    columnSelectValue.appendChild(optionContent.cloneNode(true));
                } else {
                    const text = option.textContent;
                    columnSelectValue.textContent = text;
                }
                columnSelectOptions.querySelectorAll('.custom-select-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                option.classList.add('selected');
                columnSelectWrapper.classList.remove('open');
                
                // Update hidden select
                columnSelect.value = value;
                columnSelect.dispatchEvent(new Event('change'));
            });
            
            // Sync with hidden select for compatibility
            columnSelect.addEventListener('change', function() {
                const hasSelection = this.value && selectedModelData;
                loadLineageBtn.disabled = !hasSelection;
            });
            
            loadLineageBtn.addEventListener('click', function() {
                const column = columnSelect.value;
                if (selectedModelData && selectedModelData.model_name && column) { 
                    fetch(`/api/lineage/${selectedModelData.model_name}/${column}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                console.error(data.error);
                                graphContainer.innerHTML = `<p class="error-message">Error loading lineage: ${data.error}</p>`;
                                document.getElementById('impactAnalysisCard').style.display = 'none';
                                return;
                            }
                            
                            graphInstance = initGraph(data);
                            
                            // Show impact analysis card after lineage is loaded
                            const impactCard = document.getElementById('impactAnalysisCard');
                            if (impactCard) {
                                impactCard.style.display = 'block';
                            }
                        })
                        .catch(error => { 
                            console.error("Fetch error:", error);
                            graphContainer.innerHTML = `<p class="error-message">Failed to fetch lineage data.</p>`;
                            document.getElementById('impactAnalysisCard').style.display = 'none';
                         });
                }
            });

            // Impact Analysis functionality
            const impactPanel = document.getElementById('impactAnalysisPanel');
            const impactContent = document.getElementById('impactAnalysisContent');
            const closeImpactPanel = document.getElementById('closeImpactPanel');

            // Use event delegation for the impact analysis button (since it gets cloned)
            graphContainer.addEventListener('click', function(e) {
                // Find the button element (handle clicks on button or its children)
                let loadImpactBtn = e.target;
                if (e.target.id !== 'loadImpactAnalysisFromCard') {
                    loadImpactBtn = e.target.closest('button#loadImpactAnalysisFromCard');
                }
                if (loadImpactBtn && loadImpactBtn.id === 'loadImpactAnalysisFromCard') {
                    const column = columnSelect.value;
                    if (selectedModelData && selectedModelData.model_name && column) {
                        loadImpactBtn.disabled = true;
                        loadImpactBtn.textContent = 'Loading...';
                        
                        fetch(`/api/impact-analysis/${selectedModelData.model_name}/${column}`)
                        .then(response => {
                            if (!response.ok) {
                                return response.json().then(data => {
                                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                                }).catch(() => {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                });
                            }
                            return response.json();
                        })
                        .then(data => {
                            loadImpactBtn.disabled = false;
                            loadImpactBtn.textContent = 'Analyze Impact';
                            
                            if (data.error) {
                                impactContent.innerHTML = `<p class="error-message">Error: ${data.error}</p>`;
                                impactPanel.style.display = 'block';
                                return;
                            }
                            
                            displayImpactAnalysis(data, selectedModelData.model_name, column);
                            impactPanel.style.display = 'block';
                            
                            // Hide the card when analysis is shown
                            const impactCard = document.getElementById('impactAnalysisCard');
                            if (impactCard) {
                                impactCard.style.display = 'none';
                            }
                        })
                        .catch(error => {
                            loadImpactBtn.disabled = false;
                            loadImpactBtn.textContent = 'Analyze Impact';
                            console.error("Fetch error:", error);
                            impactContent.innerHTML = `<p class="error-message">Failed to fetch impact analysis: ${error.message}</p>`;
                            impactPanel.style.display = 'block';
                        });
                    }
                }
            });

            closeImpactPanel.addEventListener('click', function() {
                impactPanel.style.display = 'none';
            });

            // Resize functionality for impact panel
            const resizeHandle = document.getElementById('impactPanelResizeHandle');
            if (resizeHandle) {
                let isResizing = false;
                let startX = 0;
                let startWidth = 0;

                resizeHandle.addEventListener('mousedown', function(e) {
                    isResizing = true;
                    startX = e.clientX;
                    startWidth = parseInt(document.defaultView.getComputedStyle(impactPanel).width, 10);
                    document.addEventListener('mousemove', handleResize);
                    document.addEventListener('mouseup', stopResize);
                    e.preventDefault();
                });

                function handleResize(e) {
                    if (!isResizing) return;
                    const width = startWidth - (e.clientX - startX);
                    const minWidth = 400;
                    const maxWidth = window.innerWidth * 0.9;
                    const newWidth = Math.min(Math.max(width, minWidth), maxWidth);
                    impactPanel.style.width = newWidth + 'px';
                }

                function stopResize() {
                    isResizing = false;
                    document.removeEventListener('mousemove', handleResize);
                    document.removeEventListener('mouseup', stopResize);
                }
            }

            function displayImpactAnalysis(data, modelName, columnName) {
                const summary = data.summary || {};
                const affectedModels = data.affected_models || [];
                const affectedColumns = data.affected_columns || [];
                const affectedExposures = data.affected_exposures || [];
                
                // Separate critical and low-impact columns
                const criticalColumns = affectedColumns.filter(col => col.severity === 'critical');
                const lowImpactColumns = affectedColumns.filter(col => col.severity === 'low_impact');

                let html = `
                    <div class="impact-intro">
                        <div class="impact-intro-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"></path>
                                <circle cx="12" cy="12" r="5"></circle>
                            </svg>
                        </div>
                        <div class="impact-intro-text">
                            <strong>Understanding the impact:</strong> This analysis shows what will be affected if you modify the logic of <code>${modelName}.${columnName}</code>. 
                            Review the transformed columns below as they may need updates when the source column changes.
                        </div>
                    </div>
                    <div class="impact-hero">
                        <div class="impact-hero-header">
                            <div class="impact-hero-content">
                                <h2 class="impact-hero-title">Impact Summary</h2>
                                <p class="impact-hero-subtitle">Column: <code>${modelName}.${columnName}</code></p>
                            </div>
                        </div>
                        <div class="impact-hero-metrics">
                            <div class="hero-metric ${criticalColumns.length > 0 ? 'hero-metric-critical' : ''}">
                                <div class="hero-metric-icon">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                        <line x1="12" y1="9" x2="12" y2="13"></line>
                                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                    </svg>
                                </div>
                                <div class="hero-metric-content">
                                    <div class="hero-metric-value">${criticalColumns.length}</div>
                                    <div class="hero-metric-label">Requires Review</div>
                                    <div class="hero-metric-desc">Transformations may break</div>
                                </div>
                            </div>
                            <div class="hero-metric hero-metric-pass-through">
                                <div class="hero-metric-icon">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                </div>
                                <div class="hero-metric-content">
                                    <div class="hero-metric-value">${lowImpactColumns.length}</div>
                                    <div class="hero-metric-label">Pass-through</div>
                                    <div class="hero-metric-desc">Direct references</div>
                                </div>
                            </div>
                            <div class="hero-metric hero-metric-models">
                                <div class="hero-metric-icon">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="18" y1="20" x2="18" y2="10"></line>
                                        <line x1="12" y1="20" x2="12" y2="4"></line>
                                        <line x1="6" y1="20" x2="6" y2="14"></line>
                                    </svg>
                                </div>
                                <div class="hero-metric-content">
                                    <div class="hero-metric-value">${summary.affected_models || 0}</div>
                                    <div class="hero-metric-label">Models Affected</div>
                                </div>
                            </div>
                            <div class="hero-metric hero-metric-exposures">
                                <div class="hero-metric-icon">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                                        <polyline points="17 6 23 6 23 12"></polyline>
                                    </svg>
                                </div>
                                <div class="hero-metric-content">
                                    <div class="hero-metric-value">${summary.affected_exposures || 0}</div>
                                    <div class="hero-metric-label">Exposures</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // CRITICAL IMPACT - Show first (most important)
                if (criticalColumns.length > 0) {
                    html += `
                        <div class="impact-section critical-section">
                            <div class="section-header critical-header">
                                <div class="section-header-left">
                                    <span class="section-icon-badge critical-badge">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                            <line x1="12" y1="9" x2="12" y2="13"></line>
                                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                        </svg>
                                    </span>
                                    <div>
                                        <h3 class="section-title">Requires Review</h3>
                                        <p class="section-description">${criticalColumns.length} column${criticalColumns.length !== 1 ? 's' : ''} with transformations that may break</p>
                                    </div>
                                </div>
                            </div>
                            <div class="columns-list">
                    `;
                    
                    criticalColumns.forEach(col => {
                        const colModelName = col.model || 'unknown';
                        const colColumnName = col.column || 'unknown';
                        const transformationType = col.transformation_type || 'unknown';
                        const modelInfo = affectedModels.find(m => m.name === colModelName);
                        
                        html += `
                            <div class="column-card critical-card">
                                <div class="column-card-header">
                                    <div class="column-card-title">
                                        <span class="column-model">${colModelName}</span>
                                        <span class="column-separator">.</span>
                                        <span class="column-name-bold">${colColumnName}</span>
                                    </div>
                                    <span class="transformation-badge critical-transformation">${transformationType}</span>
                                </div>
                                ${col.sql_expression ? `
                                    <div class="column-card-body">
                                        <div class="sql-expression-card">
                                            <div class="sql-expression-label">Transformation Logic</div>
                                            <code class="sql-expression-code">${escapeHtml(col.sql_expression)}</code>
                                        </div>
                                    </div>
                                ` : ''}
                                ${modelInfo && modelInfo.schema_name ? `
                                    <div class="column-card-footer">
                                        <span class="schema-info">${modelInfo.database || ''}.${modelInfo.schema_name}</span>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    
                    html += `</div></div>`;
                }

                // AFFECTED EXPOSURES - Show before models
                if (affectedExposures.length > 0) {
                    html += `
                        <div class="impact-section exposure-section">
                            <div class="section-header exposure-header">
                                <div class="section-header-left">
                                    <span class="section-icon-badge exposure-badge">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                                            <polyline points="17 6 23 6 23 12"></polyline>
                                        </svg>
                                    </span>
                                    <div>
                                        <h3 class="section-title">Affected Exposures</h3>
                                        <p class="section-description">${affectedExposures.length} dashboard${affectedExposures.length !== 1 ? 's' : ''} or report${affectedExposures.length !== 1 ? 's' : ''} may be impacted</p>
                                    </div>
                                </div>
                            </div>
                            <div class="exposures-grid">
                    `;
                    
                    affectedExposures.forEach(exposure => {
                        const exposureName = exposure.name || 'Unknown';
                        const exposureType = exposure.type || 'unknown';
                        const dependsOnModels = exposure.depends_on_models || [];
                        html += `
                            <div class="exposure-card">
                                <div class="exposure-card-header">
                                    <div class="exposure-card-title-group">
                                        <span class="exposure-card-name">${exposureName}</span>
                                        <span class="exposure-card-type">${exposureType}</span>
                                    </div>
                                </div>
                                ${exposure.description ? `
                                    <div class="exposure-card-body">
                                        <p class="exposure-description">${escapeHtml(exposure.description)}</p>
                                    </div>
                                ` : ''}
                                <div class="exposure-card-footer">
                                    ${exposure.url ? `
                                        <a href="${exposure.url}" target="_blank" class="exposure-link">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                                <polyline points="15 3 21 3 21 9"></polyline>
                                                <line x1="10" y1="14" x2="21" y2="3"></line>
                                            </svg>
                                            View Dashboard
                                        </a>
                                    ` : ''}
                                    ${dependsOnModels.length > 0 ? `
                                        <div class="exposure-models">
                                            Uses: ${dependsOnModels.slice(0, 2).join(', ')}${dependsOnModels.length > 2 ? ` +${dependsOnModels.length - 2} more` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div></div>`;
                }

                // AFFECTED MODELS - Group by models that contain critical columns
                if (affectedModels.length > 0) {
                    const modelsWithCritical = new Set(criticalColumns.map(col => col.model));
                    
                    html += `
                        <div class="impact-section">
                            <div class="section-header">
                                <div class="section-header-left">
                                    <span class="section-icon-badge">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <line x1="18" y1="20" x2="18" y2="10"></line>
                                            <line x1="12" y1="20" x2="12" y2="4"></line>
                                            <line x1="6" y1="20" x2="6" y2="14"></line>
                                        </svg>
                                    </span>
                                    <div>
                                        <h3 class="section-title">Affected Models</h3>
                                        <p class="section-description">${affectedModels.length} model${affectedModels.length !== 1 ? 's' : ''} in the dependency chain</p>
                                    </div>
                                </div>
                            </div>
                            <div class="model-grid">
                    `;
                    
                    affectedModels.forEach(model => {
                        const modelName = model.name || '';
                        const schemaName = model.schema_name || '';
                        const hasCritical = modelsWithCritical.has(modelName);
                        const isMart = model.resource_type === 'model' && (modelName.includes('mart') || schemaName.includes('mart'));
                        const columnsInModel = affectedColumns.filter(col => col.model === modelName);
                        const criticalInModel = columnsInModel.filter(col => col.severity === 'critical').length;
                        
                        html += `
                            <div class="model-card ${hasCritical ? 'model-card-critical' : ''} ${isMart ? 'model-card-mart' : ''}">
                                <div class="model-card-header">
                                    <div class="model-card-title-group">
                                        <span class="model-card-name">${modelName}</span>
                                        <span class="model-card-type">${model.resource_type || 'model'}</span>
                                    </div>
                                    ${criticalInModel > 0 ? `
                                        <span class="model-critical-badge">${criticalInModel} critical</span>
                                    ` : ''}
                                </div>
                                <div class="model-card-body">
                                    <div class="model-card-info">
                                        <span class="model-schema">${model.database || ''}.${schemaName}</span>
                                        <span class="model-columns-count">${columnsInModel.length} column${columnsInModel.length !== 1 ? 's' : ''} affected</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div></div>`;
                }

                // LOW IMPACT COLUMNS - Collapsible section
                if (lowImpactColumns.length > 0) {
                    html += `
                        <div class="impact-section low-impact-section">
                            <div class="section-header low-impact-header">
                                <div class="section-header-left">
                                    <span class="section-icon-badge low-impact-badge">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                    </span>
                                    <div>
                                        <h3 class="section-title">Pass-through Columns</h3>
                                        <p class="section-description">${lowImpactColumns.length} direct reference${lowImpactColumns.length !== 1 ? 's' : ''} - changes propagate automatically</p>
                                    </div>
                                </div>
                                <button class="toggle-section-btn" onclick="this.closest('.impact-section').querySelector('.columns-list').classList.toggle('collapsed'); this.textContent = this.closest('.impact-section').querySelector('.columns-list').classList.contains('collapsed') ? 'Show' : 'Hide'">
                                    Hide
                                </button>
                            </div>
                            <div class="columns-list">
                    `;
                    
                    lowImpactColumns.forEach(col => {
                        const colModelName = col.model || 'unknown';
                        const colColumnName = col.column || 'unknown';
                        const transformationType = col.transformation_type || 'unknown';
                        
                        html += `
                            <div class="column-card low-impact-card">
                                <div class="column-card-header">
                                    <div class="column-card-title">
                                        <span class="column-model">${colModelName}</span>
                                        <span class="column-separator">.</span>
                                        <span class="column-name-bold">${colColumnName}</span>
                                    </div>
                                    <span class="transformation-badge low-impact-transformation">${transformationType}</span>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div></div>`;
                }

                impactContent.innerHTML = html;
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Add event listener for the search input
            searchInput.addEventListener('input', (e) => {
                filterTree(e.target.value);
            });
            {% endif %}
        });
    </script>
</body>
</html>