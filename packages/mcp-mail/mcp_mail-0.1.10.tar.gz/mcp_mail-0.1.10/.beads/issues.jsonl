{"id":"MCP-fq5","content_hash":"5c31335d231e5c83beeae07b70e4120c5a1d8cee207a5df85c33421984def7f2","title":"CRITICAL: Database session bug in _ensure_project() blocks agent registration","description":"Location: app.py:674-702 in _ensure_project()\n\nSymptom: InvalidRequestError: Could not refresh instance\n\nRoot Cause: _ensure_project() opens a database session and calls _ensure_global_inbox_agent(project) which opens a NESTED session. The project object becomes detached from the inner session causing SQLAlchemy errors.\n\nImpact: PRODUCTION BLOCKING - Prevents agent registration in multi-agent scenarios\n\nIntroduced: Commit 8ec673f (2025-11-09) 'Add global inbox with TTL auto-deletion'\n\nEvidence: Test 3 Agent 2 failure in /tmp/real_claude_multiagent_20251118_193652/outputs/agent2_output.txt\n\nFix Required:\n1. Pass session to _ensure_global_inbox_agent() OR\n2. Accept project_id instead of project object to avoid detached instance\n\nPriority: URGENT - Blocks Test 3 completion and production use","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-18T20:20:22.634052-08:00","updated_at":"2025-11-18T20:20:22.634052-08:00","source_repo":".","labels":["bug","critical","production-blocking"]}
