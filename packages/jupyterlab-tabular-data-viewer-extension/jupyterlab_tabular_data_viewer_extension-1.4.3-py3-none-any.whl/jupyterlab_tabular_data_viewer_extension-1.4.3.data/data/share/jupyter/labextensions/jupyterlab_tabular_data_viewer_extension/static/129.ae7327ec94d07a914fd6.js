"use strict";(self.webpackChunkjupyterlab_tabular_data_viewer_extension=self.webpackChunkjupyterlab_tabular_data_viewer_extension||[]).push([[129],{129:(e,t,a)=>{a.r(t),a.d(t,{default:()=>b});var s=a(5),i=a(816),n=a(247),l=a(603),o=a(596);async function r(e="",t={}){const a=o.ServerConnection.makeSettings(),s=l.URLExt.join(a.baseUrl,"jupyterlab-tabular-data-viewer-extension",e);let i;try{i=await o.ServerConnection.makeRequest(s,t,a)}catch(e){throw new o.ServerConnection.NetworkError(e)}let n=await i.text();if(n.length>0)try{n=JSON.parse(n)}catch(e){console.log("Not a JSON response body.",i)}if(!i.ok)throw new o.ServerConnection.ResponseError(i,n.message||n);return n}async function c(e,t,a=100){return r("unique-values",{method:"POST",body:JSON.stringify({path:e,columnName:t,limit:a})})}class d extends n.Widget{constructor(e,t=null){super(),this._stats=e,this._uniqueValues=t,this.addClass("jp-ColumnStatsModal"),this._render(),this._setupEventListeners()}_render(){const e=document.createElement("div");e.className="jp-ColumnStatsModal-content";const t=document.createElement("div");t.className="jp-ColumnStatsModal-header";const a=document.createElement("h3");a.textContent=`Column: ${this._stats.column_name}`;const s=document.createElement("button");s.className="jp-ColumnStatsModal-close",s.textContent="×",s.onclick=()=>this.close(),t.appendChild(a),t.appendChild(s),e.appendChild(t);const i=document.createElement("div");i.className="jp-ColumnStatsModal-copy";const n=document.createElement("button");n.className="jp-FilterModal-button",n.textContent="Copy Stats as JSON",n.onclick=()=>this._copyStatsAsJson(),i.appendChild(n),e.appendChild(i);const l=document.createElement("div");l.className="jp-ColumnStatsModal-type",l.textContent=`Type: ${this._stats.data_type}`,e.appendChild(l);const o=document.createElement("div");o.className="jp-ColumnStatsModal-section";const r=document.createElement("h4");r.textContent="Data Summary",o.appendChild(r);const c=document.createElement("ul");if(c.innerHTML=`\n      <li>Total rows: ${this._formatNumber(this._stats.total_rows)}</li>\n      <li>Non-null: ${this._formatNumber(this._stats.non_null_count)} (${this._stats.non_null_percentage}%)</li>\n      <li>Null: ${this._formatNumber(this._stats.null_count)} (${this._stats.null_percentage}%)</li>\n      <li>Unique values: ${this._formatNumber(this._stats.unique_count)} (${this._stats.unique_percentage}%)</li>\n    `,o.appendChild(c),e.appendChild(o),"int"===this._stats.data_type||"float"===this._stats.data_type){const t=document.createElement("div");t.className="jp-ColumnStatsModal-section";const a=document.createElement("h4");a.textContent="Numeric Statistics",t.appendChild(a);const s=document.createElement("ul"),i=[];void 0!==this._stats.min_value&&i.push(`Min: ${this._formatNumber(this._stats.min_value)}`),void 0!==this._stats.max_value&&i.push(`Max: ${this._formatNumber(this._stats.max_value)}`),void 0!==this._stats.mean&&i.push(`Mean: ${this._formatNumber(this._stats.mean)}`),void 0!==this._stats.median&&i.push(`Median: ${this._formatNumber(this._stats.median)}`),void 0!==this._stats.std_dev&&i.push(`Std Dev: ${this._formatNumber(this._stats.std_dev)}`),void 0!==this._stats.outlier_count&&i.push(`Outliers: ${this._formatNumber(this._stats.outlier_count)} (${this._stats.outlier_percentage}%)`),s.innerHTML=i.map(e=>`<li>${e}</li>`).join(""),t.appendChild(s),e.appendChild(t)}if("string"===this._stats.data_type){const t=[];if(void 0!==this._stats.most_common_value&&t.push(`Most common: "${this._stats.most_common_value}" (${this._stats.most_common_count})`),void 0!==this._stats.min_length&&t.push(`Min length: ${this._stats.min_length} characters`),void 0!==this._stats.max_length&&t.push(`Max length: ${this._stats.max_length} characters`),void 0!==this._stats.avg_length&&t.push(`Avg length: ${this._formatNumber(this._stats.avg_length)} characters`),t.length>0){const a=document.createElement("div");a.className="jp-ColumnStatsModal-section";const s=document.createElement("h4");s.textContent="String Statistics",a.appendChild(s);const i=document.createElement("ul");i.innerHTML=t.map(e=>`<li>${e}</li>`).join(""),a.appendChild(i),e.appendChild(a)}}if("date"===this._stats.data_type||"datetime"===this._stats.data_type){const t=document.createElement("div");t.className="jp-ColumnStatsModal-section";const a=document.createElement("h4");a.textContent="Date Range",t.appendChild(a);const s=document.createElement("ul"),i=[];this._stats.earliest_date&&i.push(`Earliest: ${this._stats.earliest_date}`),this._stats.latest_date&&i.push(`Latest: ${this._stats.latest_date}`),void 0!==this._stats.date_range_days&&i.push(`Span: ${this._formatNumber(this._stats.date_range_days)} days`),s.innerHTML=i.map(e=>`<li>${e}</li>`).join(""),t.appendChild(s),e.appendChild(t)}if(this._uniqueValues&&this._uniqueValues.values.length>0){const t=document.createElement("div");t.className="jp-ColumnStatsModal-section";const a=document.createElement("h4");a.textContent="Unique Values",t.appendChild(a);const s=this._uniqueValues.values.length,i=this._stats.unique_count;if(s<i){const e=document.createElement("div");e.className="jp-ColumnStatsModal-info",e.textContent=`Showing ${s} of ${i} unique values`,t.appendChild(e)}const n=document.createElement("ul");n.className="jp-ColumnStatsModal-uniqueValuesList",this._uniqueValues.values.forEach((e,t)=>{const a=this._uniqueValues.counts[t],s=(a/this._stats.total_rows*100).toFixed(2),i=document.createElement("li");i.className="jp-ColumnStatsModal-uniqueValueItem";const l=e||"(empty)",o=`${a.toLocaleString()} (${s}%)`;i.textContent=`${l}: ${o}`,n.appendChild(i)}),t.appendChild(n),e.appendChild(t)}this.node.appendChild(e)}_formatNumber(e){return e.toLocaleString(void 0,{maximumFractionDigits:2})}async _copyStatsAsJson(){try{const e=JSON.stringify(this._stats,null,2);await navigator.clipboard.writeText(e);const t=this.node.querySelector(".jp-FilterModal-button");if(t){const e=t.textContent;t.textContent="Copied!",setTimeout(()=>{t.textContent=e},2e3)}}catch(e){console.error("Failed to copy stats to clipboard:",e)}}_setupEventListeners(){const e=e=>{"Escape"===e.key&&this.close()};document.addEventListener("keydown",e),this.disposed.connect(()=>{document.removeEventListener("keydown",e)}),this.node.addEventListener("click",e=>{e.target===this.node&&this.close()})}show(){n.Widget.attach(this,document.body),this.node.focus()}close(){this.dispose()}}class h extends n.Widget{constructor(e,t,a,s){super(),this._columnName=e,this._uniqueValues=t,this._selectedValues=new Set(a),this._onApply=s,this.addClass("jp-FilterModal"),this._render(),this._setupEventListeners()}_render(){const e=document.createElement("div");e.className="jp-FilterModal-content";const t=document.createElement("div");t.className="jp-FilterModal-header";const a=document.createElement("h3");a.textContent=`Filter: ${this._columnName}`;const s=document.createElement("button");s.className="jp-FilterModal-close",s.textContent="×",s.onclick=()=>this.close(),t.appendChild(a),t.appendChild(s),e.appendChild(t);const i=document.createElement("div");i.className="jp-FilterModal-actionButtons";const n=document.createElement("button");n.className="jp-FilterModal-button",n.textContent="Select All",n.onclick=()=>this._selectAll();const l=document.createElement("button");l.className="jp-FilterModal-button",l.textContent="Clear",l.onclick=()=>this._clearAll(),i.appendChild(n),i.appendChild(l),e.appendChild(i);const o=document.createElement("div");o.className="jp-FilterModal-valuesContainer";const r=document.createElement("div");r.className="jp-FilterModal-info",r.textContent=`${this._uniqueValues.values.length} unique values (showing max ${this._uniqueValues.limit})`,o.appendChild(r);const c=document.createElement("div");c.className="jp-FilterModal-valuesList",this._uniqueValues.values.forEach((e,t)=>{const a=document.createElement("label");a.className="jp-FilterModal-valueItem";const s=document.createElement("input");s.type="checkbox",s.className="jp-FilterModal-checkbox",s.dataset.value=e,s.checked=this._selectedValues.has(e),s.onchange=()=>this._toggleValue(e,s.checked);const i=document.createElement("div");i.className="jp-FilterModal-valueLabelContainer";const n=document.createElement("span");n.textContent=e||"(empty)",n.className="jp-FilterModal-valueLabel";const l=document.createElement("span");l.textContent=`(${this._uniqueValues.counts[t].toLocaleString()})`,l.className="jp-FilterModal-valueCount",i.appendChild(n),i.appendChild(l),a.appendChild(s),a.appendChild(i),c.appendChild(a)}),o.appendChild(c),e.appendChild(o);const d=document.createElement("div");d.className="jp-FilterModal-bottomButtons";const h=document.createElement("button");h.className="jp-FilterModal-okButton",h.textContent="OK",h.onclick=()=>this._apply();const u=document.createElement("button");u.className="jp-FilterModal-cancelButton",u.textContent="Cancel",u.onclick=()=>this.close(),d.appendChild(u),d.appendChild(h),e.appendChild(d),this.node.appendChild(e)}_selectAll(){this._uniqueValues.values.forEach(e=>this._selectedValues.add(e)),this._updateCheckboxes()}_clearAll(){this._selectedValues.clear(),this._updateCheckboxes()}_toggleValue(e,t){t?this._selectedValues.add(e):this._selectedValues.delete(e)}_updateCheckboxes(){this.node.querySelectorAll(".jp-FilterModal-checkbox").forEach(e=>{const t=e.dataset.value||"";e.checked=this._selectedValues.has(t)})}_apply(){const e=Array.from(this._selectedValues);this._onApply(e.length>0?e:null),this.close()}_setupEventListeners(){const e=e=>{"Escape"===e.key&&this.close()};document.addEventListener("keydown",e),this.disposed.connect(()=>{document.removeEventListener("keydown",e)}),this.node.addEventListener("click",e=>{e.target===this.node&&this.close()})}show(){n.Widget.attach(this,document.body),this.node.focus()}close(){this.dispose()}}class u extends n.Widget{constructor(e,t,a=100,s=100){super(),this._columns=[],this._data=[],this._totalRows=0,this._unfilteredTotalRows=0,this._currentOffset=0,this._limit=500,this._loading=!1,this._hasMore=!0,this._filters={},this._sortBy=null,this._sortOrder="asc",this._fileSize=0,this._caseInsensitive=!1,this._useRegex=!1,this._contextMenuOpen=!1,this._columnWidths=new Map,this._resizing=null,this._cleanupHighlight=null,this._menuObserver=null,this._maxCellCharacters=100,this._maxUniqueValues=100,this._selectedRow=null,this._doResize=e=>{if(!this._resizing)return;const t=e.clientX-this._resizing.startX,a=Math.max(80,this._resizing.startWidth+t);this._columnWidths.set(this._resizing.columnName,a);const s=this._columns.findIndex(e=>e.name===this._resizing.columnName);if(-1!==s){const e=this._headerRow.children[s+1],t=this._filterRow.children[s+1];e&&(e.style.width=`${a}px`),t&&(t.style.width=`${a}px`);const i=Array.from(this._columnWidths.values()).reduce((e,t)=>e+t,0)+60;this._table.style.width=`${i}px`}},this._stopResize=()=>{this._resizing&&(this._resizing=null,document.removeEventListener("mousemove",this._doResize),document.removeEventListener("mouseup",this._stopResize),document.body.style.userSelect="",document.body.style.cursor="")},this._filePath=e,this._setLastContextMenuRow=t,this._maxCellCharacters=a,this._maxUniqueValues=s,this.addClass("jp-TabularDataViewer"),this._tableContainer=document.createElement("div"),this._tableContainer.className="jp-TabularDataViewer-container",this._table=document.createElement("table"),this._table.className="jp-TabularDataViewer-table",this._thead=document.createElement("thead"),this._thead.className="jp-TabularDataViewer-thead",this._tbody=document.createElement("tbody"),this._tbody.className="jp-TabularDataViewer-tbody",this._filterRow=document.createElement("tr"),this._filterRow.className="jp-TabularDataViewer-filterRow",this._headerRow=document.createElement("tr"),this._headerRow.className="jp-TabularDataViewer-headerRow",this._thead.appendChild(this._filterRow),this._thead.appendChild(this._headerRow),this._table.appendChild(this._thead),this._table.appendChild(this._tbody),this._tableContainer.appendChild(this._table),this._statusBar=document.createElement("div"),this._statusBar.className="jp-TabularDataViewer-statusBar",this._statusLeft=document.createElement("div"),this._statusLeft.className="jp-TabularDataViewer-statusLeft";const i=document.createElement("div");i.className="jp-TabularDataViewer-statusMiddle";const n=document.createElement("label");n.className="jp-TabularDataViewer-caseInsensitiveLabel",this._caseInsensitiveCheckbox=document.createElement("input"),this._caseInsensitiveCheckbox.type="checkbox",this._caseInsensitiveCheckbox.className="jp-TabularDataViewer-caseInsensitiveCheckbox",this._caseInsensitiveCheckbox.checked=this._caseInsensitive,this._caseInsensitiveCheckbox.addEventListener("change",()=>{this._caseInsensitive=this._caseInsensitiveCheckbox.checked,this._loadData(!0)});const l=document.createElement("span");l.textContent=" Case insensitive",n.appendChild(this._caseInsensitiveCheckbox),n.appendChild(l),i.appendChild(n);const o=document.createElement("label");o.className="jp-TabularDataViewer-regexLabel",this._regexCheckbox=document.createElement("input"),this._regexCheckbox.type="checkbox",this._regexCheckbox.className="jp-TabularDataViewer-regexCheckbox",this._regexCheckbox.checked=this._useRegex,this._regexCheckbox.addEventListener("change",()=>{this._useRegex=this._regexCheckbox.checked,this._loadData(!0)});const r=document.createElement("span");r.textContent=" Use regex",o.appendChild(this._regexCheckbox),o.appendChild(r),i.appendChild(o),this._statusRight=document.createElement("div"),this._statusRight.className="jp-TabularDataViewer-statusRight",this._statusBar.appendChild(this._statusLeft),this._statusBar.appendChild(i),this._statusBar.appendChild(this._statusRight),this.node.appendChild(this._tableContainer),this.node.appendChild(this._statusBar),this._tableContainer.addEventListener("scroll",()=>{this._onScroll()}),this._cleanupHighlight=()=>{this._contextMenuOpen=!1,this._tbody.classList.remove("jp-TabularDataViewer-context-menu-open"),this._tbody.querySelectorAll("tr").forEach(e=>{e.classList.remove("jp-TabularDataViewer-row-context-active")}),this._menuObserver&&(this._menuObserver.disconnect(),this._menuObserver=null)},this._initialize()}_startMenuObserver(){this._menuObserver&&this._menuObserver.disconnect(),this._menuObserver=new MutationObserver(e=>{for(const t of e)if("childList"===t.type&&t.removedNodes.length>0)for(const e of Array.from(t.removedNodes))if(e instanceof HTMLElement&&(e.classList.contains("lm-Menu")||e.classList.contains("p-Menu")))return void(this._cleanupHighlight&&this._cleanupHighlight())}),this._menuObserver.observe(document.body,{childList:!0,subtree:!1})}getCleanupHighlight(){return this._cleanupHighlight||(()=>{})}async refresh(){const e=this._tableContainer.scrollTop,t=this._tableContainer.scrollLeft;try{await this._loadMetadata(),await this._loadData(!0),setTimeout(()=>{this._tableContainer.scrollTop=e,this._tableContainer.scrollLeft=t},100),console.log(`Refreshed tabular data view: ${this._filePath}`)}catch(e){this._showError(`Failed to refresh data: ${e}`)}}async _initialize(){try{await this._loadMetadata(),await this._loadData(!0)}catch(e){this._showError(`Failed to load file: ${e}`)}}async _loadMetadata(){const e=await r("metadata",{method:"POST",body:JSON.stringify({path:this._filePath})});this._columns=e.columns,this._totalRows=e.totalRows,this._unfilteredTotalRows=e.totalRows,this._fileSize=e.fileSize||0,this._renderHeaders(),this._updateStatusBar()}async _loadData(e=!1){if(!this._loading){this._loading=!0,this._updateStatusBar("Loading...");try{e&&(this._currentOffset=0,this._data=[],this._tbody.innerHTML="",this._selectedRow=null);const t=await r("data",{method:"POST",body:JSON.stringify({path:this._filePath,offset:this._currentOffset,limit:this._limit,filters:this._filters,sortBy:this._sortBy,sortOrder:this._sortOrder,caseInsensitive:this._caseInsensitive,useRegex:this._useRegex})});this._data=this._data.concat(t.data),this._hasMore=t.hasMore,this._currentOffset+=t.data.length,e&&(this._totalRows=t.totalRows),this._renderData(t.data),this._updateStatusBar()}catch(e){this._showError(`Failed to load data: ${e}`)}finally{this._loading=!1}}}_renderHeaders(){this._filterRow.innerHTML="",this._headerRow.innerHTML="";const e=document.createElement("th");e.className="jp-TabularDataViewer-filterCell jp-TabularDataViewer-rowNumberCell",this._filterRow.appendChild(e);const t=document.createElement("th");t.className="jp-TabularDataViewer-headerCell jp-TabularDataViewer-rowNumberCell";const a=document.createElement("div");a.className="jp-TabularDataViewer-headerContent";const s=document.createElement("div");s.className="jp-TabularDataViewer-columnName",s.textContent="",a.appendChild(s),t.appendChild(a),t.style.width="60px",e.style.width="60px",this._headerRow.appendChild(t),this._columns.forEach(e=>{const t=document.createElement("th");t.className="jp-TabularDataViewer-filterCell";const a=document.createElement("div");a.className="jp-TabularDataViewer-filterContainer";const s=document.createElement("input");s.type="text",s.className="jp-TabularDataViewer-filterInput",s.placeholder=this._getFilterPlaceholder(e.type),s.dataset.columnName=e.name,s.dataset.columnType=e.type,s.addEventListener("keyup",t=>{"Enter"===t.key&&this._applyFilter(e.name,s.value,e.type)});const i=document.createElement("button");i.className="jp-TabularDataViewer-filterButton",i.dataset.columnName=e.name,i.title="Filter by values";const n=document.createElementNS("http://www.w3.org/2000/svg","svg");n.setAttribute("width","16"),n.setAttribute("height","16"),n.setAttribute("viewBox","0 0 16 16"),n.setAttribute("fill","currentColor");const l=document.createElementNS("http://www.w3.org/2000/svg","path");l.setAttribute("d","M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.342.474l-3 1A.5.5 0 0 1 6 14.5V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5v-2z"),n.appendChild(l),i.appendChild(n);const o=this._filters[e.name];o&&o.valueList&&o.valueList.length>0&&i.classList.add("jp-TabularDataViewer-filterButton-active"),i.addEventListener("click",async()=>{await this._openFilterModal(e.name,s,i)}),a.appendChild(s),a.appendChild(i),t.appendChild(a),this._filterRow.appendChild(t);const r=document.createElement("th");r.className="jp-TabularDataViewer-headerCell",r.style.cursor="pointer",r.dataset.columnName=e.name,r.addEventListener("click",()=>{this._toggleSort(e.name)});const c=document.createElement("div");c.className="jp-TabularDataViewer-headerContent";const d=document.createElement("div");d.className="jp-TabularDataViewer-columnName",d.textContent=e.name;const h=document.createElement("i");h.className="jp-TabularDataViewer-infoIcon fas fa-info-circle",h.title="Show column statistics",h.addEventListener("click",async t=>{t.preventDefault(),t.stopPropagation(),await this._showColumnStats(e.name)}),d.appendChild(h);const u=document.createElement("div");u.className="jp-TabularDataViewer-columnType",u.textContent=this._simplifyType(e.type);const m=document.createElement("span");m.className="jp-TabularDataViewer-sortIndicator",m.textContent="",c.appendChild(d),c.appendChild(u),r.appendChild(c),r.appendChild(m);const p=document.createElement("div");p.className="jp-TabularDataViewer-resizeHandle",p.addEventListener("mousedown",t=>{t.preventDefault(),t.stopPropagation(),this._startResize(e.name,t.clientX,r)}),p.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation()}),r.appendChild(p);const _=this._columnWidths.get(e.name)||200;this._columnWidths.has(e.name)||this._columnWidths.set(e.name,_),r.style.width=`${_}px`,t.style.width=`${_}px`,this._headerRow.appendChild(r)});const i=Array.from(this._columnWidths.values()).reduce((e,t)=>e+t,0)+60;this._table.style.width=`${i}px`}_truncateText(e){return 0===this._maxCellCharacters||e.length<=this._maxCellCharacters?e:e.substring(0,this._maxCellCharacters)+"..."}_renderData(e){e.forEach(e=>{const t=document.createElement("tr");t.className="jp-TabularDataViewer-row";const a=document.createElement("td");a.className="jp-TabularDataViewer-cell jp-TabularDataViewer-rowNumberCell",a.textContent=String(e.__row_index__||""),t.appendChild(a),this._columns.forEach(a=>{const s=document.createElement("td");s.className="jp-TabularDataViewer-cell";const i=e[a.name],n=null!=i?String(i):"";s.textContent=this._truncateText(n),t.appendChild(s)}),t.addEventListener("mouseenter",()=>{this._contextMenuOpen||this._tbody.querySelectorAll("tr").forEach(e=>{e.classList.remove("jp-TabularDataViewer-row-context-active")})}),t.addEventListener("click",e=>{e.stopPropagation(),this._selectedRow===t?(t.classList.remove("jp-TabularDataViewer-row-selected"),this._selectedRow=null):(this._selectedRow&&this._selectedRow.classList.remove("jp-TabularDataViewer-row-selected"),t.classList.add("jp-TabularDataViewer-row-selected"),this._selectedRow=t)}),t.addEventListener("contextmenu",a=>{this._contextMenuOpen=!0,this._tbody.classList.add("jp-TabularDataViewer-context-menu-open"),this._tbody.querySelectorAll("tr").forEach(e=>{e.classList.remove("jp-TabularDataViewer-row-context-active")}),t.classList.add("jp-TabularDataViewer-row-context-active"),this._setLastContextMenuRow(e),this._startMenuObserver()}),this._tbody.appendChild(t)})}_startResize(e,t,a){this._resizing={columnName:e,startX:t,startWidth:a.offsetWidth},document.addEventListener("mousemove",this._doResize),document.addEventListener("mouseup",this._stopResize),document.body.style.userSelect="none",document.body.style.cursor="col-resize"}_applyFilter(e,t,a){if(t.trim())if(this._isNumericType(a)){const a=t.match(/^([><=]+)?\s*(.+)$/);if(a){const t=a[1]||"=",s=a[2].trim();this._filters[e]={type:"number",value:s,operator:t}}}else this._filters[e]={type:"text",value:t};else delete this._filters[e];this._loadData(!0)}async _openFilterModal(e,t,a){try{const s=await c(this._filePath,e,this._maxUniqueValues),i=this._filters[e],n=(null==i?void 0:i.valueList)||[];new h(e,s,n,s=>{if(s&&s.length>0){this._useRegex=!0,this._regexCheckbox.checked=!0;const i=`^(${s.map(e=>e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")).join("|")})$`;t.value=i,this._filters[e]={type:"text",value:i,valueList:s},a.classList.add("jp-TabularDataViewer-filterButton-active"),this._loadData(!0)}else t.value="",delete this._filters[e],a.classList.remove("jp-TabularDataViewer-filterButton-active"),this._loadData(!0)}).show()}catch(e){console.error("Failed to open filter modal:",e),this._showError(`Failed to load unique values: ${e}`)}}_simplifyType(e){const t=e.toLowerCase();return t.includes("date32")||t.includes("date64")?"date":t.includes("timestamp")?"datetime":t.match(/^u?int(8|16|32|64)$/)?"int":t.match(/^(float|double)(16|32|64)?$/)?"float":t.includes("decimal")?"decimal":"bool"===t?"boolean":"string"===t||"utf8"===t||"large_string"===t||"large_utf8"===t?"string":"binary"===t||"large_binary"===t?"binary":t.startsWith("list")?"list":t.startsWith("struct")?"struct":e}_isNumericType(e){return["int","float","double","decimal","int8","int16","int32","int64","uint8","uint16","uint32","uint64"].some(t=>e.toLowerCase().includes(t))}_getFilterPlaceholder(e){return this._isNumericType(e)?"=, >, <, >=, <=":"text or regex..."}_onScroll(){const e=this._tableContainer;e.scrollTop+e.clientHeight>=e.scrollHeight-200&&this._hasMore&&!this._loading&&this._loadData(!1)}_toggleSort(e){this._sortBy===e?"asc"===this._sortOrder?this._sortOrder="desc":"desc"===this._sortOrder&&(this._sortBy=null,this._sortOrder="asc"):(this._sortBy=e,this._sortOrder="asc"),this._updateSortIndicators(),this._loadData(!0)}async _showColumnStats(e){try{const t=await async function(e,t){return r("column-stats",{method:"POST",body:JSON.stringify({path:e,columnName:t})})}(this._filePath,e),a=await c(this._filePath,e,this._maxUniqueValues);new d(t,a).show()}catch(t){console.error("Failed to load column statistics:",t),alert(`Failed to load statistics for column "${e}": ${t}`)}}_updateSortIndicators(){this._headerRow.querySelectorAll("th").forEach(e=>{const t=e.dataset.columnName,a=e.querySelector(".jp-TabularDataViewer-sortIndicator");a&&(t===this._sortBy?a.textContent="asc"===this._sortOrder?" ▲":" ▼":a.textContent="")})}_clearFilters(){this._filters={},this._filterRow.querySelectorAll("input").forEach(e=>{e.value=""}),this._loadData(!0)}_formatFileSize(e){if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["B","KB","MB","GB","TB"][t]}_updateStatusBar(e){if(e)this._statusLeft.textContent="",this._statusRight.textContent=e;else{const e=this._columns.length,t=this._formatFileSize(this._fileSize);this._statusLeft.textContent=`${e} columns • ${this._unfilteredTotalRows} rows • ${t}`;const a=Object.keys(this._filters).length;let s=`Showing ${this._data.length} of ${this._totalRows} rows`;if(a>0&&(s+=` (${a} filter${a>1?"s":""} active)`),this._statusRight.innerHTML=s,a>0){const e=document.createElement("a");e.href="#",e.className="jp-TabularDataViewer-clearFilters",e.textContent="Clear filters",e.addEventListener("click",e=>{e.preventDefault(),this._clearFilters()}),this._statusRight.appendChild(document.createTextNode(" • ")),this._statusRight.appendChild(e)}}}_showError(e){this._tbody.innerHTML="",this._selectedRow=null;const t=document.createElement("tr"),a=document.createElement("td");a.colSpan=this._columns.length||1,a.className="jp-TabularDataViewer-error",a.textContent=e,t.appendChild(a),this._tbody.appendChild(t)}dispose(){this._tableContainer.removeEventListener("scroll",this._onScroll),this._menuObserver&&(this._menuObserver.disconnect(),this._menuObserver=null),this._resizing&&(document.removeEventListener("mousemove",this._doResize),document.removeEventListener("mouseup",this._stopResize),document.body.style.userSelect="",document.body.style.cursor=""),super.dispose()}}class m extends s.DocumentWidget{constructor(e){super(e)}}class p extends s.ABCWidgetFactory{constructor(e,t,a,s){super(e),this._setLastContextMenuRow=t,this._setActiveWidget=a,this._getSettings=s}createNewWidget(e){const t=this._getSettings(),a=new u(e.path,this._setLastContextMenuRow,t.maxCellCharacters,t.maxUniqueValues),s=new m({content:a,context:e});return s.title.label=e.path.split("/").pop()||"Tabular Data File",e.fileChanged.connect(()=>{console.log("[Tabular Data Viewer] File changed, refreshing data"),a.refresh()}),this._setActiveWidget(a),s}}const _={id:"jupyterlab_tabular_data_viewer_extension:plugin",description:"Jupyterlab extension to allow simple browsing of tabular data files (Parquet, Excel) with filtering and sorting capabilities",autoStart:!0,requires:[i.ISettingRegistry],activate:async(e,t)=>{console.log("JupyterLab extension jupyterlab_tabular_data_viewer_extension is activated!");const{docRegistry:a,commands:s,contextMenu:i}=e;let n=null,l=null,o={enableParquet:!0,enableExcel:!0,enableCSV:!0,enableTSV:!0,maxCellCharacters:100,maxUniqueValues:100};try{const e=await t.load(_.id);o=e.composite,e.changed.connect(()=>{o=e.composite})}catch(e){console.error("[Tabular Data Viewer] Failed to load settings:",e)}const r="tabular-data-viewer:copy-row-json";s.addCommand(r,{label:"Copy Row as JSON",caption:"Copy the row data as JSON to clipboard",isEnabled:()=>null!==n,execute:async()=>{if(n){const{__row_index__:e,...t}=n,a=JSON.stringify(t,null,2);await navigator.clipboard.writeText(a),l&&l.getCleanupHighlight()()}}}),i.addItem({command:r,selector:".jp-TabularDataViewer-row",rank:10});const c=[],d=[];if(o.enableParquet)try{a.addFileType({name:"parquet",displayName:"Parquet",extensions:[".parquet"],mimeTypes:["application/x-parquet"],iconClass:"jp-MaterialIcon jp-SpreadsheetIcon",contentType:"file",fileFormat:"base64"}),c.push("parquet")}catch(e){console.warn("[Tabular Data Viewer] Parquet file type already registered",e)}if(o.enableExcel)try{a.addFileType({name:"xlsx-parquet-viewer",displayName:"Excel (Parquet Viewer)",extensions:[".xlsx"],mimeTypes:["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"],iconClass:"jp-MaterialIcon jp-SpreadsheetIcon",contentType:"file",fileFormat:"base64"}),c.push("xlsx-parquet-viewer")}catch(e){console.warn("[Tabular Data Viewer] Excel file type already registered",e)}if(o.enableCSV)try{a.addFileType({name:"csv-tabular-viewer",displayName:"CSV (Tabular Viewer)",extensions:[".csv"],mimeTypes:["text/csv"],iconClass:"jp-MaterialIcon jp-SpreadsheetIcon",contentType:"file",fileFormat:"text"}),d.push("csv-tabular-viewer")}catch(e){console.warn("[Tabular Data Viewer] CSV file type already registered",e)}if(o.enableTSV)try{a.addFileType({name:"tsv-tabular-viewer",displayName:"TSV (Tabular Viewer)",extensions:[".tsv"],mimeTypes:["text/tab-separated-values"],iconClass:"jp-MaterialIcon jp-SpreadsheetIcon",contentType:"file",fileFormat:"text"}),d.push("tsv-tabular-viewer")}catch(e){console.warn("[Tabular Data Viewer] TSV file type already registered",e)}if(c.length>0){const e=new p({name:"Tabular Data Viewer (Binary)",modelName:"base64",fileTypes:c,defaultFor:c,defaultRendered:c,readOnly:!0},e=>{n=e},e=>{l=e},()=>o);a.addWidgetFactory(e)}if(d.length>0){const e=new p({name:"Tabular Data Viewer (Text)",modelName:"text",fileTypes:d,defaultFor:d,defaultRendered:d,readOnly:!0},e=>{n=e},e=>{l=e},()=>o);a.addWidgetFactory(e)}0===c.length&&0===d.length&&console.warn("[Tabular Data Viewer] No file types enabled in settings")}},b=_}}]);