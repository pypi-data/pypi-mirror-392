name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: make setup

      - name: Checks
        run: make lint-check

  integration-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # Test against longtail (Cloud instance)
          - test_env: "longtail"
            datahub_version: "cloud"
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # OSS-specific: Install DataHub CLI and start quickstart
      - name: Install DataHub CLI (OSS only)
        if: matrix.test_env == 'oss'
        run: |
          python -m pip install --upgrade pip
          pip install acryl-datahub

      - name: Start DataHub Quickstart (OSS only)
        if: matrix.test_env == 'oss'
        run: |
          datahub docker quickstart --version ${{ matrix.datahub_version }}
          datahub docker check

      - name: Ingest sample data (OSS only)
        if: matrix.test_env == 'oss'
        run: |
          datahub docker ingest-sample-data

      # Setup MCP server dependencies
      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Install MCP Server dependencies
        run: make setup

      # Run tests based on environment
      - name: Run integration tests (longtail)
        if: matrix.test_env == 'longtail'
        env:
          DATAHUB_GMS_URL: ${{ secrets.LONGTAIL_GMS_URL }}
          DATAHUB_GMS_TOKEN: ${{ secrets.LONGTAIL_GMS_TOKEN }}
        run: |
          uv run pytest tests/test_mcp_integration.py -v

      - name: Run integration tests (OSS)
        if: matrix.test_env == 'oss'
        env:
          DATAHUB_GMS_URL: "http://localhost:8080"
          DATAHUB_GMS_TOKEN: ""
        run: |
          uv run pytest tests/test_mcp_integration.py -v

      # Cleanup
      - name: Cleanup DataHub (OSS only)
        if: always() && matrix.test_env == 'oss'
        run: |
          datahub docker nuke || true
