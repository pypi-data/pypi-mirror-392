<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Documentation Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="../js/tailwind-config.js"></script>
  <style>
    /* shadcn-style graph cards */
    .graph-card {
      position: relative;
      overflow: hidden;
    }
    .graph-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, hsl(222.2 47.4% 11.2%), hsl(215 20% 65%));
    }
  </style>
  <script src="../js/nodes.js"></script>
  <script src="../js/links.js"></script>
  <script src="../js/includes-nodes.js"></script>
  <script src="../js/includes-links.js"></script>
  <script src="../js/glossary-stats.js"></script>
</head>
<body class="bg-secondary min-h-screen">
  <!-- Navigation Header -->
  <nav class="border-b border-border bg-card">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center space-x-8">
          <!-- Logo/Home -->
          <a href="index.html" class="flex items-center space-x-2 text-foreground hover:text-primary transition-colors">
            <img src="../svg/home.svg" alt="Home" class="w-6 h-6">
            <span class="font-semibold text-lg">Sphinx Visualized</span>
          </a>

          <!-- Navigation Tabs (Desktop) -->
          <div class="hidden md:flex space-x-1">
            <a href="link-graph.html" class="px-4 py-2 rounded-md text-sm font-medium text-muted-foreground hover:text-foreground hover:bg-accent transition-colors">
              Link Graph
            </a>
            <a href="toctree-graph.html" class="px-4 py-2 rounded-md text-sm font-medium text-muted-foreground hover:text-foreground hover:bg-accent transition-colors">
              Toctree Graph
            </a>
            <a href="includes-graph.html" class="px-4 py-2 rounded-md text-sm font-medium text-muted-foreground hover:text-foreground hover:bg-accent transition-colors">
              Includes Graph
            </a>
          </div>
        </div>

        <!-- Mobile Menu Button -->
        <button id="mobile-menu-button" class="md:hidden p-2 rounded-md text-muted-foreground hover:text-foreground hover:bg-accent transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Mobile Menu -->
    <div id="mobile-menu" class="hidden md:hidden border-t border-border">
      <div class="px-2 pt-2 pb-3 space-y-1">
        <a href="link-graph.html" class="block px-3 py-2 rounded-md text-base font-medium text-muted-foreground hover:text-foreground hover:bg-accent transition-colors">
          Link Graph
        </a>
        <a href="toctree-graph.html" class="block px-3 py-2 rounded-md text-base font-medium text-muted-foreground hover:text-foreground hover:bg-accent transition-colors">
          Toctree Graph
        </a>
        <a href="includes-graph.html" class="block px-3 py-2 rounded-md text-base font-medium text-muted-foreground hover:text-foreground hover:bg-accent transition-colors">
          Includes Graph
        </a>
      </div>
    </div>
  </nav>

  <script>
    // Mobile menu toggle
    document.getElementById('mobile-menu-button').addEventListener('click', function() {
      const menu = document.getElementById('mobile-menu');
      menu.classList.toggle('hidden');
    });
  </script>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Graph Navigation Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
      <a href="link-graph.html" class="graph-card group block bg-card border border-border rounded-lg p-6 hover:shadow-md transition-all duration-200 no-underline">
        <div class="flex items-start justify-between mb-4 pt-2">
          <h3 class="text-xl font-semibold text-foreground group-hover:text-primary transition-colors">Link Graph</h3>
          <svg class="w-4 h-4 text-muted-foreground group-hover:text-foreground transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        </div>
        <p class="text-sm text-muted-foreground leading-relaxed">Visualize page connections and references</p>
      </a>
      <a href="toctree-graph.html" class="graph-card group block bg-card border border-border rounded-lg p-6 hover:shadow-md transition-all duration-200 no-underline">
        <div class="flex items-start justify-between mb-4 pt-2">
          <h3 class="text-xl font-semibold text-foreground group-hover:text-primary transition-colors">Toctree Graph</h3>
          <svg class="w-4 h-4 text-muted-foreground group-hover:text-foreground transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        </div>
        <p class="text-sm text-muted-foreground leading-relaxed">Explore document hierarchy structure</p>
      </a>
      <a href="includes-graph.html" class="graph-card group block bg-card border border-border rounded-lg p-6 hover:shadow-md transition-all duration-200 no-underline">
        <div class="flex items-start justify-between mb-4 pt-2">
          <h3 class="text-xl font-semibold text-foreground group-hover:text-primary transition-colors">Includes Graph</h3>
          <svg class="w-4 h-4 text-muted-foreground group-hover:text-foreground transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        </div>
        <p class="text-sm text-muted-foreground leading-relaxed">See file inclusion relationships</p>
      </a>
    </div>

    <!-- Tabbed Detailed Sections -->
    <div class="bg-card border border-border rounded-lg overflow-hidden mb-6">
      <div class="flex border-b border-border bg-muted overflow-x-auto">
        <button class="tab-button px-6 py-3 text-sm font-medium text-primary hover:text-foreground hover:bg-accent border-b-2 border-primary bg-card whitespace-nowrap transition-colors duration-150" onclick="switchTab('structure')">Structure</button>
        <button class="tab-button px-6 py-3 text-sm font-medium text-muted-foreground hover:text-foreground hover:bg-accent border-b-2 border-transparent whitespace-nowrap transition-colors duration-150" onclick="switchTab('links')">Link Analysis</button>
        <button class="tab-button px-6 py-3 text-sm font-medium text-muted-foreground hover:text-foreground hover:bg-accent border-b-2 border-transparent whitespace-nowrap transition-colors duration-150" onclick="switchTab('reuse')">Content Reuse</button>
      </div>

      <!-- Structure Tab -->
      <div id="tab-structure" class="tab-content p-6">
        <!-- Summary card at top of tab -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
          <div class="bg-card border border-border rounded-md p-6 hover:bg-accent/50 transition-colors duration-200">
            <div class="flex flex-col">
              <span class="text-sm font-medium text-muted-foreground">Total Pages</span>
              <span class="text-3xl font-bold text-foreground mt-2" id="total-pages-tab">-</span>
            </div>
          </div>
        </div>

        <h3 class="text-lg font-semibold text-foreground mb-4">Cluster Distribution</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="cluster-stats"></div>
      </div>

      <!-- Link Analysis Tab -->
      <div id="tab-links" class="tab-content p-6 hidden">

        <!-- Sub-tabs for Link Analysis -->
        <div class="flex border-b border-border mb-6 overflow-x-auto">
          <button class="link-subtab-button px-4 py-2 text-sm font-medium text-primary hover:text-foreground hover:bg-accent border-b-2 border-primary whitespace-nowrap transition-colors duration-150" onclick="switchLinkSubtab('internal')">Internal Links</button>
          <button class="link-subtab-button px-4 py-2 text-sm font-medium text-muted-foreground hover:text-foreground hover:bg-accent border-b-2 border-transparent whitespace-nowrap transition-colors duration-150" onclick="switchLinkSubtab('glossary')">Glossary Terms</button>
          <button class="link-subtab-button px-4 py-2 text-sm font-medium text-muted-foreground hover:text-foreground hover:bg-accent border-b-2 border-transparent whitespace-nowrap transition-colors duration-150" onclick="switchLinkSubtab('external')">External Links</button>
        </div>

        <!-- Internal Links Sub-tab -->
        <div id="link-subtab-internal" class="link-subtab-content">

          <!-- Internal Links Summary Cards -->
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
            <div class="bg-card border border-border rounded-md p-6 hover:bg-accent/50 transition-colors duration-200">
              <div class="flex flex-col">
                <span class="text-sm font-medium text-muted-foreground">Total Links</span>
                <span class="text-3xl font-bold text-foreground mt-2" id="total-links-tab">-</span>
              </div>
            </div>
            <div class="bg-card border border-border rounded-md p-6 hover:bg-accent/50 transition-colors duration-200">
              <div class="flex flex-col">
                <span class="text-sm font-medium text-muted-foreground">Total References</span>
                <span class="text-3xl font-bold text-foreground mt-2" id="total-references-tab">-</span>
              </div>
            </div>
          </div>

          <!-- Internal Links Tables -->
          <h3 class="text-lg font-semibold text-foreground mb-4 mt-6">Most Referenced Pages</h3>
          <div class="border border-border rounded-md overflow-hidden mb-6">
            <table class="min-w-full divide-y divide-border">
              <thead class="bg-muted/50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Page</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Inbound References</th>
                </tr>
              </thead>
              <tbody id="most-referenced" class="bg-card divide-y divide-border"></tbody>
            </table>
          </div>

          <h3 class="text-lg font-semibold text-foreground mb-4">Pages with Most Outbound Links</h3>
          <div class="border border-border rounded-md overflow-hidden">
            <table class="min-w-full divide-y divide-border">
              <thead class="bg-muted/50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Page</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Outbound Links</th>
                </tr>
              </thead>
              <tbody id="most-outbound" class="bg-card divide-y divide-border"></tbody>
            </table>
          </div>
        </div>

        <!-- Glossary Terms Sub-tab -->
        <div id="link-subtab-glossary" class="link-subtab-content hidden">

          <!-- Glossary Summary Cards -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
            <div class="bg-card border border-border rounded-md p-6 hover:bg-accent/50 transition-colors duration-200">
              <div class="flex flex-col">
                <span class="text-sm font-medium text-muted-foreground">Glossary Terms</span>
                <span class="text-3xl font-bold text-foreground mt-2" id="glossary-total-terms">-</span>
              </div>
            </div>
            <div class="bg-card border border-border rounded-md p-6 hover:bg-accent/50 transition-colors duration-200">
              <div class="flex flex-col">
                <span class="text-sm font-medium text-muted-foreground">Term References</span>
                <span class="text-3xl font-bold text-foreground mt-2" id="glossary-total-references">-</span>
              </div>
            </div>
            <div class="bg-card border border-border rounded-md p-6 hover:bg-accent/50 transition-colors duration-200">
              <div class="flex flex-col">
                <span class="text-sm font-medium text-muted-foreground">Pages Using Terms</span>
                <span class="text-3xl font-bold text-foreground mt-2" id="glossary-pages-with-terms">-</span>
              </div>
            </div>
          </div>

          <!-- Glossary Table -->
          <h3 class="text-lg font-semibold text-foreground mb-4 mt-6">Most Referenced Terms</h3>
          <div class="border border-border rounded-md overflow-hidden">
            <table class="min-w-full divide-y divide-border">
              <thead class="bg-muted/50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Term</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">References</th>
                </tr>
              </thead>
              <tbody id="glossary-terms-stats" class="bg-card divide-y divide-border"></tbody>
            </table>
          </div>
        </div>

        <!-- External Links Sub-tab -->
        <div id="link-subtab-external" class="link-subtab-content hidden">

          <h3 class="text-lg font-semibold text-foreground mb-4">Links by Project</h3>
          <div class="border border-border rounded-md overflow-hidden">
            <table class="min-w-full divide-y divide-border">
              <thead class="bg-muted/50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Project</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">External Pages</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Total References</th>
                </tr>
              </thead>
              <tbody id="intersphinx-stats" class="bg-card divide-y divide-border"></tbody>
            </table>
          </div>
        </div>

      </div>

      <!-- Content Reuse Tab -->
      <div id="tab-reuse" class="tab-content p-6 hidden">
        <!-- Summary cards at top of tab -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
          <div class="bg-card border border-border rounded-md p-6 hover:bg-accent/50 transition-colors duration-200">
            <div class="flex flex-col">
              <span class="text-sm font-medium text-muted-foreground">Include Directives</span>
              <span class="text-3xl font-bold text-foreground mt-2" id="total-include-directives-tab">-</span>
            </div>
          </div>
          <div class="bg-card border border-border rounded-md p-6 hover:bg-accent/50 transition-colors duration-200">
            <div class="flex flex-col">
              <span class="text-sm font-medium text-muted-foreground">Included Files</span>
              <span class="text-3xl font-bold text-foreground mt-2" id="total-included-files-tab">-</span>
            </div>
          </div>
          <div class="bg-card border border-border rounded-md p-6 hover:bg-accent/50 transition-colors duration-200">
            <div class="flex flex-col">
              <span class="text-sm font-medium text-muted-foreground">Docs Using Includes</span>
              <span class="text-3xl font-bold text-foreground mt-2" id="docs-with-includes-tab">-</span>
            </div>
          </div>
        </div>

        <div id="most-included-section">
          <h3 class="text-lg font-semibold text-foreground mb-4">Most Included Files</h3>
          <div class="border border-border rounded-md overflow-hidden mb-6">
            <table class="min-w-full divide-y divide-border">
              <thead class="bg-muted/50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">File</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Times Included</th>
                </tr>
              </thead>
              <tbody id="most-included-files" class="bg-card divide-y divide-border"></tbody>
            </table>
          </div>
        </div>

        <div id="most-includes-section" class="mt-8">
          <h3 class="text-lg font-semibold text-foreground mb-4">Documents with Most Includes</h3>
          <div class="border border-border rounded-md overflow-hidden">
            <table class="min-w-full divide-y divide-border">
              <thead class="bg-muted/50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Document</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Include Count</th>
                </tr>
              </thead>
              <tbody id="most-includes-docs" class="bg-card divide-y divide-border"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Tab switching function
    function switchTab(tabName) {
      // Remove active class from all buttons and contents
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('text-primary', 'border-primary', 'bg-card');
        btn.classList.add('text-muted-foreground', 'border-transparent');
      });
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
      });

      // Add active class to selected tab
      const activeButton = document.querySelector(`[onclick*="${tabName}"]`);
      activeButton.classList.remove('text-muted-foreground', 'border-transparent');
      activeButton.classList.add('text-primary', 'border-primary', 'bg-card');
      document.getElementById(`tab-${tabName}`).classList.remove('hidden');
    }

    // Link Analysis sub-tab switching function
    function switchLinkSubtab(subtabName) {
      // Remove active class from all sub-tab buttons and contents
      document.querySelectorAll('.link-subtab-button').forEach(btn => {
        btn.classList.remove('text-primary', 'border-primary');
        btn.classList.add('text-muted-foreground', 'border-transparent');
      });
      document.querySelectorAll('.link-subtab-content').forEach(content => {
        content.classList.add('hidden');
      });

      // Add active class to selected sub-tab
      const activeButton = document.querySelector(`[onclick*="switchLinkSubtab('${subtabName}')"]`);
      activeButton.classList.remove('text-muted-foreground', 'border-transparent');
      activeButton.classList.add('text-primary', 'border-primary');
      document.getElementById(`link-subtab-${subtabName}`).classList.remove('hidden');
    }

    // Calculate statistics
    const nodes = nodes_data || [];
    const links = links_data || [];

    // Basic statistics
    const totalPages = nodes.length;
    const totalLinks = links.length;
    const totalReferences = links.reduce((sum, link) => sum + (link.reference_count || 1), 0);

    // Count intersphinx nodes and projects
    const intersphinxNodes = nodes.filter(node => node.is_intersphinx);
    const totalIntersphinx = intersphinxNodes.length;

    // Calculate pages with at least one link
    const pageStats = nodes.map(node => ({
      id: node.id,
      label: node.label,
      path: node.path,
      cluster: node.cluster,
      inbound: 0,
      outbound: 0
    }));

    links.forEach(link => {
      if (pageStats[link.target]) {
        pageStats[link.target].inbound += (link.reference_count || 1);
      }
      if (pageStats[link.source]) {
        pageStats[link.source].outbound += (link.reference_count || 1);
      }
    });

    // Update summary cards in tabs
    document.getElementById('total-pages-tab').textContent = totalPages;
    document.getElementById('total-links-tab').textContent = totalLinks;
    document.getElementById('total-references-tab').textContent = totalReferences;

    // Cluster distribution
    const clusterCounts = {};
    let hasUnclustered = false;

    nodes.forEach(node => {
      if (node.cluster) {
        clusterCounts[node.cluster] = (clusterCounts[node.cluster] || 0) + 1;
      } else {
        hasUnclustered = true;
        clusterCounts['Unclustered'] = (clusterCounts['Unclustered'] || 0) + 1;
      }
    });

    const clusterStatsDiv = document.getElementById('cluster-stats');
    if (Object.keys(clusterCounts).length > 0) {
      Object.entries(clusterCounts).sort((a, b) => b[1] - a[1]).forEach(([cluster, count]) => {
        const div = document.createElement('div');
        div.className = 'bg-card border border-border rounded-md p-4 hover:bg-accent/50 transition-colors duration-200';
        div.innerHTML = `
          <div class="font-medium text-muted-foreground text-sm mb-1">${cluster}</div>
          <div class="text-2xl font-bold text-foreground">${count} pages</div>
        `;
        clusterStatsDiv.appendChild(div);
      });
    } else {
      clusterStatsDiv.innerHTML = '<div class="text-center text-muted-foreground italic py-8 col-span-full">No clusters configured</div>';
    }

    // Intersphinx statistics by project
    const intersphinxByProject = {};

    // Count pages by project
    intersphinxNodes.forEach(node => {
      // Extract project name from cluster (format: "project_name (external)")
      let projectName = node.cluster;
      if (projectName && projectName.endsWith(' (external)')) {
        projectName = projectName.slice(0, -11); // Remove " (external)" suffix
      }

      if (!intersphinxByProject[projectName]) {
        intersphinxByProject[projectName] = {
          pageCount: 0,
          referenceCount: 0
        };
      }
      intersphinxByProject[projectName].pageCount++;
    });

    // Count references to intersphinx pages
    links.forEach(link => {
      const targetNode = nodes[link.target];
      if (targetNode && targetNode.is_intersphinx) {
        let projectName = targetNode.cluster;
        if (projectName && projectName.endsWith(' (external)')) {
          projectName = projectName.slice(0, -11);
        }
        if (intersphinxByProject[projectName]) {
          intersphinxByProject[projectName].referenceCount += (link.reference_count || 1);
        }
      }
    });

    const intersphinxStatsTbody = document.getElementById('intersphinx-stats');
    const intersphinxSubtab = document.getElementById('link-subtab-external');
    const externalSubtabButton = document.querySelector('[onclick*="switchLinkSubtab(\'external\')"]');

    if (Object.keys(intersphinxByProject).length > 0) {
      Object.entries(intersphinxByProject)
        .sort((a, b) => b[1].referenceCount - a[1].referenceCount)
        .forEach(([project, stats]) => {
          const row = document.createElement('tr');
          row.className = 'hover:bg-muted/50 transition-colors';
          row.innerHTML = `
            <td class="px-4 py-3 font-medium">${project}</td>
            <td class="px-4 py-3 text-muted-foreground">${stats.pageCount}</td>
            <td class="px-4 py-3 text-muted-foreground">${stats.referenceCount}</td>
          `;
          intersphinxStatsTbody.appendChild(row);
        });
    } else {
      // Hide the External Links sub-tab if no intersphinx links
      intersphinxSubtab.style.display = 'none';
      if (externalSubtabButton) {
        externalSubtabButton.style.display = 'none';
      }
    }

    // ========== Glossary Statistics ==========
    const glossaryData = glossary_stats || { total_terms: 0, total_references: 0, unique_pages_with_terms: 0, most_referenced_terms: [] };

    // Update glossary summary cards
    document.getElementById('glossary-total-terms').textContent = glossaryData.total_terms;
    document.getElementById('glossary-total-references').textContent = glossaryData.total_references;
    document.getElementById('glossary-pages-with-terms').textContent = glossaryData.unique_pages_with_terms;

    // Populate most referenced terms table
    const glossaryTermsStatsTbody = document.getElementById('glossary-terms-stats');
    const glossarySubtab = document.getElementById('link-subtab-glossary');
    const glossarySubtabButton = document.querySelector('[onclick*="switchLinkSubtab(\'glossary\')"]');

    if (glossaryData.most_referenced_terms && glossaryData.most_referenced_terms.length > 0) {
      glossaryData.most_referenced_terms.forEach(termData => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-muted/50 transition-colors';
        row.innerHTML = `
          <td class="px-4 py-3"><a href="${termData.link}" target="_blank" class="text-primary hover:underline font-medium">${termData.term}</a></td>
          <td class="px-4 py-3 text-muted-foreground">${termData.count}</td>
        `;
        glossaryTermsStatsTbody.appendChild(row);
      });
    } else {
      // Hide the Glossary Terms sub-tab if no glossary data
      glossarySubtab.style.display = 'none';
      if (glossarySubtabButton) {
        glossarySubtabButton.style.display = 'none';
      }
    }

    // Most referenced pages (top 10)
    const mostReferenced = [...pageStats]
      .filter(page => page.inbound > 0)
      .sort((a, b) => b.inbound - a.inbound)
      .slice(0, 10);

    const mostReferencedTbody = document.getElementById('most-referenced');
    if (mostReferenced.length > 0) {
      mostReferenced.forEach(page => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-muted/50 transition-colors';
        row.innerHTML = `
          <td class="px-4 py-3"><a href="${page.path}" target="_blank" class="text-primary hover:underline font-medium">${page.label}</a></td>
          <td class="px-4 py-3 text-muted-foreground">${page.inbound}</td>
        `;
        mostReferencedTbody.appendChild(row);
      });
    } else {
      mostReferencedTbody.innerHTML = '<tr><td colspan="2" class="px-4 py-3 text-center text-muted-foreground italic">No referenced pages</td></tr>';
    }

    // Pages with most outbound links (top 10)
    const mostOutbound = [...pageStats]
      .filter(page => page.outbound > 0)
      .sort((a, b) => b.outbound - a.outbound)
      .slice(0, 10);

    const mostOutboundTbody = document.getElementById('most-outbound');
    if (mostOutbound.length > 0) {
      mostOutbound.forEach(page => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-muted/50 transition-colors';
        row.innerHTML = `
          <td class="px-4 py-3"><a href="${page.path}" target="_blank" class="text-primary hover:underline font-medium">${page.label}</a></td>
          <td class="px-4 py-3 text-muted-foreground">${page.outbound}</td>
        `;
        mostOutboundTbody.appendChild(row);
      });
    } else {
      mostOutboundTbody.innerHTML = '<tr><td colspan="2" class="px-4 py-3 text-center text-muted-foreground italic">No pages with outbound links</td></tr>';
    }

    // ========== Include Statistics ==========
    const includesNodes = includes_nodes_data || [];
    const includesLinks = includes_links_data || [];

    // Calculate basic include statistics
    const includedFiles = includesNodes.filter(node => node.type === 'include' || node.type === 'literalinclude');
    const totalIncludedFiles = includedFiles.length;
    const totalIncludeDirectives = includesLinks.reduce((sum, link) => sum + (link.count || 1), 0);

    // Count unique documents that use includes
    const docsUsingIncludes = new Set(includesLinks.map(link => link.source)).size;

    // Update summary cards in the Content Reuse tab
    document.getElementById('total-included-files-tab').textContent = totalIncludedFiles;
    document.getElementById('total-include-directives-tab').textContent = totalIncludeDirectives;
    document.getElementById('docs-with-includes-tab').textContent = docsUsingIncludes;

    // Most included files
    const includeStats = {};

    includesLinks.forEach(link => {
      const targetNode = includesNodes[link.target];
      if (targetNode && (targetNode.type === 'include' || targetNode.type === 'literalinclude')) {
        if (!includeStats[link.target]) {
          includeStats[link.target] = {
            label: targetNode.label,
            path: targetNode.path,
            count: 0
          };
        }
        includeStats[link.target].count += (link.count || 1);
      }
    });

    const mostIncludedFiles = Object.values(includeStats)
      .sort((a, b) => b.count - a.count)
      .slice(0, 10);

    const mostIncludedTbody = document.getElementById('most-included-files');
    const mostIncludedSection = document.getElementById('most-included-section');

    if (mostIncludedFiles.length > 0) {
      mostIncludedFiles.forEach(file => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-muted/50 transition-colors';
        row.innerHTML = `
          <td class="px-4 py-3 font-medium">${file.label}</td>
          <td class="px-4 py-3 text-muted-foreground">${file.count}</td>
        `;
        mostIncludedTbody.appendChild(row);
      });
    } else {
      mostIncludedSection.style.display = 'none';
    }

    // Documents with most includes
    const docIncludeStats = {};

    includesLinks.forEach(link => {
      const sourceNode = includesNodes[link.source];
      if (sourceNode) {
        if (!docIncludeStats[link.source]) {
          docIncludeStats[link.source] = {
            label: sourceNode.label,
            path: sourceNode.path,
            count: 0
          };
        }
        docIncludeStats[link.source].count += (link.count || 1);
      }
    });

    const mostIncludesDocs = Object.values(docIncludeStats)
      .sort((a, b) => b.count - a.count)
      .slice(0, 10);

    const mostIncludesDocsTbody = document.getElementById('most-includes-docs');
    const mostIncludesSection = document.getElementById('most-includes-section');

    if (mostIncludesDocs.length > 0) {
      mostIncludesDocs.forEach(doc => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-muted/50 transition-colors';
        row.innerHTML = `
          <td class="px-4 py-3"><a href="${doc.path}" target="_blank" class="text-primary hover:underline font-medium">${doc.label}</a></td>
          <td class="px-4 py-3 text-muted-foreground">${doc.count}</td>
        `;
        mostIncludesDocsTbody.appendChild(row);
      });
    } else {
      mostIncludesSection.style.display = 'none';
    }
  </script>
</body>
</html>
