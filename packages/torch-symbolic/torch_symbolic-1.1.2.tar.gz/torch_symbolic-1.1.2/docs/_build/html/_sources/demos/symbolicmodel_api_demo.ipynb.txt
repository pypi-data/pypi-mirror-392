{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "c60f6309",
   "metadata": {},
   "source": [
    "# SymbolicModel Demo"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "248f7b3c",
   "metadata": {},
   "source": [
    "In this demo we show you how to:\n",
    "* Wrap a whole PyTorch model with `SymbolicModel`\n",
    "* Perform symbolic regression with the `.distill` method"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "bdf01fce",
   "metadata": {},
   "source": [
    "## Wrap a PyTorch model\n",
    "\n",
    "Create a simple PyTorch model."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "64a74b9a",
   "metadata": {},
   "outputs": [],
   "source": [
    "import torch\n",
    "import numpy as np\n",
    "import torch.nn as nn\n",
    "\n",
    "class MLP(nn.Module):\n",
    "    \"\"\"\n",
    "    Simple MLP.\n",
    "    \"\"\"\n",
    "    def __init__(self, input_dim, output_dim, hidden_dim):\n",
    "        super(MLP, self).__init__()\n",
    "        self.mlp = nn.Sequential(\n",
    "            nn.Linear(input_dim, hidden_dim),\n",
    "            nn.ReLU(),\n",
    "            nn.Dropout(0.2),\n",
    "            nn.Linear(hidden_dim, hidden_dim),\n",
    "            nn.ReLU(),\n",
    "            nn.Dropout(0.2),\n",
    "            nn.Linear(hidden_dim, hidden_dim),\n",
    "            nn.ReLU(),\n",
    "            nn.Dropout(0.2),\n",
    "            nn.Linear(hidden_dim, output_dim)\n",
    "        )\n",
    "\n",
    "    def forward(self, x):\n",
    "        return self.mlp(x)\n",
    "\n",
    "class SimpleModel(nn.Module):\n",
    "    \"\"\"\n",
    "    Simple model class.\n",
    "    \"\"\"\n",
    "    def __init__(self, input_dim, output_dim, hidden_dim = 64):\n",
    "        super(SimpleModel, self).__init__()\n",
    "\n",
    "        self.mlp = MLP(input_dim, output_dim, hidden_dim)\n",
    "\n",
    "    def forward(self, x):\n",
    "        x = self.mlp(x)\n",
    "        return x"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "d31000dd",
   "metadata": {},
   "source": [
    "Train the model on some data.\n",
    "\n",
    "$$\n",
    "y = x_0^2 +3 \\sin(x_4)-4\n",
    "$$"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "ae612d82",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Make the dataset \n",
    "x = np.array([np.random.uniform(0, 1, 10_000) for _ in range(5)]).T  \n",
    "y = x[:, 0]**2 + 3*np.sin(x[:, 4]) - 4\n",
    "noise = np.array([np.random.normal(0, 0.05*np.std(y)) for _ in range(len(y))])\n",
    "y = y + noise "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "6a7664ce",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Set up training\n",
    "\n",
    "import torch.optim as optim\n",
    "from torch.utils.data import DataLoader, TensorDataset\n",
    "from sklearn.model_selection import train_test_split\n",
    "\n",
    "def train_model(model, dataloader, opt, criterion, epochs = 100):\n",
    "    \"\"\"\n",
    "    Train a model for the specified number of epochs.\n",
    "    \n",
    "    Args:\n",
    "        model: PyTorch model to train\n",
    "        dataloader: DataLoader for training data\n",
    "        opt: Optimizer\n",
    "        criterion: Loss function\n",
    "        epochs: Number of training epochs\n",
    "        \n",
    "    Returns:\n",
    "        tuple: (trained_model, loss_tracker)\n",
    "    \"\"\"\n",
    "    loss_tracker = []\n",
    "    for epoch in range(epochs):\n",
    "        epoch_loss = 0.0\n",
    "        \n",
    "        for batch_x, batch_y in dataloader:\n",
    "            # Forward pass\n",
    "            pred = model(batch_x)\n",
    "            loss = criterion(pred, batch_y)\n",
    "            \n",
    "            # Backward pass\n",
    "            opt.zero_grad()\n",
    "            loss.backward()\n",
    "            opt.step()\n",
    "            \n",
    "            epoch_loss += loss.item()\n",
    "        \n",
    "        loss_tracker.append(epoch_loss)\n",
    "        if (epoch + 1) % 5 == 0:\n",
    "            avg_loss = epoch_loss / len(dataloader)\n",
    "            print(f'Epoch [{epoch+1}/{epochs}], Avg Loss: {avg_loss:.6f}')\n",
    "    return model, loss_tracker\n",
    "\n",
    "# Instantiate the model\n",
    "model = SimpleModel(input_dim=x.shape[1], output_dim=1)\n",
    "\n",
    "# Set up training\n",
    "criterion = nn.MSELoss()\n",
    "opt = optim.Adam(model.parameters(), lr=0.001)\n",
    "X_train, X_test, y_train, y_test = train_test_split(x, y.reshape(-1,1), test_size=0.2, random_state=290402)\n",
    "\n",
    "# Set up dataset\n",
    "dataset = TensorDataset(torch.FloatTensor(X_train), torch.FloatTensor(y_train))\n",
    "dataloader = DataLoader(dataset, batch_size=32, shuffle=True)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "id": "ee255ef4",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Epoch [5/20], Avg Loss: 0.086152\n",
      "Epoch [10/20], Avg Loss: 0.057278\n",
      "Epoch [15/20], Avg Loss: 0.046266\n",
      "Epoch [20/20], Avg Loss: 0.035966\n"
     ]
    }
   ],
   "source": [
    "# Train the model and save the weights\n",
    "\n",
    "model, losses = train_model(model, dataloader, opt, criterion, 20)\n",
    "torch.save(model.state_dict(), 'model_weights.pth')"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "8a8144dd",
   "metadata": {},
   "source": [
    "## Wrap the model with `SymbolicModel`"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "id": "d50f0be8",
   "metadata": {},
   "outputs": [],
   "source": [
    "from symtorch import SymbolicModel"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "id": "4c972b4a",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "�\u000f No model name specified. Model label is model_4399178768.\n"
     ]
    }
   ],
   "source": [
    "symbolic_model = SymbolicModel(model)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "db9371d8",
   "metadata": {},
   "source": [
    "## Perform symbolic regression on the inputs and outputs of the whole model"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "id": "70f97d2f",
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/Users/liz/PhD/SymTorch_project/symtorch_venv/lib/python3.11/site-packages/pysr/sr.py:2811: UserWarning: Note: it looks like you are running in Jupyter. The progress bar will be turned off.\n",
      "  warnings.warn(\n",
      "Compiling Julia backend...\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "=�\u000f Running SR on output dimension 0 of 0\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "[ Info: Started!\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "Expressions evaluated per second: 3.560e+05\n",
      "Progress: 2039 / 12400 total iterations (16.444%)\n",
      "════════════════════════════════════════════════════════════════════════════════════════════════════\n",
      "───────────────────────────────────────────────────────────────────────────────────────────────────\n",
      "Complexity  Loss       Score      Equation\n",
      "1           4.968e-01  0.000e+00  y = -2.2854\n",
      "3           2.067e-01  4.386e-01  y = x₄ + -2.7857\n",
      "5           7.297e-02  5.205e-01  y = (x₄ * 2.281) + -3.4268\n",
      "7           8.081e-03  1.100e+00  y = ((x₄ * 2.2894) + -3.9371) + x₀\n",
      "9           5.517e-03  1.908e-01  y = ((x₄ * 2.2925) + -3.7747) + (x₀ * x₀)\n",
      "10          5.294e-03  4.124e-02  y = (x₀ + -4.0234) + (sin(x₄) * 2.6749)\n",
      "11          3.904e-03  3.046e-01  y = (x₄ * 2.291) + (((x₀ * 0.86742) * x₀) + -3.7285)\n",
      "12          3.837e-03  1.725e-02  y = ((x₄ * 2.2903) + -3.7399) + (sin(x₀) * x₀)\n",
      "13          2.976e-03  2.540e-01  y = inv((exp(x₄) * -0.20925) + -0.045857) + (x₀ * x₀)\n",
      "15          1.318e-03  4.073e-01  y = inv((exp(x₄) * -0.21609) + -0.041948) + ((x₀ * x₀) * 0...\n",
      "                                      .86682)\n",
      "16          1.228e-03  7.050e-02  y = inv((exp(x₄) * -0.21452) + -0.042668) + (sin(x₀) * x₀)\n",
      "17          1.016e-03  1.901e-01  y = (x₀ * (x₀ * 0.8622)) + inv((x₄ * 0.069134) + (exp(x₄) ...\n",
      "                                      * -0.26129))\n",
      "18          9.463e-04  7.062e-02  y = (x₀ * sin(x₀)) + inv((exp(x₄) * -0.26034) + (x₄ * 0.07...\n",
      "                                      0611))\n",
      "19          9.106e-04  3.846e-02  y = (((x₄ * -2.2226) + 4.7982) * exp(x₄)) + ((x₀ * sin(x₀)...\n",
      "                                      ) + -8.6183)\n",
      "20          8.712e-04  4.428e-02  y = ((exp(x₄) * -0.85711) + (((x₀ + 0.19297) * (x₀ * 0.731...\n",
      "                                      63)) + -3.0055)) + (x₄ * 3.7376)\n",
      "───────────────────────────────────────────────────────────────────────────────────────────────────\n",
      "════════════════════════════════════════════════════════════════════════════════════════════════════\n",
      "Press 'q' and then <enter> to stop execution early.\n",
      "\n",
      "Expressions evaluated per second: 3.670e+05\n",
      "Progress: 4336 / 12400 total iterations (34.968%)\n",
      "════════════════════════════════════════════════════════════════════════════════════════════════════\n",
      "───────────────────────────────────────────────────────────────────────────────────────────────────\n",
      "Complexity  Loss       Score      Equation\n",
      "1           4.968e-01  0.000e+00  y = -2.2854\n",
      "3           2.067e-01  4.386e-01  y = x₄ + -2.7857\n",
      "5           7.297e-02  5.205e-01  y = (x₄ * 2.281) + -3.4268\n",
      "7           8.081e-03  1.100e+00  y = ((x₄ * 2.2894) + -3.9371) + x₀\n",
      "9           5.517e-03  1.908e-01  y = ((x₄ * 2.2925) + -3.7747) + (x₀ * x₀)\n",
      "10          5.294e-03  4.124e-02  y = (x₀ + -4.0234) + (sin(x₄) * 2.6749)\n",
      "11          3.904e-03  3.046e-01  y = ((x₄ * 2.291) + ((x₀ * x₀) * 0.86744)) + -3.7285\n",
      "12          2.679e-03  3.767e-01  y = ((sin(x₄) * 2.6787) + (x₀ * x₀)) + -3.8611\n",
      "14          9.952e-04  4.951e-01  y = (((x₀ * 0.86458) * x₀) + (sin(x₄) * 2.6772)) + -3.814\n",
      "15          9.312e-04  6.651e-02  y = ((sin(x₄) * 2.6764) + -3.8264) + (x₀ * sin(x₀))\n",
      "16          8.887e-04  4.662e-02  y = ((sin(x₄) * 2.6767) + -3.8401) + (((x₀ + 0.19366) * 0....\n",
      "                                      73178) * x₀)\n",
      "19          8.428e-04  1.767e-02  y = (((sin(x₀) * x₀) + -3.8101) + (x₂ * -0.032591)) + (sin...\n",
      "                                      (x₄) * 2.6762)\n",
      "23          8.249e-04  5.387e-03  y = ((((x₄ * -2.2124) + 4.7764) * ((x₂ * -0.008441) + exp(...\n",
      "                                      x₄))) + -8.5756) + (x₀ * sin(x₀))\n",
      "25          7.889e-04  2.232e-02  y = ((((x₂ * -0.0047495) + exp(x₄ * 0.68234)) * ((x₄ * -3....\n",
      "                                      0799) + 8.5074)) + -12.322) + (x₀ * sin(x₀))\n",
      "27          7.881e-04  4.965e-04  y = (((sin(x₀) + 0.0030303) * x₀) + -12.323) + ((exp(x₄ * ...\n",
      "                                      0.68235) + (x₂ * -0.0047641)) * ((x₄ * -3.0797) + 8.5068))\n",
      "───────────────────────────────────────────────────────────────────────────────────────────────────\n",
      "════════════════════════════════════════════════════════════════════════════════════════════════════\n",
      "Press 'q' and then <enter> to stop execution early.\n",
      "\n",
      "Expressions evaluated per second: 3.940e+05\n",
      "Progress: 6857 / 12400 total iterations (55.298%)\n",
      "════════════════════════════════════════════════════════════════════════════════════════════════════\n",
      "───────────────────────────────────────────────────────────────────────────────────────────────────\n",
      "Complexity  Loss       Score      Equation\n",
      "1           4.968e-01  0.000e+00  y = -2.2854\n",
      "3           2.067e-01  4.386e-01  y = x₄ + -2.7857\n",
      "5           7.297e-02  5.205e-01  y = (x₄ * 2.281) + -3.4268\n",
      "7           8.081e-03  1.100e+00  y = ((x₄ * 2.2894) + -3.9371) + x₀\n",
      "9           5.517e-03  1.908e-01  y = ((x₄ * 2.2925) + -3.7747) + (x₀ * x₀)\n",
      "10          5.294e-03  4.124e-02  y = ((sin(x₄) * 2.6749) + x₀) + -4.0234\n",
      "11          3.904e-03  3.046e-01  y = ((x₀ * 0.86744) * x₀) + ((x₄ * 2.291) + -3.7285)\n",
      "12          2.679e-03  3.767e-01  y = ((sin(x₄) * 2.6787) + (x₀ * x₀)) + -3.8611\n",
      "14          9.952e-04  4.951e-01  y = (((x₀ * 0.86458) * x₀) + (sin(x₄) * 2.6772)) + -3.814\n",
      "15          9.312e-04  6.651e-02  y = ((sin(x₄) * 2.6764) + -3.8264) + (x₀ * sin(x₀))\n",
      "16          8.887e-04  4.662e-02  y = (((x₀ * (x₀ + 0.19331)) * 0.73199) + -3.8401) + (sin(x...\n",
      "                                      ₄) * 2.6767)\n",
      "18          8.467e-04  2.426e-02  y = ((x₀ + 0.19148) * (x₀ * 0.73271)) + ((sin(x₄ * 1.0596)...\n",
      "                                       * 2.575) + -3.8507)\n",
      "19          8.428e-04  4.506e-03  y = (x₂ * -0.032586) + ((sin(x₄) * 2.6762) + ((x₀ * sin(x₀...\n",
      "                                      )) + -3.8101))\n",
      "21          8.342e-04  5.160e-03  y = ((-3.8105 + (sin(x₀) * x₀)) + (sin(x₄) * 2.7158)) + ((...\n",
      "                                      x₂ + x₄) * -0.034059)\n",
      "23          8.247e-04  5.693e-03  y = (sin(x₀) * x₀) + ((((x₄ * -2.2138) + 4.7787) * ((x₂ * ...\n",
      "                                      -0.0086564) + exp(x₄))) + -8.5778)\n",
      "25          7.889e-04  2.224e-02  y = ((((x₂ * -0.0047495) + exp(x₄ * 0.68234)) * ((x₄ * -3....\n",
      "                                      0799) + 8.5074)) + -12.322) + (x₀ * sin(x₀))\n",
      "27          7.880e-04  5.601e-04  y = ((x₀ * sin(x₀)) + (((exp(x₄ * 0.68094) + (x₂ * -0.0047...\n",
      "                                      239)) * ((x₄ * -3.0792) + 8.5138)) + -12.317)) * 1.0035\n",
      "30          7.880e-04  3.974e-08  y = ((x₀ * sin(x₀)) + (((exp(x₄ * 0.68094) + sin(x₂ * -0.0...\n",
      "                                      047239)) * ((x₄ * -3.0792) + 8.5138)) + -12.317)) * 1.0035\n",
      "───────────────────────────────────────────────────────────────────────────────────────────────────\n",
      "════════════════════════════════════════════════════════════════════════════════════════════════════\n",
      "Press 'q' and then <enter> to stop execution early.\n",
      "\n",
      "Expressions evaluated per second: 4.090e+05\n",
      "Progress: 9426 / 12400 total iterations (76.016%)\n",
      "════════════════════════════════════════════════════════════════════════════════════════════════════\n",
      "───────────────────────────────────────────────────────────────────────────────────────────────────\n",
      "Complexity  Loss       Score      Equation\n",
      "1           4.968e-01  0.000e+00  y = -2.2854\n",
      "3           2.067e-01  4.386e-01  y = x₄ + -2.7857\n",
      "5           7.297e-02  5.205e-01  y = (x₄ * 2.281) + -3.4268\n",
      "7           8.081e-03  1.100e+00  y = ((x₄ * 2.2894) + -3.9371) + x₀\n",
      "9           5.517e-03  1.908e-01  y = ((x₄ * 2.2925) + -3.7747) + (x₀ * x₀)\n",
      "10          5.294e-03  4.124e-02  y = ((sin(x₄) * 2.6749) + x₀) + -4.0234\n",
      "11          3.904e-03  3.046e-01  y = ((x₀ * 0.86744) * x₀) + ((x₄ * 2.291) + -3.7285)\n",
      "12          2.679e-03  3.767e-01  y = ((sin(x₄) * 2.6787) + (x₀ * x₀)) + -3.8611\n",
      "14          9.952e-04  4.951e-01  y = (((x₀ * 0.86458) * x₀) + (sin(x₄) * 2.6772)) + -3.814\n",
      "15          9.312e-04  6.651e-02  y = ((sin(x₄) * 2.6764) + -3.8264) + (x₀ * sin(x₀))\n",
      "16          8.887e-04  4.662e-02  y = (((x₀ * (x₀ + 0.19331)) * 0.73199) + -3.8401) + (sin(x...\n",
      "                                      ₄) * 2.6767)\n",
      "18          8.467e-04  2.426e-02  y = ((x₀ + 0.19148) * (x₀ * 0.73271)) + ((sin(x₄ * 1.0596)...\n",
      "                                       * 2.575) + -3.8507)\n",
      "19          8.428e-04  4.506e-03  y = (x₂ * -0.032586) + ((sin(x₄) * 2.6762) + ((x₀ * sin(x₀...\n",
      "                                      )) + -3.8101))\n",
      "21          8.342e-04  5.161e-03  y = ((x₄ + x₂) * -0.034067) + (((x₀ * sin(x₀)) + -3.8105) ...\n",
      "                                      + (sin(x₄) * 2.7158))\n",
      "23          8.116e-04  1.372e-02  y = ((x₂ + (x₄ * x₄)) * -0.036053) + (((x₀ * sin(x₀)) + -3...\n",
      "                                      .8153) + (sin(x₄) * 2.7172))\n",
      "25          7.889e-04  1.421e-02  y = ((((x₄ * -3.0799) + 8.5074) * ((x₂ * -0.004747) + exp(...\n",
      "                                      x₄ * 0.68234))) + -12.322) + (x₀ * sin(x₀))\n",
      "27          7.880e-04  5.590e-04  y = (((x₀ * sin(x₀)) + (((x₂ * -0.0047235) + exp(x₄ * 0.68...\n",
      "                                      094)) * ((x₄ * -3.0792) + 8.5138))) + -12.317) * 1.0035\n",
      "29          7.880e-04  9.090e-06  y = (((((x₂ * -0.0047072) + exp(x₄ * 0.68074)) * ((x₄ * -3...\n",
      "                                      .079) + 8.5148)) + -12.316) * 1.0039) + ((x₀ * 1.0033) * s...\n",
      "                                      in(x₀))\n",
      "───────────────────────────────────────────────────────────────────────────────────────────────────\n",
      "════════════════════════════════════════════════════════════════════════════════════════════════════\n",
      "Press 'q' and then <enter> to stop execution early.\n",
      "\n",
      "Expressions evaluated per second: 4.040e+05\n",
      "Progress: 11349 / 12400 total iterations (91.524%)\n",
      "════════════════════════════════════════════════════════════════════════════════════════════════════\n",
      "───────────────────────────────────────────────────────────────────────────────────────────────────\n",
      "Complexity  Loss       Score      Equation\n",
      "1           4.968e-01  0.000e+00  y = -2.2854\n",
      "3           2.067e-01  4.386e-01  y = x₄ + -2.7857\n",
      "5           7.297e-02  5.205e-01  y = (x₄ * 2.281) + -3.4268\n",
      "7           8.081e-03  1.100e+00  y = ((x₄ * 2.2894) + -3.9371) + x₀\n",
      "9           5.517e-03  1.908e-01  y = ((x₄ * 2.2925) + -3.7747) + (x₀ * x₀)\n",
      "10          5.294e-03  4.124e-02  y = ((sin(x₄) * 2.6749) + x₀) + -4.0234\n",
      "11          3.904e-03  3.046e-01  y = ((x₀ * 0.86744) * x₀) + ((x₄ * 2.291) + -3.7285)\n",
      "12          2.679e-03  3.767e-01  y = ((sin(x₄) * 2.6787) + (x₀ * x₀)) + -3.8611\n",
      "14          9.952e-04  4.951e-01  y = (((x₀ * 0.86458) * x₀) + (sin(x₄) * 2.6772)) + -3.814\n",
      "15          9.312e-04  6.651e-02  y = ((sin(x₄) * 2.6764) + (x₀ * sin(x₀))) + -3.8264\n",
      "16          8.887e-04  4.662e-02  y = (((x₀ * (x₀ + 0.19331)) * 0.73199) + -3.8401) + (sin(x...\n",
      "                                      ₄) * 2.6767)\n",
      "17          8.878e-04  1.021e-03  y = (x₀ * sin(x₀)) + ((sin(x₄ * 1.0606) * 2.5732) + -3.837...\n",
      "                                      6)\n",
      "18          8.467e-04  4.749e-02  y = ((x₀ + 0.19148) * (x₀ * 0.73271)) + ((sin(x₄ * 1.0596)...\n",
      "                                       * 2.575) + -3.8507)\n",
      "19          8.428e-04  4.506e-03  y = (x₂ * -0.032586) + ((sin(x₄) * 2.6762) + ((x₀ * sin(x₀...\n",
      "                                      )) + -3.8101))\n",
      "20          8.055e-04  4.529e-02  y = ((2.6764 * sin(x₄)) + -3.8239) + ((x₂ * -0.031773) + (...\n",
      "                                      (x₀ * (x₀ + 0.18648)) * 0.73729))\n",
      "22          7.973e-04  5.137e-03  y = ((((x₀ + 0.18505) * (x₀ * 0.73811)) + -3.8239) + ((x₂ ...\n",
      "                                      + x₄) * -0.033286)) + (sin(x₄) * 2.7148)\n",
      "24          7.703e-04  1.723e-02  y = (((x₀ + 0.18553) * x₀) * 0.73907) + (-3.8371 + ((((x₄ ...\n",
      "                                      * -0.069494) + 2.7465) * sin(x₄)) + (x₂ * -0.029261)))\n",
      "26          7.613e-04  5.836e-03  y = (((((x₀ + 0.22055) * x₀) * 0.73583) + -3.8421) + (x₂ *...\n",
      "                                       -0.031699)) + (sin(x₄) * (((x₀ * -0.080288) * x₄) + 2.716...\n",
      "                                      1))\n",
      "28          7.471e-04  9.465e-03  y = (((((((x₄ + x₀) * -0.045314) * x₄) + 2.7384) * sin(x₄)...\n",
      "                                      ) + -3.8421) + (x₂ * -0.0303)) + (((x₀ + 0.19675) * 0.7415...\n",
      "                                      7) * x₀)\n",
      "───────────────────────────────────────────────────────────────────────────────────────────────────\n",
      "════════════════════════════════════════════════════════════════════════════════════════════════════\n",
      "Press 'q' and then <enter> to stop execution early.\n",
      "───────────────────────────────────────────────────────────────────────────────────────────────────\n",
      "Complexity  Loss       Score      Equation\n",
      "1           4.968e-01  0.000e+00  y = -2.2854\n",
      "3           2.067e-01  4.386e-01  y = x₄ + -2.7857\n",
      "5           7.297e-02  5.205e-01  y = (x₄ * 2.281) + -3.4268\n",
      "7           8.081e-03  1.100e+00  y = ((x₄ * 2.2894) + -3.9371) + x₀\n",
      "9           5.517e-03  1.908e-01  y = ((x₄ * 2.2925) + -3.7747) + (x₀ * x₀)\n",
      "10          5.294e-03  4.124e-02  y = ((sin(x₄) * 2.6749) + x₀) + -4.0234\n",
      "11          3.904e-03  3.046e-01  y = ((x₀ * 0.86744) * x₀) + ((x₄ * 2.291) + -3.7285)\n",
      "12          2.679e-03  3.767e-01  y = ((sin(x₄) * 2.6787) + (x₀ * x₀)) + -3.8611\n",
      "14          9.952e-04  4.951e-01  y = (((x₀ * 0.86458) * x₀) + (sin(x₄) * 2.6772)) + -3.814\n",
      "15          9.312e-04  6.651e-02  y = ((sin(x₄) * 2.6764) + (x₀ * sin(x₀))) + -3.8264\n",
      "16          8.887e-04  4.662e-02  y = (((x₀ * (x₀ + 0.19331)) * 0.73199) + -3.8401) + (sin(x...\n",
      "                                      ₄) * 2.6767)\n",
      "17          8.878e-04  1.021e-03  y = (x₀ * sin(x₀)) + ((sin(x₄ * 1.0606) * 2.5732) + -3.837...\n",
      "                                      6)\n",
      "18          8.467e-04  4.749e-02  y = ((x₀ + 0.19148) * (x₀ * 0.73271)) + ((sin(x₄ * 1.0596)...\n",
      "                                       * 2.575) + -3.8507)\n",
      "19          8.428e-04  4.506e-03  y = (x₂ * -0.032586) + ((sin(x₄) * 2.6762) + ((x₀ * sin(x₀...\n",
      "                                      )) + -3.8101))\n",
      "20          8.054e-04  4.541e-02  y = (sin(x₄) * 2.6766) + ((((x₀ * (x₀ + 0.19586)) + (x₂ * ...\n",
      "                                      -0.043378)) * 0.73155) + -3.8249)\n",
      "22          7.972e-04  5.132e-03  y = ((x₂ + x₄) * -0.033398) + ((((x₀ + 0.18878) * (x₀ * 0....\n",
      "                                      73606)) + -3.8249) + (sin(x₄) * 2.7159))\n",
      "24          7.680e-04  1.867e-02  y = (sin(x₄) * ((x₄ * -0.082957) + 2.7591)) + (((x₀ + 0.19...\n",
      "                                      413) * (x₀ * 0.73218)) + ((x₂ * -0.031855) + -3.8376))\n",
      "26          7.580e-04  6.550e-03  y = (((x₀ + 0.22968) * (x₀ * 0.73547)) + (x₂ * -0.031636))...\n",
      "                                       + ((sin(x₄) * (((x₄ + x₀) * -0.066475) + 2.7758)) + -3.84...\n",
      "                                      96)\n",
      "28          7.462e-04  7.813e-03  y = (((((x₄ * (x₀ + x₄)) * -0.047333) + 2.7414) * (sin(x₄)...\n",
      "                                       + (x₂ * -0.011585))) + ((x₀ + 0.20367) * (x₀ * 0.73781)))...\n",
      "                                       + -3.843\n",
      "30          7.451e-04  7.788e-04  y = (((-0.039003 * (x₄ * x₄)) * (x₀ + x₄)) + (((sin(x₄) * ...\n",
      "                                      2.7379) + (x₂ * -0.031365)) + -3.8427)) + ((x₀ + 0.20632) ...\n",
      "                                      * (x₀ * 0.73515))\n",
      "───────────────────────────────────────────────────────────────────────────────────────────────────\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "[ Info: Final population:\n",
      "[ Info: Results saved to:\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "=�Best equation for output 0 found to be (((x0 * 0.86457694) * x0) + (sin(x4) * 2.6771722)) + -3.8140268.\n",
      "d\u000f SR on model_4399178768 complete.\n"
     ]
    },
    {
     "data": {
      "text/plain": [
       "{0: PySRRegressor.equations_ = [\n",
       " \t    pick     score                                           equation  \\\n",
       " \t0         0.000000                                          -2.285363   \n",
       " \t1         0.438574                                     x4 + -2.785732   \n",
       " \t2         0.520495                       (x4 * 2.2810283) + -3.426758   \n",
       " \t3         1.100268                ((x4 * 2.2893555) + -3.937105) + x0   \n",
       " \t4         0.190844         ((x4 * 2.292543) + -3.7746532) + (x0 * x0)   \n",
       " \t5         0.041235          ((sin(x4) * 2.6749036) + x0) + -4.0233617   \n",
       " \t6         0.304577  ((x0 * 0.86744106) * x0) + ((x4 * 2.2910278) +...   \n",
       " \t7         0.376723    ((sin(x4) * 2.678712) + (x0 * x0)) + -3.8610668   \n",
       " \t8   >>>>  0.495051  (((x0 * 0.86457694) * x0) + (sin(x4) * 2.67717...   \n",
       " \t9         0.066508  ((sin(x4) * 2.6763525) + (x0 * sin(x0))) + -3....   \n",
       " \t10        0.046618  (((x0 * (x0 + 0.19331135)) * 0.7319883) + -3.8...   \n",
       " \t11        0.001021  (x0 * sin(x0)) + ((sin(x4 * 1.0605501) * 2.573...   \n",
       " \t12        0.047492  ((x0 + 0.19148223) * (x0 * 0.73270535)) + ((si...   \n",
       " \t13        0.004506  (x2 * -0.032585565) + ((sin(x4) * 2.6762452) +...   \n",
       " \t14        0.045414  (sin(x4) * 2.6766343) + ((((x0 * (x0 + 0.19586...   \n",
       " \t15        0.005132  ((x2 + x4) * -0.03339828) + ((((x0 + 0.1887847...   \n",
       " \t16        0.018667  (sin(x4) * ((x4 * -0.082956664) + 2.759057)) +...   \n",
       " \t17        0.006550  (((x0 + 0.2296809) * (x0 * 0.7354745)) + (x2 *...   \n",
       " \t18        0.007813  (((((x4 * (x0 + x4)) * -0.047333058) + 2.74142...   \n",
       " \t19        0.000779  (((-0.03900284 * (x4 * x4)) * (x0 + x4)) + (((...   \n",
       " \t\n",
       " \t        loss  complexity  \n",
       " \t0   0.496795           1  \n",
       " \t1   0.206650           3  \n",
       " \t2   0.072969           5  \n",
       " \t3   0.008081           7  \n",
       " \t4   0.005517           9  \n",
       " \t5   0.005294          10  \n",
       " \t6   0.003904          11  \n",
       " \t7   0.002679          12  \n",
       " \t8   0.000995          14  \n",
       " \t9   0.000931          15  \n",
       " \t10  0.000889          16  \n",
       " \t11  0.000888          17  \n",
       " \t12  0.000847          18  \n",
       " \t13  0.000843          19  \n",
       " \t14  0.000805          20  \n",
       " \t15  0.000797          22  \n",
       " \t16  0.000768          24  \n",
       " \t17  0.000758          26  \n",
       " \t18  0.000746          28  \n",
       " \t19  0.000745          30  \n",
       " ]}"
      ]
     },
     "execution_count": 14,
     "metadata": {},
     "output_type": "execute_result"
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  - SR_output/model_4399178768/dim0_1763377865/hall_of_fame.csv\n"
     ]
    }
   ],
   "source": [
    "symbolic_model.distill(torch.FloatTensor(X_test))"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "75c96d34",
   "metadata": {},
   "source": [
    "Results of the symbolic regression"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 44,
   "id": "c1bf1427",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "(((x0 * 0.86457694) * x0) + (sin(x4) * 2.6771722)) + -3.8140268\n"
     ]
    }
   ],
   "source": [
    "print(symbolic_model.pysr_regressor[0].get_best()[\"equation\"])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 46,
   "id": "62abc3c3",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Clean up \n",
    "\n",
    "import os\n",
    "import shutil\n",
    "if os.path.exists('SR_output'):\n",
    "    shutil.rmtree('SR_output')\n",
    "    os.remove('model_weights.pth')"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "symtorch_venv",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.13"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
