{% extends "base.html" %}
{% block content %}
<h1>Dataset {{ record.dataset_name }} {{ record.dataset_version }}</h1>
<p><a href="/datasets/{{ record.dataset_name }}">Back to versions</a></p>
<p>
  Contract:
  {% if record.contract_id %}
    <a href="/contracts/{{ record.contract_id }}">{{ record.contract_id }}</a>
    {% if record.contract_version %}
      <a href="/contracts/{{ record.contract_id }}/{{ record.contract_version }}">{{ record.contract_version }}</a>
    {% else %}
      <span class="text-muted">No version</span>
    {% endif %}
  {% else %}
    <span class="text-muted">No contract recorded for this run.</span>
  {% endif %}
</p>
{% if record.contract_id and record.draft_contract_version %}
<p>Draft Contract: <a href="/contracts/{{ record.contract_id }}/{{ record.draft_contract_version }}">{{ record.draft_contract_version }}</a></p>
{% endif %}
{% if data_products %}
<h2>Data product associations</h2>
<div class="row g-3">
  {% for entry in data_products %}
  <div class="col-12">
    <div class="card h-100">
      <div class="card-header d-flex flex-wrap justify-content-between align-items-center">
        <div>
          {% if entry.product_id %}
            <a href="/data-products/{{ entry.product_id }}">{{ entry.product_name or entry.product_id }}</a>
          {% else %}
            <span class="text-muted">Unknown product</span>
          {% endif %}
          {% if entry.direction %}
            <span class="badge bg-secondary text-uppercase ms-2">{{ entry.direction }}</span>
          {% endif %}
        </div>
        {% if entry.latest_status_label %}
          <span class="badge {{ entry.latest_status_badge }}">{{ entry.latest_status_label }}</span>
        {% endif %}
      </div>
      <div class="card-body">
        <dl class="row mb-0">
          <dt class="col-sm-3">Port</dt>
          <dd class="col-sm-9">
            {% if entry.port_name %}<code>{{ entry.port_name }}</code>{% else %}<span class="text-muted">n/a</span>{% endif %}
            {% if entry.port_version %}<span class="text-muted ms-2">{{ entry.port_version }}</span>{% endif %}
          </dd>
          <dt class="col-sm-3">Contract</dt>
          <dd class="col-sm-9">
            {% if entry.contract_id %}
              <a href="/contracts/{{ entry.contract_id }}">{{ entry.contract_id }}</a>
            {% else %}
              <span class="text-muted">Unknown</span>
            {% endif %}
            {% if entry.contract_version %}
              {% if entry.contract_id %}<span class="text-muted">/</span>{% endif %}
              <a href="/contracts/{{ entry.contract_id }}/{{ entry.contract_version }}">{{ entry.contract_version }}</a>
            {% endif %}
          </dd>
          <dt class="col-sm-3">Latest dataset</dt>
          <dd class="col-sm-9">
            {% if entry.latest_dataset_version %}
              <span class="text-monospace">{{ entry.latest_dataset_version }}</span>
            {% else %}
              <span class="text-muted">n/a</span>
            {% endif %}
          </dd>
        </dl>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}
{% set output_details = record.dq_details.get('output', {}) %}
<p>Status: {{ record.status }} | Run type: {{ record.run_type }}</p>
{% if record.observation_label or record.observation_scope %}
<p class="text-muted">
  Observation scope:
  {{ record.observation_label or record.observation_scope.replace('_', ' ').title() }}
  {% if record.observation_operation %}
    <span class="text-lowercase">({{ record.observation_operation }} run)</span>
  {% endif %}
</p>
{% endif %}
{% if output_details.get('violation_strategy') %}
<p><strong>Violation strategy:</strong> {{ output_details.get('violation_strategy') }}</p>
{% endif %}
{% set warnings = output_details.get('warnings', []) %}
{% if warnings %}
<div class="alert alert-warning">
  <strong>Warnings</strong>
  <ul class="mb-0">
    {% for warning in warnings %}
    <li>{{ warning }}</li>
    {% endfor %}
  </ul>
</div>
{% endif %}
{% include "includes/metrics_summary.html" %}
{% set aux = output_details.get('auxiliary_datasets', []) %}
{% if aux %}
<h2>Auxiliary datasets</h2>
<table class="table table-sm">
  <thead><tr><th>Kind</th><th>Dataset</th><th>Path</th></tr></thead>
  <tbody>
  {% for entry in aux %}
  <tr>
    <td class="text-capitalize">{{ entry.kind }}</td>
    <td><code>{{ entry.dataset }}</code></td>
    <td>{% if entry.path %}<code>{{ entry.path }}</code>{% else %}<span class="text-muted">n/a</span>{% endif %}</td>
  </tr>
  {% endfor %}
  </tbody>
</table>
{% endif %}
{% set fails = output_details.get('failed_expectations', {}) %}
<h2>Data Quality</h2>
{% if fails %}
<table class="table table-sm">
  <thead><tr><th>Name</th><th>Predicate</th><th>Count</th></tr></thead>
  <tbody>
  {% for key, info in fails.items() %}
  <tr><td>{{ key }}</td><td><code>{{ info.expression }}</code></td><td>{{ info.count }}</td></tr>
  {% endfor %}
  </tbody>
</table>
{% else %}
<p>No data quality failures.</p>
{% endif %}
{% set schema_errors = output_details.get('errors', []) %}
{% if schema_errors %}
<div class="alert alert-danger">
  <strong>Schema errors</strong>
  <ul class="mb-0">
    {% for err in schema_errors %}
    <li>{{ err }}</li>
    {% endfor %}
  </ul>
</div>
{% endif %}
{% set pipeline_activity = output_details.get('pipeline_activity', []) %}
{% if pipeline_activity %}
<h2>Pipeline activity</h2>
{% for entry in pipeline_activity %}
  <div class="card mb-3">
    <div class="card-header">
      <strong>Dataset version:</strong> {{ entry.dataset_version or 'unknown' }}
      {% if entry.contract_id and entry.contract_version %}
        <span class="ms-2 text-muted">Contract {{ entry.contract_id }}:{{ entry.contract_version }}</span>
      {% endif %}
    </div>
    <div class="card-body p-0">
      {% set events = entry.events or [] %}
      {% if events %}
      <div class="table-responsive">
        <table class="table table-sm mb-0">
          <thead>
            <tr>
              <th scope="col">Recorded at</th>
              <th scope="col">Operation</th>
              <th scope="col">DQ Status</th>
              <th scope="col">Context</th>
            </tr>
          </thead>
          <tbody>
            {% for event in events %}
            <tr>
              <td><code>{{ event.recorded_at or 'n/a' }}</code></td>
              <td>{{ event.operation or 'unknown' }}</td>
              <td>
                {% if event.dq_status %}
                  <span class="badge bg-secondary text-uppercase">{{ event.dq_status }}</span>
                {% else %}
                  <span class="text-muted">n/a</span>
                {% endif %}
              </td>
              <td><pre class="small mb-0">{{ event.pipeline_context or {} | tojson(indent=2) }}</pre></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <p class="m-3 text-muted">No activity recorded.</p>
      {% endif %}
    </div>
  </div>
{% endfor %}
{% endif %}
<h2>Details</h2>
<pre class="small">{{ output_details | tojson(indent=2) }}</pre>
{% if data_preview %}
<h2>Data</h2>
<pre class="small">{{ data_preview }}</pre>
{% endif %}
{% endblock %}
{% block page_scripts %}
{{ super() }}
{% include "includes/metrics_chart_script.html" %}
{% endblock %}

