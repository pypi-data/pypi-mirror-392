var I=Object.defineProperty;var o=(c,e)=>I(c,"name",{value:e,configurable:!0});import{ref as h,watch as R,onBeforeUnmount as L,reactive as k,defineComponent as A,computed as S,onUnmounted as M,openBlock as b,createElementBlock as y,normalizeClass as C,createBlock as O,unref as z,createCommentVNode as w,normalizeStyle as j,createElementVNode as E}from"vue";import x from"primevue/skeleton";const q=""+new URL("images/default-template.png",import.meta.url).href;function B(c,e,t={}){const{immediate:a=!0,...r}=t,s=typeof window<"u"&&"IntersectionObserver"in window,l=h(!1);let n=null;const d=o(()=>{n&&(n.disconnect(),n=null)},"cleanup"),m=o(()=>{d(),!(!s||!c.value)&&(n=new IntersectionObserver(v=>{l.value=v.some(U=>U.isIntersecting),e(v,n)},r),n.observe(c.value))},"observe"),g=o(()=>{n&&c.value&&n.unobserve(c.value)},"unobserve");return a&&R(c,m,{immediate:!0,flush:"post"}),L(d),{isSupported:s,isIntersecting:l,observe:m,unobserve:g,cleanup:d}}o(B,"useIntersectionObserver");class D{static{o(this,"MediaCacheService")}cache=k(new Map);maxSize;maxAge;cleanupInterval=null;urlRefCount=new Map;constructor(e={}){this.maxSize=e.maxSize??100,this.maxAge=e.maxAge??30*60*1e3,this.startCleanupInterval()}startCleanupInterval(){this.cleanupInterval=window.setInterval(()=>{this.cleanup()},5*60*1e3)}cleanup(){const e=Date.now(),t=[];for(const[a,r]of Array.from(this.cache.entries()))e-r.lastAccessed>this.maxAge&&(r.objectUrl?(this.urlRefCount.get(r.objectUrl)||0)===0&&(URL.revokeObjectURL(r.objectUrl),this.urlRefCount.delete(r.objectUrl),t.push(a)):t.push(a));if(t.forEach(a=>this.cache.delete(a)),this.cache.size>this.maxSize){const a=Array.from(this.cache.entries());a.sort((l,n)=>l[1].lastAccessed-n[1].lastAccessed);let r=0;const s=this.cache.size-this.maxSize;for(const[l,n]of a){if(r>=s)break;n.objectUrl?(this.urlRefCount.get(n.objectUrl)||0)===0&&(URL.revokeObjectURL(n.objectUrl),this.urlRefCount.delete(n.objectUrl),this.cache.delete(l),r++):(this.cache.delete(l),r++)}}}async getCachedMedia(e){let t=this.cache.get(e);if(t)return t.lastAccessed=Date.now(),t;t={src:e,isLoading:!0,lastAccessed:Date.now()},this.cache.set(e,t);try{const a=await fetch(e,{cache:"force-cache"});if(!a.ok)throw new Error(`Failed to fetch: ${a.status}`);const r=await a.blob(),s=URL.createObjectURL(r),l={src:e,blob:r,objectUrl:s,isLoading:!1,lastAccessed:Date.now()};return this.cache.set(e,l),l}catch(a){console.warn("Failed to cache media:",e,a);const r={src:e,error:!0,isLoading:!1,lastAccessed:Date.now()};return this.cache.set(e,r),r}}acquireUrl(e){const t=this.cache.get(e);if(t?.objectUrl){const a=this.urlRefCount.get(t.objectUrl)||0;return this.urlRefCount.set(t.objectUrl,a+1),t.objectUrl}}releaseUrl(e){const t=this.cache.get(e);if(t?.objectUrl){const a=(this.urlRefCount.get(t.objectUrl)||1)-1;a<=0?(URL.revokeObjectURL(t.objectUrl),this.urlRefCount.delete(t.objectUrl),this.cache.delete(e)):this.urlRefCount.set(t.objectUrl,a)}}clearCache(){for(const e of Array.from(this.cache.values()))e.objectUrl&&URL.revokeObjectURL(e.objectUrl);this.cache.clear(),this.urlRefCount.clear()}destroy(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null),this.clearCache()}}let u=null;function N(c){return u||(u=new D(c)),{getCachedMedia:o(s=>u.getCachedMedia(s),"getCachedMedia"),clearCache:o(()=>u.clearCache(),"clearCache"),acquireUrl:o(s=>u.acquireUrl(s),"acquireUrl"),releaseUrl:o(s=>u.releaseUrl(s),"releaseUrl"),cache:u.cache}}o(N,"useMediaCache");typeof window<"u"&&window.addEventListener("beforeunload",()=>{u&&u.destroy()});const F=["src","alt"],W={key:2,class:"absolute inset-0 flex items-center justify-center"},T=["alt"],H=A({__name:"LazyImage",props:{src:{},alt:{default:""},containerClass:{type:[Array,Object,String,Number,null,Boolean],default:""},imageClass:{type:[Array,Object,String,Number,null,Boolean],default:""},imageStyle:{},rootMargin:{default:"300px"}},setup(c){const e=h(null),t=h(null),a=h(!1),r=h(!1),s=h(!1),l=h(void 0),{getCachedMedia:n,acquireUrl:d,releaseUrl:m}=N();B(e,i=>{const f=i[0];a.value=f?.isIntersecting??!1},{rootMargin:c.rootMargin,threshold:.1});const g=S(()=>a.value);R(g,async i=>{if(i&&c.src&&!l.value&&!s.value)try{const f=await n(c.src);if(f.error)s.value=!0;else if(f.objectUrl){const p=d(c.src);l.value=p||f.objectUrl}else l.value=c.src}catch(f){console.warn("Failed to load cached media:",f),l.value=c.src}else i||(l.value?.startsWith("blob:")&&m(c.src),r.value=!1,l.value=void 0,s.value=!1)},{immediate:!0});const v=o(()=>{r.value=!0,s.value=!1},"onImageLoad"),U=o(()=>{s.value=!0,r.value=!1},"onImageError");return M(()=>{l.value?.startsWith("blob:")&&m(c.src)}),(i,f)=>(b(),y("div",{ref_key:"containerRef",ref:e,class:C(["relative flex h-full w-full items-center justify-center overflow-hidden",i.containerClass])},[r.value?w("",!0):(b(),O(z(x),{key:0,width:"100%",height:"100%",class:"absolute inset-0"})),l.value?(b(),y("img",{key:1,ref_key:"imageRef",ref:t,src:l.value,alt:i.alt,draggable:"false",class:C(i.imageClass),style:j(i.imageStyle),onLoad:v,onError:U},null,46,F)):w("",!0),s.value?(b(),y("div",W,[E("img",{src:q,alt:i.alt,draggable:"false",class:C(i.imageClass),style:j(i.imageStyle)},null,14,T)])):w("",!0)],2))}});export{q as _,H as a,B as u};
//# sourceMappingURL=LazyImage.vue_vue_type_script_setup_true_lang-BEjdi0-r.js.map
