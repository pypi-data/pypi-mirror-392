var $=Object.defineProperty;var t=(l,r)=>$(l,"name",{value:r,configurable:!0});import{markRaw as G,openBlock as b,createElementBlock as k,createElementVNode as h,ref as m,nextTick as K,onUnmounted as j,defineComponent as J,mergeModels as Q,computed as H,useModel as X,onMounted as Y,createVNode as U,unref as o,withCtx as Z,createTextVNode as ee,toDisplayString as V,Fragment as te,renderList as ae,normalizeStyle as oe,createCommentVNode as F}from"vue";import{Button as ne}from"primevue";import{r as N,t as R,L as re,y as q}from"./index-CU6LcO2W.js";import{u as O}from"./audioService-ra-tbr89.js";import{ck as ie,cl as le}from"./vendor-other-BpgYsL4Z.js";import{f as ue}from"./audioUtils-B1PPkNHb.js";import"@primevue/themes";import"@primevue/themes/aura";import"./vendor-vue-C7sAPp8E.js";import"primevue/config";import"primevue/confirmationservice";import"primevue/toastservice";import"primevue/tooltip";import"primevue/button";import"vue-i18n";import"primevue/message";import"primevue/skeleton";import"primevue/multiselect";import"primevue/inputtext";import"primevue/select";import"primevue/checkbox";import"primevue/divider";import"primevue/scrollpanel";import"primevue/usetoast";import"primevue/card";import"primevue/listbox";import"primevue/progressbar";import"primevue/floatlabel";import"@primevue/forms";import"@primevue/forms/resolvers/zod";import"primevue/password";import"primevue/progressspinner";import"primevue/tag";import"primevue/inputnumber";import"primevue/tabpanels";import"primevue/tabs";import"primevue/iconfield";import"primevue/inputicon";import"primevue/badge";import"primevue/chip";import"primevue/tabpanel";import"primevue/toggleswitch";import"primevue/colorpicker";import"primevue/radiobutton";import"primevue/knob";import"primevue/slider";import"primevue/panel";import"primevue/tabmenu";import"primevue/popover";import"primevue/tab";import"primevue/tablist";import"primevue/autocomplete";import"primevue/dropdown";import"./vendor-xterm-DV1MVhAx.js";import"./vendor-three-zdhtZbSm.js";import"primevue/galleria";import"primevue/contextmenu";import"primevue/tree";import"primevue/toolbar";import"primevue/selectbutton";import"primevue/dialog";import"primevue/confirmpopup";import"primevue/useconfirm";import"primevue/confirmdialog";import"./vendor-tiptap-mfowjb53.js";import"primevue/blockui";const se={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function ce(l,r){return b(),k("svg",se,r[0]||(r[0]=[h("g",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2"},[h("path",{d:"M12 19v3m7-12v2a7 7 0 0 1-14 0v-2"}),h("rect",{width:"6",height:"13",x:"9",y:"2",rx:"3"})],-1)]))}t(ce,"render");const de=G({name:"lucide-mic",render:ce});function me(l,r={}){const n=m(!1),p=m(0),u=m(null);async function e(){if(!l.value)return!1;try{return await l.value.play(),n.value=!0,!0}catch(A){return console.warn("Audio playback failed:",A),n.value=!1,!1}}t(e,"play");function a(){l.value&&(l.value.pause(),l.value.currentTime=0),n.value=!1,r.onPlaybackEnded&&r.onPlaybackEnded()}t(a,"stop");function s(){n.value=!1,r.onPlaybackEnded&&r.onPlaybackEnded()}t(s,"onPlaybackEnded");function g(){l.value?.duration&&r.onMetadataLoaded&&r.onMetadataLoaded(l.value.duration)}t(g,"onMetadataLoaded");async function f(){p.value+=1,await K()}t(f,"resetAudioElement");function i(){return l.value?.currentTime||0}t(i,"getCurrentTime");function y(){return l.value?.duration||0}return t(y,"getDuration"),{isPlaying:n,audioElementKey:p,play:e,stop:a,onPlaybackEnded:s,onMetadataLoaded:g,resetAudioElement:f,getCurrentTime:i,getDuration:y,playbackTimerInterval:u}}t(me,"useAudioPlayback");function ve(l={}){const r=m(!1),n=m(null),p=m([]),u=m(null),e=m(null);async function a(){try{e.value?.startsWith("blob:")&&URL.revokeObjectURL(e.value),p.value=[],e.value=null,await O().registerWavEncoder(),u.value=await navigator.mediaDevices.getUserMedia({audio:!0}),n.value=new ie(u.value,{mimeType:"audio/wav"}),n.value.ondataavailable=i=>{p.value.push(i.data)},n.value.onstop=async()=>{const i=new Blob(p.value,{type:"audio/wav"});e.value?.startsWith("blob:")&&URL.revokeObjectURL(e.value),e.value=URL.createObjectURL(i),l.onRecordingComplete&&await l.onRecordingComplete(i),g()},n.value.start(100),r.value=!0}catch(i){throw l.onError&&l.onError(i),i}}t(a,"startRecording");function s(){n.value&&n.value.state!=="inactive"?n.value.stop():g()}t(s,"stopRecording");function g(){r.value=!1,u.value&&(u.value.getTracks().forEach(i=>i.stop()),u.value=null)}t(g,"cleanup");function f(){s(),e.value&&(URL.revokeObjectURL(e.value),e.value=null)}return t(f,"dispose"),j(()=>{f()}),{isRecording:r,recordedURL:e,mediaRecorder:n,startRecording:a,stopRecording:s,dispose:f}}t(ve,"useAudioRecorder");function pe(l={}){const{barCount:r=18,minHeight:n=4,maxHeight:p=32}=l,u=m(Array.from({length:r},()=>({height:16}))),e=m(null),a=m(null),s=m(null),g=m(null),f=m(null);function i(){u.value=Array.from({length:r},()=>({height:Math.random()*(p-n)+n}))}t(i,"initWaveform");function y(v){v.value&&(a.value&&s.value?A():w(),g.value=requestAnimationFrame(()=>y(v)))}t(y,"updateWaveform");function A(){if(!a.value||!s.value)return;a.value.getByteFrequencyData(s.value);const v=Math.floor(s.value.length/r);u.value=u.value.map((z,I)=>{let S=0;for(let P=0;P<v;P++)S+=s.value[I*v+P]||0;return{height:S/v/255*(p-n)+n}})}t(A,"updateWaveformFromAudio");function w(){u.value=u.value.map(v=>({height:Math.max(n,Math.min(p,v.height+(Math.random()-.5)*4))}))}t(w,"updateWaveformRandom");async function W(){e.value&&e.value.state!=="closed"&&await e.value.close(),e.value=null,f.value=null}t(W,"setupAudioContext");async function M(v){e.value=new window.AudioContext,a.value=e.value.createAnalyser(),e.value.createMediaStreamSource(v).connect(a.value),a.value.fftSize=256,s.value=new Uint8Array(a.value.frequencyBinCount)}t(M,"setupRecordingVisualization");async function C(v){return e.value&&e.value.state!=="closed"&&await e.value.close(),f.value=null,v?(e.value=new window.AudioContext,a.value=e.value.createAnalyser(),f.value=e.value.createMediaElementSource(v),f.value.connect(a.value),a.value.connect(e.value.destination),a.value.fftSize=256,s.value=new Uint8Array(a.value.frequencyBinCount),!0):!1}t(C,"setupPlaybackVisualization");function T(){g.value&&(cancelAnimationFrame(g.value),g.value=null)}t(T,"stopWaveform");function L(){T(),e.value&&e.value.state!=="closed"&&e.value.close(),e.value=null,f.value=null}return t(L,"dispose"),j(()=>{L()}),{waveformBars:u,initWaveform:i,updateWaveform:y,setupAudioContext:W,setupRecordingVisualization:M,setupPlaybackVisualization:C,stopWaveform:T,dispose:L}}t(pe,"useAudioWaveform");const fe={class:"relative"},ge={class:"mb-4"},ye={key:0,class:"flex h-14 w-full items-center gap-4 rounded-lg px-4 bg-node-component-surface text-text-secondary"},he={class:"flex min-w-30 items-center gap-2"},be={class:"min-w-20 text-xs"},ke={class:"min-w-10 text-sm"},we={class:"flex h-8 flex-1 items-center gap-2 overflow-x-clip"},xe=["title"],Re=["title"],_e=["title"],Ae=["title"],Ce=["src"],jt=J({__name:"WidgetRecordAudio",props:Q({widget:{},readonly:{type:Boolean},nodeId:{}},{modelValue:{default:""},modelModifiers:{}}),emits:["update:modelValue"],setup(l){const r=l,n=m();let p="";const u=ve({onRecordingComplete:L,onError:t(()=>{q().addAlert(R("g.micPermissionDenied")||"Microphone permission denied")},"onError")}),e=pe({barCount:18,minHeight:4,maxHeight:32}),a=me(n,{onPlaybackEnded:B,onMetadataLoaded:t(d=>{!w.value&&!i.value&&(s.value=Math.floor(d))},"onMetadataLoaded")}),s=m(0),{pause:g,resume:f}=le(()=>{s.value+=1},1e3,{immediate:!1}),{isRecording:i,recordedURL:y}=u,{waveformBars:A}=e,{isPlaying:w,audioElementKey:W}=a,M=H(()=>i.value||w.value),C=X(l,"modelValue"),T=H(()=>!r.nodeId||!N.rootGraph?null:N.rootGraph.getNodeById(r.nodeId));async function L(d){try{const c=await O().convertBlobToFileAndSubmit(d);C.value=c,p=c}catch{q().addAlert("Failed to upload recorded audio")}}t(L,"handleRecordingComplete");async function v(){if(!r.readonly)try{if(await e.setupAudioContext(),await u.startRecording(),u.mediaRecorder.value){const d=u.mediaRecorder.value.stream;d&&await e.setupRecordingVisualization(d)}s.value=0,f(),e.initWaveform(),e.updateWaveform(M)}catch(d){console.error("Failed to start recording:",d)}}t(v,"handleStartRecording");function z(){u.stopRecording(),g(),e.stopWaveform()}t(z,"handleStopRecording");async function I(){if(!y.value||(s.value=0,await a.resetAudioElement(),await new Promise(_=>setTimeout(_,50)),!n.value)||!await e.setupPlaybackVisualization(n.value))return;await a.play(),e.initWaveform(),e.updateWaveform(M);const c=setInterval(()=>{s.value=Math.floor(a.getCurrentTime())},100);a.playbackTimerInterval.value=c}t(I,"handlePlayRecording");function S(){a.stop(),B()}t(S,"handleStopPlayback");function B(){e.stopWaveform(),a.playbackTimerInterval.value!==null&&(clearInterval(a.playbackTimerInterval.value),a.playbackTimerInterval.value=null);const d=a.getDuration();d?s.value=Math.floor(d):s.value=0}t(B,"handlePlaybackEnded");async function D(){return i.value&&u.mediaRecorder.value&&(u.mediaRecorder.value.stop(),await new Promise((d,c)=>{let _=0;const x=50,E=t(()=>{!i.value&&C.value?d(void 0):++_>=x?c(new Error("Recording serialization timeout after 5 seconds")):setTimeout(E,100)},"checkRecording");E()})),C.value||p||""}t(D,"serializeValue");function P(){const d=T.value;if(!d?.widgets)return;const c=d.widgets.find(_=>_.name==="audio");c&&(c.serializeValue=D)}return t(P,"registerWidgetSerialization"),Y(()=>{e.initWaveform(),P()}),j(()=>{a.playbackTimerInterval.value!==null&&(clearInterval(a.playbackTimerInterval.value),a.playbackTimerInterval.value=null)}),(d,c)=>{const _=de;return b(),k("div",fe,[h("div",ge,[U(o(ne),{class:"text-text-secondary w-full border-0 bg-secondary-background hover:bg-secondary-background-hover",disabled:o(i)||d.readonly,onClick:v},{default:Z(()=>[ee(V(o(R)("g.startRecording","Start Recording"))+" ",1),U(_,{class:"ml-1"})]),_:1},8,["disabled"])]),o(i)||o(w)||o(y)?(b(),k("div",ye,[h("div",he,[h("span",be,V(o(i)?o(R)("g.listening","Listening..."):o(w)?o(R)("g.playing","Playing..."):o(y)?o(R)("g.ready","Ready"):""),1),h("span",ke,V(o(ue)(s.value)),1)]),h("div",we,[(b(!0),k(te,null,ae(o(A),(x,E)=>(b(),k("div",{key:E,class:"max-h-8 min-h-1 w-0.75 rounded-[1.5px] bg-slate-100 transition-all duration-100",style:oe({height:x.height+"px"}),title:`Bar ${E+1}: ${x.height}px`},null,12,xe))),128))]),o(i)?(b(),k("button",{key:0,title:o(R)("g.stopRecording","Stop Recording"),class:"flex size-8 animate-pulse items-center justify-center rounded-full border-0 bg-smoke-500/33 transition-colors",onClick:z},c[2]||(c[2]=[h("div",{class:"size-2.5 rounded-sm bg-danger-100"},null,-1)]),8,Re)):!o(i)&&o(y)&&!o(w)?(b(),k("button",{key:1,title:o(R)("g.playRecording")||"Play Recording",class:"flex size-8 items-center justify-center rounded-full border-0 bg-smoke-500/33 transition-colors",onClick:I},c[3]||(c[3]=[h("i",{class:"text-text-secondary icon-[lucide--play] size-4"},null,-1)]),8,_e)):o(w)?(b(),k("button",{key:2,title:o(R)("g.stopPlayback")||"Stop Playback",class:"flex size-8 items-center justify-center rounded-full border-0 bg-smoke-500/33 transition-colors",onClick:S},c[4]||(c[4]=[h("i",{class:"text-text-secondary icon-[lucide--square] size-4"},null,-1)]),8,Ae)):F("",!0)])):F("",!0),o(y)?(b(),k("audio",{ref_key:"audioRef",ref:n,key:o(W),src:o(y),class:"hidden",onEnded:c[0]||(c[0]=(...x)=>o(a).onPlaybackEnded&&o(a).onPlaybackEnded(...x)),onLoadedmetadata:c[1]||(c[1]=(...x)=>o(a).onMetadataLoaded&&o(a).onMetadataLoaded(...x))},null,40,Ce)):F("",!0),U(re)])}}});export{jt as default};
//# sourceMappingURL=WidgetRecordAudio-C2WSrbvW.js.map
