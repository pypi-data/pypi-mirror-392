# MCP Usage Guide

Complete guide for using pypi-workflow-generator as an MCP server.

## What is MCP?

Model Context Protocol (MCP) is a standard protocol that allows AI agents to interact with external tools. This package implements an MCP server that AI agents can use to generate PyPI publishing workflows.

## Supported AI Agents

- ✅ Claude Code (Anthropic)
- ✅ Continue.dev
- ✅ Cline
- ⚠️ Cursor, Aider, Windsurf (use CLI mode instead)

## Configuration

### Claude Code

Add to your project's `claude_config.json` or user-level `claude_desktop_config.json`:

```json
{
  "mcpServers": {
    "pypi-workflow-generator": {
      "command": "mcp-pypi-workflow-generator"
    }
  }
}
```

### Continue.dev

Add to `~/.continue/config.json`:

```json
{
  "mcpServers": [
    {
      "name": "pypi-workflow-generator",
      "command": "mcp-pypi-workflow-generator"
    }
  ]
}
```

### Cline

Add to Cline's MCP settings:

```json
{
  "mcpServers": {
    "pypi-workflow-generator": {
      "command": "mcp-pypi-workflow-generator"
    }
  }
}
```

## Available Tools

The MCP server provides four tools for complete PyPI workflow automation.

### 1. generate_workflow

Generate GitHub Actions workflows for PyPI publishing. **By default, this generates both publishing and release workflows.**

**Parameters**:
- `python_version` (string, optional): Python version, default "3.11"
- `output_filename` (string, optional): Publishing workflow filename, default "pypi-publish.yml"
- `release_on_main_push` (boolean, optional): Trigger on main push, default false
- `test_path` (string, optional): Tests directory, default "."
- `verbose_publish` (boolean, optional): Verbose publishing, default false
- `include_release_workflow` (boolean, optional): Also generate create-release.yml, default true

**Example**:
```json
{
  "python_version": "3.11",
  "output_filename": "pypi-publish.yml",
  "release_on_main_push": false,
  "test_path": "tests",
  "verbose_publish": true,
  "include_release_workflow": true
}
```

**Returns**:
- Success message with file paths (both workflows if include_release_workflow is true)
- Error message if project not initialized

**Note**: This tool generates TWO workflows by default:
1. `pypi-publish.yml` - Automated TestPyPI/PyPI publishing
2. `create-release.yml` - Manual release creation via GitHub UI

### 2. initialize_project

Initialize new Python project with PyPI configuration.

**Parameters** (all required):
- `package_name` (string): Package name
- `author` (string): Author name
- `author_email` (string): Author email
- `description` (string): Package description
- `url` (string): Project URL
- `command_name` (string): CLI command name

**Example**:
```json
{
  "package_name": "my-package",
  "author": "Jane Doe",
  "author_email": "jane@example.com",
  "description": "My awesome package",
  "url": "https://github.com/janedoe/my-package",
  "command_name": "my-cli"
}
```

**Returns**:
- Success message with list of created files
- Error message if parameters missing

### 3. create_release

Create and push git release tag (local CLI method).

**Parameters**:
- `version` (string, required): Version tag (e.g., "v1.0.0")

**Example**:
```json
{
  "version": "v1.0.0"
}
```

**Returns**:
- Success message with version tag
- Error message if git operations fail

**Note**: This is the programmatic way to create releases. Alternatively, users can create releases via the GitHub Actions UI using the workflow generated by `generate_release_workflow`.

### 4. generate_release_workflow

Generate GitHub Actions workflow for creating releases via UI. This allows manual release creation with automatic version calculation and tag creation.

**Parameters**:
- `output_filename` (string, optional): Workflow filename, default "create-release.yml"

**Example**:
```json
{
  "output_filename": "create-release.yml"
}
```

**Returns**:
- Success message with file path
- Error message if workflow generation fails

**Use Case**: Use this when you only want to add the release creation workflow to an existing project, or when you used `include_release_workflow: false` with `generate_workflow`.

**Important Setup Note**: The generated workflow requires a Personal Access Token (PAT) to trigger the PyPI publish workflow automatically. Users must:
1. Create a GitHub PAT with `repo` scope
2. Add it as a repository secret named `RELEASE_PAT`
3. See the README "Setting Up Automated Release Publishing" section for detailed instructions

**Why is a PAT required?** GitHub Actions workflows triggered by the default `GITHUB_TOKEN` cannot trigger other workflows (security feature). A PAT allows the tag push to trigger the PyPI publish workflow automatically.

**Workflow Features**:
- Manual trigger via GitHub Actions UI
- Choose major/minor/patch version bump
- Configurable token secret name (default: `RELEASE_PAT`)
- Automatic version calculation from latest git tag
- Creates and pushes git tag using PAT
- Creates GitHub Release with auto-generated notes
- Automatically triggers PyPI publish workflow (when PAT is configured)

## Example Workflows

### Complete Project Setup

```
You: "Set up my Python project for PyPI publishing"

Agent: I'll set up your Python project with a complete PyPI publishing workflow.

[Agent calls initialize_project]
Created pyproject.toml and setup.py

[Agent calls generate_workflow]
Generated .github/workflows/pypi-publish.yml
Generated .github/workflows/create-release.yml

Your project is now configured for PyPI publishing with:
- Automated versioning via setuptools_scm
- TestPyPI publishing on pull requests
- PyPI publishing on version tags
- Trusted Publishers (no API tokens needed)
- Manual release creation via GitHub UI

Next steps:
1. Configure Trusted Publishers on PyPI
2. Create releases via GitHub Actions UI or run: pypi-release patch
```

### Just Generate Workflow

```
You: "Generate a PyPI workflow using Python 3.12"

Agent: [Calls generate_workflow with python_version="3.12"]

Generated .github/workflows/pypi-publish.yml with Python 3.12
Generated .github/workflows/create-release.yml
```

### Generate Only Release Workflow

```
You: "Add a release creation workflow to my project"

Agent: [Calls generate_release_workflow]

Generated .github/workflows/create-release.yml

You can now create releases via GitHub Actions UI by:
1. Go to Actions tab
2. Select "Create Release" workflow
3. Click "Run workflow"
4. Choose major/minor/patch
```

### Create Release

```
You: "Create a v2.0.0 release"

Agent: [Calls create_release with version="v2.0.0"]

Created and pushed tag v2.0.0
GitHub Actions will now build and publish to PyPI
```

## Troubleshooting

### Agent Can't Find MCP Server

**Issue**: Agent reports "mcp-pypi-workflow-generator not found"

**Solution**:
```bash
# Verify installation
pip list | grep pypi-workflow-generator

# Verify command exists
which mcp-pypi-workflow-generator

# Reinstall if needed
pip install --force-reinstall pypi-workflow-generator
```

### Tool Execution Fails

**Issue**: Tool returns error

**Check**:
1. For `generate_workflow`: Project must have `pyproject.toml` and `setup.py`
   - Run `initialize_project` first
2. For `create_release`: Git repository must be initialized
   - Run `git init` if needed
3. For `initialize_project`: All required parameters must be provided
   - Verify all 6 parameters are present

### Non-MCP Agents

**Issue**: Your AI agent doesn't support MCP

**Solution**: Use CLI mode instead:
```bash
pypi-workflow-generator-init --package-name my-pkg --author "Name" --author-email "email@example.com" --description "My package" --url "https://github.com/user/repo" --command-name my-cmd
pypi-workflow-generator --python-version 3.11
pypi-release patch
```

## Protocol Details

The MCP server uses:
- **Transport**: stdio (JSON-RPC over stdin/stdout)
- **Protocol Version**: MCP 1.0
- **Capabilities**: tools (4 tools available)
- **Request Format**: JSON-RPC 2.0

## Development

Testing the MCP server:

```bash
# Start server
mcp-pypi-workflow-generator

# Send request (in another terminal)
echo '{"id":1,"method":"tools/list","params":{}}' | mcp-pypi-workflow-generator

# Expected response:
{"id": 1, "tools": [...]}
```

### Manual Testing

Test each tool individually:

**List Tools**:
```bash
echo '{"id":1,"method":"tools/list","params":{}}' | mcp-pypi-workflow-generator 2>/dev/null
```

**Initialize Project**:
```bash
cd /tmp/test-project
echo '{
  "id":2,
  "method":"tools/call",
  "params":{
    "name":"initialize_project",
    "arguments":{
      "package_name":"test-pkg",
      "author":"Test",
      "author_email":"test@example.com",
      "description":"Test package",
      "url":"https://github.com/test/test-pkg",
      "command_name":"test-cmd"
    }
  }
}' | mcp-pypi-workflow-generator 2>/dev/null
```

**Generate Workflow**:
```bash
cd /tmp/test-project
echo '{
  "id":3,
  "method":"tools/call",
  "params":{
    "name":"generate_workflow",
    "arguments":{
      "python_version":"3.11"
    }
  }
}' | mcp-pypi-workflow-generator 2>/dev/null
```

**Generate Release Workflow**:
```bash
cd /tmp/test-project
echo '{
  "id":4,
  "method":"tools/call",
  "params":{
    "name":"generate_release_workflow",
    "arguments":{
      "output_filename":"create-release.yml"
    }
  }
}' | mcp-pypi-workflow-generator 2>/dev/null
```

## Best Practices

1. **Always initialize first**: Run `initialize_project` before `generate_workflow`
2. **Use semantic versioning**: Tags should follow `v{major}.{minor}.{patch}` format
3. **Test locally**: Verify workflows work before pushing to production
4. **Configure Trusted Publishers**: Set up PyPI authentication before first release

## FAQ

**Q: Can I use this without MCP support?**
A: Yes! Use the CLI commands: `pypi-workflow-generator-init`, `pypi-workflow-generator`, `pypi-workflow-generator-release`, and `pypi-release`.

**Q: Does this work with TestPyPI?**
A: Yes! The generated workflow automatically publishes to TestPyPI on pull requests.

**Q: How do I update the generated workflow?**
A: Re-run `generate_workflow` or `generate_release_workflow` with desired parameters. The files will be overwritten.

**Q: Can I generate only one workflow instead of both?**
A: Yes! Use `include_release_workflow: false` with `generate_workflow` to skip the release workflow, or use `generate_release_workflow` alone to generate only the release workflow.

**Q: Why does the release workflow need a Personal Access Token (PAT)?**
A: GitHub Actions workflows triggered by the default `GITHUB_TOKEN` cannot trigger other workflows (security feature to prevent infinite loops). To automatically trigger the PyPI publish workflow after creating a release, you need to provide a PAT with `repo` scope as a repository secret named `RELEASE_PAT`. See the README "Setting Up Automated Release Publishing" section for detailed setup instructions.

**Q: Can I use the MCP tool to create releases without a PAT?**
A: Yes! The MCP `create_release` tool runs locally on your machine (not in GitHub Actions), so it doesn't have this limitation. It will trigger the PyPI publish workflow without needing a PAT. However, the `generate_release_workflow` tool generates a workflow that DOES require a PAT for automatic triggering.

**Q: Can I customize the generated files?**
A: Yes! All generated files can be edited after creation. They're standard Python project files.

**Q: What happens if I create a release without configuring Trusted Publishers?**
A: The GitHub Actions workflow will fail at the publishing step. Configure Trusted Publishers on PyPI first.

## Support

- **Repository**: https://github.com/hitoshura25/pypi-workflow-generator
- **Issues**: https://github.com/hitoshura25/pypi-workflow-generator/issues
- **Documentation**: See main [README.md](./README.md)
