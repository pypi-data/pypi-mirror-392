#include "test.h"

#define pi 3.14
#define FADE_PERIODIC(v1, v0, average, fwidth)	\
	    lerp((v1-v0)/fwidth, average, clamp(fwidth*VOP_PERIOD_FADE, 0, 1));

float vop_grandom(float u0, u1; float sigma)
{
    return cos(u0 * (M_PI * 2)) * sqrt(-2 * log(u1)) * sigma;
}

int   a = int(1.0); // casting
int   b = 12e4;     // 12 * 10^4 = 120000
float c = 22.E+3;   // 22 * 10^3 = 22000
float d = 22.E-3;   // 22 * 10^-3 = 0.022
float e = 1.3e+3;   // 1.3 * 10^3 = 1300

int   test_100  = 23_000_000;
float float_001 = 0.000_000_24;

s@test = "\"'test'\""; // test string escapes
i[]@connected_pts = neighbours(0, @ptnum);
f@test_float  = 1234.0f;
f@test_float2 = 1234.f;
i@test_hex    = 0xf123;
i@test_bin    = 0b1001;

float f = M_PI;
float g = sum(4, 5);

printf("%s %s", __FILE__, __DATE__);

float result = `chs('some_expression')`;  // expression string injection in wrangle

/* cstyle */

/* cstyle
* multi
* line */

// single line comment //

float radius = ch("radius");
float radius2 = ch ("radius");
int   max_pts = chi('maxpts');

int h = pcopen(@OpInput2, "P", @P, radius, max_pts);

vector avgP = 0, nP = 0;
vector avgN = 0, nN = 0;
float  avgDist = 0.0, nDist = 0.0;

while(pciterate(h)) {
    pcimport(h, "P", nP);
    avgP += nP;

    pcimport(h, "N", nN);
    avgN += nN;

    pcimport(h, "point.distance", nDist);
    avgDist += nDist;

    sum++;
    continue;
}
pcclose(h);

int values[] = {1, 2, 3, 4};
foreach(int v; values) {
    break;
}

if (sum == 0)
    return;

avgP    /= sum;
avgN     = normalize(avgN);
avgDist /= sum;

// in addition to the tangent dir (avgN), we need to find a direction to orbit and attract
vector attract = normalize(avgP - @P);
vector orbit   = normalize(cross(avgN, attract));

// fitting and remapping of vectors based on distance
float dist_tangent = fit(avgDist, ch("min_dist_tangent"), ch("max_dist_tangent"), 0, 1);
dist_tangent = chramp("remap_dist_tangent", dist_tangent);
dist_tangent *= ch("scale_tangent");

float dist_attract = fit(avgDist, ch("min_dist_attract"), ch("max_dist_attract"), 0, 1);
dist_attract = chramp("remap_dist_attract", dist_attract);
dist_attract *= ch("scale_attract");

float dist_orbit = fit(avgDist, ch("min_dist_orbit"), ch("max_dist_orbit"), 0, 1);
dist_orbit = chramp("remap_dist_orbit", dist_orbit);
dist_orbit *= ch("scale_orbit");

v@vel = (avgN    * dist_tangent) +
        (attract * dist_attract) +
        (orbit   * dist_orbit  );