"use strict";(self.webpackChunk_jupyter_collaboration_extension=self.webpackChunk_jupyter_collaboration_extension||[]).push([[393],{6393:(e,t,s)=>{s.r(t),s.d(t,{Collaborator:()=>C,CollaboratorsBody:()=>b,CollaboratorsPanel:()=>y,DefaultIconRenderer:()=>G,IUserMenu:()=>r,RendererUserMenu:()=>P,UserInfoBody:()=>V,UserInfoPanel:()=>z,UserMenu:()=>N,UsersItem:()=>q,remoteUserCursors:()=>U,showSharedLinkDialog:()=>B});var n=s(7262);const r=new n.Token("@jupyter/collaboration:IUserMenu");var a=s(2986),i=s(9694),o=s(4602),l=s(5256),c=s(3345),d=s.n(c);const h="jp-CollaboratorsList",u="jp-Collaborator",p="jp-CollaboratorHeader",_="jp-CollaboratorHeaderCollapser",m="jp-ClickableCollaborator",v="jp-CollaboratorIcon",g="jp-CollaboratorFiles",f="jp-CollaboratorFile";class y extends l.Panel{constructor(e,t,s,n){super({}),this._onAwarenessChanged=()=>{const e=this._awareness.getStates(),t=new Map;e.forEach(((e,s)=>{if(this._currentUser.isReady&&e.user&&e.user.username!==this._currentUser.identity.username){const s=`${e.user.username}-${e.current||"no-current"}`;t.has(s)||t.set(s,e)}})),this._collaboratorsChanged.emit(Array.from(t.values()))},this._collaboratorsChanged=new o.Signal(this),this._awareness=t,this._currentUser=e,this.addClass("jp-CollaboratorsPanel"),this.addWidget(a.ReactWidget.create(d().createElement(b,{fileopener:s,collaboratorsChanged:this._collaboratorsChanged,docRegistry:n}))),this._awareness.on("change",this._onAwarenessChanged)}}function b(e){const[t,s]=(0,c.useState)([]);return e.collaboratorsChanged.connect(((e,t)=>{s(t)})),d().createElement("div",{className:h},t.map((t=>{const s=`${t.user.username}-${t.current||"no-current"}`;return d().createElement(C,{key:s,collaborator:t,fileopener:e.fileopener,docRegistry:e.docRegistry})})))}function C(e){const[t,s]=(0,c.useState)(!1),{collaborator:n,fileopener:r}=e;let a="";if(n.current){const e=n.current.split(":");a=`${e[1]}`}const o=n.documents||[],l=o.map((t=>{var s,n;const r=null===(n=null===(s=e.docRegistry)||void 0===s?void 0:s.getFileTypesForPath(t))||void 0===n?void 0:n.filter((e=>void 0!==e.icon)),a=(null==r?void 0:r.length)?r[0].icon:i.fileIcon,o=(null==r?void 0:r.length)?r[0].iconClass:void 0;return{filename:t.length>40?t.slice(0,10).concat("…").concat(t.slice(t.length-15)):t,fileLocation:t,icon:a,iconClass:o}}));return d().createElement("div",{className:u},d().createElement("div",{className:l.length?`${m} ${p}`:p,onClick:o?()=>{l.length&&s(!t)}:void 0},d().createElement(i.LabIcon.resolveReact,{icon:i.caretDownIcon,className:_+(t?" jp-mod-expanded":""),tag:"div"}),d().createElement("div",{className:v,style:{backgroundColor:n.user.color}},d().createElement("span",null,n.user.initials)),d().createElement("span",null,n.user.display_name)),d().createElement("div",{className:`${g} jp-DirListing`,style:t?{}:{display:"none"}},d().createElement("ul",{className:"jp-DirListing-content"},l.map((e=>d().createElement("li",{className:"jp-DirListing-item "+(e.fileLocation===a?`${f} jp-mod-running`:f),key:e.filename,onClick:()=>r(e.fileLocation)},d().createElement(i.LabIcon.resolveReact,{icon:e.icon,iconClass:e.iconClass,tag:"span",className:"jp-DirListing-itemIcon",stylesheet:"listing"}),d().createElement("span",{className:"jp-DirListing-itemText",title:e.fileLocation},e.filename)))))))}var w=s(195),k=s(5024),j=s(2206);const S=w.Facet.define({combine:e=>e[e.length-1]}),E=k.EditorView.baseTheme({".jp-remote-cursor":{borderLeft:"1px solid black",marginLeft:"-1px"},".jp-remote-cursor.jp-mod-primary":{borderLeftWidth:"2px"},".jp-remote-selection":{opacity:.5},".cm-tooltip":{border:"none"},".cm-tooltip .jp-remote-userInfo":{color:"var(--jp-ui-inverse-font-color0)",padding:"0px 2px"}}),x=w.Annotation.define();class L{constructor(e,t){this.style=e,this.marker=t}draw(){const e=this.marker.draw();for(const[t,s]of Object.entries(this.style))e.style[t]=s;return e}eq(e){return this.marker.eq(e.marker)&&n.JSONExt.deepEqual(this.style,e.style)}update(e,t){for(const[t,s]of Object.entries(this.style))e.style[t]=s;return this.marker.update(e,t.marker)}}const A=(0,k.layer)({above:!0,markers(e){const{awareness:t,ytext:s}=e.state.facet(S),n=s.doc,r=[];return t.getStates().forEach(((a,i)=>{var o,l,c;if(i===t.doc.clientID)return;const d=a.cursors;for(const t of null!=d?d:[]){if(!(null==t?void 0:t.anchor)||!(null==t?void 0:t.head))return;const i=(0,j.createAbsolutePositionFromRelativePosition)(t.anchor,n),d=(0,j.createAbsolutePositionFromRelativePosition)(t.head,n);if((null==i?void 0:i.type)!==s||(null==d?void 0:d.type)!==s)return;const h=null===(o=t.primary)||void 0===o||o?"jp-remote-cursor jp-mod-primary":"jp-remote-cursor",u=w.EditorSelection.cursor(d.index,d.index>i.index?-1:1);for(const t of k.RectangleMarker.forRange(e,h,u))r.push(new L({borderLeftColor:null!==(c=null===(l=a.user)||void 0===l?void 0:l.color)&&void 0!==c?c:"black"},t))}})),r},update:(e,t)=>!!e.transactions.find((e=>e.annotation(x))),class:"jp-remote-cursors"}),I=(0,k.hoverTooltip)(((e,t)=>{var s;const{awareness:n,ytext:r}=e.state.facet(S),a=r.doc;for(const[e,i]of n.getStates())if(e!==n.doc.clientID)for(const e of null!==(s=i.cursors)&&void 0!==s?s:[]){if(!(null==e?void 0:e.head))continue;const s=(0,j.createAbsolutePositionFromRelativePosition)(e.head,a);if((null==s?void 0:s.type)===r&&s.index-3<=t&&t<=s.index+3)return{pos:s.index,above:!0,create:()=>{var e,t,s,n;const r=document.createElement("div");return r.classList.add("jp-remote-userInfo"),r.style.backgroundColor=null!==(t=null===(e=i.user)||void 0===e?void 0:e.color)&&void 0!==t?t:"darkgrey",r.textContent=null!==(n=null===(s=i.user)||void 0===s?void 0:s.display_name)&&void 0!==n?n:"Anonymous",{dom:r}}}}return null}),{hideOn:(e,t)=>!!e.annotation(x),hoverTime:0}),M=(0,k.layer)({above:!1,markers(e){const{awareness:t,ytext:s}=e.state.facet(S),n=s.doc,r=[];return t.getStates().forEach(((a,i)=>{var o,l,c;if(i===t.doc.clientID)return;const d=a.cursors;for(const t of null!=d?d:[]){if(null===(o=t.empty)||void 0===o||o||!(null==t?void 0:t.anchor)||!(null==t?void 0:t.head))return;const i=(0,j.createAbsolutePositionFromRelativePosition)(t.anchor,n),d=(0,j.createAbsolutePositionFromRelativePosition)(t.head,n);if((null==i?void 0:i.type)!==s||(null==d?void 0:d.type)!==s)return;const h="jp-remote-selection";for(const t of k.RectangleMarker.forRange(e,h,w.EditorSelection.range(i.index,d.index)))r.push(new L({backgroundColor:null!==(c=null===(l=a.user)||void 0===l?void 0:l.color)&&void 0!==c?c:"black"},t))}})),r},update:(e,t)=>!!e.transactions.find((e=>e.annotation(x))),class:"jp-remote-selections"}),R=k.ViewPlugin.fromClass(class{constructor(e){this.editorAwareness=e.state.facet(S),this._listener=({added:t,updated:s,removed:n})=>{t.concat(s).concat(n).findIndex((e=>e!==this.editorAwareness.awareness.doc.clientID))>=0&&e.dispatch({annotations:[x.of([])]})},this.editorAwareness.awareness.on("change",this._listener)}destroy(){this.editorAwareness.awareness.off("change",this._listener)}update(e){var t;if(!e.docChanged&&!e.selectionSet)return;const{awareness:s,ytext:r}=this.editorAwareness,a=s.getLocalState();if(a){const i=e.view.hasFocus&&e.view.dom.ownerDocument.hasFocus(),o=e.state.selection,l=new Array;if(i&&o){for(const e of o.ranges){const t=e===o.main,s=(0,j.createRelativePositionFromTypeIndex)(r,e.anchor),n=(0,j.createRelativePositionFromTypeIndex)(r,e.head);l.push({anchor:s,head:n,primary:t,empty:e.empty})}if(!a.cursors||l.length>0){const e=null===(t=a.cursors)||void 0===t?void 0:t.map((e=>({...e,anchor:(null==e?void 0:e.anchor)?(0,j.createRelativePositionFromJSON)(e.anchor):null,head:(null==e?void 0:e.head)?(0,j.createRelativePositionFromJSON)(e.head):null})));n.JSONExt.deepEqual(l,e)||s.setLocalStateField("cursors",l)}}}}},{provide:()=>[E,A,M,I,(0,k.tooltips)({position:"absolute",parent:document.body})]});function U(e){return[S.of(e),R]}var D=s(4873);class P extends l.MenuBar.Renderer{constructor(e){super(),this._user=e}renderItem(e){const t=this.createItemClass(e),s=this.createItemDataset(e),n=this.createItemARIA(e);return D.h.li({className:t,dataset:s,tabindex:"0",onfocus:e.onfocus,...n},this._createUserIcon(),this.renderLabel(e),this.renderIcon(e))}renderLabel(e){const t=this.formatLabel(e);return D.h.div({className:"lm-MenuBar-itemLabel jp-MenuBar-label"},t)}_createUserIcon(){return this._user.isReady&&this._user.identity.avatar_url?D.h.div({className:"lm-MenuBar-itemIcon jp-MenuBar-imageIcon"},D.h.img({src:this._user.identity.avatar_url})):this._user.isReady?D.h.div({className:"lm-MenuBar-itemIcon jp-MenuBar-anonymousIcon",style:{backgroundColor:this._user.identity.color}},D.h.span({},this._user.identity.initials)):D.h.div({className:"lm-MenuBar-itemIcon jp-MenuBar-anonymousIcon"},i.userIcon)}}class N extends l.Menu{constructor(e){super(e)}}var T=s(1297),O=s(9424);async function B({translator:e}){const t=(null!=e?e:O.nullTranslator).load("jupyter_collaboration"),s=T.PageConfig.getToken(),n=new URL(T.URLExt.normalize(T.PageConfig.getUrl({workspace:T.PageConfig.defaultWorkspace})));let r=!1,i=!1,o=!1,l=!1,c="",d="",h="";if(""!==T.PageConfig.getOption("hubUser")){h=T.PageConfig.getOption("hubServerUser"),d=T.PageConfig.getOption("hubServerName"),c=`${T.PageConfig.getOption("hubHost")||""}${T.PageConfig.getOption("hubPrefix")}api`;const e=await fetch(c,{headers:{Authorization:`token ${s}`}}),t=(await e.json()).version,[n]=t.split(".").map(Number);if(n>=5){const e=await fetch(`${c}/user`,{headers:{Authorization:`token ${s}`}}),t=await e.json();t.scopes.includes("read:users:name")&&(h===T.PageConfig.getOption("hubUser")&&t.scopes.includes("shares!user")||t.scopes.includes("shares!user="+h)||t.scopes.includes("shares!server="+h+"/"+d))&&(r=!0,(t.scopes.includes("list:users")||t.scopes.includes("read:users")||t.scopes.includes("admin:users"))&&(i=!0),(t.scopes.includes("list:groups")||t.scopes.includes("read:groups")||t.scopes.includes("admin:groups"))&&(o=!0),(h===T.PageConfig.getOption("hubUser")&&t.scopes.includes("servers!user")||t.scopes.includes("servers!user="+h)||t.scopes.includes("servers!server="+h+"/"+d+"/")||t.scopes.includes("admin:servers"))&&(l=!0))}}if(r){let e=d;return""===e&&(e="default"),(0,a.showDialog)({title:t.__("Share Jupyter Server %1",e),body:new $(n.toString(),d,i,o,l,h,c,s,t),buttons:[a.Dialog.cancelButton({label:t.__("Close"),caption:t.__("Close the dialog")}),a.Dialog.okButton({label:t.__("Copy Link"),caption:t.__("Copy the link to the Jupyter Server")})]})}return(0,a.showDialog)({title:t.__("Share Jupyter Server Link"),body:new F(n.toString(),s,""!==T.PageConfig.getOption("hubUser"),t),buttons:[a.Dialog.cancelButton(),a.Dialog.okButton({label:t.__("Copy Link"),caption:t.__("Copy the link to the Jupyter Server")})]})}class $ extends l.Widget{constructor(e,t,s,n,r,a,i,o,l){super(),this._url=e,this._serverName=t,this._canListUsers=s,this._canListGroups=n,this._canControlServer=r,this._serverOwner=a,this._hubApiUrl=i,this._token=o,this._trans=l,this._recipients=[],this._shares=[],this._searchInput=null,this._searchResults=null,this._sharesContainer=null,this._populateBody(this.node),this.addClass("jp-shared-link-body"),this._loadShares().then((()=>{this._updateSharesList().then((()=>{this._loadUsers()}))}))}getValue(){return this._url}onAfterAttach(e){super.onAfterAttach(e)}onBeforeDetach(e){super.onBeforeDetach(e)}async _loadUsers(){if(this._canListUsers){let e=0;const t=200;let s=[],n=!0;for(;n;){const r=await fetch(`${this._hubApiUrl}/users?limit=${t}&offset=${e}`,{headers:{Authorization:`token ${this._token}`}}),a=await r.json();s=s.concat(a),n=a.length===t,e+=t}const r=new Set(this._shares.filter((e=>"user"===e.type)).map((e=>e.name)));this._recipients=s.filter((e=>e.name!==this._serverOwner&&!r.has(e.name))).map((e=>({...e,type:"user"})))}if(this._canListGroups){const e=await fetch(`${this._hubApiUrl}/groups`,{headers:{Authorization:`token ${this._token}`}}),t=await e.json(),s=new Set(this._shares.filter((e=>"group"===e.type)).map((e=>e.name)));this._recipients=this._recipients.concat(t.filter((e=>!s.has(e.name))).map((e=>({name:e.name,type:"group"}))))}this._recipients.sort(((e,t)=>e.name.localeCompare(t.name))),this._updateSearchResults()}async _loadShares(){const e=await fetch(`${this._hubApiUrl}/shares/${this._serverOwner}/${this._serverName}`,{headers:{Authorization:`token ${this._token}`}}),t=await e.json();this._shares=t.items.map((e=>{var t,s;return{name:(null===(t=e.user)||void 0===t?void 0:t.name)||(null===(s=e.group)||void 0===s?void 0:s.name),createdAt:e.created_at,type:e.user?"user":"group"}}))}async _createShare(e,t){const s=["access:servers!server="+this._serverOwner+"/"+this._serverName];this._canControlServer&&s.push("servers!server="+this._serverOwner+"/"+this._serverName),await fetch(`${this._hubApiUrl}/shares/${this._serverOwner}/${this._serverName}`,{method:"POST",headers:{Authorization:`token ${this._token}`,"Content-Type":"application/json"},body:JSON.stringify({[t]:e.name,scopes:s})})}async _deleteShare(e,t){await fetch(`${this._hubApiUrl}/shares/${this._serverOwner}/${this._serverName}`,{method:"PATCH",headers:{Authorization:`token ${this._token}`},body:JSON.stringify({[t]:e.name})})}_populateBody(e){const t=document.createElement("div");t.classList.add("jp-ManageSharesBody-search-container"),this._searchInput=document.createElement("input"),this._searchInput.type="text",this._searchInput.classList.add("jp-ManageSharesBody-search-input"),this._searchInput.placeholder=this._trans.__("Type to search for a user or a group to share your server with..."),this._searchInput.addEventListener("input",(()=>{this._updateSearchResults()})),t.appendChild(this._searchInput),e.appendChild(t),this._searchResults=document.createElement("div"),this._searchResults.classList.add("jp-ManageSharesBody-search-results"),e.appendChild(this._searchResults),this._sharesContainer=document.createElement("div"),this._sharesContainer.classList.add("jp-ManageSharesBody-selected-users"),e.appendChild(this._sharesContainer);const s=document.createElement("input");s.classList.add("jp-ManageSharesBody-url-input"),s.readOnly=!0,s.value=this._url,e.appendChild(s),e.insertAdjacentHTML("beforeend","<br>"),e.insertAdjacentText("beforeend",this._trans.__("Warning: Anyone you share this server with will have access to all your files, not just the currently open file.")),e.insertAdjacentHTML("beforeend","<br>"),e.insertAdjacentText("beforeend",this._trans.__("If your Hub administrator allows it, you can create another server dedicated to sharing a specific project."))}_updateSearchResults(){var e;if(!this._searchResults)return;this._searchResults.innerHTML="";const t=(null===(e=this._searchInput)||void 0===e?void 0:e.value)||"";this._recipients.filter((e=>e.name.toLowerCase().includes(t.toLowerCase())||""===t)).forEach((e=>{var t;const s=document.createElement("div");s.classList.add("jp-ManageSharesBody-user-item"),"group"===e.type?s.textContent=this._trans.__("Group %1",e.name):s.textContent=e.name,s.addEventListener("click",(async()=>{await this._createShare(e,e.type),await this._loadShares(),await this._updateSharesList();const t=new Set(this._shares.map((e=>e.name)));this._recipients=this._recipients.filter((e=>e.name!==this._serverOwner&&!t.has(e.name))),this._updateSearchResults()})),null===(t=this._searchResults)||void 0===t||t.appendChild(s)}))}async _updateSharesList(){if(!this._sharesContainer)return;this._sharesContainer.innerHTML="";const e=document.createElement("table");e.classList.add("jp-ManageSharesBody-shares-table");const t=document.createElement("tr"),s=document.createElement("th");s.textContent=this._trans.__("Shared with");const n=document.createElement("th");n.textContent=this._trans.__("Shared since");const r=document.createElement("th");if(r.textContent=this._trans.__("Actions"),t.appendChild(s),t.appendChild(n),t.appendChild(r),e.appendChild(t),0===this._shares.length){const t=document.createElement("tr"),s=document.createElement("td");s.colSpan=3,s.textContent=this._trans.__("Your server is not shared to anybody yet. You can search for users and groups above."),t.appendChild(s),e.appendChild(t)}else this._shares.forEach((t=>{const s=document.createElement("tr"),n=document.createElement("td");"group"===t.type?n.textContent=this._trans.__("Group %1",t.name):n.textContent=t.name,s.appendChild(n);const r=document.createElement("td"),a=new Date(t.createdAt).toLocaleString([],{hour:"2-digit",minute:"2-digit",year:"numeric",month:"2-digit",day:"2-digit"});r.textContent=a,s.appendChild(r);const i=document.createElement("td"),o=document.createElement("button");o.textContent=this._trans.__("Revoke"),o.classList.add("jp-mod-styled"),o.addEventListener("click",(async()=>{await this._deleteShare(t,t.type),await this._loadShares(),await this._updateSharesList(),await this._loadUsers();const e=new Set(this._shares.map((e=>e.name)));this._recipients=this._recipients.filter((t=>t.name!==this._serverOwner&&!e.has(t.name))),this._updateSearchResults()})),i.appendChild(o),s.appendChild(i),e.appendChild(s)}));this._sharesContainer.appendChild(e)}}class F extends l.Widget{constructor(e,t,s,n){super(),this._url=e,this._token=t,this._behindHub=s,this._trans=n,this._tokenCheckbox=null,this._onTokenChange=e=>{const t=e.target;this._updateContent(null==t?void 0:t.checked)},this._warning=document.createElement("div"),this._populateBody(this.node),this.addClass("jp-shared-link-body")}getValue(){var e;if(!0===(null===(e=this._tokenCheckbox)||void 0===e?void 0:e.checked)){const e=new URL(this._url);return e.searchParams.set("token",this._token),e.toString()}return this._url}onAfterAttach(e){var t;super.onAfterAttach(e),null===(t=this._tokenCheckbox)||void 0===t||t.addEventListener("change",this._onTokenChange)}onBeforeDetach(e){var t;null===(t=this._tokenCheckbox)||void 0===t||t.removeEventListener("change",this._onTokenChange),super.onBeforeDetach(e)}_updateContent(e){this._warning.innerHTML="";const t=this.node.querySelector("input[readonly]");if(e){if(t){const e=new URL(this._url);e.searchParams.set("token",this._token.slice(0,5)),t.value=e.toString()+"…"}this._warning.appendChild(document.createElement("h3")).textContent=this._trans.__("Security warning!"),this._warning.insertAdjacentText("beforeend",this._trans.__("Anyone with this link has full access to your notebook server, including all your files!")),this._warning.insertAdjacentHTML("beforeend","<br>"),this._warning.insertAdjacentText("beforeend",this._trans.__("Please be careful who you share it with.")),this._warning.insertAdjacentHTML("beforeend","<br>"),this._behindHub?(this._warning.insertAdjacentText("beforeend",this._trans.__("They will be able to access this server AS YOU.")),this._warning.insertAdjacentHTML("beforeend","<br>"),this._warning.insertAdjacentText("beforeend",this._trans.__("To revoke access, go to File -> Hub Control Panel, and restart your server."))):this._warning.insertAdjacentText("beforeend",this._trans.__("Currently, there is no way to revoke access other than shutting down your server."))}else t&&(t.value=this._url),this._behindHub?this._warning.insertAdjacentText("beforeend",this._trans.__("Only users with `access:servers` permissions for this server will be able to use this link.")):this._warning.insertAdjacentText("beforeend",this._trans.__("Only authenticated users will be able to use this link."))}_populateBody(e){const t=document.createElement("input");if(t.readOnly=!0,t.value=this._url,e.appendChild(t),this._token){const t=e.appendChild(document.createElement("label"));t.insertAdjacentHTML("beforeend",'<input type="checkbox">'),this._tokenCheckbox=t.firstChild,t.insertAdjacentText("beforeend",this._trans.__("Include token in URL")),e.insertAdjacentElement("beforeend",this._warning),this._updateContent(!1)}}}var H=s(6860);function W(e){const{userManager:t,onClick:s}=e,[n,r]=(0,c.useState)(t.identity);return(0,c.useEffect)((()=>{const e=()=>{r(t.identity)};return t.userChanged.connect(e),()=>{t.userChanged.disconnect(e)}}),[t]),d().createElement("div",{title:n.display_name,className:"jp-UserInfo-Icon",style:{backgroundColor:n.color},onClick:s},d().createElement("span",null,n.initials))}class J extends i.ReactWidget{constructor(e){super(),this._onChange=(e,t)=>{var s;const n=(null===(s=this._userManager.permissions)||void 0===s?void 0:s.updatable_fields)||[];(null==n?void 0:n.includes(t))&&(this._userUpdate[t]=e.target.value)},this._userUpdate={},this._userManager=e.userManager}getValue(){return this._userUpdate}render(){var e;const t=this._userManager.identity;if(!t)return d().createElement("div",{className:"jp-UserInfo-Details"},"Error loading user info");const s=(null===(e=this._userManager.permissions)||void 0===e?void 0:e.updatable_fields)||[];return d().createElement("div",{className:"jp-UserInfo-Details"},Object.keys(t).map((e=>{const n=`jp-UserInfo-Value-${e}`;return d().createElement("div",{key:e,className:"jp-UserInfo-Field"},d().createElement("label",{htmlFor:n},e),d().createElement("input",{type:"text",name:e,id:n,onInput:t=>this._onChange(t,e),defaultValue:t[e],disabled:!(null==s?void 0:s.includes(e))}))})))}}class z extends l.Panel{constructor(e){super({}),this.addClass("jp-UserInfoPanel"),this._profile=e.userManager,this._body=null,this._profile.isReady?(this._body=new V({userManager:this._profile,trans:e.trans}),this.addWidget(this._body),this.update()):this._profile.ready.then((()=>{this._body=new V({userManager:this._profile,trans:e.trans}),this.addWidget(this._body),this.update()})).catch((e=>console.error(e)))}}class V extends a.ReactWidget{constructor(e){super(),this.onClick=()=>{this._userManager.identity&&(0,a.showDialog)({body:new J({userManager:this._userManager}),title:this._trans.__("User Details")}).then((async e=>{if(e.button.accept)try{const t=H.ServerConnection.makeSettings(),s=T.URLExt.join(t.baseUrl,"/api/me"),n={method:"PATCH",body:JSON.stringify(e.value)};let r;try{r=await H.ServerConnection.makeRequest(s,n,t)}catch(e){throw new H.ServerConnection.NetworkError(e)}if(!r.ok){const e=this._trans.__("Failed to update user data");throw new Error(e)}this._userManager.refreshUser()}catch(e){console.error(e)}}))},this._userManager=e.userManager,this._trans=e.trans}get user(){return this._userManager}set user(e){this._userManager=e,this.update()}render(){return c.createElement("div",{className:"jp-UserInfo-Container"},c.createElement(W,{userManager:this._userManager,onClick:this.onClick}))}}class q extends c.Component{constructor(e){var t;super(e),this._awarenessChange=()=>{var e;const t=null===(e=this._model)||void 0===e?void 0:e.sharedModel.awareness.getStates(),s=[];t&&t.forEach(((e,t)=>{e.user&&s.push({userId:t,userData:e.user})})),this.setState((e=>({...e,usersList:s})))},this._model=e.model,this._iconRenderer=null!==(t=e.iconRenderer)&&void 0!==t?t:null,this.state={usersList:[]}}static createWidget(e){return i.ReactWidget.create(c.createElement(q,{...e}))}componentDidMount(){var e;null===(e=this._model)||void 0===e||e.sharedModel.awareness.on("change",this._awarenessChange),this._awarenessChange()}filterDuplicated(e){var t;const s=[],n=new Set;for(const r of e)(null===(t=null==r?void 0:r.userData)||void 0===t?void 0:t.username)&&!n.has(r.userData.username)&&(n.add(r.userData.username),s.push(r));return s}render(){var e;const t=null!==(e=this._iconRenderer)&&void 0!==e?e:G;return c.createElement("div",{className:"jp-toolbar-users-item"},this.filterDuplicated(this.state.usersList).map((e=>{if(this._model&&e.userId!==this._model.sharedModel.awareness.clientID)return t({user:e,model:this._model})})))}}function G(e){let t;const{user:s,model:n,...r}=e,a=(0,i.classes)("lm-MenuBar-itemIcon",e.className||"");return t=s.userData.avatar_url?c.createElement("div",{...r,key:s.userId,title:s.userData.display_name,className:(0,i.classes)(a,"jp-MenuBar-imageIcon")},c.createElement("img",{src:s.userData.avatar_url,alt:""})):c.createElement("div",{...r,key:s.userId,title:s.userData.display_name,className:(0,i.classes)(a,"jp-MenuBar-anonymousIcon"),style:{backgroundColor:s.userData.color}},c.createElement("span",null,s.userData.initials)),t}}}]);