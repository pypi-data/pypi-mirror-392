"""
Pytest configuration for FastAPI + TortoiseORM
Generated by vyte v2.0
"""
import pytest_asyncio
from typing import AsyncGenerator
from httpx import ASGITransport, AsyncClient
from tortoise import Tortoise

from src.main import app


# Configure pytest-asyncio
pytest_plugins = ('pytest_asyncio',)


@pytest_asyncio.fixture(scope="function", autouse=True)
async def initialize_tests():
    """
    Initialize database for tests
    Uses in-memory SQLite database for testing
    """
    # Initialize Tortoise manually (don't use initializer() - it conflicts with pytest-asyncio)
    await Tortoise.init(
        db_url="sqlite://:memory:",
        modules={"models": ["src.models.models"]}
    )

    # Generate schemas
    await Tortoise.generate_schemas()

    yield

    # Cleanup after each test
    await Tortoise._drop_databases()


@pytest_asyncio.fixture
async def client() -> AsyncGenerator[AsyncClient, None]:
    """
    Create an async HTTP client for testing

    Usage:
        async def test_endpoint(client):
            response = await client.get("/api/endpoint")
            assert response.status_code == 200
    """
    transport = ASGITransport(app=app)
    async with AsyncClient(transport=transport, base_url="http://test") as ac:
        yield ac


{% if auth_enabled -%}
@pytest_asyncio.fixture
async def test_user(client: AsyncClient):
    """
    Create a test user using the API endpoint

    This ensures the user is created through the same flow as in production
    """
    user_data = {
        "username": "testuser",
        "email": "test@example.com",
        "password": "testpassword123"
    }

    # Register user through API
    response = await client.post("/api/auth/register", json=user_data)
    assert response.status_code == 201

    user_response = response.json()
    user_data["id"] = user_response["id"]

    yield user_data


@pytest_asyncio.fixture
async def auth_headers(client: AsyncClient, test_user: dict) -> dict:
    """
    Get authentication headers with valid JWT token

    Usage:
        async def test_protected_endpoint(client, auth_headers):
            response = await client.get("/api/protected", headers=auth_headers)
            assert response.status_code == 200
    """
    # Login to get token
    response = await client.post(
        "/api/auth/login",
        data={
            "username": test_user["username"],
            "password": test_user["password"]
        }
    )

    if response.status_code != 200:
        # Debug info
        print(f"Login failed: {response.status_code}")
        print(f"Response: {response.text}")
        print(f"Test user: {test_user}")

    assert response.status_code == 200, f"Login failed with status {response.status_code}: {response.text}"
    token_data = response.json()
    access_token = token_data["access_token"]

    return {"Authorization": f"Bearer {access_token}"}


@pytest_asyncio.fixture
async def test_item(test_user: dict):
    """
    Create a test item owned by test_user
    """
    from src.models.models import Item, User

    # Get the user object
    user = await User.filter(id=test_user["id"]).first()

    item = await Item.create(
        title="Test Item",
        description="This is a test item",
        owner=user
    )

    yield item
{% else -%}
@pytest_asyncio.fixture
async def test_item():
    """
    Create a test item
    """
    from src.models.models import Item

    item = await Item.create(
        title="Test Item",
        description="This is a test item"
    )

    yield item
{% endif -%}
