"""
API Views for Django REST Framework
Generated by presto v2.0
"""
from rest_framework import viewsets, status, permissions
from rest_framework.decorators import api_view, permission_classes, action
from rest_framework.response import Response
from rest_framework.views import APIView
{% if auth_enabled -%}
from rest_framework.permissions import IsAuthenticated, AllowAny
from django.contrib.auth import get_user_model
from drf_spectacular.utils import extend_schema, OpenApiResponse, OpenApiExample
from rest_framework_simplejwt.views import (
    TokenObtainPairView as BaseTokenObtainPairView,
    TokenRefreshView as BaseTokenRefreshView,
    TokenVerifyView as BaseTokenVerifyView,
)
{% endif -%}
from .models import User, Item
from .serializers import (
    UserSerializer,
    ItemSerializer,
{%- if auth_enabled %}
    UserCreateSerializer,
    UserListSerializer,
    ChangePasswordSerializer,
{%- endif %}
    ItemListSerializer,
    ItemCreateSerializer,
    LoginSerializer,
    TokenResponseSerializer,
    TokenRefreshSerializer,
    TokenVerifySerializer,
)
{% if auth_enabled -%}
from .permissions import IsOwnerOrReadOnly, IsOwner
{% endif -%}


# ============================================================================
# UTILITY VIEWS
# ============================================================================

@api_view(['GET'])
@permission_classes([permissions.AllowAny])
def health_check(request):
    """
    Health check endpoint
    Returns OK status if API is running
    """
    return Response({
        'status': 'ok',
        'version': '1.0.0',
        'service': '{{ name }}'
    })


@api_view(['GET'])
@permission_classes([permissions.AllowAny])
def api_root(request):
    """
    API Root endpoint
    Returns available API endpoints
    """
    from rest_framework.reverse import reverse

    return Response({
        'users': reverse('user-list', request=request),
        'items': reverse('item-list', request=request),
{%- if auth_enabled %}
        'auth': {
            'login': reverse('token_obtain_pair', request=request),
            'refresh': reverse('token_refresh', request=request),
            'register': reverse('user-register', request=request),
        }
{%- endif %}
    })


# ============================================================================
# USER VIEWSET
# ============================================================================

class UserViewSet(viewsets.ModelViewSet):
    """
    ViewSet for User model
    Provides CRUD operations for users
    """
    queryset = User.objects.all()
    serializer_class = UserSerializer

{%- if auth_enabled %}

    permission_classes = [IsAuthenticated]

{%- else %}

    permission_classes = [permissions.AllowAny]

{%- endif %}

    def get_serializer_class(self):
        """Return appropriate serializer based on action"""

{%- if auth_enabled %}

        if self.action == 'list':
            return UserListSerializer
        elif self.action == 'create':
            return UserCreateSerializer
        return UserSerializer

{%- else %}
        return UserSerializer
{%- endif %}

{%- if auth_enabled %}

    def get_permissions(self):
        """Set permissions based on action"""
        if self.action in ['update', 'partial_update', 'destroy']:
            return [IsOwner()]
        return [IsAuthenticated()]

    def get_queryset(self):
        """Filter queryset based on user permissions"""
        user = self.request.user
        if user.is_staff:
            return User.objects.all()
        # Regular users can only see themselves
        return User.objects.filter(pk=user.pk)

    @action(detail=False, methods=['get'])
    def me(self, request):
        """Get current user profile"""
        serializer = self.get_serializer(request.user)
        return Response(serializer.data)

    @action(detail=True, methods=['get'])
    def items(self, request, pk=None):
        """Get all items for a specific user"""
        user = self.get_object()
        items = user.items.all()
        serializer = ItemListSerializer(items, many=True)
        return Response(serializer.data)
{%- endif %}


{% if auth_enabled -%}
# ============================================================================
# AUTHENTICATION VIEWS
# ============================================================================

class UserRegisterView(APIView):
    """
    User registration endpoint
    Allows new users to register
    """
    permission_classes = [AllowAny]

    def post(self, request):
        """Register a new user"""
        serializer = UserCreateSerializer(data=request.data)
        if serializer.is_valid():
            user = serializer.save()
            return Response(
                UserSerializer(user).data,
                status=status.HTTP_201_CREATED
            )
        return Response(
            serializer.errors,
            status=status.HTTP_400_BAD_REQUEST
        )


class ChangePasswordView(APIView):
    """
    Change password endpoint
    Allows authenticated users to change their password
    """
    permission_classes = [IsAuthenticated]

    def post(self, request):
        """Change user password"""
        serializer = ChangePasswordSerializer(
            data=request.data,
            context={'request': request}
        )
        if serializer.is_valid():
            serializer.save()
            return Response(
                {'message': 'Password changed successfully'},
                status=status.HTTP_200_OK
            )
        return Response(
            serializer.errors,
            status=status.HTTP_400_BAD_REQUEST
        )


{% endif -%}
# ============================================================================
# ITEM VIEWSET
# ============================================================================

class ItemViewSet(viewsets.ModelViewSet):
    """
    ViewSet for Item model
    Provides CRUD operations for items
    """
    queryset = Item.objects.all()
    serializer_class = ItemSerializer

{%- if auth_enabled %}

    permission_classes = [IsAuthenticated]

{%- else %}

    permission_classes = [permissions.AllowAny]

{%- endif %}

    # Enable filtering and searching
    filterset_fields = ['title', {% if not auth_enabled %}'quantity', 'price', {% endif %}'is_active']
    search_fields = ['title', 'description']
    ordering_fields = ['created_at', 'title'{% if not auth_enabled %}, 'quantity', 'price'{% endif %}]
    ordering = ['-created_at']

    def get_serializer_class(self):
        """Return appropriate serializer based on action"""
        if self.action == 'list':
            return ItemListSerializer
        elif self.action == 'create':
            return ItemCreateSerializer
        return ItemSerializer

{%- if auth_enabled %}

    def get_permissions(self):
        """Set permissions based on action"""
        if self.action in ['update', 'partial_update', 'destroy']:
            return [IsOwnerOrReadOnly()]
        return [IsAuthenticated()]

    def get_queryset(self):
        """
        Filter queryset based on user
        Regular users see only their items, staff sees all
        """
        user = self.request.user
        if user.is_staff:
            return Item.objects.all()
        return Item.objects.filter(owner=user)

    def perform_create(self, serializer):
        """Set owner to current user when creating item"""
        serializer.save(owner=self.request.user)

    @action(detail=False, methods=['get'])
    def my_items(self, request):
        """Get all items owned by current user"""
        items = Item.objects.filter(owner=request.user)
        serializer = ItemListSerializer(items, many=True)
        return Response(serializer.data)

    @action(detail=False, methods=['get'])
    def active(self, request):
        """Get only active items"""
        items = self.get_queryset().filter(is_active=True)
        page = self.paginate_queryset(items)
        if page is not None:
            serializer = ItemListSerializer(page, many=True)
            return self.get_paginated_response(serializer.data)
        serializer = ItemListSerializer(items, many=True)
        return Response(serializer.data)
{%- endif %}

{% if auth_enabled -%}
# ============================================================================
# JWT AUTHENTICATION VIEWS WITH DOCUMENTATION
# ============================================================================

class TokenObtainPairView(BaseTokenObtainPairView):
    """
    Login endpoint - Obtain JWT token pair
    """

    @extend_schema(
        operation_id='auth_login',
        summary='User login',
        description='Authenticate user and get JWT tokens',
        request=LoginSerializer,
        responses={
            200: OpenApiResponse(
                response=TokenResponseSerializer,
                description='Login successful - JWT tokens returned'
            ),
            401: OpenApiResponse(
                description='Invalid credentials'
            )
        },
        tags=['Authentication']
    )
    def post(self, request, *args, **kwargs):
        return super().post(request, *args, **kwargs)


class TokenRefreshView(BaseTokenRefreshView):
    """
    Refresh JWT access token using refresh token
    """

    @extend_schema(
        operation_id='auth_refresh',
        summary='Refresh access token',
        description='Get a new access token using the refresh token. **Important: Use the REFRESH token here, not the access token!**',
        request=TokenRefreshSerializer,
        responses={
            200: OpenApiResponse(
                response=TokenResponseSerializer,
                description='New access token generated'
            ),
            401: OpenApiResponse(
                description='Invalid or expired refresh token'
            )
        },
        tags=['Authentication']
    )
    def post(self, request, *args, **kwargs):
        return super().post(request, *args, **kwargs)


class TokenVerifyView(BaseTokenVerifyView):
    """
    Verify JWT access token validity
    """

    @extend_schema(
        operation_id='auth_verify',
        summary='Verify access token',
        description='Verify if an access token is valid. **Important: Use the ACCESS token here, not the refresh token!**',
        request=TokenVerifySerializer,
        responses={
            200: OpenApiResponse(
                description='Token is valid (empty response body)'
            ),
            401: OpenApiResponse(
                description='Invalid or expired access token'
            )
        },
        tags=['Authentication']
    )
    def post(self, request, *args, **kwargs):
        return super().post(request, *args, **kwargs)
{% endif %}
