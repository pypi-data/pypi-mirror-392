"""
API routes for Peewee
Generated by vyte v2.0
"""
from flask import request
from flask_restx import Resource, Namespace, fields
{% if auth_enabled -%}
from flask_jwt_extended import create_access_token, jwt_required, get_jwt_identity
{% endif -%}
from src.models.models import User
from src.security import PasswordValidator, InputSanitizer
from peewee import IntegrityError, DoesNotExist

password_validator = PasswordValidator()
input_sanitizer = InputSanitizer()

{% if auth_enabled -%}
# Authorization configuration
authorizations = {
    'Bearer': {
        'type': 'apiKey',
        'in': 'header',
        'name': 'Authorization'
    }
}

user_ns = Namespace('auth', description='Authentication', authorizations=authorizations)
{% else -%}
user_ns = Namespace('users', description='User operations')
{% endif -%}

# API Models
user_model = user_ns.model('User', {
    'id': fields.Integer(description='User ID'),
    'username': fields.String(description='Username'),
    'email': fields.String(description='Email address'),
})

{% if auth_enabled -%}
register_model = user_ns.model('Register', {
    'username': fields.String(required=True),
    'email': fields.String(required=True),
    'password': fields.String(required=True),
})

login_model = user_ns.model('Login', {
    'username': fields.String(required=True),
    'password': fields.String(required=True),
})


@user_ns.route('/register')
class Register(Resource):
    @user_ns.expect(register_model)
    @user_ns.marshal_with(user_model, code=201)
    def post(self):
        """Register new user"""
        data = request.json

        # Check if user exists
        if User.select().where(User.username == data['username']).exists():
            user_ns.abort(400, 'Username exists')

        if User.select().where(User.email == data['email']).exists():
            user_ns.abort(400, 'Email exists')

        try:
            username = input_sanitizer.sanitize_username(data['username'])
        except ValueError as e:
            user_ns.abort(400, f'Invalid username: {str(e)}')

        try:
            email = input_sanitizer.sanitize_email(data['email'])
        except ValueError as e:
            user_ns.abort(400, f'Invalid email: {str(e)}')

        is_valid, message = password_validator.validate(data['password'])
        if not is_valid:
            user_ns.abort(400, f'Invalid password: {message}')

        try:
            # Create user with password
            user = User.create_user(
                username=username,
                email=email,
                password=data['password']
            )
        except IntegrityError as e:
            user_ns.abort(400, f'Database error: {str(e)}')

        return user.to_dict(), 201


@user_ns.route('/login')
class Login(Resource):
    @user_ns.expect(login_model)
    def post(self):
        """Login"""
        data = request.json

        try:
            user = User.get(User.username == data['username'])
        except DoesNotExist:
            user_ns.abort(401, 'Invalid credentials')

        if not user.check_password(data['password']):
            user_ns.abort(401, 'Invalid credentials')

        access_token = create_access_token(identity=user.id)
        return {'access_token': access_token, 'user': user.to_dict()}, 200


@user_ns.route('/me')
class CurrentUser(Resource):
    @user_ns.doc(security='Bearer')
    @jwt_required()
    @user_ns.marshal_with(user_model)
    def get(self):
        """Get current user"""
        user_id = get_jwt_identity()
        try:
            user = User.get_by_id(user_id)
            return user.to_dict()
        except DoesNotExist:
            user_ns.abort(404, 'User not found')
{% else -%}

user_input = user_ns.model('UserInput', {
    'username': fields.String(required=True),
    'email': fields.String(required=True),
})


@user_ns.route('/')
class UserList(Resource):
    @user_ns.marshal_list_with(user_model)
    def get(self):
        """Get all users"""
        users = User.select()
        return [user.to_dict() for user in users]

    @user_ns.expect(user_input)
    @user_ns.marshal_with(user_model, code=201)
    def post(self):
        """Create user"""
        data = user_ns.payload

        user = User.create(
            username=data['username'],
            email=data['email']
        )
        return user.to_dict(), 201


@user_ns.route('/<int:user_id>')
class UserItem(Resource):
    @user_ns.marshal_with(user_model)
    def get(self, user_id):
        """Get user by ID"""
        try:
            user = User.get_by_id(user_id)
            return user.to_dict()
        except DoesNotExist:
            user_ns.abort(404, 'User not found')
{% endif -%}
