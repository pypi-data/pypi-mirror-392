# templates/flask_restx/sqlalchemy/__init__.py.j2
"""
Flask application factory
Generated by vyte v2.0
"""
from dotenv import load_dotenv
from flask import Flask
from src.config.config import Settings
from src.models.models import User
from src.routes.routes_example import user_ns

from .extensions import api, db, migration{% if auth_enabled %}, jwt{% endif %}



def create_app(config_name=None):
    """Application factory pattern"""
    load_dotenv()

    app = Flask(__name__)
    app.config.from_object(Settings)

    # Initialize extensions
    db.init_app(app)
    api.init_app(app)
    migration.init_app(app, db)
    {% if auth_enabled %}
    jwt.init_app(app)

    # JWT Configuration
    @jwt.user_identity_loader
    def user_identity_lookup(user):
        """Store user ID in token 'sub' field"""
        return str(user.id)

    @jwt.user_lookup_loader
    def user_lookup_callback(_jwt_header, jwt_data):
        """Load user from token 'sub' field"""
        identity = jwt_data["sub"]
        return User.query.filter_by(id=int(identity)).one_or_none()
    {% endif %}

    # Register namespaces
    api.add_namespace(user_ns)

    # Health check endpoint
    @app.route('/health')
    def health_check():
        """Health check endpoint for Docker"""
        return {'status': 'healthy', 'message': 'Application is running'}, 200

    return app
