---
title: MongoDB Backend
description: "Setup and configuration for MongoDB backend"
icon: "leaf"
---

## Overview

MongoDB backend provides flexible schema, powerful aggregation framework, and horizontal scaling capabilities. Ideal for applications requiring flexible data models and document-based queries.

<CardGroup cols={2}>
  <Card title="Performance" icon="gauge-high">
    ~5,000 writes/sec ~8,000 reads/sec
  </Card>
  <Card title="Latency" icon="clock">
    &lt;10ms (p99)
  </Card>
</CardGroup>

## Installation

```bash
uv add token-usage-metrics[mongo]
```

This installs the async MongoDB driver (`motor`).

## Setup

### Docker (Recommended for Development)

```bash
# Start MongoDB
docker run -d -p 27017:27017 --name mongodb-tum mongo:7

# With persistence
docker run -d -p 27017:27017 \
  -v mongodb-data:/data/db \
  --name mongodb-tum \
  mongo:7

# With authentication
docker run -d -p 27017:27017 \
  -e MONGO_INITDB_ROOT_USERNAME=admin \
  -e MONGO_INITDB_ROOT_PASSWORD=yourpassword \
  --name mongodb-tum \
  mongo:7
```

### Production Options

<Tabs>
  <Tab title="MongoDB Atlas">
    ```python settings = Settings( backend="mongodb",
    mongodb_url="mongodb+srv://user:pass@cluster.mongodb.net/?retryWrites=true&w=majority",
    mongodb_database="token_usage" ) ```
  </Tab>

  <Tab title="AWS DocumentDB">
    ```python settings = Settings( backend="mongodb",
    mongodb_url="mongodb://user:pass@docdb-cluster.cluster-xxx.region.docdb.amazonaws.com:27017/?ssl=true&replicaSet=rs0",
    mongodb_database="token_usage" ) ```
  </Tab>

  <Tab title="Self-Hosted Replica Set">
    ```python settings = Settings( backend="mongodb",
    mongodb_url="mongodb://user:pass@host1:27017,host2:27017,host3:27017/?replicaSet=myReplicaSet",
    mongodb_database="token_usage" ) ```
  </Tab>
</Tabs>

## Configuration

### Basic Configuration

```python
from token_usage_metrics import Settings

settings = Settings(
    backend="mongodb",
    mongodb_url="mongodb://localhost:27017",
    mongodb_database="token_usage"
)
```

### With Authentication

```python
settings = Settings(
    backend="mongodb",
    mongodb_url="mongodb://user:password@localhost:27017/?authSource=admin",
    mongodb_database="token_usage"
)
```

### Advanced Configuration

```python
settings = Settings(
    backend="mongodb",
    mongodb_url="mongodb://localhost:27017",
    mongodb_database="token_usage",

    # Connection pooling
    mongodb_max_pool_size=10,
    mongodb_min_pool_size=1,

    # Timeouts
    mongodb_server_selection_timeout=5.0,
    mongodb_socket_timeout=5.0,

    # Performance
    buffer_size=1000,
    flush_interval=1.0,
    flush_batch_size=200
)
```

### Environment Variables

```bash
export TUM_BACKEND=mongodb
export TUM_MONGODB_URL=mongodb://localhost:27017
export TUM_MONGODB_DATABASE=token_usage
export TUM_MONGODB_MAX_POOL_SIZE=10
```

## Schema

Collections and indexes are automatically created on first connection.

### usage_events Collection

```javascript
{
    _id: "event_id",                    // String, primary key
    timestamp: ISODate("2024-01-15T10:30:00Z"),
    project_name: "my_app",
    request_type: "chat",
    input_tokens: 100,
    output_tokens: 50,
    total_tokens: 150,
    request_count: 1,
    metadata: {                         // Optional nested document
        model: "gpt-4",
        user: "alice"
    }
}
```

#### Indexes

```javascript
// Time-based queries
db.usage_events.createIndex({ timestamp: 1 });

// Project-based queries
db.usage_events.createIndex({ project_name: 1, timestamp: 1 });

// Request type queries
db.usage_events.createIndex({ request_type: 1, timestamp: 1 });

// Combined queries
db.usage_events.createIndex({
  project_name: 1,
  request_type: 1,
  timestamp: 1,
});
```

### daily_aggregates Collection

```javascript
{
    _id: ObjectId("..."),
    date: ISODate("2024-01-15T00:00:00Z"),
    project_name: "my_app",             // null for global
    request_type: "chat",               // null for all types
    input_tokens: 1000,
    output_tokens: 500,
    total_tokens: 1500,
    request_count: 10
}
```

#### Indexes

```javascript
// Unique constraint for aggregates
db.daily_aggregates.createIndex(
  { date: 1, project_name: 1, request_type: 1 },
  { unique: true }
);
```

## Write Path

<Steps>
  <Step title="Bulk Insert Events">
    ```javascript
    db.usage_events.insertMany([
        { _id: "id1", timestamp: ..., ... },
        { _id: "id2", timestamp: ..., ... }
    ])
    ```
  </Step>
  
  <Step title="Upsert Aggregates">
    ```javascript
    db.daily_aggregates.updateMany(
        { date: ..., project_name: ..., request_type: ... },
        { $inc: { 
            input_tokens: 100, 
            output_tokens: 50,
            total_tokens: 150,
            request_count: 1
        }},
        { upsert: true }
    )
    ```
  </Step>
</Steps>

## Read Path

### Raw Event Query

```javascript
db.usage_events
  .find({
    project_name: "my_app",
    timestamp: {
      $gte: ISODate("2024-01-01"),
      $lt: ISODate("2024-02-01"),
    },
  })
  .sort({ timestamp: 1 })
  .limit(100);
```

### Aggregate Query

```javascript
db.daily_aggregates.aggregate([
  {
    $match: {
      date: {
        $gte: ISODate("2024-01-01"),
        $lt: ISODate("2024-02-01"),
      },
      project_name: "my_app",
    },
  },
  {
    $group: {
      _id: "$date",
      sum_input: { $sum: "$input_tokens" },
      sum_output: { $sum: "$output_tokens" },
      sum_total: { $sum: "$total_tokens" },
      count_requests: { $sum: "$request_count" },
    },
  },
  {
    $sort: { _id: 1 },
  },
]);
```

## Performance Tuning

### Index Optimization

```javascript
// Check index usage
db.usage_events.aggregate([{ $indexStats: {} }]);

// Create covering index for common queries
db.usage_events.createIndex({
  project_name: 1,
  timestamp: 1,
  input_tokens: 1,
  output_tokens: 1,
  total_tokens: 1,
});
```

### Connection Pooling

```python
settings = Settings(
    backend="mongodb",
    mongodb_url="mongodb://localhost:27017",
    mongodb_database="token_usage",

    # Tune for your workload
    mongodb_max_pool_size=20,
    mongodb_min_pool_size=5
)
```

### Batch Size Tuning

```python
settings = Settings(
    backend="mongodb",
    mongodb_url="mongodb://localhost:27017",
    mongodb_database="token_usage",

    # Larger batches for better throughput
    flush_batch_size=500,
    buffer_size=2000
)
```

## Data Retention

### Using TTL Index

<Tip>MongoDB supports automatic expiration with TTL indexes</Tip>

```javascript
// Create TTL index (delete after 90 days)
db.usage_events.createIndex(
  { timestamp: 1 },
  { expireAfterSeconds: 7776000 } // 90 days
);

// For daily aggregates (delete after 1 year)
db.daily_aggregates.createIndex(
  { date: 1 },
  { expireAfterSeconds: 31536000 } // 365 days
);
```

### Manual Cleanup

```python
from datetime import datetime, timedelta, timezone

async def cleanup_old_data(client: TokenUsageClient):
    """Delete data older than 90 days"""
    cutoff = datetime.now(timezone.utc) - timedelta(days=90)

    projects = ["project1", "project2"]

    for project in projects:
        result = await client.delete(
            project,
            time_to=cutoff,
            include_aggregates=True
        )
        print(f"Deleted {result.events_deleted} events for {project}")
```

## Monitoring

### Database Stats

```javascript
// Database statistics
db.stats();

// Collection statistics
db.usage_events.stats();
db.daily_aggregates.stats();

// Index statistics
db.usage_events.aggregate([{ $indexStats: {} }]);
```

### Query Performance

```javascript
// Enable profiling (level 2 = all operations)
db.setProfilingLevel(2);

// View slow queries
db.system.profile.find({ millis: { $gt: 100 } }).sort({ ts: -1 });

// Explain query
db.usage_events.find({ project_name: "my_app" }).explain("executionStats");
```

### Application Metrics

```python
# Check client stats
stats = client.get_stats()
print(f"Queue size: {stats['queue_size']}")

# Health check
healthy = await client.health_check()
print(f"Backend healthy: {healthy}")
```

## Sharding

For horizontal scaling, enable sharding:

```javascript
// Enable sharding on database
sh.enableSharding("token_usage");

// Shard usage_events collection by project and timestamp
sh.shardCollection("token_usage.usage_events", {
  project_name: 1,
  timestamp: 1,
});

// Shard daily_aggregates by date and project
sh.shardCollection("token_usage.daily_aggregates", {
  date: 1,
  project_name: 1,
});
```

<Info>
  Sharding is ideal for multi-tenant applications with distinct projects
</Info>

## Troubleshooting

<AccordionGroup>
  <Accordion title="Connection Timeout">
    **Symptom:** `ServerSelectionTimeoutError` **Solution:** - Verify MongoDB is
    running - Check connection string format - Increase
    `mongodb_server_selection_timeout` - Check firewall rules
  </Accordion>

  <Accordion title="Authentication Failed">
    **Symptom:** `Authentication failed` **Solution:** - Verify username and
    password - Check `authSource` in connection string - Ensure user has proper
    roles
  </Accordion>

  <Accordion title="Slow Writes">
    **Symptom:** High write latency **Solution:** - Check write concern (default
    is `w=1`) - Reduce index count if excessive - Increase batch size - Consider
    sharding for horizontal scaling
  </Accordion>

  <Accordion title="Slow Queries">
    **Symptom:** High read latency **Solution:** - Add missing indexes - Use
    `explain()` to analyze queries - Consider covering indexes - Optimize
    aggregation pipelines
  </Accordion>
</AccordionGroup>

## Best Practices

<CardGroup cols={2}>
  <Card title="Use Indexes" icon="magnifying-glass">
    Create indexes for all query patterns
  </Card>
  <Card title="Connection Pooling" icon="link">
    Configure pool size for your workload
  </Card>
  <Card title="TTL for Retention" icon="clock">
    Use TTL indexes for automatic cleanup
  </Card>
  <Card title="Monitor Performance" icon="gauge">
    Enable profiling in production
  </Card>
</CardGroup>

## MongoDB Atlas Features

When using MongoDB Atlas:

- **Auto-scaling:** Automatically adjust cluster size
- **Backup:** Point-in-time restore
- **Monitoring:** Built-in performance advisor
- **Search:** Full-text search with Atlas Search

```python
# Atlas connection string
settings = Settings(
    backend="mongodb",
    mongodb_url="mongodb+srv://user:pass@cluster.mongodb.net/?retryWrites=true&w=majority",
    mongodb_database="token_usage"
)
```

<CardGroup cols={2}>
  <Card title="Previous: Supabase" icon="cloud" href="/backends/supabase">
    Supabase backend documentation
  </Card>
  <Card
    title="Next: Configuration"
    icon="sliders"
    href="/advanced/configuration"
  >
    Advanced configuration options
  </Card>
</CardGroup>
