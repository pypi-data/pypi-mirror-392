# Metamorphic Guard Evaluation Template
# 
# This template runs Metamorphic Guard evaluations in CI/CD pipelines.
# 
# Usage:
#   1. Copy this file to your repository's .github/workflows/ directory
#   2. Customize the task, baseline, and candidate paths
#   3. Optionally set environment variables for API keys
#
# Example:
#   - name: Evaluate candidate
#     run: |
#       metamorphic-guard evaluate \
#         --task my_task \
#         --baseline baseline.py \
#         --candidate candidate.py \
#         --n 400

name: Metamorphic Guard Evaluation

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  evaluate:
    runs-on: ubuntu-latest
    name: Evaluate Candidate Implementation
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install metamorphic-guard
          # Install your project dependencies
          pip install -r requirements.txt
      
      - name: Run Metamorphic Guard evaluation
        env:
          # Set API keys if using LLM executors
          # OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          # ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          metamorphic-guard evaluate \
            --task ${{ vars.MG_TASK_NAME || 'top_k' }} \
            --baseline ${{ vars.MG_BASELINE_PATH || 'baseline.py' }} \
            --candidate ${{ vars.MG_CANDIDATE_PATH || 'candidate.py' }} \
            --n ${{ vars.MG_N || '400' }} \
            --min-delta ${{ vars.MG_MIN_DELTA || '0.02' }} \
            --min-pass-rate ${{ vars.MG_MIN_PASS_RATE || '0.80' }} \
            --report-dir reports \
            --html-report reports/report.html \
            --junit-report reports/junit.xml
      
      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: metamorphic-guard-reports
          path: reports/
          retention-days: 30
      
      - name: Publish JUnit results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: reports/junit.xml
          check_name: Metamorphic Guard Results
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            try {
              const reportPath = path.join('reports', 'report_*.json');
              const files = fs.readdirSync('reports').filter(f => f.startsWith('report_') && f.endsWith('.json'));
              
              if (files.length > 0) {
                const report = JSON.parse(fs.readFileSync(path.join('reports', files[0]), 'utf8'));
                const decision = report.decision || {};
                
                const body = `## Metamorphic Guard Evaluation Results
                
                **Decision**: ${decision.adopt ? '✅ Adopt' : '❌ Reject'}
                **Reason**: ${decision.reason || 'N/A'}
                
                **Statistics**:
                - Baseline Pass Rate: ${(report.baseline?.pass_rate || 0).toFixed(3)}
                - Candidate Pass Rate: ${(report.candidate?.pass_rate || 0).toFixed(3)}
                - Δ Pass Rate: ${(report.statistics?.delta || 0).toFixed(4)}
                - Δ 95% CI: [${(report.statistics?.delta_ci?.[0] || 0).toFixed(4)}, ${(report.statistics?.delta_ci?.[1] || 0).toFixed(4)}]
                
                [View full report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
                
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: body
                });
              }
            } catch (error) {
              console.error('Failed to comment PR:', error);
            }

