# [your_file].py

# Copyright (C) [2025] Eduardo Antonio Ferrera Rodríguez
# 
# This program is free software: you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY. See the COPYING file for more details.


# pyfront/html_doc.py

from .dom import DOM
from .css import CSSRegistry

class HtmlDoc:
    """
    Represents a complete HTML document with automatically generated CSS.
    Manages root blocks and produces index.html and style.css.
    Allows additional attributes in <head> (meta, script, style).
    """

    def __init__(self, title="Untitled Document", path=".", **head_attrs):
        self.title = title
        self.path = path.strip()
        if not self.path.endswith("/"):
            self.path += "/"

        self.html_file = self.path + "index.html"
        self.css_file = self.path + "style.css"

        # Root blocks (those without id)
        self.blocks_root = []

        # Optional head attributes
        self.head_attrs = head_attrs

        # Base HTML and CSS templates
        self._html_base = self._generate_base_html()
        self._css_base = self._generate_base_css()

    # ------------------------------
    # Generate <head> content
    # ------------------------------
    def _generate_head(self):
        lines = [f"<meta charset='UTF-8'>"]
        # dynamic title
        lines.append(f"<title>{self.title}</title>")
        # default CSS link
        lines.append(f"<link rel='stylesheet' href='style.css'>")

        # Additional meta tags (list of dictionaries)
        metas = self.head_attrs.get("meta", [])
        for m in metas:
            attrs = " ".join(f'{k}="{v}"' for k, v in m.items())
            lines.append(f"<meta {attrs}>")

        # Inline scripts
        scripts = self.head_attrs.get("script", [])
        for s in scripts:
            lines.append(f"<script>{s}</script>")

        # Inline styles
        styles = self.head_attrs.get("style", [])
        for st in styles:
            lines.append(f"<style>{st}</style>")

        return "\n    ".join(lines)

    # ------------------------------
    # Base HTML and CSS
    # ------------------------------
    def _generate_base_html(self):
        head_content = self._generate_head()
        return f"""<!DOCTYPE html>
<html lang="en">
<head>
    {head_content}
</head>
<body>
{{body_content}}
</body>
</html>
"""

    def _generate_base_css(self):
        return """/* Stylesheet generated by FrontPy */
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
}
"""

    # ------------------------------
    # Register root blocks
    # ------------------------------
    def add_root_block(self, block):
        """
        Adds a block to the document as a root if it has no id.
        Blocks with id are managed through the DOM.
        """
        if block.attrs.get("id") is None:
            self.blocks_root.append(block)

    # ------------------------------
    # Body rendering
    # ------------------------------
    def render_body(self):
        """
        Generates the HTML of all root blocks and DOM blocks without duplication.
        """
        all_blocks = list(self.blocks_root)

        # Add DOM blocks that are not in root
        for block_id in DOM._by_id:
            block = DOM.get(block_id)
            if block._parent is None and block not in all_blocks:
                all_blocks.append(block)

        # Render body
        html = "".join(block.render(indent=2) for block in all_blocks)
        return html

    # ------------------------------
    # Document creation
    # ------------------------------
    def create_document(self):
        """
        Creates index.html and style.css with root blocks, DOM blocks, and CSS selectors.
        """
        # Render body
        body_content = self.render_body()
        html_final = self._html_base.replace("{body_content}", body_content)

        # Generate CSS
        css_final = self._css_base + "\n" + CSSRegistry.generate_css()

        # Write files
        try:
            with open(self.html_file, "w", encoding="utf-8") as f_html:
                f_html.write(html_final)

            with open(self.css_file, "w", encoding="utf-8") as f_css:
                f_css.write(css_final)

            print(f"✅ Documents created: {self.html_file} and {self.css_file}")
        except Exception as e:
            print(f"❌ Error creating files: {e}")
