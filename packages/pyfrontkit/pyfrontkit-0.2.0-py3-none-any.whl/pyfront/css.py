# [your_file].py

# Copyright (C) [2025] Eduardo Antonio Ferrera Rodríguez
#
# This program is free software: you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation, either version 3 of the License, or any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY. See the COPYING file for more details.


# pyfront/css.py
from pathlib import Path

class CSSRegistry:
    """
    CSS selector registry for blocks and CTN content.
    - Registers id, class, tag
    - Registers cascades based on parent → child hierarchy
    - Avoids duplicates
    """

    _selectors = set()
    _css_path = Path("style.css")

    @classmethod
    def _ensure_file(cls):
        if not cls._css_path.exists():
            cls._css_path.write_text("/* CSS file generated by FrontPy */\n\n", encoding="utf-8")

    @classmethod
    def register_selector(cls, selector: str):
        """
        Registers a simple or cascade selector.
        Avoids duplicates.
        """
        if not selector or selector in cls._selectors:
            return

        cls._selectors.add(selector)
        cls._ensure_file()

        entry = f"{selector} {{\n    /* styles here */\n}}\n\n"
        with cls._css_path.open("a", encoding="utf-8") as f:
            f.write(entry)

    @classmethod
    def register_block(cls, block):
        """
        Registers the selectors of a block:
        - tag, id, classes
        - cascades with parents
        - includes CTN content
        """
        selectors = []

        # tag
        selectors.append(block.tag)

        # id
        block_id = block.attrs.get("id")
        if block_id:
            selectors.append(f"#{block_id}")

        # classes
        classes = block.attrs.get("class")
        if classes:
            for cls_name in str(classes).split():
                selectors.append(f".{cls_name}")

        # register each simple selector
        for sel in selectors:
            cls.register_selector(sel)

        # cascade: generate combinations with parents
        chain = cls._get_parent_chain(block)
        for ctn_item in getattr(block, "content_items", []):
            # include content tag
            content_tag = getattr(ctn_item, "tag", None)
            if content_tag:
                selector = " ".join(chain + [content_tag])
                cls.register_selector(selector)

        # cascades for children that are Blocks
        for child in getattr(block, "children", []):
            if isinstance(child, Block):
                cls.register_block(child)

    @classmethod
    def _get_parent_chain(cls, block):
        """
        Generates a list of parent selectors with id, from root to this block.
        """
        chain = []
        current = getattr(block, "_parent", None)
        while current:
            sel = current.tag
            if current.attrs.get("id"):
                sel = f"#{current.attrs['id']}"
            chain.insert(0, sel)
            current = getattr(current, "_parent", None)
        return chain

    @classmethod
    def generate_css(cls):
        """
        Generates the complete CSS in memory based on current selectors.
        Returns a string ready to write into style.css
        """
        css_lines = ["/* Selectors generated by FrontPy */\n"]
        for sel in sorted(cls._selectors):
            css_lines.append(f"{sel} {{\n    /* styles here */\n}}\n")
        return "\n".join(css_lines)
