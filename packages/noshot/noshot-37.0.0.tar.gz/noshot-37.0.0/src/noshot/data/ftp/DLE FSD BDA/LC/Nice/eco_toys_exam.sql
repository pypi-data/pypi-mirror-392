
-- eco_toys_exam.sql
-- Exam-ready, reusable Oracle SQL/PLSQL script for Oracle APEX labs
-- Includes: schema, constraints, sample data, trigger, window examples, MODEL clause,
-- form/report SQLs, chart queries, regex patterns, PL/SQL validations, stored procedures.
-- Run in SQL Workshop -> SQL Scripts (Oracle APEX) or SQL*Plus / SQL Developer.

-- ==================================================================================
-- 0) Safety: Drop objects if present (dev only). This block attempts to drop known objects.
-- ==================================================================================
BEGIN
  FOR r IN (SELECT object_name, object_type FROM user_objects
            WHERE object_name IN (
              'PARENT_CHILD_VIEW','TODDLER_LOG','TOYS','MATERIALS','CHILDREN','PARENTS',
              'TRG_CHILD_INSERT_LOG','ADD_PARENT_WITH_CHILD'
            ))
  LOOP
    BEGIN
      IF r.object_type = 'TABLE' THEN
        EXECUTE IMMEDIATE 'DROP TABLE "' || r.object_name || '" CASCADE CONSTRAINTS PURGE';
      ELSIF r.object_type = 'VIEW' THEN
        EXECUTE IMMEDIATE 'DROP VIEW "' || r.object_name || '"';
      ELSIF r.object_type = 'TRIGGER' THEN
        EXECUTE IMMEDIATE 'DROP TRIGGER "' || r.object_name || '"';
      ELSE
        NULL;
      END IF;
    EXCEPTION WHEN OTHERS THEN
      NULL;
    END;
  END LOOP;
END;
/
-- ==================================================================================
-- 1) Schema: parents, children, materials, toys, toddler_log and a helpful view
-- ==================================================================================

CREATE TABLE PARENTS (
  PARENT_ID      NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  FULL_NAME      VARCHAR2(100) NOT NULL,
  AGE            NUMBER(3) CHECK (AGE BETWEEN 18 AND 100),
  GENDER         VARCHAR2(20) CHECK (GENDER IN ('Male','Female','Other','Prefer not to say')),
  MOBILE         VARCHAR2(20) UNIQUE,
  EMAIL          VARCHAR2(150),
  NUM_CHILDREN   NUMBER(2) DEFAULT 0 CHECK (NUM_CHILDREN >= 0),
  CREATED_AT     TIMESTAMP DEFAULT SYSTIMESTAMP
);

CREATE TABLE CHILDREN (
  CHILD_ID       NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  PARENT_ID      NUMBER NOT NULL,
  CHILD_NAME     VARCHAR2(100) NOT NULL,
  CHILD_DOB      DATE,
  CHILD_AGE      NUMBER(2),
  FAV_CATEGORY   VARCHAR2(50),
  CREATED_AT     TIMESTAMP DEFAULT SYSTIMESTAMP,
  CONSTRAINT FK_CHILD_PARENT FOREIGN KEY (PARENT_ID) REFERENCES PARENTS (PARENT_ID) ON DELETE CASCADE
);

CREATE TABLE MATERIALS (
  MATERIAL_ID    VARCHAR2(20) PRIMARY KEY,
  MAT_NAME       VARCHAR2(150) NOT NULL,
  TEXTURE        VARCHAR2(60),
  COLOUR         VARCHAR2(40),
  SOURCE         VARCHAR2(30) CHECK (SOURCE IN ('Organic','Recycled','Sustainably Sourced','Mixed')),
  SAFETY_CERT    VARCHAR2(60),
  NOTES          VARCHAR2(2000),
  CREATED_AT     TIMESTAMP DEFAULT SYSTIMESTAMP
);

CREATE TABLE TOYS (
  TOY_ID         NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  TOY_NAME       VARCHAR2(150) NOT NULL,
  MATERIAL_ID    VARCHAR2(20) NOT NULL,
  SHAPE          VARCHAR2(50),
  COLOR          VARCHAR2(30),
  AGE_MIN        NUMBER(2),
  AGE_MAX        NUMBER(2),
  ANIMAL_PATTERN CHAR(1) CHECK (ANIMAL_PATTERN IN ('Y','N')),
  CREATED_AT     TIMESTAMP DEFAULT SYSTIMESTAMP,
  CONSTRAINT FK_TOY_MATERIAL FOREIGN KEY (MATERIAL_ID) REFERENCES MATERIALS (MATERIAL_ID)
);

CREATE TABLE TODDLER_LOG (
  LOG_ID         NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  CHILD_ID       NUMBER,
  PARENT_ID      NUMBER,
  CHILD_NAME     VARCHAR2(100),
  CHILD_AGE      NUMBER,
  FAV_CATEGORY   VARCHAR2(50),
  ACTION         VARCHAR2(30),
  LOGGED_AT      TIMESTAMP DEFAULT SYSTIMESTAMP
);

-- Helpful view combining parents & children for reports/forms
CREATE OR REPLACE VIEW PARENT_CHILD_VIEW AS
SELECT p.parent_id,
       p.full_name parent_name,
       p.mobile,
       p.email,
       p.num_children,
       c.child_id,
       c.child_name,
       c.child_dob,
       c.child_age,
       c.fav_category
FROM parents p
LEFT JOIN children c ON p.parent_id = c.parent_id;

COMMIT;

-- ==================================================================================
-- 2) Sample data (change/remove as needed for exam)
-- ==================================================================================
INSERT INTO PARENTS (FULL_NAME, AGE, GENDER, MOBILE, EMAIL, NUM_CHILDREN)
VALUES ('Anita Sharma', 32, 'Female', '9876543210', 'anita@example.com', 2);

INSERT INTO PARENTS (FULL_NAME, AGE, GENDER, MOBILE, EMAIL, NUM_CHILDREN)
VALUES ('Ravi Kumar', 38, 'Male', '9123456780', 'ravi@example.com', 1);

INSERT INTO MATERIALS (MATERIAL_ID, MAT_NAME, TEXTURE, COLOUR, SOURCE, SAFETY_CERT)
VALUES ('MAT001', 'Beech Wood', 'Smooth', 'Natural', 'Sustainably Sourced', 'EN71');

INSERT INTO MATERIALS (MATERIAL_ID, MAT_NAME, TEXTURE, COLOUR, SOURCE, SAFETY_CERT)
VALUES ('MAT002', 'Organic Cotton', 'Soft', 'Multicolor', 'Organic', 'OEKO-TEX');

INSERT INTO CHILDREN (PARENT_ID, CHILD_NAME, CHILD_DOB, CHILD_AGE, FAV_CATEGORY)
VALUES (1, 'Maya', DATE '2022-05-10', 3, 'Soft Toys');

INSERT INTO CHILDREN (PARENT_ID, CHILD_NAME, CHILD_DOB, CHILD_AGE, FAV_CATEGORY)
VALUES (1, 'Rohan', DATE '2024-02-20', 1, 'Wooden Blocks');

INSERT INTO CHILDREN (PARENT_ID, CHILD_NAME, CHILD_DOB, CHILD_AGE, FAV_CATEGORY)
VALUES (2, 'Ishaan', DATE '2021-11-15', 4, 'Puzzle Toys');

COMMIT;

-- ==================================================================================
-- 3) Trigger: log toddler details on child INSERT (useful for audit & report)
-- ==================================================================================
CREATE OR REPLACE TRIGGER trg_child_insert_log
AFTER INSERT ON CHILDREN
FOR EACH ROW
DECLARE
  v_action VARCHAR2(30) := 'INSERT_CHILD';
BEGIN
  INSERT INTO TODDLER_LOG (CHILD_ID, PARENT_ID, CHILD_NAME, CHILD_AGE, FAV_CATEGORY, ACTION)
  VALUES (:NEW.CHILD_ID, :NEW.PARENT_ID, :NEW.CHILD_NAME, :NEW.CHILD_AGE, :NEW.FAV_CATEGORY, v_action);
END;
/
COMMIT;

-- Query to show toddler log (use as APEX Interactive Report)
-- SELECT log_id, child_id, parent_id, child_name, child_age, fav_category, action, logged_at FROM toddler_log ORDER BY logged_at DESC;

-- ==================================================================================
-- 4) Window function examples (for reports / interactive SQL)
-- ==================================================================================

-- a) Count children per parent with rank
-- Use this in a report region
-- Note: This uses a subquery to ensure proper aggregation before ranking.
SELECT parent_id, parent_name, num_children,
       children_count,
       DENSE_RANK() OVER (ORDER BY children_count DESC) rank_by_children
FROM (
  SELECT p.parent_id, p.full_name parent_name, p.num_children,
         COUNT(c.child_id) OVER (PARTITION BY p.parent_id) children_count
  FROM parents p
  LEFT JOIN children c ON p.parent_id = c.parent_id
)
ORDER BY children_count DESC;

-- b) Running average of child ages ordered by created_at
SELECT child_id, child_name, child_age, created_at,
       ROUND(AVG(child_age) OVER (ORDER BY created_at ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW),2) running_avg_age
FROM children
ORDER BY created_at;

-- c) Max child age per parent
SELECT child_id, parent_id, child_name, child_age,
       MAX(child_age) OVER (PARTITION BY parent_id) max_age_for_parent
FROM children;

-- ==================================================================================
-- 5) MODEL clause examples (educational)
-- ==================================================================================
-- Simple MODEL to display counts by age and allow model rules (examiners look for syntax)
SELECT *
FROM (
  SELECT child_age, COUNT(*) cnt
  FROM children
  GROUP BY child_age
)
MODEL
  DIMENSION BY (child_age)
  MEASURES (cnt)
  RULES (
    -- trivial rule: if age missing, set to 0 (demo)
    cnt[ANY] = NVL(cnt[CV()], 0)
  );

-- ==================================================================================
-- 6) Two forms + report SQLs (APEX-ready)
-- ==================================================================================
-- Form 1 (Parent) - Source SQL for form: SELECT * FROM parents WHERE parent_id = :P_PARENT_ID
-- Insert process example (PL/SQL) - set as "Processing" in APEX Form
-- BEGIN
--   INSERT INTO parents (full_name, age, gender, mobile, email, num_children)
--   VALUES (:P_FULL_NAME, :P_AGE, :P_GENDER, :P_MOBILE, :P_EMAIL, :P_NUM_CHILDREN);
--   COMMIT;
-- END;

-- Update process example
-- BEGIN
--   UPDATE parents
--   SET full_name = :P_FULL_NAME,
--       age = :P_AGE,
--       gender = :P_GENDER,
--       mobile = :P_MOBILE,
--       email = :P_EMAIL,
--       num_children = :P_NUM_CHILDREN
--   WHERE parent_id = :P_PARENT_ID;
--   COMMIT;
-- END;

-- Form 2 (Material) - Source SQL: SELECT * FROM materials WHERE material_id = :P_MATERIAL_ID
-- Insert example:
-- BEGIN
--   INSERT INTO materials (material_id, mat_name, texture, colour, source, safety_cert, notes)
--   VALUES (:P_MATERIAL_ID, :P_MAT_NAME, :P_TEXTURE, :P_COLOUR, :P_SOURCE, :P_SAFETY_CERT, :P_NOTES);
--   COMMIT;
-- END;

-- Reports (Interactive Reports)
-- Toddlers report SQL:
-- SELECT parent_id, parent_name, child_id, child_name, child_age, fav_category FROM parent_child_view ORDER BY parent_id, child_id;

-- Materials report SQL:
-- SELECT material_id, mat_name, texture, colour, source, safety_cert, created_at FROM materials ORDER BY mat_name;

-- ==================================================================================
-- 7) Chart SQL queries (use as Chart Region SQL Source in APEX)
-- ==================================================================================
-- Chart 1: Pie/Donut - Material Source Distribution
-- SQL:
-- SELECT source label, COUNT(*) value FROM materials GROUP BY source ORDER BY COUNT(*) DESC;

-- Chart 2: Bar - Favourite Toy Categories among registered children
-- SQL:
-- SELECT NVL(fav_category,'Unknown') label, COUNT(*) value FROM children GROUP BY fav_category ORDER BY COUNT(*) DESC;

-- Chart 3: Line - Child age distribution (count by age)
-- SQL:
-- SELECT child_age x_value, COUNT(*) y_value FROM children GROUP BY child_age ORDER BY child_age;

-- Annotation suggestions (use Chart Static Text / Region text in APEX):
-- For each chart, in the chart attributes add Title and Subtitle and a short annotation e.g.:
-- "Material Source Distribution -- shows proportion of Organic, Recycled & Sustainably Sourced materials."
-- "Children's Favourite Toy Categories -- helps prioritize production."
-- "Child Age Distribution -- highlights demand by age group; mark key ages 1,2,3."

-- ==================================================================================
-- 8) Regular expressions and APEX validations (patterns and examples)
-- ==================================================================================
-- Name (letters, spaces, hyphens, apostrophes):
-- ^[A-Za-z]+(?:[ '\-][A-Za-z]+)*$
-- Mobile (India: optional +91 or 0, then 10 digits starting 6-9):
-- ^(?:\+91|0)?[6-9]\d{9}$
-- Email:
-- ^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$
-- DOB format check (YYYY-MM-DD):
-- ^\d{4}-\d{2}-\d{2}$
-- Material ID (alnum + - _ up to 20 chars):
-- ^[A-Za-z0-9_-]{1,20}$

-- Example APEX PL/SQL validation (Page Validation type: PL/SQL Function returning Text)
-- Validate DOB not in future and age consistency:
-- DECLARE
--   v_dob DATE := :P_CHILD_DOB;
-- BEGIN
--   IF v_dob IS NULL THEN
--     RETURN 'DOB is required.';
--   ELSIF v_dob > TRUNC(SYSDATE) THEN
--     RETURN 'Date of birth cannot be in the future.';
--   ELSIF :P_CHILD_AGE IS NOT NULL AND :P_CHILD_AGE <> FLOOR(MONTHS_BETWEEN(TRUNC(SYSDATE), v_dob)/12) THEN
--     RETURN 'Child age does not match DOB.';
--   ELSE
--     RETURN NULL;
--   END IF;
-- END;

-- ==================================================================================
-- 9) Useful stored procedure: add parent with one child (transactional)
-- ==================================================================================
CREATE OR REPLACE PROCEDURE add_parent_with_child (
  p_full_name     IN VARCHAR2,
  p_age           IN NUMBER,
  p_mobile        IN VARCHAR2,
  p_email         IN VARCHAR2,
  p_child_name    IN VARCHAR2,
  p_child_dob     IN DATE,
  p_child_category IN VARCHAR2
)
AS
  v_parent_id NUMBER;
BEGIN
  INSERT INTO parents (full_name, age, mobile, email, num_children)
  VALUES (p_full_name, p_age, p_mobile, p_email, 1)
  RETURNING parent_id INTO v_parent_id;

  INSERT INTO children (parent_id, child_name, child_dob, child_age, fav_category)
  VALUES (v_parent_id, p_child_name, p_child_dob,
          FLOOR(MONTHS_BETWEEN(TRUNC(SYSDATE), p_child_dob)/12), p_child_category);

  COMMIT;
EXCEPTION
  WHEN OTHERS THEN
    ROLLBACK;
    RAISE;
END;
/
COMMIT;

-- ==================================================================================
-- 10) Authorization & Authentication: exam notes (implement in APEX UI)
-- ==================================================================================
-- COMMENTS:
-- 1) Create Authentication Scheme: APEX -> Shared Components -> Authentication Schemes (use Application Express Accounts for exam).
-- 2) Create Authorization Schemes:
--    - Example: CAN_EDIT_MATERIALS (PL/SQL function returning boolean)
--      BEGIN RETURN apex_util.get_user_id = 'ADMIN_USER'; END;
-- 3) Apply authorization scheme to sensitive pages or buttons (Materials edit page).
-- 4) For custom user table, store hashed passwords (DBMS_CRYPTO) - out of scope for short script.

-- ==================================================================================
-- 11) Miscellaneous helpful SQL snippets (for dashboard pages)
-- ==================================================================================
-- Dashboard quick counts:
-- SELECT (SELECT COUNT(*) FROM parents) total_parents,
--        (SELECT COUNT(*) FROM children) total_children,
--        (SELECT COUNT(*) FROM materials) total_materials
-- FROM dual;

-- Search children by name (case-insensitive) - use as report filter:
-- SELECT * FROM children WHERE LOWER(child_name) LIKE LOWER('%' || :P_SEARCH || '%');

-- ==================================================================================
-- End of file
-- ==================================================================================
