name: Build and Publish AutoReportV2

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  id-token: write  # ç”¨äºPyPIå¯ä¿¡å‘å¸ƒ

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´çš„Gitå†å²ï¼Œç¡®ä¿æ ‡ç­¾å¯è§
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'  # æ¨èç‰ˆæœ¬
        
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install build twine setuptools-scm[toml]
        
    - name: Verify Git and version info
      run: |
        echo "Current Git tag: ${{ github.ref_name }}"
        echo "Git tags:"
        git tag --list
        echo "Package version detection:"
        python -c "from setuptools_scm import get_version; print(f'Detected version: {get_version()}')"
        
    - name: Build package
      run: |
        echo "Building package..."
        python -m build
        echo "Build artifacts:"
        ls -la dist/
        
    - name: Verify package metadata
      run: |
        echo "Checking package distribution..."
        python -m twine check dist/*
        echo "Package contents:"
        python -c "
        import tarfile
        import glob
        for f in glob.glob('dist/*.tar.gz'):
            print(f'Contents of {f}:')
            with tarfile.open(f, 'r:gz') as tar:
                tar.list()
        "
        
    - name: Test local installation
      run: |
        echo "Testing local installation..."
        python -m pip install dist/*.whl
        python -c "
        import autoreport
        print(f'Installed version: {autoreport.__version__}')
        print(f'Package name: aerospot-autoreport')
        print('Installation test passed!')
        "
    
    - name: Publish to PyPI
      if: startsWith(github.ref, 'refs/tags/v')
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
        # å¯é€‰ï¼šä½¿ç”¨å¯ä¿¡å‘å¸ƒ
        # skip-existing: true
        
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: AutoReport ${{ github.ref_name }}
        body: |
          ## ğŸ‰ AutoReport ${{ github.ref_name }} å‘å¸ƒ
          
          ### ğŸ“¦ å®‰è£…æ–¹å¼
          
          ```bash
          # ä»PyPIå®‰è£…
          pip install aerospot-autoreport==${{ github.ref_name }}
          
          # æˆ–è€…å®‰è£…æœ€æ–°ç‰ˆæœ¬
          pip install aerospot-autoreport
          ```
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          
          #### å‘½ä»¤è¡Œä½¿ç”¨ï¼š
          ```bash
          autoreport --config config.json
          ```
          
          #### Python APIä½¿ç”¨ï¼š
          ```python
          from autoreport import get_aerospotreportgenerator
          
          # åˆ›å»ºæŠ¥å‘Šç”Ÿæˆå™¨
          generator_class = get_aerospotreportgenerator()
          generator = generator_class()
          
          # ç”ŸæˆæŠ¥å‘Š
          result = generator.generate_report({
              "file_url": "your_data.zip",
              "measure_data": "your_measure.csv",
              "output_dir": "./reports"
          })
          ```
          
          ### ğŸ“‹ ä¸»è¦åŠŸèƒ½
          - âœ… è‡ªåŠ¨åŒ–æ•°æ®å¤„ç†å’Œåˆ†æ
          - âœ… ç”Ÿæˆä¸“ä¸šçš„WordæŠ¥å‘Š
          - âœ… æ”¯æŒå¤šç§æ•°æ®æ ¼å¼
          - âœ… å¯é…ç½®çš„æŠ¥å‘Šæ¨¡æ¿
          - âœ… è·¨å¹³å°å…¼å®¹ï¼ˆWindows/Linux/macOSï¼‰
          
          ### ğŸ”— ç›¸å…³é“¾æ¥
          - ğŸ“– [æ–‡æ¡£](https://autoreport-v2.readthedocs.io/)
          - ğŸ› [é—®é¢˜åé¦ˆ](https://github.com/1034378361/AutoReportV2/issues)
          - ğŸ’¬ [è®¨è®ºåŒº](https://github.com/1034378361/AutoReportV2/discussions)
          
          ---
          
          **å®Œæ•´æ›´æ–°æ—¥å¿—:** è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/1034378361/AutoReportV2/blob/${{ github.ref_name }}/CHANGELOG.md)
        files: |
          dist/*
        draft: false
        prerelease: false