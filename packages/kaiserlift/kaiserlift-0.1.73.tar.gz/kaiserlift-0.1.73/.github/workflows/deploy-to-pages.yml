name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write

jobs:
  deploy:
    name: Deploy to douglastkaiser.github.io
    runs-on: ubuntu-latest

    steps:
      - name: Checkout kaiserlift repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for setuptools-scm

      - uses: astral-sh/setup-uv@v6

      - name: Sync dependencies
        run: uv sync

      - name: Inject version into client
        run: uv run --with setuptools-scm python scripts/inject_version.py

      - name: Preprocess CSV data for optimal loading
        run: uv run python scripts/preprocess_data.py

      - name: Generate example HTML
        run: uv run python tests/example_use/generate_example_html.py

      - name: Verify build output
        run: |
          echo "Build directory contents:"
          ls -la tests/example_use/build/
          echo ""
          echo "Subdirectories:"
          ls -la tests/example_use/build/*/ 2>/dev/null || echo "Warning: No subdirectories found!"
          echo ""
          echo "Critical files check:"
          [ -f "tests/example_use/build/index.html" ] && echo "âœ“ index.html exists" || (echo "âœ— index.html MISSING" && exit 1)
          [ -f "tests/example_use/build/lifting/index.html" ] && echo "âœ“ lifting/index.html exists" || (echo "âœ— lifting/index.html MISSING" && exit 1)
          [ -f "tests/example_use/build/running/index.html" ] && echo "âœ“ running/index.html exists" || (echo "âœ— running/index.html MISSING" && exit 1)
          [ -f "tests/example_use/build/.nojekyll" ] && echo "âœ“ .nojekyll exists" || (echo "âœ— .nojekyll MISSING" && exit 1)
          echo ""
          echo "All critical files present!"

      - name: Deploy to GitHub Pages repo
        env:
          GITHUB_TOKEN: ${{ secrets.PAGES_DEPLOY_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Clone the GitHub Pages repository
          PAGES_REPO="douglastkaiser/douglastkaiser.github.io"
          TEMP_DIR="/tmp/pages-repo"
          rm -rf "$TEMP_DIR"

          # Use token authentication for cloning
          git clone "https://x-access-token:${GITHUB_TOKEN}@github.com/${PAGES_REPO}.git" "$TEMP_DIR"

          cd "$TEMP_DIR"

          # Create kaiserlift directory if it doesn't exist
          mkdir -p kaiserlift

          # Show what currently exists
          echo "Current kaiserlift directory contents BEFORE cleanup:"
          ls -la kaiserlift/ || echo "Directory empty or doesn't exist"

          # Remove old kaiserlift contents but keep the directory
          rm -rf kaiserlift/*

          # Explicitly remove old example.html if it exists (legacy cleanup)
          rm -f kaiserlift/example.html

          echo "After cleanup:"
          ls -la kaiserlift/

          # Verify source build directory exists and has content
          if [ ! -d "${{ github.workspace }}/tests/example_use/build" ]; then
            echo "ERROR: Build directory does not exist!"
            exit 1
          fi

          echo "Source build directory contents:"
          ls -laR "${{ github.workspace }}/tests/example_use/build/"

          # Copy new build files to kaiserlift directory
          rsync -av --exclude='__pycache__' --exclude='*.pyc' --exclude='*.pyo' \
            ${{ github.workspace }}/tests/example_use/build/ kaiserlift/

          # Ensure .nojekyll exists in repo root (not just kaiserlift subdir)
          # This prevents GitHub Pages from processing files through Jekyll
          touch .nojekyll

          # Verify what we're about to commit
          echo "Files in kaiserlift directory:"
          ls -la kaiserlift/
          echo ""
          echo "Subdirectories in kaiserlift:"
          ls -la kaiserlift/*/  2>/dev/null || echo "No subdirectories found!"
          echo ""
          echo "Checking for critical files:"
          [ -f "kaiserlift/index.html" ] && echo "âœ“ index.html exists" || echo "âœ— index.html MISSING"
          [ -f "kaiserlift/lifting/index.html" ] && echo "âœ“ lifting/index.html exists" || echo "âœ— lifting/index.html MISSING"
          [ -f "kaiserlift/running/index.html" ] && echo "âœ“ running/index.html exists" || echo "âœ— running/index.html MISSING"
          [ -f "kaiserlift/.nojekyll" ] && echo "âœ“ .nojekyll exists" || echo "âœ— .nojekyll MISSING"
          echo ""
          echo "Checking index.html content (link verification):"
          grep -o 'href="[^"]*".*View Lifting Demo' kaiserlift/index.html || echo "WARNING: Could not find View Lifting Demo link!"
          echo ""
          echo "Checking for OLD example.html reference:"
          grep -q 'href="example.html"' kaiserlift/index.html && echo "ERROR: Old example.html link found!" || echo "âœ“ No example.html link found"
          echo ""
          echo "Git status:"
          git status

          # Stage changes (force add all files including in subdirectories)
          git add -A kaiserlift/ .nojekyll

          # Show what's being staged
          echo "Files staged for commit:"
          git diff --staged --name-status
          echo ""
          echo "Checking staged critical files:"
          git diff --staged --name-only | grep "kaiserlift/index.html" || echo "WARNING: index.html NOT staged!"
          git diff --staged --name-only | grep "kaiserlift/lifting/" || echo "WARNING: No lifting/ files staged!"
          git diff --staged --name-only | grep "kaiserlift/running/" || echo "WARNING: No running/ files staged!"
          echo ""
          echo "Verifying .nojekyll in root:"
          git diff --staged --name-only | grep "^\.nojekyll$" || echo "WARNING: .nojekyll NOT staged in root!"

          # Commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to deploy"
          else
            git commit -m "Deploy kaiserlift from ${{ github.repository }}@${{ github.sha }}"

            # Verify commit contents
            echo "Verifying committed files:"
            git show --name-status --format="" HEAD | head -20

            # Push with retry logic
            MAX_RETRIES=4
            RETRY_COUNT=0
            PUSH_SUCCESS=false

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if git push origin main 2>&1; then
                PUSH_SUCCESS=true
                echo "Successfully deployed to GitHub Pages!"
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  WAIT_TIME=$((2 ** RETRY_COUNT))
                  echo "Push failed, retrying in ${WAIT_TIME}s ($RETRY_COUNT/$MAX_RETRIES)..."
                  sleep $WAIT_TIME
                  git pull --rebase origin main
                fi
              fi
            done

            if [ "$PUSH_SUCCESS" = false ]; then
              echo "Failed to push after $MAX_RETRIES attempts"
              exit 1
            fi
          fi

      - name: Add deployment summary
        run: |
          {
            echo "### ðŸŒ Deployed to GitHub Pages";
            echo "";
            echo "âœ… Successfully deployed to https://www.douglastkaiser.com/kaiserlift/";
            echo "";
            echo "**Available pages:**";
            echo "- ðŸ  [Landing Page](https://www.douglastkaiser.com/kaiserlift/)";
            echo "- ðŸ‹ï¸ [Lifting Demo](https://www.douglastkaiser.com/kaiserlift/lifting/)";
            echo "- ðŸƒ [Running Demo](https://www.douglastkaiser.com/kaiserlift/running/)";
            echo "";
            echo "**Commit:** \`${{ github.sha }}\`";
          } >> "$GITHUB_STEP_SUMMARY"
