name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write

jobs:
  deploy:
    name: Deploy to douglastkaiser.github.io
    runs-on: ubuntu-latest

    steps:
      - name: Checkout kaiserlift repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for setuptools-scm

      - uses: astral-sh/setup-uv@v6

      - name: Sync dependencies
        run: uv sync

      - name: Inject version into client
        run: uv run --with setuptools-scm python scripts/inject_version.py

      - name: Preprocess CSV data for optimal loading
        run: uv run python scripts/preprocess_data.py

      - name: Generate example HTML
        run: uv run python tests/example_use/generate_example_html.py

      - name: Verify build output
        run: |
          echo "Build directory contents:"
          ls -la tests/example_use/build/
          echo ""
          echo "Subdirectories:"
          ls -la tests/example_use/build/*/ 2>/dev/null || echo "Warning: No subdirectories found!"
          echo ""
          echo "Critical files check:"
          [ -f "tests/example_use/build/index.html" ] && echo "âœ“ index.html exists" || (echo "âœ— index.html MISSING" && exit 1)
          [ -f "tests/example_use/build/lifting/index.html" ] && echo "âœ“ lifting/index.html exists" || (echo "âœ— lifting/index.html MISSING" && exit 1)
          [ -f "tests/example_use/build/running/index.html" ] && echo "âœ“ running/index.html exists" || (echo "âœ— running/index.html MISSING" && exit 1)
          [ -f "tests/example_use/build/.nojekyll" ] && echo "âœ“ .nojekyll exists" || (echo "âœ— .nojekyll MISSING" && exit 1)
          echo ""
          echo "All critical files present!"

      - name: Deploy to GitHub Pages repo using peaceiris action
        uses: peaceiris/actions-gh-pages@v4
        with:
          personal_token: ${{ secrets.PAGES_DEPLOY_TOKEN }}
          external_repository: douglastkaiser/douglastkaiser.github.io
          publish_branch: main
          publish_dir: ./tests/example_use/build
          destination_dir: kaiserlift
          keep_files: false  # This ensures old files are removed
          force_orphan: true  # This forces a fresh deployment every time

      - name: Add deployment summary
        run: |
          {
            echo "### ðŸŒ Deployed to GitHub Pages";
            echo "";
            echo "âœ… Successfully deployed to https://www.douglastkaiser.com/kaiserlift/";
            echo "";
            echo "**Available pages:**";
            echo "- ðŸ  [Landing Page](https://www.douglastkaiser.com/kaiserlift/)";
            echo "- ðŸ‹ï¸ [Lifting Demo](https://www.douglastkaiser.com/kaiserlift/lifting/)";
            echo "- ðŸƒ [Running Demo](https://www.douglastkaiser.com/kaiserlift/running/)";
            echo "";
            echo "**Commit:** \`${{ github.sha }}\`";
          } >> "$GITHUB_STEP_SUMMARY"
