name: Update Sphinx index.rst on Release

on:
  release:
    types: [ published ]

jobs:
  update-index:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v5
      with:
        ref: main
    
    - name: Update latest release line in docs/index.rst
      env:
        TAG_NAME: ${{ github.event.release.tag_name }}
        RELEASE_URL: ${{ github.event.release.html_url }}
      run: |
        set -euo pipefail
        VERSION="$TAG_NAME"
        # Remove v prefix (backward compatible with xbbg== prefix)
        VERSION="${VERSION#v}"
        VERSION="${VERSION#xbbg==}"
        NEW_LINE="Latest release: xbbg==${VERSION} (release: \`notes <${RELEASE_URL}>\`_)"
        awk -v repl="$NEW_LINE" '
          /\.. xbbg:latest-release-start/ { print; print repl; drop=1; next }
          /\.. xbbg:latest-release-end/   { drop=0; print; next }
          drop != 1 { print }
        ' docs/index.rst > docs/index.rst.tmp && mv docs/index.rst.tmp docs/index.rst
    - name: Update changelog section in docs/index.rst
      env:
        TAG_NAME: ${{ github.event.release.tag_name }}
        RELEASE_URL: ${{ github.event.release.html_url }}
        RELEASE_BODY: ${{ github.event.release.body }}
        PUBLISHED_AT: ${{ github.event.release.published_at }}
      run: |
        set -euo pipefail
        VERSION="$TAG_NAME"
        # Remove v prefix (backward compatible with xbbg== prefix)
        VERSION="${VERSION#v}"
        VERSION="${VERSION#xbbg==}"
        # Prepare RST changelog entry from the release body; normalize bullets and ensure blank line
        printf "*%s* - see release: \`notes <%s>\`_\n\n%s\n" "$VERSION" "$RELEASE_URL" "$RELEASE_BODY" > .idx_changelog_entry.rst
        sed -E 's/^\* /- /' .idx_changelog_entry.rst > .idx_changelog_entry.fix && mv .idx_changelog_entry.fix .idx_changelog_entry.rst
        awk 'BEGIN{prev_empty=1} {
          if ($0 ~ /^-/ && prev_empty==0) { print "" }
          print; prev_empty = ($0 ~ /^\s*$/) ? 1 : 0
        }' .idx_changelog_entry.rst > .idx_changelog_entry2.rst && mv .idx_changelog_entry2.rst .idx_changelog_entry.rst
        # Replace the block between markers with the new entry
        awk 'BEGIN{emit=1}
             /\.. xbbg:changelog-start/ { print; system("cat .idx_changelog_entry.rst"); skip=1; next }
             /\.. xbbg:changelog-end/   { skip=0; print; next }
             skip!=1 { print }' docs/index.rst > docs/index.rst.tmp && mv docs/index.rst.tmp docs/index.rst
    - name: Commit docs index update
      if: ${{ env.ACT != 'true' }}
      run: |
        set -euo pipefail
        # Ensure we're on main branch
        git checkout main || git checkout -B main
        if git diff --quiet; then
          echo "No docs changes to commit"
          exit 0
        fi
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git add docs/index.rst
        git commit -m "docs(index): update What's New and latest release for ${{ github.event.release.tag_name }}"
        git push origin main
