name: Release to PyPI

on:
  release:
    types: [published]

permissions:
  contents: read

jobs:
  # Run full test suite before publishing
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true  # Stop on first failure for releases
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.12', '3.13']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
        cache-dependency-path: |
          requirements.txt
          requirements-dev.txt

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt
        pip install -e .

    - name: Run smoke tests (105 critical tests, ~2-5 min per job)
      timeout-minutes: 10
      run: |
        pytest -n auto -v --cov=rheojax --cov-report=xml --cov-report=term-missing -m "smoke"
        # Note: Only smoke tests (105/1154 tests) run on release CI
        # Full validation suite should be run locally before creating release: make test

  # Run linting checks
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
        cache-dependency-path: 'requirements-dev.txt'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black==25.11.0 ruff==0.14.5 mypy==1.18.2

    - name: Run Black
      run: black --check rheojax tests

    - name: Run Ruff
      run: ruff check rheojax tests

    - name: Run MyPy
      run: mypy rheojax --ignore-missing-imports --no-strict-optional

  # Build documentation to ensure it works
  docs:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
        cache-dependency-path: |
          requirements.txt
          requirements-dev.txt

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt
        pip install -e .

    - name: Build documentation
      run: |
        sphinx-build -W -b html docs/source docs/build

  # Build and publish to PyPI (only after all tests pass)
  publish:
    name: Publish to PyPI
    needs: [test, lint, docs]
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/rheojax
    permissions:
      id-token: write  # IMPORTANT: mandatory for trusted publishing

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build>=1.2.0

    - name: Build package
      run: python -m build

    - name: Verify package metadata
      run: |
        python -m pip install --upgrade twine>=6.0.0
        twine check dist/*

    - name: Verify version matches release tag
      run: |
        # Extract version from pyproject.toml
        PACKAGE_VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
        # Extract version from git tag (remove 'v' prefix if present)
        TAG_VERSION=${GITHUB_REF#refs/tags/v}
        TAG_VERSION=${TAG_VERSION#refs/tags/}

        echo "Package version: $PACKAGE_VERSION"
        echo "Git tag version: $TAG_VERSION"

        if [ "$PACKAGE_VERSION" != "$TAG_VERSION" ]; then
          echo "Error: Package version ($PACKAGE_VERSION) does not match git tag ($TAG_VERSION)"
          exit 1
        fi

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        print-hash: true
        verbose: true
