#!/usr/bin/env python3
"""
Test suite for ReDoS (Regular Expression Denial of Service) vulnerability in abductive reasoning.
This test demonstrates the vulnerability and verifies the fix.
"""

import os
import sys
import time

# Add src to path for import
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', 'src'))

from reasoning_library.abductive import _extract_keywords


def test_redos_vulnerability():
    """Test that demonstrates the ReDoS vulnerability in _extract_keywords."""

    print("Testing ReDoS vulnerability in _extract_keywords...")

    # ReDoS Attack Pattern 1: Classic catastrophic backtracking
    # This exploits alternation and backtracking in the \b\w+\b pattern
    # The pattern (.*)+a causes exponential complexity
    malicious_input1 = " " * 500 + "a" + " " * 500 + "b" + " " * 1000

    # ReDoS Attack Pattern 2: Overlapping word boundaries
    # This creates many potential ways to match word boundaries
    malicious_input2 = "a b a b a b " * 200 + "." * 100 + "x" + "." * 100

    # ReDoS Attack Pattern 3: Unicode word boundary exploitation
    # Unicode word boundary rules are complex and can be exploited
    malicious_unicode = "\u0301\u0300\u0302" * 200 + "word" + "\u0301\u0300\u0302" * 200

    print(f"Testing malicious input 1 (length: {len(malicious_input1)})...")

    # Test 1: Special characters attack
    start_time = time.time()
    try:
        result = _extract_keywords(malicious_input1)
        end_time = time.time()
        duration = end_time - start_time

        print(f"Special chars input processing time: {duration:.4f} seconds")
        print(f"Result count: {len(result)}")

        # If it takes more than 0.1 second for this input, we likely have ReDoS
        if duration > 0.1:
            print("âŒ FAIL: Potential ReDoS vulnerability detected - processing too slow")
            return False

    except Exception as e:
        print(f"âŒ FAIL: Exception during special chars processing: {e}")
        return False

    # Test 2: Alphanumeric attack
    print("Testing alphanumeric ReDoS attack...")
    start_time = time.time()
    try:
        result2 = _extract_keywords(malicious_input2)
        end_time = time.time()
        duration2 = end_time - start_time

        print(f"Alphanumeric input processing time: {duration2:.4f} seconds")
        print(f"Alphanumeric result count: {len(result2)}")

        if duration2 > 0.1:
            print("âŒ FAIL: Potential alphanumeric ReDoS vulnerability detected")
            return False

    except Exception as e:
        print(f"âŒ FAIL: Exception during alphanumeric processing: {e}")
        return False

    # Test 3: Unicode boundary attack
    print("Testing Unicode word boundary attack...")
    start_time = time.time()
    try:
        unicode_result = _extract_keywords(malicious_unicode)
        end_time = time.time()
        unicode_duration = end_time - start_time

        print(f"Unicode input processing time: {unicode_duration:.4f} seconds")
        print(f"Unicode result count: {len(unicode_result)}")

        if unicode_duration > 0.1:
            print("âŒ FAIL: Potential Unicode ReDoS vulnerability detected")
            return False

    except Exception as e:
        print(f"âŒ FAIL: Exception during Unicode processing: {e}")
        return False

    # Test 4: The ultimate ReDoS pattern - many ambiguous boundaries
    print("Testing catastrophic backtracking pattern...")
    # This pattern creates maximum ambiguity for the regex engine
    catastrophic_pattern = ".a.b.c.d.e.f.g.h.i.j.k.l.m.n.o.p.q.r.s.t.u.v.w.x.y.z." * 20

    start_time = time.time()
    try:
        catastrophic_result = _extract_keywords(catastrophic_pattern)
        end_time = time.time()
        catastrophic_duration = end_time - start_time

        print(f"Catastrophic pattern processing time: {catastrophic_duration:.4f} seconds")
        print(f"Catastrophic result count: {len(catastrophic_result)}")

        if catastrophic_duration > 0.1:
            print("âŒ FAIL: Catastrophic ReDoS vulnerability detected")
            return False

    except Exception as e:
        print(f"âŒ FAIL: Exception during catastrophic pattern processing: {e}")
        return False

    print("âœ… PASS: No obvious ReDoS vulnerabilities detected in current tests")
    print("âš ï¸  WARNING: The vulnerable regex exists but may not trigger with current test patterns")
    return True


def test_performance_with_very_long_input():
    """Test performance with extremely long input to ensure it doesn't hang."""

    print("\nTesting performance with very long input...")

    # Create very long input (100KB)
    very_long_input = "word " * 25000  # ~125KB of text

    print(f"Input size: {len(very_long_input)} characters")

    start_time = time.time()
    try:
        result = _extract_keywords(very_long_input)
        end_time = time.time()
        duration = end_time - start_time

        print(f"Very long input processing time: {duration:.4f} seconds")
        print(f"Unique keywords found: {len(result)}")

        # Should complete in reasonable time even for large input
        if duration > 2.0:
            print(f"âŒ FAIL: Processing {len(very_long_input)} chars took too long: {duration:.2f}s")
            return False

        # Should deduplicate and return reasonable number of unique words
        if len(result) > 100:  # Should have only "word" due to deduplication
            print(f"âŒ FAIL: Too many results ({len(result)}) for repetitive input")
            return False

    except Exception as e:
        print(f"âŒ FAIL: Exception during long input processing: {e}")
        return False

    print("âœ… PASS: Long input processed efficiently")
    return True


if __name__ == "__main__":
    print("ğŸ” ReDoS Vulnerability Test Suite")
    print("=" * 50)

    success = True

    # Test basic ReDoS vulnerability
    success &= test_redos_vulnerability()

    # Test performance with long input
    success &= test_performance_with_very_long_input()

    print("\n" + "=" * 50)
    if success:
        print("âœ… ALL TESTS PASSED")
        print("ğŸ‰ No obvious ReDoS vulnerabilities detected")
    else:
        print("âŒ TESTS FAILED")
        print("ğŸš¨ ReDoS vulnerabilities detected - IMMEDIATE ACTION REQUIRED")

    print("=" * 50)

    # Exit with appropriate code
    sys.exit(0 if success else 1)
