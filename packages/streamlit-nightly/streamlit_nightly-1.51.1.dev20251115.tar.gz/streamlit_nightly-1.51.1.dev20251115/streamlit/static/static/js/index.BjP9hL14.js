import{r,E as P,_ as U,u as Q,aN as L,aO as Y,n as I,aP as Z,aQ as K,aR as M,aS as H,aT as q,aU as ee,p as _,aV as j,y as B,aW as te,aX as ne,aY as se,M as re,a7 as ae,az as oe,aZ as ce,j as A,f as ie,a_ as le,a$ as ue,b0 as fe}from"./index.BTj4XZUf.js";import{w as de,E as me}from"./withFullScreenWrapper.DH97Ph7E.js";import{a as k,S as W,T as he}from"./Toolbar.Db3RmKOo.js";import{R as pe}from"./index.B6-dkYP7.js";import{u as ge}from"./FormClearHelper.BaLOtzQI.js";import"./sprintf.D7DtBTRn.js";import"./checkbox.DMr1Xr3v.js";import"./createDownloadLinkElement.ZaXNnPK4.js";import"./toConsumableArray.EFTQxPZS.js";import"./possibleConstructorReturn.D7K8z5Us.js";import"./createSuper.ocMngbs5.js";import"./FileDownload.esm.D5MCfqpO.js";var G=r.forwardRef(function(n,t){var a={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return r.createElement(P,U({iconAttrs:a,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},n,{ref:t}),r.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),r.createElement("path",{d:"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM7 10h2v7H7zm4-3h2v10h-2zm4 6h2v4h-2z"}))});G.displayName="InsertChart";var $=r.forwardRef(function(n,t){var a={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return r.createElement(P,U({iconAttrs:a,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},n,{ref:t}),r.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),r.createElement("path",{d:"M20 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h15c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 2v3H5V5h15zm-5 14h-5v-9h5v9zM5 10h3v9H5v-9zm12 9v-9h3v9h-3z"}))});$.displayName="TableChart";const Se=20;function ye(n){"params"in n&&"encoding"in n&&n.params.forEach(t=>{"select"in t&&(["interval","point"].includes(t.select)&&(t.select={type:t.select}),"type"in t.select&&t.select.type==="point"&&!("encodings"in t.select)&&I(t.select.encodings)&&(t.select.encodings=Object.keys(n.encoding)))})}const we=(n,t,a,s,u,i,l,h)=>{const e=JSON.parse(n);if(s==="streamlit"?e.config=L(e.config,i):e.usermeta?.embedOptions?.theme==="streamlit"?(e.config=L(e.config,i),e.usermeta.embedOptions.theme=void 0):e.config=Y(e.config,i),e.title&&(typeof e.title=="string"&&(e.title={text:e.title}),e.title.limit=e.title.limit??Math.max(l-40,0)),a&&(e.height=h),t&&(e.width=l,"vconcat"in e&&e.vconcat.forEach(f=>{f.width=l})),e.padding||(e.padding={}),I(e.padding.bottom)&&(e.padding.bottom=Se),e.datasets)throw new Error("Datasets should not be passed as part of the spec");return u.length>0&&ye(e),e},be=(n,t,a,s,u)=>{const i=Q(),{id:l,formId:h,spec:e,data:f,datasets:o,vegaLiteTheme:d,selectionMode:c}=n,p=r.useMemo(()=>c,[JSON.stringify(c)]),S=r.useMemo(()=>we(e,s,u,d,p,i,t,a),[e,s,u,d,p,i,t,a]);return{id:l,formId:h,vegaLiteTheme:d,spec:S,selectionMode:p,data:f,datasets:o,useContainerWidth:s}},Ce={DATAFRAME_INDEX:"(index)"};function Ee(n){return!n||n.dimensions.numDataRows===0?null:z(n)}function Ve(n){const t=F(n);if(I(t))return null;const a={};for(const[s,u]of Object.entries(t))a[s]=z(u);return a}function F(n){if(n?.length===0)return null;const t={};return n.forEach(a=>{if(!a)return;const s=a.hasName?a.name:null;t[s]=a.data}),t}function z(n,t=0){if(n.dimensions.numDataRows===0)return[];const a=[],{numDataRows:s,numDataColumns:u,numIndexColumns:i}=n.dimensions,l=n.columnTypes[0]??void 0,h=l&&l.type===Z.INDEX&&(K(l)||M(l)||H(l));for(let e=t;e<s;e++){const f={};if(h){const{content:o}=n.getCell(e,0);f[Ce.DATAFRAME_INDEX]=typeof o=="bigint"?Number(o):o}for(let o=0;o<u;o++){const d=o+i,{content:c,contentType:p}=n.getCell(e,d);if((c instanceof Date||typeof c=="number"&&Number.isFinite(c))&&(M(p)||H(p))&&!q(p)){const S=new Date(c).getTimezoneOffset()*60*1e3;f[n.columnNames[0][d]]=c.valueOf()+S}else f[n.columnNames[0][d]]=typeof c=="bigint"?Number(c):c}a.push(f)}return a}const ve=150,De=B.getLogger("useVegaLiteSelections"),Ne=(n,t,a)=>{const{id:s,formId:u,selectionMode:i}=n,l=r.useCallback(e=>{i.forEach(o=>{e.addSignalListener(o,ee(ve,(d,c)=>{const p=e.getState({data:(C,O)=>i.some(g=>`${g}_store`===C),recurse:!1});_(p)&&t.setElementState(s,"viewState",p);let S=c;"vlPoint"in c&&"or"in c.vlPoint&&(S=c.vlPoint.or);const D={id:s,formId:u},V=JSON.parse(t.getStringValue(D)||"{}"),v={selection:{...V?.selection||{},[d]:S||{}}};j(V,v)||t.setStringValue(D,JSON.stringify(v),{fromUi:!0},a)}))});const f=t.getElementState(s,"viewState");if(_(f))try{return e.setState(f)}catch(o){De.warn("Failed to restore view state",o)}return e},[s,i,t,u,a]),h=r.useCallback(()=>{const e={selection:{}};i.forEach(c=>{e.selection[c]={}});const f={id:s,formId:u},o=t.getStringValue(f),d=o?JSON.parse(o):e;j(d,e)||t.setStringValue(f,JSON.stringify(e),{fromUi:!0},a)},[s,u,a,i,t]);return{maybeConfigureSelections:l,onFormCleared:h}},J="source",Te=B.getLogger("useVegaEmbed");function Oe(n,t,a){const s=r.useRef(null),u=r.useRef(null),i=r.useRef(J),l=r.useRef(null),h=r.useRef([]),e=r.useRef(null),f=r.useRef([]),[o,d]=r.useState(!1),{maybeConfigureSelections:c,onFormCleared:p}=Ne(n,t,a);ge({widgetMgr:t,element:n,onFormCleared:p});const{data:S,datasets:D}=n;r.useEffect(()=>{e.current=S,f.current=D,s.current===null&&(l.current=S,h.current=D)},[S,D]);const V=r.useCallback(()=>{u.current&&u.current(),u.current=null,s.current=null},[]),v=r.useCallback(async(g,y)=>{if(g.current===null)throw new Error("Element missing.");d(!0);try{V();const w={ast:!0,expr:te,tooltip:{disableDefaultStyle:!0},defaultStyle:!1,forceActionsMenu:!0},{vgSpec:b,view:T,finalize:E}=await ne(g.current,y,w);s.current=c(T),u.current=E;const m=Ve(f.current),N=m?Object.keys(m):[];if(N.length===1){const[x]=N;i.current=x}else N.length===0&&b.data&&(i.current=J);const R=Ee(e.current);if(R&&s.current.insert(i.current,R),m)for(const[x,X]of Object.entries(m))s.current.insert(x,X);return await s.current.runAsync(),await s.current.resize().runAsync(),l.current=e.current,h.current=f.current,s.current}finally{d(!1)}},[V,c]),C=r.useCallback((g,y,w,b)=>{if(!b||b.dimensions.numDataRows===0){try{g.remove(y,se)}catch{}return}if(!w||w.dimensions.numDataRows===0){g.insert(y,z(b));return}b.hash!==w.hash&&(g.data(y,z(b)),Te.info(`Had to clear the ${y} dataset before inserting data through Vega view.`))},[]),O=r.useCallback(async(g,y)=>{if(s.current===null||o)return null;const w=l.current,b=h.current;(w||g)&&C(s.current,i.current,w,g);const T=F(b)??{},E=F(y)??{};for(const[m,N]of Object.entries(E)){const R=m||i.current,x=T[R];C(s.current,R,x,N)}for(const m of Object.keys(T))!Object.hasOwn(E,m)&&m!==i.current&&C(s.current,m,null,null);return await s.current?.resize().runAsync(),l.current=g,h.current=y,s.current},[C,o]);return{createView:v,updateView:O,finalizeView:V}}function Ae(n){try{const t=typeof n=="string"?JSON.parse(n):n;return!!(t.facet||t.encoding?.row||t.encoding?.column||t.encoding?.facet)}catch{return!1}}const Re=({disableFullscreenMode:n,element:t,fragmentId:a,widgetMgr:s,widthConfig:u,heightConfig:i})=>{const[l,h]=r.useState(!1),[e,f]=r.useState(!1),{expanded:o,height:d,width:c,expand:p,collapse:S}=re(me),{width:D,height:V,elementRef:v}=ae([l],0),C=oe(u)||t.useContainerWidth,O=ce(i),g=Ae(t.spec),y=be(t,g?c??0:D,(o?d:V)??0,o?!0:C,o?!0:O),{createView:w,updateView:b,finalizeView:T}=Oe(y,s,a),{data:E,datasets:m,spec:N}=y;return r.useLayoutEffect(()=>(v.current!==null&&w(v,N),T),[w,T,N,c,d,l,v]),r.useEffect(()=>{b(E,m)},[E,m]),r.useEffect(()=>{E||m?.[0]?.data?f(!0):f(!1)},[E,m]),l?A(pe,{data:E??m[0]?.data,height:d??V??void 0,width:u??void 0,customToolbarActions:[A(k,{label:"Show chart",icon:G,onClick:()=>{h(!1)}},"show-chart")]}):ie(W,{height:O?o?d:"100%":d,useContainerWidth:o?!0:C,children:[A(he,{target:W,isFullScreen:o,onExpand:p,onCollapse:S,disableFullscreenMode:n,children:e&&A(k,{label:"Show data",icon:$,onClick:()=>{h(!0)}})}),A(ue,{styles:[le]}),A(fe,{"data-testid":"stVegaLiteChart",className:"stVegaLiteChart",useContainerWidth:C,useContainerHeight:O,ref:v})]})},xe=de(Re),Ue=r.memo(xe);export{le as StyledVegaLiteChartTooltips,L as applyStreamlitTheme,Ue as default};
