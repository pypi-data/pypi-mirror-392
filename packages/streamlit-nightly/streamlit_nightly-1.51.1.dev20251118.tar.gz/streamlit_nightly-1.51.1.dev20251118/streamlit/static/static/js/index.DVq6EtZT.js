import{r as t,E as L,_ as D,L as Te,n as de,p as P,b7 as ie,bv as Le,bn as De,bm as Be,w as d,j as o,z as Ve,f as F,B as ze,ap as We,b as Me,bw as Ne,l as qe,T as Oe,P as He,X as $e}from"./index.BBIk7Any.js";import{u as je}from"./useWaveformController.5OyTAEuu.js";import{T as _e,a as ce}from"./Toolbar.BY3_nSFT.js";import{u as Xe,F as Ge}from"./FormClearHelper.C8wGpqxd.js";import{c as Ke}from"./createDownloadLinkElement.ZaXNnPK4.js";import{F as Je,D as Qe}from"./FileDownload.esm.qvuwm2bT.js";var ue=t.forwardRef(function(e,r){var n={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return t.createElement(L,D({iconAttrs:n,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},e,{ref:r}),t.createElement("g",{fill:"none"},t.createElement("rect",{width:24,height:24}),t.createElement("rect",{width:24,height:24}),t.createElement("rect",{width:24,height:24})),t.createElement("path",{d:"M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"}),t.createElement("path",{d:"M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"}))});ue.displayName="Mic";var fe=t.forwardRef(function(e,r){var n={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return t.createElement(L,D({iconAttrs:n,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},e,{ref:r}),t.createElement("rect",{width:24,height:24,fill:"none"}),t.createElement("path",{d:"M8 19c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2v10c0 1.1.9 2 2 2zm6-12v10c0 1.1.9 2 2 2s2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2z"}))});fe.displayName="Pause";var pe=t.forwardRef(function(e,r){var n={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return t.createElement(L,D({iconAttrs:n,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},e,{ref:r}),t.createElement("rect",{width:24,height:24,fill:"none"}),t.createElement("path",{d:"M8 6.82v10.36c0 .79.87 1.27 1.54.84l8.14-5.18a1 1 0 000-1.69L9.54 5.98A.998.998 0 008 6.82z"}))});pe.displayName="PlayArrow";var ge=t.forwardRef(function(e,r){var n={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return t.createElement(L,D({iconAttrs:n,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},e,{ref:r}),t.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),t.createElement("path",{d:"M17.65 6.35a7.95 7.95 0 00-6.48-2.31c-3.67.37-6.69 3.35-7.1 7.02C3.52 15.91 7.27 20 12 20a7.98 7.98 0 007.21-4.56c.32-.67-.16-1.44-.9-1.44-.37 0-.72.2-.88.53a5.994 5.994 0 01-6.8 3.31c-2.22-.49-4.01-2.3-4.48-4.52A6.002 6.002 0 0112 6c1.66 0 3.14.69 4.22 1.78l-1.51 1.51c-.63.63-.19 1.71.7 1.71H19c.55 0 1-.45 1-1V6.41c0-.89-1.08-1.34-1.71-.71l-.64.65z"}))});ge.displayName="Refresh";var me=t.forwardRef(function(e,r){var n={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return t.createElement(L,D({iconAttrs:n,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},e,{ref:r}),t.createElement("g",{fill:"none"},t.createElement("rect",{width:24,height:24}),t.createElement("rect",{width:24,height:24})),t.createElement("path",{fillRule:"evenodd",d:"M9 16h6c.55 0 1-.45 1-1V9c0-.55-.45-1-1-1H9c-.55 0-1 .45-1 1v6c0 .55.45 1 1 1zm3-14C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"}))});me.displayName="StopCircle";const Ye=(e,r)=>{const{enforceDownloadInNewTab:n=!1}=t.useContext(Te);return t.useCallback(()=>{if(!e)return;const l=Ke({enforceDownloadInNewTab:n,url:e,filename:r});l.style.display="none",document.body.appendChild(l),l.click(),document.body.removeChild(l)},[e,n,r])},H=({widgetMgr:e,id:r,formId:n,key:c,defaultValue:l})=>{t.useEffect(()=>{const s=e.getElementState(r,c);de(s)&&P(l)&&e.setElementState(r,c,l)},[e,r,c,l]);const[S,u]=t.useState(e.getElementState(r,c)??l),h=t.useCallback(s=>{e.setElementState(r,c,s),u(s)},[e,r,c]),y=t.useMemo(()=>({formId:n||""}),[n]),b=t.useCallback(()=>h(l),[l,h]);return Xe({element:y,widgetMgr:e,onFormCleared:b}),[S,h]},Ze=async({files:e,uploadClient:r,widgetMgr:n,widgetInfo:c,fragmentId:l,signal:S})=>{let u=[];try{u=await r.fetchFileURLs(e)}catch(s){return{successfulUploads:[],failedUploads:e.map(i=>({file:i,error:ie(s)}))}}const h=Le(e,u),y=[],b=[];return await Promise.all(h.map(async([s,i])=>{if(!s||!i?.uploadUrl||!i.fileId)return{file:s,fileUrl:i,error:new Error("No upload URL found")};try{await r.uploadFile({id:i.fileId,formId:c.formId||""},i.uploadUrl,s,void 0,S),y.push({fileUrl:i,file:s})}catch(N){const f=ie(N);b.push({file:s,error:f})}})),n.setFileUploaderStateValue(c,new De({uploadedFileInfo:y.map(({file:s,fileUrl:i})=>new Be({fileId:i.fileId,fileUrls:i,name:s.webkitRelativePath||s.name,size:s.size}))}),{fromUi:!0},l),{successfulUploads:y,failedUploads:b}},et=d("div",{target:"e3q8yfp0"})(),se=d("div",{target:"e3q8yfp1"})(({theme:e,disabled:r})=>({height:e.sizes.largestElementHeight,width:"100%",background:e.colors.secondaryBg,borderRadius:e.radii.default,marginBottom:e.spacing.twoXS,display:"flex",alignItems:"center",position:"relative",paddingLeft:e.spacing.xs,paddingRight:e.spacing.sm,border:e.colors.widgetBorderColor?`${e.sizes.borderWidth} solid ${e.colors.widgetBorderColor}`:void 0,cursor:r?"not-allowed":"auto",overflow:"hidden"})),tt=d("div",{target:"e3q8yfp2"})({flex:1}),rt=d("div",{target:"e3q8yfp3"})(({show:e,theme:r})=>({display:e?"block":"none",position:"relative",height:r.sizes.largestElementHeight,"& > div":{position:"absolute",top:0,left:0,width:"100%",height:"100%",display:"flex",alignItems:"center"}})),nt=d("span",{target:"e3q8yfp4"})(({theme:e,isPlayingOrRecording:r,disabled:n})=>({margin:e.spacing.sm,fontFamily:e.fonts.monospace,color:n?e.colors.fadedText40:r?e.colors.bodyText:e.colors.fadedText60,backgroundColor:e.colors.secondaryBg,fontSize:e.fontSizes.sm})),he=d("div",{target:"e3q8yfp5"})({width:"100%",textAlign:"center",overflow:"hidden"}),ye=d("span",{target:"e3q8yfp6"})(({theme:e})=>({color:e.colors.bodyText})),ot=d("a",{target:"e3q8yfp7"})(({theme:e})=>({color:e.colors.link,textDecoration:e.linkUnderline?"underline":"none"})),at=d("div",{target:"e3q8yfp8"})(({theme:e})=>({flex:1,height:e.sizes.largestElementHeight,display:"flex",justifyContent:"center",alignItems:"center"})),lt=d("div",{target:"e3q8yfp9"})(({theme:e})=>{const r="0.625em";return{opacity:.2,width:"100%",height:r,backgroundSize:r,backgroundImage:`radial-gradient(${e.colors.fadedText10} 40%, transparent 40%)`,backgroundRepeat:"repeat"}}),it=d("span",{target:"e3q8yfp10"})(({theme:e})=>({"& > button":{color:e.colors.primary,padding:e.spacing.threeXS},"& > button:hover, & > button:focus":{color:e.colors.redColor}})),ct=d("span",{target:"e3q8yfp11"})(({theme:e})=>({"& > button":{padding:e.spacing.threeXS,color:e.colors.fadedText60},"& > button:hover, & > button:focus":{color:e.colors.bodyText}})),be=d("span",{target:"e3q8yfp12"})(({theme:e})=>({"& > button":{padding:e.spacing.threeXS,color:e.colors.fadedText60},"& > button:hover, & > button:focus":{color:e.colors.bodyText}})),$=d("div",{target:"e3q8yfp13"})(({theme:e})=>({display:"flex",justifyContent:"center",alignItems:"center",flexGrow:0,flexShrink:1,padding:e.spacing.xs,gap:e.spacing.twoXS,marginRight:e.spacing.twoXS})),st=d("div",{target:"e3q8yfp14"})(({theme:e})=>({marginLeft:e.spacing.sm})),T=({onClick:e,disabled:r,ariaLabel:n,iconContent:c})=>o(Me,{kind:ze.BORDERLESS_ICON,onClick:e,disabled:r,"aria-label":n,containerWidth:!0,"data-testid":"stAudioInputActionButton",children:o(We,{content:c,size:"lg",color:"inherit"})}),dt=({disabled:e,stopRecording:r})=>o(it,{children:o(T,{onClick:r,disabled:e,ariaLabel:"Stop recording",iconContent:me})}),ut=({disabled:e,isPlaying:r,onClickPlayPause:n})=>o(be,{children:r?o(T,{onClick:n,disabled:e,ariaLabel:"Pause",iconContent:fe}):o(T,{onClick:n,disabled:e,ariaLabel:"Play",iconContent:pe})}),ft=({disabled:e,startRecording:r})=>o(ct,{children:o(T,{onClick:r,disabled:e,ariaLabel:"Record",iconContent:ue})}),pt=({onClick:e})=>o(be,{children:o(T,{disabled:!1,onClick:e,ariaLabel:"Reset",iconContent:ge})}),gt=({disabled:e,isRecording:r,isPlaying:n,isUploading:c,isError:l,recordingUrlExists:S,startRecording:u,stopRecording:h,onClickPlayPause:y,onClear:b})=>l?o($,{children:o(pt,{onClick:b})}):c?o($,{children:o(Ve,{size:"base",iconValue:"spinner"})}):F($,{children:[r?o(dt,{disabled:e,stopRecording:h}):o(ft,{disabled:e,startRecording:u}),S&&o(ut,{disabled:e,isPlaying:n,onClickPlayPause:y})]}),mt=t.memo(gt),ht=()=>o(he,{children:o(ye,{children:"An error has occurred, please try again."})}),yt=t.memo(ht),R="00:00",E=e=>{const r=Math.floor(e/1e3),n=Math.floor(r/60),c=Math.floor(n/60),l=r%60,S=n%60,u=l.toString().padStart(2,"0"),h=S.toString().padStart(2,"0"),y=c.toString().padStart(2,"0");return n<60?`${h}:${u}`:`${y}:${h}:${u}`},bt=()=>F(he,{children:[o(ye,{children:"This app would like to use your microphone."})," ",o(ot,{href:Ne,rel:"noopener noreferrer",target:"_blank",children:"Learn how to allow access."})]}),vt=t.memo(bt),St=()=>o(at,{children:o(lt,{})}),wt=t.memo(St),Ct=({element:e,uploadClient:r,widgetMgr:n,fragmentId:c,disabled:l})=>{const S=t.useRef(null),[u,h]=t.useState(!1),[y,b]=t.useState(!1),[s,i]=t.useState(!1),[N,f]=t.useState(R),[B,V]=H({widgetMgr:n,id:e.id,key:"deleteFileUrl",defaultValue:null}),[m,z]=H({widgetMgr:n,id:e.id,key:"recordingUrl",defaultValue:null}),[q,A]=H({widgetMgr:n,id:e.id,formId:e.formId,key:"recordingTime",defaultValue:R}),I=t.useRef(null),w=t.useRef(null),p=t.useRef(null),j=e.id,C=e.formId,ve=t.useCallback(async a=>{I.current&&I.current.abort();const v=new AbortController;I.current=v;try{if(b(!0),P(C)&&n.setFormsWithUploadsInProgress(new Set([C])),v.signal.aborted)return;let g;try{g=URL.createObjectURL(a),w.current&&w.current!==g&&URL.revokeObjectURL(w.current),w.current=g}catch{i(!0),b(!1),P(C)&&n.setFormsWithUploadsInProgress(new Set);return}if(v.signal.aborted){URL.revokeObjectURL(g),w.current=null;return}z(g);const Ue=new Date().toISOString().slice(0,16).replace(/:/g,"-"),Pe=new File([a],`${Ue}_audio.wav`,{type:a.type});try{const{successfulUploads:Fe,failedUploads:xe}=await Ze({files:[Pe],uploadClient:r,widgetMgr:n,widgetInfo:{id:j,formId:C},fragmentId:c,signal:v.signal});if(v.signal.aborted)return;if(xe.length>0){i(!0);return}i(!1);const le=Fe[0];le?.fileUrl?.deleteUrl&&V(le.fileUrl.deleteUrl)}catch{v.signal.aborted||i(!0)}finally{P(C)&&n.setFormsWithUploadsInProgress(new Set),v.signal.aborted||b(!1)}}catch{v.signal.aborted||(i(!0),b(!1)),P(C)&&n.setFormsWithUploadsInProgress(new Set)}},[r,n,j,C,c,V,z]),W=t.useRef(null),_=je({containerRef:S,sampleRate:e.sampleRate??void 0,waveformPadding:4,events:{onPermissionDenied:()=>{h(!0)},onError:()=>{i(!0)},onRecordStart:()=>{A(R),f(R)},onRecordReady:()=>{const a=E(W.current?.playback.getDurationMs()??0);A(a),f(a)},onApprove:ve,onCancel:()=>{A(R),f(R)},onProgressMs:a=>{A(E(a))},onPlaybackPause:()=>{f(E(W.current?.playback.getCurrentTimeMs()??0))},onPlaybackFinish:()=>{f(E(W.current?.playback.getDurationMs()??0))}}});W.current=_;const{state:M,isPlaybackPlaying:U,start:X,stop:G,approve:K,cancel:J,playback:{play:Q,pause:Y,load:Z,getCurrentTimeMs:x,getDurationMs:ee}}=_,k=t.useCallback(async({updateWidgetManager:a,deleteFile:v})=>{const g=m;if(g&&w.current===g&&(URL.revokeObjectURL(g),w.current=null),p.current&&(cancelAnimationFrame(p.current),p.current=null),z(null),V(null),f(R),A(R),J(),a&&n.setFileUploaderStateValue(e,{},{fromUi:!0},c),v&&B)try{await r.deleteFile(B)}catch{}P(g)&&URL.revokeObjectURL(g)},[B,m,r,J,e,n,c,A,V,z]);t.useEffect(()=>{const a=()=>{U&&(f(E(x())),p.current=requestAnimationFrame(a))};return U?p.current=requestAnimationFrame(a):p.current&&(cancelAnimationFrame(p.current),p.current=null),()=>{p.current&&(cancelAnimationFrame(p.current),p.current=null)}},[U,x]),t.useEffect(()=>{if(!m)return;let a=!1;return f(q),(async()=>{try{if(await Z(m),a)return;const g=ee();g>0&&f(E(g))}catch{a||i(!0)}})(),()=>{a=!0}},[m,q,Z,ee]),t.useEffect(()=>{if(de(C))return;const a=new Ge;return a.manageFormClearListener(n,C,()=>{k({updateWidgetManager:!0,deleteFile:!1})}),()=>a.disconnect()},[C,k,n]),t.useEffect(()=>()=>{I.current&&(I.current.abort(),I.current=null),p.current&&(cancelAnimationFrame(p.current),p.current=null),w.current&&(URL.revokeObjectURL(w.current),w.current=null)},[]);const Se=t.useCallback(async()=>{try{if(U){const a=x();Y(),f(E(a))}else M==="idle"&&m&&(x()<=100&&f(R),await Q())}catch{i(!0)}},[U,x,Y,Q,m,M]),te=t.useCallback(async()=>{m&&await k({updateWidgetManager:!1,deleteFile:!0});try{f(R),await X()}catch{}},[k,m,X]),re=t.useCallback(async()=>{try{const{blob:a}=await G();await K(a)}catch{i(!0)}},[K,G]),ne=Ye(m,"recording.wav"),we=t.useCallback(()=>{te()},[te]),Ce=t.useCallback(()=>{re()},[re]),Re=t.useCallback(()=>{k({updateWidgetManager:!1,deleteFile:!0}),i(!1)},[k]),ke=t.useCallback(()=>{ne()},[ne]),Ee=t.useCallback(()=>{k({updateWidgetManager:!0,deleteFile:!0})},[k]),O=M==="recording",oe=U,Ae=O?q:N,ae=M==="idle"&&!u&&!m,Ie=u||ae||s;return F(et,{className:"stAudioInput","data-testid":"stAudioInput",children:[o($e,{label:e.label,disabled:l,labelVisibility:qe(e.labelVisibility?.value),children:e.help&&o(st,{children:o(Oe,{content:e.help,placement:He.TOP})})}),F(se,{disabled:l,children:[F(_e,{isFullScreen:!1,disableFullscreenMode:!0,target:se,children:[m&&o(ce,{label:"Download as WAV",icon:Je,onClick:ke}),B&&o(ce,{label:"Clear recording",icon:Qe,onClick:Ee})]}),o(mt,{isRecording:O,isPlaying:oe,isUploading:y,isError:s,recordingUrlExists:!!m,startRecording:we,stopRecording:Ce,onClickPlayPause:()=>void Se(),onClear:Re,disabled:l||u}),F(tt,{children:[s&&o(yt,{}),ae&&o(wt,{}),u&&o(vt,{}),o(rt,{"data-testid":"stAudioInputWaveSurfer",ref:S,show:!Ie})]}),o(nt,{isPlayingOrRecording:O||oe,disabled:l,"data-testid":"stAudioInputWaveformTimeCode",children:Ae})]})]})},Pt=t.memo(Ct);export{Pt as default};
