import{u as G,r as i,aq as L,ar as M}from"./index.BTj4XZUf.js";async function Z(l,e=16e3){if(!l||l.size===0)throw new Error("Invalid or empty blob provided");if(!window.AudioContext)throw new Error("AudioContext not supported in this browser");const o=new AudioContext;try{const r=await l.arrayBuffer(),n=await o.decodeAudioData(r),h=e??n.sampleRate,a=await $(n,h);return q(a,h)}finally{o.close()}}async function $(l,e){const{duration:o,numberOfChannels:r,sampleRate:n}=l,h=Math.ceil(o*e);if(!window.OfflineAudioContext)throw new Error("OfflineAudioContext not supported");const a=new OfflineAudioContext(1,h,e),E=a.createBufferSource();if(E.buffer=l,r>1){const y=a.createChannelSplitter(r),u=a.createChannelMerger(1);E.connect(y);for(let c=0;c<r;c++){const d=a.createGain();d.gain.value=1/r,y.connect(d,c),d.connect(u,0,0)}u.connect(a.destination)}else E.connect(a.destination);E.start(0);try{return await a.startRendering()}catch(y){throw new Error(`Failed to resample audio from ${n}Hz to ${e}Hz: ${y instanceof Error?y.message:String(y)}`)}}function q(l,e){const r=l.length,n=r*2+44,h=new ArrayBuffer(n),a=new DataView(h),E=l.getChannelData(0),y=(c,d)=>{for(let s=0;s<d.length;s++)a.setUint8(c+s,d.charCodeAt(s))};y(0,"RIFF"),a.setUint32(4,n-8,!0),y(8,"WAVE"),y(12,"fmt "),a.setUint32(16,16,!0),a.setUint16(20,1,!0),a.setUint16(22,1,!0),a.setUint32(24,e,!0),a.setUint32(28,e*2,!0),a.setUint16(32,2,!0),a.setUint16(34,16,!0),y(36,"data"),a.setUint32(40,r*2,!0);let u=44;for(let c=0;c<r;c++){const d=Math.max(-1,Math.min(1,E[c]));a.setInt16(u,d*32767,!0),u+=2}return new Blob([h],{type:"audio/wav"})}class O{constructor(){this.wavesurfer=null,this.currentBlobUrl=null,this.events={},this.isPlaying=!1}initialize(e){this.wavesurfer=e,this.setupEventListeners()}setupEventListeners(){this.wavesurfer&&(this.teardownEventListeners(),this.handleTimeUpdate=e=>{this.events.onTimeUpdate?.(e*1e3)},this.handlePause=()=>{this.isPlaying=!1,this.events.onPause?.()},this.handlePlay=()=>{this.isPlaying=!0,this.events.onPlay?.()},this.handleFinish=()=>{this.isPlaying=!1,this.events.onFinish?.()},this.handleReady=()=>{this.events.onReady?.()},this.handleError=e=>{const o=e instanceof Error?e:new Error(String(e));this.events.onError?.(o)},this.wavesurfer.on("timeupdate",this.handleTimeUpdate),this.wavesurfer.on("pause",this.handlePause),this.wavesurfer.on("play",this.handlePlay),this.wavesurfer.on("finish",this.handleFinish),this.wavesurfer.on("ready",this.handleReady),this.wavesurfer.on("error",this.handleError))}setEventHandlers(e){this.events=e}async load(e){if(!this.wavesurfer)throw new Error("WaveSurfer not initialized");this.cleanupPreviousUrl();let o,r=null;try{if(e instanceof Blob)r=URL.createObjectURL(e),o=r;else if(e instanceof ArrayBuffer){const n=new Blob([e]);r=URL.createObjectURL(n),o=r}else o=e;this.currentBlobUrl=r,await this.wavesurfer.load(o)}catch(n){throw this.cleanupPreviousUrl(),n}}async play(){if(!this.wavesurfer)throw new Error("WaveSurfer not initialized");await this.wavesurfer.play()}pause(){this.wavesurfer&&this.wavesurfer.pause()}getDuration(){return this.wavesurfer?this.wavesurfer.getDuration()*1e3:0}getCurrentTime(){return this.wavesurfer?this.wavesurfer.getCurrentTime()*1e3:0}getIsPlaying(){return this.isPlaying}seekToStart(){this.wavesurfer&&this.wavesurfer.seekTo(0)}cleanupPreviousUrl(){this.currentBlobUrl&&(URL.revokeObjectURL(this.currentBlobUrl),this.currentBlobUrl=null)}destroy(){this.pause(),this.cleanupPreviousUrl(),this.wavesurfer&&(this.teardownEventListeners(),this.wavesurfer.empty(),this.wavesurfer=null),this.events={},this.isPlaying=!1,this.handleTimeUpdate=void 0,this.handlePause=void 0,this.handlePlay=void 0,this.handleFinish=void 0,this.handleReady=void 0,this.handleError=void 0}teardownEventListeners(){this.wavesurfer&&(this.handleTimeUpdate&&(this.wavesurfer.un("timeupdate",this.handleTimeUpdate),this.handleTimeUpdate=void 0),this.handlePause&&(this.wavesurfer.un("pause",this.handlePause),this.handlePause=void 0),this.handlePlay&&(this.wavesurfer.un("play",this.handlePlay),this.handlePlay=void 0),this.handleFinish&&(this.wavesurfer.un("finish",this.handleFinish),this.handleFinish=void 0),this.handleReady&&(this.wavesurfer.un("ready",this.handleReady),this.handleReady=void 0),this.handleError&&(this.wavesurfer.un("error",this.handleError),this.handleError=void 0))}}function W(l){return l.name==="NotAllowedError"||l.name==="PermissionDeniedError"||l.message?.toLowerCase().includes("permission denied")}class J{constructor(e={}){this.wavesurfer=null,this.recordPlugin=null,this.isRecording=!1,this.recordEndResolve=null,this.recordEndReject=null,this.events={},this.options=e}initialize(e,o){this.wavesurfer=e;try{const r={renderRecordedAudio:!1,mimeType:"audio/webm"};this.recordPlugin=e.registerPlugin(o.create(r)),this.setupEventListeners()}catch(r){const n=r instanceof Error?r:new Error(String(r));throw W(n)?(this.events.onPermissionDenied?.(),new Error("Microphone permission denied")):(this.events.onError?.(n),n)}}setupEventListeners(){this.recordPlugin&&(this.recordPlugin.on("record-start",()=>{this.isRecording=!0,this.events.onRecordStart?.()}),this.recordPlugin.on("record-end",e=>{this.isRecording=!1,this.events.onRecordEnd?.(e),this.recordEndResolve&&e&&e.size>0?(this.recordEndResolve(e),this.recordEndResolve=null,this.recordEndReject=null):this.recordEndReject?(this.recordEndReject(new Error("Invalid or empty recording")),this.recordEndResolve=null,this.recordEndReject=null):(this.recordEndResolve=null,this.recordEndReject=null)}),this.recordPlugin.on("record-progress",e=>{this.events.onRecordProgress?.(e)}))}setEventHandlers(e){this.events=e}async startRecording(){if(!this.recordPlugin)throw new Error("Record plugin not initialized");if(this.isRecording)return;const e=typeof this.options.sampleRate=="number"?this.options.sampleRate:void 0,o={};e!==void 0&&(o.sampleRate={ideal:e}),await this.startRecordingWithConstraints(o,e!==void 0)}async startRecordingWithConstraints(e,o){if(!this.recordPlugin)throw new Error("Record plugin not initialized");try{const r=Object.keys(e).length?e:void 0;await this.recordPlugin.startRecording(r)}catch(r){const n=r instanceof Error?r:new Error(String(r));if(W(n))throw this.events.onPermissionDenied?.(),new Error("Microphone permission denied");if(o&&(n.name==="OverconstrainedError"||n.name==="NotReadableError")){this.options.sampleRate=void 0,await this.startRecordingWithConstraints({},!1);return}throw this.events.onError?.(n),n}}async stopRecording(){if(!this.recordPlugin||!this.isRecording)throw new Error("Not currently recording");try{return new Promise((e,o)=>{this.recordEndResolve=e,this.recordEndReject=o,this.recordPlugin?.stopRecording()})}catch(e){const o=e instanceof Error?e:new Error(String(e));throw this.events.onError?.(o),o}}cancelRecording(){this.recordPlugin&&this.isRecording&&(this.recordPlugin.stopRecording(),this.isRecording=!1,this.recordEndResolve=null,this.recordEndReject=null)}destroy(){this.cancelRecording(),this.recordPlugin&&(this.recordPlugin.destroy(),this.recordPlugin=null),this.wavesurfer=null,this.events={}}}const K=4,Q=4,X=8,Y=0,ee=16e3;function te({containerRef:l,sampleRate:e,events:o}){const r=G(),[n,h]=i.useState("idle"),[a,E]=i.useState(null),[y,u]=i.useState(!1),c=i.useRef(null),d=i.useRef(null),s=i.useRef(null),f=i.useRef(o),U=i.useRef(!1),z=i.useRef(!1),p=i.useRef(new Set),m=i.useRef(!1),P=e===void 0?ee:e,S=i.useCallback(()=>{p.current.clear(),u(!1),d.current&&(d.current.destroy(),d.current=null),s.current&&(s.current.destroy(),s.current=null),c.current&&(c.current.destroy(),c.current=null),U.current=!1,m.current=!1,h("idle"),E(null)},[]),D=i.useCallback(()=>{const t=Array.from(p.current);p.current.clear(),t.forEach(w=>{w.resolve()})},[]),x=i.useCallback(t=>{u(!1);const w=Array.from(p.current);p.current.clear(),w.forEach(v=>{v.reject(t)})},[]),C=i.useCallback(t=>{const w={onPlay:()=>{u(!0),f.current.onPlaybackPlay?.()},onPause:()=>{u(!1),f.current.onPlaybackPause?.()},onFinish:()=>{u(!1),f.current.onPlaybackFinish?.()},onReady:()=>{D()},onError:v=>{u(!1),x(v),f.current.onError?.(v)}};t.setEventHandlers(w)},[D,x]);i.useEffect(()=>{f.current=o,s.current&&C(s.current)},[o,C]);const T=i.useCallback(async()=>{if(!(U.current||z.current||!l.current)){z.current=!0;try{const[t,w]=await Promise.all([L(()=>import("./wavesurfer.esm.vI8Eid4k.js"),[],import.meta.url),L(()=>import("./record.B-tDciZb.js"),[],import.meta.url)]),v=t.default,A=w.default,B=v.create({container:l.current,waveColor:r.colors.primary,progressColor:r.colors.bodyText,height:"auto",barWidth:K,barGap:Q,barRadius:X,cursorWidth:Y,interact:!0});c.current=B,m.current=!1;const b=new J({sampleRate:P});b.initialize(B,A),b.setEventHandlers({onRecordProgress:g=>{f.current.onProgressMs?.(g)},onPermissionDenied:()=>{f.current.onPermissionDenied(),h("idle")},onError:g=>{f.current.onError(g),h("idle")}}),d.current=b;const R=new O;R.initialize(B),s.current=R,C(R),U.current=!0}catch(t){const w=t instanceof Error?t:new Error(String(t));f.current.onError?.(w)}finally{z.current=!1}}},[l,r,P,C]);i.useEffect(()=>(T(),()=>{S()}),[S,T]),i.useEffect(()=>{const t=c.current;if(t){if(n==="recording"){t.setOptions({waveColor:r.colors.primary,progressColor:r.colors.primary});return}if(m.current){t.setOptions({interact:!0,waveColor:M(r.colors.fadedText40,r.colors.secondaryBg),progressColor:r.colors.bodyText});return}t.setOptions({waveColor:r.colors.primary,progressColor:r.colors.bodyText})}},[n,r.colors.bodyText,r.colors.fadedText40,r.colors.primary,r.colors.secondaryBg]);const I=i.useCallback(async()=>{if(n!=="recording"){if(U.current||await T(),!d.current)throw new Error("Record backend not initialized");c.current&&c.current.setOptions({waveColor:r.colors.primary,progressColor:r.colors.primary}),m.current=!1,await d.current.startRecording(),h("recording"),E(null),u(!1),f.current.onRecordStart?.()}},[n,T,r.colors.primary]),_=i.useCallback(()=>{s.current&&c.current&&(s.current.destroy(),s.current=new O,s.current.initialize(c.current),p.current.clear(),u(!1),C(s.current)),m.current=!1},[C]),k=i.useCallback(()=>{s.current?.seekToStart(),u(!1),m.current=!0,c.current&&c.current.setOptions({interact:!0,waveColor:M(r.colors.fadedText40,r.colors.secondaryBg),progressColor:r.colors.bodyText})},[r.colors.bodyText,r.colors.fadedText40,r.colors.secondaryBg]),F=i.useCallback(async()=>{if(n!=="recording")throw new Error("Not currently recording");if(!d.current||!s.current)throw new Error("Backends not initialized");try{const t=await d.current.stopRecording();E(t),await new Promise((B,b)=>{if(!s.current){b(new Error("Player not initialized"));return}const R={resolve:()=>{p.current.delete(R),B()},reject:g=>{p.current.delete(R),b(g)}};p.current.add(R),s.current.load(t).catch(g=>{p.current.delete(R),b(g instanceof Error?g:new Error(String(g)))})}),h("idle"),u(!1),k();const v={durationMs:s.current?.getDuration()??0,sampleRate:typeof P=="number"?P:null,mimeType:t.type||"audio/webm",size:t.size},A={blob:t,meta:v};return f.current.onRecordReady?.(t),A}catch(t){const w=t instanceof Error?t:new Error(String(t));return u(!1),h("idle"),f.current.onError(w),{blob:new Blob,meta:{durationMs:0,sampleRate:null,mimeType:"audio/webm",size:0}}}},[n,k,P]),j=i.useCallback(async t=>{const w=t??a;if(!w){const v=new Error("No recorded audio to approve");f.current.onError(v);return}try{const v=await Z(w,P);await f.current.onApprove?.(v),E(null),h("idle")}catch(v){const A=v instanceof Error?v:new Error(String(v));f.current.onError(A)}},[a,P]),H=i.useCallback(()=>{n==="recording"&&d.current?.cancelRecording(),_(),E(null),h("idle"),u(!1),m.current=!1,f.current.onCancel?.()},[n,_]),N=i.useMemo(()=>({isPlaying:()=>s.current?.getIsPlaying()??!1,play:async()=>{if(!s.current)throw new Error("Player not initialized");await s.current.play()},pause:()=>{s.current?.pause()},load:async t=>{if(U.current||await T(),!s.current)throw new Error("Player not initialized");await s.current.load(t),k()},getCurrentTimeMs:()=>s.current?.getCurrentTime()??0,getDurationMs:()=>s.current?.getDuration()??0}),[k,T]),V=i.useCallback(t=>{f.current=t},[]);return i.useEffect(()=>()=>{S()},[S]),{state:n,isPlaybackPlaying:y,mountRef:l,start:I,stop:F,approve:j,cancel:H,destroy:S,playback:N,setEventHandlers:V}}export{te as u};
