# Оценка времени реализации парсеров для nodes.json и gems.json

## Анализ изученности

### ✅ Что изучено детально:

1. **Структура загрузки в Data.lua:**
   - Логика `LoadModule()` для загрузки модулей
   - Процесс загрузки gems: `Data/Gems.lua` → `setupGem()` → связывание с skills
   - Процесс загрузки skills: `Data/Skills/*.lua` → обработка модификаторов
   - Функции обработки: `makeSkillMod()`, `processMod()`, `setupGem()`

2. **Структура данных:**
   - Формат gems: `{ name, gameId, grantedEffectId, reqStr/Dex/Int, tags, ... }`
   - Формат skills: `{ name, baseMods, qualityMods, levelMods, statMap, levels, ... }`
   - Формат nodes: `{ id, name, stats, isKeystone, isNotable, x, y, connections, ... }`

3. **Процесс обработки:**
   - Связывание gems ↔ skills через `grantedEffectId`
   - Обработка модификаторов через `processMod()`
   - Специальные случаи (Vaal gems, AltX/AltY, Support gems)

### ⚠️ Что требует дополнительного изучения:

1. **Реальные файлы данных:**
   - `Data/Gems.lua` - размер ~423KB, структура может быть сложнее
   - `Data/Skills/*.lua` - 10 файлов, каждый может иметь уникальные особенности
   - Структура PassiveSkills.dat - бинарный формат, требует реверс-инжиниринга

2. **Детали парсинга:**
   - Обработка вложенных таблиц в Lua
   - Обработка функций и метатаблиц
   - Обработка специальных Lua конструкций

## Оценка времени реализации

### Вариант 1: Полная реализация с парсингом Lua файлов

#### Этап 1: Изучение и подготовка (20 часов)

1. **Детальное изучение реальных файлов:**
   - Анализ `Data/Gems.lua` (423KB): **4 часа**
     - Изучение структуры записей
     - Выявление всех полей и их типов
     - Понимание специальных случаев

   - Анализ `Data/Skills/*.lua` (10 файлов): **6 часов**
     - Изучение структуры skills по типам
     - Анализ модификаторов (baseMods, qualityMods, levelMods)
     - Понимание statMap структуры

   - Анализ структуры nodes: **4 часа**
     - Изучение PassiveSkills.dat формата (если нужен)
     - Или анализ tree JSON структуры
     - Понимание всех полей узлов

2. **Выбор инструментов:**
   - Выбор Lua парсера (lupa, lua-parser, ручной): **2 часа**
   - Установка и настройка: **2 часа**
   - Тестирование на простых примерах: **2 часа**

#### Этап 2: Реализация парсера для gems.json (26 часов)

1. **Базовый парсер Lua таблиц:**
   - Парсинг простых таблиц: **4 часа**
   - Парсинг вложенных структур: **4 часа**
   - Обработка массивов и словарей: **2 часа**
   - Обработка специальных типов (nil, функции): **2 часа**

2. **Обработка данных:**
   - Парсинг `Data/Gems.lua`: **4 часа**
   - Парсинг `Data/Skills/*.lua` (10 файлов): **6 часов**
   - Связывание gems ↔ skills: **2 часа**
   - Обработка Vaal/AltX/AltY: **2 часа**

3. **Тестирование и отладка:**
   - Unit тесты: **4 часа**
   - Интеграционные тесты: **2 часа**
   - Отладка и исправление ошибок: **4 часа**

#### Этап 3: Реализация парсера для nodes.json (16-32 часа)

**Вариант A: Если доступен tree JSON (16 часов)**
- Парсинг JSON структуры: **2 часа**
- Извлечение узлов: **2 часа**
- Обработка связей и геометрии: **4 часа**
- Валидация данных: **2 часа**
- Тестирование: **4 часа**
- Отладка: **2 часа**

**Вариант B: Парсинг PassiveSkills.dat (32 часа)**
- Реверс-инжиниринг бинарного формата: **12 часов**
- Реализация парсера .dat файла: **8 часов**
- Обработка структуры узлов: **4 часа**
- Валидация данных: **2 часа**
- Тестирование: **4 часа**
- Отладка: **2 часа**

#### Этап 4: Интеграция и валидация (10 часов)

1. **Интеграция с GameDataLoader:**
   - Адаптация формата данных: **2 часа**
   - Интеграция в существующий код: **2 часа**

2. **Валидация данных:**
   - Проверка полноты данных: **2 часа**
   - Проверка корректности связей: **2 часа**
   - Обработка ошибок и edge cases: **2 часа**

#### Этап 5: Документация и финализация (8 часов)

1. **Документация:**
   - Документация API: **2 часа**
   - Примеры использования: **2 часа**

2. **Тесты:**
   - Unit тесты для парсеров: **2 часа**
   - Интеграционные тесты: **2 часа**

### Итого для полной реализации:

- **Минимум (tree JSON доступен):** 20 + 26 + 16 + 10 + 8 = **80 часов** (~2 недели)
- **Максимум (нужен парсинг .dat):** 20 + 26 + 32 + 10 + 8 = **96 часов** (~2.5 недели)
- **Средняя оценка:** **88 часов** (~2.2 недели полной работы)

### Вариант 2: Упрощенная реализация (40-50 часов)

Если использовать готовые данные или упростить парсинг:

1. **Использование готовых JSON из community:**
   - Поиск готовых источников: **2 часа**
   - Адаптация формата: **4 часа**
   - Интеграция: **2 часа**
   - **ИТОГО: 8 часов**

2. **Упрощенный парсер (только базовые поля):**
   - Базовый парсинг Lua: **12 часов**
   - Обработка только основных полей: **8 часов**
   - Минимальная валидация: **4 часа**
   - Тестирование: **6 часов**
   - **ИТОГО: 30 часов**

### Вариант 3: Гибридный подход (24-32 часа)

1. **Gems: Парсинг Lua (16 часов)**
   - Использование lupa для парсинга
   - Обработка основных полей
   - Связывание с skills

2. **Nodes: Использование готовых данных (8-16 часов)**
   - Поиск готового tree JSON
   - Или использование официального API
   - Адаптация формата

## Рекомендации

### Краткосрочное решение (1-2 дня):

1. **Использовать готовые данные:**
   - Поиск готовых nodes.json и gems.json в community проектах
   - Адаптация формата под наш GameDataLoader
   - **Время: 8-16 часов**

### Среднесрочное решение (1-2 недели):

1. **Реализовать упрощенный парсер:**
   - Использовать lupa для парсинга Lua
   - Обработать только основные поля
   - Постепенно расширять функциональность
   - **Время: 40-50 часов**

### Долгосрочное решение (2-3 недели):

1. **Полная реализация:**
   - Детальный парсинг всех полей
   - Обработка всех edge cases
   - Полная валидация данных
   - **Время: 80-96 часов**

## Риски и сложности

### Высокие риски:

1. **Сложность структуры Lua файлов:**
   - Вложенные таблицы
   - Функции в данных
   - Метатаблицы
   - **Влияние: +20-30% времени**

2. **Парсинг PassiveSkills.dat:**
   - Бинарный формат
   - Требует реверс-инжиниринга
   - Может измениться в патчах
   - **Влияние: +50-100% времени для nodes**

3. **Обработка edge cases:**
   - Vaal gems
   - Альтернативные версии
   - Специальные модификаторы
   - **Влияние: +15-20% времени**

### Средние риски:

1. **Изменения в структуре данных:**
   - PoB обновляется регулярно
   - Формат может меняться
   - **Влияние: Требуется поддержка**

2. **Производительность:**
   - Большие файлы (Gems.lua ~423KB)
   - Множество связей
   - **Влияние: Оптимизация может потребоваться**

## Выводы

### Реалистичная оценка:

- **Минимум (готовые данные):** 8-16 часов
- **Упрощенная реализация:** 40-50 часов
- **Полная реализация:** 80-96 часов

### Рекомендуемый подход:

1. **Фаза 1 (1-2 дня):** Использовать готовые данные из community
2. **Фаза 2 (1-2 недели):** Реализовать упрощенный парсер для gems
3. **Фаза 3 (опционально):** Расширить до полной реализации

Это позволит быстро получить рабочее решение и постепенно улучшать его.
