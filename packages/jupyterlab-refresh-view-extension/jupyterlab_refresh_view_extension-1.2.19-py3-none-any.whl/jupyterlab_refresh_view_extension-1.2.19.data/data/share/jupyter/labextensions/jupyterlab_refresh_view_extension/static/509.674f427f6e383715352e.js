"use strict";(self.webpackChunkjupyterlab_refresh_view_extension=self.webpackChunkjupyterlab_refresh_view_extension||[]).push([[509],{509:(e,o,t)=>{t.r(o),t.d(o,{default:()=>c});var r=t(986),n=t(249),l=t(138),s=t(560);const i={id:"jupyterlab_refresh_view_extension:plugin",description:"A JupyterLab to allow context menu option to refresh markdown or notebook",autoStart:!0,requires:[l.IDocumentManager],optional:[r.ICommandPalette,n.IFileBrowserFactory,s.ISettingRegistry],activate:(e,o,t,r,n)=>{console.log("JupyterLab extension jupyterlab_refresh_view_extension is activated!");let l={notebookScrollRestoration:!0,markdownScrollRestoration:!0,notebookTimeout:5e3,markdownTimeout:3e3};n&&n.load(i.id).then(e=>{l.notebookScrollRestoration=e.get("notebookScrollRestoration").composite,l.markdownScrollRestoration=e.get("markdownScrollRestoration").composite,l.notebookTimeout=e.get("notebookTimeout").composite,l.markdownTimeout=e.get("markdownTimeout").composite,e.changed.connect(()=>{l.notebookScrollRestoration=e.get("notebookScrollRestoration").composite,l.markdownScrollRestoration=e.get("markdownScrollRestoration").composite,l.notebookTimeout=e.get("notebookTimeout").composite,l.markdownTimeout=e.get("markdownTimeout").composite})}).catch(e=>{console.error("[SETTINGS] Failed to load settings:",e)});const{commands:s}=e,c="jupyterlab_refresh_view:refresh";s.addCommand(c,{label:"Refresh View",caption:"Refresh the current document view without scrolling",execute:async()=>{const t=e.shell.currentWidget;if(!t)return;const r=o.contextForWidget(t);if(!r)return;const n=t.node.querySelector(".jp-WindowedPanel-outer")||t.node.querySelector(".jp-RenderedMarkdown")||t.node.querySelector(".jp-FileEditor");let s=0,i=0,c=-1,a=0;if(n){s=n.scrollTop,i=n.scrollLeft;const e=Array.from(t.node.querySelectorAll(".jp-Cell"));if(e.length>0){const o=n.getBoundingClientRect();for(let t=0;t<e.length;t++){const r=e[t].getBoundingClientRect(),n=r.top-o.top;if(n>=-r.height&&n<=o.height){c=t,a=n;break}}}}try{await r.revert();const e=c>=0;if(n&&(e&&l.notebookScrollRestoration||!e&&l.markdownScrollRestoration&&s>0)){const o=()=>{if(e){const e=Array.from(t.node.querySelectorAll(".jp-Cell"));if(c<e.length){const o=e[c],t=n.getBoundingClientRect(),r=o.getBoundingClientRect().top-t.top;return n.scrollTop+=r-a,n.scrollLeft=i,!0}return!1}return n.scrollTop=s,n.scrollLeft=i,!1};o();let r=!1;const d=()=>{r=!0};n.addEventListener("wheel",d,{once:!0,passive:!0}),n.addEventListener("touchstart",d,{once:!0,passive:!0});let m=0,u=0,h=n.scrollHeight,p=n.scrollTop;const v=null!==t.node.querySelector(".jp-RenderedMarkdown pre code.language-mermaid"),g=Array.from(t.node.querySelectorAll(".jp-RenderedMarkdown img")),f=g.length>0;let w=0;const k=g.length,b=(e,o)=>()=>{w++,w>=k&&(u=0)};g.forEach((e,o)=>{const t=b(e,o);e.addEventListener("load",t,{once:!0}),e.addEventListener("error",t,{once:!0}),e.complete&&0!==e.naturalHeight&&t()});const T=e?l.notebookTimeout:l.markdownTimeout,S=Math.floor(T/100),R=f||v?5:3,y=setInterval(()=>{if(r)return clearInterval(y),n.removeEventListener("wheel",d),void n.removeEventListener("touchstart",d);const t=n.scrollHeight,c=n.scrollTop,a=o(),v=Math.abs(c-p)<1,g=Math.abs(t-h)<1,f=a?n.scrollTop:s;if(Math.abs(c-f)<1&&v&&g){if(u++,u>=R){if(clearInterval(y),n.removeEventListener("wheel",d),n.removeEventListener("touchstart",d),!e&&l.markdownScrollRestoration){let e=0;const o=Math.floor(l.markdownTimeout/100);let t=!1;const r=()=>{t=!0};n.addEventListener("wheel",r,{once:!0,passive:!0}),n.addEventListener("touchstart",r,{once:!0,passive:!0});const c=setInterval(()=>{if(t)return clearInterval(c),n.removeEventListener("wheel",r),void n.removeEventListener("touchstart",r);const l=n.scrollTop;Math.abs(l-s)>1&&(n.scrollTop=s,n.scrollLeft=i),e++,e>=o&&(clearInterval(c),n.removeEventListener("wheel",r),n.removeEventListener("touchstart",r))},100)}return}}else u=0;p=c,h=t,m++,m>=S&&(clearInterval(y),n.removeEventListener("wheel",d),n.removeEventListener("touchstart",d),setTimeout(()=>{console.log(`[SNAPSHOT-3s] scrollTop=${n.scrollTop}px, height=${n.scrollHeight}px, drift=${Math.abs(n.scrollTop-s).toFixed(2)}px`)},3e3))},100)}}catch(e){console.error("Failed to refresh document:",e)}},isEnabled:()=>{const t=e.shell.currentWidget;return!!t&&void 0!==o.contextForWidget(t)}}),t&&t.addItem({command:c,category:"File Operations"}),e.contextMenu.addItem({command:c,selector:".jp-Document",rank:0}),console.log("Context menu items registered for refresh view extension")}},c=i}}]);