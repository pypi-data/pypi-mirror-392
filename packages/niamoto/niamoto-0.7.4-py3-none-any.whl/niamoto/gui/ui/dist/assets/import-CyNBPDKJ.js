import{be as c}from"./index-DxSNfwTo.js";function g(t,o){const a={reference:8e3,dataset:1e4}[t]||8e3,n=o/1e3*a;return Math.max(3e3,n)+1e3}async function D(t,o){const r=new FormData;r.append("reset_table",String(t.reset_table||!1));const a=t.file;a&&r.append("file",a);let n;return t.entity_type==="reference"?n=`/api/imports/execute/reference/${t.entity_name}`:n=`/api/imports/execute/dataset/${t.entity_name}`,(await c.post(n,r,{headers:{"Content-Type":"multipart/form-data"}})).data}async function _(t=!1){const o=new FormData;return o.append("reset_table",String(t)),(await c.post("/api/imports/execute/all",o,{headers:{"Content-Type":"multipart/form-data"}})).data}async function x(t){return(await c.get(`/api/imports/jobs/${t}`)).data}async function M(t,o=500,r=3e5,a,n,p){try{const d=(await D(t)).job_id,m=Date.now(),f=g(t.entity_type,n||1e3);let s=0,u=0;const w=Math.ceil(r/o);for(;u<w;){if(Date.now()-m>r)throw new Error("Import timed out");const e=await x(d);if(p?.(e),a){if(typeof e.progress=="number")s=Math.max(s,e.progress),a(Math.round(Math.min(100,s)));else if(e.status==="running"){const h=(Date.now()-m)/f*100,y=Math.log(h+1)/Math.log(101)*95;s=Math.max(s,Math.min(95,y)),a(Math.round(s))}}if(e.status==="completed")return a?.(100),{...e,count:e.processed_records||e.total_records||e.count||e.imported_count||e.result?.count||0};if(e.status==="failed")throw new Error(e.errors?.join(", ")||"Import failed");await new Promise(l=>setTimeout(l,o)),u++}throw new Error("Import timed out")}catch(i){throw c.isAxiosError(i)?new Error(i.response?.data?.detail||i.message):i}}export{_ as a,M as e,x as g};
