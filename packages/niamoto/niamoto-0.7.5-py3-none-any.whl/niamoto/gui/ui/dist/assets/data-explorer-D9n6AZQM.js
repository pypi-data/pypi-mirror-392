import{u as ue,a as pe,r as l,j as e,B as j,T as je,b as fe,c as $,D as b,P as F,d as W,C as i,e as x,f as o,g as c,L as f,h as ge,i as Ne,k as y,I as be,S as ye,G,l as U,m as X,n as Y,o as Z,p as ee}from"./index-DxSNfwTo.js";import{a as L}from"./client-DoUPr9N2.js";import{l as ve,r as we}from"./exports-BWTFEA1B.js";import{t as v,F as _e}from"./index-Dj-YiGsJ.js";import{R as Se}from"./refresh-cw-Dv23nu5q.js";import{S as se}from"./sparkles-K0ediSEW.js";import{F as D}from"./file-code-JSNlsDoc.js";import{E as Ce}from"./external-link-DSsEMbXk.js";async function Ee(){return(await L.get("/data/tables")).data}async function Te(a){return(await L.post("/data/query",a)).data}async function Fe(a){return(await L.post("/data/enrichment/preview",a)).data}function Je(){const{t:a}=ue(),_=pe(),[m,te]=l.useState(""),[k,A]=l.useState(""),[q,ae]=l.useState([]),[S,P]=l.useState(!0),[d,z]=l.useState(null),[g,R]=l.useState(!1),[h,w]=l.useState(0),N=100,[re,C]=l.useState(!1),[n,J]=l.useState(null),[le,B]=l.useState(!1),[r,ne]=l.useState(null),[ie,I]=l.useState(!1),[E,ce]=l.useState("database"),[de,T]=l.useState(!1),[u,O]=l.useState(null),[xe,M]=l.useState(!1);l.useEffect(()=>{K()},[]),l.useEffect(()=>{E==="exports"&&oe()},[E]);const oe=async()=>{I(!0);try{const s=await ve();ne(s)}catch(s){console.error("Failed to load exports:",s),v.error("Erreur lors du chargement des exports")}finally{I(!1)}},H=async s=>{M(!0),T(!0),O(null);try{const t=await we(s);O(t)}catch(t){console.error("Failed to load JSON file:",t),v.error("Erreur lors du chargement du fichier"),T(!1)}finally{M(!1)}};l.useEffect(()=>{m&&Q()},[m,h]);const K=async()=>{P(!0);try{const s=await Ee();ae(s)}catch(s){console.error("Failed to load tables:",s),v.error("Erreur lors du chargement des tables")}finally{P(!1)}},Q=async()=>{if(m){R(!0);try{const s=await Te({table:m,limit:N,offset:h*N,where:k||void 0});z(s)}catch(s){console.error("Failed to query table:",s),v.error("Erreur lors de la requête")}finally{R(!1)}}},V=()=>{w(0),Q()},me=s=>{te(s),A(""),w(0),z(null)},he=async s=>{B(!0),C(!0),J(null);try{const t=await Fe({taxon_name:s,table:m});J(t)}catch(t){console.error("Failed to preview enrichment:",t),v.error("Erreur lors de la prévisualisation de l'enrichissement"),C(!1)}finally{B(!1)}};return e.jsxs("div",{className:"container mx-auto p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:a("data_explorer.title","Data Explorer")}),e.jsx("p",{className:"text-muted-foreground",children:a("data_explorer.description","Browse and query your ecological data")})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(j,{variant:"outline",size:"sm",onClick:K,disabled:S,children:[e.jsx(Se,{className:`mr-2 h-4 w-4 ${S?"animate-spin":""}`}),a("common.refresh","Actualiser")]})})]}),e.jsxs(je,{value:E,onValueChange:ce,className:"space-y-4",children:[e.jsxs(fe,{children:[e.jsxs($,{value:"database",className:"gap-2",children:[e.jsx(b,{className:"h-4 w-4"}),"Database"]}),e.jsxs($,{value:"exports",className:"gap-2",children:[e.jsx(F,{className:"h-4 w-4"}),"Exports"]})]}),e.jsx(W,{value:"database",className:"space-y-6",children:e.jsxs("div",{className:"grid gap-6 md:grid-cols-3",children:[e.jsx("div",{className:"space-y-4",children:e.jsxs(i,{children:[e.jsx(x,{children:e.jsxs(o,{className:"flex items-center gap-2",children:[e.jsx(b,{className:"h-5 w-5"}),a("data_explorer.tables","Tables")]})}),e.jsx(c,{className:"space-y-2",children:S?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(f,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):q.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(ge,{className:"h-8 w-8 text-muted-foreground mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:a("data_explorer.no_tables","Aucune table disponible")})]}):q.map(s=>e.jsxs("button",{onClick:()=>me(s.name),className:`w-full text-left p-3 rounded-lg border transition-colors ${m===s.name?"bg-accent border-accent-foreground/20":"hover:bg-muted border-transparent"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"font-medium",children:s.name})]}),e.jsx("span",{className:"text-sm text-muted-foreground",children:s.count.toLocaleString()})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:s.description})]},s.name))})]})}),e.jsx("div",{className:"md:col-span-2 space-y-4",children:m?e.jsxs(e.Fragment,{children:[e.jsxs(i,{children:[e.jsxs(x,{children:[e.jsx(o,{children:a("data_explorer.query_builder","Query Builder")}),e.jsx(y,{children:a("data_explorer.query_description","Build queries to filter and analyze data")})]}),e.jsxs(c,{className:"space-y-4",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(be,{placeholder:a("data_explorer.search_placeholder","WHERE clause (ex: id > 100)"),value:k,onChange:s=>A(s.target.value),onKeyPress:s=>s.key==="Enter"&&V(),className:"flex-1"}),e.jsxs(j,{onClick:V,disabled:g,children:[g?e.jsx(f,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(ye,{className:"mr-2 h-4 w-4"}),a("common.search","Rechercher")]})]}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[e.jsx("p",{children:"Exemples de requêtes WHERE :"}),e.jsxs("ul",{className:"list-disc list-inside mt-1 space-y-0.5",children:[e.jsx("li",{children:e.jsx("code",{className:"bg-muted px-1 rounded",children:"id < 100"})}),e.jsx("li",{children:e.jsx("code",{className:"bg-muted px-1 rounded",children:"full_name LIKE '%Araucaria%'"})}),e.jsx("li",{children:e.jsx("code",{className:"bg-muted px-1 rounded",children:"dbh > 50 AND height < 30"})})]})]})]})]}),e.jsxs(i,{children:[e.jsx(x,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(o,{children:a("data_explorer.results","Résultats")}),e.jsx(y,{children:d?`Affichage de ${d.page_count} sur ${d.total_count.toLocaleString()} enregistrements`:a("data_explorer.no_query","Exécutez une requête pour voir les résultats")})]}),d&&d.total_count>N&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(j,{variant:"outline",size:"sm",onClick:()=>w(Math.max(0,h-1)),disabled:h===0||g,children:"Précédent"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:["Page ",h+1," / ",Math.ceil(d.total_count/N)]}),e.jsx(j,{variant:"outline",size:"sm",onClick:()=>w(h+1),disabled:h>=Math.floor(d.total_count/N)||g,children:"Suivant"})]})]})}),e.jsx(c,{children:g?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(f,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):d&&d.rows.length>0?e.jsx("div",{className:"rounded-lg border overflow-auto max-h-[600px]",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-muted/50 sticky top-0",children:e.jsxs("tr",{children:[m==="taxon_ref"&&e.jsx("th",{className:"px-4 py-2 text-left font-medium whitespace-nowrap",children:"Actions"}),d.columns.map(s=>e.jsx("th",{className:"px-4 py-2 text-left font-medium whitespace-nowrap",children:s},s))]})}),e.jsx("tbody",{children:d.rows.map((s,t)=>e.jsxs("tr",{className:"border-t hover:bg-muted/30",children:[m==="taxon_ref"&&e.jsx("td",{className:"px-4 py-2 whitespace-nowrap",children:e.jsx(j,{size:"sm",variant:"ghost",onClick:()=>he(s.full_name),disabled:!s.full_name,className:"h-8 px-2",children:e.jsx(se,{className:"h-4 w-4"})})}),d.columns.map(p=>e.jsx("td",{className:"px-4 py-2 whitespace-nowrap",children:s[p]!==null&&s[p]!==void 0?String(s[p]).length>100?String(s[p]).substring(0,100)+"...":String(s[p]):e.jsx("span",{className:"text-muted-foreground italic",children:"null"})},p))]},t))})]})}):e.jsx("div",{className:"rounded-lg border p-4",children:e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:d?.rows.length===0?a("data_explorer.no_results","Aucun résultat trouvé"):a("data_explorer.table_preview","Sélectionnez une table et cliquez sur Rechercher")})})})]})]}):e.jsx(i,{children:e.jsxs(c,{className:"flex flex-col items-center justify-center py-12",children:[e.jsx(b,{className:"h-12 w-12 text-muted-foreground mb-4"}),e.jsx("p",{className:"text-lg font-medium",children:a("data_explorer.select_table","Select a table to explore")}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:a("data_explorer.select_table_description","Choose a table from the list to start exploring your data")})]})})})]})}),e.jsx(W,{value:"exports",className:"space-y-6",children:e.jsx("div",{className:"space-y-4",children:ie?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(f,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):r?.exists?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsx(i,{children:e.jsx(c,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:r.web.length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Pages HTML"})]}),e.jsx(G,{className:"h-8 w-8 text-purple-500"})]})})}),e.jsx(i,{children:e.jsx(c,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:r.api.length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Fichiers JSON"})]}),e.jsx(D,{className:"h-8 w-8 text-blue-500"})]})})}),e.jsx(i,{children:e.jsx(c,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:r.dwc.length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Darwin Core"})]}),e.jsx(b,{className:"h-8 w-8 text-green-500"})]})})})]}),r.path&&e.jsx(i,{children:e.jsx(c,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(F,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-muted-foreground",children:"Répertoire :"}),e.jsx("code",{className:"px-2 py-1 bg-muted rounded font-mono text-xs",children:r.path})]}),e.jsxs(j,{variant:"outline",size:"sm",onClick:()=>_("/data/preview"),children:[e.jsx(Ce,{className:"h-4 w-4 mr-2"}),"Voir le site"]})]})})}),r.web.length>0&&e.jsxs(i,{children:[e.jsxs(x,{children:[e.jsxs(o,{className:"flex items-center gap-2",children:[e.jsx(G,{className:"h-5 w-5 text-purple-500"}),"Pages Web (",r.web.length,")"]}),e.jsx(y,{children:"Pages HTML statiques générées"})]}),e.jsx(c,{children:e.jsxs("div",{className:"rounded-lg border overflow-auto max-h-96",children:[e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-muted/50 sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left font-medium",children:"Fichier"}),e.jsx("th",{className:"px-4 py-2 text-left font-medium",children:"Chemin"}),e.jsx("th",{className:"px-4 py-2 text-right font-medium",children:"Taille"})]})}),e.jsx("tbody",{children:r.web.slice(0,50).map((s,t)=>e.jsxs("tr",{className:"border-t hover:bg-muted/30",children:[e.jsx("td",{className:"px-4 py-2 font-mono text-xs",children:s.name}),e.jsx("td",{className:"px-4 py-2 text-xs text-muted-foreground",children:s.path}),e.jsxs("td",{className:"px-4 py-2 text-right text-xs",children:[(s.size/1024).toFixed(1)," KB"]})]},t))})]}),r.web.length>50&&e.jsxs("div",{className:"p-3 text-center text-sm text-muted-foreground border-t",children:["... et ",r.web.length-50," autres fichiers"]})]})})]}),r.api.length>0&&e.jsxs(i,{children:[e.jsxs(x,{children:[e.jsxs(o,{className:"flex items-center gap-2",children:[e.jsx(D,{className:"h-5 w-5 text-blue-500"}),"API JSON (",r.api.length,")"]}),e.jsx(y,{children:"Fichiers JSON pour API statique"})]}),e.jsx(c,{children:e.jsxs("div",{className:"rounded-lg border overflow-auto max-h-96",children:[e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-muted/50 sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left font-medium",children:"Fichier"}),e.jsx("th",{className:"px-4 py-2 text-left font-medium",children:"Chemin"}),e.jsx("th",{className:"px-4 py-2 text-right font-medium",children:"Taille"})]})}),e.jsx("tbody",{children:r.api.slice(0,50).map((s,t)=>e.jsxs("tr",{className:"border-t hover:bg-muted/30 cursor-pointer",onClick:()=>H(s.path),children:[e.jsx("td",{className:"px-4 py-2 font-mono text-xs",children:s.name}),e.jsx("td",{className:"px-4 py-2 text-xs text-muted-foreground",children:s.path}),e.jsxs("td",{className:"px-4 py-2 text-right text-xs",children:[(s.size/1024).toFixed(1)," KB"]})]},t))})]}),r.api.length>50&&e.jsxs("div",{className:"p-3 text-center text-sm text-muted-foreground border-t",children:["... et ",r.api.length-50," autres fichiers"]})]})})]}),r.dwc.length>0&&e.jsxs(i,{children:[e.jsxs(x,{children:[e.jsxs(o,{className:"flex items-center gap-2",children:[e.jsx(b,{className:"h-5 w-5 text-green-500"}),"Darwin Core (",r.dwc.length,")"]}),e.jsx(y,{children:"Exports au format Darwin Core"})]}),e.jsx(c,{children:e.jsxs("div",{className:"rounded-lg border overflow-auto max-h-96",children:[e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-muted/50 sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left font-medium",children:"Fichier"}),e.jsx("th",{className:"px-4 py-2 text-left font-medium",children:"Chemin"}),e.jsx("th",{className:"px-4 py-2 text-right font-medium",children:"Taille"})]})}),e.jsx("tbody",{children:r.dwc.slice(0,50).map((s,t)=>e.jsxs("tr",{className:"border-t hover:bg-muted/30 cursor-pointer",onClick:()=>H(s.path),children:[e.jsx("td",{className:"px-4 py-2 font-mono text-xs",children:s.name}),e.jsx("td",{className:"px-4 py-2 text-xs text-muted-foreground",children:s.path}),e.jsxs("td",{className:"px-4 py-2 text-right text-xs",children:[(s.size/1024).toFixed(1)," KB"]})]},t))})]}),r.dwc.length>50&&e.jsxs("div",{className:"p-3 text-center text-sm text-muted-foreground border-t",children:["... et ",r.dwc.length-50," autres fichiers"]})]})})]})]}):e.jsx(i,{children:e.jsxs(c,{className:"flex flex-col items-center justify-center py-12",children:[e.jsx(F,{className:"h-12 w-12 text-muted-foreground mb-4"}),e.jsx("p",{className:"text-lg font-medium",children:"Aucun export disponible"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Exécutez le pipeline pour générer des exports"})]})})})})]}),e.jsx(U,{open:re,onOpenChange:C,children:e.jsxs(X,{className:"!max-w-7xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(Y,{children:[e.jsxs(Z,{className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-5 w-5"}),a("data_explorer.enrichment_preview","API Enrichment Preview")]}),e.jsx(ee,{children:n?.taxon_name&&`Données enrichies pour : ${n.taxon_name}`})]}),le?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(f,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):n?e.jsxs("div",{className:"space-y-4",children:[e.jsxs(i,{children:[e.jsx(x,{children:e.jsx(o,{className:"text-sm",children:"Configuration"})}),e.jsxs(c,{className:"space-y-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"API URL:"})," ",e.jsx("span",{className:"text-muted-foreground",children:n.config_used.api_url})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Query Field:"})," ",e.jsx("span",{className:"text-muted-foreground",children:n.config_used.query_field})]})]})]}),n.api_enrichment.images&&Array.isArray(n.api_enrichment.images)&&n.api_enrichment.images.length>0&&e.jsxs(i,{children:[e.jsx(x,{children:e.jsx(o,{className:"text-sm",children:"Images"})}),e.jsx(c,{children:e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-4",children:n.api_enrichment.images.slice(0,6).map((s,t)=>e.jsxs("div",{className:"space-y-2",children:[e.jsx("img",{src:s.big_thumb||s.small_thumb,alt:s.auteur||"Image",className:"w-full h-40 object-cover rounded-lg border"}),s.auteur&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["© ",s.auteur]})]},t))})})]}),(n.api_enrichment.image_big_thumb||n.api_enrichment.image_small_thumb)&&e.jsxs(i,{children:[e.jsx(x,{children:e.jsx(o,{className:"text-sm",children:"Image"})}),e.jsx(c,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("img",{src:n.api_enrichment.image_big_thumb||n.api_enrichment.image_small_thumb,alt:"Taxon",className:"w-full max-w-md h-64 object-cover rounded-lg border"}),n.api_enrichment.image_auteur&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["© ",n.api_enrichment.image_auteur]})]})})]}),e.jsxs(i,{children:[e.jsx(x,{children:e.jsx(o,{className:"text-sm",children:"Données enrichies"})}),e.jsx(c,{children:e.jsx("div",{className:"rounded-lg border",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-muted/50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left font-medium",children:"Champ"}),e.jsx("th",{className:"px-4 py-2 text-left font-medium",children:"Valeur"})]})}),e.jsx("tbody",{children:Object.entries(n.api_enrichment).map(([s,t])=>s==="images"||s.startsWith("image_")?null:e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"px-4 py-2 font-medium",children:s}),e.jsx("td",{className:"px-4 py-2",children:t!=null?typeof t=="object"?e.jsx("pre",{className:"text-xs overflow-auto max-h-32 bg-muted p-2 rounded",children:JSON.stringify(t,null,2)}):String(t):e.jsx("span",{className:"text-muted-foreground italic",children:"null"})})]},s))})]})})})]})]}):e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Aucune donnée disponible"})]})}),e.jsx(U,{open:de,onOpenChange:T,children:e.jsxs(X,{className:"!max-w-7xl max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs(Y,{children:[e.jsxs(Z,{className:"flex items-center gap-2",children:[e.jsx(D,{className:"h-5 w-5"}),"Visualisation JSON"]}),e.jsx(ee,{children:u?.path})]}),xe?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(f,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):u?e.jsxs("div",{className:"flex-1 min-h-0",children:[e.jsx("div",{className:"h-[600px] border rounded-lg overflow-hidden",children:e.jsx(_e,{height:"100%",language:"json",value:u.content,theme:"vs-dark",options:{readOnly:!0,minimap:{enabled:!0},scrollBeyondLastLine:!1,wordWrap:"on",automaticLayout:!0}})}),e.jsxs("div",{className:"mt-4 flex items-center justify-between text-sm text-muted-foreground",children:[e.jsxs("span",{children:["Taille : ",(u.size/1024).toFixed(1)," KB"]}),u.error&&e.jsx("span",{className:"text-destructive",children:u.error})]})]}):e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Aucun fichier sélectionné"})]})})]})}export{Je as DataExplorer};
