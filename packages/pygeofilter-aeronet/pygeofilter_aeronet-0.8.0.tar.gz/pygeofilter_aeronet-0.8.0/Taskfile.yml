# Copyright 2025 Terradue
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

version: '3'

tasks:
  install_ruff:
    internal: true
    cmds:
    - pip install ruff pre-commit

  base_ruff:
    deps:
    - install_ruff
    cmds:
    - ruff --version

  ruff_check:
    deps:
    - install_ruff
    cmds:
    #ruff check --fix-only
    - ruff check --output-format=gitlab > code-quality-report.json

  ruff_format:
    deps:
    - install_ruff
    cmds:
    - ruff format --diff

  install_hatch:
    internal: true
    cmds:
    - pip install hatch

  package:
    deps:
    - install_hatch
    cmds:
    - hatch build
    - hatch -e default run nose2 tests

  install_mkdocs:
    internal: true
    cmds:
    - pip install mkdocs-material mkdocs-mermaid2-plugin jupytext ipykernel bash_kernel mkdocs-jupyter legacy-cgi pdocs mkdocs-build-plantuml-plugin folium "numpy<2.0.0" 

  serve-docs:
    deps:
    - install_mkdocs
    cmds:
    - mkdocs serve

  run-clt: 
    cmds:
    - cwltool cwl-clt/aeronet-client.cwl docs/cwl/inputs.yaml 

  install_openapi_prerequisites:
    internal: true
    cmds:
    - npm i -g @redocly/cli@latest
    - pip install openapi-python-client

  generate_openapi:
    deps:
    - install_openapi_prerequisites
    cmds:
    - redocly build-docs ./schemas/aeronet_openapi.yaml --output=./docs/aeronet_openapi.html
    - |
      openapi-python-client generate \
      --meta none \
      --path ./schemas/aeronet_openapi.yaml \
      --output-path ./src/pygeofilter_aeronet/aeronet_client \
      --overwrite
