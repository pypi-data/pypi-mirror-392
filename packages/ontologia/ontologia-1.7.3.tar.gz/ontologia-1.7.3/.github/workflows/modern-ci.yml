name: ğŸš€ Modern CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  release:
    types: [published]

env:
  PYTHONPATH: packages:.
  UV_CACHE_DIR: ~/.cache/uv

jobs:
  # ğŸ” Quality Gates
  quality:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: ğŸ Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: âš¡ Setup UV
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: ğŸ“¦ Cache Dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.UV_CACHE_DIR }}
          key: ${{ runner.os }}-uv-${{ hashFiles('uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: ğŸ”„ Sync Dependencies
        run: uv sync --dev

      - name: ğŸ—ï¸ Architecture Validation
        run: python scripts/git-hooks/validate-architecture.py

      - name: ğŸ¨ Format Check (Black)
        run: uv run black --check .

      - name: ğŸ” Lint (Ruff)
        run: uv run ruff check .

      - name: ğŸ“ Type Check (Ty)
        run: uv run ty check

      - name: ğŸ” Security Check (Bandit)
        run: uv run bandit -r ontologia/ packages/ -f json -o security-report.json || true

      - name: ğŸ“Š Dependency Check (Safety)
        run: uv run safety check --json --output safety-report.json || true

  # ğŸ§ª Testing Matrix
  test:
    name: ğŸ§ª Test Suite
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12', '3.13']
    needs: quality
    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v5

      - name: ğŸ Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: âš¡ Setup UV
        uses: astral-sh/setup-uv@v3

      - name: ğŸ“¦ Cache Dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.UV_CACHE_DIR }}
          key: ${{ runner.os }}-uv-${{ matrix.python-version }}-${{ hashFiles('uv.lock') }}

      - name: ğŸ”„ Sync Dependencies
        run: uv sync --dev

      - name: ğŸ§ª Run Tests
        run: |
          uv run pytest tests/ \
            --cov=ontologia \
            --cov=packages \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --junitxml=test-results-${{ matrix.python-version }}.xml

      - name: ğŸ“Š Upload Coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # ğŸ§ª Forward-compat check against next CPython (allowed to fail)
  test-next:
    name: ğŸ§ª Test Suite (next Python)
    runs-on: ubuntu-latest
    continue-on-error: true
    needs: quality
    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v5

      - name: ğŸ Setup Python (3.14-dev)
        uses: actions/setup-python@v6
        with:
          python-version: '3.14-dev'

      - name: âš¡ Setup UV
        uses: astral-sh/setup-uv@v3

      - name: ğŸ”„ Sync Dependencies
        run: uv sync --dev || true

      - name: ğŸ§ª Run Tests (best-effort)
        run: |
          uv run pytest -q || true

  # ğŸ—ï¸ Build and Package
  build:
    name: ğŸ“¦ Build Package
    runs-on: ubuntu-latest
    needs: [quality, test]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v5

      - name: ğŸ Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: âš¡ Setup UV
        uses: astral-sh/setup-uv@v3

      - name: ğŸ“¦ Cache Dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.UV_CACHE_DIR }}
          key: ${{ runner.os }}-uv-build-${{ hashFiles('uv.lock') }}

      - name: ğŸ”„ Sync Dependencies
        run: uv sync --dev

      - name: ğŸ—ï¸ Build Package
        run: uv build

      - name: ğŸ“¦ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-package
          path: dist/
          retention-days: 30

  # ğŸš€ Deploy (Release only)
  deploy:
    name: ğŸš€ Deploy to PyPI
    runs-on: ubuntu-latest
    needs: [quality, test, build]
    if: github.event_name == 'release'
    environment: production
    permissions:
      id-token: write  # IMPORTANT: this permission is mandatory for trusted publishing
    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v5

      - name: ğŸ Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: âš¡ Setup UV
        uses: astral-sh/setup-uv@v3

      - name: ğŸ”„ Sync Dependencies
        run: uv sync --dev

      - name: ğŸ“¦ Download Build Artifacts
        uses: actions/download-artifact@v6
        with:
          name: python-package
          path: dist/

      - name: ğŸš€ Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}

  # ğŸ“Š Performance Monitoring
  performance:
    name: ğŸ“Š Performance Tests
    runs-on: ubuntu-latest
    needs: quality
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v5

      - name: ğŸ Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: âš¡ Setup UV
        uses: astral-sh/setup-uv@v3

      - name: ğŸ”„ Sync Dependencies
        run: uv sync --dev

      - name: ğŸ“Š Run Performance Tests
        run: |
          uv run pytest tests/performance/ \
            --benchmark-json=benchmark-results.json \
            --benchmark-only

      - name: ğŸ“ˆ Upload Benchmark Results
        uses: benchmark-action/github-action-benchmark@v1
        with:
          tool: 'pytest'
          output-file-path: benchmark-results.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true
          comment-on-alert: true
          alert-threshold: '200%'
          fail-on-alert: true

  # ğŸ“‹ Documentation
  docs:
    name: ğŸ“š Build Documentation
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v5

      - name: ğŸ Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: âš¡ Setup UV
        uses: astral-sh/setup-uv@v3

      - name: ğŸ”„ Sync Dependencies
        run: uv sync --dev

      - name: ğŸ“š Build Documentation
        run: |
          uv run mkdocs build
          # Upload to GitHub Pages if on main
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            uv run mkdocs gh-deploy --force
          fi

  # ğŸ”” Notifications
  notify:
    name: ğŸ”” Notify Results
    runs-on: ubuntu-latest
    needs: [quality, test, build]
    if: always()
    steps:
      - name: ğŸ“§ Notify on Success
        if: ${{ needs.quality.result == 'success' && needs.test.result == 'success' && needs.build.result == 'success' }}
        run: |
          echo "âœ… All checks passed successfully!"
          # Add Slack/Discord notification here if needed

      - name: ğŸš¨ Notify on Failure
        if: ${{ needs.quality.result == 'failure' || needs.test.result == 'failure' || needs.build.result == 'failure' }}
        run: |
          echo "âŒ Some checks failed!"
          # Add Slack/Discord notification here if needed
