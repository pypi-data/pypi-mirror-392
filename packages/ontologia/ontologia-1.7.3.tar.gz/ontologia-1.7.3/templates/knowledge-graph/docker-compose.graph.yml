# Docker Compose - Knowledge Graph Template
# Core services + Graph database (K첫zuDB) for high-performance traversals

version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: ${PROJECT_NAME:-my-ontology-graph}-postgres
    environment:
      POSTGRES_DB: ontologia
      POSTGRES_USER: ontologia
      POSTGRES_PASSWORD: ontologia123
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ontologia"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - ontologia-network

  api:
    image: ontologia:latest
    container_name: ${PROJECT_NAME:-my-ontology-graph}-api
    environment:
      # Database
      DATABASE_URL: postgresql://ontologia:ontologia123@postgres:5432/ontologia

      # Security
      SECRET_KEY: ${SECRET_KEY:-dev-secret-key-change-in-production}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-jwt-secret-key-change-in-production}
      JWT_ALGORITHM: HS256
      JWT_ACCESS_TTL_MINUTES: 60

      # API Configuration
      API_HOST: 0.0.0.0
      API_PORT: 8000
      API_ONTOLOGY: default

      # Feature Flags - Graph mode
      STORAGE_MODE: sql_kuzu
      KUZU_PATH: /app/data/graph.kuzu
      KUZU_PORT: 8001
      ENABLE_SEARCH: "false"
      ENABLE_WORKFLOWS: "false"
      ENABLE_REALTIME: "false"
      ENABLE_ORCHESTRATION: "false"

      # Development mode
      ONTOLOGIA_DEV_MODE: "true"
    ports:
      - "${API_PORT:-8000}:8000"
      - "${KUZU_PORT:-8001}:8001"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    command: >
      sh -c "
        echo 'Running database migrations...' &&
        uv run alembic upgrade head &&
        echo 'Starting API server...' &&
        uv run uvicorn ontologia_api.main:app --host 0.0.0.0 --port 8000 --reload
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - ontologia-network

  # K첫zuDB Graph Database
  kuzu:
    image: kuzudb/kuzu:latest
    container_name: ${PROJECT_NAME:-my-ontology-graph}-kuzu
    environment:
      # K첫zuDB configuration
      KUZU_HOME: /app/data
    ports:
      - "${KUZU_SHELL_PORT:-8002}:8000"
    volumes:
      - kuzu_data:/app/data
      - ./scripts/init-kuzu.sql:/docker-entrypoint-initdb.d/init-kuzu.sql:ro
    command: >
      sh -c "
        echo 'Initializing K첫zuDB graph database...' &&
        kuzu-py /app/data/graph.kuzu
      "
    depends_on:
      - postgres
      - api
    restart: unless-stopped
    networks:
      - ontologia-network

  # Graph Explorer Web Interface
  graph-explorer:
    image: ontologia:latest
    container_name: ${PROJECT_NAME:-my-ontology-graph}-graph-explorer
    environment:
      # API connection
      API_HOST: api
      API_PORT: 8000

      # Graph database connection
      KUZU_PATH: /app/data/graph.kuzu
      STORAGE_MODE: sql_kuzu
    ports:
      - "${GRAPH_EXPLORER_PORT:-3000}:3000"
    volumes:
      - ./data:/app/data
      - ./graph-explorer:/app/graph-explorer
    command: >
      sh -c "
        echo 'Installing graph explorer dependencies...' &&
        pip install streamlit>=1.28.0 plotly>=5.17.0 networkx>=3.0.0 &&
        echo 'Starting graph explorer...' &&
        streamlit run graph-explorer/app.py --server.address=0.0.0.0 --server.port=3000
      "
    depends_on:
      - kuzu
      - api
    restart: unless-stopped
    networks:
      - ontologia-network

  # Jupyter Lab for graph exploration
  jupyter:
    image: ontologia:latest
    container_name: ${PROJECT_NAME:-my-ontology-graph}-jupyter
    environment:
      # Jupyter configuration
      JUPYTER_TOKEN: ${JUPYTER_TOKEN:-jupyter-graph-token}
      JUPYTER_ENABLE_LAB: "yes"

      # Database connections
      DATABASE_URL: postgresql://ontologia:ontologia123@postgres:5432/ontologia
      KUZU_PATH: /app/data/graph.kuzu
      STORAGE_MODE: sql_kuzu
    ports:
      - "${JUPYTER_PORT:-8888}:8888"
    volumes:
      - ./notebooks:/app/notebooks
      - ./data:/app/data
      - ./examples:/app/examples
    command: >
      sh -c "
        echo 'Installing Jupyter dependencies...' &&
        pip install jupyterlab>=4.0.0 ipykernel>=6.0.0 networkx>=3.0.0 matplotlib>=3.7.0 plotly>=5.17.0 &&
        echo 'Starting Jupyter Lab...' &&
        jupyter lab --ip=0.0.0.0 --port=8888 --no-browser --NotebookApp.token='${JUPYTER_TOKEN:-jupyter-graph-token}' --NotebookApp.password='' --allow-root
      "
    depends_on:
      - postgres
      - kuzu
      - api
    restart: unless-stopped
    networks:
      - ontologia-network

  # Graph Analytics Worker
  graph-analytics:
    image: ontologia:latest
    container_name: ${PROJECT_NAME:-my-ontology-graph}-graph-analytics
    environment:
      # Database connections
      DATABASE_URL: postgresql://ontologia:ontologia123@postgres:5432/ontologia
      KUZU_PATH: /app/data/graph.kuzu
      STORAGE_MODE: sql_kuzu

      # Analytics configuration
      ANALYTICS_INTERVAL: 300  # 5 minutes
    volumes:
      - ./data:/app/data
      - ./analytics:/app/analytics
    command: >
      sh -c "
        echo 'Installing analytics dependencies...' &&
        pip install networkx>=3.0.0 pandas>=2.0.0 matplotlib>=3.7.0 &&
        echo 'Starting graph analytics worker...' &&
        python analytics/worker.py
      "
    depends_on:
      - postgres
      - kuzu
      - api
    restart: unless-stopped
    networks:
      - ontologia-network

  # Optional: Database management tool
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: ${PROJECT_NAME:-my-ontology-graph}-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@ontologia.dev}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin123}
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    depends_on:
      - postgres
    profiles:
      - tools  # Only start with: docker-compose --profile tools up
    networks:
      - ontologia-network

  # Optional: Graph visualization tool
  graph-visualization:
    image: ontologia:latest
    container_name: ${PROJECT_NAME:-my-ontology-graph}-graph-viz
    environment:
      # Database connections
      DATABASE_URL: postgresql://ontologia:ontologia123@postgres:5432/ontologia
      KUZU_PATH: /app/data/graph.kuzu
      STORAGE_MODE: sql_kuzu
    ports:
      - "${GRAPH_VIZ_PORT:-8080}:8080"
    volumes:
      - ./data:/app/data
      - ./visualization:/app/visualization
    command: >
      sh -c "
        echo 'Installing visualization dependencies...' &&
        pip install pyvis>=0.3.0 flask>=2.3.0 &&
        echo 'Starting graph visualization server...' &&
        python visualization/app.py
      "
    depends_on:
      - postgres
      - kuzu
      - api
    profiles:
      - tools  # Only start with: docker-compose --profile tools up
    networks:
      - ontologia-network

volumes:
  postgres_data:
    driver: local
  kuzu_data:
    driver: local

networks:
  ontologia-network:
    driver: bridge
    name: ${PROJECT_NAME:-my-ontology-graph}-network
