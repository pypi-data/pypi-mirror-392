# Docker Compose - Simple API Template
# Minimal setup: PostgreSQL + Ontologia API
# Perfect for getting started with basic CRUD operations

version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: ${PROJECT_NAME:-my-ontology-api}-postgres
    environment:
      POSTGRES_DB: ontologia
      POSTGRES_USER: ontologia
      POSTGRES_PASSWORD: ontologia123
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ontologia"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - ontologia-network

  api:
    image: ontologia:latest
    container_name: ${PROJECT_NAME:-my-ontology-api}-api
    environment:
      # Database
      DATABASE_URL: postgresql://ontologia:ontologia123@postgres:5432/ontologia

      # Security
      SECRET_KEY: ${SECRET_KEY:-dev-secret-key-change-in-production}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-jwt-secret-key-change-in-production}
      JWT_ALGORITHM: HS256
      JWT_ACCESS_TTL_MINUTES: 60

      # API Configuration
      API_HOST: 0.0.0.0
      API_PORT: 8000
      API_ONTOLOGY: default

      # Feature Flags - Simple API mode (minimal)
      STORAGE_MODE: sql_only
      ENABLE_SEARCH: "false"
      ENABLE_WORKFLOWS: "false"
      ENABLE_REALTIME: "false"
      ENABLE_ORCHESTRATION: "false"

      # Development mode
      ONTOLOGIA_DEV_MODE: "true"
    ports:
      - "${API_PORT:-8000}:8000"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    command: >
      sh -c "
        echo 'Running database migrations...' &&
        uv run alembic upgrade head &&
        echo 'Starting API server...' &&
        uv run uvicorn ontologia_api.main:app --host 0.0.0.0 --port 8000 --reload
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - ontologia-network

  # Optional: Database management tool
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: ${PROJECT_NAME:-my-ontology-api}-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@ontologia.dev}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin123}
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    depends_on:
      - postgres
    profiles:
      - tools  # Only start with: docker-compose --profile tools up
    networks:
      - ontologia-network

  # Optional: API documentation viewer
  docs:
    image: redocly/redoc:latest
    container_name: ${PROJECT_NAME:-my-ontology-api}-docs
    ports:
      - "${DOCS_PORT:-8080}:80"
    environment:
      SPEC_URL: http://localhost:8000/openapi.json
    command: ["redoc-cli", "serve", "http://localhost:8000/openapi.json", "--port", "80"]
    depends_on:
      - api
    profiles:
      - tools  # Only start with: docker-compose --profile tools up
    networks:
      - ontologia-network

volumes:
  postgres_data:
    driver: local

networks:
  ontologia-network:
    driver: bridge
    name: ${PROJECT_NAME:-my-ontology-api}-network
