# Docker Compose - Data Platform Template
# Core services + Analytics stack (DuckDB, dbt, Dagster, Jupyter)

version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: ${PROJECT_NAME:-my-ontology-analytics}-postgres
    environment:
      POSTGRES_DB: ontologia
      POSTGRES_USER: ontologia
      POSTGRES_PASSWORD: ontologia123
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ontologia"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - ontologia-network

  # Dagster PostgreSQL for orchestration metadata
  dagster-postgres:
    image: postgres:15-alpine
    container_name: ${PROJECT_NAME:-my-ontology-analytics}-dagster-postgres
    environment:
      POSTGRES_DB: dagster
      POSTGRES_USER: dagster
      POSTGRES_PASSWORD: dagster123
    ports:
      - "${DAGSTER_POSTGRES_PORT:-5433}:5432"
    volumes:
      - dagster_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dagster"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - ontologia-network

  api:
    image: ontologia:latest
    container_name: ${PROJECT_NAME:-my-ontology-analytics}-api
    environment:
      # Database
      DATABASE_URL: postgresql://ontologia:ontologia123@postgres:5432/ontologia

      # Security
      SECRET_KEY: ${SECRET_KEY:-dev-secret-key-change-in-production}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-jwt-secret-key-change-in-production}
      JWT_ALGORITHM: HS256
      JWT_ACCESS_TTL_MINUTES: 60

      # API Configuration
      API_HOST: 0.0.0.0
      API_PORT: 8000
      API_ONTOLOGY: default

      # Feature Flags - Analytics mode
      STORAGE_MODE: sql_duckdb
      DUCKDB_PATH: /app/data/analytics.duckdb
      ENABLE_SEARCH: "false"
      ENABLE_WORKFLOWS: "false"
      ENABLE_REALTIME: "false"
      ENABLE_ORCHESTRATION: "true"

      # Development mode
      ONTOLOGIA_DEV_MODE: "true"
    ports:
      - "${API_PORT:-8000}:8000"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./dagster:/app/dagster
    command: >
      sh -c "
        echo 'Running database migrations...' &&
        uv run alembic upgrade head &&
        echo 'Starting API server...' &&
        uv run uvicorn ontologia_api.main:app --host 0.0.0.0 --port 8000 --reload
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - ontologia-network

  # Dagster Daemon
  dagster-daemon:
    image: ontologia:latest
    container_name: ${PROJECT_NAME:-my-ontology-analytics}-dagster-daemon
    environment:
      # Dagster configuration
      DAGSTER_HOME: /app/dagster
      DAGSTER_POSTGRES_DB: postgresql://dagster:dagster123@dagster-postgres:5432/dagster

      # Ontologia connection
      DATABASE_URL: postgresql://ontologia:ontologia123@postgres:5432/ontologia
      DUCKDB_PATH: /app/data/analytics.duckdb

      # Feature flags
      ENABLE_ORCHESTRATION: "true"
    volumes:
      - ./dagster:/app/dagster
      - ./data:/app/data
      - ./dbt:/app/dbt
    command: >
      sh -c "
        echo 'Starting Dagster daemon...' &&
        uv run dagster daemon -h 0.0.0.0 -p 4000
      "
    depends_on:
      - dagster-postgres
      - postgres
    restart: unless-stopped
    networks:
      - ontologia-network

  # Dagster Webserver
  dagster-webserver:
    image: ontologia:latest
    container_name: ${PROJECT_NAME:-my-ontology-analytics}-dagster-webserver
    environment:
      # Dagster configuration
      DAGSTER_HOME: /app/dagster
      DAGSTER_POSTGRES_DB: postgresql://dagster:dagster123@dagster-postgres:5432/dagster

      # Ontologia connection
      DATABASE_URL: postgresql://ontologia:ontologia123@postgres:5432/ontologia
      DUCKDB_PATH: /app/data/analytics.duckdb

      # Feature flags
      ENABLE_ORCHESTRATION: "true"
    ports:
      - "${DAGSTER_PORT:-3000}:3000"
    volumes:
      - ./dagster:/app/dagster
      - ./data:/app/data
      - ./dbt:/app/dbt
    command: >
      sh -c "
        echo 'Starting Dagster webserver...' &&
        uv run dagster-webserver -h 0.0.0.0 -p 3000
      "
    depends_on:
      - dagster-postgres
      - dagster-daemon
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - ontologia-network

  # Dagster Worker
  dagster-worker:
    image: ontologia:latest
    container_name: ${PROJECT_NAME:-my-ontology-analytics}-dagster-worker
    environment:
      # Dagster configuration
      DAGSTER_HOME: /app/dagster
      DAGSTER_POSTGRES_DB: postgresql://dagster:dagster123@dagster-postgres:5432/dagster

      # Ontologia connection
      DATABASE_URL: postgresql://ontologia:ontologia123@postgres:5432/ontologia
      DUCKDB_PATH: /app/data/analytics.duckdb

      # Feature flags
      ENABLE_ORCHESTRATION: "true"
    volumes:
      - ./dagster:/app/dagster
      - ./data:/app/data
      - ./dbt:/app/dbt
    command: >
      sh -c "
        echo 'Starting Dagster worker...' &&
        uv run dagster worker -a dagster-daemon:4000
      "
    depends_on:
      - dagster-daemon
      - postgres
    restart: unless-stopped
    networks:
      - ontologia-network
    deploy:
      replicas: 2

  # dbt Documentation Server
  dbt-docs:
    image: ontologia:latest
    container_name: ${PROJECT_NAME:-my-ontology-analytics}-dbt-docs
    environment:
      # dbt configuration
      DBT_PROFILES_DIR: /app/dbt
      DBT_TARGET_PATH: /app/dbt/target

      # Database connection
      DATABASE_URL: postgresql://ontologia:ontologia123@postgres:5432/ontologia
      DUCKDB_PATH: /app/data/analytics.duckdb
    ports:
      - "${DBT_DOCS_PORT:-8080}:8080"
    volumes:
      - ./dbt:/app/dbt
      - ./data:/app/data
    command: >
      sh -c "
        echo 'Installing dbt dependencies...' &&
        cd /app/dbt &&
        uv run dbt deps &&
        echo 'Running dbt transformations...' &&
        uv run dbt run &&
        echo 'Generating dbt documentation...' &&
        uv run dbt docs generate &&
        echo 'Starting dbt docs server...' &&
        uv run dbt docs serve --host 0.0.0.0 --port 8080
      "
    depends_on:
      - postgres
      - api
    restart: unless-stopped
    networks:
      - ontologia-network

  # Jupyter Lab for data exploration
  jupyter:
    image: ontologia:latest
    container_name: ${PROJECT_NAME:-my-ontology-analytics}-jupyter
    environment:
      # Jupyter configuration
      JUPYTER_TOKEN: ${JUPYTER_TOKEN:-jupyter-dev-token}
      JUPYTER_ENABLE_LAB: "yes"

      # Database connections
      DATABASE_URL: postgresql://ontologia:ontologia123@postgres:5432/ontologia
      DUCKDB_PATH: /app/data/analytics.duckdb

      # Feature flags
      ENABLE_ORCHESTRATION: "true"
    ports:
      - "${JUPYTER_PORT:-8888}:8888"
    volumes:
      - ./notebooks:/app/notebooks
      - ./data:/app/data
      - ./dbt:/app/dbt
      - ./examples:/app/examples
    command: >
      sh -c "
        echo 'Installing Jupyter dependencies...' &&
        pip install jupyterlab>=4.0.0 ipykernel>=6.0.0 &&
        echo 'Starting Jupyter Lab...' &&
        jupyter lab --ip=0.0.0.0 --port=8888 --no-browser --NotebookApp.token='${JUPYTER_TOKEN:-jupyter-dev-token}' --NotebookApp.password='' --allow-root
      "
    depends_on:
      - postgres
      - dbt-docs
    restart: unless-stopped
    networks:
      - ontologia-network

  # Optional: Database management tool
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: ${PROJECT_NAME:-my-ontology-analytics}-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@ontologia.dev}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin123}
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    depends_on:
      - postgres
    profiles:
      - tools  # Only start with: docker-compose --profile tools up
    networks:
      - ontologia-network

  # Optional: Streamlit dashboard
  dashboard:
    image: ontologia:latest
    container_name: ${PROJECT_NAME:-my-ontology-analytics}-dashboard
    environment:
      # Database connections
      DATABASE_URL: postgresql://ontologia:ontologia123@postgres:5432/ontologia
      DUCKDB_PATH: /app/data/analytics.duckdb
    ports:
      - "${DASHBOARD_PORT:-8501}:8501"
    volumes:
      - ./dashboards:/app/dashboards
      - ./data:/app/data
    command: >
      sh -c "
        echo 'Installing dashboard dependencies...' &&
        pip install streamlit>=1.28.0 plotly>=5.17.0 pandas>=2.0.0 &&
        echo 'Starting Streamlit dashboard...' &&
        streamlit run dashboards/main.py --server.address=0.0.0.0 --server.port=8501
      "
    depends_on:
      - postgres
      - dbt-docs
    profiles:
      - tools  # Only start with: docker-compose --profile tools up
    networks:
      - ontologia-network

volumes:
  postgres_data:
    driver: local
  dagster_postgres_data:
    driver: local

networks:
  ontologia-network:
    driver: bridge
    name: ${PROJECT_NAME:-my-ontology-analytics}-network
