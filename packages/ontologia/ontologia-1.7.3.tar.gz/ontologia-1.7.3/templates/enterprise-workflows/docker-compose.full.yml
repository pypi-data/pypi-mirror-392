# Docker Compose - Enterprise Workflows Template
# Complete enterprise stack with all services enabled

version: '3.8'

services:
  # PostgreSQL - Primary transactional database
  postgres:
    image: postgres:15-alpine
    container_name: ${PROJECT_NAME:-my-ontology-enterprise}-postgres
    environment:
      POSTGRES_DB: ontologia
      POSTGRES_USER: ontologia
      POSTGRES_PASSWORD: ontologia123
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ontologia"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - ontologia-network

  # Elasticsearch - Advanced search capabilities
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: ${PROJECT_NAME:-my-ontology-enterprise}-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
      - bootstrap.memory_lock=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
    ports:
      - "${ELASTICSEARCH_PORT:-9200}:9200"
      - "${ELASTICSEARCH_NODE_PORT:-9300}:9300"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    networks:
      - ontologia-network

  # Kibana - Elasticsearch visualization
  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    container_name: ${PROJECT_NAME:-my-ontology-enterprise}-kibana
    environment:
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
      SERVER_NAME: kibana
      SERVER_HOST: "0.0.0.0"
    ports:
      - "${KIBANA_PORT:-5601}:5601"
    depends_on:
      elasticsearch:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5601/api/status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    networks:
      - ontologia-network

  # Redis - Real-time updates and caching
  redis:
    image: redis:7-alpine
    container_name: ${PROJECT_NAME:-my-ontology-enterprise}-redis
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redis123}
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped
    networks:
      - ontologia-network

  # Redis Commander - Redis management UI
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: ${PROJECT_NAME:-my-ontology-enterprise}-redis-commander
    environment:
      REDIS_HOSTS: local:redis:6379:0:${REDIS_PASSWORD:-redis123}
      HTTP_USER: ${REDIS_COMMANDER_USER:-admin}
      HTTP_PASSWORD: ${REDIS_COMMANDER_PASSWORD:-admin123}
    ports:
      - "${REDIS_COMMANDER_PORT:-8081}:8081"
    depends_on:
      - redis
    restart: unless-stopped
    networks:
      - ontologia-network

  # Temporal - Workflow orchestration
  temporal:
    image: temporalio/auto-setup:latest
    container_name: ${PROJECT_NAME:-my-ontology-enterprise}-temporal
    environment:
      - DB=postgresql
      - DB_PORT=5432
      - POSTGRES_USER=ontologia
      - POSTGRES_PWD=ontologia123
      - POSTGRES_SEEDS=postgres
      - DYNAMIC_CONFIG_FILE_PATH=config/dynamicconfig/development.yaml
    ports:
      - "${TEMPORAL_UI_PORT:-7233}:7233"
      - "${TEMPORAL_GRPC_PORT:-7234}:7234"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./temporal/config:/etc/temporal/config
    restart: unless-stopped
    networks:
      - ontologia-network

  # KùzuDB - Graph database
  kuzu:
    image: kuzudb/kuzu:latest
    container_name: ${PROJECT_NAME:-my-ontology-enterprise}-kuzu
    environment:
      KUZU_HOME: /app/data
    ports:
      - "${KUZU_SHELL_PORT:-8002}:8000"
    volumes:
      - kuzu_data:/app/data
      - ./scripts/init-kuzu.sql:/docker-entrypoint-initdb.d/init-kuzu.sql:ro
    command: >
      sh -c "
        echo 'Initializing KùzuDB graph database...' &&
        kuzu-py /app/data/graph.kuzu
      "
    depends_on:
      - postgres
    restart: unless-stopped
    networks:
      - ontologia-network

  # Dagster PostgreSQL for orchestration metadata
  dagster-postgres:
    image: postgres:15-alpine
    container_name: ${PROJECT_NAME:-my-ontology-enterprise}-dagster-postgres
    environment:
      POSTGRES_DB: dagster
      POSTGRES_USER: dagster
      POSTGRES_PASSWORD: dagster123
    ports:
      - "${DAGSTER_POSTGRES_PORT:-5433}:5432"
    volumes:
      - dagster_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dagster"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - ontologia-network

  # Main API Service
  api:
    image: ontologia:latest
    container_name: ${PROJECT_NAME:-my-ontology-enterprise}-api
    environment:
      # Database Configuration
      DATABASE_URL: postgresql://ontologia:ontologia123@postgres:5432/ontologia

      # Security
      SECRET_KEY: ${SECRET_KEY:-dev-secret-key-change-in-production}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-jwt-secret-key-change-in-production}
      JWT_ALGORITHM: HS256
      JWT_ACCESS_TTL_MINUTES: 60

      # API Configuration
      API_HOST: 0.0.0.0
      API_PORT: 8000
      API_ONTOLOGY: default

      # Feature Flags - All enabled for enterprise
      STORAGE_MODE: sql_kuzu
      KUZU_PATH: /app/data/graph.kuzu
      KUZU_PORT: 8001
      ENABLE_SEARCH: "true"
      ENABLE_WORKFLOWS: "true"
      ENABLE_REALTIME: "true"
      ENABLE_ORCHESTRATION: "true"

      # Search Configuration
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
      ELASTICSEARCH_INDEX: ontologia_enterprise

      # Workflow Configuration
      TEMPORAL_ADDRESS: temporal:7233
      TEMPORAL_NAMESPACE: default
      TEMPORAL_TASK_QUEUE: enterprise-tasks

      # Real-time Configuration
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis123}@redis:6379
      REDIS_CHANNELS: ontologia:*

      # Analytics Configuration
      DUCKDB_PATH: /app/data/analytics.duckdb

      # Development mode
      ONTOLOGIA_DEV_MODE: "true"
    ports:
      - "${API_PORT:-8000}:8000"
      - "${KUZU_PORT:-8001}:8001"
    depends_on:
      postgres:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      redis:
        condition: service_healthy
      temporal:
        condition: service_started
      kuzu:
        condition: service_started
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./workflows:/app/workflows
      - ./search:/app/search
      - ./realtime:/app/realtime
      - ./dagster:/app/dagster
    command: >
      sh -c "
        echo 'Running database migrations...' &&
        uv run alembic upgrade head &&
        echo 'Setting up Elasticsearch indices...' &&
        python scripts/setup-elasticsearch.py &&
        echo 'Starting API server...' &&
        uv run uvicorn ontologia_api.main:app --host 0.0.0.0 --port 8000 --workers 4
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    networks:
      - ontologia-network
    deploy:
      replicas: 2

  # Temporal Worker
  temporal-worker:
    image: ontologia:latest
    container_name: ${PROJECT_NAME:-my-ontology-enterprise}-temporal-worker
    environment:
      # Temporal Configuration
      TEMPORAL_ADDRESS: temporal:7233
      TEMPORAL_NAMESPACE: default
      TEMPORAL_TASK_QUEUE: enterprise-tasks

      # Database Configuration
      DATABASE_URL: postgresql://ontologia:ontologia123@postgres:5432/ontologia

      # Feature Flags
      ENABLE_WORKFLOWS: "true"
      ENABLE_SEARCH: "true"
      ENABLE_REALTIME: "true"

      # External Services
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis123}@redis:6379
    volumes:
      - ./workflows:/app/workflows
      - ./data:/app/data
      - ./logs:/app/logs
    command: >
      sh -c "
        echo 'Starting Temporal worker...' &&
        python workflows/worker.py
      "
    depends_on:
      - api
      - temporal
      - postgres
      - elasticsearch
      - redis
    restart: unless-stopped
    networks:
      - ontologia-network
    deploy:
      replicas: 3

  # Dagster Daemon
  dagster-daemon:
    image: ontologia:latest
    container_name: ${PROJECT_NAME:-my-ontology-enterprise}-dagster-daemon
    environment:
      # Dagster configuration
      DAGSTER_HOME: /app/dagster
      DAGSTER_POSTGRES_DB: postgresql://dagster:dagster123@dagster-postgres:5432/dagster

      # Ontologia connection
      DATABASE_URL: postgresql://ontologia:ontologia123@postgres:5432/ontologia
      DUCKDB_PATH: /app/data/analytics.duckdb
      KUZU_PATH: /app/data/graph.kuzu

      # Feature flags
      ENABLE_ORCHESTRATION: "true"
      ENABLE_SEARCH: "true"

      # External services
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
    volumes:
      - ./dagster:/app/dagster
      - ./data:/app/data
      - ./analytics:/app/analytics
    command: >
      sh -c "
        echo 'Starting Dagster daemon...' &&
        uv run dagster daemon -h 0.0.0.0 -p 4000
      "
    depends_on:
      - dagster-postgres
      - postgres
      - elasticsearch
    restart: unless-stopped
    networks:
      - ontologia-network

  # Dagster Webserver
  dagster-webserver:
    image: ontologia:latest
    container_name: ${PROJECT_NAME:-my-ontology-enterprise}-dagster-webserver
    environment:
      # Dagster configuration
      DAGSTER_HOME: /app/dagster
      DAGSTER_POSTGRES_DB: postgresql://dagster:dagster123@dagster-postgres:5432/dagster

      # Ontologia connection
      DATABASE_URL: postgresql://ontologia:ontologia123@postgres:5432/ontologia
      DUCKDB_PATH: /app/data/analytics.duckdb
      KUZU_PATH: /app/data/graph.kuzu

      # Feature flags
      ENABLE_ORCHESTRATION: "true"
      ENABLE_SEARCH: "true"

      # External services
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
    ports:
      - "${DAGSTER_PORT:-3000}:3000"
    volumes:
      - ./dagster:/app/dagster
      - ./data:/app/data
      - ./analytics:/app/analytics
    command: >
      sh -c "
        echo 'Starting Dagster webserver...' &&
        uv run dagster-webserver -h 0.0.0.0 -p 3000
      "
    depends_on:
      - dagster-postgres
      - dagster-daemon
      - postgres
      - elasticsearch
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    networks:
      - ontologia-network

  # Dagster Worker
  dagster-worker:
    image: ontologia:latest
    container_name: ${PROJECT_NAME:-my-ontology-enterprise}-dagster-worker
    environment:
      # Dagster configuration
      DAGSTER_HOME: /app/dagster
      DAGSTER_POSTGRES_DB: postgresql://dagster:dagster123@dagster-postgres:5432/dagster

      # Ontologia connection
      DATABASE_URL: postgresql://ontologia:ontologia123@postgres:5432/ontologia
      DUCKDB_PATH: /app/data/analytics.duckdb
      KUZU_PATH: /app/data/graph.kuzu

      # Feature flags
      ENABLE_ORCHESTRATION: "true"
      ENABLE_SEARCH: "true"

      # External services
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
    volumes:
      - ./dagster:/app/dagster
      - ./data:/app/data
      - ./analytics:/app/analytics
    command: >
      sh -c "
        echo 'Starting Dagster worker...' &&
        uv run dagster worker -a dagster-daemon:4000
      "
    depends_on:
      - dagster-daemon
      - postgres
      - elasticsearch
    restart: unless-stopped
    networks:
      - ontologia-network
    deploy:
      replicas: 2

  # Real-time Event Processor
  realtime-processor:
    image: ontologia:latest
    container_name: ${PROJECT_NAME:-my-ontology-enterprise}-realtime-processor
    environment:
      # Database Configuration
      DATABASE_URL: postgresql://ontologia:ontologia123@postgres:5432/ontologia

      # Real-time Configuration
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis123}@redis:6379
      REDIS_CHANNELS: ontologia:*

      # Feature Flags
      ENABLE_REALTIME: "true"
      ENABLE_SEARCH: "true"

      # External Services
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
    volumes:
      - ./realtime:/app/realtime
      - ./data:/app/data
      - ./logs:/app/logs
    command: >
      sh -c "
        echo 'Starting real-time event processor...' &&
        python realtime/processor.py
      "
    depends_on:
      - redis
      - postgres
      - elasticsearch
    restart: unless-stopped
    networks:
      - ontologia-network

  # Search Indexer
  search-indexer:
    image: ontologia:latest
    container_name: ${PROJECT_NAME:-my-ontology-enterprise}-search-indexer
    environment:
      # Database Configuration
      DATABASE_URL: postgresql://ontologia:ontologia123@postgres:5432/ontologia

      # Search Configuration
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
      ELASTICSEARCH_INDEX: ontologia_enterprise

      # Feature Flags
      ENABLE_SEARCH: "true"

      # Real-time Configuration
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis123}@redis:6379
    volumes:
      - ./search:/app/search
      - ./data:/app/data
      - ./logs:/app/logs
    command: >
      sh -c "
        echo 'Starting search indexer...' &&
        python search/indexer.py
      "
    depends_on:
      - elasticsearch
      - postgres
      - redis
    restart: unless-stopped
    networks:
      - ontologia-network

  # Jupyter Lab for enterprise analytics
  jupyter:
    image: ontologia:latest
    container_name: ${PROJECT_NAME:-my-ontology-enterprise}-jupyter
    environment:
      # Jupyter configuration
      JUPYTER_TOKEN: ${JUPYTER_TOKEN:-jupyter-enterprise-token}
      JUPYTER_ENABLE_LAB: "yes"

      # Database connections
      DATABASE_URL: postgresql://ontologia:ontologia123@postgres:5432/ontologia
      DUCKDB_PATH: /app/data/analytics.duckdb
      KUZU_PATH: /app/data/graph.kuzu

      # External services
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis123}@redis:6379
    ports:
      - "${JUPYTER_PORT:-8888}:8888"
    volumes:
      - ./notebooks:/app/notebooks
      - ./data:/app/data
      - ./analytics:/app/analytics
      - ./examples:/app/examples
    command: >
      sh -c "
        echo 'Installing Jupyter dependencies...' &&
        pip install jupyterlab>=4.0.0 ipykernel>=6.0.0 networkx>=3.0.0 matplotlib>=3.7.0 plotly>=5.17.0 elasticsearch>=8.0.0 redis>=5.0.0 &&
        echo 'Starting Jupyter Lab...' &&
        jupyter lab --ip=0.0.0.0 --port=8888 --no-browser --NotebookApp.token='${JUPYTER_TOKEN:-jupyter-enterprise-token}' --NotebookApp.password='' --allow-root
      "
    depends_on:
      - postgres
      - elasticsearch
      - redis
      - dagster-webserver
    restart: unless-stopped
    networks:
      - ontologia-network

  # Enterprise Dashboard
  dashboard:
    image: ontologia:latest
    container_name: ${PROJECT_NAME:-my-ontology-enterprise}-dashboard
    environment:
      # Database connections
      DATABASE_URL: postgresql://ontologia:ontologia123@postgres:5432/ontologia
      DUCKDB_PATH: /app/data/analytics.duckdb

      # External services
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis123}@redis:6379
    ports:
      - "${DASHBOARD_PORT:-8501}:8501"
    volumes:
      - ./dashboards:/app/dashboards
      - ./data:/app/data
      - ./analytics:/app/analytics
    command: >
      sh -c "
        echo 'Installing dashboard dependencies...' &&
        pip install streamlit>=1.28.0 plotly>=5.17.0 pandas>=2.0.0 elasticsearch>=8.0.0 redis>=5.0.0 &&
        echo 'Starting Streamlit dashboard...' &&
        streamlit run dashboards/enterprise.py --server.address=0.0.0.0 --server.port=8501
      "
    depends_on:
      - postgres
      - elasticsearch
      - redis
      - dagster-webserver
    restart: unless-stopped
    networks:
      - ontologia-network

  # Optional: Database management tool
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: ${PROJECT_NAME:-my-ontology-enterprise}-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@ontologia.dev}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin123}
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    depends_on:
      - postgres
    profiles:
      - tools  # Only start with: docker-compose --profile tools up
    networks:
      - ontologia-network

volumes:
  postgres_data:
    driver: local
  elasticsearch_data:
    driver: local
  redis_data:
    driver: local
  kuzu_data:
    driver: local
  dagster_postgres_data:
    driver: local

networks:
  ontologia-network:
    driver: bridge
    name: ${PROJECT_NAME:-my-ontology-enterprise}-network
