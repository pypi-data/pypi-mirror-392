"""
⚙️ Configuration generation for Ontologia setup.

Generates environment files and configuration for different deployment modes.
"""

from __future__ import annotations

import time
from pathlib import Path
from typing import Any

from rich.console import Console

from scripts.utils import ScriptConfig

from .modes import ModeConfig


class ConfigGenerator:
    """Generates configuration files for Ontologia setup."""

    def __init__(self, console: Console | None = None) -> None:
        self.console = console or Console()

    def generate_env_file(self, mode_config: ModeConfig, project_dir: Path) -> Path:
        """Generate .env file for the specified mode."""
        env_content = self._build_env_content(mode_config, project_dir)

        env_file = project_dir / ".env"
        env_file.write_text(env_content, encoding="utf-8")

        self.console.print(f"✅ Generated .env file at {env_file}")
        return env_file

    def _build_env_content(self, mode_config: ModeConfig, project_dir: Path) -> str:
        """Build the content for the .env file."""
        content = f"""# Ontologia Configuration - {mode_config.display_name} Mode
# Generated by setup script on {time.strftime('%Y-%m-%d %H:%M:%S')}

# Core Configuration
DATABASE_URL=postgresql://ontologia:ontologia123@localhost:5432/ontologia
SECRET_KEY=dev-secret-key-change-in-production
JWT_SECRET_KEY=jwt-secret-key-change-in-production
JWT_ALGORITHM=HS256
JWT_ACCESS_TTL_MINUTES=60

# Feature Flags
"""

        # Add feature flags
        for key, value in mode_config.feature_flags.items():
            content += f"{key}={value}\\n"

        content += f"""
# Development Mode
ONTOLOGIA_DEV_MODE=true

# API Configuration
API_HOST=localhost
API_PORT=8000
API_ONTOLOGY=default

# Database Paths
DUCKDB_PATH={project_dir}/data/analytics.duckdb
KUZU_PATH={project_dir}/data/graph.kuzu
"""

        # Add mode-specific configurations
        if mode_config.mode.value == "full":
            content += """
# Elasticsearch Configuration
ELASTICSEARCH_HOSTS=localhost:9200

# Temporal Configuration
TEMPORAL_ADDRESS=127.0.0.1:7233
TEMPORAL_NAMESPACE=default
TEMPORAL_TASK_QUEUE=actions

# Redis Configuration
REDIS_URL=redis://localhost:6379
"""

        return content

    def validate_config(self, config_path: Path) -> bool:
        """Validate generated configuration."""
        try:
            # Load and validate the configuration
            config = ScriptConfig(config_root=config_path.parent)
            ontologia_config = config.load_ontologia_config()

            # Basic validation
            if not ontologia_config.data.duckdb_path:
                self.console.print("❌ DuckDB path not configured")
                return False

            if not ontologia_config.data.kuzu_path:
                self.console.print("❌ KùzuDB path not configured")
                return False

            self.console.print("✅ Configuration validation passed")
            return True

        except Exception as e:
            self.console.print(f"❌ Configuration validation failed: {e}")
            return False

    def get_config_summary(self, mode_config: ModeConfig) -> dict[str, Any]:
        """Get a summary of the configuration for the mode."""
        return {
            "mode": mode_config.mode.value,
            "display_name": mode_config.display_name,
            "storage_mode": mode_config.feature_flags.get("STORAGE_MODE"),
            "search_enabled": mode_config.feature_flags.get("ENABLE_SEARCH") == "true",
            "workflows_enabled": mode_config.feature_flags.get("ENABLE_WORKFLOWS") == "true",
            "orchestration_enabled": mode_config.feature_flags.get("ENABLE_ORCHESTRATION")
            == "true",
            "docker_files": mode_config.docker_compose_files,
            "dependency_groups": mode_config.get_dependency_groups(),
        }
