name: Edge CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-edge:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
            python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[edge,dev]
      - name: Run edge unit tests
        env:
          TESTING: "1"
          EDGE_VERIFY_SIGNATURES: "1"
        run: |
          pytest -q tests/unit/test_edge_runtime.py tests/unit/test_edge_fusion.py tests/unit/test_edge_signature_verification.py
      - name: Run edge integration tests
        env:
          TESTING: "1"
          EDGE_VERIFY_SIGNATURES: "1"
          EDGE_SHARED_TOKEN: "test-token"
        run: |
          pytest -q tests/integration/test_edge_e2e_signed.py -q



  smoke-docker:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build API image
        run: |
          docker build -f config/edge/Dockerfile.api -t ontologia-edge-api:ci .
      - name: Run API container
        run: |
          docker run -d --rm --name edge-api -p 8001:8001             -e EDGE_VERIFY_SIGNATURES=1 ontologia-edge-api:ci
          # wait for server
          for i in `seq 1 30`; do curl -fsS http://localhost:8001/health && break || sleep 1; done
      - name: Curl /metrics
        run: |
          curl -fsS http://localhost:8001/metrics | head -n 5
      - name: Stop container
        if: always()
        run: docker rm -f edge-api || true


  smoke-compose:
    runs-on: ubuntu-latest
    services:
      docker:
        image: docker:25.0-dind
        privileged: true
    steps:
      - uses: actions/checkout@v4
      - name: Compose up (API + Redis)
        run: |
          docker compose -f config/edge/docker-compose.yml up -d redis
          docker compose -f config/edge/docker-compose.yml build api
          docker compose -f config/edge/docker-compose.yml up -d api
          for i in `seq 1 30`; do curl -fsS http://localhost:8001/health && break || sleep 1; done
      - name: Curl /metrics
        run: |
          curl -fsS http://localhost:8001/metrics | head -n 5
      - name: Compose down
        if: always()
        run: |
          docker compose -f config/edge/docker-compose.yml down -v
