import{b as j,u as P,n as W,h as p,i as x,B as J,g as A,l as f,e as b,a as s,t as _,f as u,c as y,m as M,w as n,F as R,s as B,q as K,o as r,k as H,j as E}from"./index-WQ41F5VK.js";import{u as O}from"./amavis-DrKC7POz.js";import{_ as X}from"./ConfirmDialog-BemItW2F.js";import{a as h}from"./amavis-BUExu2Ci.js";import{V as Y}from"./VToolbar-DYf0Nubr.js";import{V as Z}from"./VAlert-Ck0PurTo.js";import{V as k,c as ee}from"./VAvatar-BKSHKr1K.js";import{V as ae,a as te,b as N}from"./VMenu--sryJ9Uc.js";import{a as z,V as se}from"./VRow-CVWfiMs5.js";import{a as le,V as ie}from"./VRadioGroup-G5s53Jnf.js";import"./permissions-TImOfY3I.js";import"./parameters-CxHnQU2I.js";import"./VCard-B7MvPr5E.js";import"./tag-D-paBiFC.js";import"./VSpacer-yH183XvN.js";/* empty css              */import"./VDialog-ByBq-y2_.js";import"./VProgressCircular-DN4UW8ON.js";import"./ssrBoot-B5vxBC28.js";import"./VSelectionControl-DMlq6-TE.js";import"./VInput-quQSdtEy.js";const re={class:"text-h5 ml-4"},ne={class:"bg-white rounded-lg pa-4 position-relative mt-6 h-100"},oe={key:0},ue={key:1},me={class:"pa-4 bg-grey-lighten-3 rounded"},ce=["innerHTML"],Ee={__name:"MessageView",async setup(de){let o,V;const e=J(),C=K(),{$gettext:t}=j(),q=P(),{displayNotification:w}=W(),m=p(null),v=p(null),L=p(null),i=p(!1),c=p(null),U=x(()=>m.value?m.value:c.value.headers),d=x(()=>{var a;return((a=e.query)==null?void 0:a.secret_id)!==void 0});if(d.value)p(!1);else{const{manualLearningEnabled:a}=([o,V]=A(()=>O()),o=await o,V(),o)}const D=()=>{C.go(-1)},T=async()=>{if(m.value){m.value=null;return}i.value=!0;try{const a=await h.getMessageHeaders(e.params.mailid,e.params.rcpt,e.query.secret_id);m.value=a.data.headers}finally{i.value=!1}},F=async()=>{i.value=!0;const a={rcpt:e.params.rcpt,mailid:e.params.mailid};d.value&&(a.secret_id=e.query.secret_id);try{(await h.releaseMessage(e.params.mailid,a)).data.status==="pending"?w({msg:t("Release request sent")}):w({msg:t("Message released")})}finally{i.value=!1}},I=async()=>{i.value=!0;const a={rcpt:e.params.rcpt,mailid:e.params.mailid};d.value&&(a.secret_id=e.query.secret_id);try{await h.deleteMessage(e.params.mailid,a),w({msg:t("Message deleted")}),d.value||C.push({name:"QuarantineView"})}finally{i.value=!1}},S=async(a,g)=>{manualLearningEnabled.value&&q.authUser.role!==E.USER&&(v.value=q.authUser.role===E.SUPER_ADMIN?"global":"domain",await L.value.open(t("Learning database"),t("Which database should be used for this learning:"),{width:600,noconfirm:!0})),i.value=!0;const l={type:a,selection:[{rcpt:e.params.rcpt,mailid:e.params.mailid}]};v.value&&(l.database=v.value);try{await h.markMessageSelection(l),w({msg:g})}finally{i.value=!1}},G=async()=>{await S("spam",t("Message marked as spam"))},Q=async()=>{await S("ham",t("Message marked as non-spam"))},$=([o,V]=A(()=>h.getMessageContent(e.params.mailid,e.params.rcpt,e.query.secret_id)),o=await o,V(),o);return c.value=$.data,(a,g)=>(r(),f("div",null,[b("div",re,_(u(t)("Quarantined message")),1),b("div",ne,[s(Y,{color:"white"},{default:n(()=>[d.value?M("",!0):(r(),y(k,{key:0,icon:"mdi-arrow-left",size:"small",variant:"flat",onClick:D})),s(k,{class:"ml-2",color:"success",variant:"tonal",icon:"mdi-check",size:"small",title:u(t)("Release message"),loading:i.value,onClick:F},null,8,["title","loading"]),s(k,{class:"ml-2",color:"error",variant:"tonal",icon:"mdi-trash-can",size:"small",title:u(t)("Delete message"),loading:i.value,onClick:I},null,8,["title","loading"]),d.value?M("",!0):(r(),f(R,{key:1},[a.manualLearningEnabled?(r(),y(k,{key:0,class:"ml-2",variant:"tonal",icon:"",size:"small"},{default:n(()=>[s(ee,{icon:"mdi-cog"}),s(ae,{activator:"parent"},{default:n(()=>[s(te,{density:"compact"},{default:n(()=>[s(N,{title:u(t)("Mark as spam"),onClick:G},null,8,["title"]),s(N,{title:u(t)("Mark as non-spam"),onClick:Q},null,8,["title"])]),_:1})]),_:1})]),_:1})):M("",!0)],64)),s(k,{class:"ml-2",variant:"tonal",size:"small",loading:i.value,onClick:T},{default:n(()=>[m.value?(r(),f("span",ue,_(u(t)("Hide full headers")),1)):(r(),f("span",oe,_(u(t)("View full headers")),1))]),_:1},8,["loading"])]),_:1}),c.value.qtype?(r(),y(Z,{key:0,title:c.value.qtype,text:c.value.qreason,type:"error",variant:"tonal",class:"mb-4",density:"compact"},null,8,["title","text"])):M("",!0),b("div",me,[(r(!0),f(R,null,B(U.value,l=>(r(),y(se,{key:l.name,"no-gutters":""},{default:n(()=>[s(z,{cols:"2",class:"font-weight-bold"},{default:n(()=>[H(_(l.name),1)]),_:2},1024),s(z,{cols:"10"},{default:n(()=>[H(_(l.value),1)]),_:2},1024)]),_:2},1024))),128))]),b("div",{class:"mt-4",innerHTML:c.value.body},null,8,ce)]),s(u(X),{ref_key:"learningRecipientRef",ref:L},{default:n(()=>[s(le,{modelValue:v.value,"onUpdate:modelValue":g[0]||(g[0]=l=>v.value=l),class:"mt-4","hide-details":""},{default:n(()=>[(r(!0),f(R,null,B(a.learningRecipients,l=>(r(),y(ie,{key:l.value,value:l.value,label:l.title},null,8,["value","label"]))),128))]),_:1},8,["modelValue"])]),_:1},512)]))}};export{Ee as default};
