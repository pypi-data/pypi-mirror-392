"""Manifest - CLI Commands (SAP-043)

Command implementations for CLI interface. Each command translates
CLI arguments to capability registry service calls and formats output.

Generated by: chora-base SAP-047 (Capability Server Template)
Customized for: Capability Registry (chora-manifest)
"""

import asyncio
from typing import Optional

import click

from manifest.core import (
    Category,
    ManifestError,
    ManifestNotFoundError,
    Maturity,
)
from .formatters import (
    OutputFormat,
    print_entity,
    print_entity_list,
    print_error,
    print_output,
    print_success,
)


# ============================================================================
# Helper: Async Command Wrapper
# ============================================================================


def async_command(f):
    """Decorator to run async commands in event loop."""
    def wrapper(*args, **kwargs):
        return asyncio.run(f(*args, **kwargs))
    return wrapper


# ============================================================================
# List Command
# ============================================================================


@click.command(name="list")
@click.option(
    "--category", "-c",
    type=click.Choice([c.value for c in Category], case_sensitive=False),
    help="Filter by category"
)
@click.option(
    "--maturity", "-m",
    type=click.Choice([m.value for m in Maturity], case_sensitive=False),
    help="Filter by maturity level"
)
@click.option(
    "--tags", "-t",
    multiple=True,
    help="Filter by tags (capability must have ALL specified tags)"
)
@click.pass_context
@async_command
async def list_command(
    ctx: click.Context,
    category: Optional[str],
    maturity: Optional[str],
    tags: tuple
):
    """List capabilities with optional filtering.

    Examples:
        manifest list
        manifest list --category integration
        manifest list --maturity stable
        manifest list --tags git --tags vcs
    """
    format = ctx.obj["format"]
    service = ctx.obj["service"]

    try:
        # Call service
        capabilities = await service.list_capabilities(
            category=Category(category) if category else None,
            maturity=Maturity(maturity) if maturity else None,
            tags=list(tags) if tags else None
        )

        # Output result
        if format == OutputFormat.TABLE:
            if len(capabilities) == 0:
                click.echo("No capabilities found.")
            else:
                click.echo(f"Found {len(capabilities)} capabilities\n")

                # Show table
                caps_dict = [cap.model_dump() for cap in capabilities]
                columns = ["id", "name", "category", "maturity", "version"]
                print_entity_list(caps_dict, format, columns)
        else:
            output = {
                "capabilities": [cap.model_dump() for cap in capabilities],
                "total": len(capabilities)
            }
            print_output(output, format)

    except ManifestError as e:
        print_error(f"Error: {e.message}", format)
        ctx.exit(1)
    except Exception as e:
        print_error(f"Unexpected error: {str(e)}", format)
        ctx.exit(1)


# ============================================================================
# Get Command
# ============================================================================


@click.command(name="get")
@click.argument("capability_id")
@click.pass_context
@async_command
async def get_command(ctx: click.Context, capability_id: str):
    """Get a capability by ID.

    Examples:
        manifest get github
        manifest get slack
    """
    format = ctx.obj["format"]
    service = ctx.obj["service"]

    try:
        # Call service
        capability = await service.get_capability(capability_id)

        if capability is None:
            print_error(f"Capability '{capability_id}' not found", format)
            ctx.exit(1)

        # Output result
        print_entity(capability.model_dump(), format)

    except ManifestError as e:
        print_error(f"Error: {e.message}", format)
        ctx.exit(1)
    except Exception as e:
        print_error(f"Unexpected error: {str(e)}", format)
        ctx.exit(1)


# ============================================================================
# Search Command
# ============================================================================


@click.command(name="search")
@click.argument("query")
@click.pass_context
@async_command
async def search_command(ctx: click.Context, query: str):
    """Search capabilities by name, description, or tags.

    The search is case-insensitive and matches across name, description, and tags.

    Examples:
        manifest search github
        manifest search "database"
        manifest search integration
    """
    format = ctx.obj["format"]
    service = ctx.obj["service"]

    try:
        # Call service
        capabilities = await service.search(query)

        # Output result
        if format == OutputFormat.TABLE:
            if len(capabilities) == 0:
                click.echo(f"No capabilities found matching '{query}'")
            else:
                click.echo(f"Found {len(capabilities)} capabilities matching '{query}'\n")

                # Show table
                caps_dict = [cap.model_dump() for cap in capabilities]
                columns = ["id", "name", "category", "maturity"]
                print_entity_list(caps_dict, format, columns)
        else:
            output = {
                "query": query,
                "capabilities": [cap.model_dump() for cap in capabilities],
                "total": len(capabilities)
            }
            print_output(output, format)

    except ManifestError as e:
        print_error(f"Error: {e.message}", format)
        ctx.exit(1)
    except Exception as e:
        print_error(f"Unexpected error: {str(e)}", format)
        ctx.exit(1)


# ============================================================================
# Count Command
# ============================================================================


@click.command(name="count")
@click.option(
    "--category", "-c",
    type=click.Choice([c.value for c in Category], case_sensitive=False),
    help="Filter by category"
)
@click.option(
    "--maturity", "-m",
    type=click.Choice([m.value for m in Maturity], case_sensitive=False),
    help="Filter by maturity level"
)
@click.pass_context
@async_command
async def count_command(
    ctx: click.Context,
    category: Optional[str],
    maturity: Optional[str]
):
    """Count capabilities with optional filtering.

    Examples:
        manifest count
        manifest count --category integration
        manifest count --maturity stable
    """
    format = ctx.obj["format"]
    service = ctx.obj["service"]

    try:
        # Call service
        count = await service.count_capabilities(
            category=Category(category) if category else None,
            maturity=Maturity(maturity) if maturity else None
        )

        # Output result
        if format == OutputFormat.TABLE:
            filters = []
            if category:
                filters.append(f"category={category}")
            if maturity:
                filters.append(f"maturity={maturity}")

            filter_str = f" ({', '.join(filters)})" if filters else ""
            click.echo(f"Total capabilities{filter_str}: {count}")
        else:
            output = {
                "count": count,
                "filters": {
                    "category": category,
                    "maturity": maturity
                }
            }
            print_output(output, format)

    except ManifestError as e:
        print_error(f"Error: {e.message}", format)
        ctx.exit(1)
    except Exception as e:
        print_error(f"Unexpected error: {str(e)}", format)
        ctx.exit(1)


# ============================================================================
# Categories Command
# ============================================================================


@click.command(name="categories")
@click.pass_context
@async_command
async def categories_command(ctx: click.Context):
    """List all categories present in the manifest.

    Example:
        manifest categories
    """
    format = ctx.obj["format"]
    service = ctx.obj["service"]

    try:
        # Call service
        categories = await service.get_all_categories()

        # Output result
        if format == OutputFormat.TABLE:
            click.echo(f"Categories ({len(categories)} total):")
            for cat in sorted(categories, key=lambda c: c.value):
                click.echo(f"  - {cat.value}")
        else:
            output = {
                "categories": [c.value for c in categories],
                "total": len(categories)
            }
            print_output(output, format)

    except ManifestError as e:
        print_error(f"Error: {e.message}", format)
        ctx.exit(1)
    except Exception as e:
        print_error(f"Unexpected error: {str(e)}", format)
        ctx.exit(1)


# ============================================================================
# Maturities Command
# ============================================================================


@click.command(name="maturities")
@click.pass_context
@async_command
async def maturities_command(ctx: click.Context):
    """List all maturity levels present in the manifest.

    Example:
        manifest maturities
    """
    format = ctx.obj["format"]
    service = ctx.obj["service"]

    try:
        # Call service
        maturities = await service.get_all_maturities()

        # Output result
        if format == OutputFormat.TABLE:
            click.echo(f"Maturity Levels ({len(maturities)} total):")
            # Sort by maturity level order
            maturity_order = ["experimental", "beta", "stable", "deprecated"]
            sorted_maturities = sorted(
                maturities,
                key=lambda m: maturity_order.index(m.value) if m.value in maturity_order else 999
            )
            for mat in sorted_maturities:
                click.echo(f"  - {mat.value}")
        else:
            output = {
                "maturities": [m.value for m in maturities],
                "total": len(maturities)
            }
            print_output(output, format)

    except ManifestError as e:
        print_error(f"Error: {e.message}", format)
        ctx.exit(1)
    except Exception as e:
        print_error(f"Unexpected error: {str(e)}", format)
        ctx.exit(1)


# ============================================================================
# Health Command
# ============================================================================


@click.command(name="health")
@click.pass_context
@async_command
async def health_command(ctx: click.Context):
    """Check service health status.

    Example:
        manifest health
    """
    format = ctx.obj["format"]
    service = ctx.obj["service"]

    try:
        # Call service health check
        health = await service.health_check()

        # Output result
        if format == OutputFormat.TABLE:
            click.echo("Service Health Status:")
            for key, value in health.items():
                formatted_key = key.replace("_", " ").title()
                click.echo(f"  {formatted_key}: {value}")
        else:
            print_output(health, format)

    except ManifestError as e:
        print_error(f"Error: {e.message}", format)
        ctx.exit(1)
    except Exception as e:
        print_error(f"Unexpected error: {str(e)}", format)
        ctx.exit(1)


# ============================================================================
# Command Group Export
# ============================================================================


# Export commands for registration in __init__.py
__all__ = [
    "list_command",
    "get_command",
    "search_command",
    "count_command",
    "categories_command",
    "maturities_command",
    "health_command",
]
