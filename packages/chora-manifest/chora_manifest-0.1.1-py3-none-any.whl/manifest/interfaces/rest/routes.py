"""Manifest - REST API Routes (SAP-043)

API endpoint definitions for capability registry. Routes translate HTTP requests
to core service calls and format responses.

Generated by: chora-base SAP-047 (Capability Server Template)
Customized for: Capability Registry (chora-manifest)
"""

from typing import List, Optional

from fastapi import APIRouter, Depends, Query, status as http_status

from manifest.core import (
    Capability,
    Category,
    ManifestServiceBase,
    Maturity,
    create_manifest_service,
)
from .models import (
    CapabilityListResponse,
    CapabilityResponse,
    CountResponse,
    HealthResponse,
    SearchResponse,
    StringListResponse,
)


# ============================================================================
# Router Setup
# ============================================================================


router = APIRouter(
    prefix="/api/v1",
    tags=["Capability Registry"]
)


# ============================================================================
# Dependencies
# ============================================================================


async def get_service() -> ManifestServiceBase:
    """Get initialized service instance.

    This is a dependency that can be overridden for testing.
    """
    service = create_manifest_service()
    await service.initialize()
    return service


# ============================================================================
# List Capabilities
# ============================================================================


@router.get(
    "/capabilities",
    response_model=CapabilityListResponse,
    summary="List capabilities",
    description="List capability servers with optional filtering by category, maturity, and tags."
)
async def list_capabilities(
    category: Optional[Category] = Query(
        None,
        description="Filter by category (integration, database, monitoring, etc.)"
    ),
    maturity: Optional[Maturity] = Query(
        None,
        description="Filter by maturity level (experimental, beta, stable, deprecated)"
    ),
    tags: Optional[List[str]] = Query(
        None,
        description="Filter by tags (capability must have ALL specified tags)"
    ),
    service: ManifestServiceBase = Depends(get_service)
) -> CapabilityListResponse:
    """List capabilities with optional filtering.

    Args:
        category: Filter by category
        maturity: Filter by maturity level
        tags: Filter by tags
        service: Service dependency

    Returns:
        List of matching capabilities

    Raises:
        500: Internal server error
    """
    capabilities = await service.list_capabilities(
        category=category,
        maturity=maturity,
        tags=tags
    )

    return CapabilityListResponse(
        capabilities=capabilities,
        total=len(capabilities)
    )


# ============================================================================
# Get Capability
# ============================================================================


@router.get(
    "/capabilities/{capability_id}",
    response_model=CapabilityResponse,
    summary="Get capability by ID",
    description="Retrieve a capability server definition by its unique identifier."
)
async def get_capability(
    capability_id: str,
    service: ManifestServiceBase = Depends(get_service)
) -> CapabilityResponse:
    """Get capability by ID.

    Args:
        capability_id: Capability identifier (e.g., "github", "slack")
        service: Service dependency

    Returns:
        Capability definition

    Raises:
        404: Capability not found
        500: Internal server error
    """
    capability = await service.get_capability(capability_id)

    if capability is None:
        from fastapi import HTTPException
        raise HTTPException(
            status_code=http_status.HTTP_404_NOT_FOUND,
            detail=f"Capability '{capability_id}' not found"
        )

    return CapabilityResponse(
        capability=capability
    )


# ============================================================================
# Search Capabilities
# ============================================================================


@router.get(
    "/capabilities/search",
    response_model=SearchResponse,
    summary="Search capabilities",
    description="Search capabilities by name, description, or tags (case-insensitive)."
)
async def search_capabilities(
    query: str = Query(
        ...,
        min_length=1,
        description="Search query string"
    ),
    service: ManifestServiceBase = Depends(get_service)
) -> SearchResponse:
    """Search capabilities.

    Args:
        query: Search query string
        service: Service dependency

    Returns:
        Matching capabilities

    Raises:
        400: Invalid query
        500: Internal server error
    """
    capabilities = await service.search(query)

    return SearchResponse(
        query=query,
        capabilities=capabilities,
        total=len(capabilities)
    )


# ============================================================================
# Count Capabilities
# ============================================================================


@router.get(
    "/capabilities/count",
    response_model=CountResponse,
    summary="Count capabilities",
    description="Count capabilities with optional filtering."
)
async def count_capabilities(
    category: Optional[Category] = Query(
        None,
        description="Filter by category"
    ),
    maturity: Optional[Maturity] = Query(
        None,
        description="Filter by maturity level"
    ),
    service: ManifestServiceBase = Depends(get_service)
) -> CountResponse:
    """Count capabilities with optional filtering.

    Args:
        category: Filter by category
        maturity: Filter by maturity level
        service: Service dependency

    Returns:
        Count of matching capabilities

    Raises:
        500: Internal server error
    """
    count = await service.count_capabilities(
        category=category,
        maturity=maturity
    )

    return CountResponse(
        count=count,
        filters={
            "category": category.value if category else None,
            "maturity": maturity.value if maturity else None
        }
    )


# ============================================================================
# Get All Categories
# ============================================================================


@router.get(
    "/meta/categories",
    response_model=StringListResponse,
    summary="Get all categories",
    description="List all categories present in the capability registry."
)
async def get_categories(
    service: ManifestServiceBase = Depends(get_service)
) -> StringListResponse:
    """Get all categories.

    Args:
        service: Service dependency

    Returns:
        List of unique categories

    Raises:
        500: Internal server error
    """
    categories = await service.get_all_categories()

    return StringListResponse(
        items=[cat.value for cat in categories],
        total=len(categories)
    )


# ============================================================================
# Get All Maturities
# ============================================================================


@router.get(
    "/meta/maturities",
    response_model=StringListResponse,
    summary="Get all maturity levels",
    description="List all maturity levels present in the capability registry."
)
async def get_maturities(
    service: ManifestServiceBase = Depends(get_service)
) -> StringListResponse:
    """Get all maturity levels.

    Args:
        service: Service dependency

    Returns:
        List of unique maturity levels

    Raises:
        500: Internal server error
    """
    maturities = await service.get_all_maturities()

    return StringListResponse(
        items=[mat.value for mat in maturities],
        total=len(maturities)
    )


# ============================================================================
# Health Check
# ============================================================================


@router.get(
    "/health",
    response_model=HealthResponse,
    summary="Service health check",
    description="Check the health status of the capability registry service."
)
async def health_check(
    service: ManifestServiceBase = Depends(get_service)
) -> HealthResponse:
    """Health check endpoint.

    Args:
        service: Service dependency

    Returns:
        Health status information

    Raises:
        500: Internal server error
    """
    health = await service.health_check()

    return HealthResponse(**health)


# ============================================================================
# Export
# ============================================================================


__all__ = ["router"]
