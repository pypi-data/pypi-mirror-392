"""Manifest - Core Exception Hierarchy (SAP-042)

This module defines interface-agnostic exceptions that represent domain
errors. These exceptions can be caught and translated by interface layers
(CLI, REST, MCP) into appropriate error responses for each interface.

Generated by: chora-base SAP-047 (Capability Server Template)
"""

from typing import Any, Dict, Optional


# ============================================================================
# Base Exception
# ============================================================================


class ManifestError(Exception):
    """Base exception for all Manifest errors.

    All domain-specific exceptions inherit from this base class,
    making it easy to catch all Manifest-related errors.

    Attributes:
        message: Human-readable error message
        code: Machine-readable error code
        details: Additional context about the error
    """

    def __init__(
        self,
        message: str,
        code: Optional[str] = None,
        details: Optional[Dict[str, Any]] = None
    ):
        """Initialize exception.

        Args:
            message: Human-readable error message
            code: Optional machine-readable error code
            details: Optional additional context
        """
        self.message = message
        self.code = code or self.__class__.__name__
        self.details = details or {}
        super().__init__(self.message)

    def to_dict(self) -> Dict[str, Any]:
        """Convert exception to dictionary representation.

        Useful for serialization in API responses.

        Returns:
            Dictionary with error details
        """
        return {
            "error": self.code,
            "message": self.message,
            "details": self.details
        }

    def __str__(self) -> str:
        """String representation of the error."""
        if self.details:
            return f"{self.message} (details: {self.details})"
        return self.message


# ============================================================================
# Validation Errors
# ============================================================================


class ManifestValidationError(ManifestError):
    """Raised when input validation fails.

    Used for:
    - Invalid request data
    - Schema validation failures
    - Business rule violations
    - Invalid state transitions
    """

    def __init__(
        self,
        message: str,
        field: Optional[str] = None,
        value: Optional[Any] = None,
        details: Optional[Dict[str, Any]] = None
    ):
        """Initialize validation error.

        Args:
            message: Human-readable error message
            field: Optional field name that failed validation
            value: Optional invalid value
            details: Optional additional context
        """
        details = details or {}
        if field:
            details["field"] = field
        if value is not None:
            details["value"] = value

        super().__init__(
            message=message,
            code="VALIDATION_ERROR",
            details=details
        )


# ============================================================================
# Not Found Errors
# ============================================================================


class ManifestNotFoundError(ManifestError):
    """Raised when a requested entity cannot be found.

    Used for:
    - Entity lookup by ID fails
    - Resource does not exist
    - Query returns no results (when at least one expected)
    """

    def __init__(
        self,
        message: str,
        entity_id: Optional[str] = None,
        entity_type: Optional[str] = None,
        details: Optional[Dict[str, Any]] = None
    ):
        """Initialize not found error.

        Args:
            message: Human-readable error message
            entity_id: Optional ID of entity that wasn't found
            entity_type: Optional type of entity
            details: Optional additional context
        """
        details = details or {}
        if entity_id:
            details["entity_id"] = entity_id
        if entity_type:
            details["entity_type"] = entity_type

        super().__init__(
            message=message,
            code="NOT_FOUND",
            details=details
        )


# ============================================================================
# Conflict Errors
# ============================================================================


class ManifestConflictError(ManifestError):
    """Raised when an operation conflicts with existing state.

    Used for:
    - Duplicate entity creation
    - Concurrent modification conflicts
    - Resource already exists
    """

    def __init__(
        self,
        message: str,
        conflicting_id: Optional[str] = None,
        details: Optional[Dict[str, Any]] = None
    ):
        """Initialize conflict error.

        Args:
            message: Human-readable error message
            conflicting_id: Optional ID of conflicting entity
            details: Optional additional context
        """
        details = details or {}
        if conflicting_id:
            details["conflicting_id"] = conflicting_id

        super().__init__(
            message=message,
            code="CONFLICT",
            details=details
        )


# ============================================================================
# Permission Errors
# ============================================================================


class ManifestPermissionError(ManifestError):
    """Raised when user lacks permission for an operation.

    Used for:
    - Unauthorized access
    - Insufficient permissions
    - Authentication failures
    """

    def __init__(
        self,
        message: str,
        required_permission: Optional[str] = None,
        details: Optional[Dict[str, Any]] = None
    ):
        """Initialize permission error.

        Args:
            message: Human-readable error message
            required_permission: Optional permission that was required
            details: Optional additional context
        """
        details = details or {}
        if required_permission:
            details["required_permission"] = required_permission

        super().__init__(
            message=message,
            code="PERMISSION_DENIED",
            details=details
        )


# ============================================================================
# Service Errors
# ============================================================================


class ManifestServiceError(ManifestError):
    """Raised when a service-level operation fails.

    Used for:
    - Database errors
    - External API failures
    - Internal service errors
    - Unexpected conditions
    """

    def __init__(
        self,
        message: str,
        operation: Optional[str] = None,
        cause: Optional[Exception] = None,
        details: Optional[Dict[str, Any]] = None
    ):
        """Initialize service error.

        Args:
            message: Human-readable error message
            operation: Optional operation that failed
            cause: Optional underlying exception
            details: Optional additional context
        """
        details = details or {}
        if operation:
            details["operation"] = operation
        if cause:
            details["cause"] = str(cause)
            details["cause_type"] = type(cause).__name__

        super().__init__(
            message=message,
            code="SERVICE_ERROR",
            details=details
        )


# ============================================================================
# Rate Limiting Errors
# ============================================================================


class ManifestRateLimitError(ManifestError):
    """Raised when rate limit is exceeded.

    Used for:
    - API rate limiting
    - Request throttling
    - Quota enforcement
    """

    def __init__(
        self,
        message: str,
        limit: Optional[int] = None,
        window_seconds: Optional[int] = None,
        retry_after_seconds: Optional[int] = None,
        details: Optional[Dict[str, Any]] = None
    ):
        """Initialize rate limit error.

        Args:
            message: Human-readable error message
            limit: Optional request limit
            window_seconds: Optional time window in seconds
            retry_after_seconds: Optional seconds until retry allowed
            details: Optional additional context
        """
        details = details or {}
        if limit:
            details["limit"] = limit
        if window_seconds:
            details["window_seconds"] = window_seconds
        if retry_after_seconds:
            details["retry_after_seconds"] = retry_after_seconds

        super().__init__(
            message=message,
            code="RATE_LIMIT_EXCEEDED",
            details=details
        )


# ============================================================================
# Timeout Errors
# ============================================================================


class ManifestTimeoutError(ManifestError):
    """Raised when an operation times out.

    Used for:
    - Long-running operations
    - External API timeouts
    - Database query timeouts
    """

    def __init__(
        self,
        message: str,
        timeout_seconds: Optional[float] = None,
        operation: Optional[str] = None,
        details: Optional[Dict[str, Any]] = None
    ):
        """Initialize timeout error.

        Args:
            message: Human-readable error message
            timeout_seconds: Optional timeout duration
            operation: Optional operation that timed out
            details: Optional additional context
        """
        details = details or {}
        if timeout_seconds:
            details["timeout_seconds"] = timeout_seconds
        if operation:
            details["operation"] = operation

        super().__init__(
            message=message,
            code="TIMEOUT",
            details=details
        )


# ============================================================================
# Configuration Errors
# ============================================================================


class ManifestConfigError(ManifestError):
    """Raised when configuration is invalid or missing.

    Used for:
    - Missing required configuration
    - Invalid configuration values
    - Configuration parsing errors
    """

    def __init__(
        self,
        message: str,
        config_key: Optional[str] = None,
        details: Optional[Dict[str, Any]] = None
    ):
        """Initialize configuration error.

        Args:
            message: Human-readable error message
            config_key: Optional configuration key that's invalid
            details: Optional additional context
        """
        details = details or {}
        if config_key:
            details["config_key"] = config_key

        super().__init__(
            message=message,
            code="CONFIG_ERROR",
            details=details
        )


# ============================================================================
# Helper Functions
# ============================================================================


def is_manifest_error(exc: Exception) -> bool:
    """Check if exception is a Manifest error.

    Args:
        exc: Exception to check

    Returns:
        True if exception is a ManifestError or subclass
    """
    return isinstance(exc, ManifestError)


def get_error_code(exc: Exception) -> str:
    """Get error code from exception.

    Args:
        exc: Exception to extract code from

    Returns:
        Error code string, or "UNKNOWN_ERROR" if not a ManifestError
    """
    if isinstance(exc, ManifestError):
        return exc.code
    return "UNKNOWN_ERROR"


def get_error_details(exc: Exception) -> Dict[str, Any]:
    """Get error details from exception.

    Args:
        exc: Exception to extract details from

    Returns:
        Error details dictionary
    """
    if isinstance(exc, ManifestError):
        return exc.to_dict()
    return {
        "error": type(exc).__name__,
        "message": str(exc),
        "details": {}
    }