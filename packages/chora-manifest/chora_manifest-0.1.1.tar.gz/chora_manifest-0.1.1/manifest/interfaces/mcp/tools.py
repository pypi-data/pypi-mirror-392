"""Manifest - MCP Tools (SAP-043)

MCP tool definitions. Tools are functions that AI assistants can call
to interact with the manifest capability.

Generated by: chora-base SAP-047 (Capability Server Template)
"""

from typing import Any, Dict, List, Optional
from uuid import UUID

from fastmcp import FastMCP

from manifest.core import (
    ManifestError,
    ManifestFilter,
    ManifestRequest,
    ManifestStatus,
    create_manifest_service,
)


# ============================================================================
# Namespace Configuration
# ============================================================================


NAMESPACE = "chora"


def make_tool_name(tool: str) -> str:
    """Create namespaced tool name.

    Args:
        tool: Tool name

    Returns:
        Namespaced tool name (e.g., "namespace:tool")
    """
    return f"{NAMESPACE}:{tool}"


# ============================================================================
# Tool Registration
# ============================================================================


def register_tools(mcp: FastMCP):
    """Register all MCP tools.

    Args:
        mcp: FastMCP server instance
    """

    # ========================================================================
    # Create Entity Tool
    # ========================================================================

    @mcp.tool(name=make_tool_name("create"))
    async def create_entity(
        name: str,
        description: Optional[str] = None,
        metadata: Optional[Dict[str, Any]] = None
    ) -> Dict[str, Any]:
        """Create a new manifest entity.

        Args:
            name: Entity name (required, 1-200 characters)
            description: Optional description (max 2000 characters)
            metadata: Optional metadata as key-value pairs

        Returns:
            Created entity as dictionary

        Raises:
            Error if validation fails or creation fails
        """
        try:
            service = create_manifest_service()

            request = ManifestRequest(
                name=name,
                description=description,
                metadata=metadata or {}
            )

            response = await service.create(request)

            return {
                "success": True,
                "message": response.message,
                "entity": response.entity.to_dict()
            }

        except ManifestError as e:
            return {
                "success": False,
                "error": e.code,
                "message": e.message,
                "details": e.details
            }

    # ========================================================================
    # Get Entity Tool
    # ========================================================================

    @mcp.tool(name=make_tool_name("get"))
    async def get_entity(entity_id: str) -> Dict[str, Any]:
        """Get a manifest entity by ID.

        Args:
            entity_id: Entity UUID

        Returns:
            Entity as dictionary

        Raises:
            Error if entity not found
        """
        try:
            service = create_manifest_service()
            uuid = UUID(entity_id)

            entity = await service.get(uuid)

            return {
                "success": True,
                "entity": entity.to_dict()
            }

        except ValueError:
            return {
                "success": False,
                "error": "INVALID_UUID",
                "message": f"Invalid UUID format: {entity_id}"
            }
        except ManifestError as e:
            return {
                "success": False,
                "error": e.code,
                "message": e.message,
                "details": e.details
            }

    # ========================================================================
    # List Entities Tool
    # ========================================================================

    @mcp.tool(name=make_tool_name("list"))
    async def list_entities(
        status: Optional[str] = None,
        name_contains: Optional[str] = None,
        offset: int = 0,
        limit: int = 100
    ) -> Dict[str, Any]:
        """List manifest entities with optional filtering.

        Args:
            status: Optional status filter (pending, active, completed, failed, cancelled)
            name_contains: Optional name search (case-insensitive)
            offset: Pagination offset (default: 0)
            limit: Maximum results (default: 100, max: 1000)

        Returns:
            List of entities with pagination metadata
        """
        try:
            service = create_manifest_service()

            # Convert status string to enum if provided
            status_enum = None
            if status:
                try:
                    status_enum = ManifestStatus(status.lower())
                except ValueError:
                    return {
                        "success": False,
                        "error": "INVALID_STATUS",
                        "message": f"Invalid status: {status}",
                        "valid_statuses": [s.value for s in ManifestStatus]
                    }

            filters = ManifestFilter(
                status=status_enum,
                name_contains=name_contains,
                offset=offset,
                limit=limit
            )

            response = await service.list(filters)

            return {
                "success": True,
                "entities": [e.to_dict() for e in response.entities],
                "total": response.total,
                "offset": response.offset,
                "limit": response.limit
            }

        except ManifestError as e:
            return {
                "success": False,
                "error": e.code,
                "message": e.message,
                "details": e.details
            }

    # ========================================================================
    # Update Entity Tool
    # ========================================================================

    @mcp.tool(name=make_tool_name("update"))
    async def update_entity(
        entity_id: str,
        name: Optional[str] = None,
        description: Optional[str] = None,
        metadata: Optional[Dict[str, Any]] = None
    ) -> Dict[str, Any]:
        """Update a manifest entity.

        Only provided fields will be updated. Omitted fields remain unchanged.

        Args:
            entity_id: Entity UUID
            name: Optional new name
            description: Optional new description
            metadata: Optional new metadata (replaces existing)

        Returns:
            Updated entity as dictionary

        Raises:
            Error if entity not found or validation fails
        """
        try:
            service = create_manifest_service()
            uuid = UUID(entity_id)

            # Get existing entity
            existing = await service.get(uuid)

            # Merge with existing values
            request = ManifestRequest(
                name=name if name else existing.name,
                description=description if description is not None else existing.description,
                metadata=metadata if metadata is not None else existing.metadata
            )

            response = await service.update(uuid, request)

            return {
                "success": True,
                "message": response.message,
                "entity": response.entity.to_dict()
            }

        except ValueError:
            return {
                "success": False,
                "error": "INVALID_UUID",
                "message": f"Invalid UUID format: {entity_id}"
            }
        except ManifestError as e:
            return {
                "success": False,
                "error": e.code,
                "message": e.message,
                "details": e.details
            }

    # ========================================================================
    # Delete Entity Tool
    # ========================================================================

    @mcp.tool(name=make_tool_name("delete"))
    async def delete_entity(entity_id: str) -> Dict[str, Any]:
        """Delete a manifest entity.

        Args:
            entity_id: Entity UUID

        Returns:
            Success confirmation

        Raises:
            Error if entity not found
        """
        try:
            service = create_manifest_service()
            uuid = UUID(entity_id)

            await service.delete(uuid)

            return {
                "success": True,
                "message": f"Entity {entity_id} deleted successfully"
            }

        except ValueError:
            return {
                "success": False,
                "error": "INVALID_UUID",
                "message": f"Invalid UUID format: {entity_id}"
            }
        except ManifestError as e:
            return {
                "success": False,
                "error": e.code,
                "message": e.message,
                "details": e.details
            }

    # ========================================================================
    # Update Status Tool
    # ========================================================================

    @mcp.tool(name=make_tool_name("update_status"))
    async def update_status(
        entity_id: str,
        new_status: str
    ) -> Dict[str, Any]:
        """Update entity status.

        Args:
            entity_id: Entity UUID
            new_status: New status (pending, active, completed, failed, cancelled)

        Returns:
            Updated entity as dictionary

        Raises:
            Error if entity not found or status transition invalid
        """
        try:
            service = create_manifest_service()
            uuid = UUID(entity_id)

            # Convert status string to enum
            try:
                status_enum = ManifestStatus(new_status.lower())
            except ValueError:
                return {
                    "success": False,
                    "error": "INVALID_STATUS",
                    "message": f"Invalid status: {new_status}",
                    "valid_statuses": [s.value for s in ManifestStatus]
                }

            response = await service.update_status(uuid, status_enum)

            return {
                "success": True,
                "message": response.message,
                "entity": response.entity.to_dict()
            }

        except ValueError:
            return {
                "success": False,
                "error": "INVALID_UUID",
                "message": f"Invalid UUID format: {entity_id}"
            }
        except ManifestError as e:
            return {
                "success": False,
                "error": e.code,
                "message": e.message,
                "details": e.details
            }

    # ========================================================================
    # Health Check Tool
    # ========================================================================

    @mcp.tool(name=make_tool_name("health"))
    async def health_check() -> Dict[str, Any]:
        """Check service health status.

        Returns:
            Health status information
        """
        try:
            service = create_manifest_service()
            health = await service.health_check()

            return {
                "success": True,
                "health": health
            }

        except ManifestError as e:
            return {
                "success": False,
                "error": e.code,
                "message": e.message,
                "details": e.details
            }