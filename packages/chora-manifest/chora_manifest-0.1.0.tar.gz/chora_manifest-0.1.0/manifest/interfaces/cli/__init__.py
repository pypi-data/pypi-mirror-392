"""Manifest - CLI Interface (SAP-043)

Command-line interface using Click framework. Translates CLI commands
to core service calls and formats output for terminal display.

Generated by: chora-base SAP-047 (Capability Server Template)
Customized for: Capability Registry (chora-manifest)
"""

import asyncio
from typing import Optional

import click

from manifest.core import create_manifest_service
from .formatters import OutputFormat


# ============================================================================
# CLI Application Setup
# ============================================================================


@click.group()
@click.version_option(version="1.0.0", prog_name="manifest")
@click.option(
    "--format",
    type=click.Choice(["json", "table", "yaml"], case_sensitive=False),
    default="table",
    help="Output format for results"
)
@click.option(
    "--registry",
    type=click.Path(exists=True),
    default=None,
    help="Path to registry.yaml file (default: package registry)"
)
@click.pass_context
def cli(ctx: click.Context, format: str, registry: Optional[str]):
    """chora-manifest - Capability Registry CLI

    Query and search capability server definitions from the chora ecosystem.

    Examples:
        manifest list --category integration
        manifest get github
        manifest search "database"
    """
    # Store format in context for commands to access
    ctx.ensure_object(dict)
    ctx.obj["format"] = OutputFormat(format.lower())

    # Create and initialize service instance
    service = create_manifest_service(registry_path=registry)

    # Initialize service synchronously (load registry YAML)
    asyncio.run(service.initialize())

    ctx.obj["service"] = service


# Import and register command groups
from .commands import (
    categories_command,
    count_command,
    get_command,
    health_command,
    list_command,
    maturities_command,
    search_command,
)

cli.add_command(list_command)
cli.add_command(get_command)
cli.add_command(search_command)
cli.add_command(count_command)
cli.add_command(categories_command)
cli.add_command(maturities_command)
cli.add_command(health_command)


# ============================================================================
# Entry Point
# ============================================================================


def main():
    """Main entry point for CLI."""
    cli()


if __name__ == "__main__":
    main()
