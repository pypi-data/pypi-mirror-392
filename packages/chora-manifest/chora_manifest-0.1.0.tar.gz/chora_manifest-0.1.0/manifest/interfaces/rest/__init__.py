"""Manifest - REST API Interface (SAP-043)

FastAPI-based REST API interface. Translates HTTP requests to core
service calls and returns JSON responses.

Generated by: chora-base SAP-047 (Capability Server Template)
"""

from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

from manifest.core import create_manifest_service
from .middleware import error_handler_middleware
from .routes import router


# ============================================================================
# FastAPI Application Setup
# ============================================================================


def create_app() -> FastAPI:
    """Create and configure FastAPI application.

    Returns:
        Configured FastAPI app
    """
    app = FastAPI(
        title="Manifest API",
        description="CLI + REST only, no optional features",
        version="{{ version }}",
        docs_url="/docs",
        redoc_url="/redoc",
        openapi_url="/openapi.json",
    )

    # Configure CORS
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],  # Configure appropriately for production
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )

    # Add error handling middleware
    app.middleware("http")(error_handler_middleware)

    # Register routes
    app.include_router(router, prefix="/api/v1")

    # Health check endpoint
    @app.get("/health")
    async def health_check():
        """Health check endpoint."""
        service = create_manifest_service()
        health = await service.health_check()
        return health

    # Root endpoint
    @app.get("/")
    async def root():
        """Root endpoint with API information."""
        return {
            "name": "Manifest API",
            "version": "{{ version }}",
            "docs": "/docs",
            "health": "/health",
            "api": "/api/v1"
        }

    return app


# ============================================================================
# App Instance
# ============================================================================


app = create_app()


# ============================================================================
# Entry Point for uvicorn
# ============================================================================


if __name__ == "__main__":
    import uvicorn

    uvicorn.run(
        "manifest.interfaces.rest:app",
        host="0.0.0.0",
        port=8000,
        reload=True,
        log_level="info"
    )