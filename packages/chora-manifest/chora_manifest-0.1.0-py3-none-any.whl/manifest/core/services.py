"""Manifest - Core Business Logic Services (SAP-042)

This module contains the capability registry service that loads and queries
capability server definitions from the manifest registry.

Generated by: chora-base SAP-047 (Capability Server Template)
Customized for: Capability Registry (chora-manifest)
"""

from pathlib import Path
from typing import Dict, List, Optional

import yaml

from .exceptions import ManifestError, ManifestNotFoundError
from .models import (
    Capability,
    CapabilityFilter,
    CapabilityTool,
    Category,
    HealthCheck,
    HealthCheckMethod,
    ManifestData,
    Maturity,
    Transport,
)


# ============================================================================
# Abstract Base Service (Following BaseCapability pattern)
# ============================================================================


class ManifestServiceBase:
    """Abstract base class for Manifest registry services.

    Defines the contract for capability registry operations. Implementations
    can load from different sources (YAML file, database, remote API).
    """

    async def initialize(self) -> None:
        """Initialize the service and load capability data.

        Raises:
            ManifestError: If initialization fails
        """
        raise NotImplementedError

    async def shutdown(self) -> None:
        """Cleanup service resources."""
        raise NotImplementedError

    async def health_check(self) -> Dict[str, any]:
        """Check service health.

        Returns:
            Health status information
        """
        raise NotImplementedError

    async def list_capabilities(
        self,
        category: Optional[Category] = None,
        maturity: Optional[Maturity] = None,
        tags: Optional[List[str]] = None,
    ) -> List[Capability]:
        """List capabilities with optional filtering.

        Args:
            category: Filter by category
            maturity: Filter by maturity level
            tags: Filter by tags (capability must have ALL specified tags)

        Returns:
            List of matching capabilities
        """
        raise NotImplementedError

    async def get_capability(self, capability_id: str) -> Optional[Capability]:
        """Get capability by ID.

        Args:
            capability_id: Capability identifier

        Returns:
            Capability if found, None otherwise
        """
        raise NotImplementedError

    async def has_capability(self, capability_id: str) -> bool:
        """Check if capability exists in registry.

        Args:
            capability_id: Capability identifier

        Returns:
            True if capability exists, False otherwise
        """
        raise NotImplementedError

    async def count_capabilities(
        self,
        category: Optional[Category] = None,
        maturity: Optional[Maturity] = None,
    ) -> int:
        """Count capabilities with optional filtering.

        Args:
            category: Filter by category
            maturity: Filter by maturity

        Returns:
            Number of matching capabilities
        """
        raise NotImplementedError

    async def get_all_categories(self) -> List[Category]:
        """Get list of all categories present in the manifest.

        Returns:
            List of unique categories
        """
        raise NotImplementedError

    async def get_all_maturities(self) -> List[Maturity]:
        """Get list of all maturity levels present in the manifest.

        Returns:
            List of unique maturity levels
        """
        raise NotImplementedError

    async def search(self, query: str) -> List[Capability]:
        """Search capabilities by name, description, or tags.

        Args:
            query: Search query string (case-insensitive)

        Returns:
            List of matching capabilities
        """
        raise NotImplementedError


# ============================================================================
# YAML-Based Service Implementation
# ============================================================================


class ManifestService(ManifestServiceBase):
    """YAML-based implementation of Manifest registry service.

    Loads capability definitions from a YAML file (registry.yaml) and
    provides query and search operations. This is the async version of
    the original Manifest class, following SAP-047 patterns.
    """

    def __init__(self, registry_path: Optional[Path | str] = None):
        """Initialize service with registry path.

        Args:
            registry_path: Path to registry.yaml file. If None, uses
                          default registry.yaml in package directory.
        """
        self.registry_path = registry_path
        self.data: Optional[ManifestData] = None
        self._capabilities_by_id: Dict[str, Capability] = {}
        self._initialized = False

    def _convert_servers_to_capabilities(self, servers: List[Dict]) -> List[Capability]:
        """Convert ecosystem-manifest servers format to capabilities format.

        Args:
            servers: List of server entries from ecosystem-manifest

        Returns:
            List of Capability objects
        """
        capabilities = []
        for server_entry in servers:
            server_info = server_entry.get("server", {})
            health_config = server_entry.get("health", {})
            tools_list = server_entry.get("tools", [])

            # Create capability from server entry
            capability = Capability(
                id=server_info.get("name", "unknown"),
                name=server_info.get("name", "Unknown").replace("-", " ").title(),
                description=server_info.get("description", ""),
                version=server_info.get("version", "0.0.0"),
                docker_image=server_info.get("docker_image", f"{server_info.get('name')}:latest"),
                transport=Transport(server_info.get("transport", "stdio")),
                default_namespace=server_info.get("name", "unknown"),
                category=Category.INTEGRATION,  # Default category
                maturity=Maturity.BETA,  # Default maturity
                health_check=HealthCheck(
                    method=HealthCheckMethod.HTTP,
                    endpoint=health_config.get("endpoint", "/health"),
                    interval=health_config.get("interval", 30),
                    timeout=health_config.get("timeout", 10),
                    retries=3
                ),
                tools=[
                    CapabilityTool(
                        name=tool.get("name", ""),
                        description=tool.get("description", ""),
                        parameters=tool.get("input_schema")
                    )
                    for tool in tools_list
                ],
                source_url=server_info.get("repository"),
            )
            capabilities.append(capability)
        return capabilities

    async def initialize(self) -> None:
        """Load manifest from YAML file.

        Raises:
            FileNotFoundError: If manifest file doesn't exist
            yaml.YAMLError: If YAML is invalid
            pydantic.ValidationError: If manifest structure is invalid
            ManifestError: If initialization fails
        """
        if self._initialized:
            return

        try:
            # Determine registry path
            if self.registry_path is None:
                # Default to ecosystem-manifest/registry.yaml (workspace root)
                package_dir = Path(__file__).parent.parent.parent
                workspace_root = package_dir.parent.parent
                path = workspace_root / "ecosystem-manifest" / "registry.yaml"
            else:
                path = Path(self.registry_path)

            if not path.exists():
                raise FileNotFoundError(f"Manifest file not found: {path}")

            # Load YAML
            with open(path, "r", encoding="utf-8") as f:
                raw_data = yaml.safe_load(f)

            # Handle ecosystem-manifest format (servers: [...])
            if "servers" in raw_data:
                # Convert ecosystem-manifest schema to capabilities schema
                capabilities = self._convert_servers_to_capabilities(raw_data["servers"])
                self.data = ManifestData(capabilities=capabilities)
            # Handle chora-manifest format (capabilities: [...])
            elif "capabilities" in raw_data and "metadata" not in raw_data:
                # Flat structure - wrap in metadata
                self.data = ManifestData(capabilities=raw_data["capabilities"])
            else:
                self.data = ManifestData(**raw_data)

            # Build index for fast lookups
            self._capabilities_by_id = {cap.id: cap for cap in self.data.capabilities}

            self._initialized = True

        except FileNotFoundError:
            raise
        except Exception as e:
            raise ManifestError(
                f"Failed to initialize manifest service: {str(e)}"
            ) from e

    async def shutdown(self) -> None:
        """Cleanup service resources."""
        self.data = None
        self._capabilities_by_id = {}
        self._initialized = False

    async def health_check(self) -> Dict[str, any]:
        """Check service health.

        Returns:
            Health status information including:
            - status: "healthy" or "not_initialized"
            - capabilities_loaded: Number of capabilities in registry
            - registry_path: Path to registry file
        """
        if not self._initialized:
            return {
                "status": "not_initialized",
                "capabilities_loaded": 0,
            }

        return {
            "status": "healthy",
            "capabilities_loaded": len(self._capabilities_by_id),
            "registry_path": str(self.registry_path) if self.registry_path else "default",
        }

    async def list_capabilities(
        self,
        category: Optional[Category] = None,
        maturity: Optional[Maturity] = None,
        tags: Optional[List[str]] = None,
    ) -> List[Capability]:
        """List capabilities with optional filtering.

        Args:
            category: Filter by category
            maturity: Filter by maturity level
            tags: Filter by tags (capability must have ALL specified tags)

        Returns:
            List of matching capabilities

        Raises:
            ManifestError: If service not initialized
        """
        if not self._initialized or self.data is None:
            raise ManifestError("Service not initialized. Call initialize() first.")

        capabilities = self.data.capabilities

        if category is not None:
            capabilities = [cap for cap in capabilities if cap.category == category]

        if maturity is not None:
            capabilities = [cap for cap in capabilities if cap.maturity == maturity]

        if tags is not None:
            capabilities = [
                cap for cap in capabilities if all(tag in cap.tags for tag in tags)
            ]

        return capabilities

    async def get_capability(self, capability_id: str) -> Optional[Capability]:
        """Get capability by ID.

        Args:
            capability_id: Capability identifier (e.g., "github")

        Returns:
            Capability if found, None otherwise

        Raises:
            ManifestError: If service not initialized
        """
        if not self._initialized:
            raise ManifestError("Service not initialized. Call initialize() first.")

        return self._capabilities_by_id.get(capability_id)

    async def has_capability(self, capability_id: str) -> bool:
        """Check if capability exists in registry.

        Args:
            capability_id: Capability identifier

        Returns:
            True if capability exists, False otherwise

        Raises:
            ManifestError: If service not initialized
        """
        if not self._initialized:
            raise ManifestError("Service not initialized. Call initialize() first.")

        return capability_id in self._capabilities_by_id

    async def count_capabilities(
        self,
        category: Optional[Category] = None,
        maturity: Optional[Maturity] = None,
    ) -> int:
        """Count capabilities with optional filtering.

        Args:
            category: Filter by category
            maturity: Filter by maturity

        Returns:
            Number of matching capabilities

        Raises:
            ManifestError: If service not initialized
        """
        capabilities = await self.list_capabilities(category=category, maturity=maturity)
        return len(capabilities)

    async def get_all_categories(self) -> List[Category]:
        """Get list of all categories present in the manifest.

        Returns:
            List of unique categories

        Raises:
            ManifestError: If service not initialized
        """
        if not self._initialized or self.data is None:
            raise ManifestError("Service not initialized. Call initialize() first.")

        return list(set(cap.category for cap in self.data.capabilities))

    async def get_all_maturities(self) -> List[Maturity]:
        """Get list of all maturity levels present in the manifest.

        Returns:
            List of unique maturity levels

        Raises:
            ManifestError: If service not initialized
        """
        if not self._initialized or self.data is None:
            raise ManifestError("Service not initialized. Call initialize() first.")

        return list(set(cap.maturity for cap in self.data.capabilities))

    async def search(self, query: str) -> List[Capability]:
        """Search capabilities by name, description, or tags.

        Args:
            query: Search query string (case-insensitive)

        Returns:
            List of matching capabilities

        Raises:
            ManifestError: If service not initialized
        """
        if not self._initialized or self.data is None:
            raise ManifestError("Service not initialized. Call initialize() first.")

        query_lower = query.lower()
        results = []

        for cap in self.data.capabilities:
            # Search in name
            if query_lower in cap.name.lower():
                results.append(cap)
                continue

            # Search in description
            if query_lower in cap.description.lower():
                results.append(cap)
                continue

            # Search in tags
            if any(query_lower in tag.lower() for tag in cap.tags):
                results.append(cap)
                continue

        return results


# ============================================================================
# Service Factory (Dependency Injection)
# ============================================================================


def create_manifest_service(
    registry_path: Optional[Path | str] = None
) -> ManifestServiceBase:
    """Create and configure a Manifest service instance.

    This factory function enables dependency injection and makes it easy
    to swap implementations (e.g., YAML for production, mock for testing).

    Args:
        registry_path: Optional path to registry.yaml file

    Returns:
        Configured service instance
    """
    return ManifestService(registry_path=registry_path)
