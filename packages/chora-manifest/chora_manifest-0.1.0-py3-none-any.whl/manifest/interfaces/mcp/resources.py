"""Manifest - MCP Resources (SAP-043)

MCP resource definitions. Resources are URI-addressable content that
AI assistants can read to get information about the capability.

Generated by: chora-base SAP-047 (Capability Server Template)
"""

from fastmcp import FastMCP


# ============================================================================
# Namespace Configuration
# ============================================================================


NAMESPACE = "chora"


def make_resource_uri(resource_type: str, resource_id: str) -> str:
    """Create namespaced resource URI.

    Args:
        resource_type: Resource type (e.g., "docs", "templates")
        resource_id: Resource identifier

    Returns:
        Namespaced URI (e.g., "namespace://docs/getting-started")
    """
    return f"{NAMESPACE}://{resource_type}/{resource_id}"


# ============================================================================
# Resource Registration
# ============================================================================


def register_resources(mcp: FastMCP):
    """Register all MCP resources.

    Args:
        mcp: FastMCP server instance
    """

    # ========================================================================
    # Documentation Resources
    # ========================================================================

    @mcp.resource(uri=make_resource_uri("docs", "readme"))
    def get_readme() -> str:
        """Get README documentation.

        Returns:
            README content as markdown
        """
        return """# Manifest

CLI + REST only, no optional features

## Overview

This is a production-ready capability server with multi-interface support:

- **CLI**: Command-line interface using Click
- **REST API**: FastAPI-based HTTP API
- **MCP**: Model Context Protocol for AI assistants

## Getting Started

### CLI Usage

```bash
# Create entity
manifest create "My Entity" -d "Description"

# List entities
manifest list

# Get entity
manifest get <entity-id>

# Update entity
manifest update <entity-id> --name "New Name"

# Update status
manifest status <entity-id> active

# Delete entity
manifest delete <entity-id>
```

### REST API Usage

Start the server:

```bash
uvicorn manifest.interfaces.rest:app --reload
```

Visit http://localhost:8000/docs for interactive API documentation.

### MCP Usage

Configure in Claude Desktop's `claude_desktop_config.json`:

```json
{
  "mcpServers": {
    "chora": {
      "command": "python",
      "args": ["-m", "manifest.interfaces.mcp"],
      "cwd": "/path/to/manifest"
    }
  }
}
```

## Features

- **Core/Interface Separation**: Business logic independent of interface
- **Type Safety**: Full Pydantic validation
- **Error Handling**: Rich exception hierarchy
- **Testing**: Comprehensive test suite (85%+ coverage)
- **Documentation**: Auto-generated API docs

## Architecture

Based on chora-base SAP-047 (Capability Server Template):

- **SAP-042**: Core/interface separation pattern
- **SAP-043**: Multi-interface patterns
- **SAP-044**: Service registry integration (optional)
- **SAP-045**: Bootstrap startup sequence (optional)
- **SAP-046**: Composition patterns (optional)

## Status Values

- `pending`: Initial state
- `active`: Currently active/in-progress
- `completed`: Successfully completed
- `failed`: Failed to complete
- `cancelled`: Manually cancelled

## Entity Fields

- `id`: Unique UUID identifier
- `name`: Entity name (required, 1-200 characters)
- `description`: Optional description (max 2000 characters)
- `status`: Current status (see above)
- `metadata`: Arbitrary key-value pairs
- `created_at`: Creation timestamp
- `updated_at`: Last update timestamp

## License

See LICENSE file for details.
"""

    @mcp.resource(uri=make_resource_uri("docs", "api-reference"))
    def get_api_reference() -> str:
        """Get API reference documentation.

        Returns:
            API reference as markdown
        """
        return """# API Reference

## MCP Tools

### chora:create

Create a new entity.

**Parameters**:
- `name` (string, required): Entity name (1-200 characters)
- `description` (string, optional): Description (max 2000 characters)
- `metadata` (object, optional): Key-value metadata pairs

**Returns**: Created entity object

**Example**:
```json
{
  "name": "My Task",
  "description": "Important task to complete",
  "metadata": {"priority": "high"}
}
```

---

### chora:get

Get entity by ID.

**Parameters**:
- `entity_id` (string, required): Entity UUID

**Returns**: Entity object

**Example**:
```json
{
  "entity_id": "123e4567-e89b-12d3-a456-426614174000"
}
```

---

### chora:list

List entities with optional filtering.

**Parameters**:
- `status` (string, optional): Filter by status
- `name_contains` (string, optional): Search by name
- `offset` (integer, optional): Pagination offset (default: 0)
- `limit` (integer, optional): Max results (default: 100)

**Returns**: List of entities with pagination metadata

**Example**:
```json
{
  "status": "active",
  "name_contains": "important",
  "limit": 10
}
```

---

### chora:update

Update existing entity.

**Parameters**:
- `entity_id` (string, required): Entity UUID
- `name` (string, optional): New name
- `description` (string, optional): New description
- `metadata` (object, optional): New metadata (replaces existing)

**Returns**: Updated entity object

**Example**:
```json
{
  "entity_id": "123e4567-e89b-12d3-a456-426614174000",
  "name": "Updated Name",
  "metadata": {"priority": "low"}
}
```

---

### chora:delete

Delete entity.

**Parameters**:
- `entity_id` (string, required): Entity UUID

**Returns**: Success confirmation

**Example**:
```json
{
  "entity_id": "123e4567-e89b-12d3-a456-426614174000"
}
```

---

### chora:update_status

Update entity status.

**Parameters**:
- `entity_id` (string, required): Entity UUID
- `new_status` (string, required): New status value

**Returns**: Updated entity object

**Valid statuses**: pending, active, completed, failed, cancelled

**Example**:
```json
{
  "entity_id": "123e4567-e89b-12d3-a456-426614174000",
  "new_status": "completed"
}
```

---

### chora:health

Check service health.

**Parameters**: None

**Returns**: Health status information

**Example**:
```json
{}
```

## REST API Endpoints

See interactive documentation at `/docs` when running the server.

## CLI Commands

Run `manifest --help` for complete CLI reference.
"""

    @mcp.resource(uri=make_resource_uri("docs", "examples"))
    def get_examples() -> str:
        """Get usage examples.

        Returns:
            Examples as markdown
        """
        return """# Usage Examples

## Example 1: Basic CRUD Operations

```python
# Using MCP tools from Claude

# Create an entity
result = await chora:create(
    name="Important Project",
    description="Q1 2025 initiatives",
    metadata={"team": "engineering", "priority": "high"}
)
entity_id = result["entity"]["id"]

# Get the entity
entity = await chora:get(entity_id=entity_id)

# Update the entity
updated = await chora:update(
    entity_id=entity_id,
    description="Updated description",
    metadata={"priority": "medium"}
)

# Update status
status_update = await chora:update_status(
    entity_id=entity_id,
    new_status="active"
)

# Delete the entity
await chora:delete(entity_id=entity_id)
```

## Example 2: List and Filter

```python
# List all active entities
active_entities = await chora:list(status="active")

# Search by name
search_results = await chora:list(
    name_contains="project",
    limit=10
)

# Pagination
page_1 = await chora:list(offset=0, limit=10)
page_2 = await chora:list(offset=10, limit=10)
```

## Example 3: Status Workflow

```python
# Create entity (starts as 'pending')
entity = await chora:create(name="Task")
entity_id = entity["entity"]["id"]

# Activate
await chora:update_status(entity_id, "active")

# Complete
await chora:update_status(entity_id, "completed")

# Invalid transition (completed is terminal)
# This will fail:
# await chora:update_status(entity_id, "active")
```

## Example 4: Error Handling

```python
# Handle not found
result = await chora:get(entity_id="invalid-uuid")
if not result["success"]:
    print(f"Error: {result['message']}")

# Handle validation errors
result = await chora:create(name="")  # Empty name
if not result["success"]:
    print(f"Validation error: {result['message']}")
    print(f"Details: {result['details']}")
```

## Example 5: Bulk Operations

```python
# Create multiple entities
entities = []
for i in range(5):
    result = await chora:create(name=f"Task {i}")
    entities.append(result["entity"])

# List all
all_entities = await chora:list(limit=100)
print(f"Total: {all_entities['total']}")

# Filter and process
active = await chora:list(status="active")
for entity in active["entities"]:
    print(f"Active task: {entity['name']}")
```
"""

    # ========================================================================
    # Template Resources
    # ========================================================================

    @mcp.resource(uri=make_resource_uri("templates", "entity"))
    def get_entity_template() -> str:
        """Get entity template.

        Returns:
            Entity template as JSON
        """
        return """{
  "name": "Entity Name",
  "description": "Optional description of what this entity represents",
  "metadata": {
    "category": "example-category",
    "tags": "comma,separated,tags",
    "priority": "low|medium|high",
    "owner": "team-name",
    "custom_field": "any value"
  }
}"""