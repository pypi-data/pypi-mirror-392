---
check-dockerfile:
  artifacts:
    name: "$CI_JOB_NAME artifacts from $CI_PROJECT_NAME on $CI_COMMIT_REF_SLUG"
    expire_in: 1 day
    when: always
    reports:
      codequality:
        - "reports/*"
    paths:
      - "reports/*"
  image:
    name: hadolint/hadolint:v2.14.0-debian
  stage: setup

  script:
    - ./build_harness/scripts/run-hadolint.sh "${CI_PROJECT_DIR}"


construct-build-image:
  # https://docs.gitlab.com/ee/ci/docker/using_kaniko.html
  # Run this build on Gitlab shared runners since it is IO intensive.
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  parallel:
    matrix:
      - python_version: ["3.10", "3.11", "3.12", "3.13", "3.14"]
  stage: setup
  variables:
    BUILD_IMAGE_PATH: ${CI_REGISTRY_IMAGE}/build-image:${python_version}-${CI_COMMIT_SHORT_SHA}

  script:
    - source ./build_harness/scripts/run-kaniko.sh \
        "${python_version}" \
        "${BUILD_IMAGE_PATH}" \
        "${PROJECT_NAME}" \
        "${CI_PROJECT_DIR}" \
        "${CI_REGISTRY}" \
        "${CI_REGISTRY_USER}" \
        "${CI_REGISTRY_PASSWORD}"
