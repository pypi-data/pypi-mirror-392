{"version":3,"file":"BgYyfsui.js","sources":["../../../../../../../../node_modules/.pnpm/@babylonjs+core@8.36.1/node_modules/@babylonjs/core/Engines/WebGPU/Extensions/engine.multiRender.js"],"sourcesContent":["import { InternalTexture } from \"../../../Materials/Textures/internalTexture.js\";\nimport { Logger } from \"../../../Misc/logger.js\";\n\nimport { WebGPUEngine } from \"../../webgpuEngine.js\";\nWebGPUEngine.prototype.unBindMultiColorAttachmentFramebuffer = function (rtWrapper, disableGenerateMipMaps = false, onBeforeUnbind) {\n    if (onBeforeUnbind) {\n        onBeforeUnbind();\n    }\n    this._endCurrentRenderPass();\n    if (!disableGenerateMipMaps) {\n        this.generateMipMapsMultiFramebuffer(rtWrapper);\n    }\n    this._currentRenderTarget = null;\n    this._mrtAttachments = [];\n    this._cacheRenderPipeline.setMRT([]);\n    this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments);\n};\nWebGPUEngine.prototype.createMultipleRenderTarget = function (size, options, initializeBuffers) {\n    let generateMipMaps = false;\n    let generateDepthBuffer = true;\n    let generateStencilBuffer = false;\n    let generateDepthTexture = false;\n    let depthTextureFormat = 15;\n    let textureCount = 1;\n    let samples = 1;\n    const defaultType = 0;\n    const defaultSamplingMode = 3;\n    const defaultUseSRGBBuffer = false;\n    const defaultFormat = 5;\n    const defaultTarget = 3553;\n    let types = [];\n    let samplingModes = [];\n    let useSRGBBuffers = [];\n    let formats = [];\n    let targets = [];\n    let faceIndex = [];\n    let layerIndex = [];\n    let layers = [];\n    let labels = [];\n    let creationFlags = [];\n    let dontCreateTextures = false;\n    const rtWrapper = this._createHardwareRenderTargetWrapper(true, false, size);\n    if (options !== undefined) {\n        generateMipMaps = options.generateMipMaps ?? false;\n        generateDepthBuffer = options.generateDepthBuffer ?? true;\n        generateStencilBuffer = options.generateStencilBuffer ?? false;\n        generateDepthTexture = options.generateDepthTexture ?? false;\n        textureCount = options.textureCount ?? 1;\n        depthTextureFormat = options.depthTextureFormat ?? 15;\n        types = options.types || types;\n        samplingModes = options.samplingModes || samplingModes;\n        useSRGBBuffers = options.useSRGBBuffers || useSRGBBuffers;\n        formats = options.formats || formats;\n        targets = options.targetTypes || targets;\n        faceIndex = options.faceIndex || faceIndex;\n        layerIndex = options.layerIndex || layerIndex;\n        layers = options.layerCounts || layers;\n        labels = options.labels || labels;\n        creationFlags = options.creationFlags || creationFlags;\n        samples = options.samples ?? samples;\n        dontCreateTextures = options.dontCreateTextures ?? false;\n    }\n    const width = size.width ?? size;\n    const height = size.height ?? size;\n    const textures = [];\n    const attachments = [];\n    const defaultAttachments = [];\n    rtWrapper.label = options?.label ?? \"MultiRenderTargetWrapper\";\n    rtWrapper._generateDepthBuffer = generateDepthBuffer;\n    rtWrapper._generateStencilBuffer = generateStencilBuffer;\n    rtWrapper._attachments = attachments;\n    rtWrapper._defaultAttachments = defaultAttachments;\n    let depthStencilTexture = null;\n    if ((generateDepthBuffer || generateStencilBuffer || generateDepthTexture) && !dontCreateTextures) {\n        if (!generateDepthTexture) {\n            // The caller doesn't want a depth texture, so we are free to use the depth texture format we want.\n            // So, we will align with what the WebGL engine does\n            if (generateDepthBuffer && generateStencilBuffer) {\n                depthTextureFormat = 13;\n            }\n            else if (generateDepthBuffer) {\n                depthTextureFormat = 14;\n            }\n            else {\n                depthTextureFormat = 19;\n            }\n        }\n        depthStencilTexture = rtWrapper.createDepthStencilTexture(0, false, generateStencilBuffer, 1, depthTextureFormat, rtWrapper.label + \"-DepthStencil\");\n    }\n    const mipmapsCreationOnly = options !== undefined && typeof options === \"object\" && options.createMipMaps && !generateMipMaps;\n    for (let i = 0; i < textureCount; i++) {\n        let samplingMode = samplingModes[i] || defaultSamplingMode;\n        let type = types[i] || defaultType;\n        const format = formats[i] || defaultFormat;\n        const useSRGBBuffer = (useSRGBBuffers[i] || defaultUseSRGBBuffer) && this._caps.supportSRGBBuffers;\n        const target = targets[i] || defaultTarget;\n        const layerCount = layers[i] ?? 1;\n        const creationFlag = creationFlags[i];\n        if (type === 1 && !this._caps.textureFloatLinearFiltering) {\n            // if floating point linear (FLOAT) then force to NEAREST_SAMPLINGMODE\n            samplingMode = 1;\n        }\n        else if (type === 2 && !this._caps.textureHalfFloatLinearFiltering) {\n            // if floating point linear (HALF_FLOAT) then force to NEAREST_SAMPLINGMODE\n            samplingMode = 1;\n        }\n        if (type === 1 && !this._caps.textureFloat) {\n            type = 0;\n            Logger.Warn(\"Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type\");\n        }\n        attachments.push(i + 1);\n        defaultAttachments.push(initializeBuffers ? i + 1 : i === 0 ? 1 : 0);\n        if (target === -1 || dontCreateTextures) {\n            continue;\n        }\n        const texture = new InternalTexture(this, 6 /* InternalTextureSource.MultiRenderTarget */);\n        textures[i] = texture;\n        switch (target) {\n            case 34067:\n                texture.isCube = true;\n                break;\n            case 32879:\n                texture.is3D = true;\n                texture.baseDepth = texture.depth = layerCount;\n                break;\n            case 35866:\n                texture.is2DArray = true;\n                texture.baseDepth = texture.depth = layerCount;\n                break;\n        }\n        texture.baseWidth = width;\n        texture.baseHeight = height;\n        texture.width = width;\n        texture.height = height;\n        texture.isReady = true;\n        texture.samples = 1;\n        texture.generateMipMaps = generateMipMaps;\n        texture.samplingMode = samplingMode;\n        texture.type = type;\n        texture._cachedWrapU = 0;\n        texture._cachedWrapV = 0;\n        texture._useSRGBBuffer = useSRGBBuffer;\n        texture.format = format;\n        texture.label = labels[i] ?? rtWrapper.label + \"-Texture\" + i;\n        this._internalTexturesCache.push(texture);\n        if (mipmapsCreationOnly) {\n            // createGPUTextureForInternalTexture will only create a texture with mipmaps if generateMipMaps is true, as InternalTexture has no createMipMaps property, separate from generateMipMaps.\n            texture.generateMipMaps = true;\n        }\n        this._textureHelper.createGPUTextureForInternalTexture(texture, undefined, undefined, undefined, creationFlag, true);\n        if (mipmapsCreationOnly) {\n            texture.generateMipMaps = false;\n        }\n    }\n    if (depthStencilTexture) {\n        depthStencilTexture.incrementReferences();\n        textures[textureCount] = depthStencilTexture;\n        this._internalTexturesCache.push(depthStencilTexture);\n    }\n    rtWrapper.setTextures(textures);\n    rtWrapper.setLayerAndFaceIndices(layerIndex, faceIndex);\n    if (!dontCreateTextures) {\n        this.updateMultipleRenderTargetTextureSampleCount(rtWrapper, samples);\n    }\n    else {\n        rtWrapper._samples = samples;\n    }\n    return rtWrapper;\n};\nWebGPUEngine.prototype.updateMultipleRenderTargetTextureSampleCount = function (rtWrapper, samples) {\n    if (!rtWrapper || !rtWrapper.textures || rtWrapper.textures.length === 0 || rtWrapper.textures[0].samples === samples) {\n        return samples;\n    }\n    const count = rtWrapper.textures.length;\n    if (count === 0) {\n        return 1;\n    }\n    samples = Math.min(samples, this.getCaps().maxMSAASamples);\n    for (let i = 0; i < count; ++i) {\n        const texture = rtWrapper.textures[i];\n        const gpuTextureWrapper = texture._hardwareTexture;\n        gpuTextureWrapper?.releaseMSAATexture(rtWrapper.getBaseArrayLayer(i));\n    }\n    // Note that rtWrapper.textures can't have null textures, lastTextureIsDepthTexture can't be true if rtWrapper._depthStencilTexture is null\n    const lastTextureIsDepthTexture = rtWrapper._depthStencilTexture === rtWrapper.textures[count - 1];\n    for (let i = 0; i < count; ++i) {\n        const texture = rtWrapper.textures[i];\n        this._textureHelper.createMSAATexture(texture, samples, false, rtWrapper.getBaseArrayLayer(i));\n        texture.samples = samples;\n    }\n    // Note that the last texture of textures is the depth texture if the depth texture has been generated by the MRT class and so the MSAA texture\n    // will be recreated for this texture by the loop above: in that case, there's no need to create the MSAA texture for rtWrapper._depthStencilTexture\n    // because rtWrapper._depthStencilTexture is the same texture than the depth texture\n    if (rtWrapper._depthStencilTexture && !lastTextureIsDepthTexture) {\n        this._textureHelper.createMSAATexture(rtWrapper._depthStencilTexture, samples);\n        rtWrapper._depthStencilTexture.samples = samples;\n    }\n    rtWrapper._samples = samples;\n    return samples;\n};\nWebGPUEngine.prototype.generateMipMapsMultiFramebuffer = function (texture) {\n    const rtWrapper = texture;\n    if (!rtWrapper.isMulti) {\n        return;\n    }\n    const attachments = rtWrapper._attachments;\n    const count = attachments.length;\n    for (let i = 0; i < count; i++) {\n        const texture = rtWrapper.textures[i];\n        if (texture.generateMipMaps && !texture.isCube && !texture.is3D) {\n            this._generateMipmaps(texture);\n        }\n    }\n};\nWebGPUEngine.prototype.resolveMultiFramebuffer = function (_texture) {\n    throw new Error(\"resolveMultiFramebuffer is not yet implemented in WebGPU!\");\n};\nWebGPUEngine.prototype.bindAttachments = function (attachments) {\n    if (attachments.length === 0 || !this._currentRenderTarget) {\n        return;\n    }\n    this._mrtAttachments = attachments;\n    if (this._currentRenderPass) {\n        // the render pass has already been created, we need to call setMRTAttachments to update the state of the attachments\n        this._cacheRenderPipeline.setMRTAttachments(attachments);\n    }\n    else {\n        // the render pass is not created yet so we don't need to call setMRTAttachments: it will be called as part of the render pass creation (see WebGPUEngine._startRenderTargetRenderPass)\n    }\n};\nWebGPUEngine.prototype.buildTextureLayout = function (textureStatus, backBufferLayout = false) {\n    const result = [];\n    if (backBufferLayout) {\n        result.push(1);\n    }\n    else {\n        for (let i = 0; i < textureStatus.length; i++) {\n            if (textureStatus[i]) {\n                result.push(i + 1);\n            }\n            else {\n                result.push(0);\n            }\n        }\n    }\n    return result;\n};\nWebGPUEngine.prototype.restoreSingleAttachment = function () {\n    // not sure what to do, probably nothing... This function and restoreSingleAttachmentForRenderTarget are not called in Babylon.js so it's hard to know the use case\n};\nWebGPUEngine.prototype.restoreSingleAttachmentForRenderTarget = function () {\n    // not sure what to do, probably nothing... This function and restoreSingleAttachment are not called in Babylon.js so it's hard to know the use case\n};\n//# sourceMappingURL=engine.multiRender.js.map"],"names":["texture"],"mappings":"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","x_google_ignoreList":[0]}