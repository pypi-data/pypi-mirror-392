{"version":3,"file":"CsKhvapf.js","sources":["../../../../../../../../node_modules/.pnpm/@babylonjs+core@8.36.1/node_modules/@babylonjs/core/Engines/AbstractEngine/abstractEngine.cubeTexture.js"],"sourcesContent":["import { InternalTexture } from \"../../Materials/Textures/internalTexture.js\";\nimport { Logger } from \"../../Misc/logger.js\";\nimport { LoadImage } from \"../../Misc/fileTools.js\";\nimport { RandomGUID } from \"../../Misc/guid.js\";\nimport { AbstractEngine } from \"../abstractEngine.js\";\nimport { _GetCompatibleTextureLoader } from \"../../Materials/Textures/Loaders/textureLoaderManager.js\";\nimport { GetExtensionFromUrl } from \"../../Misc/urlTools.js\";\nAbstractEngine.prototype._partialLoadFile = function (url, index, loadedFiles, onfinish, onErrorCallBack = null) {\n    const onload = (data) => {\n        loadedFiles[index] = data;\n        loadedFiles._internalCount++;\n        if (loadedFiles._internalCount === 6) {\n            onfinish(loadedFiles);\n        }\n    };\n    const onerror = (request, exception) => {\n        if (onErrorCallBack && request) {\n            onErrorCallBack(request.status + \" \" + request.statusText, exception);\n        }\n    };\n    this._loadFile(url, onload, undefined, undefined, true, onerror);\n};\nAbstractEngine.prototype._cascadeLoadFiles = function (scene, onfinish, files, onError = null) {\n    const loadedFiles = [];\n    loadedFiles._internalCount = 0;\n    for (let index = 0; index < 6; index++) {\n        this._partialLoadFile(files[index], index, loadedFiles, onfinish, onError);\n    }\n};\nAbstractEngine.prototype._cascadeLoadImgs = function (scene, texture, onfinish, files, onError = null, mimeType) {\n    const loadedImages = [];\n    loadedImages._internalCount = 0;\n    for (let index = 0; index < 6; index++) {\n        this._partialLoadImg(files[index], index, loadedImages, scene, texture, onfinish, onError, mimeType);\n    }\n};\nAbstractEngine.prototype._partialLoadImg = function (url, index, loadedImages, scene, texture, onfinish, onErrorCallBack = null, mimeType) {\n    const tokenPendingData = RandomGUID();\n    const onload = (img) => {\n        loadedImages[index] = img;\n        loadedImages._internalCount++;\n        if (scene) {\n            scene.removePendingData(tokenPendingData);\n        }\n        if (loadedImages._internalCount === 6 && onfinish) {\n            onfinish(texture, loadedImages);\n        }\n    };\n    const onerror = (message, exception) => {\n        if (scene) {\n            scene.removePendingData(tokenPendingData);\n        }\n        if (onErrorCallBack) {\n            onErrorCallBack(message, exception);\n        }\n    };\n    LoadImage(url, onload, onerror, scene ? scene.offlineProvider : null, mimeType);\n    if (scene) {\n        scene.addPendingData(tokenPendingData);\n    }\n};\nAbstractEngine.prototype.createCubeTextureBase = function (rootUrl, scene, files, noMipmap, onLoad = null, onError = null, format, forcedExtension = null, createPolynomials = false, lodScale = 0, lodOffset = 0, fallback = null, beforeLoadCubeDataCallback = null, imageHandler = null, useSRGBBuffer = false, buffer = null) {\n    const texture = fallback ? fallback : new InternalTexture(this, 7 /* InternalTextureSource.Cube */);\n    texture.isCube = true;\n    texture.url = rootUrl;\n    texture.generateMipMaps = !noMipmap;\n    texture._lodGenerationScale = lodScale;\n    texture._lodGenerationOffset = lodOffset;\n    texture._useSRGBBuffer = !!useSRGBBuffer && this._caps.supportSRGBBuffers && (this.version > 1 || this.isWebGPU || !!noMipmap);\n    if (texture !== fallback) {\n        texture.label = rootUrl.substring(0, 60); // default label, can be overriden by the caller\n    }\n    if (!this._doNotHandleContextLost) {\n        texture._extension = forcedExtension;\n        texture._files = files;\n        texture._buffer = buffer;\n    }\n    const originalRootUrl = rootUrl;\n    if (this._transformTextureUrl && !fallback) {\n        rootUrl = this._transformTextureUrl(rootUrl);\n    }\n    const extension = forcedExtension ?? GetExtensionFromUrl(rootUrl);\n    const loaderPromise = _GetCompatibleTextureLoader(extension);\n    const localOnError = (message, exception) => {\n        // if an error was thrown during load, dispose the texture, otherwise it will stay in the cache\n        texture.dispose();\n        if (onError) {\n            onError(message, exception);\n        }\n        else if (message) {\n            Logger.Warn(message);\n        }\n    };\n    const onInternalError = (request, exception) => {\n        if (rootUrl === originalRootUrl) {\n            if (request) {\n                localOnError(request.status + \" \" + request.statusText, exception);\n            }\n        }\n        else {\n            // fall back to the original url if the transformed url fails to load\n            Logger.Warn(`Failed to load ${rootUrl}, falling back to the ${originalRootUrl}`);\n            this.createCubeTextureBase(originalRootUrl, scene, files, !!noMipmap, onLoad, localOnError, format, forcedExtension, createPolynomials, lodScale, lodOffset, texture, beforeLoadCubeDataCallback, imageHandler, useSRGBBuffer, buffer);\n        }\n    };\n    if (loaderPromise) {\n        // eslint-disable-next-line @typescript-eslint/no-floating-promises, github/no-then\n        loaderPromise.then((loader) => {\n            const onLoadData = (data) => {\n                if (beforeLoadCubeDataCallback) {\n                    beforeLoadCubeDataCallback(texture, data);\n                }\n                loader.loadCubeData(data, texture, createPolynomials, onLoad, (message, exception) => {\n                    localOnError(message, exception);\n                });\n            };\n            if (buffer) {\n                onLoadData(buffer);\n            }\n            else if (files && files.length === 6) {\n                if (loader.supportCascades) {\n                    this._cascadeLoadFiles(scene, (images) => onLoadData(images.map((image) => new Uint8Array(image))), files, localOnError);\n                }\n                else {\n                    localOnError(\"Textures type does not support cascades.\");\n                }\n            }\n            else {\n                this._loadFile(rootUrl, (data) => onLoadData(new Uint8Array(data)), undefined, scene ? scene.offlineProvider || null : undefined, true, onInternalError);\n            }\n        });\n    }\n    else {\n        if (!files || files.length === 0) {\n            throw new Error(\"Cannot load cubemap because files were not defined, or the correct loader was not found.\");\n        }\n        this._cascadeLoadImgs(scene, texture, (texture, imgs) => {\n            if (imageHandler) {\n                imageHandler(texture, imgs);\n            }\n        }, files, localOnError);\n    }\n    this._internalTexturesCache.push(texture);\n    return texture;\n};\n//# sourceMappingURL=abstractEngine.cubeTexture.js.map"],"names":["texture"],"mappings":"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","x_google_ignoreList":[0]}