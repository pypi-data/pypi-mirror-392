import{e as L,aP as g,a as _,L as w,V as n,aw as R,_ as b,s as E,R as D,F as y,bb as S,Q as B,aN as F,aO as P}from"./index-CKSmRzt-.js";import{R as x}from"./rawTexture-DOa77KPU.js";import{ArrayItem as A,GLTFLoader as C}from"./glTFLoader-Dm3LessQ.js";import"./index-bhUlIv2p.js";import"./bone-DKMuB1dq.js";import"./skeleton-BfCPY60z.js";import"./assetContainer-BOrw4ub9.js";import"./objectModelMapping-CFlMfOyz.js";async function z(){const i=new Uint16Array(16384),t=new Uint16Array(4096*4),s=await L.LoadFileAsync(L.GetAssetUrl("https://assets.babylonjs.com/core/areaLights/areaLightsLTC.bin")),e=new Uint16Array(s),h=e.length/8;for(let r=0;r<h;r++)i[r*4]=e[r*8],i[r*4+1]=e[r*8+1],i[r*4+2]=e[r*8+2],i[r*4+3]=e[r*8+3],t[r*4]=e[r*8+4],t[r*4+1]=e[r*8+5],t[r*4+2]=e[r*8+6],t[r*4+3]=e[r*8+7];return[i,t]}function M(i){const t=i.useDelayedTextureLoading;i.useDelayedTextureLoading=!1;const s=i._blockEntityCollection;i._blockEntityCollection=!1,i._ltcTextures={LTC1:x.CreateRGBATexture(null,64,64,i.getEngine(),!1,!1,2,2,0,!1,!0),LTC2:x.CreateRGBATexture(null,64,64,i.getEngine(),!1,!1,2,2,0,!1,!0)},i._blockEntityCollection=s,i._ltcTextures.LTC1.wrapU=_.CLAMP_ADDRESSMODE,i._ltcTextures.LTC1.wrapV=_.CLAMP_ADDRESSMODE,i._ltcTextures.LTC2.wrapU=_.CLAMP_ADDRESSMODE,i._ltcTextures.LTC2.wrapV=_.CLAMP_ADDRESSMODE,i.useDelayedTextureLoading=t,z().then(e=>{i._ltcTextures&&((i._ltcTextures?.LTC1).update(e[0]),(i._ltcTextures?.LTC2).update(e[1]),i.onDisposeObservable.addOnce(()=>{i._ltcTextures?.LTC1.dispose(),i._ltcTextures?.LTC2.dispose()}))}).catch(e=>{w.Error(`Area Light fail to get LTC textures data. Error: ${e}`)})}class U extends g{constructor(t,s,e){super(t,e),this.position=s,this._scene._ltcTextures||M(this._scene)}transferTexturesToEffect(t){return this._scene._ltcTextures&&(t.setTexture("areaLightsLTC1Sampler",this._scene._ltcTextures.LTC1),t.setTexture("areaLightsLTC2Sampler",this._scene._ltcTextures.LTC2)),this}prepareLightSpecificDefines(t,s){t["AREALIGHT"+s]=!0,t.AREALIGHTUSED=!0}_isReady(){return this._scene._ltcTextures?this._scene._ltcTextures.LTC1.isReady()&&this._scene._ltcTextures.LTC2.isReady():!1}}R.AddNodeConstructor("Light_Type_4",(i,t)=>()=>new l(i,n.Zero(),1,1,t));class l extends U{get width(){return this._width.x}set width(t){this._width.x=t}get height(){return this._height.y}set height(t){this._height.y=t}constructor(t,s,e,h,r){super(t,s,r),this._width=new n(e,0,0),this._height=new n(0,h,0),this._pointTransformedPosition=n.Zero(),this._pointTransformedWidth=n.Zero(),this._pointTransformedHeight=n.Zero()}getClassName(){return"RectAreaLight"}getTypeID(){return g.LIGHTTYPEID_RECT_AREALIGHT}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightWidth",4),this._uniformBuffer.addUniform("vLightHeight",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}_computeTransformedInformation(){return this.parent&&this.parent.getWorldMatrix?(n.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this._pointTransformedPosition),n.TransformNormalToRef(this._width,this.parent.getWorldMatrix(),this._pointTransformedWidth),n.TransformNormalToRef(this._height,this.parent.getWorldMatrix(),this._pointTransformedHeight),!0):!1}transferToEffect(t,s){const e=this._scene.floatingOriginOffset;return this._computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this._pointTransformedPosition.x-e.x,this._pointTransformedPosition.y-e.y,this._pointTransformedPosition.z-e.z,0,s),this._uniformBuffer.updateFloat4("vLightWidth",this._pointTransformedWidth.x/2,this._pointTransformedWidth.y/2,this._pointTransformedWidth.z/2,0,s),this._uniformBuffer.updateFloat4("vLightHeight",this._pointTransformedHeight.x/2,this._pointTransformedHeight.y/2,this._pointTransformedHeight.z/2,0,s)):(this._uniformBuffer.updateFloat4("vLightData",this.position.x-e.x,this.position.y-e.y,this.position.z-e.z,0,s),this._uniformBuffer.updateFloat4("vLightWidth",this._width.x/2,this._width.y/2,this._width.z/2,0,s),this._uniformBuffer.updateFloat4("vLightHeight",this._height.x/2,this._height.y/2,this._height.z/2,0,s)),this}transferToNodeMaterialEffect(t,s){const e=this._scene.floatingOriginOffset;return this._computeTransformedInformation()?t.setFloat3(s,this._pointTransformedPosition.x-e.x,this._pointTransformedPosition.y-e.y,this._pointTransformedPosition.z-e.z):t.setFloat3(s,this.position.x-e.x,this.position.y-e.y,this.position.z-e.z),this}}b([E()],l.prototype,"width",null);b([E()],l.prototype,"height",null);D("BABYLON.RectAreaLight",l);const u="EXT_lights_area";class v{constructor(t){this.name=u,this._loader=t,this.enabled=this._loader.isExtensionUsed(u)}dispose(){this._loader=null,delete this._lights}onLoading(){const t=this._loader.gltf.extensions;if(t&&t[this.name]){const s=t[this.name];this._lights=s.lights,A.Assign(this._lights)}}loadNodeAsync(t,s,e){return C.LoadExtensionAsync(t,s,this.name,async(h,r)=>(this._loader._allMaterialsDirtyRequired=!0,await this._loader.loadNodeAsync(t,s,c=>{let a;const o=A.Get(h,this._lights,r.light),T=o.name||c.name;this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer;const f=o.size!==void 0?o.size:1;switch(o.type){case"rect":{const d=o.rect?.aspect!==void 0?o.rect.aspect*f:f,m=f;a=new l(T,n.Zero(),d,m,this._loader.babylonScene);break}case"disk":{const d=Math.sqrt(f*f*.25*Math.PI);a=new l(T,n.Zero(),d,d,this._loader.babylonScene);break}default:throw this._loader.babylonScene._blockEntityCollection=!1,new Error(`${h}: Invalid area light type (${o.type})`)}a._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,o._babylonLight=a,a.falloffType=g.FALLOFF_GLTF,a.diffuse=o.color?y.FromArray(o.color):y.White(),a.intensity=o.intensity==null?1:o.intensity;const p=new S(`${T}_orientation`,this._loader.babylonScene);p.rotationQuaternion=B.RotationAxis(n.Up(),Math.PI),p.parent=c,a.parent=p,this._loader._babylonLights.push(a),C.AddPointerMetadata(a,h),e(c)})))}}F(u);P(u,!0,i=>new v(i));export{v as EXT_lights_area};
//# sourceMappingURL=EXT_lights_area-Cjb0yxH3.js.map
