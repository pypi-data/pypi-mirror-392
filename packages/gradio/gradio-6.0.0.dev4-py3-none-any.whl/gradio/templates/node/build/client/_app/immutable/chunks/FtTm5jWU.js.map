{"version":3,"file":"FtTm5jWU.js","sources":["../../../../../../../../node_modules/.pnpm/@babylonjs+loaders@8.36.1_@babylonjs+core@8.36.1_babylonjs-gltf2interface@8.36.1/node_modules/@babylonjs/loaders/glTF/2.0/Extensions/KHR_materials_variants.js"],"sourcesContent":["import { GLTFLoader, ArrayItem } from \"../glTFLoader.js\";\nimport { Mesh } from \"@babylonjs/core/Meshes/mesh.js\";\nimport { registerGLTFExtension, unregisterGLTFExtension } from \"../glTFLoaderExtensionRegistry.js\";\nconst NAME = \"KHR_materials_variants\";\n/**\n * [Specification](https://github.com/KhronosGroup/glTF/blob/main/extensions/2.0/Khronos/KHR_materials_variants/README.md)\n */\n// eslint-disable-next-line @typescript-eslint/naming-convention\nexport class KHR_materials_variants {\n    /**\n     * @internal\n     */\n    constructor(loader) {\n        /**\n         * The name of this extension.\n         */\n        this.name = NAME;\n        this._loader = loader;\n        this.enabled = this._loader.isExtensionUsed(NAME) && !this._loader.parent.skipMaterials;\n    }\n    /** @internal */\n    dispose() {\n        this._loader = null;\n    }\n    /**\n     * Gets the list of available variant names for this asset.\n     * @param rootNode The glTF root node\n     * @returns the list of all the variant names for this model\n     */\n    static GetAvailableVariants(rootNode) {\n        const extensionMetadata = this._GetExtensionMetadata(rootNode);\n        if (!extensionMetadata) {\n            return [];\n        }\n        return Object.keys(extensionMetadata.variants);\n    }\n    /**\n     * Gets the list of available variant names for this asset.\n     * @param rootNode The glTF root node\n     * @returns the list of all the variant names for this model\n     */\n    getAvailableVariants(rootNode) {\n        return KHR_materials_variants.GetAvailableVariants(rootNode);\n    }\n    /**\n     * Select a variant given a variant name or a list of variant names.\n     * @param rootNode The glTF root node\n     * @param variantName The variant name(s) to select.\n     */\n    static SelectVariant(rootNode, variantName) {\n        const extensionMetadata = this._GetExtensionMetadata(rootNode);\n        if (!extensionMetadata) {\n            throw new Error(`Cannot select variant on a glTF mesh that does not have the ${NAME} extension`);\n        }\n        const select = (variantName) => {\n            const entries = extensionMetadata.variants[variantName];\n            if (entries) {\n                for (const entry of entries) {\n                    entry.mesh.material = entry.material;\n                }\n            }\n        };\n        if (variantName instanceof Array) {\n            for (const name of variantName) {\n                select(name);\n            }\n        }\n        else {\n            select(variantName);\n        }\n        extensionMetadata.lastSelected = variantName;\n    }\n    /**\n     * Select a variant given a variant name or a list of variant names.\n     * @param rootNode The glTF root node\n     * @param variantName The variant name(s) to select.\n     */\n    selectVariant(rootNode, variantName) {\n        KHR_materials_variants.SelectVariant(rootNode, variantName);\n    }\n    /**\n     * Reset back to the original before selecting a variant.\n     * @param rootNode The glTF root node\n     */\n    static Reset(rootNode) {\n        const extensionMetadata = this._GetExtensionMetadata(rootNode);\n        if (!extensionMetadata) {\n            throw new Error(`Cannot reset on a glTF mesh that does not have the ${NAME} extension`);\n        }\n        for (const entry of extensionMetadata.original) {\n            entry.mesh.material = entry.material;\n        }\n        extensionMetadata.lastSelected = null;\n    }\n    /**\n     * Reset back to the original before selecting a variant.\n     * @param rootNode The glTF root node\n     */\n    reset(rootNode) {\n        KHR_materials_variants.Reset(rootNode);\n    }\n    /**\n     * Gets the last selected variant name(s) or null if original.\n     * @param rootNode The glTF root node\n     * @returns The selected variant name(s).\n     */\n    static GetLastSelectedVariant(rootNode) {\n        const extensionMetadata = this._GetExtensionMetadata(rootNode);\n        if (!extensionMetadata) {\n            throw new Error(`Cannot get the last selected variant on a glTF mesh that does not have the ${NAME} extension`);\n        }\n        return extensionMetadata.lastSelected;\n    }\n    /**\n     * Gets the last selected variant name(s) or null if original.\n     * @param rootNode The glTF root node\n     * @returns The selected variant name(s).\n     */\n    getLastSelectedVariant(rootNode) {\n        return KHR_materials_variants.GetLastSelectedVariant(rootNode);\n    }\n    static _GetExtensionMetadata(rootNode) {\n        return rootNode?._internalMetadata?.gltf?.[NAME] || null;\n    }\n    /** @internal */\n    onLoading() {\n        const extensions = this._loader.gltf.extensions;\n        if (extensions && extensions[this.name]) {\n            const extension = extensions[this.name];\n            this._variants = extension.variants;\n        }\n    }\n    /** @internal */\n    onReady() {\n        const rootNode = this._loader.rootBabylonMesh;\n        if (rootNode) {\n            const options = this._loader.parent.extensionOptions[NAME];\n            if (options?.defaultVariant) {\n                KHR_materials_variants.SelectVariant(rootNode, options.defaultVariant);\n            }\n            options?.onLoaded?.({\n                get variants() {\n                    return KHR_materials_variants.GetAvailableVariants(rootNode);\n                },\n                get selectedVariant() {\n                    const lastSelectedVariant = KHR_materials_variants.GetLastSelectedVariant(rootNode);\n                    if (!lastSelectedVariant) {\n                        return KHR_materials_variants.GetAvailableVariants(rootNode)[0];\n                    }\n                    if (Array.isArray(lastSelectedVariant)) {\n                        return lastSelectedVariant[0];\n                    }\n                    return lastSelectedVariant;\n                },\n                set selectedVariant(variantName) {\n                    KHR_materials_variants.SelectVariant(rootNode, variantName);\n                },\n            });\n        }\n    }\n    /**\n     * @internal\n     */\n    // eslint-disable-next-line no-restricted-syntax\n    _loadMeshPrimitiveAsync(context, name, node, mesh, primitive, assign) {\n        return GLTFLoader.LoadExtensionAsync(context, primitive, this.name, async (extensionContext, extension) => {\n            const promises = new Array();\n            promises.push(this._loader._loadMeshPrimitiveAsync(context, name, node, mesh, primitive, (babylonMesh) => {\n                assign(babylonMesh);\n                if (babylonMesh instanceof Mesh) {\n                    const babylonDrawMode = GLTFLoader._GetDrawMode(context, primitive.mode);\n                    const root = this._loader.rootBabylonMesh;\n                    const metadata = root ? (root._internalMetadata = root._internalMetadata || {}) : {};\n                    const gltf = (metadata.gltf = metadata.gltf || {});\n                    const extensionMetadata = (gltf[NAME] = gltf[NAME] || { lastSelected: null, original: [], variants: {} });\n                    // Store the original material.\n                    extensionMetadata.original.push({ mesh: babylonMesh, material: babylonMesh.material });\n                    // For each mapping, look at the variants and make a new entry for them.\n                    for (let mappingIndex = 0; mappingIndex < extension.mappings.length; ++mappingIndex) {\n                        const mapping = extension.mappings[mappingIndex];\n                        const material = ArrayItem.Get(`${extensionContext}/mappings/${mappingIndex}/material`, this._loader.gltf.materials, mapping.material);\n                        promises.push(this._loader._loadMaterialAsync(`#/materials/${mapping.material}`, material, babylonMesh, babylonDrawMode, (babylonMaterial) => {\n                            for (let mappingVariantIndex = 0; mappingVariantIndex < mapping.variants.length; ++mappingVariantIndex) {\n                                const variantIndex = mapping.variants[mappingVariantIndex];\n                                const variant = ArrayItem.Get(`/extensions/${NAME}/variants/${variantIndex}`, this._variants, variantIndex);\n                                extensionMetadata.variants[variant.name] = extensionMetadata.variants[variant.name] || [];\n                                extensionMetadata.variants[variant.name].push({\n                                    mesh: babylonMesh,\n                                    material: babylonMaterial,\n                                });\n                                // Replace the target when original mesh is cloned\n                                babylonMesh.onClonedObservable.add((newOne) => {\n                                    const newMesh = newOne;\n                                    let metadata = null;\n                                    let newRoot = newMesh;\n                                    // Find root to get medata\n                                    do {\n                                        newRoot = newRoot.parent;\n                                        if (!newRoot) {\n                                            return;\n                                        }\n                                        metadata = KHR_materials_variants._GetExtensionMetadata(newRoot);\n                                    } while (metadata === null);\n                                    // Need to clone the metadata on the root (first time only)\n                                    if (root && metadata === KHR_materials_variants._GetExtensionMetadata(root)) {\n                                        // Copy main metadata\n                                        newRoot._internalMetadata = {};\n                                        for (const key in root._internalMetadata) {\n                                            newRoot._internalMetadata[key] = root._internalMetadata[key];\n                                        }\n                                        // Copy the gltf metadata\n                                        newRoot._internalMetadata.gltf = [];\n                                        for (const key in root._internalMetadata.gltf) {\n                                            newRoot._internalMetadata.gltf[key] = root._internalMetadata.gltf[key];\n                                        }\n                                        // Duplicate the extension specific metadata\n                                        newRoot._internalMetadata.gltf[NAME] = { lastSelected: null, original: [], variants: {} };\n                                        for (const original of metadata.original) {\n                                            newRoot._internalMetadata.gltf[NAME].original.push({\n                                                mesh: original.mesh,\n                                                material: original.material,\n                                            });\n                                        }\n                                        for (const key in metadata.variants) {\n                                            if (Object.prototype.hasOwnProperty.call(metadata.variants, key)) {\n                                                newRoot._internalMetadata.gltf[NAME].variants[key] = [];\n                                                for (const variantEntry of metadata.variants[key]) {\n                                                    newRoot._internalMetadata.gltf[NAME].variants[key].push({\n                                                        mesh: variantEntry.mesh,\n                                                        material: variantEntry.material,\n                                                    });\n                                                }\n                                            }\n                                        }\n                                        metadata = newRoot._internalMetadata.gltf[NAME];\n                                    }\n                                    // Relocate\n                                    for (const target of metadata.original) {\n                                        if (target.mesh === babylonMesh) {\n                                            target.mesh = newMesh;\n                                        }\n                                    }\n                                    for (const target of metadata.variants[variant.name]) {\n                                        if (target.mesh === babylonMesh) {\n                                            target.mesh = newMesh;\n                                        }\n                                    }\n                                });\n                            }\n                        }));\n                    }\n                }\n            }));\n            // eslint-disable-next-line github/no-then\n            return await Promise.all(promises).then(([babylonMesh]) => {\n                return babylonMesh;\n            });\n        });\n    }\n}\nunregisterGLTFExtension(NAME);\nregisterGLTFExtension(NAME, true, (loader) => new KHR_materials_variants(loader));\n//# sourceMappingURL=KHR_materials_variants.js.map"],"names":["variantName","metadata"],"mappings":"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","x_google_ignoreList":[0]}