{"version":3,"file":"BikVSv5j.js","sources":["../../../../../../../../node_modules/.pnpm/@babylonjs+core@8.36.1/node_modules/@babylonjs/core/FlowGraph/Blocks/Execution/Animation/flowGraphPlayAnimationBlock.js"],"sourcesContent":["import { FlowGraphAsyncExecutionBlock } from \"../../../flowGraphAsyncExecutionBlock.js\";\nimport { RichTypeAny, RichTypeNumber, RichTypeBoolean } from \"../../../flowGraphRichTypes.js\";\nimport { RegisterClass } from \"../../../../Misc/typeStore.js\";\nimport { AnimationGroup } from \"../../../../Animations/animationGroup.js\";\n/**\n * @experimental\n * A block that plays an animation on an animatable object.\n */\nexport class FlowGraphPlayAnimationBlock extends FlowGraphAsyncExecutionBlock {\n    constructor(\n    /**\n     * the configuration of the block\n     */\n    config) {\n        super(config, [\"animationLoop\", \"animationEnd\", \"animationGroupLoop\"]);\n        this.config = config;\n        this.speed = this.registerDataInput(\"speed\", RichTypeNumber);\n        this.loop = this.registerDataInput(\"loop\", RichTypeBoolean);\n        this.from = this.registerDataInput(\"from\", RichTypeNumber, 0);\n        this.to = this.registerDataInput(\"to\", RichTypeNumber);\n        this.currentFrame = this.registerDataOutput(\"currentFrame\", RichTypeNumber);\n        this.currentTime = this.registerDataOutput(\"currentTime\", RichTypeNumber);\n        this.currentAnimationGroup = this.registerDataOutput(\"currentAnimationGroup\", RichTypeAny);\n        this.animationGroup = this.registerDataInput(\"animationGroup\", RichTypeAny, config?.animationGroup);\n        this.animation = this.registerDataInput(\"animation\", RichTypeAny);\n        this.object = this.registerDataInput(\"object\", RichTypeAny);\n    }\n    /**\n     * @internal\n     * @param context\n     */\n    _preparePendingTasks(context) {\n        const ag = this.animationGroup.getValue(context);\n        const animation = this.animation.getValue(context);\n        if (!ag && !animation) {\n            return this._reportError(context, \"No animation or animation group provided\");\n        }\n        else {\n            // if an animation group was already created, dispose it and create a new one\n            const currentAnimationGroup = this.currentAnimationGroup.getValue(context);\n            if (currentAnimationGroup && currentAnimationGroup !== ag) {\n                currentAnimationGroup.dispose();\n            }\n            let animationGroupToUse = ag;\n            // check which animation to use. If no animationGroup was defined and an animation was provided, use the animation\n            if (animation && !animationGroupToUse) {\n                const target = this.object.getValue(context);\n                if (!target) {\n                    return this._reportError(context, \"No target object provided\");\n                }\n                const animationsArray = Array.isArray(animation) ? animation : [animation];\n                const name = animationsArray[0].name;\n                animationGroupToUse = new AnimationGroup(\"flowGraphAnimationGroup-\" + name + \"-\" + target.name, context.configuration.scene);\n                let isInterpolation = false;\n                const interpolationAnimations = context._getGlobalContextVariable(\"interpolationAnimations\", []);\n                for (const anim of animationsArray) {\n                    animationGroupToUse.addTargetedAnimation(anim, target);\n                    if (interpolationAnimations.indexOf(anim.uniqueId) !== -1) {\n                        isInterpolation = true;\n                    }\n                }\n                if (isInterpolation) {\n                    this._checkInterpolationDuplications(context, animationsArray, target);\n                }\n            }\n            // not accepting 0\n            const speed = this.speed.getValue(context) || 1;\n            const from = this.from.getValue(context) ?? 0;\n            // not accepting 0\n            const to = this.to.getValue(context) || animationGroupToUse.to;\n            const loop = !isFinite(to) || this.loop.getValue(context);\n            this.currentAnimationGroup.setValue(animationGroupToUse, context);\n            const currentlyRunningAnimationGroups = context._getGlobalContextVariable(\"currentlyRunningAnimationGroups\", []);\n            // check if it already running\n            if (currentlyRunningAnimationGroups.indexOf(animationGroupToUse.uniqueId) !== -1) {\n                animationGroupToUse.stop();\n            }\n            try {\n                animationGroupToUse.start(loop, speed, from, to);\n                animationGroupToUse.onAnimationGroupEndObservable.add(() => this._onAnimationGroupEnd(context));\n                animationGroupToUse.onAnimationEndObservable.add(() => this._eventsSignalOutputs[\"animationEnd\"]._activateSignal(context));\n                animationGroupToUse.onAnimationLoopObservable.add(() => this._eventsSignalOutputs[\"animationLoop\"]._activateSignal(context));\n                animationGroupToUse.onAnimationGroupLoopObservable.add(() => this._eventsSignalOutputs[\"animationGroupLoop\"]._activateSignal(context));\n                currentlyRunningAnimationGroups.push(animationGroupToUse.uniqueId);\n                context._setGlobalContextVariable(\"currentlyRunningAnimationGroups\", currentlyRunningAnimationGroups);\n            }\n            catch (e) {\n                this._reportError(context, e);\n            }\n        }\n    }\n    _reportError(context, error) {\n        super._reportError(context, error);\n        this.currentFrame.setValue(-1, context);\n        this.currentTime.setValue(-1, context);\n    }\n    /**\n     * @internal\n     */\n    _executeOnTick(_context) {\n        const ag = this.currentAnimationGroup.getValue(_context);\n        if (ag) {\n            this.currentFrame.setValue(ag.getCurrentFrame(), _context);\n            this.currentTime.setValue(ag.animatables[0]?.elapsedTime ?? 0, _context);\n        }\n    }\n    _execute(context) {\n        this._startPendingTasks(context);\n    }\n    _onAnimationGroupEnd(context) {\n        this._removeFromCurrentlyRunning(context, this.currentAnimationGroup.getValue(context));\n        this._resetAfterCanceled(context);\n        this.done._activateSignal(context);\n    }\n    /**\n     * The idea behind this function is to check every running animation group and check if the targeted animations it uses are interpolation animations.\n     * If they are, we want to see that they don't collide with the current interpolation animations that are starting to play.\n     * If they do, we want to stop the already-running animation group.\n     * @internal\n     */\n    _checkInterpolationDuplications(context, animation, target) {\n        const currentlyRunningAnimationGroups = context._getGlobalContextVariable(\"currentlyRunningAnimationGroups\", []);\n        for (const uniqueId of currentlyRunningAnimationGroups) {\n            const ag = context.assetsContext.animationGroups.find((ag) => ag.uniqueId === uniqueId);\n            if (ag) {\n                for (const anim of ag.targetedAnimations) {\n                    for (const animToCheck of animation) {\n                        if (anim.animation.targetProperty === animToCheck.targetProperty && anim.target === target) {\n                            this._stopAnimationGroup(context, ag);\n                        }\n                    }\n                }\n            }\n        }\n    }\n    _stopAnimationGroup(context, animationGroup) {\n        // stop, while skipping the on AnimationEndObservable to avoid the \"done\" signal\n        animationGroup.stop(true);\n        animationGroup.dispose();\n        this._removeFromCurrentlyRunning(context, animationGroup);\n    }\n    _removeFromCurrentlyRunning(context, animationGroup) {\n        const currentlyRunningAnimationGroups = context._getGlobalContextVariable(\"currentlyRunningAnimationGroups\", []);\n        const idx = currentlyRunningAnimationGroups.indexOf(animationGroup.uniqueId);\n        if (idx !== -1) {\n            currentlyRunningAnimationGroups.splice(idx, 1);\n            context._setGlobalContextVariable(\"currentlyRunningAnimationGroups\", currentlyRunningAnimationGroups);\n        }\n    }\n    /**\n     * @internal\n     * Stop any currently running animations.\n     */\n    _cancelPendingTasks(context) {\n        const ag = this.currentAnimationGroup.getValue(context);\n        if (ag) {\n            this._stopAnimationGroup(context, ag);\n        }\n    }\n    /**\n     * @returns class name of the block.\n     */\n    getClassName() {\n        return \"FlowGraphPlayAnimationBlock\" /* FlowGraphBlockNames.PlayAnimation */;\n    }\n}\nRegisterClass(\"FlowGraphPlayAnimationBlock\" /* FlowGraphBlockNames.PlayAnimation */, FlowGraphPlayAnimationBlock);\n//# sourceMappingURL=flowGraphPlayAnimationBlock.js.map"],"names":["ag"],"mappings":"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","x_google_ignoreList":[0]}