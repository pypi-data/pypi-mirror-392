"use strict";(self.webpackChunkhintbot=self.webpackChunkhintbot||[]).push([[972],{62:(e,t,n)=>{n.r(t),n.d(t,{default:()=>a,setBannerActive:()=>o});const i="hint-banner-active-style";function o(e){try{if(e){if(document.body.classList.add("hint-banner-active"),!document.getElementById(i)){const e=document.createElement("style");e.id=i,e.innerHTML="body.hint-banner-active .hint-request-bar-right-request-button { background-color: #d1d5db !important; color: #6b7280 !important; cursor: default !important; opacity: 0.9; }",document.head.appendChild(e)}}else{document.body.classList.remove("hint-banner-active");const e=document.getElementById(i);e&&e.parentElement&&e.parentElement.removeChild(e)}}catch(e){}}const a=o},220:(e,t,n)=>{n.d(t,{q:()=>a});var i=n(297),o=n(860);async function a(e="",t={}){const n=o.ServerConnection.makeSettings();let a=e,r="";const s=e.indexOf("?");s>=0&&(a=e.substring(0,s),r=e.substring(s));const l=`${i.URLExt.join(n.baseUrl,"hintbot",a)}${r}`;let d;try{d=await o.ServerConnection.makeRequest(l,t,n)}catch(e){throw new o.ServerConnection.NetworkError(e)}let c=await d.text();if(c.length>0)try{c=JSON.parse(c)}catch(e){console.log("Not a JSON response body.",d)}if(!d.ok){if(404===d.status){const e=`HintBot server extension not found at ${l}. Ensure the Python package is installed in the environment where you run Jupyter Server and that the server extension is enabled (e.g. run: \n  jupyter server extension enable --sys-prefix hintbot \nthen restart Jupyter Server).`;throw console.error(e,d),new Error(e)}throw new o.ServerConnection.ResponseError(d,c.message||c)}return c}},954:(e,t,n)=>{n.d(t,{createHintHistoryBar:()=>r,p:()=>a});var i=n(220),o=n(986);const a=async(e,t,n)=>{var a;const r=e.getMetadata("hintHistory");let s=!1;if(r)for(let l=0;l<r.length;l++)if(!r[l].isGPT&&0===(null===(a=r[l])||void 0===a?void 0:a.hintContent)){const a=await(0,i.q)("check_ta",{method:"POST",body:JSON.stringify({request_id:r[l].requestId})});if(200==a.statusCode){if(a.feedback_ready){r[l].hintContent=a.feedback;const i=e.getMetadata("questionIndex");o.Notification.info(`Instructor feedback for Question ${i} is now available. You can view it by expanding the bar beneath the question.`,{autoClose:2e4}),s=!0,n.exporters.forEach(i=>{n.publishEvent(t,{eventName:"GetInstructorHint",eventTime:Date.now(),eventInfo:{gradeId:e.getMetadata("nbgrader").grade_id,requestId:r[l].requestId,hintType:r[l].hintType,hintContent:a.feedback}},i,!1)})}}else r[l].error=a.message,n.exporters.forEach(i=>{n.publishEvent(t,{eventName:"GetInstructorHintError",eventTime:Date.now(),eventInfo:{gradeId:e.getMetadata("nbgrader").grade_id,requestId:r[l].requestId,hintType:r[l].hintType,error:a.message}},i,!1)})}return s&&e.setMetadata("hintHistory",r),s},r=async(e,t,n,i)=>{var o,a,r;document.getElementById(`hint-history-bar-${e.id}`)&&document.getElementById(`hint-history-bar-${e.id}`).remove();const s=e.getMetadata("hintHistory"),l=document.createElement("div");if(l.classList.add("hint-history-bar"),l.id=`hint-history-bar-${e.id}`,s&&s.length>0){const d=[...s].sort((e,t)=>{var n,i,o,a,r,s,l,d;const c=Number(null!==(a=null!==(o=null!==(i=null!==(n=e.ai_request_id)&&void 0!==n?n:e.aiRequestId)&&void 0!==i?i:e.requestId)&&void 0!==o?o:e.id)&&void 0!==a?a:0),u=Number(null!==(d=null!==(l=null!==(s=null!==(r=t.ai_request_id)&&void 0!==r?r:t.aiRequestId)&&void 0!==s?s:t.requestId)&&void 0!==l?l:t.id)&&void 0!==d?d:0);if(c!==u)return c-u;const p=e.isGPT?"ai":"instructor";return p!==(t.isGPT?"ai":"instructor")?"ai"===p?-1:1:0}),c=d.length>1;for(let t=0;t<d.length;t++){const s=d[t],u=c&&0===t,p=c&&t===d.length-1&&!u;if(0!==(null==s?void 0:s.hintContent)){const t=document.createElement("div"),o=document.createElement("button");o.classList.add("accordion"),s.isGPT||o.classList.add("ta-accordion");const a=document.createElement("span"),r={plan:"Planning Hint",debug:"Debugging Hint",optimize:"Optimization Hint"},d=(s.hintType||"").toString();if(s.isGPT){const e=r[d.toLowerCase()];a.textContent=e||`AI hint (${d})`}else a.textContent="Instructor feedback";a.classList.add("history-label"),a.style.whiteSpace="nowrap",o.appendChild(a);let c=null;if(s.isGPT?void 0!==s.helpful&&null!==s.helpful&&(c=s.helpful?"ðŸ‘":"ðŸ‘Ž"):void 0!==s.instructor_helpful&&null!==s.instructor_helpful&&(c=s.instructor_helpful?"ðŸ‘":"ðŸ‘Ž"),c){const e=document.createElement("span");e.classList.add("history-rating"),e.textContent=` ${c}`,e.setAttribute("aria-hidden","true"),o.appendChild(e)}if(u){const e=document.createElement("span");e.classList.add("history-edge"),e.textContent=" (earliest)",o.appendChild(e)}else if(p){const e=document.createElement("span");e.classList.add("history-edge"),e.textContent=" (latest)",o.appendChild(e)}const h=document.createElement("div");h.classList.add("accordion-panel");const m=document.createElement("p");m.innerText=s.hintContent,h.appendChild(m),t.appendChild(o),t.appendChild(h),l.appendChild(t),o.addEventListener("click",function(){this.classList.toggle("active"),h.style.maxHeight?h.style.maxHeight=null:h.style.maxHeight=h.scrollHeight+"px",i.exporters.forEach(t=>{i.publishEvent(n,{eventName:this.classList.contains("active")?"HintHistoryReview":"HintHistoryHide",eventTime:Date.now(),eventInfo:{gradeId:e.getMetadata("nbgrader").grade_id,requestId:s.requestId,isGPT:s.isGPT,hintType:s.hintType,hintContent:s.hintContent}},t,!1)})})}else if((null==s?void 0:s.errorMessage)||(null==s?void 0:s.error)){const e=document.createElement("button");e.classList.add("accordion","accordion-error");const t=null!==(r=null!==(a=null!==(o=s.ai_request_id)&&void 0!==o?o:s.requestId)&&void 0!==a?a:s.id)&&void 0!==r?r:0,n=document.createElement("span");n.classList.add("history-id"),n.textContent=`[#${t}] `;const i=document.createElement("span");if(i.textContent=s.error||s.errorMessage,e.appendChild(n),e.appendChild(i),u){const t=document.createElement("span");t.classList.add("history-edge"),t.textContent=" (earliest)",e.appendChild(t)}else if(p){const t=document.createElement("span");t.classList.add("history-edge"),t.textContent=" (latest)",e.appendChild(t)}const d=document.createElement("div");d.appendChild(e),l.appendChild(d)}}n.content.widgets[t].node.appendChild(l)}}},972:(e,t,n)=>{n.r(t),n.d(t,{default:()=>w});var i=n(762),o=n(986),a=n(832),r=n(500),s=n(345),l=n.n(s);class d extends o.ReactWidget{constructor(e){super(),this._message="",this._message=e}getValue(){var e;return null===(e=this.node.querySelector("textarea"))||void 0===e?void 0:e.value}render(){return l().createElement("div",{className:"reflection"},l().createElement("p",null,this._message),l().createElement("textarea",{name:"reflection-input",className:"reflection-input",rows:10}),l().createElement("p",{style:{fontStyle:"italic"}},"Text entered here will be passed to the external language model service to improve hint relevance."))}}var c=n(220),u=n(954),p=n(62);const h=async(e,t,n,i,a,r,s,l,d,h,m)=>{var g;const f=n.getMetadata("nbgrader").grade_id,b=document.createElement("div");b.id="hint-banner-placeholder",e.content.node.insertBefore(b,e.content.node.firstChild);const y=document.createElement("div");y.id="hint-banner",null===(g=e.content.node.parentElement)||void 0===g||g.insertBefore(y,e.content.node),(0,p.setBannerActive)(!0);const v=m=>{y.innerHTML="";const g=document.createElement("div");g.id="hint-banner-title-row";const v=document.createElement("div");v.classList.add("hint-banner-title"),v.textContent="instructor"===d?"Instructor Feedback":"AI Hint",g.appendChild(v),y.appendChild(g);const _=document.createElement("div");_.id="hint-banner-content";const x=document.createElement("p");x.textContent=m,_.appendChild(x),y.appendChild(_);const q=document.createElement("div");q.id="hint-banner-buttons-container";const E=document.createElement("div");E.id="hint-banner-buttons";const w=document.createElement("button");w.classList.add("hint-banner-button","hint-button-helpful"),w.innerText="ðŸ‘ Helpful";const C=document.createElement("button");C.classList.add("hint-banner-button","hint-button-unhelpful"),C.innerText="ðŸ‘Ž Unhelpful",E.appendChild(C),E.appendChild(w),q.appendChild(E),y.appendChild(q);const T=async o=>{t.exporters.forEach(n=>{t.publishEvent(e,{eventName:"HintEvaluated",eventTime:Date.now(),eventInfo:{gradeId:f,requestId:h,hintContent:m,evaluation:o,promptGroup:a,prompt:r,uuid:s,preReflection:l,hintType:d}},n,!1)});try{const e=n.getMetadata("hintHistory")||[],t=e.findIndex(e=>String(e.requestId)===String(h));t>=0&&(e[t].helpful="helpful"===o,n.setMetadata("hintHistory",e))}catch(e){}w.remove(),C.remove(),(0,u.createHintHistoryBar)(n,i,e,t);try{await(0,c.q)("save_rating",{method:"POST",body:JSON.stringify({request_id:h,is_hint_helpful:"helpful"===o})})}catch(e){console.error("Failed to save hint rating",e)}};w.onclick=()=>{T("helpful"),y.remove(),b.remove(),(0,p.setBannerActive)(!1)},C.onclick=()=>{T("unhelpful"),y.innerHTML="",y.style.backgroundColor="#f3f4f6";const i=document.createElement("div");i.id="hint-banner-content",i.classList.add("hint-banner-escalation");const a=document.createElement("span");a.style.cssText="font-size: 15px; font-weight: 600; color: #6b7280; letter-spacing: 0.05em;",a.textContent="AI Hint",i.appendChild(a);const r=document.createElement("div");r.style.cssText="display: flex; align-items: center; justify-content: flex-start; background-color: #ffffff; border: 1px solid #e5e7eb; border-radius: 6px; padding: 12px; min-height: calc(1.4em * 3);";const l=document.createElement("p");l.style.cssText="margin: 0; font-size: 14px; line-height: 1.4; color: #111827; white-space: pre-wrap;",l.textContent=m,r.appendChild(l),i.appendChild(r);const u=document.createElement("p");u.style.cssText="margin-bottom: 8px; font-size: 14px; line-height: 1.4; color: #4b5563; white-space: pre-wrap;",u.textContent="\nI'm sorry that the AI hint was not helpful.\nDo you want to escalate to request some feedback from a human instructor?",i.appendChild(u);const g=document.createElement("div");g.style.cssText="display: flex; justify-content: flex-start; align-items: center; gap: 12px; width: 100%;";const v=document.createElement("span");v.style.cssText="font-size: 13px; line-height: 1.4; color: #6b7280;",v.textContent="Enter your email to get a notification once a response is available:",g.appendChild(v);const _=document.createElement("input");_.type="email",_.placeholder="your-email@something.edu",_.style.cssText="padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px; width: 220px; max-width: 40%;",g.appendChild(_),i.appendChild(g);const x=document.createElement("div");x.style.cssText="display: flex; flex-direction: column; gap: 8px;";const q=document.createElement("div");q.style.cssText="display: flex; gap: 8px; align-items: stretch; width: 100%;";const E=document.createElement("textarea");E.placeholder="Here you can optionally provide more context on why the AI hint is not useful...",E.style.cssText="flex: 1 1 auto; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px; resize: vertical; min-height: 80px; height: auto;",q.appendChild(E);const w=document.createElement("div");w.style.cssText="display: flex; flex-direction: column; gap: 4px; flex-shrink: 0; margin-left: auto; width: 150px; padding: 0;";const C=document.createElement("button");C.classList.add("hint-banner-cancel-button"),C.innerText="Don't Escalate",C.style.cssText="padding: 6px 12px; border-radius: 4px; font-size: 13px; white-space: nowrap; display: flex; justify-content: center; align-items: center; flex: 1 1 0;";const H=document.createElement("button");H.classList.add("hint-banner-button","hint-button-escalate"),H.innerText="Escalate",H.style.cssText="padding: 6px 12px; border-radius: 4px; font-size: 13px; white-space: nowrap; display: flex; justify-content: center; align-items: center; flex: 1 1 0;",w.appendChild(C),w.appendChild(H),q.appendChild(w),x.appendChild(q),i.appendChild(x),y.appendChild(i),C.onclick=()=>{E.value.trim().length>0||(t.exporters.forEach(n=>{t.publishEvent(e,{eventName:"InstructorRequestCanceled",eventTime:Date.now(),eventInfo:{gradeId:f,requestId:h,uuid:s,hintType:d}},n,!1)}),y.remove(),b.remove(),(0,p.setBannerActive)(!1))},E.addEventListener("input",()=>{E.value.trim().length>0?(C.disabled=!0,C.style.opacity="0.5",C.style.cursor="not-allowed",C.title="To select Don't Escalate, you should empty the textbox"):(C.disabled=!1,C.style.opacity="1",C.style.cursor="pointer",C.title="")}),H.onclick=async()=>{t.exporters.forEach(n=>{t.publishEvent(e,{eventName:"InstructorRequestContinued",eventTime:Date.now(),eventInfo:{gradeId:f,requestId:h,uuid:s,hintType:d}},n,!1)}),t.exporters.forEach(n=>{t.publishEvent(e,{eventName:"InstructorReflection",eventTime:Date.now(),eventInfo:{status:"Submit",gradeId:f,uuid:s,hintType:d,email:_.value.trim(),reflection:E.value.trim()}},n,!1)});try{const t=await(0,c.q)("ta",{method:"POST",body:JSON.stringify({request_id:h,student_email:_.value.trim()||void 0,student_notes:E.value.trim()||void 0,problem_id:f})});if(console.log("create ta ticket",t),200!==t.statusCode)(0,o.showDialog)({title:(null==t?void 0:t.message)||"Error",buttons:[o.Dialog.createButton({label:"Dismiss",className:"jp-Dialog-button jp-mod-reject jp-mod-styled"})]});else{const t=n.getMetadata("hintHistory")||[];n.setMetadata("hintHistory",[...t,{requestId:h,isGPT:!1,hintType:d,hintContent:0}]),y.innerHTML="",y.style.backgroundColor="#f3f4f6",y.style.display="flex",y.style.flexDirection="column";const i=document.createElement("div");i.style.cssText="flex: 1 1 auto; display: flex; align-items: center; justify-content: flex-start; padding: 12px 16px;";const o=document.createElement("p");o.style.cssText="margin: 0; font-size: 14px; color: #111827; white-space: pre-wrap;";const a=_&&_.value&&_.value.trim().length>0;o.innerText=a?"Request sent! You will receive a response via email when an instructional team member has reviewed your request.":"Request sent! Check this notebook later for feedback from an instructional team member.",i.appendChild(o),y.appendChild(i);const r=document.createElement("div");r.style.cssText="display: flex; justify-content: center; padding: 12px;";const s=document.createElement("button");s.classList.add("hint-banner-cancel-button"),s.innerText="Close",s.style.cssText="padding: 6px 12px;",r.appendChild(s),y.appendChild(r),e.context.save(),s.onclick=()=>{y.remove(),b.remove(),(0,p.setBannerActive)(!1)}}}catch(e){console.error("Error escalating to instructor:",e),(0,o.showDialog)({title:"Error escalating request",buttons:[o.Dialog.createButton({label:"Dismiss",className:"jp-Dialog-button jp-mod-reject jp-mod-styled"})]})}}}};if(null==m?void 0:m.skipNetwork)return void v(m.preloadedContent||"");y.innerHTML='<div id="hint-banner-content"><p><span class="loader"></span>Retrieving hint... Please do not refresh the page. You can continue to work on the assignment in the meantime.</p></div>';const _=document.createElement("div");_.classList.add("hint-banner-cancel-button"),_.innerText="Cancel request",_.style.cssText="display: inline-block; align-self: center; margin-top: 8px;",y.appendChild(_),_.onclick=async()=>{await(0,c.q)("cancel",{method:"POST",body:JSON.stringify({request_id:h})})};const x=i=>{y.remove(),b.remove(),(0,p.setBannerActive)(!1);const c=n.getMetadata("remaining_hints");c[d]+=1,n.setMetadata("remaining_hints",c);try{const e=f?document.getElementById(f):null;if(e){const t=e.querySelector("."+d),n=null==t?void 0:t.querySelector(".hint-quantity");n&&(n.innerHTML=String(c[d]))}}catch(e){console.warn("Could not update remaining_hints UI after error:",e)}e.context.save(),(0,o.showDialog)({title:"Hint Request Error. Please try again later",buttons:[o.Dialog.createButton({label:"Dismiss",className:"jp-Dialog-button jp-mod-reject jp-mod-styled"})]}),t.exporters.forEach(n=>{t.publishEvent(e,{eventName:"HintRequestError",eventTime:Date.now(),eventInfo:{gradeId:f,requestId:null==i?void 0:i.message,promptGroup:a,prompt:r,uuid:s,preReflection:l,hintType:d}},n,!1)})};try{const i=await(0,c.q)("reflection",{method:"POST",body:JSON.stringify({request_id:h,reflection_question:r,reflection_answer:l})});if(console.log("Sent reflection",i),!i)throw new Error;{const i=setInterval(async()=>{const u=await(0,c.q)("check",{method:"POST",body:JSON.stringify({request_id:h})});0===u.status?console.log("loading"):1===u.status?(console.log("success"),clearInterval(i),((i,o)=>{const c=n.getMetadata("hintHistory")||[];n.setMetadata("hintHistory",[...c,{requestId:o,isGPT:!0,hintType:d,hintContent:i}]),t.exporters.forEach(n=>{t.publishEvent(e,{eventName:"HintRequestCompleted",eventTime:Date.now(),eventInfo:{hintContent:i,gradeId:f,requestId:o,promptGroup:a,prompt:r,uuid:s,preReflection:l,hintType:d}},n,!0)}),v(i),_.remove()})(JSON.parse(u.result).feedback,h)):2===u.status?(console.log("cancelled"),clearInterval(i),(n=>{y.remove(),b.remove(),(0,p.setBannerActive)(!1),(0,o.showDialog)({title:"Hint Request Cancelled",buttons:[o.Dialog.createButton({label:"Dismiss",className:"jp-Dialog-button jp-mod-reject jp-mod-styled"})]}),t.exporters.forEach(i=>{t.publishEvent(e,{eventName:"HintRequestCancelled",eventTime:Date.now(),eventInfo:{gradeId:f,requestId:n,promptGroup:a,prompt:r,uuid:s,preReflection:l,hintType:d}},i,!1)})})(h)):(clearInterval(i),x(new Error(h)))},1e3)}}catch(e){console.log(e),x(e)}};class m extends o.ReactWidget{constructor(){super()}getValue(){var e;return null===(e=this.node.querySelector('input[name="hint-info"]:checked'))||void 0===e?void 0:e.value}render(){return l().createElement("div",{className:"hint-info"},"You can request hints of the following types, but keep in mind you are limited in the number of hints you can request:",l().createElement("div",null,l().createElement("label",null,l().createElement("span",{className:"hint-request-bar-right-request-button planning"},"Planning")," ","A hint aimed at helping you to identify the steps needed to solve the question.")),l().createElement("div",null,l().createElement("label",null,l().createElement("span",{className:"hint-request-bar-right-request-button debugging"},"Debugging")," ","A hint aimed at helping you identify and fix a bug in your current program.")),l().createElement("div",null,l().createElement("label",null,l().createElement("span",{className:"hint-request-bar-right-request-button optimizing"},"Optimizing")," ","A hint aimed at helping you optimize your current program for better performance and readability.")))}}class g extends o.ReactWidget{constructor(){super()}getValue(){var e;return null===(e=this.node.querySelector('input[name="hint-consent"]:checked'))||void 0===e?void 0:e.value}render(){return l().createElement("div",{className:"hint-consent"},l().createElement("p",null,"The hinting features in this notebook are a part of a research prototype with the purpose of supporting your learning. It is completely optional to use these features, press cancel if you do not wish to use this prototype."),l().createElement("p",null,"When you request a hint this prototype takes your notebook, as well as other contextual information you might provide, and uses external/third party large language model services for analysis. Hints may be incorrect, incomplete, or misleading, and you are encouraged to critically evaluate responses before modifying your program."),l().createElement("p",null,"If you have questions about the system, contact the instructional team."))}}const f=JSON.parse('[{"question_id":"count_vowels","question_start_grade_id":"start_of_question_1","question_end_grade_id":"end_of_question_1"},{"question_id":"read_file","question_start_grade_id":"start_of_question_2","question_end_grade_id":"end_of_question_2"}]');function b(e){return null==e?null:Number(e)}function y(e){return{planning:b(e.plan),debugging:b(e.debug),optimizing:b(e.optimize)}}async function v(e){try{return await(0,c.q)(`quota_left?problem_id=${encodeURIComponent(e)}`,{method:"GET"})}catch(t){return console.warn("Failed to fetch quota_left for",e,t),null}}function _(e,t){const n=document.getElementById(e);if(!n)return;const i=(e,t)=>{const i=n.querySelector(`.${e}`),o=null==i?void 0:i.querySelector(".hint-quantity");o&&(o.textContent=String(null!=t?t:""))};"number"==typeof t.planning&&i("planning",t.planning),"number"==typeof t.debugging&&i("debugging",t.debugging),"number"==typeof t.optimizing&&i("optimizing",t.optimizing)}async function x(e){const[t,n]=await Promise.all([(0,c.q)(`query_all_hint?problem_id=${encodeURIComponent(e)}`),(0,c.q)(`query_all_feedback?problem_id=${encodeURIComponent(e)}`)]);return[...(t||[]).map(e=>{var t;return{id:e.request_id||e.id,ai_request_id:e.request_id||e.id,type:"ai",subtype:e.hint_type||e.type,created_at:e.returned_time||e.created_at||(new Date).toISOString(),content:e.returned_hint||e.hint||"",helpful:null!==(t=void 0!==e.is_hint_helpful?e.is_hint_helpful:e.helpful)&&void 0!==t?t:null}}),...(n||[]).map(e=>{var t;return{id:e.instructor_request_id||e.id,ai_request_id:e.ai_hint_request_id||void 0,type:"instructor",created_at:e.created_at||(new Date).toISOString(),content:e.instructor_feedback||e.feedback||"",instructor_helpful:null!==(t=void 0!==e.is_feedback_helpful?e.is_feedback_helpful:e.helpful)&&void 0!==t?t:null}})]}function q(e){const t=e.filter(e=>"ai"===e.type?null===e.helpful||void 0===e.helpful:null===e.instructor_helpful||void 0===e.instructor_helpful).sort((e,t)=>new Date(e.created_at).getTime()-new Date(t.created_at).getTime());return t.length?t[0]:null}const E=async(e,t)=>{var i;console.log("[HintBot] Activating extension for notebook:",e.title.label);const a=null===(i=e.content.model)||void 0===i?void 0:i.cells;if(console.log("[HintBot] Number of cells:",(null==a?void 0:a.length)||0),await async function(e){var t,n,i,o;const a=null===(t=e.content.model)||void 0===t?void 0:t.cells;if(!a)return;const r={};f.forEach(e=>{e&&e.question_start_grade_id&&e.question_id&&e.question_end_grade_id&&(r[e.question_start_grade_id]={question_id:e.question_id,question_end_grade_id:e.question_end_grade_id})});const s=[];for(let e=0;e<a.length;e++){const t=a.get(e),n=t.getMetadata("nbgrader");if(!n||!(null==n?void 0:n.grade_id))continue;const i=r[n.grade_id];i&&s.push({cell:t,idx:e,problem_id:i.question_id})}for(const e of s){const t=await v(e.problem_id);if(!t)continue;const a=y(t.left),r=e.cell.getMetadata("remaining_hints")||{},s={planning:"number"==typeof a.planning?a.planning:null!==(n=r.planning)&&void 0!==n?n:1,debugging:"number"==typeof a.debugging?a.debugging:null!==(i=r.debugging)&&void 0!==i?i:3,optimizing:"number"==typeof a.optimizing?a.optimizing:null!==(o=r.optimizing)&&void 0!==o?o:1};e.cell.setMetadata("remaining_hints",s),_(e.problem_id,s)}try{await e.context.save()}catch(e){}}(e),await async function(e,t){var i,o;const a=null===(i=e.content.model)||void 0===i?void 0:i.cells;if(a)for(let i=0;i<a.length;i++){const r=a.get(i),s=r.getMetadata("nbgrader");if(!s||!(null==s?void 0:s.grade_id))continue;const l={};f.forEach(e=>{e&&e.question_start_grade_id&&e.question_id&&e.question_end_grade_id&&(l[e.question_start_grade_id]={question_id:e.question_id,question_end_grade_id:e.question_end_grade_id})});const d=l[s.grade_id];if(!d)continue;const u=d.question_id,p=await x(u),m=p.map(e=>{var t;return{requestId:"ai"===e.type?e.id:null!==(t=e.ai_request_id)&&void 0!==t?t:e.id,instructorRequestId:"instructor"===e.type?e.id:void 0,isGPT:"ai"===e.type,hintType:"ai"===e.type?e.subtype||"plan":e.subtype||"debug",hintContent:e.content||0,helpful:e.helpful,instructor_helpful:e.instructor_helpful}});r.setMetadata("hintHistory",m);const g=q(p);if(g&&!document.getElementById("hint-banner"))if("ai"===g.type){const n="plan"===g.subtype?"planning":"debug"===g.subtype?"debugging":"optimizing";await h(e,t,r,i,"promptA","","","",n,String(g.id),{preloadedContent:g.content,skipNetwork:!0})}else{const a=document.createElement("div");a.id="hint-banner",r&&(null===(o=e.content.node.parentElement)||void 0===o||o.insertBefore(a,e.content.node));try{(await Promise.resolve().then(n.bind(n,62))).setBannerActive(!0)}catch(e){}a.innerHTML="";const s=document.createElement("div");s.id="hint-banner-title-row";const l=document.createElement("div");l.classList.add("hint-banner-title"),l.textContent="Instructor Feedback",s.appendChild(l),a.appendChild(s);const d=document.createElement("div");d.id="hint-banner-content";const u=document.createElement("p");u.textContent=g.content,d.appendChild(u),a.appendChild(d);const p=document.createElement("div");p.id="hint-banner-buttons-container";const h=document.createElement("div");h.id="hint-banner-buttons";const m=document.createElement("button");m.classList.add("hint-banner-button","hint-button-helpful"),m.innerText="ðŸ‘ Helpful";const f=document.createElement("button");f.classList.add("hint-banner-button","hint-button-unhelpful"),f.innerText="ðŸ‘Ž Unhelpful",h.appendChild(f),h.appendChild(m),p.appendChild(h),a.appendChild(p);const b=async e=>(0,c.q)("save_feedback_rating",{method:"POST",body:JSON.stringify({instructor_request_id:g.id,is_feedback_helpful:e})}),y=async()=>{var o;console.debug("[hint] refreshHistoryBar - earliest.id=",g.id);const a=r.getMetadata("hintHistory")||[],s=a.findIndex(e=>String(e.instructorRequestId)===String(g.id));if(console.debug("[hint] refreshHistoryBar - found idx=",s,"meta-before=",a),s>=0){a[s].instructor_helpful=null!==(o=a[s].instructor_helpful)&&void 0!==o?o:null,r.setMetadata("hintHistory",a);try{await e.context.save()}catch(e){console.warn("[hint] refreshHistoryBar - notebook save failed",e)}console.debug("[hint] refreshHistoryBar - meta-after=",a)}try{const o=await Promise.resolve().then(n.bind(n,954));await o.createHintHistoryBar(r,i,e,t)}catch(e){console.warn("[hint] refreshHistoryBar - createHintHistoryBar failed",e)}};m.onclick=async()=>{console.debug("[hint] helpful.onclick - earliest.id=",g.id);try{try{await b(!0),console.debug("[hint] saveFeedbackRating(true) succeeded for",g.id)}catch(e){console.error("[hint] saveFeedbackRating(true) failed",e)}const e=r.getMetadata("hintHistory")||[],t=e.findIndex(e=>String(e.instructorRequestId)===String(g.id));console.debug("[hint] helpful.onclick - found idx=",t,"meta-before=",e),t>=0&&(e[t].instructor_helpful=!0,r.setMetadata("hintHistory",e)),await y()}finally{try{(await Promise.resolve().then(n.bind(n,62))).setBannerActive(!1)}catch(e){}a.remove()}},f.onclick=async()=>{console.debug("[hint] unhelpful.onclick - earliest.id=",g.id);try{try{await b(!1),console.debug("[hint] saveFeedbackRating(false) succeeded for",g.id)}catch(e){console.error("[hint] saveFeedbackRating(false) failed",e)}const e=r.getMetadata("hintHistory")||[],t=e.findIndex(e=>String(e.instructorRequestId)===String(g.id));console.debug("[hint] unhelpful.onclick - found idx=",t,"meta-before=",e),t>=0&&(e[t].instructor_helpful=!1,r.setMetadata("hintHistory",e)),await y()}finally{try{(await Promise.resolve().then(n.bind(n,62))).setBannerActive(!1)}catch(e){}a.remove()}}}}}(e,t),void 0===e.model.getMetadata("firstTimeUsingHintbot"))try{const t=await(0,c.q)("has_ever_requested");t&&!0===t.ever_requested?e.model.setMetadata("firstTimeUsingHintbot",!1):e.model.setMetadata("firstTimeUsingHintbot",!0)}catch(t){e.model.setMetadata("firstTimeUsingHintbot",!0),console.warn("has_ever_requested check failed",t)}const s=async(n,i,a,s,l)=>{if(!0===e.model.getMetadata("firstTimeUsingHintbot")){const n=await(0,o.showDialog)({body:new g,buttons:[o.Dialog.cancelButton({label:"Cancel",className:"jp-mod-reject jp-mod-styled"}),o.Dialog.createButton({label:"Consent and request hint",className:"jp-mod-accept jp-mod-styled"})],hasClose:!1});if("Cancel"===n.button.label)return;t.exporters.forEach(i=>{t.publishEvent(e,{eventName:"FirstTimeUsingHintbot",eventTime:Date.now(),eventInfo:{status:n.button.label}},i,!1)}),e.model.setMetadata("firstTimeUsingHintbot",!1)}(async(e,t,n,i,a,s,l)=>{var u,p,m;const g=null===(u=n.getMetadata("nbgrader"))||void 0===u?void 0:u.grade_id,f=n.getMetadata("remaining_hints");if(document.getElementById("hint-banner"))(0,o.showDialog)({title:"Please review previous hint first.",buttons:[o.Dialog.createButton({label:"Dismiss",className:"jp-Dialog-button jp-mod-reject jp-mod-styled"})]}),t.exporters.forEach(n=>{t.publishEvent(e,{eventName:"HintAlreadyExists",eventTime:Date.now(),eventInfo:{gradeId:g}},n,!1)});else if(f[a]<1)(0,o.showDialog)({title:"No hint left for this question.",buttons:[o.Dialog.createButton({label:"Dismiss",className:"jp-Dialog-button jp-mod-reject jp-mod-styled"})]}),t.exporters.forEach(n=>{t.publishEvent(e,{eventName:"NotEnoughHint",eventTime:Date.now(),eventInfo:{gradeId:g}},n,!1)});else{const u=(0,r.v4)(),y="prompt",v=[{hintType:"planning",serverHintType:"plan",prompt:"Considering the program you wrote and the feedback you have received from the system so far, what do you think is a possible issue with the program plan and problem-solving steps?"},{hintType:"debugging",serverHintType:"debug",prompt:"Considering the program you wrote and the feedback you have received from the system so far, what do you think is a possible bug in the program?"},{hintType:"optimizing",serverHintType:"optimize",prompt:"Considering the program you wrote and the feedback you have received from the system so far, what do you think is a possible issue with the program in terms of performance and readability?"}],_=(null===(p=e.content.model)||void 0===p?void 0:p.toJSON)?e.content.model.toJSON():void 0,x=null===(m=e.content.model)||void 0===m?void 0:m.cells;let q="";if(x)for(let e=i+1;e<x.length;e++){console.log("cell",e);const t=x.get(e),n=t.getMetadata("nbgrader"),i=null==n?void 0:n.grade_id;if(i&&i===l){console.log("Reached assertion cell:",e,i);break}if("code"===t.type){const e=e=>{if(!e)return"";if(e.value&&"string"==typeof e.value.text)return e.value.text;if(e.model&&e.model.value&&"string"==typeof e.model.value.text)return e.model.value.text;const t=e.sharedModel||e.model&&e.model.sharedModel;if(t&&"function"==typeof t.getSource)try{return t.getSource()}catch(e){}return e.input&&e.input.model&&e.input.model.value&&"string"==typeof e.input.model.value.text?e.input.model.value.text:""};q+=(q?"\n":"")+(e(t)||"")}}console.log(`Requesting ${a} hint for ${s} with prompt:`,v.find(e=>e.hintType===a)[y]),console.log("Program: `",q,"`");const E=await(0,c.q)("hint",{method:"POST",body:JSON.stringify({hint_type:v.find(e=>e.hintType===a).serverHintType,problem_id:s||g,buggy_notebook_path:e.context.path,notebook_json:_,program:q})});console.log("create ticket",E);const w=null==E?void 0:E.request_id;f[a]-=1,n.setMetadata("remaining_hints",f);const C=s,T=C?document.getElementById(C):null;if(T){const e=T.querySelector("."+a),t=null==e?void 0:e.querySelector(".hint-quantity");t&&(t.textContent=String(f[a]))}e.context.save();const H=await(b=v.find(e=>e.hintType===a)[y],(0,o.showDialog)({title:"Reflection",body:new d(b),buttons:[o.Dialog.cancelButton({label:"Cancel",className:"jp-Dialog-button jp-mod-reject jp-mod-styled"}),o.Dialog.createButton({label:"Submit",className:"jp-Dialog-button jp-mod-accept jp-mod-styled"})],hasClose:!1}));t.exporters.forEach(n=>{t.publishEvent(e,{eventName:"Reflection",eventTime:Date.now(),eventInfo:{status:H.button.label,gradeId:g,uuid:u,hintType:a,promptGroup:y,prompt:v.find(e=>e.hintType===a)[y],reflection:H.value}},n,!1)}),"Cancel"!==H.button.label&&h(e,t,n,i,y,v.find(e=>e.hintType===a)[y],u,H.value,a,w)}var b})(e,t,n,i,a,s,l)},l=(n,i,a,r)=>{const l=document.createElement("div");l.classList.add("hint-request-bar");const d=document.createElement("div");d.classList.add("hint-request-bar-left");const c=document.createElement("div");c.classList.add("hint-request-bar-left-text"),d.appendChild(c),c.innerText="Request Hint";const u=document.createElement("button");u.classList.add("hint-request-bar-left-info-button"),u.innerText=" ? ",u.onclick=()=>{(0,o.showDialog)({body:new m,buttons:[o.Dialog.createButton({label:"Dismiss",className:"jp-Dialog-button jp-mod-reject jp-mod-styled"})]}),t.exporters.forEach(n=>{t.publishEvent(e,{eventName:"HintTypeReview",eventTime:Date.now()},n,!1)})},d.appendChild(u);const p=document.createElement("div");p.id=a,p.classList.add("hint-request-bar-right");const h=document.createElement("button");h.classList.add("hint-request-bar-right-request-button","planning"),h.onclick=()=>s(n,i,"planning",a,r);const g=document.createElement("button");g.classList.add("hint-request-bar-right-request-button","debugging"),g.onclick=()=>s(n,i,"debugging",a,r);const f=document.createElement("button");if(f.classList.add("hint-request-bar-right-request-button","optimizing"),f.onclick=()=>s(n,i,"optimizing",a,r),void 0===n.getMetadata("remaining_hints"))n.setMetadata("remaining_hints",{planning:0,debugging:0,optimizing:0}),h.innerHTML="Planning hint (<span class='hint-quantity'>0</span> left)",g.innerHTML="Debugging hint (<span class='hint-quantity'>0</span> left)",f.innerHTML="Optimizing hint (<span class='hint-quantity'>0</span> left)";else{const e=n.getMetadata("remaining_hints");h.innerHTML=`Planning hint (<span class='hint-quantity'>${e.planning}</span> left)`,g.innerHTML=`Debugging hint (<span class='hint-quantity'>${e.debugging}</span> left)`,f.innerHTML=`Optimizing hint (<span class='hint-quantity'>${e.optimizing}</span> left)`}return p.appendChild(h),p.appendChild(g),p.appendChild(f),l.appendChild(d),l.appendChild(p),l};if(a){const n={};console.log("[HintBot] Loading questions config:",f),f.forEach(e=>{e&&e.question_start_grade_id&&e.question_id&&e.question_end_grade_id&&(n[e.question_start_grade_id]={question_id:e.question_id,question_end_grade_id:e.question_end_grade_id})}),console.log("[HintBot] Question lookup built:",n);let i=1;for(let o=0;o<a.length;o++){const r=a.get(o).getMetadata("nbgrader"),s=null==r?void 0:r.grade_id;s&&console.log(`[HintBot] Cell ${o} has grade_id: ${s}`);const d=s?n[s]:void 0;if(d){console.log(`[HintBot] âœ“ Matched cell ${o} (grade_id: ${s}) as question start`),a.get(o).setMetadata("questionIndex",i),i+=1;const n=d.question_id,r=d.question_end_grade_id,c=l(a.get(o),o,n,r);e.content.widgets[o].node.appendChild(c),console.log(`[HintBot] âœ“ Hint bar added for question ${n} at cell ${o}`),await(0,u.p)(a.get(o),e,t),await(0,u.createHintHistoryBar)(a.get(o),o,e,t)}}console.log("[HintBot] Activation complete. Total questions found:",i-1)}},w={id:"hintbot:plugin",description:"A JupyterLab extension.",autoStart:!0,requires:[i.INotebookTracker,a.IJupyterLabPioneer],activate:async(e,t,n)=>{console.log("[HintBot] Plugin activated"),t.widgetAdded.connect(async(e,t)=>{console.log("[HintBot] Notebook widget added, waiting for reveal..."),await t.revealed,console.log("[HintBot] Notebook revealed, loading exporters..."),await n.loadExporters(t),console.log("[HintBot] Exporters loaded, activating hintbot..."),await E(t,n)})}}}}]);