# 开发守则

## 项目概述

### 核心定位
- **AICoding-backend** 是基于 MCP (Model Context Protocol) 的 AI 编码辅助后端系统
- 提供项目规则初始化、需求文档生成、PRP (Product Requirement Prompt) 等 AI 编码工具
- 使用 Python + uv 包管理，遵循模块化架构设计

### 技术栈
- **语言**: Python 3.13+
- **包管理**: uv (替代 pip/poetry)
- **框架**: MCP (Model Context Protocol) Server
- **项目结构**: 模块化分层架构 (prompts/tools/utils)

## 项目架构

### 目录结构规范
```
aicoding_backend/
├── prompts/          # 提示词模板和规则定义
│   ├── __init__.py
│   ├── init_project_rules.py      # 项目规则初始化
│   ├── init_requirements_doc.py   # 需求文档初始化
│   └── prp_base.md               # PRP基础模板
├── tools/            # MCP工具实现
│   ├── __init__.py
│   ├── init_project_rules.py      # 工具实现
│   └── init_requirements_doc.py   # 工具实现
├── utils/            # 通用工具函数
│   ├── __init__.py
│   ├── file_reader.py
│   ├── file_utils.py
│   ├── git_info.py
│   ├── loader.py
│   ├── log.py
│   ├── template.py
│   ├── user_info.py
│   └── version.py
└── main.py          # MCP服务器入口
```

### 模块职责
- **prompts/**: 存储所有 AI 提示词模板和规则定义
- **tools/**: MCP 工具的具体实现逻辑
- **utils/**: 通用工具函数，供 tools 调用
- **main.py**: MCP 服务器配置和工具注册

## 代码规范

### 文件命名规范
- 使用下划线命名法: `file_name.py`
- 工具文件以功能命名: `init_project_rules.py`
- 提示词文件以用途命名: `init_requirements_doc.py`

### 函数命名规范
- 工具函数使用动词开头: `init_project_rules()`, `generate_prp()`
- 工具类使用驼峰命名: `GeneratePrpParam`, `ExecutePrpArgs`
- 私有函数以下划线开头: `_internal_function()`

### 导入规范
- 标准库导入在前
- 第三方库导入在中
- 本地模块导入在后
- 避免循环导入，使用延迟导入解决依赖

## 功能实现规范

### MCP 工具开发规范
1. **工具参数定义**: 使用 Pydantic 模型定义参数结构
2. **错误处理**: 所有工具必须包含 try-except 异常处理
3. **日志记录**: 使用 `utils/log.py` 记录工具执行日志
4. **返回值**: 统一返回结构化数据，便于前端解析

### PRP 生成规范
1. **模板加载**: 从 `prompts/` 目录加载基础模板
2. **参数注入**: 使用字符串替换方式注入用户参数
3. **文件输出**: 生成到 `PRPs/` 目录，文件名包含时间戳
4. **格式验证**: 确保生成的 PRP 符合 Markdown 规范

### 需求文档规范
1. **模板结构**: 遵循固定的需求文档模板格式
2. **内容完整性**: 必须包含用户故事、验收标准、功能描述
3. **文件路径**: 生成到 `.joycode/specs/{project_name}/` 目录
4. **版本管理**: 支持需求文档的版本迭代和更新

## 框架/插件使用规范

### MCP Server 配置
- **服务器定义**: 在 `main.py` 中统一注册所有工具
- **工具命名**: 使用功能描述性名称，避免缩写
- **参数验证**: 所有输入参数必须经过验证
- **超时设置**: 设置合理的工具执行超时时间

### 文件操作规范
- **路径处理**: 使用 `pathlib.Path` 处理文件路径
- **编码统一**: 所有文本文件使用 UTF-8 编码
- **文件锁**: 并发操作时考虑文件锁机制
- **备份机制**: 修改重要文件前创建备份

## 关键文件交互规范

### 多文件联动修改规则
1. **修改 `main.py` 时**:
   - 必须同步检查 `mcp-config.json` 工具注册
   - 更新 `pyproject.toml` 中的依赖版本

2. **修改工具实现时**:
   - 同步更新对应的 `prompts/` 模板文件
   - 检查 `utils/` 中的依赖函数是否需要调整
   - 更新工具使用文档

3. **新增工具时**:
   - 在 `tools/` 创建实现文件
   - 在 `prompts/` 创建对应模板
   - 在 `main.py` 注册工具
   - 更新 `README.md` 文档

### 配置文件同步
- **mcp-config.json**: 工具注册配置，必须与代码同步
- **pyproject.toml**: 项目依赖和元数据，版本更新时同步
- **README.md**: 功能文档，新增工具时必须更新

## AI 决策规范

### 模糊情况处理优先级
1. **功能定位**: 优先保持现有功能，不添加新特性
2. **代码风格**: 遵循现有代码风格，保持一致性
3. **错误处理**: 优先处理错误，再优化性能
4. **用户反馈**: 优先处理用户明确指出的问题

### 代码修改决策树
```
是否需要修改现有功能？
├── 是 → 检查是否影响其他模块？
│   ├── 是 → 先创建备份，再逐步修改
│   └── 否 → 直接修改，添加测试
└── 否 → 是否需要新增功能？
    ├── 是 → 遵循项目架构规范
    └── 否 → 保持现状
```

## 禁止事项

### **严格禁止**
- ❌ 修改 `.python-version` 文件中的 Python 版本
- ❌ 删除 `uv.lock` 文件中的依赖锁定
- ❌ 在工具函数中使用全局变量
- ❌ 直接修改用户项目文件而不创建备份
- ❌ 忽略异常处理，让错误直接抛出

### **需要审批**
- ⚠️ 修改核心架构文件 (`main.py`, `__init__.py`)
- ⚠️ 添加新的外部依赖
- ⚠️ 修改现有工具的行为逻辑
- ⚠️ 删除已有功能模块

### **最佳实践**
- ✅ 使用类型注解提高代码可读性
- ✅ 添加详细的函数文档字符串
- ✅ 创建单元测试验证工具功能
- ✅ 使用日志记录重要操作
- ✅ 保持代码简洁，单一职责原则