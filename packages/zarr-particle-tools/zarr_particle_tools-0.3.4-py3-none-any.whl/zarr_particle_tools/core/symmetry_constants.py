from functools import cache

import numpy as np
from scipy.spatial.transform import Rotation as R


@cache
def i_transforms(n: int) -> np.ndarray:
    eulers = []
    if n == 1:
        eulers = EULERS_I1_ZYZ_DEG
    elif n == 2:
        eulers = EULERS_I2_ZYZ_DEG
    elif n == 3:
        eulers = EULERS_I3_ZYZ_DEG
    elif n == 4:
        eulers = EULERS_I4_ZYZ_DEG
    elif n == 5:
        raise NotImplementedError("I5/I5H symmetry is not supported by RELION, so not implemented.")
    else:
        raise ValueError("Invalid n for I symmetry. Must be 1, 2, 3, or 4.")

    transforms = R.from_euler("ZYZ", eulers, degrees=True).as_matrix()
    T = np.repeat(np.eye(4)[None, :, :], transforms.shape[0], axis=0)
    T[:, :3, :3] = transforms
    return T


EULERS_I1_ZYZ_DEG = np.array(
    [
        [0.0, 0.0, 0.0],
        [0.0, 180.0, 180.0],
        [-110.90515752579, 59.9999998969243, 69.0948424742101],
        [-148.282525693054, 107.999999754271, 31.7174743069463],
        [148.282525693054, 107.999999754271, -31.7174743069463],
        [110.90515752579, 59.9999998969243, -69.09484247421],
        [-69.0948433655256, 120.0, 69.0948433655256],
        [110.905156634474, 120.0, -110.905156634474],
        [69.0948424742101, 120.000000103076, -69.0948424742101],
        [31.7174743069463, 72.0000002457288, -31.7174743069463],
        [148.282525693054, 72.0000002457288, -148.282525693054],
        [-31.7174743069463, 72.0000002457288, 31.7174743069463],
        [-148.282525693054, 72.0000002457288, 148.282525693054],
        [-110.90515752579, 120.000000103076, 110.90515752579],
        [-148.282526432995, 144.000000645002, -31.7174741467176],
        [180.0, 90.0, -90.0],
        [-148.282526692251, 36.0000008907308, -148.282525532825],
        [-69.0948442568412, 60.0000001030757, 110.905158417106],
        [69.0948433655256, 60.0, -110.905156634474],
        [-90.0, 90.0, 0.0],
        [-31.717474467175, 36.0000008907308, -31.7174733077492],
        [148.28252501662, 36.0000001518687, 148.282525951428],
        [180.0, 90.0, 90.0],
        [148.282525434679, 143.99999990614, 31.7174745653209],
        [-31.7174758228925, 108.000000304773, 148.282525113885],
        [31.7174735670047, 35.999999354998, 31.7174741467176],
        [-148.282525693054, 35.9999995085424, 31.7174743069463],
        [148.282525274995, 71.9999996024025, 31.7174747250051],
        [90.0, 90.0, 0.0],
        [31.7174743069463, 144.000000491458, -31.7174743069463],
        [-31.7174749833797, 143.999999848131, -148.282525951428],
        [31.7174730499191, 108.000000493133, -148.282525434343],
        [0.0, 90.0, 90.0],
        [31.717474467175, 143.999999109269, 148.282526692251],
        [148.282525693054, 144.000000491458, -148.282525693054],
        [-148.282525274995, 71.9999996024025, -31.7174747250051],
        [148.282525693054, 35.9999995085424, -31.7174743069463],
        [31.7174747250051, 108.000000397598, 31.7174747250051],
        [-31.7174743069463, 144.000000491458, 31.7174743069463],
        [-31.7174747250051, 108.000000397598, -31.7174747250051],
        [0.0, 90.0, -90.0],
        [90.0, 90.0, 180.0],
        [148.282525274995, 108.000000397598, 148.282525274995],
        [-148.282525693054, 144.000000491458, 148.282525693054],
        [-148.282525274995, 108.000000397598, -148.282525274995],
        [-90.0, 90.0, 180.0],
        [-110.905157147652, 119.999999948462, -69.09484247421],
        [-110.905157147652, 60.0000000515379, -110.90515752579],
        [-31.7174743962125, 36.0000001228644, 148.282525693054],
        [-69.09484247421, 60.0000000515379, -69.0948428523478],
        [31.7174743069463, 36.0000001228644, -148.282525603787],
        [110.905156710004, 60.0000001667801, 110.905157644812],
        [110.905157147652, 119.999999948462, 69.0948424742101],
        [0.0, 0.0, -180.0],
        [69.0948424033337, 59.9999999803143, 69.0948429048343],
        [31.7174733080857, 72.0000003412645, 148.282525533706],
        [69.0948415090843, 120.000000386235, 110.905157891347],
        [-69.0948419156658, 120.000001261347, -110.905157168164],
        [-31.7174748852338, 72.0000011381353, -148.282525336197],
        [0.0, 180.0, 0.0],
    ]
)

EULERS_I2_ZYZ_DEG = np.array(
    [
        [0.0, 0.0, 0.0],
        [0.0, 0.0, -180.0],
        [-58.2825256251327, 36.0000001392108, 121.717474374867],
        [-20.9051574751647, 60.0000002473639, 159.094842524835],
        [20.9051574751647, 60.0000002473639, -159.094842524835],
        [58.2825256251327, 36.0000001392108, -121.717474374867],
        [58.2825257320584, 35.9999985706056, 58.2825257320584],
        [121.717474267942, 35.9999985706056, 121.717474267942],
        [-58.2825256251327, 36.0000001392108, -58.2825256251327],
        [-20.9051574751647, 60.0000002473639, -20.9051574751647],
        [159.094842524835, 60.0000002473639, 159.094842524835],
        [20.9051574751647, 60.0000002473639, 20.9051574751647],
        [-159.094842524835, 60.0000002473639, -159.094842524835],
        [-121.717474374867, 36.0000001392108, -121.717474374867],
        [58.282525798142, 71.9999987098164, 121.717474440951],
        [90.0, 90.0, 180.0],
        [121.717475251868, 71.9999994675322, -121.717475730054],
        [121.717476607055, 35.9999993283213, -58.2825278178709],
        [-121.717474267942, 35.9999985706056, 58.2825257320584],
        [0.0, 90.0, 90.0],
        [-58.2825242699461, 71.9999994675321, 58.282524748132],
        [-121.717474611707, 72.0000002252479, 121.717474284403],
        [-90.0, 90.0, 180.0],
        [-58.2825256251327, 72.0000002784217, -121.717474374867],
        [159.094842910016, 59.9999990390182, -20.9051586323872],
        [58.282525798142, 71.9999987098164, -58.2825255590491],
        [-58.2825258619724, 108.000000364459, 121.717474138028],
        [-20.9051574751647, 120.000000494728, -159.094842524835],
        [0.0, 90.0, -90.0],
        [-58.2825258619724, 108.000000364459, -58.2825258619724],
        [-121.717474611707, 72.0000002252479, -58.2825257155974],
        [-159.094841821902, 60.000000014839, 20.9051556824369],
        [90.0, 90.0, 0.0],
        [121.717475730054, 71.9999994675321, 58.282524748132],
        [121.717474138028, 108.000000364459, 121.717474138028],
        [20.9051574751646, 120.000000494728, 159.094842524835],
        [58.2825258619723, 108.000000364459, -121.717474138028],
        [20.9051574751646, 120.000000494728, -20.9051574751647],
        [58.2825258619723, 108.000000364459, 58.2825258619723],
        [-20.9051574751647, 120.000000494728, 20.9051574751646],
        [-90.0, 90.0, 0.0],
        [180.0, 90.0, 90.0],
        [-159.094842524835, 120.000000494728, 159.094842524835],
        [-121.717474138028, 108.000000364459, -121.717474138028],
        [159.094842524835, 120.000000494728, -159.094842524835],
        [180.0, 90.0, -90.0],
        [58.2825253011281, 144.000000182229, 121.717474138028],
        [121.717474698872, 144.000000182229, -121.717474138028],
        [121.717474552497, 108.000000043019, -58.2825254787578],
        [-58.2825258619723, 144.000000182229, 58.2825253011281],
        [-121.717474521242, 108.000000043019, 58.282525447503],
        [-121.717475141296, 144.000000450496, 121.717473754813],
        [-58.2825253011281, 144.000000182229, -121.717474138028],
        [0.0, 180.0, 180.0],
        [58.2825259857311, 144.000000155642, -58.2825252419182],
        [159.094841752794, 119.999999286382, 20.9051563179421],
        [121.717473858093, 143.999998613624, 58.2825251942024],
        [-121.71747299992, 143.999999424514, -58.2825254521235],
        [-159.094842139654, 119.999999286382, -20.9051582472062],
        [0.0, 180.0, 0.0],
    ]
)


EULERS_I3_ZYZ_DEG = np.array(
    [
        [0.0, 0.0, 0.0],
        [180.0, 63.43494911696, 0.0],
        [0.0, 0.0, 72.0],
        [0.0, 0.0, 144.0],
        [0.0, 0.0, -144.0],
        [0.0, 0.0, -72.0],
        [108.000001380815, 63.4349483519268, 0.0],
        [180.0, 63.4349483519268, 71.9999986191853],
        [-108.0, 63.43494911696, 0.0],
        [-36.0, 63.43494911696, 0.0],
        [180.0, 63.43494911696, 144.0],
        [36.0, 63.43494911696, 0.0],
        [180.0, 63.43494911696, -144.0],
        [180.0, 63.43494911696, -72.0],
        [108.000001380815, 63.4349483519268, 72.0],
        [108.000001380815, 63.4349483519268, 144.0],
        [108.000001380815, 63.4349483519268, -144.0],
        [108.000001380815, 63.4349483519268, -72.0],
        [-108.000000213944, 63.4349477925855, 71.9999999555933],
        [36.0, 63.4349483519268, 71.9999986191853],
        [-36.0, 63.4349483519268, 71.9999986191853],
        [-108.0, 63.43494911696, 144.0],
        [-108.0, 63.43494911696, -144.0],
        [-108.0, 63.43494911696, -72.0],
        [143.999999574347, 116.565050307979, -36.0000008939971],
        [36.0000004828474, 63.4349487682392, -71.9999993593611],
        [-36.0, 63.43494911696, 144.0],
        [-36.0, 63.43494911696, -144.0],
        [-36.0, 63.43494911696, -72.0],
        [-72.0000002796467, 116.565051652841, -36.0000002796467],
        [-144.000000279647, 116.565051652841, -36.0000002796467],
        [-144.000000316034, 116.565051759854, 35.999998659792],
        [72.000000380002, 116.565051033917, -35.9999997768945],
        [144.000000223105, 116.565051156867, 35.9999995103797],
        [143.999999720353, 116.565051652841, 107.999999720353],
        [36.0, 63.43494911696, 144.0],
        [36.0, 63.43494911696, -144.0],
        [0.0, 116.565051652841, -36.0000002796467],
        [72.0000002796467, 116.565051652841, 36.0000002796467],
        [0.0, 116.565051652841, 36.0000002796467],
        [-71.9999997203533, 116.565051652841, 36.0000002796467],
        [-144.000000223105, 116.565050910967, 107.999999619998],
        [-143.999999720353, 116.565051652841, 180.0],
        [-143.999999720353, 116.565051652841, -107.999999720353],
        [143.999999720353, 116.565051652841, 180.0],
        [143.999999720353, 116.565051652841, -108.000000279647],
        [72.000000380002, 116.565051033917, 108.000000223105],
        [72.000000380002, 116.565051033917, 180.0],
        [72.000000380002, 116.565051033917, -107.999999776895],
        [0.0, 116.565050910967, 107.999999619998],
        [-72.0000002231055, 116.565050910967, 107.999999619998],
        [-71.9999997203533, 116.565051652841, 180.0],
        [-71.9999997203533, 116.565051652841, -107.999999720353],
        [0.0, 116.565050307979, 180.0],
        [0.0, 116.565050307979, -108.000000893997],
        [0.0, 180.0, -144.000000397221],
        [0.0, 180.0, -72.0000012287511],
        [0.0, 180.0, 71.9999998639627],
        [0.0, 180.0, 143.999999251696],
        [0.0, 180.0, 0.0],
    ]
)


EULERS_I4_ZYZ_DEG = np.array(
    [
        [0.0, 0.0, 0.0],
        [0.0, 63.43494911696, 180.0],
        [-72.0000001697982, 63.4349490014584, 107.999999830202],
        [-36.0000002747393, 116.565051644492, 143.999999725261],
        [36.0000002747393, 116.565051644492, -143.999999725261],
        [72.0000001697982, 63.4349490014584, -107.999999830202],
        [0.0, 63.4349483519268, 108.000001380815],
        [71.9999986191853, 63.4349483519268, 180.0],
        [0.0, 63.4349491133945, -108.000000002454],
        [0.0, 63.4349491076255, -36.0000000015165],
        [144.0, 63.4349491076255, 180.0],
        [0.0, 63.4349491076255, 36.0000000015165],
        [-144.0, 63.4349491076255, 180.0],
        [-72.0, 63.4349491133945, 180.0],
        [36.0000002123795, 116.565050303805, 144.000000552884],
        [107.999999607105, 116.565050526179, -144.000000895082],
        [144.000001038702, 63.4349487117352, -108.000001511523],
        [0.0, 0.0, 71.9999996939287],
        [0.0, 0.0, -71.9999991421232],
        [-35.9999991049178, 116.565050725116, 72.0000003928953],
        [-71.9999984884773, 63.4349485887851, 35.9999989612978],
        [-144.000000442552, 63.434948820342, 107.999999895996],
        [-108.000000546267, 116.565051463376, 143.999999659466],
        [-36.0000000638093, 116.565051644492, -143.999999938176],
        [0.0, 0.0, 143.999999142123],
        [71.9999999518021, 63.4349475916129, -36.0000002130065],
        [-108.000000714838, 116.565050998542, 71.9999992856306],
        [0.0, 180.0, -143.999999850841],
        [36.0000003393068, 116.565051463376, -71.9999994544916],
        [-36.0000002698319, 116.565051637297, -72.0000002707691],
        [-72.000000160631, 63.4349489991508, -108.000000174706],
        [0.0, 0.0, -144.000000857877],
        [71.9999999456679, 63.4349475901867, 35.9999997900264],
        [72.0000002090363, 63.434947789701, 108.000000054332],
        [107.999999729231, 116.565051636584, 143.999999730168],
        [0.0, 180.0, 143.999999849065],
        [108.000000714838, 116.565050998542, -71.9999992856306],
        [36.0000002698319, 116.565051636584, 0.0],
        [36.0000002698319, 116.565051637297, 72.0000002707691],
        [-36.0000002698319, 116.565051636584, 0.0],
        [-72.000000160631, 63.434948997997, -36.0000001737684],
        [144.000000209974, 63.434947789701, 108.000000054332],
        [180.0, 116.565051636584, 143.999999730168],
        [-107.999999729231, 116.565051636584, -143.999999730168],
        [180.0, 116.565051636584, -143.999999730168],
        [-143.999999826232, 63.4349489995074, -107.999999839369],
        [0.0, 180.0, 72.0000001566528],
        [180.0, 116.56505164865, -72.0000008357748],
        [144.000000300286, 63.4349485300419, -36.0000012387685],
        [-107.999999164225, 116.565051648073, 0.0],
        [-143.999998761232, 63.4349486031441, 35.9999996997142],
        [180.0, 116.565050885452, 71.9999994539124],
        [0.0, 180.0, -71.9999996092366],
        [180.0, 116.565051227849, 0.0],
        [108.000000977759, 116.565050991676, 0.0],
        [143.999999142123, 63.4349491076255, 36.0000000015165],
        [108.000000037205, 116.565050725116, 72.0000003928953],
        [-108.000000546267, 116.565051463376, -72.0000011984105],
        [-143.999999998484, 63.4349491076255, -36.0000008578768],
        [0.0, 180.0, 0.0],
    ]
)
