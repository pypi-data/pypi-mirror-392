# @fraiseql:view
# @fraiseql:description Localized aggregation of {{ name }}
# @fraiseql:pattern localization/locale_aggregation

CREATE OR REPLACE VIEW {{ schema }}.{{ name }} AS
SELECT
    -- Localized group-by field
    COALESCE(
        current_locale.{{ group_by_field }},
        fallback_locale.{{ group_by_field }}
    ) AS {{ group_by_field }},

    -- Aggregations
    {% for agg in aggregations %}
    {{ agg.function }}({{ table }}.{{ agg.field }}) AS {{ agg.metric }},
    {% endfor %}

    -- Metadata
    {{ current_locale_source }}::text AS locale

FROM {{ schema }}.{{ table }}
INNER JOIN {{ schema }}.{{ translation_table }} fallback_locale
    ON fallback_locale.{{ fk_field }} = {{ table }}.{{ pk_field }}
    AND fallback_locale.locale = '{{ fallback_locale }}'
LEFT JOIN {{ schema }}.{{ translation_table }} current_locale
    ON current_locale.{{ fk_field }} = {{ table }}.{{ pk_field }}
    AND current_locale.locale = {{ current_locale_source }}::text
WHERE {{ table }}.deleted_at IS NULL
GROUP BY
    COALESCE(current_locale.{{ group_by_field }}, fallback_locale.{{ group_by_field }}),
    {{ current_locale_source }}::text;

COMMENT ON VIEW {{ schema }}.{{ name }} IS
    'Localized aggregation of {{ name }} grouped by {{ group_by_field }} with {{ fallback_locale }} fallback.';