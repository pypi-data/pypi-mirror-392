{# stdlib/queries/temporal/scd_type2.sql.jinja2 #}
# @fraiseql:view
# @fraiseql:description SCD Type 2 view for {{ name }}
# @fraiseql:pattern temporal/scd_type2

CREATE OR REPLACE VIEW {{ schema }}.{{ name }} AS
SELECT
    -- Surrogate key (unique per version)
    {% if surrogate_key_field %}
    {{ surrogate_key_field }},
    {% else %}
    ROW_NUMBER() OVER (ORDER BY {{ pk_field }}, {{ effective_date_field }}) AS surrogate_key,
    {% endif %}

    -- Natural key (same across versions)
    {{ pk_field }} AS natural_key,

    -- All entity attributes
    t.*,

    -- SCD Type 2 metadata
    {{ effective_date_field | default('effective_date') }},
    {{ end_date_field | default('end_date') }},
    {{ is_current_field | default('is_current') }},

    -- Version tracking
    ROW_NUMBER() OVER (
        PARTITION BY {{ pk_field }}
        ORDER BY {{ effective_date_field | default('effective_date') }}
    ) AS {{ version_number_field | default('version_number') }},

    -- Validity range
    tsrange({{ effective_date_field | default('effective_date') }}, {{ end_date_field | default('end_date') }}, '[)') AS valid_period

FROM {{ schema }}.{{ table }} t
WHERE t.deleted_at IS NULL;

-- Unique constraint on current version
CREATE UNIQUE INDEX IF NOT EXISTS idx_{{ name }}_current_unique
    ON {{ schema }}.{{ name }}({{ pk_field }})
    WHERE {{ is_current_field | default('is_current') }} = true;

-- Temporal index
CREATE INDEX IF NOT EXISTS idx_{{ name }}_temporal_lookup
    ON {{ schema }}.{{ name }} USING GIST ({{ pk_field }}, valid_period);

COMMENT ON VIEW {{ schema }}.{{ name }} IS
    'SCD Type 2 view for {{ name }} with full version history. Query current: WHERE is_current = true';