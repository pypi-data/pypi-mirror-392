-- @fraiseql:view
-- @fraiseql:description Aggregates {{ target_entity.name }} items for each {{ source_entity.name }} via junction tables
CREATE OR REPLACE VIEW {{ schema }}.{{ view_name }} AS
SELECT
    {{ source_entity.alias }}.{{ source_entity.pk_field }},
    jsonb_agg(
        jsonb_build_object(
{%- for field in aggregation_fields %}
            '{{ field.name }}', {{ field.expression }}{% if not loop.last %},{% endif %}
{%- endfor %}
        )
        {% if order_by %}ORDER BY {{ order_by|join(', ') }}{% endif %}
    ) AS {{ aggregate_into }}
FROM {{ source_entity.schema }}.{{ source_entity.table }} {{ source_entity.alias }}
{%- for junction in junction_tables %}
INNER JOIN {{ junction.schema }}.{{ junction.table }} {{ junction.alias }}
    ON {{ junction.alias }}.{{ junction.left_key }} = {% if loop.first %}{{ source_entity.alias }}.{{ source_entity.pk_field }}{% else %}{{ loop.previtem.alias }}.{{ loop.previtem.right_key }}{% endif %}
{%- endfor %}
INNER JOIN {{ target_entity.schema }}.{{ target_entity.table }} {{ target_entity.alias }}
    ON {{ target_entity.alias }}.{{ target_entity.pk_field }} = {{ junction_tables[-1].alias }}.{{ junction_tables[-1].right_key }}
WHERE {{ source_entity.alias }}.deleted_at IS NULL
{%- for junction in junction_tables %}
  AND {{ junction.alias }}.deleted_at IS NULL
{%- endfor %}
  AND {{ target_entity.alias }}.deleted_at IS NULL
{%- if source_entity.is_multi_tenant %}
  AND {{ source_entity.alias }}.tenant_id = CURRENT_SETTING('app.current_tenant_id')::uuid
{%- endif %}
GROUP BY {{ source_entity.alias }}.{{ source_entity.pk_field }};

-- Index for parent entity lookup
CREATE INDEX IF NOT EXISTS idx_{{ view_name }}_{{ source_entity.pk_field|replace('pk_', '') }}
    ON {{ schema }}.{{ view_name }}({{ source_entity.pk_field }});