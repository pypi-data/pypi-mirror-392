pattern: crud_update
version: 1.0
description: "Update entity with partial updates and identifier recalculation"
author: SpecQL Team

parameters:
  - name: partial_updates
    type: boolean
    default: true
    description: "Enable partial updates (CASE expressions)"

  - name: track_updated_fields
    type: boolean
    default: false
    description: "Track which fields were updated"

template: |
  steps:
    # Update the entity
    - update: {{ entity.name }}
      partial_updates: {{ partial_updates }}
      track_updated_fields: {{ track_updated_fields }}

    {% if entity.identifier %}
    # Recalculate identifier
    - raw_sql: "PERFORM {{ entity.schema }}.recalcid_{{ entity.name | lower }}(v_{{ entity.name | lower }}_id, auth_tenant_id, auth_user_id);"
    {% endif %}

    {% if entity.projections %}
    {% for projection in entity.projections %}
    # Refresh projection
    - refresh_table_view: {{ projection.name }}
    {% endfor %}
    {% endif %}

examples:
  - name: update_contract
    description: "Update contract with partial updates"
    config:
      partial_updates: true
      track_updated_fields: true