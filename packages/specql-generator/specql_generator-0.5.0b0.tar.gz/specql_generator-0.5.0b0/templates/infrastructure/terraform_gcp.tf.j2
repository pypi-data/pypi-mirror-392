{# Terraform GCP Template #}

# ============================================================================
# Provider Configuration
# ============================================================================
terraform {
  required_providers {
    google = {
      source  = "hashicorp/google"
      version = "~> 5.0"
    }
  }
}

provider "google" {
  project = var.project_id
  region  = "{{ _map_region(infrastructure.region) }}"
}

{%- if infrastructure.compute %}

# ============================================================================
# Compute Resources (Instance Group Manager)
# ============================================================================

# Instance Template
resource "google_compute_instance_template" "{{ infrastructure.name }}" {
  name_prefix  = "{{ infrastructure.name }}-"
  machine_type = "{{ _map_instance_type(infrastructure.compute) }}"

  {%- if infrastructure.container %}
  metadata_startup_script = <<-EOF
    #!/bin/bash
    # Install Docker
    apt-get update
    apt-get install -y docker.io

    # Run container
    docker run -d \
      -p {{ infrastructure.container.port }}:{{ infrastructure.container.port }} \
      {%- for key, value in infrastructure.container.environment.items() %}
      -e {{ key }}={{ value }} \
      {%- endfor %}
      {%- if infrastructure.container.secrets %}
      {%- for key, value in infrastructure.container.secrets.items() %}
      -e {{ key }}={{ value }} \
      {%- endfor %}
      {%- endif %}
      {{ infrastructure.container.image }}:{{ infrastructure.container.tag }}
  EOF
  {%- endif %}

  disk {
    source_image = "cos-cloud/cos-stable"
    auto_delete  = true
    boot         = true
  }

  network_interface {
    network = google_compute_network.{{ infrastructure.name }}.name
    subnetwork = google_compute_subnetwork.public.name
  }

  {%- if infrastructure.load_balancer %}
  tags = ["{{ infrastructure.name }}-backend"]
  {%- endif %}

  labels = {
    name = "{{ infrastructure.name }}"
  }
}

# Instance Group Manager
resource "google_compute_instance_group_manager" "{{ infrastructure.name }}" {
  name = "{{ infrastructure.name }}-igm"
  zone = "{{ _map_region(infrastructure.region) }}-a"

  version {
    instance_template = google_compute_instance_template.{{ infrastructure.name }}.id
    name              = "primary"
  }

  base_instance_name = "{{ infrastructure.name }}"
  target_size        = {{ infrastructure.compute.instances }}

  {%- if infrastructure.load_balancer %}
  named_port {
    name = "http"
    port = {{ infrastructure.container.port if infrastructure.container else 80 }}
  }
  {%- endif %}
}

# Auto Scaling
resource "google_compute_autoscaler" "{{ infrastructure.name }}" {
  name   = "{{ infrastructure.name }}-autoscaler"
  zone   = "{{ _map_region(infrastructure.region) }}-a"
  target = google_compute_instance_group_manager.{{ infrastructure.name }}.id

  autoscaling_policy {
    max_replicas    = {{ infrastructure.compute.max_instances }}
    min_replicas    = {{ infrastructure.compute.min_instances }}
    cooldown_period = 60

    cpu_utilization {
      target = {{ (infrastructure.compute.cpu_target / 100.0) }}
    }
  }
}
{%- endif %}

{%- if infrastructure.database %}

# ============================================================================
# Database (Cloud SQL)
# ============================================================================

resource "google_sql_database_instance" "{{ infrastructure.name }}" {
  name             = "{{ infrastructure.name }}-db"
  database_version = "{{ _map_database_engine(infrastructure.database.type) }}"
  region           = "{{ _map_region(infrastructure.region) }}"

  settings {
    tier = "{{ infrastructure.database.instance_class or 'db-f1-micro' }}"

    disk_size = {{ infrastructure.database.storage|replace('GB', '') }}
    disk_type = "{{ 'PD_SSD' if infrastructure.database.storage_type == 'gp3' else 'PD_HDD' }}"

    {%- if infrastructure.database.iops %}
    disk_autoresize = false
    {%- endif %}

    backup_configuration {
      enabled    = {{ infrastructure.database.backup_enabled|lower }}
      start_time = "03:00"
    }

    maintenance_window {
      day  = 7  # Sunday
      hour = 3
    }

    ip_configuration {
      ipv4_enabled = {{ infrastructure.database.publicly_accessible|lower }}
      authorized_networks {
        name  = "allow-app"
        value = "{{ infrastructure.network.vpc_cidr }}"
      }
    }
  }

  deletion_protection = true
}

resource "google_sql_database" "{{ infrastructure.name }}" {
  name     = "{{ infrastructure.name|replace('-', '_') }}"
  instance = google_sql_database_instance.{{ infrastructure.name }}.name
}

resource "random_password" "db_password" {
  length  = 32
  special = true
}

resource "google_sql_user" "{{ infrastructure.name }}" {
  name     = "admin"
  instance = google_sql_database_instance.{{ infrastructure.name }}.name
  password = random_password.db_password.result
}

# Store password in Secret Manager
resource "google_secret_manager_secret" "{{ infrastructure.name }}" {
  secret_id = "{{ infrastructure.name }}-db-password"

  replication {
    automatic = true
  }
}

resource "google_secret_manager_secret_version" "{{ infrastructure.name }}" {
  secret = google_secret_manager_secret.{{ infrastructure.name }}.id
  secret_data = random_password.db_password.result
}
{%- endif %}

{%- if infrastructure.load_balancer %}

# ============================================================================
# Load Balancer
# ============================================================================

resource "google_compute_global_address" "{{ infrastructure.name }}" {
  name = "{{ infrastructure.name }}-lb-ip"
}

resource "google_compute_backend_service" "{{ infrastructure.name }}" {
  name        = "{{ infrastructure.name }}-backend"
  protocol    = "HTTP"
  port_name   = "http"
  timeout_sec = 10

  backend {
    group = google_compute_instance_group_manager.{{ infrastructure.name }}.instance_group
  }

  health_checks = [google_compute_http_health_check.{{ infrastructure.name }}.id]
}

resource "google_compute_http_health_check" "{{ infrastructure.name }}" {
  name               = "{{ infrastructure.name }}-health-check"
  request_path       = "{{ infrastructure.load_balancer.health_check_path }}"
  check_interval_sec = {{ infrastructure.load_balancer.health_check_interval }}
  timeout_sec        = 5
  healthy_threshold  = {{ infrastructure.load_balancer.healthy_threshold }}
  unhealthy_threshold = {{ infrastructure.load_balancer.unhealthy_threshold }}
}

resource "google_compute_url_map" "{{ infrastructure.name }}" {
  name            = "{{ infrastructure.name }}-url-map"
  default_service = google_compute_backend_service.{{ infrastructure.name }}.id
}

resource "google_compute_target_http_proxy" "{{ infrastructure.name }}" {
  name    = "{{ infrastructure.name }}-http-proxy"
  url_map = google_compute_url_map.{{ infrastructure.name }}.id
}

resource "google_compute_global_forwarding_rule" "{{ infrastructure.name }}" {
  name       = "{{ infrastructure.name }}-forwarding-rule"
  target     = google_compute_target_http_proxy.{{ infrastructure.name }}.id
  port_range = "80"
  ip_address = google_compute_global_address.{{ infrastructure.name }}.address
}

{%- if infrastructure.load_balancer.https %}
resource "google_compute_ssl_certificate" "{{ infrastructure.name }}" {
  name_prefix = "{{ infrastructure.name }}-ssl-"
  private_key = file("private_key.pem")
  certificate = file("certificate.pem")
}

resource "google_compute_target_https_proxy" "{{ infrastructure.name }}" {
  name             = "{{ infrastructure.name }}-https-proxy"
  url_map          = google_compute_url_map.{{ infrastructure.name }}.id
  ssl_certificates = [google_compute_ssl_certificate.{{ infrastructure.name }}.id]
}

resource "google_compute_global_forwarding_rule" "https" {
  name       = "{{ infrastructure.name }}-https-forwarding-rule"
  target     = google_compute_target_https_proxy.{{ infrastructure.name }}.id
  port_range = "443"
  ip_address = google_compute_global_address.{{ infrastructure.name }}.address
}
{%- endif %}
{%- endif %}

# ============================================================================
# Networking (VPC, Subnets, etc.)
# ============================================================================

resource "google_compute_network" "{{ infrastructure.name }}" {
  name                    = "{{ infrastructure.name }}-vpc"
  auto_create_subnetworks = false
}

resource "google_compute_subnetwork" "public" {
  name          = "{{ infrastructure.name }}-public"
  ip_cidr_range = "{{ infrastructure.network.public_subnets[0] }}"
  region        = "{{ _map_region(infrastructure.region) }}"
  network       = google_compute_network.{{ infrastructure.name }}.id
}

resource "google_compute_subnetwork" "private" {
  name          = "{{ infrastructure.name }}-private"
  ip_cidr_range = "{{ infrastructure.network.private_subnets[0] }}"
  region        = "{{ _map_region(infrastructure.region) }}"
  network       = google_compute_network.{{ infrastructure.name }}.id
}

resource "google_compute_router" "{{ infrastructure.name }}" {
  name    = "{{ infrastructure.name }}-router"
  region  = "{{ _map_region(infrastructure.region) }}"
  network = google_compute_network.{{ infrastructure.name }}.id
}

{%- if infrastructure.network.enable_nat_gateway %}
resource "google_compute_router_nat" "{{ infrastructure.name }}" {
  name                               = "{{ infrastructure.name }}-nat"
  router                             = google_compute_router.{{ infrastructure.name }}.name
  region                             = "{{ _map_region(infrastructure.region) }}"
  nat_ip_allocate_option             = "AUTO_ONLY"
  source_subnetwork_ip_ranges_to_nat = "ALL_SUBNETWORKS_ALL_IP_RANGES"
}
{%- endif %}

# Firewall Rules
resource "google_compute_firewall" "{{ infrastructure.name }}-allow-http" {
  name    = "{{ infrastructure.name }}-allow-http"
  network = google_compute_network.{{ infrastructure.name }}.name

  allow {
    protocol = "tcp"
    ports    = ["80", "443"]
  }

  source_ranges = ["0.0.0.0/0"]
  target_tags   = ["{{ infrastructure.name }}-backend"]
}

{%- if infrastructure.database %}
resource "google_compute_firewall" "{{ infrastructure.name }}-allow-db" {
  name    = "{{ infrastructure.name }}-allow-db"
  network = google_compute_network.{{ infrastructure.name }}.name

  allow {
    protocol = "tcp"
    ports    = ["5432"]
  }

  source_ranges = ["{{ infrastructure.network.vpc_cidr }}"]
  target_tags   = ["{{ infrastructure.name }}-db"]
}
{%- endif %}

# ============================================================================
# Variables
# ============================================================================

variable "project_id" {
  description = "GCP Project ID"
  type        = string
}

# ============================================================================
# Outputs
# ============================================================================

{%- if infrastructure.load_balancer %}
output "load_balancer_ip" {
  value = google_compute_global_address.{{ infrastructure.name }}.address
}
{%- endif %}

{%- if infrastructure.database %}
output "database_connection_name" {
  value = google_sql_database_instance.{{ infrastructure.name }}.connection_name
}

output "database_password_secret" {
  value = google_secret_manager_secret.{{ infrastructure.name }}.name
}
{%- endif %}

output "vpc_id" {
  value = google_compute_network.{{ infrastructure.name }}.id
}