{# ============================================================================ #}
{# Jinja2 Template: Trinity Helper Functions #}
{# ============================================================================ #}
-- ============================================================================
-- Trinity Helper: {{ entity.schema }}.{{ entity.name | lower }}_{{ function_type }}()
-- ============================================================================
-- Converts between UUID and INTEGER representations
-- ============================================================================

{%- if function_type == "pk" %}

-- UUID/identifier/text → INTEGER (pk)
{%- if is_tenant_specific %}
CREATE OR REPLACE FUNCTION {{ entity.schema }}.{{ entity.name | lower }}_pk(p_identifier TEXT, p_tenant_id UUID)
{%- else %}
CREATE OR REPLACE FUNCTION {{ entity.schema }}.{{ entity.name | lower }}_pk(p_identifier TEXT)
{%- endif %}
RETURNS INTEGER
LANGUAGE sql STABLE
AS $$
    SELECT {{ entity.pk_column }}
    FROM {{ entity.schema }}.{{ entity.table_name }}
    WHERE (id::TEXT = p_identifier
        OR {{ entity.pk_column }}::TEXT = p_identifier)
{%- if is_tenant_specific %}
      AND tenant_id = p_tenant_id
{%- endif %}
    LIMIT 1;
$$;

COMMENT ON FUNCTION {{ entity.schema }}.{{ entity.name | lower }}_pk(TEXT, UUID) IS
'Trinity Pattern: Resolve entity identifier to internal INTEGER primary key.
Accepts UUID, text identifier, or integer pk and returns {{ entity.pk_column }}.';
{%- elif function_type == "id" %}

-- INTEGER (pk) → UUID
CREATE OR REPLACE FUNCTION {{ entity.schema }}.{{ entity.name | lower }}_id(p_pk INTEGER)
RETURNS UUID
LANGUAGE sql STABLE
AS $$
    SELECT id FROM {{ entity.schema }}.{{ entity.table_name }}
    WHERE {{ entity.pk_column }} = p_pk;
$$;

COMMENT ON FUNCTION {{ entity.schema }}.{{ entity.name | lower }}_id(INTEGER) IS
'Trinity Pattern: Convert internal INTEGER primary key to external UUID identifier.';
{%- endif %}
