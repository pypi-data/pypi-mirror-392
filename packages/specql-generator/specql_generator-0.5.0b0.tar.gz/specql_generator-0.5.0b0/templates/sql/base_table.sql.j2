{#
   Base Table (tb_) Template
   Generates normalized storage tables with full Trinity pattern

   Variables:
   - entity: Entity object
   - schema: Schema name
   - table_name: tb_{entity_name}
   - fields: List of Field objects
   - foreign_keys: List of ForeignKey objects
   - indexes: List of Index objects
#}

-- ============================================================================
-- Base Table: {{ schema }}.{{ table_name }}
-- Entity: {{ entity.name }}
-- Trinity Pattern: pk_{{ entity.name|lower }}, id, tenant_id
-- ============================================================================

CREATE TABLE {{ schema }}.{{ table_name }} (
    -- ========================================================================
    -- Trinity Pattern: INTEGER Primary Key (Performance)
    -- ========================================================================
    pk_{{ entity.name|lower }} INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

    -- ========================================================================
    -- Trinity Pattern: UUID Identifier (Stable Public API)
    -- ========================================================================
    id UUID DEFAULT gen_random_uuid() NOT NULL,

{%- if entity.schema_type == 'multi_tenant' %}
    -- ========================================================================
    -- Trinity Pattern: Multi-Tenancy
    -- ========================================================================
    tenant_id UUID NOT NULL,

{% endif %}
    -- ========================================================================
    -- Business Fields
    -- ========================================================================
{%- for field in fields %}
    {{ field.name }} {{ field.sql_type }}{% if field.required %} NOT NULL{% endif %}{% if field.default %} DEFAULT {{ field.default }}{% endif %},
{%- endfor %}

    -- ========================================================================
    -- Trinity Pattern: Audit Trail (Full 6-field audit)
    -- ========================================================================
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    created_by UUID,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_by UUID,
    deleted_at TIMESTAMPTZ,
    deleted_by UUID,

    -- ========================================================================
    -- Constraints
    -- ========================================================================
    CONSTRAINT {{ table_name }}_id_key UNIQUE (id)
{%- for constraint in constraints %}
    ,CONSTRAINT {{ constraint.name }} {{ constraint.definition }}
{%- endfor %}
{%- for fk in foreign_keys %}
    ,CONSTRAINT {{ fk.name }} FOREIGN KEY ({{ fk.column }}) REFERENCES {{ fk.ref_schema }}.{{ fk.ref_table }}({{ fk.ref_column }})
{%- endfor %}
);

-- ============================================================================
-- Comments
-- ============================================================================
COMMENT ON TABLE {{ schema }}.{{ table_name }} IS '{{ entity.description }}

Trinity Pattern: Normalized base table
- pk_{{ entity.name|lower }}: INTEGER primary key for performance
- id: UUID for stable external references
- Full audit trail (created_at, updated_at, deleted_at + by fields)
{% if entity.schema_type == 'multi_tenant' %}- Multi-tenant with tenant_id{% endif %}

@fraiseql:entity
name: {{ entity.name }}
trinity: base_table';

{%- for field in fields %}
COMMENT ON COLUMN {{ schema }}.{{ table_name }}.{{ field.name }} IS '{{ field.description }}
{% if field.field_type == 'ref' %}
@fraiseql:field
name: {{ field.name }}
type: {{ field.ref_entity }}!
relation: many_to_one{% endif %}';
{%- endfor %}

-- ============================================================================
-- Indexes
-- ============================================================================

{%- if entity.schema_type == 'multi_tenant' %}
-- Multi-tenancy index
CREATE INDEX idx_{{ table_name }}_tenant_id ON {{ schema }}.{{ table_name }}(tenant_id);
{% endif %}

{%- for index in indexes %}
-- {{ index.comment }}
CREATE INDEX {{ index.name }} ON {{ schema }}.{{ table_name }}({{ index.columns|join(', ') }}){% if index.method %} USING {{ index.method }}{% endif %};
{%- endfor %}

{%- for fk in foreign_keys %}
-- Foreign key index
CREATE INDEX idx_{{ table_name }}_{{ fk.column }} ON {{ schema }}.{{ table_name }}({{ fk.column }});
{%- endfor %}