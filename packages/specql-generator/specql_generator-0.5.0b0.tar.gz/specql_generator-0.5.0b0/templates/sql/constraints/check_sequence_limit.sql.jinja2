-- Check identifier sequence limit to prevent excessive duplicates
CREATE OR REPLACE FUNCTION {{ schema }}.check_{{ entity_lower }}_sequence_limit()
RETURNS TRIGGER AS $$
DECLARE
    v_max_duplicates INTEGER := 100;  -- Configurable limit
BEGIN
    IF NEW.sequence_number > v_max_duplicates THEN
        RAISE EXCEPTION
            'Identifier sequence limit exceeded (>% duplicates): "%"',
            v_max_duplicates,
            NEW.identifier
        USING
            ERRCODE = '23514',
            HINT = FORMAT(
                'Current variant: %s#%s. Use more descriptive naming to reduce collisions.',
                NEW.identifier,
                NEW.sequence_number
            );
    ELSIF NEW.sequence_number > (v_max_duplicates * 0.5) THEN
        -- Warning at 50%
        RAISE WARNING
            'High identifier duplication: % has % variants (limit: %)',
            NEW.identifier,
            NEW.sequence_number,
            v_max_duplicates;
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_check_{{ entity_lower }}_sequence_limit
    BEFORE INSERT OR UPDATE OF sequence_number
    ON {{ schema }}.tb_{{ entity_lower }}
    FOR EACH ROW
    EXECUTE FUNCTION {{ schema }}.check_{{ entity_lower }}_sequence_limit();

COMMENT ON FUNCTION {{ schema }}.check_{{ entity_lower }}_sequence_limit() IS
'Safety trigger: Prevents excessive identifier duplication.

Limits the number of duplicate identifiers (e.g., "item#1", "item#2", etc.)
to prevent naming conflicts and encourage more descriptive identifiers.

Configurable limit: 100 duplicates max, warning at 50 duplicates.

Used by: BEFORE INSERT/UPDATE on sequence_number';