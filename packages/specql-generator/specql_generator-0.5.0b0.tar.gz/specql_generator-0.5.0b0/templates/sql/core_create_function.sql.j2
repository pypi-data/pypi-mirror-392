-- ============================================================================
-- CORE LOGIC: {{ entity.schema }}.create_{{ entity.name | lower }}
-- Business Rules & Data Manipulation
-- ============================================================================
CREATE OR REPLACE FUNCTION {{ entity.schema }}.create_{{ entity.name | lower }}(
    auth_tenant_id UUID,
    input_data {{ composite_type }},
    input_payload JSONB,
    auth_user_id UUID
) RETURNS app.mutation_result
LANGUAGE plpgsql
AS $$
DECLARE
    v_{{ entity.name | lower }}_id UUID := gen_random_uuid();
    v_{{ entity.name | lower }}_pk INTEGER;
{%- for resolution in fk_resolutions %}
    {{ resolution.variable }} INTEGER;
{%- endfor %}
BEGIN
    -- === VALIDATION ===
{%- for validation in validations %}
    IF {{ validation.check }} THEN
        RETURN app.log_and_return_mutation(
            auth_tenant_id,
            auth_user_id,
            '{{ entity.name | lower }}',
            '00000000-0000-0000-0000-000000000000'::UUID,
            'NOOP',
            '{{ validation.error }}',
            ARRAY['{{ validation.field }}']::TEXT[],
            '{{ validation.message }}',
            NULL, NULL,
            jsonb_build_object('reason', 'validation_{{ validation.field }}_null')
        );
    END IF;
{%- endfor %}

    -- === UUID â†’ INTEGER RESOLUTION (Trinity Helpers) ===
{%- for resolution in fk_resolutions %}
    IF input_data.{{ resolution.input_field }} IS NOT NULL THEN
        {{ resolution.variable }} := {{ resolution.helper_call }};

        IF {{ resolution.variable }} IS NULL THEN
            RETURN app.log_and_return_mutation(
                auth_tenant_id,
                auth_user_id,
                '{{ entity.name | lower }}',
                '00000000-0000-0000-0000-000000000000'::UUID,
                'NOOP',
                 'validation:reference_not_found',
                ARRAY['{{ resolution.input_field }}']::TEXT[],
                 'Referenced {{ resolution.target_entity | lower }} not found',
                NULL, NULL,
                jsonb_build_object('{{ resolution.input_field }}', input_data.{{ resolution.input_field }})
            );
        END IF;
    END IF;
{%- endfor %}

    -- === BUSINESS LOGIC: INSERT ===
    INSERT INTO {{ entity.schema }}.{{ entity.table_name }} (
{%- for column in fields.columns %}
        {{ column }}{{ "," if not loop.last else "" }}
{%- endfor %}
    ) VALUES (
{%- for value in fields.insert_values %}
        {{ value }}{{ "," if not loop.last else "" }}
{%- endfor %}
    )
    RETURNING pk_{{ entity.name | lower }} INTO v_{{ entity.name | lower }}_pk;

    -- === AUDIT & RETURN ===
    RETURN app.log_and_return_mutation(
        auth_tenant_id,
        auth_user_id,
        '{{ entity.name | lower }}',
        v_{{ entity.name | lower }}_id,
        'INSERT',
        'success',
        ARRAY(SELECT jsonb_object_keys(input_payload)),
        '{{ entity.name }} created successfully',
        (SELECT row_to_json(t.*) FROM {{ entity.schema }}.{{ entity.table_name }} t WHERE t.id = v_{{ entity.name | lower }}_id)::JSONB,
        NULL
    );
END;
$$;