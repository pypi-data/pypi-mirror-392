# Domain Pattern Entity
# Stores reusable patterns for business logic

entity: DomainPattern
schema: pattern_library
description: "Registry of reusable domain patterns including universal patterns, domain-specific patterns, and entity templates."

# Organization (Numbering System)
organization:
  table_code: "012001"
  domain: core
  subdomain: patterns
  entity: domain_pattern

# Identifier format: pattern_id is human-readable (e.g., "email_validation")
identifier_template: "{pattern_id}"

fields:
  # Primary identifier
  pattern_id:
    type: text
    required: true
    unique: true
    description: "Unique pattern identifier (e.g., 'email_validation', 'audit_trail')"
    validation:
      pattern: "^[a-z][a-z0-9_]*$"
      max_length: 100

  # Pattern metadata
  pattern_name:
    type: text
    required: true
    description: "Human-readable pattern name"
    validation:
      max_length: 200

  category:
    type: enum
    values: [validation, audit, security, workflow, notification, data_quality, performance]
    required: true
    description: "Pattern category for organization"

  description:
    type: text
    required: true
    description: "Detailed pattern description and usage instructions"

  pattern_type:
    type: enum
    values: [universal, domain, entity_template]
    required: true
    description: |
      Pattern scope level:
      - universal: Applies to any domain (e.g., soft_delete)
      - domain: Specific to a domain (e.g., crm_contact_validation)
      - entity_template: Complete entity template (e.g., customer_entity_template)

  # Pattern definition
  fields_json:
    type: json
    required: true
    description: "Pattern field definitions in JSON format"
    validation:
      schema: pattern_fields_schema

  actions_json:
    type: json
    description: "Pattern actions in JSON format (optional)"

  # Usage tracking
  usage_count:
    type: integer
    required: true
    default: 0
    description: "Number of times pattern has been applied to entities"
    validation:
      min: 0

  popularity_score:
    type: decimal
    required: true
    default: 0.0
    description: "Calculated popularity score (0.0-1.0)"
    validation:
      min: 0.0
      max: 1.0
      precision: 3

  # Relationships
  parent_domain:
    type: ref(Domain)
    description: "Domain this pattern belongs to (for domain-specific patterns)"

  created_by_user:
    type: text
    description: "User who created this pattern"

  # Versioning
  version:
    type: text
    required: true
    default: "1.0.0"
    description: "Pattern version (semver format)"
    validation:
      pattern: '^\d+\.\d+\.\d+$'

  # Status
  status:
    type: enum
    values: [draft, active, deprecated]
    required: true
    default: active
    description: "Pattern lifecycle status"

# Indexes
indexes:
  - fields: [pattern_id]
    name: idx_domain_patterns_pattern_id
  - fields: [category]
    name: idx_domain_patterns_category
  - fields: [pattern_type]
    name: idx_domain_patterns_type
  - fields: [parent_domain]
    name: idx_domain_patterns_domain
  - fields: [status]
    name: idx_domain_patterns_status
  - fields: [usage_count]
    name: idx_domain_patterns_usage
    description: "For finding popular patterns"

# Post-processing notes:
# - Add embedding vector(384) column for semantic search
#   ALTER TABLE pattern_library.domain_patterns ADD COLUMN embedding vector(384);
# - Create IVFFlat index on embedding
#   CREATE INDEX idx_domain_patterns_embedding ON pattern_library.domain_patterns
#   USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);
# - Embeddings generated by EmbeddingService after pattern creation