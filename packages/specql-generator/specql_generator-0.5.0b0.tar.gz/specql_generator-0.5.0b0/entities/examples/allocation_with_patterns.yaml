# Example: Allocation entity using multi-entity pattern
# Demonstrates coordinated operations across multiple entities

entity: Allocation
schema: tenant
description: "Machine allocation to locations with automatic inventory management"

fields:
  machine_id: uuid!
  location_id: uuid!
  allocation_type: enum(stock, production, maintenance)
  status: enum(active, completed, cancelled)
  allocated_at: timestamptz!
  completed_at: timestamptz
  notes: text

# Multi-entity pattern for complex allocation workflow
actions:
  - name: allocate_to_stock
    pattern: multi_entity/coordinated_update
    description: "Allocate machine to stock location with automatic inventory tracking"
    config:
      primary_entity: Machine
      operations:
        # Get or create stock location
        - action: get_or_create
          entity: Location
          where:
            code: 'STOCK'
            tenant_id: $auth_tenant_id
          create_if_missing:
            code: STOCK
            name: Stock Location
            location_type: warehouse
            active: true
          store_as: stock_location_id

        # Create allocation record
        - action: insert
          entity: Allocation
          values:
            machine_id: $input_data.machine_id
            location_id: $stock_location_id
            allocation_type: stock
            status: active
            allocated_at: NOW()
            notes: $input_data.notes
          store_as: allocation_id

        # Update machine status and location
        - action: update
          entity: Machine
          where:
            id: $input_data.machine_id
            tenant_id: $auth_tenant_id
          values:
            status: in_stock
            location_id: $stock_location_id
            current_allocation_id: $allocation_id

        # Log allocation event
        - action: insert
          entity: AllocationEvent
          values:
            allocation_id: $allocation_id
            event_type: allocated_to_stock
            event_data: $input_payload
            tenant_id: $auth_tenant_id

      refresh_projections:
        - machine_projection
        - allocation_projection
        - location_projection

  - name: allocate_to_production
    pattern: multi_entity/coordinated_update
    description: "Allocate machine to production line"
    config:
      primary_entity: Machine
      operations:
        # Verify production line exists and is active
        - action: update
          entity: Allocation
          where:
            machine_id: $input_data.machine_id
            status: active
            tenant_id: $auth_tenant_id
          values:
            status: completed
            completed_at: NOW()

        # Create new production allocation
        - action: insert
          entity: Allocation
          values:
            machine_id: $input_data.machine_id
            location_id: $input_data.production_line_id
            allocation_type: production
            status: active
            allocated_at: NOW()
            notes: $input_data.notes
          store_as: new_allocation_id

        # Update machine status
        - action: update
          entity: Machine
          where:
            id: $input_data.machine_id
            tenant_id: $auth_tenant_id
          values:
            status: allocated
            location_id: $input_data.production_line_id
            current_allocation_id: $new_allocation_id

      refresh_projections:
        - machine_projection
        - allocation_projection