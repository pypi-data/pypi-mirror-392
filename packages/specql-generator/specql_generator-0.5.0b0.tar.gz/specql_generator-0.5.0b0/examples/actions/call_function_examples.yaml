# Call Function Action Examples

entity: Order
schema: ecommerce
actions:
  # Simple function call with return value
  - name: process_order_total
    parameters:
      - name: order_id
        type: uuid
    returns: numeric
    steps:
      - declare:
          name: subtotal
          type: numeric
      - declare:
          name: tax_amount
          type: numeric
      - declare:
          name: final_total
          type: numeric

      - call_function:
          function: ecommerce.calculate_subtotal
          arguments:
            order_id: $order_id
          returns: subtotal

      - call_function:
          function: ecommerce.calculate_tax
          arguments:
            amount: $subtotal
            tax_rate: 0.0825
          returns: tax_amount

      - assign: final_total = subtotal + tax_amount
      - return: final_total

  # Function composition with multiple calls
  - name: complex_order_processing
    parameters:
      - name: order_id
        type: uuid
      - name: customer_id
        type: uuid
    returns: json
    steps:
      - declare:
          name: subtotal
          type: numeric
      - declare:
          name: tax_amount
          type: numeric
      - declare:
          name: discount_amount
          type: numeric
      - declare:
          name: shipping_cost
          type: numeric
      - declare:
          name: final_total
          type: numeric

      # Calculate base amounts
      - call_function:
          function: ecommerce.calculate_subtotal
          arguments:
            order_id: $order_id
          returns: subtotal

      # Apply customer-specific discount
      - call_function:
          function: ecommerce.calculate_customer_discount
          arguments:
            customer_id: $customer_id
            order_amount: $subtotal
          returns: discount_amount

      # Calculate tax on discounted amount
      - call_function:
          function: ecommerce.calculate_tax
          arguments:
            amount: $subtotal - $discount_amount
            tax_rate: 0.0825
          returns: tax_amount

      # Calculate shipping
      - call_function:
          function: ecommerce.calculate_shipping
          arguments:
            order_id: $order_id
            subtotal: $subtotal
          returns: shipping_cost

      # Final calculation
      - assign: final_total = subtotal - discount_amount + tax_amount + shipping_cost
      - return:
          subtotal: $subtotal
          discount: $discount_amount
          tax: $tax_amount
          shipping: $shipping_cost
          total: $final_total

  # Function call for side effects (no return value)
  - name: send_order_confirmation
    parameters:
      - name: order_id
        type: uuid
      - name: customer_email
        type: text
    steps:
      - declare:
          name: order_details
          type: json

      # Get order details
      - call_function:
          function: ecommerce.get_order_details
          arguments:
            order_id: $order_id
          returns: order_details

      # Send confirmation email (side effect only)
      - call_function:
          function: notification.send_order_confirmation
          arguments:
            email: $customer_email
            order_details: $order_details

      # Log the notification
      - call_function:
          function: audit.log_notification
          arguments:
            type: "order_confirmation"
            reference_id: $order_id
            recipient: $customer_email