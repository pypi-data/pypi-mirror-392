# Test Contact Integration
# Generated by SpecQL v0.5.0-beta
# End-to-end integration tests for Contact entity

import pytest
from uuid import UUID
import psycopg


class TestContactIntegration:
    @pytest.fixture
    def clean_db(self):
        """Clean database for each test"""
        conn = psycopg.connect(
            "postgresql://test:test@localhost/test_db", autocommit=False
        )

        # Clean up any existing test data
        with conn.cursor() as cur:
            cur.execute("DELETE FROM crm.tb_contact")
            cur.execute("DELETE FROM app.user")
            cur.execute("DELETE FROM crm.tenant")

        # Insert test tenant and user
        with conn.cursor() as cur:
            cur.execute(
                """
                INSERT INTO crm.tenant (id, name) VALUES (%s, %s)
            """,
                (UUID("01232122-0000-0000-2000-000000000001"), "Test Tenant"),
            )

            cur.execute(
                """
                INSERT INTO app.user (id, tenant_id, email) VALUES (%s, %s, %s)
            """,
                (
                    UUID("01232122-0000-0000-2000-000000000002"),
                    UUID("01232122-0000-0000-2000-000000000001"),
                    "test@example.com",
                ),
            )

        conn.commit()
        yield conn
        conn.close()

    def test_create_contact_success(self, clean_db):
        """Test creating Contact via app.create function"""
        tenant_id = UUID("01232122-0000-0000-2000-000000000001")
        user_id = UUID("01232122-0000-0000-2000-000000000002")

        with clean_db.cursor() as cur:
            cur.execute(
                "SELECT app.create_contact(%s::UUID, %s::UUID, %s::JSONB)",
                (
                    tenant_id,
                    user_id,
                    {
                        "email": "john.doe@example.com",
                        "first_name": "John",
                        "last_name": "Doe",
                        "status": "lead",
                    },
                ),
            )
            result = cur.fetchone()[0]

        assert result["status"] == "success"
        assert result["object_data"]["id"] is not None
        assert result["object_data"]["email"] == "john.doe@example.com"
        assert result["object_data"]["first_name"] == "John"
        assert result["object_data"]["status"] == "lead"

    def test_create_duplicate_email_fails(self, clean_db):
        """Test that duplicate emails are rejected"""
        tenant_id = UUID("01232122-0000-0000-2000-000000000001")
        user_id = UUID("01232122-0000-0000-2000-000000000002")

        # First contact
        with clean_db.cursor() as cur:
            cur.execute(
                "SELECT app.create_contact(%s::UUID, %s::UUID, %s::JSONB)",
                (
                    tenant_id,
                    user_id,
                    {
                        "email": "duplicate@example.com",
                        "first_name": "First",
                        "last_name": "Contact",
                        "status": "lead",
                    },
                ),
            )
            result1 = cur.fetchone()[0]
            assert result1["status"] == "success"

        # Duplicate should fail
        with clean_db.cursor() as cur:
            cur.execute(
                "SELECT app.create_contact(%s::UUID, %s::UUID, %s::JSONB)",
                (
                    tenant_id,
                    user_id,
                    {
                        "email": "duplicate@example.com",
                        "first_name": "Second",
                        "last_name": "Contact",
                        "status": "lead",
                    },
                ),
            )
            result2 = cur.fetchone()[0]
            assert result2["status"] == "failed"
            assert "duplicate" in result2["error_message"].lower()

    def test_create_contact_validation_errors(self, clean_db):
        """Test validation errors during contact creation"""
        tenant_id = UUID("01232122-0000-0000-2000-000000000001")
        user_id = UUID("01232122-0000-0000-2000-000000000002")

        # Test invalid email
        with clean_db.cursor() as cur:
            cur.execute(
                "SELECT app.create_contact(%s::UUID, %s::UUID, %s::JSONB)",
                (
                    tenant_id,
                    user_id,
                    {
                        "email": "not-an-email",
                        "first_name": "Test",
                        "last_name": "User",
                        "status": "lead",
                    },
                ),
            )
            result = cur.fetchone()[0]
            assert result["status"] == "failed"
            assert "email" in result["error_message"].lower()

        # Test missing first name
        with clean_db.cursor() as cur:
            cur.execute(
                "SELECT app.create_contact(%s::UUID, %s::UUID, %s::JSONB)",
                (
                    tenant_id,
                    user_id,
                    {
                        "email": "test@example.com",
                        "last_name": "User",
                        "status": "lead",
                    },
                ),
            )
            result = cur.fetchone()[0]
            assert result["status"] == "failed"
            assert "first_name" in result["error_message"].lower()

    def test_full_contact_lifecycle(self, clean_db):
        """Test complete contact lifecycle: create, read, update, delete"""
        tenant_id = UUID("01232122-0000-0000-2000-000000000001")
        user_id = UUID("01232122-0000-0000-2000-000000000002")

        # Create contact
        with clean_db.cursor() as cur:
            cur.execute(
                "SELECT app.create_contact(%s::UUID, %s::UUID, %s::JSONB)",
                (
                    tenant_id,
                    user_id,
                    {
                        "email": "lifecycle@example.com",
                        "first_name": "Lifecycle",
                        "last_name": "Test",
                        "status": "lead",
                    },
                ),
            )
            create_result = cur.fetchone()[0]
            contact_id = create_result["object_data"]["id"]

        assert create_result["status"] == "success"

        # Read contact
        with clean_db.cursor() as cur:
            cur.execute(
                "SELECT app.get_contact(%s::UUID, %s::UUID)", (tenant_id, contact_id)
            )
            read_result = cur.fetchone()[0]

        assert read_result["status"] == "success"
        assert read_result["object_data"]["email"] == "lifecycle@example.com"
        assert read_result["object_data"]["status"] == "lead"

        # Update contact
        with clean_db.cursor() as cur:
            cur.execute(
                "SELECT app.update_contact(%s::UUID, %s::UUID, %s::UUID, %s::JSONB)",
                (
                    tenant_id,
                    user_id,
                    contact_id,
                    {"first_name": "Updated", "phone": "+1-555-0123"},
                ),
            )
            update_result = cur.fetchone()[0]

        assert update_result["status"] == "success"

        # Verify update
        with clean_db.cursor() as cur:
            cur.execute(
                "SELECT app.get_contact(%s::UUID, %s::UUID)", (tenant_id, contact_id)
            )
            verify_result = cur.fetchone()[0]

        assert verify_result["object_data"]["first_name"] == "Updated"
        assert verify_result["object_data"]["phone"] == "+1-555-0123"

        # Qualify lead
        with clean_db.cursor() as cur:
            cur.execute(
                "SELECT app.qualify_lead(%s::UUID, %s::UUID, %s::UUID)",
                (tenant_id, user_id, contact_id),
            )
            qualify_result = cur.fetchone()[0]

        assert qualify_result["status"] == "success"

        # Verify status change
        with clean_db.cursor() as cur:
            cur.execute(
                "SELECT app.get_contact(%s::UUID, %s::UUID)", (tenant_id, contact_id)
            )
            final_result = cur.fetchone()[0]

        assert final_result["object_data"]["status"] == "qualified"

        # Delete contact
        with clean_db.cursor() as cur:
            cur.execute(
                "SELECT app.delete_contact(%s::UUID, %s::UUID, %s::UUID)",
                (tenant_id, user_id, contact_id),
            )
            delete_result = cur.fetchone()[0]

        assert delete_result["status"] == "success"

        # Verify contact is deleted (soft delete)
        with clean_db.cursor() as cur:
            cur.execute(
                "SELECT app.get_contact(%s::UUID, %s::UUID)", (tenant_id, contact_id)
            )
            deleted_result = cur.fetchone()[0]

        assert deleted_result["status"] == "failed"

    def test_contact_actions_validation(self, clean_db):
        """Test business logic validation in actions"""
        tenant_id = UUID("01232122-0000-0000-2000-000000000001")
        user_id = UUID("01232122-0000-0000-2000-000000000002")

        # Create qualified contact
        with clean_db.cursor() as cur:
            cur.execute(
                "SELECT app.create_contact(%s::UUID, %s::UUID, %s::JSONB)",
                (
                    tenant_id,
                    user_id,
                    {
                        "email": "qualified@example.com",
                        "first_name": "Qualified",
                        "last_name": "Contact",
                        "status": "qualified",
                    },
                ),
            )
            create_result = cur.fetchone()[0]
            contact_id = create_result["object_data"]["id"]

        # Try to qualify already qualified contact - should fail
        with clean_db.cursor() as cur:
            cur.execute(
                "SELECT app.qualify_lead(%s::UUID, %s::UUID, %s::UUID)",
                (tenant_id, user_id, contact_id),
            )
            qualify_result = cur.fetchone()[0]

        assert qualify_result["status"] == "failed"
        assert "not_a_lead" in qualify_result["error_message"]

        # Update to customer without notes - should fail
        with clean_db.cursor() as cur:
            cur.execute(
                "SELECT app.update_status(%s::UUID, %s::UUID, %s::UUID, %s::TEXT)",
                (tenant_id, user_id, contact_id, "customer"),
            )
            status_result = cur.fetchone()[0]

        assert status_result["status"] == "failed"
        assert "notes_required" in status_result["error_message"]

        # Update to customer with notes - should succeed
        with clean_db.cursor() as cur:
            cur.execute(
                "SELECT app.update_contact(%s::UUID, %s::UUID, %s::UUID, %s::JSONB)",
                (
                    tenant_id,
                    user_id,
                    contact_id,
                    {"status": "customer", "notes": "Converted to customer after demo"},
                ),
            )
            success_result = cur.fetchone()[0]

        assert success_result["status"] == "success"

    def test_bulk_contact_operations(self, clean_db):
        """Test bulk contact creation and operations"""
        tenant_id = UUID("01232122-0000-0000-2000-000000000001")
        user_id = UUID("01232122-0000-0000-2000-000000000002")

        # Create multiple contacts
        contacts_data = [
            {
                "email": "bulk1@example.com",
                "first_name": "Bulk",
                "last_name": "One",
                "status": "lead",
            },
            {
                "email": "bulk2@example.com",
                "first_name": "Bulk",
                "last_name": "Two",
                "status": "lead",
            },
            {
                "email": "bulk3@example.com",
                "first_name": "Bulk",
                "last_name": "Three",
                "status": "lead",
            },
        ]

        contact_ids = []
        for contact_data in contacts_data:
            with clean_db.cursor() as cur:
                cur.execute(
                    "SELECT app.create_contact(%s::UUID, %s::UUID, %s::JSONB)",
                    (tenant_id, user_id, contact_data),
                )
                result = cur.fetchone()[0]
                assert result["status"] == "success"
                contact_ids.append(result["object_data"]["id"])

        # Verify all contacts exist
        with clean_db.cursor() as cur:
            cur.execute(
                "SELECT COUNT(*) FROM crm.tb_contact WHERE tenant_id = %s", (tenant_id,)
            )
            count = cur.fetchone()[0]

        assert count == 3

        # Bulk qualify leads
        for contact_id in contact_ids:
            with clean_db.cursor() as cur:
                cur.execute(
                    "SELECT app.qualify_lead(%s::UUID, %s::UUID, %s::UUID)",
                    (tenant_id, user_id, contact_id),
                )
                result = cur.fetchone()[0]
                assert result["status"] == "success"

        # Verify all are qualified
        with clean_db.cursor() as cur:
            cur.execute(
                "SELECT COUNT(*) FROM crm.tb_contact WHERE tenant_id = %s AND status = 'qualified'",
                (tenant_id,),
            )
            qualified_count = cur.fetchone()[0]

        assert qualified_count == 3
