-- Test Contact Actions
-- Generated by SpecQL v0.5.0-beta
-- Tests business logic actions and state transitions

BEGIN;
SELECT plan(12);

-- Setup test data
INSERT INTO crm.tenant (id, name) VALUES
    ('01232122-0000-0000-2000-000000000001'::UUID, 'Test Tenant');

INSERT INTO app.user (id, tenant_id, email) VALUES
    ('01232122-0000-0000-2000-000000000002'::UUID,
     '01232122-0000-0000-2000-000000000001'::UUID, 'test@example.com');

-- Create test contacts in different states
SELECT lives_ok(
    $$SELECT app.create_contact(
        '01232122-0000-0000-2000-000000000001'::UUID,
        '01232122-0000-0000-2000-000000000002'::UUID,
        '{"email": "lead@example.com", "first_name": "Lead", "last_name": "Contact", "status": "lead"}'::JSONB
    )$$,
    'Create lead contact should succeed'
);

SELECT lives_ok(
    $$SELECT app.create_contact(
        '01232122-0000-0000-2000-000000000001'::UUID,
        '01232122-0000-0000-2000-000000000002'::UUID,
        '{"email": "qualified@example.com", "first_name": "Qualified", "last_name": "Contact", "status": "qualified"}'::JSONB
    )$$,
    'Create qualified contact should succeed'
);

SELECT lives_ok(
    $$SELECT app.create_contact(
        '01232122-0000-0000-2000-000000000001'::UUID,
        '01232122-0000-0000-2000-000000000002'::UUID,
        '{"email": "customer@example.com", "first_name": "Customer", "last_name": "Contact", "status": "customer"}'::JSONB
    )$$,
    'Create customer contact should succeed'
);

-- Test: Qualify lead action succeeds for lead
SELECT lives_ok(
    $$SELECT app.qualify_lead(
        '01232122-0000-0000-2000-000000000001'::UUID,
        '01232122-0000-0000-2000-000000000002'::UUID,
        (SELECT id FROM crm.tb_contact WHERE email = 'lead@example.com')
    )$$,
    'Qualify lead should succeed for lead status'
);

-- Test: Verify lead status changed to qualified
SELECT ok(
    (SELECT status = 'qualified' FROM crm.tb_contact WHERE email = 'lead@example.com'),
    'Lead status should change to qualified'
);

-- Test: Qualify lead fails for already qualified contact
SELECT throws_ok(
    $$SELECT app.qualify_lead(
        '01232122-0000-0000-2000-000000000001'::UUID,
        '01232122-0000-0000-2000-000000000002'::UUID,
        (SELECT id FROM crm.tb_contact WHERE email = 'qualified@example.com')
    )$$,
    'not_a_lead',
    'Qualify lead should fail for qualified contact'
);

-- Test: Qualify lead fails for customer contact
SELECT throws_ok(
    $$SELECT app.qualify_lead(
        '01232122-0000-0000-2000-000000000001'::UUID,
        '01232122-0000-0000-2000-000000000002'::UUID,
        (SELECT id FROM crm.tb_contact WHERE email = 'customer@example.com')
    )$$,
    'not_a_lead',
    'Qualify lead should fail for customer contact'
);

-- Test: Update status to qualified succeeds
SELECT lives_ok(
    $$SELECT app.update_status(
        '01232122-0000-0000-2000-000000000001'::UUID,
        '01232122-0000-0000-2000-000000000002'::UUID,
        (SELECT id FROM crm.tb_contact WHERE email = 'lead@example.com'),
        'qualified'::TEXT
    )$$,
    'Update status to qualified should succeed'
);

-- Test: Update status to customer requires notes
SELECT throws_ok(
    $$SELECT app.update_status(
        '01232122-0000-0000-2000-000000000001'::UUID,
        '01232122-0000-0000-2000-000000000002'::UUID,
        (SELECT id FROM crm.tb_contact WHERE email = 'qualified@example.com'),
        'customer'::TEXT
    )$$,
    'notes_required_for_customer',
    'Update to customer status should require notes'
);

-- Test: Update status to customer succeeds with notes
SELECT lives_ok(
    $$SELECT app.update_contact(
        '01232122-0000-0000-2000-000000000001'::UUID,
        '01232122-0000-0000-2000-000000000002'::UUID,
        (SELECT id FROM crm.tb_contact WHERE email = 'qualified@example.com'),
        '{"status": "customer", "notes": "Converted to customer"}'::JSONB
    )$$,
    'Update to customer with notes should succeed'
);

-- Test: Create contact action validates email format
SELECT throws_ok(
    $$SELECT app.create_contact(
        '01232122-0000-0000-2000-000000000001'::UUID,
        '01232122-0000-0000-2000-000000000002'::UUID,
        '{"email": "invalid-email", "first_name": "Test", "last_name": "User", "status": "lead"}'::JSONB
    )$$,
    'invalid_email',
    'Create contact should validate email format'
);

-- Test: Create contact action validates required fields
SELECT throws_ok(
    $$SELECT app.create_contact(
        '01232122-0000-0000-2000-000000000001'::UUID,
        '01232122-0000-0000-2000-000000000002'::UUID,
        '{"email": "test@example.com", "last_name": "User", "status": "lead"}'::JSONB
    )$$,
    'first_name_required',
    'Create contact should require first name'
);

-- Test: Action permissions - unauthorized user
INSERT INTO app.user (id, tenant_id, email) VALUES
    ('01232122-0000-0000-2000-000000000003'::UUID,
     '01232122-0000-0000-2000-000000000001'::UUID, 'unauthorized@example.com');

SELECT throws_ok(
    $$SELECT app.qualify_lead(
        '01232122-0000-0000-2000-000000000001'::UUID,
        '01232122-0000-0000-2000-000000000003'::UUID,
        (SELECT id FROM crm.tb_contact WHERE email = 'lead@example.com')
    )$$,
    'permission_denied',
    'Qualify lead should fail for unauthorized user'
);

SELECT * FROM finish();
ROLLBACK;