-- Test Contact CRUD Operations
-- Generated by SpecQL v0.5.0-beta
-- Tests create, read, update, delete operations

BEGIN;
SELECT plan(15);

-- Setup test data
INSERT INTO crm.tenant (id, name) VALUES
    ('01232122-0000-0000-2000-000000000001'::UUID, 'Test Tenant');

INSERT INTO app.user (id, tenant_id, email) VALUES
    ('01232122-0000-0000-2000-000000000002'::UUID,
     '01232122-0000-0000-2000-000000000001'::UUID, 'test@example.com');

-- Test: Create contact successfully
SELECT lives_ok(
    $$SELECT app.create_contact(
        '01232122-0000-0000-2000-000000000001'::UUID,
        '01232122-0000-0000-2000-000000000002'::UUID,
        '{"email": "john.doe@example.com", "first_name": "John", "last_name": "Doe", "status": "lead"}'::JSONB
    )$$,
    'Create contact should succeed'
);

-- Test: Create contact with duplicate email fails
SELECT throws_ok(
    $$SELECT app.create_contact(
        '01232122-0000-0000-2000-000000000001'::UUID,
        '01232122-0000-0000-2000-000000000002'::UUID,
        '{"email": "john.doe@example.com", "first_name": "Jane", "last_name": "Doe", "status": "lead"}'::JSONB
    )$$,
    'Duplicate email should be rejected'
);

-- Test: Create contact with invalid email fails
SELECT throws_ok(
    $$SELECT app.create_contact(
        '01232122-0000-0000-2000-000000000001'::UUID,
        '01232122-0000-0000-2000-000000000002'::UUID,
        '{"email": "not-an-email", "first_name": "John", "last_name": "Doe", "status": "lead"}'::JSONB
    )$$,
    'Invalid email should be rejected'
);

-- Test: Create contact without first name fails
SELECT throws_ok(
    $$SELECT app.create_contact(
        '01232122-0000-0000-2000-000000000001'::UUID,
        '01232122-0000-0000-2000-000000000002'::UUID,
        '{"email": "jane.doe@example.com", "last_name": "Doe", "status": "lead"}'::JSONB
    )$$,
    'Missing first name should be rejected'
);

-- Test: Read contact by ID
SELECT ok(
    (SELECT app.get_contact('01232122-0000-0000-2000-000000000001'::UUID, (SELECT id FROM crm.tb_contact WHERE email = 'john.doe@example.com'))).status = 'success',
    'Get contact should succeed'
);

-- Test: Read non-existent contact fails
SELECT ok(
    (SELECT app.get_contact('01232122-0000-0000-2000-000000000001'::UUID, '01232122-0000-0000-2000-000000000999'::UUID)).status = 'failed',
    'Get non-existent contact should fail'
);

-- Test: Update contact successfully
SELECT lives_ok(
    $$SELECT app.update_contact(
        '01232122-0000-0000-2000-000000000001'::UUID,
        '01232122-0000-0000-2000-000000000002'::UUID,
        (SELECT id FROM crm.tb_contact WHERE email = 'john.doe@example.com'),
        '{"first_name": "Johnny", "phone": "+1-555-0123"}'::JSONB
    )$$,
    'Update contact should succeed'
);

-- Test: Update contact status
SELECT lives_ok(
    $$SELECT app.update_status(
        '01232122-0000-0000-2000-000000000001'::UUID,
        '01232122-0000-0000-2000-000000000002'::UUID,
        (SELECT id FROM crm.tb_contact WHERE email = 'john.doe@example.com'),
        'qualified'::TEXT
    )$$,
    'Update status should succeed'
);

-- Test: Update to invalid status fails
SELECT throws_ok(
    $$SELECT app.update_status(
        '01232122-0000-0000-2000-000000000001'::UUID,
        '01232122-0000-0000-2000-000000000002'::UUID,
        (SELECT id FROM crm.tb_contact WHERE email = 'john.doe@example.com'),
        'invalid_status'::TEXT
    )$$,
    'Invalid status should be rejected'
);

-- Test: Delete contact (soft delete)
SELECT lives_ok(
    $$SELECT app.delete_contact(
        '01232122-0000-0000-2000-000000000001'::UUID,
        '01232122-0000-0000-2000-000000000002'::UUID,
        (SELECT id FROM crm.tb_contact WHERE email = 'john.doe@example.com')
    )$$,
    'Delete contact should succeed'
);

-- Test: Verify contact is marked as deleted
SELECT ok(
    (SELECT deleted_at IS NOT NULL FROM crm.tb_contact WHERE email = 'john.doe@example.com'),
    'Contact should be soft deleted'
);

-- Test: Read deleted contact fails
SELECT ok(
    (SELECT app.get_contact('01232122-0000-0000-2000-000000000001'::UUID, (SELECT id FROM crm.tb_contact WHERE email = 'john.doe@example.com'))).status = 'failed',
    'Get deleted contact should fail'
);

-- Test: Update deleted contact fails
SELECT throws_ok(
    $$SELECT app.update_contact(
        '01232122-0000-0000-2000-000000000001'::UUID,
        '01232122-0000-0000-2000-000000000002'::UUID,
        (SELECT id FROM crm.tb_contact WHERE email = 'john.doe@example.com'),
        '{"first_name": "Updated"}'::JSONB
    )$$,
    'Update deleted contact should fail'
);

-- Test: Create contact with all fields
SELECT lives_ok(
    $$SELECT app.create_contact(
        '01232122-0000-0000-2000-000000000001'::UUID,
        '01232122-0000-0000-2000-000000000002'::UUID,
        '{"email": "complete@example.com", "first_name": "Complete", "last_name": "Contact", "status": "customer", "phone": "+1-555-0199"}'::JSONB
    )$$,
    'Create contact with all fields should succeed'
);

SELECT * FROM finish();
ROLLBACK;