# TestSpec Example - Contact Entity
# Generated by SpecQL v0.5.0-beta reverse engineering
# Universal test specification format

entity_name: Contact
test_framework: pgtap
source_language: pgtap
source_file: generated_tests/test_contact_crud.sql
parsed_at: 2025-11-20T14:30:00Z

scenarios:
  - name: table_exists
    category: structure
    description: Verify Contact table exists in database
    assertions:
      - type: has_table
        target: crm.tb_contact
        expected: true
        message: Contact table should exist

  - name: email_column_exists
    category: structure
    description: Verify email column exists with correct type
    assertions:
      - type: has_column
        target: crm.tb_contact.email
        expected: true
        message: Email column should exist
      - type: column_type
        target: crm.tb_contact.email
        expected: text
        message: Email column should be text type

  - name: primary_key_constraint
    category: structure
    description: Verify primary key constraint exists
    assertions:
      - type: has_primary_key
        target: crm.tb_contact.id
        expected: true
        message: Primary key constraint should exist on id column

  - name: create_contact_success
    category: crud_create
    description: Successfully create a new contact
    setup:
      - type: insert_fixture
        table: crm.tenant
        data:
          id: "01232122-0000-0000-2000-000000000001"
          name: "Test Tenant"
      - type: insert_fixture
        table: app.user
        data:
          id: "01232122-0000-0000-2000-000000000002"
          tenant_id: "01232122-0000-0000-2000-000000000001"
          email: "test@example.com"
    steps:
      - action: call_function
        function: app.create_contact
        parameters:
          - type: uuid
            value: "01232122-0000-0000-2000-000000000001"
          - type: uuid
            value: "01232122-0000-0000-2000-000000000002"
          - type: jsonb
            value: {"email": "john.doe@example.com", "first_name": "John", "last_name": "Doe", "status": "lead"}
    assertions:
      - type: equals
        target: result.status
        expected: success
        message: Contact creation should return success
      - type: is_not_null
        target: result.object_data.id
        message: Created contact should have UUID
      - type: equals
        target: result.object_data.email
        expected: "john.doe@example.com"
        message: Contact should have correct email

  - name: create_duplicate_email_fails
    category: crud_create
    description: Duplicate email addresses should be rejected
    setup:
      - type: insert_fixture
        table: crm.tenant
        data:
          id: "01232122-0000-0000-2000-000000000001"
          name: "Test Tenant"
      - type: insert_fixture
        table: app.user
        data:
          id: "01232122-0000-0000-2000-000000000002"
          tenant_id: "01232122-0000-0000-2000-000000000001"
          email: "test@example.com"
      - type: insert_fixture
        table: crm.tb_contact
        data:
          id: "01232122-0000-0000-2000-000000000003"
          tenant_id: "01232122-0000-0000-2000-000000000001"
          email: "duplicate@example.com"
          first_name: "Original"
          last_name: "Contact"
          status: "lead"
    steps:
      - action: call_function
        function: app.create_contact
        parameters:
          - type: uuid
            value: "01232122-0000-0000-2000-000000000001"
          - type: uuid
            value: "01232122-0000-0000-2000-000000000002"
          - type: jsonb
            value: {"email": "duplicate@example.com", "first_name": "Duplicate", "last_name": "Contact", "status": "lead"}
    assertions:
      - type: equals
        target: result.status
        expected: failed
        message: Duplicate email should be rejected
      - type: contains
        target: result.error_message
        expected: "duplicate"
        message: Error message should mention duplicate

  - name: create_invalid_email_fails
    category: crud_create
    description: Invalid email formats should be rejected
    setup:
      - type: insert_fixture
        table: crm.tenant
        data:
          id: "01232122-0000-0000-2000-000000000001"
          name: "Test Tenant"
      - type: insert_fixture
        table: app.user
        data:
          id: "01232122-0000-0000-2000-000000000002"
          tenant_id: "01232122-0000-0000-2000-000000000001"
          email: "test@example.com"
    steps:
      - action: call_function
        function: app.create_contact
        parameters:
          - type: uuid
            value: "01232122-0000-0000-2000-000000000001"
          - type: uuid
            value: "01232122-0000-0000-2000-000000000002"
          - type: jsonb
            value: {"email": "not-an-email", "first_name": "Test", "last_name": "User", "status": "lead"}
    assertions:
      - type: equals
        target: result.status
        expected: failed
        message: Invalid email should be rejected
      - type: contains
        target: result.error_message
        expected: "email"
        message: Error message should mention email validation

  - name: create_missing_first_name_fails
    category: crud_create
    description: Missing first name should be rejected
    setup:
      - type: insert_fixture
        table: crm.tenant
        data:
          id: "01232122-0000-0000-2000-000000000001"
          name: "Test Tenant"
      - type: insert_fixture
        table: app.user
        data:
          id: "01232122-0000-0000-2000-000000000002"
          tenant_id: "01232122-0000-0000-2000-000000000001"
          email: "test@example.com"
    steps:
      - action: call_function
        function: app.create_contact
        parameters:
          - type: uuid
            value: "01232122-0000-0000-2000-000000000001"
          - type: uuid
            value: "01232122-0000-0000-2000-000000000002"
          - type: jsonb
            value: {"email": "test@example.com", "last_name": "User", "status": "lead"}
    assertions:
      - type: equals
        target: result.status
        expected: failed
        message: Missing first name should be rejected
      - type: contains
        target: result.error_message
        expected: "first_name"
        message: Error message should mention first name

  - name: get_contact_success
    category: crud_read
    description: Successfully retrieve contact by ID
    setup:
      - type: insert_fixture
        table: crm.tenant
        data:
          id: "01232122-0000-0000-2000-000000000001"
          name: "Test Tenant"
      - type: insert_fixture
        table: app.user
        data:
          id: "01232122-0000-0000-2000-000000000002"
          tenant_id: "01232122-0000-0000-2000-000000000001"
          email: "test@example.com"
      - type: insert_fixture
        table: crm.tb_contact
        data:
          id: "01232122-0000-0000-2000-000000000003"
          tenant_id: "01232122-0000-0000-2000-000000000001"
          email: "read.test@example.com"
          first_name: "Read"
          last_name: "Test"
          status: "lead"
    steps:
      - action: call_function
        function: app.get_contact
        parameters:
          - type: uuid
            value: "01232122-0000-0000-2000-000000000001"
          - type: uuid
            value: "01232122-0000-0000-2000-000000000003"
    assertions:
      - type: equals
        target: result.status
        expected: success
        message: Get contact should succeed
      - type: equals
        target: result.object_data.email
        expected: "read.test@example.com"
        message: Retrieved contact should have correct email

  - name: get_nonexistent_contact_fails
    category: crud_read
    description: Attempting to get non-existent contact should fail
    setup:
      - type: insert_fixture
        table: crm.tenant
        data:
          id: "01232122-0000-0000-2000-000000000001"
          name: "Test Tenant"
    steps:
      - action: call_function
        function: app.get_contact
        parameters:
          - type: uuid
            value: "01232122-0000-0000-2000-000000000001"
          - type: uuid
            value: "01232122-0000-0000-2000-000000000999"
    assertions:
      - type: equals
        target: result.status
        expected: failed
        message: Get non-existent contact should fail

  - name: update_contact_success
    category: crud_update
    description: Successfully update contact fields
    setup:
      - type: insert_fixture
        table: crm.tenant
        data:
          id: "01232122-0000-0000-2000-000000000001"
          name: "Test Tenant"
      - type: insert_fixture
        table: app.user
        data:
          id: "01232122-0000-0000-2000-000000000002"
          tenant_id: "01232122-0000-0000-2000-000000000001"
          email: "test@example.com"
      - type: insert_fixture
        table: crm.tb_contact
        data:
          id: "01232122-0000-0000-2000-000000000003"
          tenant_id: "01232122-0000-0000-2000-000000000001"
          email: "update.test@example.com"
          first_name: "Update"
          last_name: "Test"
          status: "lead"
    steps:
      - action: call_function
        function: app.update_contact
        parameters:
          - type: uuid
            value: "01232122-0000-0000-2000-000000000001"
          - type: uuid
            value: "01232122-0000-0000-2000-000000000002"
          - type: uuid
            value: "01232122-0000-0000-2000-000000000003"
          - type: jsonb
            value: {"first_name": "Updated", "phone": "+1-555-0123"}
    assertions:
      - type: equals
        target: result.status
        expected: success
        message: Update contact should succeed

  - name: update_status_success
    category: crud_update
    description: Successfully update contact status
    setup:
      - type: insert_fixture
        table: crm.tenant
        data:
          id: "01232122-0000-0000-2000-000000000001"
          name: "Test Tenant"
      - type: insert_fixture
        table: app.user
        data:
          id: "01232122-0000-0000-2000-000000000002"
          tenant_id: "01232122-0000-0000-2000-000000000001"
          email: "test@example.com"
      - type: insert_fixture
        table: crm.tb_contact
        data:
          id: "01232122-0000-0000-2000-000000000003"
          tenant_id: "01232122-0000-0000-2000-000000000001"
          email: "status.test@example.com"
          first_name: "Status"
          last_name: "Test"
          status: "lead"
    steps:
      - action: call_function
        function: app.update_status
        parameters:
          - type: uuid
            value: "01232122-0000-0000-2000-000000000001"
          - type: uuid
            value: "01232122-0000-0000-2000-000000000002"
          - type: uuid
            value: "01232122-0000-0000-2000-000000000003"
          - type: text
            value: "qualified"
    assertions:
      - type: equals
        target: result.status
        expected: success
        message: Update status should succeed

  - name: update_invalid_status_fails
    category: crud_update
    description: Invalid status values should be rejected
    setup:
      - type: insert_fixture
        table: crm.tenant
        data:
          id: "01232122-0000-0000-2000-000000000001"
          name: "Test Tenant"
      - type: insert_fixture
        table: app.user
        data:
          id: "01232122-0000-0000-2000-000000000002"
          tenant_id: "01232122-0000-0000-2000-000000000001"
          email: "test@example.com"
      - type: insert_fixture
        table: crm.tb_contact
        data:
          id: "01232122-0000-0000-2000-000000000003"
          tenant_id: "01232122-0000-0000-2000-000000000001"
          email: "invalid.status@example.com"
          first_name: "Invalid"
          last_name: "Status"
          status: "lead"
    steps:
      - action: call_function
        function: app.update_status
        parameters:
          - type: uuid
            value: "01232122-0000-0000-2000-000000000001"
          - type: uuid
            value: "01232122-0000-0000-2000-000000000002"
          - type: uuid
            value: "01232122-0000-0000-2000-000000000003"
          - type: text
            value: "invalid_status"
    assertions:
      - type: equals
        target: result.status
        expected: failed
        message: Invalid status should be rejected

  - name: delete_contact_success
    category: crud_delete
    description: Successfully delete contact (soft delete)
    setup:
      - type: insert_fixture
        table: crm.tenant
        data:
          id: "01232122-0000-0000-2000-000000000001"
          name: "Test Tenant"
      - type: insert_fixture
        table: app.user
        data:
          id: "01232122-0000-0000-2000-000000000002"
          tenant_id: "01232122-0000-0000-2000-000000000001"
          email: "test@example.com"
      - type: insert_fixture
        table: crm.tb_contact
        data:
          id: "01232122-0000-0000-2000-000000000003"
          tenant_id: "01232122-0000-0000-2000-000000000001"
          email: "delete.test@example.com"
          first_name: "Delete"
          last_name: "Test"
          status: "lead"
    steps:
      - action: call_function
        function: app.delete_contact
        parameters:
          - type: uuid
            value: "01232122-0000-0000-2000-000000000001"
          - type: uuid
            value: "01232122-0000-0000-2000-000000000002"
          - type: uuid
            value: "01232122-0000-0000-2000-000000000003"
    assertions:
      - type: equals
        target: result.status
        expected: success
        message: Delete contact should succeed

  - name: deleted_contact_inaccessible
    category: crud_delete
    description: Deleted contacts should become inaccessible
    setup:
      - type: insert_fixture
        table: crm.tenant
        data:
          id: "01232122-0000-0000-2000-000000000001"
          name: "Test Tenant"
      - type: insert_fixture
        table: crm.tb_contact
        data:
          id: "01232122-0000-0000-2000-000000000003"
          tenant_id: "01232122-0000-0000-2000-000000000001"
          email: "deleted.test@example.com"
          first_name: "Deleted"
          last_name: "Test"
          status: "lead"
          deleted_at: "2025-11-20T12:00:00Z"
    steps:
      - action: call_function
        function: app.get_contact
        parameters:
          - type: uuid
            value: "01232122-0000-0000-2000-000000000001"
          - type: uuid
            value: "01232122-0000-0000-2000-000000000003"
    assertions:
      - type: equals
        target: result.status
        expected: failed
        message: Get deleted contact should fail

  - name: qualify_lead_success
    category: actions
    description: Successfully qualify a lead contact
    setup:
      - type: insert_fixture
        table: crm.tenant
        data:
          id: "01232122-0000-0000-2000-000000000001"
          name: "Test Tenant"
      - type: insert_fixture
        table: app.user
        data:
          id: "01232122-0000-0000-2000-000000000002"
          tenant_id: "01232122-0000-0000-2000-000000000001"
          email: "test@example.com"
      - type: insert_fixture
        table: crm.tb_contact
        data:
          id: "01232122-0000-0000-2000-000000000003"
          tenant_id: "01232122-0000-0000-2000-000000000001"
          email: "lead@example.com"
          first_name: "Lead"
          last_name: "Contact"
          status: "lead"
    steps:
      - action: call_function
        function: app.qualify_lead
        parameters:
          - type: uuid
            value: "01232122-0000-0000-2000-000000000001"
          - type: uuid
            value: "01232122-0000-0000-2000-000000000002"
          - type: uuid
            value: "01232122-0000-0000-2000-000000000003"
    assertions:
      - type: equals
        target: result.status
        expected: success
        message: Qualify lead should succeed for lead status

  - name: qualify_lead_wrong_status_fails
    category: actions
    description: Qualify lead should fail for non-lead contacts
    setup:
      - type: insert_fixture
        table: crm.tenant
        data:
          id: "01232122-0000-0000-2000-000000000001"
          name: "Test Tenant"
      - type: insert_fixture
        table: app.user
        data:
          id: "01232122-0000-0000-2000-000000000002"
          tenant_id: "01232122-0000-0000-2000-000000000001"
          email: "test@example.com"
      - type: insert_fixture
        table: crm.tb_contact
        data:
          id: "01232122-0000-0000-2000-000000000003"
          tenant_id: "01232122-0000-0000-2000-000000000001"
          email: "qualified@example.com"
          first_name: "Qualified"
          last_name: "Contact"
          status: "qualified"
    steps:
      - action: call_function
        function: app.qualify_lead
        parameters:
          - type: uuid
            value: "01232122-0000-0000-2000-000000000001"
          - type: uuid
            value: "01232122-0000-0000-2000-000000000002"
          - type: uuid
            value: "01232122-0000-0000-2000-000000000003"
    assertions:
      - type: equals
        target: result.status
        expected: failed
        message: Qualify lead should fail for qualified contact
      - type: contains
        target: result.error_message
        expected: "not_a_lead"
        message: Error should mention not a lead

  - name: update_to_customer_requires_notes
    category: actions
    description: Updating to customer status requires notes
    setup:
      - type: insert_fixture
        table: crm.tenant
        data:
          id: "01232122-0000-0000-2000-000000000001"
          name: "Test Tenant"
      - type: insert_fixture
        table: app.user
        data:
          id: "01232122-0000-0000-2000-000000000002"
          tenant_id: "01232122-0000-0000-2000-000000000001"
          email: "test@example.com"
      - type: insert_fixture
        table: crm.tb_contact
        data:
          id: "01232122-0000-0000-2000-000000000003"
          tenant_id: "01232122-0000-0000-2000-000000000001"
          email: "customer@example.com"
          first_name: "Customer"
          last_name: "Contact"
          status: "qualified"
    steps:
      - action: call_function
        function: app.update_status
        parameters:
          - type: uuid
            value: "01232122-0000-0000-2000-000000000001"
          - type: uuid
            value: "01232122-0000-0000-2000-000000000002"
          - type: uuid
            value: "01232122-0000-0000-2000-000000000003"
          - type: text
            value: "customer"
    assertions:
      - type: equals
        target: result.status
        expected: failed
        message: Update to customer without notes should fail
      - type: contains
        target: result.error_message
        expected: "notes_required"
        message: Error should mention notes requirement