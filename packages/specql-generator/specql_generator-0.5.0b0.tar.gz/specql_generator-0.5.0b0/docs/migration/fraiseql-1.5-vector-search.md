# FraiseQL 1.5 Vector Search Migration Guide

**Status**: Active Migration | **Timeline**: SpecQL v1.6 - v2.0 | **Impact**: Breaking Changes

## Executive Summary

SpecQL is migrating from custom vector search functions to FraiseQL 1.5's native vector operators. This migration reduces SpecQL's codebase by ~70% while improving performance, type safety, and developer experience.

**Migration Timeline:**
- **v1.6 (Current)**: Deprecation warnings, backward compatibility
- **v1.7**: Migration guides and examples
- **v1.8**: Final warnings ("removed in v2.0")
- **v2.0**: Complete removal of deprecated code

---

## What Changed

### ✅ Removed (Deprecated)

1. **Custom SQL Search Functions**
   - `search_document_by_embedding()`
   - `search_pattern_by_embedding()`
   - All per-entity vector search functions

2. **EmbeddingService Class**
   - `src/infrastructure/services/embedding_service.py`
   - Manual model loading and embedding generation

3. **SpecQL Embedding CLI Commands**
   - `specql embeddings generate`
   - `specql embeddings test-retrieval`

4. **Raw PostgreSQL Vector Queries**
   - Manual pgvector operations
   - Direct SQL with `<=>` operator

### ✅ Improved (FraiseQL 1.5)

1. **Type-Safe GraphQL Queries**
   - IDE autocomplete for vector operations
   - Compile-time query validation
   - Better error messages

2. **Automatic Embedding Generation**
   - Trigger-based embedding on INSERT/UPDATE
   - No manual batch processing needed
   - Shared model across all entities

3. **Optimized Performance**
   - FraiseQL's query optimization
   - Better HNSW index utilization
   - Reduced database round trips

4. **Unified API**
   - Same vector operators for all entities
   - Consistent GraphQL interface
   - Cross-entity vector searches

---

## Migration Examples

### Before: Custom SQL Functions

```yaml
# entities/document.yaml
entity: Document
features:
  - semantic_search
```

```sql
-- Generated by SpecQL
ALTER TABLE crm.tv_document ADD COLUMN embedding vector(384);
CREATE INDEX ... USING hnsw (embedding vector_cosine_ops);
CREATE FUNCTION crm.search_document_by_embedding(...) ...;
```

```python
# Application code
from src.infrastructure.services.embedding_service import EmbeddingService

service = EmbeddingService()
query_embedding = service.generate_embedding("search query")

results = db.execute("""
    SELECT * FROM search_document_by_embedding(%s::vector, 10, 0.7)
""", (query_embedding,))
```

### After: FraiseQL GraphQL

```yaml
# entities/document.yaml (unchanged!)
entity: Document
features:
  - semantic_search
```

```sql
-- Generated by SpecQL (simpler!)
ALTER TABLE crm.tv_document ADD COLUMN embedding vector(384);
CREATE INDEX ... USING hnsw (embedding vector_cosine_ops);

-- No custom function needed - FraiseQL auto-discovers
```

```python
# Application code (type-safe!)
from fraiseql import FraiseQLClient

client = FraiseQLClient("http://localhost:4000/graphql")

results = client.query("""
    query FindSimilarDocuments($query: String!) {
      documents(
        where: {
          embedding: {
            cosineDistance: { text: $query, threshold: 0.7 }
          }
        }
        limit: 10
      ) {
        id
        title
        content
        similarity  # Auto-calculated
      }
    }
""", {"query": "search query"})
```

---

## Step-by-Step Migration

### Step 1: Update Entity Configuration

**No changes required** for basic semantic search:

```yaml
# entities/document.yaml
entity: Document
features:
  - semantic_search  # Still works exactly the same
```

**Optional**: Disable deprecated custom functions:

```yaml
# entities/document.yaml
entity: Document
features:
  - semantic_search

# NEW: Opt-in for legacy support during migration
vector_config:
  generate_custom_functions: false  # Default in v2.0
```

### Step 2: Replace SQL Queries with GraphQL

#### Pattern 1: Simple Vector Search

**Before:**
```sql
SELECT * FROM search_document_by_embedding('[0.1, 0.2, ...]'::vector, 10, 0.7);
```

**After:**
```graphql
query {
  documents(
    where: { embedding: { cosineDistance: { vector: [0.1, 0.2, ...], threshold: 0.7 } } }
    limit: 10
  ) {
    id title similarity
  }
}
```

#### Pattern 2: Text-to-Vector Search

**Before:**
```python
service = EmbeddingService()
query_embedding = service.generate_embedding("machine learning tutorial")
results = db.execute("SELECT * FROM search_document_by_embedding(%s::vector, 10, 0.7)", (query_embedding,))
```

**After:**
```python
results = fraiseql_client.query("""
    query {
      documents(
        where: { embedding: { cosineDistance: { text: "machine learning tutorial", threshold: 0.7 } } }
        limit: 10
      ) { id title similarity }
    }
""")
```

#### Pattern 3: Hybrid Search (Vector + Filters)

**Before:**
```sql
SELECT * FROM search_document_by_embedding(embedding, 10, 0.7)
WHERE category = 'tutorial' AND published_at > '2024-01-01';
```

**After:**
```graphql
query {
  documents(
    where: {
      AND: [
        { embedding: { cosineDistance: { text: "machine learning", threshold: 0.7 } } }
        { category: { equals: "tutorial" } }
        { publishedAt: { gt: "2024-01-01" } }
      ]
    }
    limit: 10
  ) { id title category similarity }
}
```

### Step 3: Update CLI Commands

#### Embedding Generation

**Before:**
```bash
specql embeddings generate
```

**After:**
```bash
fraiseql embeddings generate --entity Document
```

#### Testing Retrieval

**Before:**
```bash
specql embeddings test-retrieval "machine learning tutorial" --top-k 5
```

**After:**
```bash
fraiseql embeddings search --entity Document --query "machine learning tutorial" --limit 5
```

### Step 4: Remove Deprecated Imports

**Remove these imports:**
```python
# Remove - deprecated
from src.infrastructure.services.embedding_service import EmbeddingService
from src.pattern_library.embeddings_pg import PatternEmbeddingService

# Replace with
from fraiseql import FraiseQLClient
```

---

## FraiseQL Configuration

Add to your `config/fraiseql.yaml`:

```yaml
# Embedding configuration
embeddings:
  provider: sentence_transformers
  model: all-MiniLM-L6-v2
  dimensions: 384
  auto_generate: true

  # Per-entity configuration
  entities:
    - name: Document
      fields: [title, content]
      combine_strategy: weighted
      weights:
        title: 0.3
        content: 0.7

    - name: DomainPattern
      fields: [name, description, category]
      combine_strategy: concat
      separator: " | "
```

---

## GraphQL Vector Operators Reference

### Distance Operators

```graphql
# Cosine distance (recommended for normalized embeddings)
query {
  documents(where: {
    embedding: { cosineDistance: { text: "query", threshold: 0.7 } }
  }) { id title similarity }
}

# L2 distance (Euclidean)
query {
  documents(where: {
    embedding: { l2Distance: { vector: [0.1, 0.2, ...], threshold: 5.0 } }
  }) { id title }
}

# Inner product
query {
  documents(where: {
    embedding: { innerProduct: { vector: [0.1, 0.2, ...], threshold: 0.8 } }
  }) { id title }
}
```

### Ordering

```graphql
# Order by similarity (ascending distance = more similar)
query {
  documents(
    where: { embedding: { cosineDistance: { text: "query" } } }
    orderBy: { embedding: { cosineDistance: "query" } }  # ASC by default
    limit: 10
  ) { id title similarity }
}
```

### Hybrid Search

```graphql
# Combine vector search with full-text and filters
query HybridSearch($query: String!) {
  documents(
    where: {
      OR: [
        { embedding: { cosineDistance: { text: $query, threshold: 0.6 } } }
        { searchVector: { matches: $query } }
      ]
      AND: [
        { category: { equals: "tutorial" } }
        { publishedAt: { gt: "2024-01-01" } }
      ]
    }
    orderBy: { _relevance: DESC }  # Combined score
  ) { id title category similarity _relevance }
}
```

---

## Troubleshooting

### "Command not found: fraiseql"

**Solution:** Install FraiseQL 1.5
```bash
pip install fraiseql>=1.5.0
# or
npm install -g @fraiseql/cli
```

### "Vector operators not available"

**Solution:** Verify FraiseQL configuration
```bash
# Check if vector columns are auto-discovered
fraiseql schema introspect

# Verify embedding configuration
fraiseql config show embeddings
```

### "Performance regression"

**Solution:** Compare query plans
```sql
-- Old: Custom function
EXPLAIN ANALYZE SELECT * FROM search_document_by_embedding('[...]'::vector, 10, 0.7);

-- New: FraiseQL GraphQL
# Use FraiseQL's query analyzer
fraiseql query analyze --query "query { documents(where: { embedding: { cosineDistance: { text: \"test\" } } }) { id } }"
```

### "Embedding generation not working"

**Solution:** Check FraiseQL embedding service
```bash
# Check embedding service status
fraiseql embeddings status

# Manually trigger regeneration
fraiseql embeddings regenerate --entity Document
```

---

## Benefits of Migration

### ✅ Developer Experience
- **Type Safety**: GraphQL queries with IDE autocomplete
- **Better Errors**: Clear error messages vs raw SQL
- **Documentation**: Self-documenting GraphQL schema

### ✅ Performance
- **Optimization**: FraiseQL's query planner
- **Caching**: Built-in query result caching
- **Batching**: Automatic request batching

### ✅ Maintainability
- **Less Code**: ~70% reduction in vector-related code
- **Standardization**: Single API for all vector operations
- **Future-Proof**: Automatic FraiseQL updates

### ✅ Features
- **Auto-Generation**: Embeddings created automatically on INSERT/UPDATE
- **Model Management**: FraiseQL handles model loading and versioning
- **Multi-Vector**: Support for multiple embeddings per entity
- **Hybrid Search**: Combine vector + full-text + filters

---

## Rollback Plan

If migration issues occur:

1. **Temporary**: Re-enable custom functions
   ```yaml
   # entities/document.yaml
   vector_config:
     generate_custom_functions: true  # Temporary rollback
   ```

2. **Revert CLI**: Use old commands (deprecated but functional)
   ```bash
   specql embeddings generate  # Still works during grace period
   ```

3. **Full Rollback**: Pin SpecQL version
   ```bash
   pip install specql<2.0.0
   ```

---

## Support

- **Documentation**: [FraiseQL Vector Search Docs](https://docs.fraiseql.com/vector-search)
- **Migration Examples**: `docs/examples/fraiseql-migration/`
- **Community**: [SpecQL Discord #fraiseql-migration](https://discord.gg/specql)

---

*Migration Guide Version: 1.0 | Last Updated: 2025-11-14 | SpecQL Team*