from typing import Optional
from pathlib import Path

from src.generators.diagrams.relationship_extractor import (
    RelationshipExtractor,
    RelationshipType,
    EntityNode
)

class GraphvizGenerator:
    """
    Generate Graphviz DOT format for ERD diagrams

    Features:
    - Entity boxes with fields
    - Relationship arrows with cardinality
    - Color coding by schema
    - Clustering by domain
    - Trinity pattern visualization
    """

    # Color palette for schemas
    SCHEMA_COLORS = {
        'common': '#e3f2fd',      # Light blue
        'app': '#f3e5f5',         # Light purple
        'core': '#fff3e0',        # Light orange
        'crm': '#e8f5e9',         # Light green
        'projects': '#fce4ec',    # Light pink
        'catalog': '#f1f8e9',     # Light lime
        'analytics': '#e0f2f1',   # Light teal
        'public': '#f5f5f5',      # Light gray
    }

    def __init__(self, extractor: RelationshipExtractor):
        self.extractor = extractor
        self.dot_lines = []

    def generate(
        self,
        output_path: Optional[str] = None,
        format: str = 'svg',
        title: Optional[str] = None,
        cluster_by_schema: bool = True,
        show_fields: bool = True,
        show_trinity: bool = True,
    ) -> str:
        """
        Generate Graphviz DOT diagram

        Args:
            output_path: Path to save diagram (if None, returns DOT string)
            format: Output format (svg, png, pdf)
            title: Diagram title
            cluster_by_schema: Group entities by schema
            show_fields: Show field list in entity boxes
            show_trinity: Show Trinity pattern fields (pk_, id, identifier)

        Returns:
            DOT source string

        Raises:
            ValueError: If format is not supported
            RuntimeError: If diagram rendering fails
        """
        if format not in ['svg', 'png', 'pdf', 'dot']:
            raise ValueError(f"Unsupported format: {format}. Supported: svg, png, pdf, dot")

        if not self.extractor.entities:
            raise ValueError("No entities found in extractor. Run extract_from_entities() first.")

        try:
            self.dot_lines = []

            # Header
            self._add_header(title)

            # Graph attributes
            self._add_graph_attributes()

            # Entities
            if cluster_by_schema:
                self._add_entities_clustered()
            else:
                self._add_entities_flat(show_fields, show_trinity)

            # Relationships
            self._add_relationships()

            # Footer
            self._add_footer()

            dot_source = '\n'.join(self.dot_lines)

            # Render if output path provided
            if output_path:
                self._render_diagram(dot_source, output_path, format)

            return dot_source

        except Exception as e:
            raise RuntimeError(f"Failed to generate Graphviz diagram: {e}") from e

    def _add_header(self, title: Optional[str]) -> None:
        """Add DOT header"""
        self.dot_lines.append('digraph schema {')
        self.dot_lines.append('  // Generated by SpecQL Diagram Generator')
        self.dot_lines.append('')

        if title:
            self.dot_lines.append(f'  label="{title}";')
            self.dot_lines.append('  labelloc="t";')
            self.dot_lines.append('  fontsize=20;')
            self.dot_lines.append('  fontname="Arial Bold";')
            self.dot_lines.append('')

    def _add_graph_attributes(self) -> None:
        """Add graph-level styling"""
        self.dot_lines.extend([
            '  // Graph attributes',
            '  graph [',
            '    rankdir=TB;',  # Top to bottom layout
            '    splines=ortho;',  # Orthogonal edges
            '    nodesep=0.8;',
            '    ranksep=1.2;',
            '    bgcolor="white";',
            '  ];',
            '',
            '  // Node defaults',
            '  node [',
            '    shape=plaintext;',  # Use HTML-like labels
            '    fontname="Arial";',
            '    fontsize=10;',
            '  ];',
            '',
            '  // Edge defaults',
            '  edge [',
            '    fontname="Arial";',
            '    fontsize=9;',
            '    color="#666666";',
            '    arrowhead=crow;',  # ERD-style arrows
            '  ];',
            '',
        ])

    def _add_entities_clustered(self) -> None:
        """Add entities grouped by schema"""
        from src.generators.diagrams.dependency_graph import DependencyGraph

        graph = DependencyGraph(self.extractor)
        schemas = graph.get_entities_by_schema()

        self.dot_lines.append('  // Entities (clustered by schema)')
        self.dot_lines.append('')

        for schema_name, entity_names in schemas.items():
            color = self.SCHEMA_COLORS.get(schema_name, '#f5f5f5')

            self.dot_lines.append(f'  subgraph cluster_{schema_name} {{')
            self.dot_lines.append(f'    label="{schema_name}";')
            self.dot_lines.append('    style=filled;')
            self.dot_lines.append(f'    color="{color}";')
            self.dot_lines.append('    fontname="Arial Bold";')
            self.dot_lines.append('')

            for entity_name in entity_names:
                entity_node = self.extractor.entities[entity_name]
                self._add_entity_node(entity_node)

            self.dot_lines.append('  }')
            self.dot_lines.append('')

    def _add_entities_flat(
        self,
        show_fields: bool,
        show_trinity: bool
    ) -> None:
        """Add entities without clustering"""
        self.dot_lines.append('  // Entities')
        self.dot_lines.append('')

        for entity_node in self.extractor.entities.values():
            self._add_entity_node(entity_node, show_fields, show_trinity)

    def _add_entity_node(
        self,
        entity: EntityNode,
        show_fields: bool = True,
        show_trinity: bool = True
    ) -> None:
        """
        Add single entity node with HTML-like table

        Entity box looks like:
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Contact (CRM)  â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ pk_contact  PK  â”‚
        â”‚ id          UUIDâ”‚
        â”‚ identifier  TEXTâ”‚
        â”‚ email       TEXTâ”‚
        â”‚ company_id  FK  â”‚
        â”‚ status      ENUMâ”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        """
        node_id = entity.name

        # Start HTML table
        html = '<TABLE BORDER="1" CELLBORDER="0" CELLSPACING="0" CELLPADDING="4">'

        # Header row (entity name)
        schema_label = f" ({entity.schema})" if entity.schema != 'public' else ''
        html += f'<TR><TD BGCOLOR="#4a90e2" ALIGN="CENTER"><FONT COLOR="white" POINT-SIZE="12"><B>{entity.name}{schema_label}</B></FONT></TD></TR>'

        # Separator
        html += '<TR><TD BGCOLOR="#e0e0e0" HEIGHT="1"></TD></TR>'

        if show_fields:
            # Field rows
            for field in entity.fields:
                field_name = field['name']

                # Skip Trinity fields if not showing
                if not show_trinity and field_name in ['pk_' + entity.name.lower(), 'id', 'identifier']:
                    continue

                field_type = field['type']

                # Styling
                is_pk = field.get('is_pk', False)
                is_fk = field.get('is_fk', False)

                if is_pk:
                    style = 'BGCOLOR="#fff9c4"'  # Light yellow for PK
                    type_suffix = ' PK'
                elif is_fk:
                    style = 'BGCOLOR="#ffe0b2"'  # Light orange for FK
                    type_suffix = ' FK'
                else:
                    style = ''
                    type_suffix = ''

                html += f'<TR><TD {style} ALIGN="LEFT">{field_name} <FONT COLOR="#666666">{field_type}{type_suffix}</FONT></TD></TR>'

        html += '</TABLE>'

        # Add node
        self.dot_lines.append(f'    {node_id} [label=<{html}>];')

    def _add_relationships(self) -> None:
        """Add relationship edges"""
        self.dot_lines.append('')
        self.dot_lines.append('  // Relationships')
        self.dot_lines.append('')

        for rel in self.extractor.relationships:
            # Arrow from FK to PK
            from_node = rel.from_entity
            to_node = rel.to_entity

            # Edge label (cardinality)
            from_card = self._cardinality_symbol(rel.from_cardinality)
            to_card = self._cardinality_symbol(rel.to_cardinality)

            label = f"{from_card} {rel.from_field} {to_card}"

            # Edge style
            style = 'dashed' if rel.nullable else 'solid'

            # Self-referential needs special handling
            if rel.relationship_type == RelationshipType.SELF_REFERENTIAL:
                self.dot_lines.append(
                    f'    {from_node} -> {to_node} [label="{label}", style="{style}", dir=back, constraint=false];'
                )
            else:
                # Normal relationship: FK â†’ PK (reversed arrow direction for ER notation)
                self.dot_lines.append(
                    f'    {from_node} -> {to_node} [label="{label}", style="{style}", dir=back];'
                )

    def _cardinality_symbol(self, cardinality) -> str:
        """Convert cardinality enum to symbol"""
        symbols = {
            'ZERO_OR_ONE': '0..1',
            'EXACTLY_ONE': '1',
            'ZERO_OR_MANY': '0..*',
            'ONE_OR_MANY': '1..*',
        }
        return symbols.get(cardinality.name, '*')

    def _add_footer(self) -> None:
        """Add DOT footer"""
        self.dot_lines.append('}')

    def _render_diagram(
        self,
        dot_source: str,
        output_path: str,
        format: str
    ) -> None:
        """Render DOT to image using Graphviz"""
        try:
            import graphviz
        except ImportError as e:
            # Fallback: save DOT source
            dot_path = Path(output_path).with_suffix('.dot')
            dot_path.parent.mkdir(parents=True, exist_ok=True)
            dot_path.write_text(dot_source)
            raise RuntimeError(
                f"Graphviz library not installed. Install with: pip install graphviz. "
                f"DOT source saved to: {dot_path}"
            ) from e

        # Validate output path
        output_path_obj = Path(output_path)
        output_path_obj.parent.mkdir(parents=True, exist_ok=True)

        try:
            # Create graph
            graph = graphviz.Source(dot_source)

            # Render
            output = output_path_obj.with_suffix('')
            graph.render(
                filename=str(output),
                format=format,
                cleanup=True  # Remove intermediate .dot file
            )

        except Exception as e:
            # Fallback: save DOT source
            dot_path = Path(output_path).with_suffix('.dot')
            try:
                dot_path.write_text(dot_source)
                fallback_msg = f"DOT source saved to: {dot_path}"
            except OSError:
                fallback_msg = "Could not save DOT source"

            raise RuntimeError(f"Failed to render diagram to {format}: {e}. {fallback_msg}") from e

        except Exception as e:
            print(f"âŒ Error rendering diagram: {e}")

            # Save DOT source for debugging
            Path(output_path).with_suffix('.dot').write_text(dot_source)
            print(f"ğŸ’¾ Saved DOT source: {output_path}.dot")