"""
TypeScript entity/interface generator.

Generates TypeScript interfaces from UniversalEntity objects.
"""

from src.core.universal_ast import UniversalEntity, UniversalField, FieldType


class TypeScriptEntityGenerator:
    """Generates TypeScript interfaces from UniversalEntity."""

    def __init__(self):
        self.type_mapping = {
            FieldType.TEXT: "string",
            FieldType.INTEGER: "number",
            FieldType.BOOLEAN: "boolean",
            FieldType.DATETIME: "Date",
            FieldType.RICH: "any",
        }

    def generate(self, entity: UniversalEntity) -> str:
        """
        Generate TypeScript interface for entity.

        Args:
            entity: UniversalEntity object

        Returns:
            TypeScript interface definition
        """
        lines = []

        # Add file header
        lines.append("/**")
        lines.append(f" * {entity.name} entity interface")
        lines.append(" * Generated by SpecQL")
        lines.append(" */")
        lines.append("")

        # Generate interface
        lines.append(f"export interface {entity.name} {{")
        lines.append("")

        for field in entity.fields:
            field_line = self._generate_field(field)
            lines.append(f"  {field_line}")

        lines.append("")
        lines.append("}")

        return "\n".join(lines)

    def _generate_field(self, field: UniversalField) -> str:
        """Generate a single TypeScript field."""
        field_name = field.name

        # Map field type
        if field.type == FieldType.REFERENCE:
            # For references, use the referenced type
            field_type = field.references or "any"
        elif field.type == FieldType.ENUM:
            # For enums, use string literal union
            if field.enum_values:
                field_type = " | ".join(f'"{v}"' for v in field.enum_values)
            else:
                field_type = "string"
        elif field.type == FieldType.LIST:
            # For arrays
            field_type = "any[]"
        else:
            field_type = self.type_mapping.get(field.type, "any")

        # Optional marker
        optional = "?" if not field.required else ""

        return f"{field_name}{optional}: {field_type};"

    def write_entity(self, entity: UniversalEntity, output_path: str):
        """
        Generate and write TypeScript interface to file.

        Args:
            entity: UniversalEntity object
            output_path: Path to output .ts file
        """
        from pathlib import Path

        interface_content = self.generate(entity)

        output_file = Path(output_path)
        output_file.parent.mkdir(parents=True, exist_ok=True)
        output_file.write_text(interface_content)
