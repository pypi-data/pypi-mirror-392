# Copyright (C) 2021 ASTRON (Netherlands Institute for Radio Astronomy)
# SPDX-License-Identifier: GPL-3.0-or-later

import os

import numpy as np
import pytest

from everybeam import (
    OSKAR,
    ElementResponseModel,
    Options,
    StationCoordinateSystem,
    StationNode,
    create_telescope,
    load_telescope,
)

DATADIR = os.environ["DATA_DIR"]

# Unlike the Python bindings built using "cibuildwheel", the everybeam Python
# bindings library for testing does not have casacore in its own namespace.
# It will therefore typically conflict with the casacore libraries bundled with
# python-casacore.
# We therefore can't use python-casacore in tests. For testing the OSKAR
# constructor without MS, this file therefore contains a copy of the relevant
# values from the MS.

# Station positions.
# Extracted using: taql 'select str(POSITION,20.15) from OSKAR_MOCK.ms/ANTENNA'
# (The POSITION column in the PHASED_ARRAY subtable has the same values.)

OSKAR_STATION_POSITIONS = np.array(
    [
        [-2564897.75402287, 5085472.86804536, -2860897.72802569],
        [-2564387.29972904, 5085804.60618374, -2860766.56178064],
        [-2564722.47243005, 5085269.20812143, -2861413.42045864],
        [-2564087.82304277, 5085818.78115577, -2861008.22756164],
        [-2564616.64296109, 5085442.49556598, -2861201.69511598],
        [-2565301.60859861, 5085369.48390966, -2860720.62496251],
        [-2564841.47751966, 5085052.24465452, -2861690.53032216],
        [-2565387.2941108, 5085676.04107786, -2860103.03734022],
        [-2564717.96070356, 5085569.24754374, -2860887.6648158],
        [-2564612.41426188, 5085805.52148225, -2860564.47345969],
        [-2565171.07069076, 5085711.55017899, -2860232.89400119],
        [-2564534.49398468, 5085585.48234017, -2861022.38275993],
        [-2565022.02156094, 5085153.62537105, -2861350.74380961],
        [-2564915.32732002, 5085284.51147444, -2861214.65575943],
        [-2564608.23762231, 5085700.40801254, -2860753.78961022],
        [-2565425.78811337, 5084968.08699729, -2861318.77719707],
        [-2565065.2686631, 5085337.65556654, -2860987.29242128],
        [-2564071.35083574, 5085986.18840375, -2860727.30906176],
        [-2565719.52464341, 5085117.55881522, -2860793.27542168],
        [-2564078.23038027, 5085723.79333873, -2861184.48820754],
        [-2565491.81403816, 5085410.60602304, -2860478.6320309],
        [-2564969.56814648, 5085704.84215272, -2860424.1831394],
        [-2564822.1326667, 5085653.13087175, -2860646.78503512],
        [-2564560.86940263, 5086012.30961434, -2860245.25433309],
        [-2565217.50486076, 5085536.96231809, -2860499.80900928],
        [-2565034.76397679, 5085466.94219395, -2860786.17912694],
        [-2565007.36198601, 5085468.12736423, -2860808.48890669],
        [-2564952.55800444, 5085470.49770479, -2860853.10846619],
        [-2564925.15601366, 5085471.68287508, -2860875.41824594],
        [-2564908.71481919, 5085472.39397724, -2860888.80411379],
    ]
)

# Coordinate system axes for the OSKAR stations. The values are equal for all
# stations. Extracted transposed(!) transformation matrix using:
# taql 'select str(COORDINATE_AXES,20.15) from OSKAR_MOCK.ms/PHASED_ARRAY'
OSKAR_COORDINATE_AXES = np.array(
    [
        [-0.89286541387948, -0.450323608861255, 0],  # p axis
        [-0.203214217455512, 0.402916797619005, 0.892391190017242],  # q axis
        [-0.401864821204555, 0.796785229217147, -0.45126263304157],  # r axis
    ]
)


# Positions of the elements within each station. These relative positions are
# the same within all stations. Extracted using:
# taql 'select str(ELEMENT_OFFSET,20.15) from OSKAR_MOCK.ms/PHASED_ARRAY limit 1'
OSKAR_ELEMENT_OFFSETS = np.array(
    [
        [16.5554813010937, 4.18895056578343, -7.34687818917395],
        [-10.0578660288195, -4.01817548497936, 1.86206345708998],
        [1.02905550910531, 3.50168611178359, 5.26644660788676],
        [-14.3857442456206, -0.792688864508596, 11.4113631032265],
        [-4.35525786209929, -3.45027632536044, -2.21357634683777],
        [3.22855796072373, -0.190013888127839, -3.21064502344403],
        [-5.09213695575134, -1.88332792859054, 1.20936854071137],
        [-2.1941787202257, 2.23329683669711, 5.89727794010994],
        [-1.60296086502441, -8.21514042573144, -13.0778144114647],
        [12.6623508500943, 9.86074187576407, 6.13465399665453],
        [-1.25804502344647, -3.81155923359613, -5.60966025956739],
        [1.78784458431498, -4.76458385149344, -10.0048653486403],
        [-0.0258766758710843, -1.26419223839525, -2.20911439088768],
        [2.81080756506413, -7.11593351283489, -15.0675790478461],
        [-8.76059088734478, -1.84194515948122, 4.5493210475889],
        [9.93941589174763, 9.37045989386395, 7.69383988385266],
        [-0.549618366715696, 3.20466260723631, 6.14786138626679],
        [-3.14017934943524, -6.89780061357552, -9.38286868919829],
        [15.0991369720431, 4.27359965225964, -5.90049054839401],
        [-12.5798616729315, -6.25145238991624, 0.164735413677183],
        [-2.55179728315872, 3.82949395374775, 9.03412221213955],
        [-1.55435598971357, 3.5321947878636, 7.62093152362825],
        [-4.08829933020418, 4.35198385108379, 11.3249796360328],
        [5.28053846677982, -4.99443093675516, -13.5210651155462],
        [10.5039601471129, 11.4754749122351, 10.9078759938188],
        [8.43841584448196, 4.75487028082768, 0.88087934366602],
        [0.0491384075866498, 5.87894119534923, 10.3365671539697],
        [7.04268145879229, -4.24709399616484, -13.7707561705131],
        [5.46984944673609, 3.05260613219386, 0.518836237876025],
        [0.171610799417974, -7.64100588940845, -13.6443935780066],
        [-14.1424192778816, -5.29668645227975, 3.24205719333264],
        [-3.83693507013733, -2.21048455152134, -0.486085481202392],
        [-4.54744349915195, 0.283696034251706, 4.55057039525492],
        [3.15843595378296, 5.99267220685557, 7.7684437873381],
        [9.3960042797863, 3.70007860375937, -1.83431009108044],
        [3.40323855162617, -3.75470875756205, -9.66031311017465],
        [-4.96295402289127, -0.711377320626006, 3.16361600773013],
        [-11.3918227286181, 1.87324070697167, 13.4523509939149],
        [-9.79237445369621, -7.16690723521905, -3.93401732207201],
        [11.5888011828784, 8.61393930753788, 4.88923285186647],
        [2.22505849216406, -2.40644227881466, -6.23049681046238],
        [7.71637171500546, 1.11190833698441, -4.90841926245184],
        [-2.16349887359229, -9.69011305855537, -15.1829652287154],
        [9.65748211289254, -3.55662401936145, -14.8801768979425],
        [-16.1881182612214, -5.47648189043624, 4.74636102234471],
        [-14.4507309872163, -8.34742399081331, -1.87000573868113],
        [5.97330643532515, -5.53859196703588, -15.0988127394967],
        [-12.4047439629468, -10.2025144963475, -6.96752269429762],
        [9.27223930008157, -1.84325619159945, -11.5118463512224],
        [17.1087643761837, 5.29702633251711, -5.88308892018867],
        [2.90101574805308, 7.38043333292724, 10.4480268136029],
        [14.2742957007116, 10.2177078234505, 5.32944942590197],
        [-5.68203268904711, -4.49900802789452, -2.88376213054072],
        [-5.65292610849066, 4.17389222439532, 12.4038805847637],
        [-15.8810357483756, -3.50142078422019, 7.9602186540728],
        [-3.54227656515997, -8.96738187630096, -12.679004788646],
        [16.9107205853767, 6.52242611255664, -3.54306074172546],
        [1.14476691586902, 4.92374188302931, 7.67429651679128],
        [7.38528033345689, -2.49545295746242, -10.9830153320182],
        [-15.0506645328673, -9.60927230451613, -3.56376421733386],
        [6.54954623820933, 6.67950031512822, 5.96126238843418],
        [-8.55810623854731, -4.59305905929565, -0.48858417653444],
        [14.1383559201143, 7.81182891722556, 1.20249712854823],
        [12.3448140194311, 11.2930843979851, 8.94648939727986],
        [13.9551595727136, 2.13784188394946, -8.65280345664518],
        [-0.477734594358485, 4.64721958861635, 8.63093987248976],
        [-8.5750917770045, 0.000228432459731269, 7.63681608681055],
        [1.00033051078898, -1.70846142727755, -3.9074240646095],
        [-6.98262768811196, -0.959872480105242, 4.5234417030784],
        [-0.800885855848384, 0.33416698167973, 1.30324809390118],
        [6.76208853761393, 9.08383424426231, 10.0172695861815],
        [6.15742915416004, 7.6601457306675, 8.04196168707838],
        [0.493657811317322, 8.00009136339395, 13.6859790074614],
        [-11.9991930081178, -0.378917661054038, 10.0166449123485],
        [7.85805958781091, -0.947739842553755, -8.67127595427854],
        [-4.16945139741525, -4.88502270169501, -4.91234578368791],
        [4.18437133200903, -1.04520489691824, -5.57182287311066],
        [8.16381593230412, -3.06665887388128, -12.6848945705001],
        [1.01498220022606, 9.43512046472324, 15.7555234162304],
        [2.66919821408369, -8.22460713865286, -16.8990334871185],
        [-0.502119386493071, -5.34787632443216, -8.99548167361181],
        [12.6854073404799, 6.67772789509492, 0.493938523674544],
        [-10.991230013371, -10.8224635998787, -9.32093674061109],
        [11.0573747190767, -0.464438130387627, -10.6670196116331],
        [10.2554482860659, 10.4650629654065, 9.34512054186056],
        [-1.76209366992768, -1.20066435662314, -0.550783842478642],
        [-5.16455501421405, 3.05969423578254, 10.0016527403562],
        [-4.16012517102309, -6.61139691279505, -7.96887484861597],
        [-14.1642074524778, -4.35679811598118, 4.92100197823108],
        [11.0972701483396, -2.23321336954262, -13.8256382286991],
        [-7.17844978823016, -8.7110921604544, -8.98834254409167],
        [-12.9275062267514, -1.63677139709808, 8.6223729170656],
        [-16.6218126140284, -8.84488026515083, -0.814931634723746],
        [-11.5162668576849, -8.05648106023335, -3.9695344914347],
        [10.5018980321654, 3.48264766965343, -3.20305969832889],
        [-16.3320079251674, -7.78154845861556, 0.804490657800544],
        [-0.661011484115441, -6.9781056240921, -11.7324454533947],
        [-12.5596576947588, -9.3026791217497, -5.24074574161426],
        [-4.04315955872421, -10.1074040482325, -14.2458652400783],
        [9.64714153058337, 8.26716812373206, 6.00606042617305],
        [7.79336957275457, 10.3580397721139, 11.3487172416873],
        [-1.81474054779212, 0.71663813297364, 2.88144191344667],
        [5.66330424772569, 0.247003503125796, -4.60723723582102],
        [14.7393314970109, 0.659438405562303, -11.9615222718721],
        [-3.06641942142806, 7.34160896916255, 15.6936807067622],
        [5.72532829823889, 9.4326664110248, 11.5564659107233],
        [-5.6182449613208, 5.55275487107853, 14.8076254941941],
        [-5.48823129344243, -8.02100539176279, -9.27506783344421],
        [-16.8716983458569, -6.84895042783989, 2.93177277656365],
        [10.3263838794465, 1.09238994785014, -7.26718765590541],
        [-3.97758885113997, 1.73086975783152, 6.59834045898749],
        [-10.5379008010483, -9.26727526101548, -6.97867758417284],
        [7.66973252828606, 5.48241540795525, 2.85002974355807],
        [12.4217458632466, 1.17815883570532, -8.98173884928554],
        [6.39710701780908, 1.37799658446014, -3.26374229925006],
        [4.75131431629286, 6.12052249155089, 6.57567372276105],
        [7.40973069246574, 3.49172840951483, -0.433345161872373],
        [5.96592817313785, -3.82518458634645, -12.0669136714132],
        [2.12297192826446, 6.31117652881326, 9.25293653193178],
        [-2.44037862442501, 6.7314473655629, 14.0588200466506],
        [-12.4065066204568, -4.63257819593932, 2.86876995854843],
        [-7.00416489003478, 4.2566646422742, 13.7533545423077],
        [-2.00278358166554, -3.21987073276433, -3.90171276099339],
        [8.81155685980384, 2.34890113828025, -3.69958615645448],
        [0.276360056086017, -5.91319727293584, -10.6869199351705],
        [4.23327067856592, 7.24270049213266, 9.01841612719525],
        [-8.64026341359281, 2.27212686315214, 11.7062983915272],
        [1.67889753639175, 2.87830891119833, 3.58705562739331],
        [10.4061532478142, 5.95928265960378, 1.25514820875925],
        [-6.20904096517788, -11.0850552149705, -14.0432924399443],
        [3.64607383209254, 3.27863507446807, 2.54206554388312],
        [-13.3945732932034, -8.78179312611462, -3.57750704166012],
        [9.32310069743605, 6.31529367144485, 2.84824496117803],
        [3.2884146796219, 9.25620639036112, 13.4150490421722],
        [-11.3793209255607, -5.04880905063175, 1.21909560468255],
        [-8.39552266346186, -3.55861462916841, 1.19312702105305],
        [1.65071944146274, -0.414746847878621, -2.20233221784355],
        [2.6976968228266, 4.36157414605086, 5.29875116896538],
        [-14.2423496179937, -6.53707368609402, 1.14092213643704],
        [0.916988227879157, -8.99852238228183, -16.7051168815278],
        [-9.66900886949382, -10.91365475233, -10.659434286518],
        [11.9226199674884, 2.09583723710907, -6.91692411382365],
        [13.4802087245256, 4.39148163471924, -4.25063771629013],
        [6.65101998188459, 2.44187573006576, -1.61139077181413],
        [-7.75707507462102, -8.04926919592417, -7.30448960764813],
        [1.58615112615771, -3.51085186435188, -7.61156141613307],
        [-6.15359591921696, -7.42147861444004, -7.62396565367431],
        [-9.30442410017733, -8.09285023741182, -6.003472491722],
        [6.08771046688615, 4.50519101038366, 2.53340934933995],
        [8.25413096777036, 6.57965045345685, 4.26696847506744],
        [-5.32978659486671, 6.62763855855162, 16.4486436535168],
        [-1.5864979126704, 5.04732390372114, 10.3247875902615],
        [-7.09625603734311, -5.97969629669701, -4.2387689134629],
        [-7.11992850039667, 1.11639251730608, 8.3117315438206],
        [-2.06886584422239, -2.27432277940553, -2.17332950416799],
        [6.29121826702639, -1.95617370366667, -9.05652123100899],
        [-13.8209773515536, 0.394766473966029, 13.0050845294783],
        [1.25619383708496, 0.546691234689718, -0.153402045563964],
        [16.5034003322765, 8.23759749413021, -0.151884980540935],
        [-10.3952177225029, -0.162482322468384, 8.97040548117232],
        [-12.6855183207725, -2.64729499140035, 6.62261349935596],
        [-11.9645856688234, -7.11140877780664, -1.90159638680774],
        [2.71104819718718, 1.8331235874102, 0.82242772071989],
        [-5.41807569008119, -9.74651899251765, -12.3842479785833],
        [-8.58068150169515, 3.82967649584276, 14.4033722851163],
        [13.7421745525846, 1.08363767943793, -10.3245198729045],
        [-11.0222493138786, 1.04876845500793, 11.6674793747614],
        [-5.4515986942908, 2.00265743731114, 8.39088664237512],
        [-2.88204120852368, -0.595849469700929, 1.51447708857826],
        [13.8347540169589, 10.9293106820957, 6.97733899738781],
        [9.1064171854585, 11.4235517514947, 12.060756172202],
        [-6.64821675134273, -2.6928128458961, 1.16581985063853],
        [-14.3982761274644, -10.7502185784622, -6.15928399349901],
        [7.97050175263651, -5.10629534172035, -16.1140861963794],
        [-0.811784548804616, -9.66079851743013, -16.3349530159086],
        [3.50064326643211, -5.65105459463347, -13.095394517908],
        [12.5837439431456, 3.28832472229138, -5.40012680815134],
        [0.403359760111163, -2.83473030068758, -5.36443116055065],
        [-8.40265272972982, -5.69048999954555, -2.56473228010955],
        [-0.215552219319017, 1.73976914844875, 3.26383153836906],
        [-2.40652972244119, -5.77583051871625, -8.05516907669064],
        [7.70188092648904, 8.60593764719521, 8.33654001890307],
        [14.4503810880755, 8.86463518795702, 2.78354659990178],
        [-0.909932006638541, -4.60591703716236, -7.32224819232948],
        [-5.35787662981251, 0.722064595758128, 6.04630726884282],
        [4.41099621894609, 10.3769243792626, 14.3941806558591],
        [-1.13001445338207, 7.76164241410151, 14.7108902891962],
        [-7.06257257828839, -0.0303630801575053, 6.23585115760249],
        [5.32659673280187, -6.65062621072788, -16.4863918008545],
        [-15.6110512098417, -1.82875666348791, 10.6731771108442],
        [-11.1504246570121, -1.69338550917476, 6.93985856740709],
        [-0.797991081734478, 6.96942948516821, 13.0164178975915],
        [14.4975100875544, 5.47178652632673, -3.24910708373378],
        [12.5457766692097, 7.72158033330622, 2.46139338030556],
        [-12.1486459294369, -3.50813102633672, 4.62454962490735],
        [-8.87278522840833, -9.76785773212415, -9.34538825921757],
        [-1.31230707573632, 8.82501721453984, 16.7508073104567],
        [0.963480480611556, -8.09586334437397, -15.1527131673738],
        [-3.40201722969381, -5.4450986577961, -6.58468687378023],
        [2.49295408743046, 8.07536501614836, 12.0384463924516],
        [10.5551443068206, 7.34844153141557, 3.57527606368508],
        [-7.96786725584633, 5.27627920982496, 16.4118771364881],
        [-5.74555214876631, -6.04297698183544, -5.5533503754773],
        [-14.2277042777752, -2.71066163854062, 7.88409768556433],
        [13.3959071429608, 9.1382235875115, 4.20566120031326],
        [-2.86519787568727, 0.994476146286382, 4.30748303509423],
        [12.6897569470968, -0.0669409464801937, -11.4188591892226],
        [5.52686502940037, -1.34602454768996, -7.29851058667502],
        [15.9088663730203, 9.86562408472054, 3.25214121377984],
        [-7.04359489980584, 2.48750510382339, 10.6646993945391],
        [-6.35989036890761, -3.88981128030727, -1.20446038916627],
        [12.3062200245353, 5.6306214344684, -1.01723671750065],
        [3.23984408270821, 0.791775659040805, -1.48716991816373],
        [6.31270606070988, 10.5801761148008, 13.0595203920693],
        [-10.8038279289039, -3.46647538361132, 3.50049368196163],
        [1.86199276550859, -6.63480413290294, -13.3731066562414],
        [-4.56015361542585, 5.29286805819139, 13.406482086748],
        [3.8153596772332, -2.18088209897626, -7.24844744091505],
        [9.47957036953588, 1.78831281051669, -5.2842944316871],
        [2.56514720496067, -1.30268813199119, -4.58448126047558],
        [15.9215384654101, 6.9507991739513, -1.90579062540082],
        [-10.2022565157151, -6.43372445188422, -2.27443742599695],
        [11.0571230991853, 4.53868544200459, -1.83288226517641],
        [5.19147247927442, 5.37461001049672, 4.86665535475903],
        [13.0696529306671, -0.967173527283145, -13.3466918770169],
        [14.8691317458798, 7.25115553666776, -0.438253313417468],
        [13.9437365847948, 6.17848988692029, -1.50814111112914],
        [15.7777199906506, 3.066060680151, -8.63691889346288],
        [0.612773538061496, 6.94472961173989, 11.7164716510934],
        [16.5306563497576, 9.17129059037781, 1.47244546352845],
        [14.0208216492653, 3.1250710544736, -6.96814736813063],
        [-10.1297904894906, 3.66967119954091, 15.5003887750045],
        [8.02755819256436, 7.779896196901, 6.58798872118329],
        [-4.77135223956034, -8.64428275857845, -11.0139813063118],
        [-8.13801113689855, 1.41020517114038, 9.73714799163514],
        [-2.93389020135291, 5.71315613545945, 12.7003329380874],
        [4.78315597652903, 1.89149634308587, -0.919787599550772],
        [-3.81022699994892, 2.77227283384291, 8.28808317728514],
        [-10.1509829817294, -5.55053816755313, -0.760674250370697],
        [8.56632557093324, 9.66954449644215, 9.44471139866649],
        [-2.69109328375139, -7.6025680511675, -11.0271886959241],
        [9.41484815611523, -0.559358404857458, -9.37189227756108],
        [-13.9138573657327, -7.31651176987285, -0.527849388895199],
        [10.8299075025342, 0.391829679815185, -8.95255765737198],
        [5.27789997870083, -3.228243690295, -10.4001946458179],
        [-15.5009935337352, -4.29579741077792, 6.21916344234916],
        [-9.45631924865962, -1.07007403295504, 6.5317680762122],
        [4.93941858596001, 8.33215027169243, 10.3131865047913],
        [4.56164777147834, -2.66438956751007, -8.76676181161039],
        [11.383099238842, -1.25260057882865, -12.3487308092206],
        [-10.5724631035401, -2.35877785314925, 5.25029432734744],
        [-12.6327772594363, 0.211114616962508, 11.6226813370226],
        [-6.6034361554764, -9.39662092048471, -10.7108360190629],
        [15.8364100475352, 5.38461040200408, -4.59536843299379],
        [15.525092985866, 1.96143708274797, -10.3623572593612],
        [-7.20006087885588, -10.4609542354558, -12.058792911584],
    ]
)

# Extracted using: taql 'select str(DELAY_DIR,20.15) from OSKAR_MOCK.ms/FIELD'
OSKAR_DELAY_DIRECTION = np.array([0.349065850398866, -0.523598775598299])


def verify_telescope(telescope):
    assert type(telescope) is OSKAR
    assert telescope.nr_stations == OSKAR_STATION_POSITIONS.shape[0]

    response = telescope.station_response(
        time=4.45353e09,
        station_idx=0,
        freq=5.0e07,  # Frequency of channel 4
        ra=0.349066,
        dec=-0.523599,
    )

    # The reference solution is the same as pixel (8,8) in toskar.cc.
    expected_response = np.array(
        [
            [-0.00115441 + 0.00881435j, 6.07546e-05 + 0.0013592j],
            [-0.000379462 + 0.00158725j, 0.000982019 - 0.00856565j],
        ]
    )

    np.testing.assert_allclose(response, expected_response, rtol=1e-5)


def test_oskar_from_ms():
    ms_path = os.path.join(DATADIR, "OSKAR_MOCK.ms")
    differential_beam = False
    telescope = load_telescope(
        ms_path,
        use_differential_beam=differential_beam,
        element_response_model="skala40_wave",
    )

    verify_telescope(telescope)


def test_oskar_from_metadata():
    root_node = StationNode()

    for i in range(OSKAR_STATION_POSITIONS.shape[0]):
        position = OSKAR_STATION_POSITIONS[i, :]
        station_node = StationNode(
            coordinate_system=StationCoordinateSystem(
                position, OSKAR_COORDINATE_AXES
            ),
            name=f"s{i:04d}",
        )
        for j in range(OSKAR_ELEMENT_OFFSETS.shape[0]):
            station_node.add_child_element(OSKAR_ELEMENT_OFFSETS[j, :])

        root_node.add_child_node(station_node, position)

    options = Options()
    options.element_response_model = ElementResponseModel.skala40_wave

    telescope = create_telescope(
        options, root_node, delay_directions=OSKAR_DELAY_DIRECTION
    )

    verify_telescope(telescope)
