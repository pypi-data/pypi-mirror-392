weekly_flow:
  - week: 1
    label: 初回サイクル
    steps:
      - "1. CLIアプリケーションを起動する。"
      - "2. 現在時刻からセッションIDを生成する。"
      - "3. セッションIDを基にtmuxセッション名を決定する。"
      - "4. logs/<session-id> ディレクトリを作成する。"
      - "5. 初期ステータスを待機中として表示する。"
      - "6. ユーザーから最初の指示テキストを受信する。"
      - "7. サイクル用のログディレクトリ logs/<session-id>/<yy-mm-dd-hhmmss> を作成する。"
      - "8. tmux制御・ワークツリー・Codex監視・ログ管理の各オブジェクトを初期化する。"
      - "9. tmuxセッションで必要なペインレイアウトを確認する。"
      - "10. 不足しているペインを分割してメイン/Boss/ワーカー構成を整える。"
      - "11. `.parallel-dev/sessions/<session-id>` 配下に各種ワークツリーを準備する。"
      - "12. 各ワーカー用ディレクトリ `.parallel-dev/sessions/<session-id>/worktrees/worker-N` を再生成する。"
      - "13. Boss用ディレクトリ `.parallel-dev/sessions/<session-id>/worktrees/boss` を再生成する。"
      - "14. tmuxメインペインで `codex` を起動し、メインセッションのrolloutファイルを検出する。"
      - "15. ユーザー指示の末尾に完了フラグを作成する手順付きの完全指示文を保持する。"
      - "16. メインペインへフォーク準備用メッセージ（文字列 `Fork`）のみ送信する。"
      - "17. メインペインから最初の出力を検知したら Ctrl+C を二回送信して停止する。"
      - "18. 生成されたrolloutファイルからメインセッションIDを取得しpane情報と紐づける。"
      - "19. 各ワーカーペインへ Ctrl+C を二回送信して待機状態にする。"
      - "20. 各ワーカーペインに `codex resume <main-id>` を送信する。"
      - "21. 各ワーカーペインに Esc を二回送信する。"
      - "22. 各ワーカーペインに Enter を1回送信してフォークを確定する。"
      - "23. ワーカーの新しいrolloutファイルが現れるまで待機する。"
      - "24. 新しいrolloutからワーカーセッションIDを取得しpane情報と紐づける。"
      - "25. 各ワーカーペインへ、割り当てたワークツリーへの移動手順（pwd→必要ならcd→再度pwd）とタスク本体を含む専用指示文を送信する。"
      - "26. 監視処理が全ワーカーの完了フラグ生成を検知するまで待機する。"
      - "26a. ワーカー完了直後に `/continue` を送ると既存ワーカーペインへ同じユーザー指示だけを再送し（フォークやワークツリー再作成は行わない）、追加作業が終わったらCLIの `/done` コマンドで次工程へ進む。"
      - "27. ワーカー完了ステータスをログへ書き出す。"
      - "28. Bossペインに Ctrl+C を送信して待機状態にする。"
      - "29. Bossペインに `codex resume <main-id>` を送信する。"
      - "30. Bossペインに Esc を二回送信する。"
      - "31. Bossペインに Enter を送信して独立セッションにフォークする。"
      - "32. 新しいBossセッションIDを取得する。"
      - "33. ワーカー候補一覧と採点手順を含む評価指示文を生成し、Boss用ワークツリー内で作業するよう注意書きを付与する。"
      - "34. 評価指示文をBossペインへ送信する。"
      - "35. Bossセッションの評価JSONを受信し、Bossモードがrewriteの場合のみ追加統合の完了フラグを検知するまで待機する。"
      - "36. Bossレスポンスを取得する。"
      - "37. BossレスポンスのJSONを解析する。"
      - "38. score と comment を候補ごとに抽出する。"
      - "39. ワーカー完了情報とBossスコアを統合したスコアボードを組み立てる。"
      - "40. 候補一覧とスコアボードをUIへ送信する。"
      - "41. ユーザーの採択選択を待機する。"
      - "42. 選択された候補のブランチをmainへfast-forwardマージする。"
      - "43. 選択されたセッションIDでメインペインに `codex resume` を送信する。"
      - "44. サイクルの指示・tmux配置・完了情報・スコアボードをYAML/JSONLへ記録する。"
      - "45. 会話ログパスやセッションIDを含むマニフェストを保存する。"
      - "46. 実行状態を待機中に戻す。"
      - "47. スコアボードと採択結果を履歴に追加する。"
      - "48. 第1週目のサイクルを完了と宣言する。"
  - week: 2
    label: 2回目以降のサイクル
    steps:
      - "1. 1.6の手順で次のユーザー指示テキストを受信する。"
      - "2. 前回サイクルで採択したセッションIDとtmuxセッション名を保持する。"
      - "3. 1.7〜1.49の手順を順に再実行し、ログ準備から記録保存まで第1サイクルと同じ処理を行う。"

esc_behavior:
  description: "ESCキー操作の共通ルール"
  rules:
    - "ESCを1回押すとCLIControllerが一時停止モードへ入り、全ペインへEscapeをブロードキャストしてCodex入力を中断させる。"
    - "一時停止中に再度ESCを押すと直前に採択された `_last_selected_session` をメインに戻し、進行中サイクルをキャンセルする。"
    - "巻き戻し後に再開する際はステップ15から同じ手順（Ctrl+C×2 → `codex resume <_last_selected_session>` → 完了プロトコル付き指示投入）を繰り返す。"

continue_behavior:
  description: "ワーカー完了後の分岐"
  rules:
    - "ワーカーが完了フラグを `touch` した直後は `/continue` で同じ指示文のみを既存ワーカーペインへ再送でき、既存の作業内容を保持したまま追記が可能。"
    - "追加作業が完了したら CLI `/done` コマンドを送るとBoss評価（ステップ28以降）へ進む。Bossのscore/skipモードはJSON受信で完了し、rewriteモードでは統合作業の完了フラグを待機する。"
