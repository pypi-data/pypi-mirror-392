# modules/generate_networking.py
import os

def get_networking_resources(project_name):
    """Networking module ke resources input leta hai"""
    resources = {}
    
    print("\nüåê NETWORKING MODULE CONFIGURATION")
    print("Ab hum networking resources ke values input karenge...")
    
    # VPC Configuration
    print("\nüîπ VPC Configuration:")
    vpc_cidr = input("   Enter VPC CIDR block (e.g., 10.0.0.0/16): ").strip() or "10.0.0.0/16"
    vpc_name = input("   Enter VPC name: ").strip() or f"{project_name}-vpc"
    
    resources["vpc"] = {
        "cidr_block": vpc_cidr,
        "name": vpc_name,
        "enable_dns_hostnames": True,
        "enable_dns_support": True
    }
    
    # Subnets Configuration - Now flexible
    print("\nüîπ Subnets Configuration:")
    num_public_subnets = int(input("   Number of public subnets: ").strip() or "2")
    num_private_subnets = int(input("   Number of private subnets: ").strip() or "2")
    
    public_subnets = []
    private_subnets = []
    
    # Public Subnets
    print("\n   üìç Public Subnets CIDR blocks:")
    for i in range(num_public_subnets):
        default_cidr = f"10.0.{i+1}.0/24"
        cidr = input(f"     Public subnet {i+1} CIDR [default: {default_cidr}]: ").strip() or default_cidr
        public_subnets.append(cidr)
    
    # Private Subnets  
    print("\n   üìç Private Subnets CIDR blocks:")
    for i in range(num_private_subnets):
        default_cidr = f"10.0.{i+num_public_subnets+10}.0/24"
        cidr = input(f"     Private subnet {i+1} CIDR [default: {default_cidr}]: ").strip() or default_cidr
        private_subnets.append(cidr)
    
    resources["subnets"] = {
        "public_cidrs": public_subnets,
        "private_cidrs": private_subnets,
        "public_count": num_public_subnets,
        "private_count": num_private_subnets
    }
    
    # Internet Gateway
    print("\nüîπ Internet Gateway:")
    igw_name = input("   Enter IGW name [default: main-igw]: ").strip() or f"{project_name}-igw"
    resources["internet_gateway"] = {"name": igw_name}
    
    # NAT Gateway Configuration
    print("\nüîπ NAT Gateway Configuration:")
    create_nat = input("   Create NAT Gateway? (y/n) [default: y]: ").strip().lower() or 'y'
    nat_strategy = "1"
    if create_nat == 'y':
        print("\n   üîß NAT Gateway Strategy:")
        print("   1. Single NAT Gateway (Cost Effective)")
        print("   2. One NAT per AZ (High Availability)")
        nat_strategy = input("   Select strategy (1 or 2) [default: 1]: ").strip() or "1"
        nat_name = input("   Enter NAT Gateway name [default: main-nat]: ").strip() or f"{project_name}-nat"
        resources["nat_gateway"] = {
            "name": nat_name,
            "create": True,
            "strategy": nat_strategy
        }
    else:
        resources["nat_gateway"] = {"create": False, "strategy": "1"}
    
    # Additional Features
    print("\nüîπ Additional Features:")
    enable_flow_logs = input("   Enable VPC Flow Logs? (y/n) [default: n]: ").strip().lower() or 'n'
    resources["flow_logs"] = {"enable": enable_flow_logs == 'y'}
    
    return resources

def generate_networking_main_tf(resources, project_name):
    """Networking module ke liye main.tf content generate karta hai"""
    content = f'''# Main Terraform configuration file
# Auto-generated by Python Script
# Project: {project_name}
# Module: Networking

# VPC Configuration
resource "aws_vpc" "main" {{
  cidr_block           = "{resources["vpc"]["cidr_block"]}"
  enable_dns_hostnames = {str(resources["vpc"]["enable_dns_hostnames"]).lower()}
  enable_dns_support   = {str(resources["vpc"]["enable_dns_support"]).lower()}
  tags = {{
    Name        = "{resources["vpc"]["name"]}"
    Project     = var.project_name
    Environment = var.environment
  }}
}}

# Internet Gateway
resource "aws_internet_gateway" "main" {{
  vpc_id = aws_vpc.main.id
  tags = {{
    Name        = "{resources["internet_gateway"]["name"]}"
    Project     = var.project_name
    Environment = var.environment
  }}
}}

'''
    
    # Public Subnets - Dynamic with count
    content += '# Public Subnets\n'
    content += f'''resource "aws_subnet" "public" {{
  count = length(var.public_subnet_cidrs)

  vpc_id                  = aws_vpc.main.id
  cidr_block              = var.public_subnet_cidrs[count.index]
  availability_zone       = element(var.availability_zones, count.index)
  map_public_ip_on_launch = true

  tags = {{
    Name        = "${{var.project_name}}-public-${{count.index + 1}}"
    Type        = "public"
    Project     = var.project_name
    Environment = var.environment
  }}
}}

'''
    
    # Private Subnets - Dynamic with count
    content += '# Private Subnets\n'
    content += f'''resource "aws_subnet" "private" {{
  count = length(var.private_subnet_cidrs)

  vpc_id            = aws_vpc.main.id
  cidr_block        = var.private_subnet_cidrs[count.index]
  availability_zone = element(var.availability_zones, count.index)
  map_public_ip_on_launch = false

  tags = {{
    Name        = "${{var.project_name}}-private-${{count.index + 1}}"
    Type        = "private"
    Project     = var.project_name
    Environment = var.environment
  }}
}}

'''
    
    # Public Route Table
    content += f'''# Public Route Table
resource "aws_route_table" "public" {{
  vpc_id = aws_vpc.main.id
  route {{
    cidr_block = "0.0.0.0/0"
    gateway_id = aws_internet_gateway.main.id
  }}
  tags = {{
    Name        = "${{var.project_name}}-public-rt"
    Project     = var.project_name
    Environment = var.environment
  }}
}}

'''
    
    # Public Route Table Associations - Dynamic
    content += '# Public Route Table Associations\n'
    content += f'''resource "aws_route_table_association" "public" {{
  count = length(var.public_subnet_cidrs)

  subnet_id      = aws_subnet.public[count.index].id
  route_table_id = aws_route_table.public.id
}}

'''
    
    # NAT Gateway (if enabled)
    if resources["nat_gateway"]["create"]:
        nat_strategy = resources["nat_gateway"]["strategy"]
        
        if nat_strategy == "1":
            # Single NAT Gateway (Cost Effective)
            content += f'''# NAT Gateway - Single (Cost Effective)
resource "aws_eip" "nat" {{
  domain = "vpc"

  lifecycle {{
    prevent_destroy = true
  }}

  tags = {{
    Name        = "${{var.project_name}}-nat-eip"
    Project     = var.project_name
    Environment = var.environment
  }}
}}

resource "aws_nat_gateway" "main" {{
  allocation_id = aws_eip.nat.id
  subnet_id     = aws_subnet.public[0].id

  depends_on = [aws_internet_gateway.main]

  tags = {{
    Name        = "{resources["nat_gateway"]["name"]}"
    Project     = var.project_name
    Environment = var.environment
  }}
}}

'''
            
            # Single Private Route Table
            content += f'''# Private Route Table
resource "aws_route_table" "private" {{
  vpc_id = aws_vpc.main.id
  route {{
    cidr_block     = "0.0.0.0/0"
    nat_gateway_id = aws_nat_gateway.main.id
  }}
  tags = {{
    Name        = "${{var.project_name}}-private-rt"
    Project     = var.project_name
    Environment = var.environment
  }}
}}

'''
            
            # Private Route Table Associations - Dynamic
            content += '# Private Route Table Associations\n'
            content += f'''resource "aws_route_table_association" "private" {{
  count = length(var.private_subnet_cidrs)

  subnet_id      = aws_subnet.private[count.index].id
  route_table_id = aws_route_table.private.id
}}

'''
        
        else:
            # One NAT per AZ (High Availability)
            content += f'''# NAT Gateway - One per AZ (High Availability)
resource "aws_eip" "nat" {{
  count = length(var.public_subnet_cidrs)

  domain = "vpc"

  lifecycle {{
    prevent_destroy = true
  }}

  tags = {{
    Name        = "${{var.project_name}}-nat-eip-${{count.index + 1}}"
    Project     = var.project_name
    Environment = var.environment
  }}
}}

resource "aws_nat_gateway" "main" {{
  count = length(var.public_subnet_cidrs)

  allocation_id = aws_eip.nat[count.index].id
  subnet_id     = aws_subnet.public[count.index].id

  depends_on = [aws_internet_gateway.main]

  tags = {{
    Name        = "${{var.project_name}}-nat-${{count.index + 1}}"
    Project     = var.project_name
    Environment = var.environment
  }}
}}

'''
            
            # Multiple Private Route Tables (one per AZ)
            content += '# Private Route Tables - One per AZ\n'
            content += f'''resource "aws_route_table" "private" {{
  count = length(var.private_subnet_cidrs)

  vpc_id = aws_vpc.main.id
  route {{
    cidr_block     = "0.0.0.0/0"
    nat_gateway_id = aws_nat_gateway.main[count.index].id
  }}
  tags = {{
    Name        = "${{var.project_name}}-private-rt-${{count.index + 1}}"
    Project     = var.project_name
    Environment = var.environment
  }}
}}

'''
            
            # Private Route Table Associations - Dynamic
            content += '# Private Route Table Associations\n'
            content += f'''resource "aws_route_table_association" "private" {{
  count = length(var.private_subnet_cidrs)

  subnet_id      = aws_subnet.private[count.index].id
  route_table_id = aws_route_table.private[count.index].id
}}

'''
    
    # VPC Flow Logs (if enabled)
    if resources["flow_logs"]["enable"]:
        content += f'''# VPC Flow Logs
resource "aws_cloudwatch_log_group" "vpc_flow_log" {{
  name = "/aws/vpc/${{var.project_name}}-flow-log"

  retention_in_days = 30

  tags = {{
    Project     = var.project_name
    Environment = var.environment
  }}
}}

resource "aws_iam_role" "vpc_flow_log_role" {{
  name = "${{var.project_name}}-vpc-flow-log-role"

  assume_role_policy = <<EOF
{{
  "Version": "2012-10-17",
  "Statement": [
    {{
      "Action": "sts:AssumeRole",
      "Principal": {{
        "Service": "vpc-flow-logs.amazonaws.com"
      }},
      "Effect": "Allow"
    }}
  ]
}}
EOF

  tags = {{
    Project     = var.project_name
    Environment = var.environment
  }}
}}

resource "aws_iam_role_policy" "vpc_flow_log_policy" {{
  name = "${{var.project_name}}-vpc-flow-log-policy"
  role = aws_iam_role.vpc_flow_log_role.id

  policy = <<EOF
{{
  "Version": "2012-10-17",
  "Statement": [
    {{
      "Action": [
        "logs:CreateLogGroup",
        "logs:CreateLogStream",
        "logs:PutLogEvents",
        "logs:DescribeLogGroups",
        "logs:DescribeLogStreams"
      ],
      "Effect": "Allow",
      "Resource": "*"
    }}
  ]
}}
EOF
}}

resource "aws_flow_log" "vpc_flow_log" {{
  iam_role_arn    = aws_iam_role.vpc_flow_log_role.arn
  log_destination = aws_cloudwatch_log_group.vpc_flow_log.arn
  traffic_type    = "ALL"
  vpc_id          = aws_vpc.main.id

  tags = {{
    Project     = var.project_name
    Environment = var.environment
  }}
}}

'''
    
    return content

def generate_networking_variables_tf(project_name, resources):
    """Networking module ke liye variables.tf generate karta hai"""
    # Calculate required AZ count
    required_az_count = max(resources["subnets"]["public_count"], resources["subnets"]["private_count"])
    
    # Default AZs based on requirement
    if required_az_count == 1:
        default_azs = '["us-east-1a"]'
    elif required_az_count == 2:
        default_azs = '["us-east-1a", "us-east-1b"]'
    else:
        default_azs = '["us-east-1a", "us-east-1b", "us-east-1c"]'
    
    # Default CIDR blocks
    public_cidrs = resources["subnets"]["public_cidrs"]
    private_cidrs = resources["subnets"]["private_cidrs"]
    
    content = f'''# Variables configuration file
# Auto-generated by Python Script
# Project: {project_name}
# Module: Networking

variable "availability_zones" {{
  description = "List of availability zones for subnets. Should have at least max(public_subnet_count, private_subnet_count) zones"
  type        = list(string)
  default     = {default_azs}
}}

variable "environment" {{
  description = "Environment name (dev, staging, prod)"
  type        = string
  default     = "dev"
  validation {{
    condition     = contains(["dev", "staging", "prod"], var.environment)
    error_message = "Environment must be dev, staging, or prod."
  }}
}}

variable "project_name" {{
  description = "Project name for tagging"
  type        = string
  default     = "{project_name}"
}}

variable "region" {{
  description = "AWS region"
  type        = string
  default     = "us-east-1"
}}

variable "public_subnet_cidrs" {{
  description = "List of CIDR blocks for public subnets"
  type        = list(string)
  default     = {public_cidrs}
}}

variable "private_subnet_cidrs" {{
  description = "List of CIDR blocks for private subnets"
  type        = list(string)
  default     = {private_cidrs}
}}

variable "create_nat_gateway" {{
  description = "Whether to create NAT Gateway"
  type        = bool
  default     = {str(resources["nat_gateway"]["create"]).lower()}
}}

variable "nat_gateway_strategy" {{
  description = "NAT Gateway deployment strategy: 'single' for one NAT or 'multi' for one per AZ"
  type        = string
  default     = "{"single" if resources["nat_gateway"]["strategy"] == "1" else "multi"}"
  validation {{
    condition     = contains(["single", "multi"], var.nat_gateway_strategy)
    error_message = "NAT Gateway strategy must be 'single' or 'multi'."
  }}
}}

variable "enable_flow_logs" {{
  description = "Whether to enable VPC Flow Logs"
  type        = bool
  default     = {str(resources["flow_logs"]["enable"]).lower()}
}}
'''
    
    return content

def generate_networking_outputs_tf(resources, project_name):
    """Networking module ke liye outputs.tf generate karta hai"""
    content = f'''# Outputs configuration file
# Auto-generated by Python Script
# Project: {project_name}
# Module: Networking

output "vpc_id" {{
  description = "ID of the VPC"
  value       = aws_vpc.main.id
}}

output "vpc_cidr_block" {{
  description = "CIDR block of the VPC"
  value       = aws_vpc.main.cidr_block
}}

output "internet_gateway_id" {{
  description = "ID of the Internet Gateway"
  value       = aws_internet_gateway.main.id
}}

output "public_subnet_ids" {{
  description = "List of public subnet IDs"
  value       = aws_subnet.public[*].id
}}

output "private_subnet_ids" {{
  description = "List of private subnet IDs"
  value       = aws_subnet.private[*].id
}}

output "public_route_table_id" {{
  description = "ID of the public route table"
  value       = aws_route_table.public.id
}}

'''
    
    if resources["nat_gateway"]["create"]:
        nat_strategy = resources["nat_gateway"]["strategy"]
        
        if nat_strategy == "1":
            # Single NAT outputs
            content += '''output "nat_gateway_id" {
  description = "ID of the NAT Gateway"
  value       = aws_nat_gateway.main.id
}

output "nat_eip_id" {
  description = "ID of the NAT Gateway EIP"
  value       = aws_eip.nat.id
}

output "private_route_table_id" {
  description = "ID of the private route table"
  value       = aws_route_table.private.id
}

'''
        else:
            # Multi NAT outputs
            content += '''output "nat_gateway_ids" {
  description = "List of NAT Gateway IDs"
  value       = aws_nat_gateway.main[*].id
}

output "nat_eip_ids" {
  description = "List of NAT Gateway EIP IDs"
  value       = aws_eip.nat[*].id
}

output "private_route_table_ids" {
  description = "List of private route table IDs"
  value       = aws_route_table.private[*].id
}

'''
    
    if resources["flow_logs"]["enable"]:
        content += '''output "flow_log_id" {
  description = "ID of the VPC Flow Log"
  value       = aws_flow_log.vpc_flow_log.id
}

output "cloudwatch_log_group_name" {
  description = "Name of the CloudWatch Log Group for VPC Flow Logs"
  value       = aws_cloudwatch_log_group.vpc_flow_log.name
}

'''
    
    return content

def generate_networking_module(module_path, project_name):
    """Networking module generate karta hai"""
    print(f"\nüîß Generating Networking Module for project: {project_name}")
    
    # Resources input
    resources = get_networking_resources(project_name)
    
    # Files generate karte hain
    main_tf_content = generate_networking_main_tf(resources, project_name)
    variables_tf_content = generate_networking_variables_tf(project_name, resources)
    outputs_tf_content = generate_networking_outputs_tf(resources, project_name)
    
    # Files save karte hain
    with open(os.path.join(module_path, "main.tf"), 'w') as f:
        f.write(main_tf_content)
    print("‚úÖ Created: main.tf")
    
    with open(os.path.join(module_path, "variables.tf"), 'w') as f:
        f.write(variables_tf_content)
    print("‚úÖ Created: variables.tf")
    
    with open(os.path.join(module_path, "outputs.tf"), 'w') as f:
        f.write(outputs_tf_content)
    print("‚úÖ Created: outputs.tf")
    
    # Resources summary
    print(f"\nüìä Networking Resources Summary:")
    print(f"   ‚Ä¢ VPC: {resources['vpc']['cidr_block']} ({resources['vpc']['name']})")
    print(f"   ‚Ä¢ Public Subnets: {resources['subnets']['public_count']}")
    print(f"   ‚Ä¢ Private Subnets: {resources['subnets']['private_count']}")
    print(f"   ‚Ä¢ Internet Gateway: {resources['internet_gateway']['name']}")
    print(f"   ‚Ä¢ NAT Gateway: {'Yes' if resources['nat_gateway']['create'] else 'No'}")
    if resources["nat_gateway"]["create"]:
        strategy = "Single" if resources["nat_gateway"]["strategy"] == "1" else "Multi-AZ"
        print(f"   ‚Ä¢ NAT Strategy: {strategy}")
    print(f"   ‚Ä¢ VPC Flow Logs: {'Yes' if resources['flow_logs']['enable'] else 'No'}")
    print(f"   ‚Ä¢ Availability Zones: {max(resources['subnets']['public_count'], resources['subnets']['private_count'])}")