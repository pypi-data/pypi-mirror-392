"use strict";(self.webpackChunkthree_jupyterlab=self.webpackChunkthree_jupyterlab||[]).push([[82],{691:(e,t,n)=>{n.r(t),n.d(t,{default:()=>S});var i=n(501),o=n(480),r=n(100),s=n(385),a=n(345),l=n.n(a),c=n(628),d=n(431),u=n(963),h=n(863),m=n(907);class p{constructor(){this.isContainerVisible=!0,this.isOutputContainerVisible=!0,this.baseDistance=null,this.MIN_SCALE=.1,this.MAX_SCALE=5}initializeRenderer(e,t,n){this.dispose(),this.hostElement=e,this.css2DRenderer=new h.B,this.css2DRenderer.setSize(t,n);const i=this.css2DRenderer.domElement;return i.style.position="absolute",i.style.top="0",i.style.left="0",i.style.pointerEvents="none",i.style.zIndex="10",e.appendChild(i),this.createFloatingContainer(),this.createOutputContainer(),this.applyContainerVisibility(),this.css2DRenderer}initializeWithRenderer(e){this.css2DRenderer=e,this.createFloatingContainer(),this.createOutputContainer(),this.applyContainerVisibility()}createFloatingContainer(){if(this.floatingContainer)return this.applyContainerVisibility(),this.floatingContainer;const e=document.createElement("div");e.className="floating-windows-container",e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.width="0",e.style.height="0",e.style.pointerEvents="none",e.style.zIndex="100";const t=document.createElement("style");return t.textContent="\n      .floating-windows-container > * {\n        pointer-events: all;\n      }\n    ",document.head.appendChild(t),this.floatingContainer=e,this.applyContainerVisibility(),e}getFloatingContainer(){return this.floatingContainer}createOutputContainer(){if(this.outputContainer)return this.applyContainerVisibility(),this.outputContainer;const e=document.createElement("div");e.className="floating-output-container",e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.width="0",e.style.height="0",e.style.pointerEvents="none",e.style.zIndex="100";const t=document.createElement("style");return t.textContent="\n      .floating-output-container > * {\n        pointer-events: all;\n      }\n    ",document.head.appendChild(t),this.outputContainer=e,this.applyContainerVisibility(),e}getOutputContainer(){return this.outputContainer}attachToScene(e,t=new u.Vector3(0,200,-100)){return this.floatingContainer?this.attachFloatingWindowContainer(this.floatingContainer,e,t):(console.warn("Floating container is not created. Call initializeRenderer() or initializeWithRenderer() first."),null)}attachOutputContainerToScene(e,t=new u.Vector3(0,0,-100)){return this.outputContainer?this.attachOutputContainer(this.outputContainer,e,t):(console.warn("Output container is not created. Call initializeRenderer() or initializeWithRenderer() first."),null)}attachFloatingWindowContainer(e,t,n=new u.Vector3(0,20,-100)){return this.css2DObject&&this.css2DObject.parent&&this.css2DObject.parent.remove(this.css2DObject),e.style.pointerEvents="auto",this.css2DObject=new h.v(e),this.css2DObject.position.copy(n),this.css2DObject.scale.set(1,1,1),t.add(this.css2DObject),this.css2DObject}attachOutputContainer(e,t,n=new u.Vector3(0,0,-100)){return this.outputCSS2DObject&&this.outputCSS2DObject.parent&&this.outputCSS2DObject.parent.remove(this.outputCSS2DObject),e.style.pointerEvents="auto",this.outputCSS2DObject=new h.v(e),this.outputCSS2DObject.position.copy(n),this.outputCSS2DObject.scale.set(1,1,1),t.add(this.outputCSS2DObject),this.outputCSS2DObject}calculateScale(e){if(e<=0)return this.MAX_SCALE;null===this.baseDistance&&(this.baseDistance=1e3);const t=this.baseDistance/e;return Math.max(this.MIN_SCALE,Math.min(this.MAX_SCALE,t))}updateContainerScale(e){if(!this.floatingContainer||!this.css2DObject)return;const t=e.position,n=new u.Vector3;this.css2DObject.getWorldPosition(n);const i=Math.abs(t.y-n.y),o=this.calculateScale(i);let r=(this.floatingContainer.style.transform||"").replace(/\s*scale\([^)]*\)/gi,"");const s=r.trim()?`${r.trim()} scale(${o})`:`scale(${o})`;this.floatingContainer.style.transform=s,this.floatingContainer.style.transformOrigin="top left"}updateOutputContainerScale(e){if(!this.outputContainer||!this.outputCSS2DObject)return;const t=e.position,n=new u.Vector3;this.outputCSS2DObject.getWorldPosition(n);const i=Math.abs(t.y-n.y),o=this.calculateScale(i);let r=(this.outputContainer.style.transform||"").replace(/\s*scale\([^)]*\)/gi,"");const s=r.trim()?`${r.trim()} scale(${o})`:`scale(${o})`;this.outputContainer.style.transform=s,this.outputContainer.style.transformOrigin="top left"}render(e,t){this.css2DRenderer&&(this.css2DRenderer.render(e,t),this.updateContainerScale(t),this.updateOutputContainerScale(t))}setSize(e,t){this.css2DRenderer&&this.css2DRenderer.setSize(e,t)}getCSS2DObject(){return this.css2DObject}getRenderer(){return this.css2DRenderer}dispose(){if(this.css2DObject&&this.css2DObject.parent&&this.css2DObject.parent.remove(this.css2DObject),this.css2DObject=void 0,this.outputCSS2DObject&&this.outputCSS2DObject.parent&&this.outputCSS2DObject.parent.remove(this.outputCSS2DObject),this.outputCSS2DObject=void 0,this.floatingContainer){for(;this.floatingContainer.firstChild;)this.floatingContainer.removeChild(this.floatingContainer.firstChild);this.floatingContainer.parentElement&&this.floatingContainer.parentElement.removeChild(this.floatingContainer),this.floatingContainer=void 0}if(this.outputContainer){for(;this.outputContainer.firstChild;)this.outputContainer.removeChild(this.outputContainer.firstChild);this.outputContainer.parentElement&&this.outputContainer.parentElement.removeChild(this.outputContainer),this.outputContainer=void 0}if(this.css2DRenderer&&this.hostElement){const e=this.css2DRenderer.domElement;e&&e.parentElement&&e.parentElement.removeChild(e)}this.css2DRenderer=void 0,this.hostElement=void 0,this.baseDistance=null}isInitialized(){return!!this.css2DRenderer&&!!this.floatingContainer}getCurrentScale(){if(!this.floatingContainer)return 1;const e=(this.floatingContainer.style.transform||"").match(/scale\(([^)]+)\)/);if(e&&e[1]){const t=parseFloat(e[1].trim());return isNaN(t)?1:t}return 1}hideFloatingContainer(){this.isContainerVisible=!1,this.applyContainerVisibility()}showFloatingContainer(){this.isContainerVisible=!0,this.applyContainerVisibility()}applyContainerVisibility(){const e=this.isContainerVisible?"":"none",t=this.isOutputContainerVisible?"":"none";this.floatingContainer&&(this.floatingContainer.style.display=e),this.outputContainer&&(this.outputContainer.style.display=t)}}class w{constructor(e){this.animationFrameId=null,this.resizeObserver=null,this.onWindowResize=()=>{const e=this.container.clientWidth,t=this.container.clientHeight;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t),this.css2DRenderer.setSize(e,t),this.floatingWindowCSS2DService.setSize(e,t)},this.animate=()=>{this.animationFrameId=requestAnimationFrame(this.animate),this.controls.update(),this.renderer.render(this.scene,this.camera),this.floatingWindowCSS2DService.render(this.scene,this.camera)},this.container=e,this.scene=new u.Scene,this.scene.background=new u.Color(7834775),this.camera=new u.PerspectiveCamera(60,e.clientWidth/e.clientHeight,.1,1e4),this.camera.position.set(0,1200,0),this.camera.lookAt(0,0,0),this.camera.up.set(0,0,-1),this.renderer=new u.WebGLRenderer({antialias:!0}),this.renderer.setSize(e.clientWidth,e.clientHeight),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.domElement.style.position="absolute",this.renderer.domElement.style.top="0",this.renderer.domElement.style.left="0",this.renderer.domElement.style.zIndex="0",e.appendChild(this.renderer.domElement),this.css2DRenderer=new h.B,this.css2DRenderer.setSize(e.clientWidth,e.clientHeight),this.css2DRenderer.domElement.style.position="absolute",this.css2DRenderer.domElement.style.top="0",this.css2DRenderer.domElement.style.left="0",this.css2DRenderer.domElement.style.pointerEvents="none",this.css2DRenderer.domElement.style.zIndex="1",e.appendChild(this.css2DRenderer.domElement),this.floatingWindowCSS2DService=new p,this.floatingWindowCSS2DService.initializeWithRenderer(this.css2DRenderer),this.floatingWindowCSS2DService.attachToScene(this.scene),this.floatingWindowCSS2DService.attachOutputContainerToScene(this.scene),this.controls=new m.N(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.enableRotate=!1,this.controls.mouseButtons.LEFT=u.MOUSE.PAN;const t=new u.AmbientLight(16777215,.6);this.scene.add(t);const n=new u.DirectionalLight(16777215,.4);n.position.set(5,5,5),this.scene.add(n),window.addEventListener("resize",this.onWindowResize),this.resizeObserver=new ResizeObserver(()=>{this.onWindowResize()}),this.resizeObserver.observe(e),this.animate()}getFloatingContainer(){var e;return null===(e=this.floatingWindowCSS2DService)||void 0===e?void 0:e.getFloatingContainer()}getOutputContainer(){var e;return null===(e=this.floatingWindowCSS2DService)||void 0===e?void 0:e.getOutputContainer()}getFloatingWindowCSS2DService(){return this.floatingWindowCSS2DService}addHTMLElement(e,t){const n=new h.v(e);return n.position.copy(t),this.scene.add(n),n}removeHTMLElement(e){this.scene.remove(e)}getScene(){return this.scene}getCamera(){return this.camera}getCSS2DContainer(){return this.css2DRenderer.domElement}dispose(){null!==this.animationFrameId&&cancelAnimationFrame(this.animationFrameId),window.removeEventListener("resize",this.onWindowResize),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.floatingWindowCSS2DService&&this.floatingWindowCSS2DService.dispose(),this.controls&&this.controls.dispose(),this.renderer.dispose(),this.container.removeChild(this.renderer.domElement),this.container.removeChild(this.css2DRenderer.domElement)}}class y{constructor(){this.windows=new Map,this.nextId=1,this.maxZIndex=1e3,this.listeners=new Set}addListener(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notifyListeners(){const e=Array.from(this.windows.values());this.listeners.forEach(t=>t(e))}createWindow(e,t="Untitled",n="",i,o){const r="window-"+this.nextId++,s="output"===e?800:700,a=this.windows.size,l={id:r,type:e,title:t,x:100+30*a,y:100+30*a,width:s,height:600,zIndex:++this.maxZIndex,isMinimized:!1,content:n,linkedWindowId:i,initialOutputs:o||void 0};return this.windows.set(r,l),this.notifyListeners(),r}closeWindow(e){const t=this.windows.get(e);t&&("editor"===t.type&&Array.from(this.windows.values()).filter(t=>t.linkedWindowId===e).forEach(e=>this.windows.delete(e.id)),this.windows.delete(e),this.notifyListeners())}minimizeWindow(e){const t=this.windows.get(e);t&&(t.isMinimized=!t.isMinimized,this.notifyListeners())}bringToFront(e){const t=this.windows.get(e);t&&(t.zIndex=++this.maxZIndex,this.notifyListeners())}updatePosition(e,t,n){const i=this.windows.get(e);i&&(i.x=t,i.y=n,this.notifyListeners())}updateSize(e,t,n){const i=this.windows.get(e);i&&(i.width=t,i.height=n,this.notifyListeners())}updateContent(e,t){const n=this.windows.get(e);n&&(n.content=t,this.notifyListeners())}updateTitle(e,t){const n=this.windows.get(e);n&&(n.title=t,this.notifyListeners())}getWindow(e){return this.windows.get(e)}getAllWindows(){return Array.from(this.windows.values())}clearAllWindows(){this.windows.clear(),this.notifyListeners()}}const f=({window:e,kernel:t,onClose:n,onMinimize:i,onBringToFront:o,onUpdatePosition:r,onUpdateSize:s,onUpdateContent:c,onCreateOutputWindow:d})=>{const u=(0,a.useRef)(null),h=(0,a.useRef)(null),[m,p]=(0,a.useState)(!1),[w,y]=(0,a.useState)(!1),[f,g]=(0,a.useState)(!1),[v,C]=(0,a.useState)({x:0,y:0}),[b,E]=(0,a.useState)({x:0,y:0,width:0,height:0});(0,a.useEffect)(()=>{if(!u.current)return;const t=()=>{const t=window;u.current&&!h.current&&(h.current=t.monaco.editor.create(u.current,{value:e.content,language:"python",theme:"vs-dark",automaticLayout:!0,minimap:{enabled:!1},fontSize:14,lineNumbers:"on",scrollBeyondLastLine:!1}),h.current.onDidChangeModelContent(()=>{const e=h.current.getValue();c(e)}),h.current.addCommand(t.monaco.KeyMod.CtrlCmd|t.monaco.KeyCode.Enter,()=>{S()}))};return(async()=>{const e=window;if(e.monaco)t();else{const n=document.createElement("script");n.src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js",n.onload=()=>{e.require.config({paths:{vs:"https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs"}}),e.require(["vs/editor/editor.main"],()=>{t()})},document.head.appendChild(n)}})(),()=>{h.current&&(h.current.dispose(),h.current=null)}},[]);const S=async()=>{if(!t||!h.current||m)return;const n=h.current.getValue();if(n.trim()){p(!0),e.linkedWindowId||d(e.id);try{const e=t.requestExecute({code:n});await e.done}catch(e){console.error("Execution error:",e)}finally{p(!1)}}};return(0,a.useEffect)(()=>{const e=e=>{if(w){const t=e.clientX-v.x,n=e.clientY-v.y;r(t,n)}else if(f){const t=e.clientX-b.x,n=e.clientY-b.y,i=Math.max(400,b.width+t),o=Math.max(300,b.height+n);s(i,o)}},t=()=>{y(!1),g(!1)};return(w||f)&&(document.addEventListener("mousemove",e),document.addEventListener("mouseup",t)),()=>{document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",t)}},[w,f,v,b]),l().createElement("div",{className:"floating-window floating-editor-window "+(e.isMinimized?"minimized":""),style:{position:"absolute",left:`${e.x}px`,top:`${e.y}px`,width:`${e.width}px`,height:`${e.height}px`,zIndex:e.zIndex},onMouseDown:o},l().createElement("div",{className:"window-titlebar",onMouseDown:t=>{t.target.closest("button")||(t.preventDefault(),y(!0),C({x:t.clientX-e.x,y:t.clientY-e.y}),o())}},l().createElement("div",{className:"titlebar-controls"},l().createElement("button",{className:"titlebar-btn run-btn",onClick:S,disabled:!t||m,title:"Run code (Ctrl+Enter)"},m?"â³":"â–¶ï¸")),l().createElement("div",{className:"titlebar-left"},l().createElement("span",{className:"window-title"},e.title)),l().createElement("div",{className:"titlebar-buttons"},l().createElement("button",{className:"titlebar-btn",onClick:i,title:"Minimize"},"âˆ’"),l().createElement("button",{className:"titlebar-btn close",onClick:n,title:"Close"},"âœ•"))),!e.isMinimized&&l().createElement(l().Fragment,null,l().createElement("div",{className:"window-content"},l().createElement("div",{ref:u,className:"editor-host"})),l().createElement("div",{className:"resize-handle",onMouseDown:t=>{t.preventDefault(),t.stopPropagation(),g(!0),E({x:t.clientX,y:t.clientY,width:e.width,height:e.height})}})))},g=({window:e,kernel:t,onClose:n,onMinimize:i,onBringToFront:o,onUpdatePosition:r,onUpdateSize:s})=>{const[c,d]=(0,a.useState)(e.initialOutputs||[]),[u,h]=(0,a.useState)(!1),[m,p]=(0,a.useState)(!1),[w,y]=(0,a.useState)({x:0,y:0}),[f,g]=(0,a.useState)({x:0,y:0,width:0,height:0}),v=(0,a.useRef)(null);return(0,a.useEffect)(()=>{e.initialOutputs&&e.initialOutputs.length>0&&d(e.initialOutputs)},[e.initialOutputs]),(0,a.useEffect)(()=>{if(!t)return;const e=(e,t)=>{const n=t.header.msg_type,i=t.content;let o=null;switch(n){case"stream":o={type:"stream",content:i.text||"",timestamp:Date.now()};break;case"execute_result":case"display_data":const e=i.data;let t="";t=e["text/html"]?e["text/html"]:e["text/plain"]?e["text/plain"]:e["image/png"]?`<img src="data:image/png;base64,${e["image/png"]}" />`:e["image/jpeg"]?`<img src="data:image/jpeg;base64,${e["image/jpeg"]}" />`:JSON.stringify(e,null,2),o={type:n,content:t,timestamp:Date.now()};break;case"error":const r=`${i.ename}: ${i.evalue}\n${i.traceback?i.traceback.join("\n"):""}`;o={type:"error",content:r,timestamp:Date.now()}}o&&d(e=>[...e,o])};return t.iopubMessage.connect(e),()=>{t.iopubMessage.disconnect(e)}},[t]),(0,a.useEffect)(()=>{v.current&&(v.current.scrollTop=v.current.scrollHeight)},[c]),(0,a.useEffect)(()=>{const e=e=>{if(u){const t=e.clientX-w.x,n=e.clientY-w.y;r(t,n)}else if(m){const t=e.clientX-f.x,n=e.clientY-f.y,i=Math.max(400,f.width+t),o=Math.max(300,f.height+n);s(i,o)}},t=()=>{h(!1),p(!1)};return(u||m)&&(document.addEventListener("mousemove",e),document.addEventListener("mouseup",t)),()=>{document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",t)}},[u,m,w,f]),l().createElement("div",{className:"floating-window floating-output-window "+(e.isMinimized?"minimized":""),style:{position:"absolute",left:`${e.x}px`,top:`${e.y}px`,width:`${e.width}px`,height:`${e.height}px`,zIndex:e.zIndex},onMouseDown:o},l().createElement("div",{className:"window-titlebar",onMouseDown:t=>{t.target.closest("button")||(t.preventDefault(),h(!0),y({x:t.clientX-e.x,y:t.clientY-e.y}),o())}},l().createElement("div",{className:"titlebar-controls"},l().createElement("button",{className:"titlebar-btn",onClick:()=>{d([])},title:"Clear output"},"ðŸ—‘ï¸")),l().createElement("div",{className:"titlebar-left"},l().createElement("span",{className:"window-title"},e.title)),l().createElement("div",{className:"titlebar-buttons"},l().createElement("button",{className:"titlebar-btn",onClick:i,title:"Minimize"},"âˆ’"),l().createElement("button",{className:"titlebar-btn close",onClick:n,title:"Close"},"âœ•"))),!e.isMinimized&&l().createElement(l().Fragment,null,l().createElement("div",{className:"window-content"},l().createElement("div",{ref:v,className:"output-container"},0===c.length?l().createElement("div",{className:"output-empty"},"Output will appear here..."):c.map((e,t)=>l().createElement("div",{key:t,className:`output-item output-${e.type}`},"error"===e.type?l().createElement("pre",{className:"output-error"},e.content):e.content.startsWith("<")?l().createElement("div",{dangerouslySetInnerHTML:{__html:e.content}}):l().createElement("pre",{className:"output-text"},e.content))))),l().createElement("div",{className:"resize-handle",onMouseDown:t=>{t.preventDefault(),t.stopPropagation(),p(!0),g({x:t.clientX,y:t.clientY,width:e.width,height:e.height})}})))};var v=n(970);const C=({window:e,onClose:t,onMinimize:n,onBringToFront:i,onUpdatePosition:o,onUpdateSize:r,onUpdateContent:s})=>{const[c,d]=(0,a.useState)(!0),[u,h]=(0,a.useState)(e.content||"# Markdown\n\nEdit me..."),[m,p]=(0,a.useState)(!1),[w,y]=(0,a.useState)(!1),[f,g]=(0,a.useState)({x:0,y:0}),[C,b]=(0,a.useState)({x:0,y:0,width:0,height:0}),E=(0,a.useRef)(null);(0,a.useEffect)(()=>{v.marked.setOptions({breaks:!0,gfm:!0})},[]),(0,a.useEffect)(()=>{if(c&&E.current){E.current.focus();const e=E.current.value.length;E.current.setSelectionRange(e,e)}},[c]);const S=()=>{d(!0)};return(0,a.useEffect)(()=>{const e=e=>{if(m){const t=e.clientX-f.x,n=e.clientY-f.y;o(t,n)}else if(w){const t=e.clientX-C.x,n=e.clientY-C.y,i=Math.max(400,C.width+t),o=Math.max(300,C.height+n);r(i,o)}},t=()=>{p(!1),y(!1)};return(m||w)&&(document.addEventListener("mousemove",e),document.addEventListener("mouseup",t)),()=>{document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",t)}},[m,w,f,C]),l().createElement("div",{className:"floating-window floating-markdown-window "+(e.isMinimized?"minimized":""),style:{position:"absolute",left:`${e.x}px`,top:`${e.y}px`,width:`${e.width}px`,height:`${e.height}px`,zIndex:e.zIndex},onMouseDown:i},l().createElement("div",{className:"window-titlebar",onMouseDown:t=>{t.target.closest("button")||(t.preventDefault(),p(!0),g({x:t.clientX-e.x,y:t.clientY-e.y}),i())}},l().createElement("div",{className:"titlebar-controls"},l().createElement("button",{className:"titlebar-btn",onClick:()=>{c&&s(u),d(!c)},title:c?"Preview":"Edit"},c?"ðŸ‘ï¸":"âœï¸")),l().createElement("div",{className:"titlebar-left"},l().createElement("span",{className:"window-title"},e.title)),l().createElement("div",{className:"titlebar-buttons"},l().createElement("button",{className:"titlebar-btn",onClick:n,title:"Minimize"},"âˆ’"),l().createElement("button",{className:"titlebar-btn close",onClick:t,title:"Close"},"âœ•"))),!e.isMinimized&&l().createElement(l().Fragment,null,l().createElement("div",{className:"window-content"},c?l().createElement("textarea",{ref:E,className:"markdown-editor",value:u,onChange:e=>{h(e.target.value)},onKeyDown:e=>{"Enter"===e.key&&(e.shiftKey||e.ctrlKey)&&(e.preventDefault(),s(u),d(!1))},placeholder:"Enter markdown here..."}):l().createElement("div",{className:"markdown-preview",tabIndex:0,onDoubleClick:S,onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),S())},dangerouslySetInnerHTML:{__html:(()=>{try{return v.marked.parse(u)}catch(e){return console.error("Markdown rendering error:",e),"<p>Error rendering markdown</p>"}})()}})),l().createElement("div",{className:"resize-handle",onMouseDown:t=>{t.preventDefault(),t.stopPropagation(),y(!0),b({x:t.clientX,y:t.clientY,width:e.width,height:e.height})}})))},b=({context:e,onSaveNotebookRef:t})=>{const[n,i]=(0,a.useState)(!1),[o,r]=(0,a.useState)(!1),[s,u]=(0,a.useState)(""),[h,m]=(0,a.useState)([]),[p,v]=(0,a.useState)(null),[b,E]=(0,a.useState)(null),S=(0,a.useRef)(null),x=(0,a.useRef)(null),D=(0,a.useRef)(null),k=(0,a.useRef)(null),z=(0,a.useRef)(null),N=(0,a.useRef)(!1),O=(0,a.useRef)(!1);(0,a.useEffect)(()=>{const e=setTimeout(()=>{N.current||(N.current=!0,j(),R())},1e3);return()=>{clearTimeout(e),_()}},[]),(0,a.useEffect)(()=>{if(!e)return;if(O.current)return;const t=async()=>{try{await e.ready;const n=e.model;if(!n)return void console.warn("Model not available for context:",e.path);if(!k.current)return void setTimeout(t,200);const i=function(e){var t;try{const n="string"==typeof e?JSON.parse(e):e;if(!n||!Array.isArray(n.cells))return console.warn("Invalid notebook format: cells array not found"),[];const i=[];for(const e of n.cells){if(!e.cell_type)continue;let n="";Array.isArray(e.source)?n=e.source.join(""):"string"==typeof e.source&&(n=e.source),i.push({cell_type:e.cell_type,source:n,metadata:e.metadata||{},execution_count:null!==(t=e.execution_count)&&void 0!==t?t:null,outputs:e.outputs||[]})}return i}catch(e){return console.error("Error parsing notebook:",e),[]}}(n.toJSON());if(0===i.length)return;k.current.clearAllWindows();const{codeCells:o,markdownCells:r}=function(e){const t=[],n=[];for(const i of e)"code"===i.cell_type?t.push(i):"markdown"===i.cell_type&&n.push(i);return{codeCells:t,markdownCells:n}}(i);if(o.forEach((e,t)=>{var n;const i="string"==typeof e.source?e.source:e.source.join(""),o=`Code Cell ${t+1}`,r=null===(n=k.current)||void 0===n?void 0:n.createWindow("editor",o,i);if(e.outputs&&e.outputs.length>0&&r){const t=function(e){if(!Array.isArray(e)||0===e.length)return[];const t=[];for(const n of e){const e=n.output_type;let i=null;switch(e){case"stream":const t=n.text||"";i={type:"stream",content:Array.isArray(t)?t.join(""):t,timestamp:Date.now()};break;case"execute_result":case"display_data":const o=n.data||{};let r="";r=o["text/html"]?Array.isArray(o["text/html"])?o["text/html"].join(""):o["text/html"]:o["text/plain"]?Array.isArray(o["text/plain"])?o["text/plain"].join(""):o["text/plain"]:o["image/png"]?`<img src="data:image/png;base64,${Array.isArray(o["image/png"])?o["image/png"].join(""):o["image/png"]}" />`:o["image/jpeg"]?`<img src="data:image/jpeg;base64,${Array.isArray(o["image/jpeg"])?o["image/jpeg"].join(""):o["image/jpeg"]}" />`:JSON.stringify(o,null,2),i={type:e,content:r,timestamp:Date.now()};break;case"error":const s=n.ename||"Error",a=n.evalue||"",l=n.traceback||[];i={type:"error",content:`${s}: ${a}\n${Array.isArray(l)?l.join("\n"):""}`,timestamp:Date.now()}}i&&t.push(i)}return t}(e.outputs);setTimeout(()=>{L(r,t)},200)}}),r.forEach((e,t)=>{var n;const i="string"==typeof e.source?e.source:e.source.join(""),o=`Markdown ${t+1}`,r=null===(n=k.current)||void 0===n?void 0:n.createWindow("markdown",o,i);console.log(`Created markdown cell window ${t+1}: ${r}`)}),k.current){const e=k.current.getAllWindows();m(e),setTimeout(()=>{var e;const t=null===(e=k.current)||void 0===e?void 0:e.getAllWindows();t&&m(t)},100)}O.current=!0}catch(e){console.error("Error loading notebook:",e),console.error("Error stack:",e instanceof Error?e.stack:"No stack trace")}};let n=0;const i=()=>{n++,k.current?t():n<50?setTimeout(i,100):console.error("WindowManager not initialized after maximum attempts")};setTimeout(i,500)},[e]);const j=()=>{if(z.current&&!D.current)try{D.current=new w(z.current);const e=D.current.getFloatingContainer();e&&v(e);const t=D.current.getOutputContainer();t&&E(t),k.current=new y,k.current.addListener(e=>{m(e)})}catch(e){console.error("Scene initialization error:",e),u("Failed to initialize 3D scene")}},R=async()=>{if(!o){r(!0),u("");try{x.current||(x.current=new d.KernelManager);const e=await(async(e,t=3,n=1e3)=>{let i=null;for(let o=0;o<t;o++)try{return await e.startNew({name:"python3"})}catch(e){if(i=e,o===t-1)break;console.warn(`ã‚«ãƒ¼ãƒãƒ«èµ·å‹•è©¦è¡Œ ${o+1}/${t} å¤±æ•—:`,e.message),await new Promise(e=>setTimeout(e,n*(o+1)))}throw new Error(`ã‚«ãƒ¼ãƒãƒ«ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ (${t}å›žè©¦è¡Œ): ${(null==i?void 0:i.message)||"ä¸æ˜Žãªã‚¨ãƒ©ãƒ¼"}`)})(x.current);S.current=e,i(!0),u(""),e.statusChanged.connect((e,t)=>{"dead"!==t&&"terminating"!==t||i(!1)})}catch(e){const t=`Kernel ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nè©³ç´°: ${e.message}`;u(t),console.error("Kernel start error:",e)}finally{r(!1)}}},M=async()=>{if(S.current)try{await S.current.shutdown(),S.current=null,i(!1)}catch(e){console.error("Kernel stop error:",e)}},W=(0,a.useCallback)(async()=>{if(e&&k.current)if(e.isDisposed)console.warn("Context is already disposed, skipping save");else try{await e.ready;const t=e.model;if(!t)return void console.warn("Model not available for saving");if(t.isDisposed)return void console.warn("Model is already disposed, skipping save");const n=k.current.getAllWindows(),i=n.filter(e=>"editor"===e.type),o=n.filter(e=>"markdown"===e.type),r=[];i.forEach(e=>{const t={cell_type:"code",source:(e.content||"").split("\n"),metadata:{},execution_count:null,outputs:[]},i=n.find(t=>"output"===t.type&&t.linkedWindowId===e.id);if(i&&i.initialOutputs){const e=[];i.initialOutputs.forEach(t=>{var n,i;if("stream"===t.type)e.push({output_type:"stream",name:"stdout",text:t.content.split("\n")});else if("execute_result"===t.type||"display_data"===t.type)e.push({output_type:t.type,data:{"text/plain":[t.content]},metadata:{}});else if("error"===t.type){const o=t.content.split("\n"),r=(null===(n=o[0])||void 0===n?void 0:n.split(":")[0])||"Error",s=(null===(i=o[0])||void 0===i?void 0:i.split(":").slice(1).join(":").trim())||"";e.push({output_type:"error",ename:r,evalue:s,traceback:o.slice(1)})}}),t.outputs=e}r.push(t)}),o.forEach(e=>{const t=e.content||"";r.push({cell_type:"markdown",source:t.split("\n"),metadata:{}})});const s=t.toJSON(),a={cells:r,metadata:s.metadata||{kernelspec:{display_name:"Python 3",language:"python",name:"python3"},language_info:{name:"python",version:"3.0.0"}},nbformat:s.nbformat||4,nbformat_minor:s.nbformat_minor||4};t.fromJSON(a),await e.save(),console.log("Notebook saved successfully")}catch(e){console.error("Error saving notebook:",e),e instanceof Error&&console.error("Error message:",e.message)}},[e]);(0,a.useEffect)(()=>{t&&t(W)},[t,W]);const _=async()=>{M(),D.current&&(D.current.dispose(),D.current=null)},L=(e,t)=>{if(!k.current)return;const n=k.current.getWindow(e);if(!n)return;if(h.find(t=>"output"===t.type&&t.linkedWindowId===e))return;const i=`Output: ${n.title}`,o=n.x+n.width+20,r=n.y,s=k.current.createWindow("output",i,"",e,t);k.current.updatePosition(s,o,r)},A=e=>{var t;null===(t=k.current)||void 0===t||t.closeWindow(e)},$=e=>{var t;null===(t=k.current)||void 0===t||t.minimizeWindow(e)},F=e=>{var t;null===(t=k.current)||void 0===t||t.bringToFront(e)},I=(e,t,n)=>{var i;null===(i=k.current)||void 0===i||i.updatePosition(e,t,n)},T=(e,t,n)=>{var i;null===(i=k.current)||void 0===i||i.updateSize(e,t,n)},P=(e,t)=>{var n;null===(n=k.current)||void 0===n||n.updateContent(e,t)};return l().createElement("div",{className:"three-jupyter-container"},l().createElement("div",{className:"toolbar"},l().createElement("button",{onClick:()=>{if(!k.current)return;const e=h.filter(e=>"editor"===e.type).length,t=0===e?"Code Cell":`Code Cell ${e+1}`;k.current.createWindow("editor",t,'print("Hello, Jupyter!")')},className:"toolbar-btn",title:"æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ã‚»ãƒ«"},"+"),l().createElement("button",{onClick:()=>{if(!k.current)return;const e=h.filter(e=>"markdown"===e.type).length,t=0===e?"Markdown":`Markdown ${e+1}`;k.current.createWindow("markdown",t,"# Markdown\n\nEdit me...")},className:"toolbar-btn info-btn",title:"æ–°ã—ã„ãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚»ãƒ«"},"i")),l().createElement("div",{className:"kernel-status"},n?l().createElement("button",{onClick:M,className:"kernel-btn"},"â¹ï¸"):l().createElement("button",{onClick:R,className:"kernel-btn",disabled:o},o?"â³":"â–¶ï¸")),s&&l().createElement("div",{className:"error-banner"},s),l().createElement("div",{ref:z,className:"scene-container"}),p&&(0,c.createPortal)(l().createElement(l().Fragment,null,h.map(e=>{switch(e.type){case"editor":return l().createElement(f,{key:e.id,window:e,kernel:S.current,onClose:()=>A(e.id),onMinimize:()=>$(e.id),onBringToFront:()=>F(e.id),onUpdatePosition:(t,n)=>I(e.id,t,n),onUpdateSize:(t,n)=>T(e.id,t,n),onUpdateContent:t=>P(e.id,t),onCreateOutputWindow:L});case"markdown":return l().createElement(C,{key:e.id,window:e,onClose:()=>A(e.id),onMinimize:()=>$(e.id),onBringToFront:()=>F(e.id),onUpdatePosition:(t,n)=>I(e.id,t,n),onUpdateSize:(t,n)=>T(e.id,t,n),onUpdateContent:t=>P(e.id,t)});default:return null}})),p),b&&(0,c.createPortal)(l().createElement(l().Fragment,null,h.map(e=>"output"===e.type?l().createElement(g,{key:e.id,window:e,kernel:S.current,onClose:()=>A(e.id),onMinimize:()=>$(e.id),onBringToFront:()=>F(e.id),onUpdatePosition:(t,n)=>I(e.id,t,n),onUpdateSize:(t,n)=>T(e.id,t,n)}):null)),b))};class E extends i.ReactWidget{constructor(e){super(),this.addClass("three-jupyter-widget"),this._context=e}setSaveNotebookRef(e){this._saveNotebookRef=e}async save(){if(this._saveNotebookRef)try{await this._saveNotebookRef()}catch(e){throw console.error("Error saving notebook:",e),e}}async dispose(){if(this._saveNotebookRef&&this._context&&!this._context.isDisposed)try{await this._saveNotebookRef()}catch(e){console.error("Error saving notebook on dispose:",e)}super.dispose()}render(){return l().createElement(b,{context:this._context,onSaveNotebookRef:e=>this.setSaveNotebookRef(e)})}}const S={id:"three-jupyterlab:plugin",description:"JupyterLab extension with custom UI for Python code execution",autoStart:!0,optional:[i.ICommandPalette,r.ILauncher],activate:(e,t,n)=>{const i="three-jupyterlab:open";e.commands.addCommand(i,{label:"Three Jupyter ã‚’é–‹ã",caption:"ã‚«ã‚¹ã‚¿ãƒ UIã§Pythonã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ",execute:()=>{(async()=>{try{const t=await e.serviceManager.contents.newUntitled({type:"notebook"});if(!t||!t.path)throw new Error("Failed to create notebook file: model or path is missing");await e.commands.execute("docmanager:open",{path:t.path})}catch(e){console.error("Error creating new notebook:",e),e instanceof Error&&(console.error("Error message:",e.message),console.error("Error stack:",e.stack))}})()}});const r="three-jupyterlab:save";e.commands.addCommand(r,{label:"ä¿å­˜",caption:"Notebookãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸Šæ›¸ãä¿å­˜",execute:async()=>{try{const t=e.shell.currentWidget;if(t&&t.id&&t.id.startsWith("three-jupyterlab-")){const n=t;n.content&&"function"==typeof n.content.save?await n.content.save():n.save&&"function"==typeof n.save?await n.save():await e.commands.execute("docmanager:save")}else await e.commands.execute("docmanager:save")}catch(e){console.error("Error saving notebook:",e),e instanceof Error&&console.error("Error message:",e.message)}}}),e.commands.addKeyBinding({command:r,keys:["Accel S"],selector:".three-jupyter-widget"}),t&&t.addItem({command:i,category:"Three Jupyter"}),n&&n.add({command:i,category:"Notebook",rank:1});class a extends o.ABCWidgetFactory{constructor(e){super(e)}createNewWidget(e){const t=new E(e),n=new o.DocumentWidget({content:t,context:e});n.id=`three-jupyterlab-${e.path}`,n.title.label=e.path.split("/").pop()||"Three Jupyter",n.title.closable=!0;const i=()=>{e.model.dirty?(n.title.icon=s.circleIcon,n.title.iconClass="jp-mod-dirty"):(n.title.icon=void 0,n.title.iconClass="")};return i(),e.model.stateChanged.connect((e,t)=>{"dirty"===t.name&&i()}),n}}const l=new a({name:"Three Jupyter",modelName:"notebook",fileTypes:["notebook"],defaultFor:["notebook"]});e.docRegistry.addWidgetFactory(l)}}}}]);