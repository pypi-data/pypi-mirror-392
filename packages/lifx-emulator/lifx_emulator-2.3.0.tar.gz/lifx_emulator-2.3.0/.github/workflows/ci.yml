name: CI

on:
  push:
    branches:
    - main
  pull_request:


env:
  PYTHON_VERSION: '3.11'
  UV_VERSION: 0.9.4

jobs:
  # Code quality checks
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

    - name: Set up Python
      uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install uv
      uses: astral-sh/setup-uv@5a7eac68fb9809dea845d802897dc5c723910fa3 # v7
      with:
        version: ${{ env.UV_VERSION }}
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: uv sync --frozen

    - name: Run Ruff format check
      run: uv run ruff format --check .

    - name: Run Ruff linter (with complexity checks)
      run: uv run ruff check .

    - name: Run Pyright type checker
      run: uv run pyright

    - name: Check for security issues
      run: |
        uv pip install bandit
        uv run bandit -r src/

  # Testing matrix across Python versions and platforms
  test:
    name: Test (Python ${{ matrix.python-version }} on ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ['3.11', '3.12', '3.13', '3.14']
    steps:
    - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install uv
      uses: astral-sh/setup-uv@5a7eac68fb9809dea845d802897dc5c723910fa3 # v7
      with:
        version: ${{ env.UV_VERSION }}
        python-version: ${{ matrix.python-version }}
        enable-cache: true

    - name: Install dependencies
      run: uv sync --frozen

    - name: Run unit tests with coverage threshold
      run: uv run --frozen pytest --cov-fail-under=80

    - name: Upload coverage to Codecov
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
      uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7 # v5
      with:
        slug: Djelibeybi/lifx-emulator
        token: ${{ secrets.CODECOV_TOKEN }}
        fail_ci_if_error: false

    - name: Upload test results to Codecov
      if: ${{ !cancelled() }}
      uses: codecov/test-results-action@47f89e9acb64b76debcd5ea40642d25a4adced9f # v1
      with:
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

  release:
    needs:
    - quality
    - test
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: write

    concurrency:
      group: ${{ github.workflow }}-release-${{ github.ref_name }}
      cancel-in-progress: false

    outputs:
      released: ${{ steps.release.outputs.released || 'false' }}


    steps:
    - name: Checkout repository on release branch
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      with:
        ref: ${{ github.head_ref || github.ref_name }}
        fetch-depth: 0
        ssh-key: ${{ secrets.DEPLOY_KEY }}

    - name: Set up Python
      uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install uv
      uses: astral-sh/setup-uv@5a7eac68fb9809dea845d802897dc5c723910fa3 # v7
      with:
        version: ${{ env.UV_VERSION }}
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Configure git
      run: |
        git config --local user.email "github-actions@github.com"
        git config --local user.name "GitHub Actions"

    - name: Run Python Semantic Release (NOOP)
      id: psr-noop
      if: github.ref_name != 'main'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        uv run --with python-semantic-release semantic-release --noop version

    - name: Run Python Semantic Release
      id: release
      if: github.ref_name == 'main'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        uv run --with python-semantic-release semantic-release version

    - name: Upload Distribution Artifacts
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
      with:
        name: distribution-artifacts
        path: dist


  deploy:
    runs-on: ubuntu-latest
    needs: release
    if: ${{ needs.release.outputs.released == 'true' }}

    permissions:
      contents: read
      id-token: write

    environment:
      name: pypi
      url: https://pypi.org/p/lifx-emulator

    steps:
    - name: Download Build Artifacts
      uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6
      id: artifact-download
      with:
        name: distribution-artifacts
        path: dist

    - name: Publish package distributions to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        packages-dir: dist
        print-hash: true
        verbose: true
