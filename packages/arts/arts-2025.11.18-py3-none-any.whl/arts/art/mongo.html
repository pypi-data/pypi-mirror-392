<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>arts.mongo</title>
<base href="/mongo/README.md">
<base target="_blank">
<link rel="icon" href="/site.ico" type="image/x-icon">
<script src="/cdn/markdown_css/light.js"></script>
<link rel="stylesheet" href="/cdn/markdown_css/light.css">
<article class="markdown-body">
<h1>描述</h1>
<p>一个优雅的 MongoDB ODM 。</p>
<p><a href="https://github.com/canbiaoxu/arts/tree/main/arts/mongo">源码</a></p>
<h1>教程</h1>
<p>本文将以简洁的方式向你介绍核心知识，而不会让你被繁琐的术语所淹没。</p>
<h2>安装</h2>
<pre><code class="language-bash">pip install arts
</code></pre>
<h2>导入</h2>
<pre><code class="language-python">from pymongo import MongoClient as mongo_client
from motor.motor_asyncio import AsyncIOMotorClient as motor_client
from arts.mongo import ODM, mc, mf, mo
</code></pre>
<h2>创建ODM</h2>
<pre><code class="language-python">class My_ODM(ODM):

    def mkconn(self):  # 定义同步连接器
        return mongo_client(host='localhost', port=27017)

    async def amkconn(self):  # 定义异步连接器
        return motor_client(host='localhost', port=27017)

odm = My_ODM()          # 账户ODM
db = odm['泉州市']      # 库ODM
sheet = db['希望小学']  # 表ODM
</code></pre>
<h2>基础功能 —— 增、查、改、删</h2>
<p>【增、查、改、删】的同步方法名称分别为：insert、find、update、delete 。</p>
<p>对应的异步方法名称为各同步方法名前加 <code>a</code> ，即：ainsert、afind、aupdate、adelete 。</p>
<h3>示例</h3>
<pre><code class="language-python">row1 = {'姓名':'小一', '年龄':11, '幸运数字':[1, 2, 3], '成绩':{'语文':81, '数学':82}}
row2 = {'姓名':'小二', '年龄':12, '幸运数字':[2, 3, 4], '成绩':{'语文':82, '数学':83}}
row3 = {'姓名':'小三', '年龄':13, '幸运数字':[3, 4, 5], '成绩':{'语文':83, '数学':84}}
row4 = {'姓名':'小四', '年龄':14, '幸运数字':[4, 5, 6], '成绩':{'语文':84, '数学':85}}
row5 = {'姓名':'小五', '年龄':15, '幸运数字':[5, 6, 7], '成绩':{'语文':85, '数学':86}}
row6 = {'姓名':'小六', '年龄':16, '幸运数字':[6, 7, 8], '成绩':{'语文':86, '数学':87}}
</code></pre>
<table>
<thead>
<tr>
<th style="text-align: center;"></th>
<th>同步方式</th>
<th>异步方式</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">增（1 条）</td>
<td>sheet.insert( row1 )</td>
<td>await sheet.ainsert( row2 )</td>
</tr>
<tr>
<td style="text-align: center;">增（批量）</td>
<td>sheet.insert( row3, row4 )</td>
<td>await sheet.ainsert( row5, row6 )</td>
</tr>
<tr>
<td style="text-align: center;">查</td>
<td>sheet.find( )</td>
<td>await sheet.afind( )</td>
</tr>
<tr>
<td style="text-align: center;">改</td>
<td>sheet.update( {'年龄': 100} )</td>
<td>await sheet.aupdate( {'年龄': 200} )</td>
</tr>
<tr>
<td style="text-align: center;">删</td>
<td>sheet.delete( )</td>
<td>await sheet.adelete( )</td>
</tr>
</tbody>
</table>
<h3>新增时，查看分配到的主键：</h3>
<pre><code class="language-python">row1 = {'姓名':'小一', '年龄':11, '幸运数字':[1, 2, 3], '成绩':{'语文':81, '数学':82}}
row2 = {'姓名':'小二', '年龄':12, '幸运数字':[2, 3, 4], '成绩':{'语文':82, '数学':83}}
row3 = {'姓名':'小三', '年龄':13, '幸运数字':[3, 4, 5], '成绩':{'语文':83, '数学':84}}

r1 = sheet.insert( row1 )
r2 = sheet.insert( row2, row3 )
</code></pre>
<p>方法1：使用 insert 添加数据成功后，row1~row3 已各自多了一个叫‘_id’的键，该键的值即分配到的主键。</p>
<p>方法2：</p>
<pre><code class="language-python">r1.inserted_id
r2.inserted_ids
</code></pre>
<h2>注：下文中所有示例都同时支持同步方式和异步方式，将同步示例中的 insert、delete、update、find 替换为 ainsert、adelete、aupdate、afind 即为异步方式，当然，须加上 await 前缀。</h2>
<h2>条件筛选</h2>
<h3>示例一：理解条件筛选的基本范式</h3>
<p>筛选【年龄&gt;13，且视力≧4.6，且性别为女】的数据，并进行查改删：</p>
<p><strong>查询</strong>：<code>sheet[mc.年龄 &gt; 13][mc.视力 &gt;= 4.6][mc.性别 == '女'].find( )</code></p>
<p><strong>修改</strong>：<code>sheet[mc.年龄 &gt; 13][mc.视力 &gt;= 4.6][mc.性别 == '女'].update( {'年级':'初一', '爱好':'画画,跳绳'} )</code></p>
<p><strong>删除</strong>：<code>sheet[mc.年龄 &gt; 13][mc.视力 &gt;= 4.6][mc.性别 == '女'].delete( )</code></p>
<h3>筛选操作清单</h3>
<table>
<thead>
<tr>
<th><strong>代码</strong></th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>mc.年龄 &gt; 10</td>
<td>大于</td>
</tr>
<tr>
<td>mc.年龄 &gt;= 10</td>
<td>大于或等于</td>
</tr>
<tr>
<td>mc.年龄 &lt; 10</td>
<td>小于</td>
</tr>
<tr>
<td>mc.年龄 &lt;= 10</td>
<td>小于或等于</td>
</tr>
<tr>
<td>mc.年龄 == 10</td>
<td>等于</td>
</tr>
<tr>
<td>mc.年龄 != 10</td>
<td>不等于</td>
</tr>
<tr>
<td>mc.年级 == mf.isin( '初三', '高二' )</td>
<td>若字段值是传入值的成员，则符合</td>
</tr>
<tr>
<td>mc.年龄 == mf.notin( 10, 30, 45 )</td>
<td>若字段值不是传入值的成员，则符合</td>
</tr>
<tr>
<td>mc.爱好 == mf.contain_all( '画画', '足球' )</td>
<td>若（列表）字段值包含传入值的所有元素，则符合</td>
</tr>
<tr>
<td>mc.爱好 == mf.contain_any( '画画', '足球' )</td>
<td>若（列表）字段值包含传入值的至少1个元素，则符合</td>
</tr>
<tr>
<td>mc.爱好 == mf.contain_none( '画画', '足球' )</td>
<td>若（列表）字段值不包含传入值的任何元素，则符合</td>
</tr>
<tr>
<td>mc.姓名 == mf.re( '小' )</td>
<td>正则匹配</td>
</tr>
<tr>
<td>[mc.年龄 &gt; 3][mc.年龄 &lt; 100]</td>
<td>交集（方式一）</td>
</tr>
<tr>
<td>[ (mc.年龄 &gt; 3) &amp; (mc.年龄 &lt; 100) ]</td>
<td>交集（方式二）</td>
</tr>
<tr>
<td>[(mc.年龄&lt;30)&#124; (mc.年龄&gt;30) &#124; (mc.年龄==30) &#124; (mc.年龄==None)]</td>
<td>并集</td>
</tr>
<tr>
<td>[ (mc.年龄 &gt; 3) - (mc.年龄 &gt; 100) ]</td>
<td>差集</td>
</tr>
<tr>
<td>[ ~(mc.年龄 &gt; 100) ]</td>
<td>补集</td>
</tr>
</tbody>
</table>
<p>注：</p>
<p>1、isin、notin 用于判断（普通）字段的值是否传入值的成员，针对普通字段。</p>
<p>2、contain_any、contain_none 用于判断传入值是否（列表）字段的值的成员，针对列表字段。</p>
<p>3、isin、notin、contain_all、contain_any、contain_none 的传入值都不必是同类型的数据，以 isin 为例：可以这样使用：mc.tag == mf.isin( 3, 3.5, '学生', None )，传入值含有 int、float、str、NoneType 等多种类型。</p>
<p>4、成员运算符未传入任何值时的处理方式：</p>
<table>
<thead>
<tr>
<th><strong>代码</strong></th>
<th><strong>处理方式</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>mc.年级 == mf.isin( )</td>
<td>所有数据都 不符合</td>
</tr>
<tr>
<td>mc.年级 == mf.notin( )</td>
<td>所有数据都 符合</td>
</tr>
<tr>
<td>mc.爱好 == mf.contain_all( )</td>
<td>所有数据都 符合</td>
</tr>
<tr>
<td>mc.爱好 == mf.contain_any( )</td>
<td>所有数据都 不符合</td>
</tr>
<tr>
<td>mc.爱好 == mf.contain_none( )</td>
<td>所有数据都 符合</td>
</tr>
</tbody>
</table>
<p>5、四种集合运算可以相互嵌套，且可以无限嵌套。</p>
<h3>示例二：理解并集、交集、补集的使用</h3>
<p>筛选【年龄&gt;13或视力≧4.6、且姓名含有‘小’、且年龄不高于15】的数据：</p>
<p><strong>查询</strong>：<code>sheet[(mc.年龄&gt;13) | (mc.视力&gt;=4.6)][mc.姓名 == mf.re('小')][~(mc.年龄&gt;15)].find( )</code></p>
<p><strong>修改</strong>：<code>sheet[(mc.年龄&gt;13) | (mc.视力&gt;=4.6)][mc.姓名 == mf.re('小')][~(mc.年龄&gt;15)].update( {'年级':'初三'} )</code></p>
<p><strong>删除</strong>：<code>sheet[(mc.年龄&gt;13) | (mc.视力&gt;=4.6)][mc.姓名 == mf.re('小')][~(mc.年龄&gt;15)].delete( )</code></p>
<h3>根据子元素过滤</h3>
<p>可使用  mc.xxx.xxx.xxx...  的形式来表示子孙元素。</p>
<p>查询【语文成绩&gt;80】的数据：</p>
<pre><code class="language-python">sheet[mc.成绩.语文 &gt; 80].find()
</code></pre>
<h2>特殊字段名的表示方法</h2>
<p>MongoDB 支持各种特殊的字段名，如：数字、符号、emoji 表情，这些字符在 Python 中不是合法变量名，因此使用  mc.1、mc.+  等格式会报错，可用  mc['1']、mc['+']、mc['👈']  这种格式代替。</p>
<h2>切片</h2>
<p>1、切片格式为  [start: stop: step]  ，start 表示从哪条开始，stop 表示到哪条停止，step 表示步长。</p>
<p>2、start 和 stop</p>
<ul>
<li>当为正值时，表示正序第 x 条，例如：1 表示第 1 条、2 表示第 2 条。</li>
<li>当为负值时，表示倒数第 x 条，例如：-1 表示倒数第 1 条、-2 表示倒数第 2 条。</li>
<li>不可为 0 。</li>
</ul>
<p>3、step</p>
<ul>
<li>须为正整数。</li>
<li>当 step &gt;= 2  时表示间隔式切片。</li>
<li>当 step = 1 时可省略 <code>: step</code> ，即：[start: stop] 等价于 [start: stop: 1] 。</li>
</ul>
<h3>示例</h3>
<pre><code class="language-python">sheet[过滤器]...[过滤器][:].find()                      # 查询符合条件的全部数据
sheet[过滤器]...[过滤器][:].delete()                    # 删除符合条件的全部数据
sheet[过滤器]...[过滤器][:].update({'年级':'初一'})      # 修改符合条件的全部数据

sheet[过滤器]...[过滤器][1].find()                      # 查询符合条件的第1条
sheet[过滤器]...[过滤器][1].delete()                    # 删除符合条件的第1条
sheet[过滤器]...[过滤器][1].update({'年级':'初一'})      # 修改符合条件的第1条

sheet[过滤器]...[过滤器][3:7].find()                    # 查询符合条件的第3~7条
sheet[过滤器]...[过滤器][3:7].delete()                  # 删除符合条件的第3~7条
sheet[过滤器]...[过滤器][3:7].update({'年级':'初一'})    # 修改符合条件的第3~7条

sheet[过滤器]...[过滤器][3:7:2].find()                  # 查询符合条件的第3、5、7条
sheet[过滤器]...[过滤器][3:7:2].delete()                # 删除符合条件的第3、5、7条
sheet[过滤器]...[过滤器][3:7:2].update({'年级':'初一'})  # 修改符合条件的第3、5、7条
</code></pre>
<p>值得注意的地方：  [3: 8: 2]  操作第  3、5、7  条，而  [8: 3: 2]  操作第  8、6、4  条。</p>
<p>更多示例：</p>
<pre><code class="language-python">[:]           # 所有数据
[1:-1]        # 所有数据
[-1:1]        # 所有数据（逆序）
[1:]          # 所有数据
[:1000]       # 第1条 ~ 第1000条
[:-1000]      # 第1条 ~ 倒数第1000条
[100:200]     # 第100条 ~ 第200条
[200:100]     # 第200条 ~ 第100条
[-300:-2]     # 倒数第300条 ~ 倒数第2条
[50:-2]       # 第50条 ~ 倒数第2条
[250:]        # 第250条 ~ 最后1条
[-250:]       # 倒数第250条 ~ 最后1条
[1]           # 第1条
[-1]          # 最后1条
[::3]         # 以3为间距, 间隔操作所有数据
[100:200:4]   # 以4为间距, 间隔操作第100条 ~ 第200条
</code></pre>
<h2>字段提示</h2>
<p>变量 mc 无字段提示功能，输入‘mc.’后，编辑器不会提示可选字段。</p>
<p>为了获得字段提示功能，可自建一个‘mc2’：</p>
<pre><code class="language-python">class mc2(mc):
    姓名 = 年龄 = 幸运数字 = None
    class 成绩:
        语文 = 数学 = None

sheet[mc.姓名 == '小王'][mc2.年龄 &gt; 10].find()
sheet[mc.姓名 == '小王'][mc2.成绩.语文 &gt; 80].find()
</code></pre>
<p>注：</p>
<p>1、mc2 与 mc 用法完全一致，可混用。</p>
<p>2、mc2 设置字段提示后，仅具备提示效果，而不产生任何实际约束。</p>
<h2>排序</h2>
<p>对所有年龄&gt;12的数据，优先按年龄降序，其次按姓名升序，排序后返回第 2\~4 条数据：</p>
<pre><code class="language-python">sheet[mc.年级=='高一'].order(年龄=False, 姓名=True)[2:4].find()
</code></pre>
<p>有趣的，以下两行代码的返回结果相同：</p>
<pre><code class="language-python">sheet[mc.年级=='高一'].order(年龄=True)[1:-1].find()

sheet[mc.年级=='高一'].order(年龄=False)[-1:1].find()
</code></pre>
<p>解释：order(年龄=False) 表示按年龄降序，[-1:1]表示逆序切片，产生了类似‘负负得正’的效果。</p>
<p>注：</p>
<p>1、筛选器、切片器、排序器、限定字段器的位置可任意，位置不影响其效果。当然，它们都应该在 sheet 之后，且在 find/update/delete 之前。</p>
<p>2、可反复排序，find/update/delete 时是根据最后1次指定的顺序提取数据。以下代码最终是按年龄降序后提取数据：</p>
<pre><code class="language-python">sheet.order(年龄=True, 姓名=False).order(年龄=False).find()
</code></pre>
<p>3、若想取消排序，则再次调用order方法，但不传入任何值。</p>
<pre><code class="language-python">sheet.order(年龄=True, 姓名=False).order().find()
</code></pre>
<h2>限定字段</h2>
<p>只返回姓名、年龄这2个字段：</p>
<pre><code class="language-python">sheet[mc.年级=='高一']['姓名','年龄'].find()
</code></pre>
<p>注：</p>
<p>1、限定字段只对 find 有作用，对 update/delete 无作用但不会报错。</p>
<p>2、筛选器、切片器、排序器、限定字段器的位置可任意，位置不影响其效果。当然，它们都应该在 sheet 之后，且在 find/update/delete 之前。</p>
<p>3、可反复限定字段，查询时是根据最后一次指定的字段提取数据。以下代码返回结果中只有‘年龄’字段：</p>
<pre><code class="language-python">sheet[mc.年级=='高一']['姓名']['年龄'].find()
</code></pre>
<p>4、若想恢复提取全部字段，则限定字段为 <code>None</code> ，<code>None</code> 即代表“全部字段”。</p>
<pre><code class="language-python">sheet[mc.年级=='高一']['姓名'][None].find()
</code></pre>
<h2>统计 与 删库删表</h2>
<table>
<thead>
<tr>
<th></th>
<th>同步方式</th>
<th>异步方式</th>
</tr>
</thead>
<tbody>
<tr>
<td>统计库的数量</td>
<td>odm.len( )</td>
<td>await odm.alen( )</td>
</tr>
<tr>
<td>统计表的数量</td>
<td>db.len( )</td>
<td>await db.alen( )</td>
</tr>
<tr>
<td>统计行的数量</td>
<td>sheet.len( )</td>
<td>await sheet.alen( )</td>
</tr>
<tr>
<td>统计符合条件的行的数量</td>
<td>sheet[ mc.age &gt; 8 ].len( )</td>
<td>await sheet[ mc.age &gt; 8 ].alen( )</td>
</tr>
<tr>
<td>获取库名清单</td>
<td>odm.get_db_names( )</td>
<td>await odm.aget_db_names( )</td>
</tr>
<tr>
<td>获取表名清单</td>
<td>db.get_sheet_names( )</td>
<td>await db.aget_sheet_names( )</td>
</tr>
<tr>
<td>删除某个库</td>
<td>db.delete_db( )</td>
<td>await db.adelete_db( )</td>
</tr>
<tr>
<td>删除某张表</td>
<td>sheet.delete_sheet( )</td>
<td>await sheet.adelete_sheet( )</td>
</tr>
</tbody>
</table>
<h2>迭代所有 库ODM 和 表ODM</h2>
<pre><code class="language-python"># 同步方式迭代
for db in odm:
    for sheet in db:
        print(sheet.sheet_name)

# 异步方式迭代
async for db in odm:
    async for sheet in db:
        print(sheet.sheet_name)
</code></pre>
<h2>特殊操作</h2>
<h3>示例：自增</h3>
<p>由于新年到了，令所有学生的年龄增加 1 岁：</p>
<pre><code class="language-python">sheet.update( {'年龄': mo.inc( 1 )} )
</code></pre>
<h3>特殊操作清单：</h3>
<table>
<thead>
<tr>
<th><strong>语法</strong></th>
<th><strong>含义</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>mo.inc( 1.5 )</td>
<td>自增 1.5</td>
</tr>
<tr>
<td>mo.inc( -1.5 )</td>
<td>自减 1.5</td>
</tr>
<tr>
<td>mo.add( 1, 2, 3 )</td>
<td>向列表字段添加元素，仅当被添加的元素不存在时才添加</td>
</tr>
<tr>
<td>mo.push( 1, 2, 3 )</td>
<td>向列表字段添加元素，无论被添加的元素是否存在都添加</td>
</tr>
<tr>
<td>mo.pull( 15 )</td>
<td>从列表字段删除 1 个等于 15 的值</td>
</tr>
<tr>
<td>mo.popfirst</td>
<td>从列表字段删除第 1 个元素</td>
</tr>
<tr>
<td>mo.poplast</td>
<td>从列表字段删除最后 1 个元素</td>
</tr>
<tr>
<td>mo.rename( '新名称' )</td>
<td>重命名字段</td>
</tr>
<tr>
<td>mo.unset</td>
<td>删除字段</td>
</tr>
<tr>
<td>mo.delete</td>
<td>删除字段（与 mo.unset 等价）</td>
</tr>
</tbody>
</table>
<p>示例：</p>
<pre><code class="language-python">sheet[mc.姓名=='小六'].update({
    '姓名': 'xiaoliu',          # 修改为‘xiaoliu’
    '年龄': mo.inc(6),          # 自增6
    '幸运数字': mo.push(666),   # 添加666
    '视力': mo.rename('眼力'),  # 字段名改为‘眼力’
    '籍贯': mo.delete,          # 删除此字段
    '成绩.语文': 60,            # 改为60分
    '成绩.数学': mo.inc(-6)     # 减6分
})
</code></pre>
</article>