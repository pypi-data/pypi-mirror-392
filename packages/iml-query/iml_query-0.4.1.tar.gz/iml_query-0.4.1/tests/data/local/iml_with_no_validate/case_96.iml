(* Remove factors of 2 from a number *)
let rec remove_factors_of_2 n =
  if n <= 0 then n
  else if n mod 2 = 0 then
    remove_factors_of_2 (n / 2)
  else
    n
[@@measure Ordinal.of_int n]

(* Remove common factors of 2 from both numbers *)
let rec remove_common_factors_of_2 x y shift =
  if x <= 0 || y <= 0 then (x, y, shift)
  else if (x mod 2 = 0) && (y mod 2 = 0) then
    remove_common_factors_of_2 (x / 2) (y / 2) (shift + 1)
  else
    (x, y, shift)
[@@measure Ordinal.of_int (x + y)]

(* Main loop to compute GCD *)
let rec binary_gcd_loop x y =
  if y = 0 then
    x
  else if y < 0 then
    x
  else
    let y' = remove_factors_of_2 y in
    if y' <= 0 then x
    else
      let (x', y'') = if x > y' then (y', x) else (x, y') in
      if y'' < x' then x'
      else
        binary_gcd_loop x' (y'' - x')
[@@no_validate]

let binary_gcd x y =
  if x = 0 then
    y
  else if y = 0 then
    x
  else if x < 0 || y < 0 then
    0
  else
    let (x', y', shift) = remove_common_factors_of_2 x y 0 in
    let x'' = remove_factors_of_2 x' in
    let result = binary_gcd_loop x'' y' in
    result * Int.pow 2 shift